<!--ğŸ® Zombie Survivor  âœ¨ Version: 1.2  ğŸ–‹ï¸ TÃ¡c giáº£: Dang -->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Zombie Survivor - Dang</title>
<style>
  :root {
  /* ğŸ¨ MÃ u sáº¯c chÃ­nh */
  --color-bg-dark: #111;
  --color-primary: #00ffff;
  --color-accent: gold;
  --color-danger: #ff4c4c;
  --color-text: #e0f7fa;
  --color-hover-bg: #22404c;
  --color-hover-border: #3d6c78;
  --color-title: #aefeff;
  --glow-title: 0 0 6px #7f7fff, 0 0 12px #4d4dfb;
 
  /* ğŸŒˆ MÃ u sáº¯c giao diá»‡n */
  --menu-width: 24rem;
  --menu-min-height: 20rem;
  --menu-radius: 1rem;
  --menu-padding: 2rem 1.5rem;

  /* ğŸ”˜ MÃ u button riÃªng */
  --btn-bg: #1a2b33;
  --btn-border: #294e5a;

  /* ğŸ”¤ KÃ­ch thÆ°á»›c font chá»¯ */
  --font-xs: 0.75rem;
  --font-sm: 0.9rem;
  --font-md: 1rem;
  --font-lg: 1.25rem;
  --font-xl: 1.5rem;
  --font-xxl: 2.5rem;

  /* ğŸ“ KÃ­ch thÆ°á»›c padding/margin chuáº©n */
  --space-xs: 0.4rem;
  --space-sm: 0.6rem;
  --space-md: 1rem;
  --space-lg: 1.5rem;
  --space-xl: 2rem;

  /* ğŸŒŸ Äá»™ sÃ¡ng bÃ³ng / hiá»‡u á»©ng */
  --glow-primary: 0 0 8px var(--color-primary);
  --glow-accent: 0 0 8px var(--color-accent);
}

  body { margin: 0; background: #111; overflow: hidden; font-family: sans-serif; background-image: url('images/foggy-graveyard.png');
  background-size: cover;
  background-position: center center;
  background-repeat: no-repeat;
  background-attachment: fixed;}
  canvas { display: block; margin: auto; transition: background 1s ease; }
/* ğŸ¯ Giao diá»‡n chÃ­nh */
#ui {
  position: absolute;
  top: 0vh; /* cÃ¡ch top theo chiá»u cao mÃ n hÃ¬nh */
  left: 50%;
  transform: translateX(-50%);
  display: flex;
  gap: 0.2rem; /* khoáº£ng cÃ¡ch giá»¯a cÃ¡c nÃºt */
  padding: 0.2rem 0.2rem; 
  background: rgb(0, 0, 0); /* ná»n trong suá»‘t */
  border-radius: 0rem;
  width: 90%; /* tá»· lá»‡ theo chiá»u ngang */
  max-width: 60rem; /* giá»›i háº¡n tá»‘i Ä‘a */
  justify-content: center;
  z-index: 1000;
  flex-wrap: wrap;
  border-radius: 10px;
}
/* --- CSS Ä‘Ã£ Ä‘Æ°á»£c sá»­a lá»—i cho Logo vÃ  thanh UI --- */

/* Style chung cho cáº£ hai logo (giá» Ä‘Ã¢y Ä‘Æ°á»£c Ä‘á»‹nh vá»‹ tuyá»‡t Ä‘á»‘i) */
.ui-logo {
  position: fixed; /* Äá»‹nh vá»‹ cá»‘ Ä‘á»‹nh trÃªn mÃ n hÃ¬nh */
  top: 1.2rem;     /* Vá»‹ trÃ­ cÃ¡ch Ä‘á»‰nh */
  color: var(--color-title);
  font-family: 'Segoe UI', sans-serif;
  font-weight: bold;
  text-shadow: 0 0 4px var(--color-primary);
  z-index: 1001;   /* LuÃ´n ná»•i lÃªn trÃªn thanh UI */
  pointer-events: none; /* Cho phÃ©p click xuyÃªn qua logo */
}

/* Style riÃªng cho logo bÃªn trÃ¡i (TÃªn game) */
.left-logo {
  left: 18.1rem; /* Vá»‹ trÃ­ cÃ¡ch lá» trÃ¡i */
  line-height: 1;
  font-size: 0.8rem;
  text-align: center;
}

/* Style riÃªng cho logo bÃªn pháº£i (TÃªn tÃ¡c giáº£) */
.right-logo {
  right: 18.1rem; /* Vá»‹ trÃ­ cÃ¡ch lá» pháº£i */
  line-height: 1;
  font-size: 0.8rem;
  text-align: center;
}
/* --- Káº¿t thÃºc CSS cho Logo vÃ  thanh UI --- */
/* ğŸ”˜ NÃºt trong UI (nhá» gá»n hÆ¡n nÃºt máº·c Ä‘á»‹nh) */
#ui button {
  padding: 0.6rem 0.6rem;
  font-size: 0.75rem;
  min-width: 4.5rem;
  margin-bottom: 0.6rem;
  margin-top: 0.6rem;
}

/* ğŸ”˜ NÃºt máº·c Ä‘á»‹nh cho toÃ n giao diá»‡n */
button {
  font-family: 'Segoe UI', sans-serif;
  padding: 0.65rem 1.25rem;
  font-size: 1rem;
  cursor: pointer;
  min-width: 5rem;
  text-align: center;
  background-color: #1a2b33;
  border: 0.125rem solid #294e5a;
  border-radius: 0.5rem;
  color: #e0f7fa;
  transition: all 0.2s ease;
  box-shadow: 0 0.125rem 0.3rem rgba(0, 0, 0, 0.2);
}

/* ğŸ” Hiá»‡u á»©ng hover cho nÃºt */
button:hover {
  background-color: #22404c;
  border-color: #3d6c78;
  color: #ffffff;
  transform: translateY(-0.06rem);
}

/* ğŸ–± Hiá»‡u á»©ng khi click giá»¯ */
button:active {
  transform: scale(0.97);
  box-shadow: 0 0.06rem 0.2rem rgba(0, 0, 0, 0.3);
}

/* âœ³ï¸ NÃºt Ä‘ang active (Ä‘Æ°á»£c chá»n) */
button.active {
  border-color: #00ffff;
  box-shadow: 0 0 0.625rem #00ffffaa;
}

/* Tráº¡ng thÃ¡i active dÃ¹ng cho nhiá»u thÃ nh pháº§n */
.active {
  outline: 0.125rem solid gold;
  border-radius: 0.5rem;
}

/* ğŸ“Š VÃ¹ng hiá»ƒn thá»‹ Ä‘iá»ƒm sá»‘ hoáº·c thÃ´ng tin */
#score {
  display: flex;
  flex-direction: column;
  justify-content: center;
  align-items: center;
  min-width: 7.5rem;
  text-align: center;
  color: white;
  font-size: 0.8rem;
  padding: 0.2rem 0.2rem;
}

/* ğŸ”„ NÃºt restart Ä‘áº·c biá»‡t */
#restartBtn {
  padding: 0.75rem 1.75rem;
  font-weight: bold;
  background-color: #1c2e36;
  border: 0.125rem solid #3a6b75;
  border-radius: 0.5rem;
  font-size: 1rem;
  color: #aefeff;
  cursor: pointer;
  transition: 0.25s ease;
}

/* ğŸ–± Hover cho restart */
#restartBtn:hover {
  background-color: #28515f;
  color: white;
  transform: translateY(-0.06rem);
}

/* â³ Hiá»ƒn thá»‹ Ä‘á»“ng há»“ Ä‘áº¿m wave */
#waveTimerDisplay {
  position: fixed;
  top: 10vh;
  left: 48.5%;
  transform: translateX(-50%);
  font-size: 1.2rem;
  color: gold;
  z-index: 10;
  text-shadow: 0 0 8px gold;
  font-weight: bold;
  font-family: 'Courier New', monospace;
  letter-spacing: 0.1rem;
  pointer-events: none;
}

/* ğŸŒŠ Popup khi báº¯t Ä‘áº§u Wave */
#wavePopup {
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  font-size: 2.5rem;
  font-weight: bold;
  color: #fff3b0;
  text-shadow:
    0 0 6px #ffd54f,
    0 0 12px #ffb300;
  background: none;
  border: none;
  pointer-events: none;
  z-index: 1000;
  transition: opacity 0.5s ease;
  opacity: 0;
}

/* âœ¨ Animation xuáº¥t hiá»‡n má»m mÆ°á»£t */
@keyframes waveFade {
  0% {
    opacity: 0;
    transform: translate(-50%, -50%) scale(0.7);
  }
  50% {
    opacity: 1;
    transform: translate(-50%, -50%) scale(1.05);
  }
  100% {
    opacity: 1;
    transform: translate(-50%, -50%) scale(1);
  }
}

/* ğŸ“‹ Menu báº¯t Ä‘áº§u game */
#startMenu {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 1rem;
  width: 90%;
  position: fixed;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  color: white;
  border-radius: var(--menu-radius);
  padding: var(--menu-padding);
  max-width: var(--menu-width);
  min-height: var(--menu-min-height);
  text-align: center;
  background: linear-gradient(to bottom, #0e1a26, #0a121a);
  backdrop-filter: blur(6px);
  border: 1px solid #446688;
  box-shadow:
    0 0 8px rgba(102, 170, 255, 0.1),
    inset 0 0 6px rgba(102, 170, 255, 0.05);
  z-index: 999;
}
#startMenu:hover {
  box-shadow:
    0 0 12px rgb(0, 153, 255),
    inset 0 0 8px rgba(0, 187, 255, 0.393);
}
#startMenu .btn-group {
  display: flex;
  flex-wrap: wrap;
  justify-content: center;
  gap: 1rem;
}
#startMenu button {
  min-width: 10rem;
}

/* ğŸŒŸ Popup khi lÃªn cáº¥p */
#levelUpPopup {
  position: fixed;
  top: 40%;
  left: 50%;
  transform: translate(-50%, -50%);
  font-size: 2.5rem;
  color: gold;
  font-weight: bold;
  text-shadow: 0 0 15px #ffff00;
  display: none;
  z-index: 10003;
}

/* ğŸ’€ Panel Game Over hiá»ƒn thá»‹ khi thua */
.gameOverPanel {
  position: fixed;
  top: 50%;
  left: 50%;
  /* Báº¯t Ä‘áº§u áº©n vÃ  nhá» */
  transform: translate(-50%, -50%) scale(0.7);
  opacity: 0;
  visibility: hidden; /* DÃ¹ng visibility Ä‘á»ƒ áº©n hoÃ n toÃ n */

  color: white;
  display: flex; /* Giá»¯ láº¡i flex Ä‘á»ƒ cÄƒn giá»¯a ná»™i dung */
  flex-direction: column;
  align-items: center;
  backdrop-filter: blur(6px);
  z-index: 2000;
  padding: 2rem 1rem;
  border: 2px solid #ff5722;
  background: linear-gradient(145deg, #1a0f0f, #300d0d);
  box-shadow: 0 0 1rem #ff572288;
  border-radius: 1rem;
  text-align: center;
  
  /* Hiá»‡u á»©ng chuyá»ƒn Ä‘á»™ng */
  transition: opacity 0.4s ease-out, transform 0.4s ease-out, visibility 0.4s;
}

/* Khi cÃ³ class 'visible', panel sáº½ hiá»‡n ra */
.gameOverPanel.visible {
  opacity: 1;
  visibility: visible;
  transform: translate(-50%, -50%) scale(1);
}

/* ğŸ¯ TiÃªu Ä‘á» Game Over */
.gameOverTitle {
  color: #ff5722;
  font-size: 2.5rem;
  text-shadow: 0 0 4px #ffff00, 0 0 4px #ffff00;
  margin-bottom: 1rem;
}

/* ğŸ” NÃºt ChÆ¡i láº¡i trong Game Over Panel */
.restartButton {
  margin-top: 1rem;
  padding: 0.75rem 2rem;
  font-size: 1.2rem;
  font-weight: 300;
  background-color: #330000;
  color: #fff5cc;
  border: 2px solid #ff9800;
  border-radius: 0.75rem;
  cursor: pointer;
  box-shadow: 0 0 0.5rem #ff5722aa;
  transition: all 0.25s ease;
  text-shadow: 0 0 3px #ffaa00;
}

.restartButton:hover {
  background-color: #551100;
  color: #ffffff;
  transform: scale(1.05);
  box-shadow: 0 0 1rem #ff5722cc;
}

/* ğŸ•¹ï¸ TiÃªu Ä‘á» game á»Ÿ menu báº¯t Ä‘áº§u */
.gameTitle {
  font-size: 2.5rem;
  font-weight: 900;
  color: var(--color-title);
  text-shadow: var(--glow-title);
  margin-bottom: 1.5rem;
  font-family: 'Segoe UI', sans-serif;
}

/* âš ï¸ Popup cáº£nh bÃ¡o (dÃ¹ng cho showWarning) */
.warningPopup{
  position:fixed;
  top:20%;                /* â‘  Ä‘áº·t tÃ¢m dá»c  */
  left:50%;               /* â‘¡ Ä‘áº·t tÃ¢m ngang */
  transform:translate(-50%,-50%); /* â‘¢ kÃ©o ngÆ°á»£c láº¡i 50 % kÃ­ch thÆ°á»›c chÃ­nh nÃ³ */
  background:rgba(0,32,64,.9);
  color:var(--color-text);
  padding:var(--space-sm) var(--space-lg);
  border-radius:.75rem;
  font:var(--font-md) 'Segoe UI',sans-serif;
  font-weight:500;
  z-index:9999;
  box-shadow:0 0 10px #00bcd4aa;
  pointer-events:none;
  animation:popupFade 1.5s ease-out forwards;
  max-width:70vw;         /* náº¿u text quÃ¡ dÃ i sáº½ tá»± xuá»‘ng hÃ ng */
  text-align:center;
}

/*  VÃ¬ transform nay Ä‘Ã£ chá»©a translate(-50%,-50%),
    animation chá»‰ láº¯c trá»¥c Y thÃªm má»™t chÃºt  */
@keyframes popupFade{
  0%   {opacity:0; transform:translate(-50%,-30%);}
  10%  {opacity:1; transform:translate(-50%,-50%);}
  90%  {opacity:1; transform:translate(-50%,-50%);}
  100% {opacity:0; transform:translate(-50%,-70%);}
}
#notificationContainer{
  position: fixed;
  top: 20%;
  left: 50%;
  transform: translate(-50%, -50%);   /* cÄƒn Ä‘Ãºng tÃ¢m nhÆ° popup cÅ© */
  display: flex;
  flex-direction: column;             /* xáº¿p dá»c */
  align-items: center;                /* má»—i popup váº«n giá»¯a ngang */
  gap: .5rem;                         /* khoáº£ng cÃ¡ch giá»¯a cÃ¡c popup */
  pointer-events: none;
  z-index: 10000;
}

/* âœ¨ Popup bÃªn trong khay â€“ bá» fixed & translate cÅ© */
#notificationContainer .warningPopup{
  position: relative;                 /* relative â†’ theo khay */
  left: auto; top: 0;
  transform: none;                    /* khay Ä‘Ã£ lo cÄƒn giá»¯a */
  animation: popupFadeStack 1.5s ease-out forwards;
}

/* Hiá»‡u á»©ng gáº§n giá»‘ng cÅ© nhÆ°ng khÃ´ng chá»©a -50% ná»¯a */
@keyframes popupFadeStack{
  0%   {opacity:0;   transform: translateY(20px);}
  10%  {opacity:1;   transform: translateY(0);}
  90%  {opacity:1;}
  100% {opacity:0;   transform: translateY(-20px);}
}

/* ğŸŒŸ Giao diá»‡n popup nÃ¢ng cáº¥p */
#upgradePopup {
  /* display: none; */ /* Bá» display none Ä‘á»ƒ dÃ¹ng opacity vÃ  visibility */
  opacity: 0;
  visibility: hidden;
  transform: translate(-50%, -50%) scale(0.9); /* Báº¯t Ä‘áº§u nhá» hÆ¡n má»™t chÃºt */
  transition: opacity 0.3s ease, transform 0.3s ease, visibility 0.3s; /* Hiá»‡u á»©ng chuyá»ƒn Ä‘á»™ng */
  
  position: fixed;
  top: 50%;
  left: 50%;
  background: rgba(0, 0, 0, 0.85);
  border: 2px solid gold;
  padding: 2rem;
  border-radius: 1rem;
  z-index: 9999;
  max-width: 42rem;
  width: 90%;
  text-align: center;
  box-shadow: 0 0 15px gold;
}

/* ThÃªm class .visible Ä‘á»ƒ kÃ­ch hoáº¡t hiá»‡u á»©ng */
#upgradePopup.visible {
    opacity: 1;
    visibility: visible;
    transform: translate(-50%, -50%) scale(1);
}
.upgradeTitle {
  color: gold;
  font-size: 1.8rem;
  font-weight: bold;
  margin-bottom: 1.5rem;
  text-shadow: 0 0 6px gold;
  margin-top: 1rem;
}

.upgradeChoices {
  display: flex;
  justify-content: space-evenly;
  gap: 1rem;
  flex-wrap: wrap;
}

.upgradeChoices button {
  padding: 0.8rem 1.2rem;
  border: 2px solid #ccc;
  border-radius: 0.6rem;
  background: #111;
  color: white;
  font-size: 1rem;
  font-weight: bold;
  min-width: 8rem;
  cursor: pointer;
  transition: 0.2s ease;
}

.upgradeChoices button:hover {
  background: #22404c;
  border-color: gold;
  color: #fff;
  box-shadow: 0 0 10px gold;
}

/* ğŸ“Š Overlay thá»‘ng kÃª */
#statsOverlay {
  position: fixed;
  top: 0.2rem;
  right: 0.5rem;
  background: rgba(0, 0, 0, 0.7);
  border: 2px solid #00ffff;
  border-radius: 1rem;
  padding: 1rem;
  color: #e0f7fa;
  font-size: 0.95rem;
  line-height: 1.5;
  z-index: 9999;
  width: 15rem;
  font-family: 'Segoe UI', sans-serif;
}

#statsOverlay h3 {
  font-size: 1rem;
  margin-top: 0;
  margin-bottom: 0.5rem;
  color: gold;
  text-align: center;
}

#statsOverlay.hidden {
  display: none;
}
/* ğŸ“š Giao diá»‡n báº£ng ká»¹ nÄƒng active */
#skillsOverlay {
  position: fixed;
  top: 0.2rem;
  left: 0.5rem;
  background: rgba(0, 0, 0, 0.7);
  border: 2px solid #00ffff;
  border-radius: 1rem;
  padding: 1rem;
  color: #e0f7fa;
  font-size: 0.95rem;
  line-height: 1.5;
  z-index: 9999;
  width: 15rem;
  font-family: 'Segoe UI', sans-serif;
}

#skillsOverlay h3 {
  font-size: 1rem;
  margin-top: 0;
  margin-bottom: 0.5rem;
  color: gold;
  text-align: center;
}

#skillsOverlay.hidden {
  display: none;
}

.skill-item {
  margin-bottom: 0.5rem;
  padding: 0.4rem;
  background: rgba(255, 255, 255, 0.1);
  border-radius: 0.5rem;
  cursor: pointer;
  transition: background 0.3s;
}

.skill-item:hover {
  background: rgba(0, 255, 255, 0.3);
}

.skill-icon {
  font-size: 1.2rem;
  margin-right: 0.5rem;
}
#skillPopup {
  display: none;
  position: fixed;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  background: rgba(0, 32, 64, 0.9);
  border: 2px solid #00ffff;
  padding: 2rem;
  border-radius: 1rem;
  z-index: 9999;
  max-width: 42rem;
  width: 90%;
  text-align: center;
  box-shadow: 0 0 15px #00ffffaa;
}

#skillPopup h3 {
  color: #00ffff;
  font-size: 1.6rem;
  font-weight: bold;
  margin-bottom: 1.2rem;
  text-shadow: 0 0 6px #00ffff;
}

#skillPopup .upgradeChoices {
  display: flex;
  justify-content: space-evenly;
  gap: 1rem;
  flex-wrap: wrap;
}

#skillPopup .upgradeChoices button {
  padding: 0.8rem 1rem;
  border: 2px solid #0d1aa0; /* mÃ u ká»¹ nÄƒng active */
  border-radius: 0.6rem;
  background: #001f2f;
  color: white;
  font-size: 1rem;
  font-weight: bold;
  min-width: 9rem;
  cursor: pointer;
  transition: 0.2s ease;
}
#skillPopup .upgradeChoices button:hover {
  background: #003344;
  border-color: cyan;
  box-shadow: 0 0 10px cyan;
}

.skill-item.active {
  border: 2px solid #00ffff;
  background: rgba(0, 255, 255, 0.2);
  box-shadow: 0 0 8px cyan;
  pointer-events: none; /* khÃ´ng cho click vÃ o ká»¹ nÄƒng Ä‘Ã£ chá»n */
}
.infoOverlay {
  position: fixed;
  top: 50%; left: 50%;
  transform: translate(-50%, -50%);
  background: rgba(10, 25, 40, 0.95); /* xanh Ä‘en dá»‹u */
  border: 2px solid #446688;
  border-radius: var(--menu-radius);
  max-width: 24rem;
  min-height: 22rem;
  width: 90%;
  padding: var(--menu-padding);
  box-shadow: 0 0 10px rgba(50, 100, 150, 0.3);
  color: #eef;
  z-index: 9999;
  font-family: 'Segoe UI', sans-serif;
  font-size: 0.95rem;
  line-height: 1.6; /* khoáº£ng cÃ¡ch dÃ²ng */
  text-align: center;
}
.spacer {
  height: 2rem;  /* hoáº·c 4rem tÃ¹y Ä‘á»™ cao báº¡n muá»‘n */
}
/* ğŸ”§ Spacer cÃ¢n báº±ng layout trong overlay hÆ°á»›ng dáº«n */
.spacerguide {
  height: 1rem; /* khoáº£ng cÃ¡ch giá»¯a cÃ¡c má»¥c */
}

.infoOverlay button {
  min-width: 10rem;
}
.custom-input {
  font-family: 'Segoe UI', sans-serif;
  padding: 0.65rem 1.25rem;
  font-size: 0.9rem;
  min-width: 6.5rem;
  width: 100%;
  max-width: 7.2rem;
  text-align: center;
  background-color: #1a2b33;
  border: 0.125rem solid #294e5a;
  border-radius: 0.5rem;
  color: #e0f7fa;
  transition: all 0.2s ease;
  box-shadow: 0 0.125rem 0.3rem rgba(0, 0, 0, 0.2);
}

.custom-input:focus {
  outline: none;
  background-color: #22404c;
  border-color: #3d6c78;
  color: #ffffff;
  box-shadow: 0 0 0.625rem #00ffffaa;
}
#waveNumberDisplay {
  position: fixed;
  top: 14vh; /* giá»‘ng waveTimerDisplay */
  left: 48.5%; /* lá»‡ch pháº£i so vá»›i thá»i gian á»Ÿ 50% */
  transform: translateX(-50%);
  font-size: 1.1rem;
  color: #aefeff;
  font-weight: bold;
  text-shadow: 0 0 6px #00ffff;
  z-index: 10;
  pointer-events: none;
}
#miniMap {
  position: fixed;
  top: 6.5rem;
  right: 18rem;
  width: 150px;
  height: 150px;
  border: 2px solid #00ffff;
  border-radius: 0.5rem;
  background: rgba(0, 0, 0, 0.4);
  z-index: 9999;
  display: none; /* áº©n mini map ban Ä‘áº§u */
}
/* Tooltip cho item trong báº£ng ká»¹ nÄƒng (phÃ­m X) */
.skill-item[data-tooltip] {
  position: relative;
}
.skill-item[data-tooltip]::after {
  content: attr(data-tooltip);
  position: absolute;
  left: 105%;               /* hiá»‡n bÃªn pháº£i báº£ng */
  top: -2rem;
  transform: translateY(var(--tip-shift,0)); /* Dá»ŠCH theo biáº¿n */
  margin-left: .6rem;
  min-width: 18rem;
  white-space: pre-line;    /* xuá»‘ng dÃ²ng theo \n */
  padding: .55rem .7rem;
  font-size: .8rem;
  background: rgba(0,0,0,.85);
  color: #e0f7fa;
  border: 1px solid #00ffff;
  border-radius: .5rem;
  pointer-events: none;
  opacity: 0;
  transition: opacity .25s;
  z-index: 10000;
}
.skill-item:hover::after { opacity: 1; }
#bigBossRespawnDisplay {
    position: fixed;
    top: 10vh;
    left: 29.1vw;
    background: rgba(0, 0, 0, 0.6);
    border: 2px solid violet;
    border-radius: 0.5rem;
    padding: 0.4rem 0.6rem;
    color: violet;
    font-family: 'Courier New', monospace;
    font-size: 0.8rem;
    text-align: center;
    min-width: 6rem;
    z-index: 10;
    text-shadow: 0 0 5px violet;
}
/* CSS cho bá»™ Ä‘áº¿m ngÃ y má»›i (cÃ³ Ä‘á»‹nh vá»‹) */
#dayCounterDisplay {
    position: fixed;
    top: 10vh; /* CÃ¹ng Ä‘á»™ cao vá»›i BigBoss */
    left: 23.2vw; /* Äáº·t á»Ÿ vá»‹ trÃ­ bÃªn pháº£i cá»§a BigBoss */
    background: rgba(0, 0, 0, 0.6);
    border: 2px solid gold;
    border-radius: 0.5rem;
    padding: 0.4rem 0.6rem;
    color: gold;
    font-family: 'Courier New', monospace;
    font-size: 0.8rem;
    text-align: center;
    min-width: 4rem;
    z-index: 10;
    text-shadow: 0 0 5px gold;
}
#ui button[data-tooltip] {
  position: relative;
}

#ui button[data-tooltip]::after {
  content: attr(data-tooltip);
  position: absolute;
  left: 110%;
  top: 4rem;
  transform: translateX(-40%);
  margin-left: .6rem;
  min-width: 18rem;
  white-space: pre-line;
  padding: .55rem .7rem;
  font-size: .8rem;
  background: rgba(0, 0, 0, 0.85);
  color: #e0f7fa;
  border: 1px solid #00ffff;
  border-radius: .5rem;
  pointer-events: none;
  opacity: 0;
  transition: opacity .25s;
  text-align: left; /* chá»¯ canh trÃ¡i */
  z-index: 10000;
}

#ui button:hover::after {
  opacity: 1;
}

/* --- CSS cho Debug Menu (PhiÃªn báº£n thanh kÃ©o) --- */
#debugMenu {
  max-width: 24rem;
  width: 90%;
  padding-bottom: 1rem;
  
  /* Bá»” SUNG: Giá»›i háº¡n chiá»u cao vÃ  dÃ¹ng Flexbox */
  display: flex;
  flex-direction: column;
  max-height: 90vh; /* Chiá»u cao tá»‘i Ä‘a báº±ng 85% chiá»u cao mÃ n hÃ¬nh */
}

.debug-grid {
  display: grid;
  grid-template-columns: auto 1fr; 
  gap: 0.8rem 1rem;
  align-items: center;
  margin-bottom: 1rem;
  text-align: left;

  /* Bá»” SUNG: Cho phÃ©p cuá»™n dá»c khi ná»™i dung dÃ i hÆ¡n */
  overflow-y: auto;
  padding-right: 1rem; /* ThÃªm khoáº£ng Ä‘á»‡m nhá» trÃ¡nh ná»™i dung sÃ¡t viá»n */

  /* --- CÃ¡c thuá»™c tÃ­nh Ä‘á»ƒ áº©n thanh cuá»™n --- */
  /* Cho Firefox */
  scrollbar-width: none;
  /* Cho Internet Explorer vÃ  Edge cÅ© */
  -ms-overflow-style: none;
}

/* Cho cÃ¡c trÃ¬nh duyá»‡t Webkit (Chrome, Safari, Edge má»›i) */
.debug-grid::-webkit-scrollbar {
    display: none;
}

/* ThÃªm Ä‘á»‹nh nghÄ©a Ä‘á»ƒ áº©n Debug Menu khi cÃ³ class 'hidden' */
#debugMenu.hidden {
    display: none;
}
.debug-subtitle {
  grid-column: 1 / -1; /* TiÃªu Ä‘á» chiáº¿m trá»n chiá»u rá»™ng cá»§a grid */
  text-align: center;
  color: gold;
  margin-top: 1rem;
  margin-bottom: 0.5rem;
  border-top: 1px solid #446688;
  padding-top: 1rem;
}
/* Chá»‰nh láº¡i chiá»u rá»™ng cho Ã´ nháº­p sá»‘ Kill */
#debug-kill.debug-input {
    width: 10em; /* Giá»›i háº¡n chiá»u rá»™ng (báº¡n cÃ³ thá»ƒ thay Ä‘á»•i sá»‘ 12) */
    justify-self: start; /* CÄƒn lá» trÃ¡i trong Ã´ layout */
}

/* --- CSS cho khu vá»±c debug ká»¹ nÄƒng active --- */
.debug-skill-grid {
  grid-column: 1 / -1; /* Chiáº¿m trá»n chiá»u rá»™ng cá»§a grid cha */
  display: flex;
  flex-direction: column;
  gap: 1rem;
}

.debug-skill-wrapper {
  background: rgba(0,0,0,0.2);
  padding: 0.75rem;
  border-radius: 0.5rem;
  border: 1px solid #294e5a;
}

.debug-skill-wrapper h5 {
  margin: 0 0 0.75rem 0;
  color: white;
  font-weight: 600;
  font-size: 1.1rem;
}

.debug-skill-controls {
    display: grid;
    grid-template-columns: auto 1fr;
    gap: 0.8rem 1rem;
    align-items: center;
    font-size: 0.9rem;
}
/* CSS cho bá»™ Ä‘áº¿m Xu (Coin) */
#coinCounterDisplay {
  position: fixed;
  top: 10vh; /* CÃ¹ng Ä‘á»™ cao vá»›i Wave */
  left: 40.8%; /* Vá»‹ trÃ­ bÃªn pháº£i cá»§a Wave */
  border: 2px solid gold;
  border-radius: 0.5rem;
  padding: 0.3rem 0.6rem;
  transform: translateX(-50%);
  font-size: 0.8rem;
  color: gold; /* MÃ u vÃ ng cho há»£p vá»›i coin */
  font-weight: normal;
  text-shadow: 0 0 2px gold;
  z-index: 10;
  pointer-events: none;
}
/* Style chung cho hiá»ƒn thá»‹ buff */
.buff-display {
  position: fixed;
  top: 10vh;
  transform: translateX(-50%);
  background: rgba(0, 0, 0, 0.6);
  border-radius: 0.5rem;
  padding: 0.4rem 0.4rem;
  font-family: 'Segoe UI', sans-serif;
  font-size: 0.8rem;
  font-weight: normal;
  color: white;
  border: 2px solid;
  z-index: 10;
  pointer-events: none;
}
.buff-display.inactive {
  opacity: 0.4; /* LÃ m má» Ä‘i */
}
/* Vá»‹ trÃ­ riÃªng cho tá»«ng buff */
#luckyBuffDisplay { 
  left: 56.9%; /* Vá»‹ trÃ­ bÃªn trÃ¡i cá»§a Wave 68% */
  border-color: #22c55e; 
}
#powerBuffDisplay { 
  left: 64.1%; /* Vá»‹ trÃ­ bÃªn trÃ¡i cá»§a Lucky */
  border-color: #ef4444; 
}
#crazyBuffDisplay { 
  left: 71.2%; /* Vá»‹ trÃ­ bÃªn trÃ¡i cá»§a Power */
  border-color: #f59e0b; 
}
#expBuffDisplay { 
  left: 77.9%; /* Vá»‹ trÃ­ bÃªn trÃ¡i cá»§a Power */
  border-color: #ffeb3b; /* MÃ u vÃ ng cho buff EXP */
}
#magnetBuffDisplay { 
  top: 15vh; /* CÃ¹ng Ä‘á»™ cao vá»›i Wave */
  left: 56.7%; 
  border-color: #8b5cf6; /* MÃ u tÃ­m */
}

@keyframes pulsing-glow-magnet {
  0% { box-shadow: 0 0 4px #8b5cf6, inset 0 0 4px #8b5cf6; }
  50% { box-shadow: 0 0 14px #a78bfa, inset 0 0 14px #a78bfa; }
  100% { box-shadow: 0 0 4px #8b5cf6, inset 0 0 4px #8b5cf6; }
}

#magnetBuffDisplay.active-glow {
    animation: pulsing-glow-magnet 2s infinite;
}
#crazymadnesstimeBuffDisplay { 
  top: 15vh; /* CÃ¹ng Ä‘á»™ cao vá»›i Wave */
  left: 65.7%; 
  border-color: #0613c5; /* MÃ u xanh dÆ°Æ¡ng */
}
@keyframes pulsing-glow-crazymadness {
  0%   { box-shadow: 0 0 4px #3b82f6, inset 0 0 4px #3b82f6; }
  50%  { box-shadow: 0 0 14px #60a5fa, inset 0 0 14px #60a5fa; }
  100% { box-shadow: 0 0 4px #3b82f6, inset 0 0 4px #3b82f6; }
}

/* Ãp dá»¥ng animation khi cÃ³ class active-glow */
#crazymadnesstimeBuffDisplay.active-glow {
    animation: pulsing-glow-crazymadness 1.5s infinite;
}
/* --- Báº®T Äáº¦U: CSS cho hiá»‡u á»©ng viá»n sÃ¡ng --- */

/* Äá»‹nh nghÄ©a animation cho buff Lucky (mÃ u xanh lÃ¡) */
@keyframes pulsing-glow-lucky {
  0% { box-shadow: 0 0 4px #22c55e, inset 0 0 4px #22c55e; }
  50% { box-shadow: 0 0 14px #34d399, inset 0 0 14px #34d399; }
  100% { box-shadow: 0 0 4px #22c55e, inset 0 0 4px #22c55e; }
}

/* Äá»‹nh nghÄ©a animation cho buff Power (mÃ u Ä‘á») */
@keyframes pulsing-glow-power {
  0% { box-shadow: 0 0 4px #ef4444, inset 0 0 4px #ef4444; }
  50% { box-shadow: 0 0 14px #f87171, inset 0 0 14px #f87171; }
  100% { box-shadow: 0 0 4px #ef4444, inset 0 0 4px #ef4444; }
}
/* Äá»‹nh nghÄ©a animation cho buff Crazy (mÃ u vÃ ng cam) */
@keyframes pulsing-glow-crazy {
  0% { box-shadow: 0 0 4px #f59e0b, inset 0 0 4px #f59e0b; }
  50% { box-shadow: 0 0 14px #fbbf24, inset 0 0 14px #fbbf24; }
  100% { box-shadow: 0 0 4px #f59e0b, inset 0 0 4px #f59e0b; }
}
@keyframes pulsing-glow-exp {
  0% { box-shadow: 0 0 4px #ffeb3b, inset 0 0 4px #ffeb3b; }
  50% { box-shadow: 0 0 14px #fff176, inset 0 0 14px #fff176; }
  100% { box-shadow: 0 0 4px #ffeb3b, inset 0 0 4px #ffeb3b; }
}

/* Ãp dá»¥ng animation khi cÃ³ class 'active-glow' */
#expBuffDisplay.active-glow {
    animation: pulsing-glow-exp 2s infinite;
}

/* Ãp dá»¥ng animation khi cÃ³ class 'active-glow' */
#crazyBuffDisplay.active-glow {
    animation: pulsing-glow-crazy 2s infinite;
}

/* Ãp dá»¥ng animation khi cÃ³ class 'active-glow' */
#luckyBuffDisplay.active-glow {
    /* TÃªn animation, thá»i gian 2 giÃ¢y, láº·p láº¡i vÃ´ háº¡n */
    animation: pulsing-glow-lucky 2s infinite;
}

#powerBuffDisplay.active-glow {
    animation: pulsing-glow-power 2s infinite;
}

/* --- Káº¾T THÃšC: CSS cho hiá»‡u á»©ng viá»n sÃ¡ng --- */

/* --- CSS cho Pause Menu (Gá»n hÆ¡n) --- */
#pauseMenu {
  max-width: 24rem; /* Giáº£m chiá»u rá»™ng tá»‘i Ä‘a */
  padding: 1.5rem; /* Giáº£m padding tá»•ng thá»ƒ */
  border-radius: 0.75rem; /* Bo trÃ²n nháº¹ hÆ¡n */
}

#pauseMenu h2 {
  font-size: 2rem; /* Giáº£m kÃ­ch thÆ°á»›c tiÃªu Ä‘á» */
  margin-bottom: 1rem;
}

.settings-section {
  margin-bottom: 1rem; /* Giáº£m margin */
  padding-bottom: 1rem; /* Giáº£m padding */
  border-bottom: 1px solid #446688;
}

.settings-section h3 {
  font-size: 1.2rem; /* Giáº£m kÃ­ch thÆ°á»›c tiÃªu Ä‘á» phá»¥ */
  margin-bottom: 0.75rem;
}

.debug-grid label {
  font-size: 0.9rem; /* Giáº£m kÃ­ch thÆ°á»›c label */
}

.range-container input {
  width: 70%; /* Äiá»u chá»‰nh chiá»u rá»™ng thanh trÆ°á»£t */
}

.range-container .range-value {
  font-size: 0.9rem; /* Giáº£m kÃ­ch thÆ°á»›c giÃ¡ trá»‹ */
}

.pause-menu-buttons {
  display: grid;
  grid-template-columns: 1fr; /* <-- Sá»­a thÃ nh 1fr Ä‘á»ƒ chá»‰ cÃ³ 1 cá»™t dá»c */
  gap: 0.75rem;
  margin-top: 0.5rem;
  justify-items: center;
}

.pause-menu-buttons button {
  width: 14rem; /* Chiá»u rá»™ng cá»‘ Ä‘á»‹nh, báº¡n cÃ³ thá»ƒ thay Ä‘á»•i sá»‘ nÃ y */
  max-width: 90%; /* Äáº£m báº£o khÃ´ng quÃ¡ to trÃªn mÃ n hÃ¬nh háº¹p */
  font-size: 0.9rem; /* Giáº£m kÃ­ch thÆ°á»›c chá»¯ nÃºt */
  padding: 0.6rem 1rem; /* Giáº£m padding nÃºt */
}

#resumeBtn {
  grid-column: 1 / -1;
  padding: 0.75rem 1.2rem; /* TÄƒng padding nÃºt Tiáº¿p tá»¥c má»™t chÃºt */
}
#pauseMenu.hidden {
    display: none;
}
#guideOverlay, #infoOverlay {
    z-index: 10001;
}

/* --- CSS cho Cá»­a hÃ ng (Shop) --- */
#shopOverlay {
  max-width: 40rem;
  min-height: auto;
}

#shopOverlay.hidden {
  display: none;
}

.shop-balance {
  font-size: 1.2rem;
  color: gold;
  margin-bottom: 1rem;
  text-shadow: 0 0 5px gold;
}

.shop-grid {
  display: grid;
  /* THAY Äá»”I: Giá»›i háº¡n chiá»u rá»™ng tá»‘i thiá»ƒu vÃ  tá»‘i Ä‘a cá»§a má»—i Ã´ */
  grid-template-columns: repeat(auto-fill, minmax(8rem, 1fr)); 
  gap: 0.75rem;
  margin-bottom: 1.5rem;
  max-height: 50vh;
  overflow-y: auto;
  padding: 0.5rem;
}

/* áº¨n thanh cuá»™n cho shop grid */
.shop-grid::-webkit-scrollbar { display: none; }
.shop-grid { -ms-overflow-style: none; scrollbar-width: none; }

.shop-item {
  background: #1a2b33;
  border: 1px solid #294e5a;
  border-radius: 0.5rem;
  /* THAY Äá»”I: Giáº£m padding Ä‘á»ƒ thu nhá» Ã´ váº­t pháº©m */
  padding: 0.5rem; 
  text-align: center;
  display: flex;
  flex-direction: column;
  justify-content: space-between;
  transition: all 0.2s ease;
}

.shop-item:hover {
    transform: translateY(-3px);
    border-color: var(--color-primary);
}

.shop-item .icon {
  font-size: 1.8rem;
}

.shop-item .name {
  font-weight: bold;
  margin: 0.4rem 0;
  font-size: 0.85rem;
  min-height: 2.2em;
}

.shop-item button {
  min-width: 8rem; /* Äáº£m báº£o nÃºt khÃ´ng quÃ¡ nhá» */
  padding: 0.5rem 1rem;
  /* THAY Äá»”I: Giáº£m padding Ä‘á»ƒ thu nhá» nÃºt báº¥m */
  margin: 0 auto; 
  font-size: 0.8rem;
  font-weight: bold;
  width: fit-content;
}
/* Bá»” SUNG: CSS Ä‘á»ƒ hiá»ƒn thá»‹ tooltip cho thanh EXP/HP */
#score-top[data-tooltip] {
  position: relative;
}
#score-top[data-tooltip]::after {
  content: attr(data-tooltip);
  position: absolute;
  left: 50%;
  top: 110%; /* Hiá»ƒn thá»‹ ngay bÃªn dÆ°á»›i thanh tráº¡ng thÃ¡i */
  transform: translateX(-50%);
  
  /* CÃ¡c style khÃ¡c cho tooltip */
  min-width: 10rem;
  white-space: pre-line;
  padding: .55rem .7rem;
  font-size: .8rem;
  background: rgba(0,0,0,.85);
  color: #e0f7fa;
  border: 1px solid #00ffff;
  border-radius: .5rem;
  pointer-events: none;
  opacity: 0;
  transition: opacity .25s;
  z-index: 10000;
}
#score-top:hover::after {
  opacity: 1;
}
/* âœ¨ CSS cho mÃ n hÃ¬nh táº£i game */
#loadingOverlay {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: var(--color-bg-dark);
  display: flex;
  justify-content: center;
  align-items: center;
  z-index: 10002; /* LuÃ´n ná»•i lÃªn trÃªn cÃ¹ng */
  transition: opacity 0.5s ease-out; /* Hiá»‡u á»©ng má» dáº§n khi áº©n */
}

#loadingOverlay.hidden {
    opacity: 0;
    pointer-events: none; /* VÃ´ hiá»‡u hÃ³a click khi Ä‘ang áº©n */
}

.loading-content {
  text-align: center;
}

#loadingText {
  color: var(--color-primary);
  font-size: var(--font-lg);
  margin-top: 1.5rem;
  animation: pulse 1.5s infinite ease-in-out;
}

/* Hiá»‡u á»©ng nháº¥p nhÃ¡y cho chá»¯ loading */
@keyframes pulse {
  0% { opacity: 0.6; }
  50% { opacity: 1; }
  100% { opacity: 0.6; }
}
/* CSS cho hÃ¬nh ná»n loading */
#loadingOverlay {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  
  /* MÃ u ná»n Ä‘en lÃ m dá»± phÃ²ng náº¿u áº£nh khÃ´ng táº£i Ä‘Æ°á»£c */
  background-color: var(--color-bg-dark); 
  
  /* Äáº·t trá»±c tiáº¿p hÃ¬nh ná»n duy nháº¥t cá»§a báº¡n táº¡i Ä‘Ã¢y */
  background-image: url('images/neon-night.png');
  
  background-size: cover;
  background-position: center;
  
  display: flex;
  justify-content: center;
  align-items: center;
  z-index: 10002;
}

/* káº¿t thÃºc style */
</style>
</head>
<body>
  <div id="loadingOverlay">
  <div class="loading-content">
    <h2 class="gameTitle">Zombie Survivor</h2>
    <p id="loadingText">Äang khá»Ÿi táº¡o...</p>
  </div>
</div>
<div class="ui-logo left-logo">Zombie<br>Survivor</div>
<div class="ui-logo right-logo">Bubble<br>Ver: 1.2</div>
<div id="ui">
  <button id="autoBtn" data-tooltip="âš™ï¸ Auto:
- Tá»± Ä‘á»™ng táº¥n cÃ´ng zombie gáº§n nháº¥t
- CÃ³ thá»ƒ táº¯t báº­t kÃ­ch hoáº¡t má»i lÃºc
- NÃ¢ng cáº¥p Ä‘á»ƒ tÄƒng tá»‘c Ä‘á»™ táº¥n cÃ´ng
- TÄƒng cáº¥p Ä‘á»ƒ tÄƒng sÃ¡t thÆ°Æ¡ng
- YÃªu cáº§u level 1
- SÃ¡t thÆ°Æ¡ng: 1
- TiÃªu hao: 0 âš¡">âš™ï¸ Auto</button>

  <button id="bladeBtn" data-tooltip="ğŸ”ª Ká»¹ nÄƒng Äao:
- Táº¡o 2~20 thanh Ä‘ao xoay quanh player
- Tá»‘i Ä‘a táº¡o Ä‘Æ°á»£c 20 Ä‘ao
- Bay vÃ o zombie gáº§n nháº¥t
- YÃªu cáº§u level 1
- SÃ¡t thÆ°Æ¡ng: 1
- Hiá»‡u lá»±c: 60s â±
- TiÃªu hao: 5 âš¡">ğŸ”ª Äao</button>

  <button id="swordBtn" data-tooltip="âš”ï¸ Ká»¹ nÄƒng Kiáº¿m:
- Táº¡o mÆ°a kiáº¿m rÆ¡i tá»«ng Ä‘á»£t
- Sá»‘ lÆ°á»£ng kiáº¿m tÄƒng theo level
- Bay vÃ o zombie gáº§n nháº¥t
- YÃªu cáº§u level 2
- SÃ¡t thÆ°Æ¡ng: 1
- Hiá»‡u lá»±c: 60s â±
- TiÃªu hao: 6 âš¡">âš”ï¸ Kiáº¿m</button>

  <button id="fireBtn" data-tooltip="ğŸ”¥ Ká»¹ nÄƒng Lá»­a:
- Táº¡o 2 quáº£ cáº§u lá»­a quay quanh
- Táº¡o Ä‘Æ°á»£c tá»‘i Ä‘a 10 quáº£ cáº§u lá»­a
- TiÃªu diá»‡t zombie cháº¡m vÃ o
- YÃªu cáº§u level 3
- SÃ¡t thÆ°Æ¡ng: 1
- Hiá»‡u lá»±c: 60s â±
- TiÃªu hao: 8 âš¡">ğŸ”¥ Lá»­a</button>

  <button id="iceBtn" data-tooltip="â„ï¸ Ká»¹ nÄƒng BÄƒng:
- Táº¡o 2 quáº£ cáº§u bÄƒng lá»›n xoay quanh
- Táº¡o Ä‘Æ°á»£c tá»‘i Ä‘a 10 quáº£ cáº§u bÄƒng
- GÃ¢y sÃ¡t thÆ°Æ¡ng diá»‡n rá»™ng
- YÃªu cáº§u level 3
- SÃ¡t thÆ°Æ¡ng: 1
- Hiá»‡u lá»±c: 60s â±
- TiÃªu hao: 12 âš¡">â„ï¸ BÄƒng</button>

  <button id="thunderBtn" data-tooltip="ğŸ”µ Ká»¹ nÄƒng thunder:
- Táº¡o 2 quáº£ cáº§u lÃ´i xoay quanh
- Táº¡o Ä‘Æ°á»£c tá»‘i Ä‘a 6 quáº£ cáº§u
- GÃ¢y sÃ¡t thÆ°Æ¡ng vÃ  lÃ m choÃ¡ng
- YÃªu cáº§u level 5
- SÃ¡t thÆ°Æ¡ng: 1
- Hiá»‡u lá»±c: 60s â±
- TiÃªu hao: 18 âš¡">ğŸ”µ LÃ´i</button>

<button id="supportAuraBtn" data-tooltip="âœ¨ Ká»¹ nÄƒng hÃ o quang:
- Táº¡o má»™t vÃ¹ng phÃ©p thuáº­t dÆ°á»›i chÃ¢n.
- TÄƒng 20% tá»‘c Ä‘á»™ cháº¡y vÃ  tá»‘c Ä‘á»™ báº¯n.
- Giáº£m 50% sÃ¡t thÆ°Æ¡ng tá»« má»i nguá»“n.
- Há»“i 1 HP má»—i giÃ¢y.
- YÃªu cáº§u level 6
- Hiá»‡u lá»±c: 60s â±
- TiÃªu hao: 15 âš¡">âœ¨ Heal</button>

<button id="fairyBtn" data-tooltip="ğŸ¦‹ Ká»¹ nÄƒng Fairy:
- Triá»‡u há»“i Fairy há»— trá»£.
- Há»“i mÃ¡u má»—i 3s. GiÃºp há»“i sinh player.
- TÄƒng sÃ¡t thÆ°Æ¡ng player.
- Giáº£m sÃ¡t thÆ°Æ¡ng zombie.
- YÃªu cáº§u level 7
- Hiá»‡u lá»±c: 60s â±
- TiÃªu hao: 25 âš¡">ğŸ¦‹ Fairy</button>

  <button id="PetBtn" data-tooltip="ğŸ° Ká»¹ nÄƒng Pet:
- Triá»‡u há»“i 1 rabbit cute Ä‘i theo player
- Há»— trá»£: nháº·t váº­t pháº©m
- Há»— trá»£: tÄƒng sÃ¡t thÆ°Æ¡ng
- Báº¯n carrot lÃ m choÃ¡ng zombie.
- Há»— trá»£: Há»“i 1 HP má»—i 3s
- Hiá»‡u lá»±c: 60s â±
- TiÃªu hao: 5 âš¡">ğŸ° Pet</button>

  <div id="score">
    <div id="score-top" data-tooltip="Exp cáº¥p tiáº¿p theo: --">Exp: 0000 |â¤ï¸: 0010</div>
    <div id="score-bottom">Level: 0001 |âš¡: 0000</div>
  </div>
</div>
<canvas id="game" width="960" height="720"></canvas>

<!-- ğŸ“‹ Menu báº¯t Ä‘áº§u game -->
<div id="startMenu">
  <h2 class="gameTitle">Zombie Survivor</h2>
<input type="text" id="playerNameInput" placeholder="Nháº­p tÃªn cá»§a báº¡n" class="custom-input" />
  <button onclick="startGame()">ğŸ® Báº¯t Ä‘áº§u</button>
  <button onclick="showGuide()">ğŸ“˜ HÆ°á»›ng dáº«n</button>
  <button onclick="showInfo()">â„¹ï¸ ThÃ´ng tin</button>
</div>
<div id="guideOverlay" class="infoOverlay" style="display: none;">
<h3 style="margin-top: 0; color: #66aaff;">ğŸ“˜ HÆ°á»›ng dáº«n chÆ¡i</h3>
  <ul style="text-align: left;">
    <li>TiÃªu diá»‡t zombie Ä‘á»ƒ lÃªn cáº¥p</li>
    <li>Má»—i wave, level sáº½ Ä‘Æ°á»£c nÃ¢ng cáº¥p ká»¹ nÄƒng</li>
    <li>TrÃ¹m cuá»‘i siÃªu khÃ³ nÃªn trÃ¡nh xa khi cÃ²n yáº¿u</li>
    <li>Nháº·t váº­t pháº©m Ä‘á»ƒ tÄƒng mÃ¡u, mana, nÄƒng lÆ°á»£ng</li>
    <li>Nháº¥n phÃ­m Space Ä‘á»ƒ sá»­ dá»¥ng ká»¹ nÄƒng Ä‘áº·c biá»‡t</li>
    <li>Báº¥m X: má»Ÿ danh sÃ¡ch ká»¹ nÄƒng</li>
    <li>Báº¥m Z: má»Ÿ báº£ng thá»‘ng kÃª</li>
    <li>Báº¥m M: má»Ÿ báº£ng báº£n Ä‘á»“</li>
    <li>Báº¥m O: má»Ÿ Shop. ESC: má»Ÿ Menu</li>
    <li>Váº­t pháº©m trong game: Energy, Mana, HP, Box</li>
  </ul>
  <div class="spacerguide"></div> <!-- ğŸ‘ˆ dÃ²ng Ä‘á»‡m -->
  <button onclick="hideGuide()">ÄÃ³ng</button>
</div>
<div id="infoOverlay" class="infoOverlay" style="display: none;">
  <h3 style="margin-top: 0; color: #66aaff;">â„¹ï¸ ThÃ´ng tin</h3>
  <div class="infoContent">
    <p>PhiÃªn báº£n: 1.2<br>
       TÃ¡c giáº£: Dang<br>
       Cáº­p nháº­t: 2025-07-31</p>
    <p style="margin: 0; text-align: left;"><strong style="color: #00cc66;">ğŸ†• New</strong></p>
    <!-- Pháº§n cÃ³ thá»ƒ cuá»™n vÃ  canh trÃ¡i -->
    <div style="max-height: 128px;overflow-y: auto;scrollbar-width: none;
    -ms-overflow-style: none;text-align: left;">
      <ul style="padding-left: 20px;margin-top: 2px;list-style-type: disc;">
        <li>ThÃªm minimap</li>
        <li>TÄƒng giá»›i háº¡n báº£n Ä‘á»“</li>
        <li>TÄƒng giá»›i háº¡n sá»‘ lÆ°á»£ng Zombie</li>
        <li>ThÃªm Boss to hÆ¡n</li>
        <li>Cáº£i tiáº¿n má»™t sá»‘ ká»¹ nÄƒng</li>
        <li>ThÃªm há»‡ thá»‘ng ngÃ y Ä‘Ãªm</li>
        <li>ThÃªm ká»¹ nÄƒng há»— trá»£</li>
        <li>ThÃªm Shop vÃ  Menu cÃ i Ä‘áº·t</li>
        <li>ThÃªm váº­t pháº©m má»›i: Coin, lucky, power, crazy</li>
        <!-- CÃ¡c má»¥c má»›i cÃ³ thá»ƒ thÃªm á»Ÿ Ä‘Ã¢y -->
      </ul>
    </div>
    <!-- áº¨n scrollbar trÃªn Chrome/Safari -->
    <style>
      .infoContent div::-webkit-scrollbar {
        display: none;
      }
    </style>
  </div>
  <div class="spacer"></div>
  <button onclick="hideInfo()">ÄÃ³ng</button>
</div>

<!-- ğŸ’€ Game Over Panel -->
<div id="gameOverPanel" class="gameOverPanel">
  <h2 class="gameOverTitle">Game Over</h2>
  <button onclick="resetGame()" class="restartButton">ChÆ¡i láº¡i</button>
</div>

<!-- ğŸŒŠ Popup khi báº¯t Ä‘áº§u má»—i Wave -->
<div id="wavePopup">Wave 1</div>

<!-- â³ Äá»“ng há»“ Ä‘áº¿m thá»i gian wave -->
<div id="dayCounterDisplay">NgÃ y: 1</div>
<div id="bigBossRespawnDisplay">BigBoss: wait..</div>
<div id="waveTimerDisplay">01:30:00</div>
<div id="waveNumberDisplay">Wave: 1</div>
<div id="coinCounterDisplay">ğŸª™: 0000</div>
<div id="luckyBuffDisplay" class="buff-display">ğŸ€ LuckyUp: <span>--</span>-</div>
<div id="powerBuffDisplay" class="buff-display">ğŸ PowerUp: <span>--</span>-</div>
<div id="crazyBuffDisplay" class="buff-display">ğŸ‚ CarzyUp: <span>--</span>-</div>
<div id="expBuffDisplay" class="buff-display">ğŸŒ¿ ExpUp: <span>--</span>-</div>
<div id="magnetBuffDisplay" class="buff-display">ğŸ§² Magnet: <span>---</span></div>
<div id="crazymadnesstimeBuffDisplay" class="buff-display">ğŸ’¢ CrazyMadnessTime: <span>---</span></div>

<!-- Mini map -->
<canvas id="miniMap" width="150" height="150"></canvas>
<script>
// --- Báº®T Äáº¦U: Há»† THá»NG Ã‚M THANH & NHáº C Ná»€N HOÃ€N CHá»ˆNH ---

// Danh sÃ¡ch ID vÃ  file nháº¡c
const normalMusicTracks = ['music-background', 'music-background-2', 'music-background-3'];
const bossMusicId = 'music-boss';
const luckyMusicId = 'sfx-lucky-loop';
const powerMusicId = 'sfx-power-loop';
const crazyMusicId = 'sfx-crazy-loop';
const expMusicId = 'sfx-exp-loop';
const crazyMadnessMusicId = 'sfx-power-loop'; // DÃ¹ng chung vá»›i Power
// Biáº¿n tráº¡ng thÃ¡i
let currentMusicState = '';
let currentNormalTrackId = '';

// Bá»” SUNG Láº I HÃ€M Bá»Š THIáº¾U: Cáº­p nháº­t Ã¢m lÆ°á»£ng cho táº¥t cáº£ cÃ¡c track nháº¡c
function updateAllMusicVolume() {
    // TÃ­nh toÃ¡n Ã¢m lÆ°á»£ng cuá»‘i cÃ¹ng dá»±a trÃªn thanh trÆ°á»£t Tá»•ng vÃ  Nháº¡c ná»n
    const finalMusicVol = musicVolume * masterVolume;
    // Ãp dá»¥ng Ã¢m lÆ°á»£ng cho táº¥t cáº£ cÃ¡c tháº» audio dÃ¹ng cho nháº¡c
    document.querySelectorAll('audio[id^="music-"], audio[id^="sfx-"][loop]').forEach(audio => {
        if (audio) audio.volume = finalMusicVol;
    });
}

// HÃ m phÃ¡t hiá»‡u á»©ng Ã¢m thanh (SFX)
function playSound(id, baseVolume = 1.0) {
    const soundData = sfxPool[id];
    
    // Náº¿u khÃ´ng tÃ¬m tháº¥y Ã¢m thanh trong kho, khÃ´ng lÃ m gÃ¬ cáº£
    if (!soundData || soundData.pool.length === 0) {
        return;
    }

    // Láº¥y Ä‘á»‘i tÆ°á»£ng Audio tiáº¿p theo trong kho theo kiá»ƒu xoay vÃ²ng (Round-robin)
    let audio = soundData.pool[soundData.currentIndex];

    // Cáº­p nháº­t con trá» cho láº§n gá»i tiáº¿p theo
    soundData.currentIndex = (soundData.currentIndex + 1) % soundData.pool.length;
    
    // Äáº·t láº¡i thá»i gian vÃ  Ã¢m lÆ°á»£ng, sau Ä‘Ã³ phÃ¡t
    audio.currentTime = 0;
    audio.volume = baseVolume * sfxVolume * masterVolume;
    audio.play().catch(e => {
        // Lá»—i nÃ y thÆ°á»ng xáº£y ra khi ngÆ°á»i dÃ¹ng chÆ°a tÆ°Æ¡ng tÃ¡c vá»›i trang, cÃ³ thá»ƒ bá» qua
    });
}

// HÃ m dá»«ng táº¥t cáº£ nháº¡c ná»n
function stopAllMusic() {
    document.querySelectorAll('audio[id^="music-"], audio[id^="sfx-"][loop]').forEach(audio => {
        if(audio) { audio.pause(); audio.currentTime = 0; }
    });
}

// HÃ m phÃ¡t nháº¡c ná»n ngáº«u nhiÃªn
function playRandomNormalMusic() {
    const availableTracks = normalMusicTracks.filter(id => id !== currentNormalTrackId);
    const randomTrackId = availableTracks.length ? availableTracks[Math.floor(Math.random() * availableTracks.length)] : normalMusicTracks[0];
    
    stopAllMusic();
    const trackElement = document.getElementById(randomTrackId);
    if (trackElement) {
        updateAllMusicVolume(); // Gá»i hÃ m Ä‘á»ƒ Ä‘áº·t Ä‘Ãºng Ã¢m lÆ°á»£ng
        trackElement.play().catch(e => console.error("Lá»—i phÃ¡t nháº¡c thÆ°á»ng:", e));
    }
    currentNormalTrackId = randomTrackId;
    currentMusicState = 'normal';
}

// HÃ m cáº­p nháº­t nháº¡c ná»n chÃ­nh
function updateMusic() {
    const now = Date.now();
    const bigBoss = zombies.find(z => z.active && z.isBigBoss);
    
    // TÃ¬m buff cÃ³ thá»i gian káº¿t thÃºc xa nháº¥t (Ä‘Æ°á»£c nháº·t sau cÃ¹ng)
    let latestBuffEndTime = 0;
    let highestPriorityState = null;

    // Láº¥y thá»i gian káº¿t thÃºc cá»§a cÃ¡c buff
    if (now < expBuffEndTime && expBuffEndTime > latestBuffEndTime) {
        latestBuffEndTime = expBuffEndTime;
        highestPriorityState = 'exp';
    }
    if (now < crazyBuffEndTime && crazyBuffEndTime > latestBuffEndTime) {
        latestBuffEndTime = crazyBuffEndTime;
        highestPriorityState = 'crazy';
    }
    if (now < powerBuffEndTime && powerBuffEndTime > latestBuffEndTime) {
        latestBuffEndTime = powerBuffEndTime;
        highestPriorityState = 'power';
    }
    if (now < luckyBuffEndTime && luckyBuffEndTime > latestBuffEndTime) {
        latestBuffEndTime = luckyBuffEndTime;
        highestPriorityState = 'lucky';
    }

    //  BÆ¯á»šC 1: THÃŠM CRAZYMADNESSTIME VÃ€O DANH SÃCH KIá»‚M TRA
    if (now < crazyMadnessTimeEndTime && crazyMadnessTimeEndTime > latestBuffEndTime) {
        latestBuffEndTime = crazyMadnessTimeEndTime;
        highestPriorityState = 'crazymadness';
    }

    // XÃ¡c Ä‘á»‹nh tráº¡ng thÃ¡i nháº¡c cuá»‘i cÃ¹ng
    let desiredState = 'normal';
    // Náº¿u cÃ³ buff nÃ o Ä‘ang hoáº¡t Ä‘á»™ng, Æ°u tiÃªn buff Ä‘Ã³
    if (highestPriorityState) {
        desiredState = highestPriorityState;
    } else if (bigBoss) {
        desiredState = 'boss';
    }

    // Chá»‰ Ä‘á»•i nháº¡c khi tráº¡ng thÃ¡i thay Ä‘á»•i
if (desiredState !== currentMusicState) {
        stopAllMusic();
        let trackToPlayId = null;

        // BÆ¯á»šC 2: Cáº¬P NHáº¬T ID PHÃT NHáº C Dá»°A TRÃŠN TRáº NG THÃI
        if (desiredState === 'crazymadness') trackToPlayId = crazyMadnessMusicId; 
        else if (desiredState === 'exp') trackToPlayId = expMusicId;
        else if (desiredState === 'crazy') trackToPlayId = crazyMusicId;
        else if (desiredState === 'lucky') trackToPlayId = luckyMusicId;
        else if (desiredState === 'power') trackToPlayId = powerMusicId;
        else if (desiredState === 'boss') trackToPlayId = bossMusicId;
        else { 
            playRandomNormalMusic(); 
            return; 
        }
        
        const trackElement = document.getElementById(trackToPlayId);
        if (trackElement) {
            updateAllMusicVolume();
            trackElement.play().catch(e => console.error(`Lá»—i phÃ¡t nháº¡c cho tráº¡ng thÃ¡i '${desiredState}':`, e));
        }
        currentMusicState = desiredState;
    }
}
// --- Káº¾T THÃšC: Há»† THá»NG Ã‚M THANH & NHáº C Ná»€N ---
// ğŸ§± 1. Biáº¿n toÃ n cá»¥c â€“ Cáº¥u hÃ¬nh & Khá»Ÿi táº¡o
let camera = { x: 0, y: 0 }; // ğŸ“· Vá»‹ trÃ­ camera
let backgroundStars = [];
let backgroundBirds = [];
let backgroundTrees = [];
let backgroundClouds = [];
let backgroundPlanes = [];
let backgroundMushrooms = [];
let backgroundRocks = [];
let backgroundBalloons = [];
let backgroundSeeds = [];
let dayTime = 0.25; // 0.25 = 6h
let dayDirection = 1; // giá»¯ láº¡i cá» nÃ y nhÆ° cÅ©
const dayDuration = 600; // 1 vÃ²ng ngÃ y Ä‘Ãªm = 96 giÃ¢y thá»±c táº¿
let lastUpdateTime = Date.now();
let prevIsNight = isNight();
let backgroundBigStars = [];
let globalDeltaTime = 0;
let currentDay = 1; // âœ¨ biáº¿n Ä‘áº¿m sá»‘ ngÃ y trÃ´i qua
// ğŸ¦‹ Tráº¡ng thÃ¡i ká»¹ nÄƒng Fairy
let fairyActive = false;
let fairyEndTime = 0;
let fairies = []; // Máº£ng chá»©a cÃ¡c Fairy
let lastFairyHealTime = 0;
let fairyDamageBonus = 0; // LÆ°u láº¡i má»©c sÃ¡t thÆ°Æ¡ng cá»™ng thÃªm
let fairyDeathDefyAvailable = false; // Cá» cho cÆ¡ cháº¿ há»“i sinh
let lastShieldBlockSoundTime = 0;
let luckyBuffEndTime = 0;
let powerBuffEndTime = 0;
let isPowerBuffActive = false; // Biáº¿n cá» Ä‘á»ƒ trÃ¡nh nhÃ¢n/chia sÃ¡t thÆ°Æ¡ng nhiá»u láº§n
let crazyBuffEndTime = 0;
let isCrazyBuffActive = false;
let expBuffEndTime = 0;
let magnetBuffEndTime = 0;
let crazyMadnessTimeEndTime = 0;
let isCrazyMadnessTimeActive = false;
let crazyMadnessTimeBuffStats = {};
let supplyDrops = []; // Máº£ng chá»©a cÃ¡c kiá»‡n hÃ ng ğŸª‚
let morningDropTriggered = false; // Cá» Ä‘á»ƒ Ä‘áº£m báº£o chá»‰ rÆ¡i 1 láº§n má»—i 9h sÃ¡ng
let morningDropTriggered12h = false;    // Cho 12h
let morningDropTriggered15h = false;    // Cho 15h
// Dá»¯ liá»‡u quáº£n lÃ½ hiá»‡u á»©ng Ä‘Ã³m sÃ¡ng cho cÃ¡c buff
const buffEffects = {
    power:  { color: "#ef4444", active: false, angle: 0 }, // Äá» (Power)
    crazy:  { color: "#f59e0b", active: false, angle: 0 }, // VÃ ng cam (Crazy)
    lucky:  { color: "#22c55e", active: false, angle: 0 }, // Xanh lÃ¡ (Lucky)
    exp:    { color: "#ffeb3b", active: false, angle: 0 }, // VÃ ng (Exp)
    magnet: { color: "#8b5cf6", active: false, angle: 0 }, // TÃ­m (Magnet)
    crazymadness: { color: "#3b82f6", active: false, angle: 0 }, // Xanh dÆ°Æ¡ng (CrazyMadnessTime)
};
// --- Tá»‰ lá»‡ rÆ¡i váº­t pháº©m trong game ---
const itemDropTable = [
  // --- Váº­t pháº©m SiÃªu hiáº¿m ---
  { type: 'crazymadnesstime', chance: 0.002 }, // 0.2%

  // --- Váº­t pháº©m Hiáº¿m ---
  { type: 'box',              chance: 0.008 }, // 0.8%
  { type: 'magnet',           chance: 0.003 }, // 0.3%
  { type: 'secret',           chance: 0.200 }, // 20%
  { type: 'potion',           chance: 0.015 }, // 1.5%

  // --- Buff (Ä‘Ã£ giáº£m) ---
  { type: 'lucky',            chance: 0.003 }, // 0.3%
  { type: 'power',            chance: 0.003 }, // 0.3%
  { type: 'crazy',            chance: 0.003 }, // 0.3%
  { type: 'exp',              chance: 0.003 }, // 0.3%

  // --- ThÆ°á»ng ---
  { type: 'expBonus',         chance: 0.010 }, // 1.0%
  { type: 'hp',               chance: 0.050 }, // 5.0%

  // â­ Äiá»u chá»‰nh táº¡i Ä‘Ã¢y
  { type: 'coin',             chance: 0.200 }, // 20%
  { type: 'mana',             chance: 0.250 }, // 25%
  { type: 'energy',           chance: 0.250 } // 25%

];

// Biáº¿n Ä‘á»ƒ lÆ°u trá»¯ lÆ°á»£ng chá»‰ sá»‘ cá»™ng thÃªm tá»« buff, giÃºp gá»¡ bá» chÃ­nh xÃ¡c
let powerBuffDamageBonus = 0;
let crazyBuffStats = { speed: 0, bulletSpeed: 0, damage: 0 };

let debugKeyTimer = null; // Biáº¿n Ä‘á»ƒ lÆ°u timer cá»§a phÃ­m Debug
// Menu ESC
let masterVolume = 1.0;
let musicVolume = 0.5;
let sfxVolume = 0.8;
// (ThÃªm vÃ o cÃ¹ng cÃ¡c biáº¿n toÃ n cá»¥c khÃ¡c)
const shopItems = [
    { id: 'buy_10_mana',   name: '10 Mana',   icon: 'ğŸ’ ', cost: 1, type: 'resource', value: 10 },
    { id: 'buy_10_energy', name: '10 Energy', icon: 'âš¡', cost: 1, type: 'resource', value: 10 },
    { id: 'buy_5_hp',      name: '5 HP',      icon: 'â¤ï¸', cost: 1, type: 'resource', value: 5 },
    { id: 'buy_12_hp',      name: '12 HP',      icon: 'â¤ï¸', cost: 2, type: 'resource', value: 12 },
    { id: 'buy_damage',    name: 'SÃ¡t thÆ°Æ¡ng +0.2', icon: 'ğŸ’¥', cost: 3, type: 'permanent_upgrade', value: 0.2 },
    // Báº¡n cÃ³ thá»ƒ thÃªm cÃ¡c váº­t pháº©m khÃ¡c vÃ o Ä‘Ã¢y
];
// âœ¨ DANH SÃCH CÃC LOáº I ZOMBIE âœ¨
const zombieTypes = [
    // 4 loáº¡i cÅ©
    "Walker", "Brute", "Spitter", "Mutant",
    // 48 loáº¡i má»›i tá»« file cá»§a báº¡n
    "Cyber", "Hunter", "Shadow", "Arcanist", "Soldier", "Robot",
    "Knight", "Rogue", "Wraith", "Astronaut", "Beast", "Spectre",
    "Ninja", "Samurai", "Alien", "Skeleton", "Mage", "Ghost",
    "Monk", "Cyborg", "Shaman", "Demon", "Angel", "Guardian",
    "Pilot", "Engineer", "Android", "Starfighter", "Commander", "Medic",
    "Barbarian", "Paladin", "Druid", "Necromancer", "Archer", "Sorcerer",
    "Bard", "Cleric", "Vampire", "Werewolf", "Goblin", "Elf",
    "Dwarf", "Orc", "Detective", "Swat", "Firefighter", "Doctor"
];
let lastBigBossTimerUpdate = performance.now();
let bigBossRespawnTimer = 0;
const bigBossRespawnInterval = 10; // Thá»i gian há»“i sinh bigboss - giÃ¢y
// Táº O BIáº¾N CHá»¨A KHO Ã‚M THANH
const sfxPool = {}; // Má»—i key lÃ  má»™t ID Ã¢m thanh, value lÃ  má»™t máº£ng cÃ¡c Ä‘á»‘i tÆ°á»£ng Audio

/**
 * Táº O HÃ€M KHá»I Táº O KHO Ã‚M THANH
 * HÃ m nÃ y sáº½ cháº¡y má»™t láº§n duy nháº¥t khi game báº¯t Ä‘áº§u.
 * NÃ³ sáº½ táº¡o sáºµn má»™t sá»‘ lÆ°á»£ng Ä‘á»‘i tÆ°á»£ng Audio cho má»—i hiá»‡u á»©ng Ã¢m thanh.
 * @param {number} poolSize - Sá»‘ lÆ°á»£ng Ä‘á»‘i tÆ°á»£ng Audio táº¡o sáºµn cho má»—i Ã¢m thanh.
 */
function initAudioPool(poolSize = 5, onProgress, onComplete) {
    console.log("Initializing audio resources...");
    
    // TÃ¬m táº¥t cáº£ cÃ¡c tháº» audio cáº§n táº£i trÆ°á»›c
    const sfxElements = document.querySelectorAll('audio[id^="sfx-"]');
    const musicElements = document.querySelectorAll('audio[id^="music-"]');
    
    let totalToLoad = (sfxElements.length * poolSize) + musicElements.length;
    let loadedCount = 0;

    // HÃ m nÃ y Ä‘Æ°á»£c gá»i má»—i khi má»™t file audio táº£i xong
    const handleLoad = () => {
        loadedCount++;
        if (onProgress) {
            onProgress(loadedCount, totalToLoad); // Gá»­i tiáº¿n trÃ¬nh ra ngoÃ i
        }
        if (loadedCount >= totalToLoad && onComplete) {
            onComplete(); // Gá»i callback khi hoÃ n táº¥t
        }
    };

    // Xá»­ lÃ½ cÃ¡c file hiá»‡u á»©ng SFX (táº¡o thÃ nh kho)
    sfxElements.forEach(audioElement => {
        const id = audioElement.id;
        sfxPool[id] = {
            pool: [],
            currentIndex: 0
        };
        for (let i = 0; i < poolSize; i++) {
            const audio = new Audio(audioElement.src);
            // Láº¯ng nghe sá»± kiá»‡n canplaythrough Ä‘á»ƒ biáº¿t khi nÃ o cÃ³ thá»ƒ phÃ¡t
            audio.addEventListener('canplaythrough', handleLoad, { once: true });
            audio.load();
            sfxPool[id].pool.push(audio);
        }
    });

    // Xá»­ lÃ½ cÃ¡c file nháº¡c ná»n (chá»‰ cáº§n táº£i 1 láº§n)
    musicElements.forEach(audioElement => {
        audioElement.addEventListener('canplaythrough', handleLoad, { once: true });
        audioElement.load();
    });

    // Xá»­ lÃ½ trÆ°á»ng há»£p khÃ´ng cÃ³ audio nÃ o Ä‘á»ƒ táº£i
    if (totalToLoad === 0 && onComplete) {
        onComplete();
    }
}

// ğŸ”« Cáº¥u hÃ¬nh báº¯n
let autoBurstIndex = 0;
let autoLastBurstTime = 0;
let clickShotMode = 5; // 0: xoáº¯n á»‘c, 1: zigzag, 2: spiral, 3: xuyÃªn tháº³ng, 4: máº·c Ä‘á»‹nh

const autoBurstDelay = 100; // ms delay giá»¯a tá»«ng viÃªn trong auto

// ğŸ§Ÿ Thá»‘ng kÃª â€“ Ká»¹ nÄƒng & zombie
let zombieKillCount = 0;
let zombieSpawnedCount = 0;
let zombieByLevel = {};
for (let i = 1; i <= 10; i++) zombieByLevel[i] = 0;
zombieByLevel.boss = 0;
zombieByLevel.miniBoss = 0;
let skillStats = {};             // ğŸ“Š Thá»‘ng kÃª ká»¹ nÄƒng
// ğŸ¯ EXP lÃªn cáº¥p
const INITIAL_REQUIRED_EXP = 50; // EXP cáº§n Ä‘á»ƒ lÃªn cáº¥p
// ğŸ§ Tráº¡ng thÃ¡i ngÆ°á»i chÆ¡i
const player = {
  x: 480, y: 360, size: 20, speed: 1,
  hearts: 10, energy: 0, mana: 0,
  coins: 0,
  level: 1, score: 0,
  exp: 0,
  currentLevelExp: 0, // EXP hiá»‡n táº¡i cá»§a level
  requiredExp: INITIAL_REQUIRED_EXP,  // EXP cáº§n Ä‘á»ƒ lÃªn cáº¥p
  hitTimer: 0,
  name: "Player",
  isDying: false,
  isTeleporting: false,      // Cá» bÃ¡o hiá»‡u Ä‘ang trong quÃ¡ trÃ¬nh dá»‹ch chuyá»ƒn
  isGrowingAfterTeleport: false, // Cá» bÃ¡o hiá»‡u Ä‘ang lá»›n dáº§n ra sau khi dá»‹ch chuyá»ƒn
  originalSize: 20,          // DÃ¹ng Ä‘á»ƒ lÆ°u láº¡i kÃ­ch thÆ°á»›c gá»‘c
};

// ğŸŒŸ Tráº¡ng thÃ¡i nÃ¢ng cáº¥p
const playerUpgrades = {
  fireRate: 1,          // ğŸ”« HÆ°á»›ng báº¯n
  damageBoost: 1,       // ğŸ’¥ SÃ¡t thÆ°Æ¡ng cÆ¡ báº£n cá»™ng thÃªm
  hpBoost: 0,           // â¤ï¸ Sá»‘ láº§n Ä‘Ã£ tÄƒng mÃ¡u
  bulletSpeed: 1,       // ğŸ’¨ Tá»‘c Ä‘á»™ Ä‘áº¡n
  lineBulletCount: 1    // ğŸ§¨ Sá»‘ lÆ°á»£ng Ä‘áº¡n
};
// ğŸŒŸ Biáº¿n nÃ¢ng cáº¥p ká»¹ nÄƒng máº·c Ä‘á»‹nh (ğŸ”ª Äao, âš”ï¸ Kiáº¿m, ğŸ”¥ Lá»­a, â„ï¸ BÄƒng)
const skillUpgrades = {
  // ğŸ”ª Äao: sá»‘ lÆ°á»£ng Ä‘ao vÃ  sÃ¡t thÆ°Æ¡ng tá»«ng Ä‘ao
  bladeCount: 2,           // báº¯t Ä‘áº§u 2 Ä‘ao, tá»‘i Ä‘a 20
  bladeDamage: 1,          // sÃ¡t thÆ°Æ¡ng tá»«ng Ä‘ao

  // âš”ï¸ Kiáº¿m: cáº¥p Ä‘á»™ mÆ°a kiáº¿m (sá»‘ lÆ°á»£ng + sÃ¡t thÆ°Æ¡ng)
  swordLevel: 1,           // cáº¥p Ä‘á»™ mÆ°a kiáº¿m, tá»‘i Ä‘a 10
  swordDamage: 3,          // sÃ¡t thÆ°Æ¡ng má»—i kiáº¿m

  // ğŸ”¥ Lá»­a: sá»‘ lÆ°á»£ng cáº§u lá»­a vÃ  sÃ¡t thÆ°Æ¡ng
  fireCount: 2,            // báº¯t Ä‘áº§u 2 quáº£ cáº§u, tá»‘i Ä‘a 10
  fireDamage: 1,           // sÃ¡t thÆ°Æ¡ng má»—i quáº£

  // â„ï¸ BÄƒng: sá»‘ lÆ°á»£ng cáº§u bÄƒng vÃ  sÃ¡t thÆ°Æ¡ng
  iceCount: 2,             // báº¯t Ä‘áº§u 2 quáº£ cáº§u, tá»‘i Ä‘a 10
  iceDamage: 2,             // sÃ¡t thÆ°Æ¡ng má»—i quáº£
  // LÃ´i
  thunderCount: 2,         // báº¯t Ä‘áº§u 2 quáº£ cáº§u lÃ´i, tá»‘i Ä‘a 6
  thunderDamage: 3,        // sÃ¡t thÆ°Æ¡ng má»—i quáº£ cáº§u lÃ´i
  // ğŸ¦‹ NÃ¢ng cáº¥p ká»¹ nÄƒng Fairy
  fairyCount: 1,      // Sá»‘ lÆ°á»£ng Fairy, tá»‘i Ä‘a 3
  fairyHealLevel: 0,  // Cáº¥p Ä‘á»™ há»“i mÃ¡u
  fairyDamageLevel: 0, // Cáº¥p Ä‘á»™ tÄƒng sÃ¡t thÆ°Æ¡ng
  
  auraHealLevel: 0, // Cáº¥p Ä‘á»™ há»“i mÃ¡u cá»§a HÃ o quang, báº¯t Ä‘áº§u tá»« 0

};
let petActive = false;
let petEndTime = 0;
let petRabbit = null;
let petLastHealTime = 0;
/* â”€â”€ chá»‘ng chá»n láº¡i mÃ³n Ä‘á»“ vá»«a bá» â”€â”€ */
let lastGiveUpId   = null;   // id mÃ³n Ä‘á»“ vá»«a bá»‹ bá»
let lastGiveUpTime = 0;      // má»‘c thá»i gian bá»
const RESELECT_CD  = 2000;   // 2 000 ms â†’ cáº¥m chá»n láº¡i 2 s
let auraCrackLines = []; // Máº£ng chá»©a cÃ¡c Ä‘Æ°á»ng ná»©t phÃ¡t sÃ¡ng dÆ°á»›i Ä‘áº¥t
let auraLightBeams = []; // Máº£ng chá»©a cÃ¡c cá»™t sÃ¡ng bay lÃªn
let supportAuraActive = false;
let supportAuraEndTime = 0;
let lastAuraHealTime = 0;
// âš™ï¸ Tráº¡ng thÃ¡i Ä‘iá»u khiá»ƒn & ká»¹ nÄƒng
let lastManualShootTime = 0;
const manualShootCooldown = 500; // delay 1 giÃ¢y
let lastAutoShootTime = 0;
const autoShootCooldown = 500;
let playerLasers = []; // Máº£ng chá»©a cÃ¡c tia laze cá»§a ngÆ°á»i chÆ¡i

let keys = {};
let autoShoot = false;
let fireActive = false;
let iceActive = false;
let swordActive = false;
let bladeActive = false;
let frame = 0;
let gameOver = false;
let isPaused = false;
let pendingWave = null;
let uiVisible = true; // Tráº¡ng thÃ¡i hiá»ƒn thá»‹ UI
let swordRainClouds = [];
let nextFireIndex = 0; // Ká»¹ nÄƒng Ä‘ao xoay

// Ká»¹ nÄƒng active
let satelliteActive = false;
let satelliteEndTime = 0;
let satellites = [];

let ufoActive = false; // Ká»¹ nÄƒng UFO
let ufoEndTime = 0;
let ufoCooldown = 0;
let ufoCount = 1;
let ufos = [];
// ========================= âš¡ Lightning â€“ tráº¡ng thÃ¡i & dá»¯ liá»‡u =========================
let lightningActive = false; // Ká»¹ nÄƒng sÃ©t - tráº¡ng thÃ¡i & dá»¯ liá»‡u
let lightningEndTime = 0;
let lightningBolts = [];
let activeLightningStrikes = [];
let nextLightningStrikeTime = 0;
let disguiseActive = false;
let disguiseEndTime = 0;

let clones = []; // ğŸ­ Global â€“ lÆ°u cÃ¡c báº£n sao hiá»‡n táº¡i
let clonesActive = false;
let clonesEndTime = 0;
let activeCloneLasers = []; // Máº£ng chá»©a cÃ¡c tia lazer cá»§a clone

let blackHoles = []; // Danh sÃ¡ch há»‘ Ä‘en
let extraShockwaves = []; // ğŸŒŠ cÃ¡c vÃ²ng ná»• phá»¥ lan ra

let bloodOrbActive = false;
let bloodOrbEndTime = 0;
let bloodOrbs = []; // [{ angle, radius, x, y }]
let bloodOrbCount = 1; // vá» sau nÃ¢ng cáº¥p +1 quáº£ cáº§u
let bloodOrbLastDrain = 0;
let particles = [];
let healEffects = []; // Táº¡o "Kho" Chá»©a Hiá»‡u á»©ng

// ğŸšª Tráº¡ng thÃ¡i Cá»•ng KhÃ´ng Gian
let spaceGate = null; // Biáº¿n chá»©a Ä‘á»‘i tÆ°á»£ng cá»•ng
let spaceGateActive = false;
let spaceGateEndTime = 0;
let lastTeleportTime = 0; // LÆ°u thá»i Ä‘iá»ƒm dá»‹ch chuyá»ƒn cuá»‘i
const GATE_COOLDOWN = 2000; // 1000ms = 1 giÃ¢y chá»
// Quáº£n lÃ½ tráº¡ng thÃ¡i animation khi dá»‹ch chuyá»ƒn
let playerTeleportState = {
    phase: null, // cÃ¡c giai Ä‘oáº¡n: 'shrinking', 'growing'
    progress: 0, // tiáº¿n trÃ¬nh cá»§a hiá»‡u á»©ng (tá»« 1.0 xuá»‘ng 0.0 vÃ  ngÆ°á»£c láº¡i)
    originalPlayerSize: 0,
    originalGateRadius: 0,
};

// ğŸŒŠ Quáº£n lÃ½ wave
let wave = 1;
let waveTime = 180; // Thá»i gian má»—i wave
let waveTimer = waveTime;
let lastWaveTime = null;
let gameStarted = false;

// â± Thá»i gian ká»¹ nÄƒng
let fireEndTime = 0;
let iceEndTime = 0;
let swordEndTime = 0;
let bladeEndTime = 0;
let levelUpGlowTime = 0;
let nextBladeToAttack = 0; // Theo dÃµi thá»© tá»± cá»§a Ä‘ao sáº¯p táº¥n cÃ´ng
let lastBladeLaunchTime = 0; // Má»‘c thá»i gian cá»§a láº§n phÃ³ng Ä‘ao cuá»‘i

// ğŸ“± Äiá»u khiá»ƒn cáº£m á»©ng
let touchStartX = null, touchStartY = null;
let touchMoveX = null, touchMoveY = null;

// ğŸ® Danh sÃ¡ch cÃ¡c Ä‘á»‘i tÆ°á»£ng trong game
let enemyBullets = []; // Zombie báº¯n tráº£
let zombies = [];
let bullets = [];
let swords = [];
let downwardSwords = [];
let fireballs = [];
let iceballs = [];
let thunderActive = false;
let thunderEndTime = 0;
let thunderBalls = [];
let items = [];
let explosions = [];
let missiles = []; // ğŸš€ Danh sÃ¡ch tÃªn lá»­a Ä‘ang bay
let expandingExplosions = []; // â˜¢ï¸ CÃ¡c vÃ²ng ná»• lan rá»™ng (dÃ¹ng cho bom háº¡t nhÃ¢n)
let nuclearBombs = []; // Máº£ng lÆ°u trá»¯ riÃªng bom háº¡t nhÃ¢n
let bombsB52 = []; // ğŸ’£ Danh sÃ¡ch bom B52
let activePlanes = [];   // ğŸ›¬ Danh sÃ¡ch mÃ¡y bay Ä‘ang hoáº¡t Ä‘á»™ng

// ğŸ”§ Váº½ Canvas
const canvas = document.getElementById("game");
const ctx = canvas.getContext("2d");

// ğŸŒ€ Object Pooling
const bulletPool = [];
const explosionPool = [];
const zombiePool = [];
const swordPool = [];
const fireballPool = [];
const iceballPool = [];

//ğŸ“² 2. Sá»± kiá»‡n Ä‘iá»u khiá»ƒn bÃ n phÃ­m, chuá»™t, cáº£m á»©ng
// âŒ¨ï¸ BÃ n phÃ­m di chuyá»ƒn
document.addEventListener("keydown", e => keys[e.key.toLowerCase()] = true);
document.addEventListener("keyup", e => keys[e.key.toLowerCase()] = false);

// ğŸ–± Click chuá»™t Ä‘á»ƒ báº¯n
canvas.addEventListener("click", () => {
  const now = Date.now();
  if (now - lastManualShootTime < manualShootCooldown) return;
  // KhÃ´ng Ä‘áº·t láº¡i lastManualShootTime á»Ÿ Ä‘Ã¢y Ä‘á»ƒ laze cÃ³ thá»ƒ tá»± kiá»ƒm tra

  if (zombies.length === 0) return;

  // THÃŠM Má»šI: Náº¿u Ä‘ang á»Ÿ cháº¿ Ä‘á»™ laze, gá»i hÃ m báº¯n laze vÃ  káº¿t thÃºc
  if (clickShotMode === 4) {
      firePlayerLaser();
      return;
  }

  // Logic báº¯n Ä‘áº¡n thÆ°á»ng (giá»¯ nguyÃªn)
  lastManualShootTime = now; // Äáº·t láº¡i cooldown cho Ä‘áº¡n thÆ°á»ng
  const target = zombies.reduce((a, b) =>
    distance(a, player) < distance(b, player) ? a : b
  );

  const angle = Math.atan2(target.y - player.y, target.x - player.x);
  const bullet = getBullet();
  bullet.x = player.x;
  bullet.y = player.y;
  bullet.speed = playerUpgrades.bulletSpeed;
  bullet.active = true;
  bullet.color = "cyan";
  bullet.piercing = true;
  bullet.rotation = 0;

  // ======= Kiá»ƒu báº¯n tÃ¹y theo clickShotMode =======
  if (clickShotMode === 0) {
    // ğŸ”„ Xoáº¯n á»‘c quanh player
    bullet.curveMode = true;
    bullet.angle = angle;
    bullet.curveRadius = 0;
    bullet.curveSpeed = 0.1 + Math.random() * 0.05;

  } else if (clickShotMode === 1) {
    // â†”ï¸ Zigzag
    bullet.zigzagMode = true;
    bullet.baseAngle = angle;
    bullet.oscillatePhase = Math.random() * Math.PI * 2;
    bullet.oscillateSpeed = 0.2;
    bullet.oscillateAmplitude = 20;
    bullet.travel = 0;
    bullet.startX = player.x;
    bullet.startY = player.y;

  } else if (clickShotMode === 2) {
    // ğŸ¯ Xoáº¯n á»‘c bay tháº³ng
    bullet.spiralForwardMode = true;
    bullet.baseAngle = angle;
    bullet.travel = 0;
    bullet.spiralRadius = 15;
    bullet.spiralSpeed = 0.3;
    bullet.spiralPhase = Math.random() * Math.PI * 2;
    bullet.startX = player.x;
    bullet.startY = player.y;

  } else if (clickShotMode === 3) {
    // ğŸ¯ Kiá»ƒu 3 â€“ XuyÃªn tháº³ng
    bullet.dx = Math.cos(angle);
    bullet.dy = Math.sin(angle);
    bullet.piercing = true;

  } else if (clickShotMode === 5) { // THAY Äá»”I: Chuyá»ƒn kiá»ƒu máº·c Ä‘á»‹nh sang sá»‘ 5
    // ğŸ”µ Kiá»ƒu 5 â€“ Giá»‘ng auto shoot
    bullet.dx = Math.cos(angle);
    bullet.dy = Math.sin(angle);
    bullet.piercing = false; // â— khÃ´ng xuyÃªn
  }
  // ================================================

  bullets.push(bullet);
});
// GÃ¡n sá»± kiá»‡n middle click (chuá»™t giá»¯a) Ä‘á»ƒ chuyá»ƒn kiá»ƒu báº¯n
canvas.addEventListener("mousedown", (e) => {
  if (e.button === 1) {
    // THAY Äá»”I: TÄƒng tá»•ng sá»‘ kiá»ƒu Ä‘áº¡n lÃªn 6
    clickShotMode = (clickShotMode + 1) % 6;
    
    // THAY Äá»”I: Cáº­p nháº­t láº¡i danh sÃ¡ch tÃªn cÃ¡c kiá»ƒu Ä‘áº¡n
    const modeNames = [
      "ğŸ”„ Xoáº¯n á»‘c", 
      "â†”ï¸ Zigzag", 
      "ğŸ¯ Xoáº¯n bay tháº³ng", 
      "ğŸ¯ XuyÃªn tháº³ng", 
      "ğŸ’¥ Laze", // ThÃªm Laze vÃ o vá»‹ trÃ­ sá»‘ 4
      "ğŸ”µ Máº·c Ä‘á»‹nh" // Chuyá»ƒn Máº·c Ä‘á»‹nh xuá»‘ng vá»‹ trÃ­ sá»‘ 5
    ];
    showWarning(`Kiá»ƒu Ä‘áº¡n chuá»™t trÃ¡i: ${modeNames[clickShotMode]}`);
    e.preventDefault();
  }
});

// Sá»­ dá»¥ng phÃ­m Space Ä‘á»ƒ báº¯n
document.addEventListener("keydown", e => {
  if (e.code === 'Space') shoot();
});

// ğŸ“± Äiá»u khiá»ƒn cáº£m á»©ng
canvas.addEventListener("touchstart", e => {
  const touch = e.touches[0];
  touchStartX = touch.clientX;
  touchStartY = touch.clientY;
});
canvas.addEventListener("touchmove", e => {
  const touch = e.touches[0];
  touchMoveX = touch.clientX;
  touchMoveY = touch.clientY;
  e.preventDefault(); // ngÄƒn cuá»™n trang
});
canvas.addEventListener("touchend", () => {
  touchStartX = null;
  touchStartY = null;
  touchMoveX = null;
  touchMoveY = null;
});

// HÃ m tiá»‡n Ã­ch Ä‘á»ƒ láº¥y má»™t sá»‘ nguyÃªn ngáº«u nhiÃªn trong má»™t khoáº£ng
function getRandomInt(min, max) {
    min = Math.ceil(min);
    max = Math.floor(max);
    return Math.floor(Math.random() * (max - min + 1)) + min;
}
// HÃ m dá»n dáº¹p cÃ¡c Ä‘á»‘i tÆ°á»£ng khÃ´ng cÃ²n hoáº¡t Ä‘á»™ng
function cleanupInactiveObjects() {
  // Dá»n dáº¹p zombies
  for (let i = zombies.length - 1; i >= 0; i--) {
    if (!zombies[i].active) {
      zombies.splice(i, 1);
    }
  }

  // Dá»n dáº¹p Ä‘áº¡n ngÆ°á»i chÆ¡i
  for (let i = bullets.length - 1; i >= 0; i--) {
    if (!bullets[i].active) {
      bullets.splice(i, 1);
    }
  }

  // Dá»n dáº¹p Ä‘áº¡n cá»§a Ä‘á»‹ch
  for (let i = enemyBullets.length - 1; i >= 0; i--) {
    if (!enemyBullets[i].active) {
      enemyBullets.splice(i, 1);
    }
  }

  // Dá»n dáº¹p váº­t pháº©m
  for (let i = items.length - 1; i >= 0; i--) {
    if (!items[i].active) {
      items.splice(i, 1);
    }
  }

  // Dá»n dáº¹p hiá»‡u á»©ng ná»•
  for (let i = explosions.length - 1; i >= 0; i--) {
    if (!explosions[i].active) {
      explosions.splice(i, 1);
    }
  }
}

//ğŸ’¥ 3. HÃ m há»— trá»£ tiá»‡n Ã­ch
function distance(a, b) {
return Math.hypot(a.x - b.x, a.y - b.y);}

function distanceSq(a, b) {
    return (a.x - b.x)**2 + (a.y - b.y)**2;
}
function createFairyHitParticle(targetZombie) {
    particles.push({
        type: 'fairy_status_effect', // Loáº¡i háº¡t má»›i
        target: targetZombie,       // "DÃ­nh" vÃ o má»¥c tiÃªu nÃ y
        life: 180,                   // Tá»“n táº¡i trong 1.5 giÃ¢y (60fps * 1.5)
        maxLife: 180,
        angle: Math.random() * Math.PI * 2, // GÃ³c xoay ban Ä‘áº§u
        orbitRadius: targetZombie.radius + 5 + Math.random() * 5, // Khoáº£ng cÃ¡ch xoay
        size: 0.5 + Math.random() * 1,                 // KÃ­ch thÆ°á»›c háº¡t
        color: 'rgba(100, 255, 150, 0.8)'   // MÃ u xanh lÃ¡ cÃ¢y báº¡c hÃ 

    });
}
// HÃ m nÃ y sáº½ quyáº¿t Ä‘á»‹nh váº­t pháº©m nÃ o sáº½ rÆ¡i dá»±a trÃªn tá»‰ lá»‡
function determineItemDrop() {
    const itemRand = Math.random(); // Táº¡o sá»‘ ngáº«u nhiÃªn tá»« 0 Ä‘áº¿n 1
    let cumulativeChance = 0;

    // Duyá»‡t qua tá»«ng váº­t pháº©m trong báº£ng tá»‰ lá»‡
    for (const item of itemDropTable) {
        cumulativeChance += item.chance;
        // Náº¿u sá»‘ ngáº«u nhiÃªn nhá» hÆ¡n tá»‰ lá»‡ cá»™ng dá»“n, chÃºng ta chá»n váº­t pháº©m nÃ y
        if (itemRand < cumulativeChance) {
            return item.type;
        }
    }
    // Náº¿u khÃ´ng trÃºng váº­t pháº©m nÃ o trong báº£ng, máº·c Ä‘á»‹nh sáº½ lÃ  'energy'
    return 'energy';
}
// Táº¡o hiá»‡u á»©ng cá»•ng dá»‹ch chuyá»ƒn
function createSpawnEffect(x, y) {
    playSound('sfx-nuke-fall', 0.5); // Táº¡m dÃ¹ng Ã¢m thanh bom rÆ¡i Ä‘á»ƒ cáº£nh bÃ¡o
    // Táº¡o 30 háº¡t bay ra tá»« tÃ¢m theo hÃ¬nh trÃ²n
    for (let i = 0; i < 30; i++) {
        const angle = Math.random() * Math.PI * 2;
        const speed = 2 + Math.random() * 2;
        particles.push({
            x: x, y: y,
            vx: Math.cos(angle) * speed,
            vy: Math.sin(angle) * speed,
            size: Math.random() * 2 + 1,
            color: 'rgba(139, 0, 139, 0.8)', // MÃ u tÃ­m Ä‘áº­m
            alpha: 1,
            fastFade: true
        });
    }
}
/**
 * Táº¡o má»™t vá»¥ ná»• báº±ng cÃ¡c háº¡t (particle) táº¡i má»™t vá»‹ trÃ­.
 * @param {number} x Tá»a Ä‘á»™ X cá»§a vá»¥ ná»•.
 * @param {number} y Tá»a Ä‘á»™ Y cá»§a vá»¥ ná»•.
 * @param {number} count Sá»‘ lÆ°á»£ng háº¡t.
 * @param {string} baseColor MÃ u cÆ¡ báº£n cá»§a vá»¥ ná»• (vÃ­ dá»¥: 'orange', 'cyan').
 */
function createParticleExplosion(x, y, count, colorScheme = 'fire') {
    let colors;
    let maxDist = 60; // BÃ¡n kÃ­nh máº·c Ä‘á»‹nh

    // Chá»n bá»™ mÃ u vÃ  bÃ¡n kÃ­nh dá»±a trÃªn yÃªu cáº§u
    if (colorScheme === 'fire') {
        colors = [
            'rgba(255, 255, 255, 0.9)', // Tráº¯ng
            'rgba(255, 220, 0, 0.8)',   // VÃ ng
            'rgba(255, 150, 0, 0.8)',   // Cam
            'rgba(255, 50, 0, 0.7)'     // Äá»
        ];
        maxDist = 60; // BÃ¡n kÃ­nh ná»• cá»§a tÃªn lá»­a
    } else if (colorScheme === 'smoke') {
        colors = [
            'rgba(200, 200, 200, 0.7)', // XÃ¡m sÃ¡ng
            'rgba(150, 150, 150, 0.6)', // XÃ¡m vá»«a
            'rgba(100, 100, 100, 0.5)'  // XÃ¡m tá»‘i
        ];
        maxDist = 80; // BÃ¡n kÃ­nh cá»§a bom khÃ³i
    }

    for (let i = 0; i < count; i++) {
        const angle = Math.random() * Math.PI * 2;
        const speed = 1 + Math.random() * 2;

        const color = colors[Math.floor(Math.random() * colors.length)];

        particles.push({
            x: x,
            y: y,
            vx: Math.cos(angle) * speed,
            vy: Math.sin(angle) * speed,
            size: Math.random() * 1 + 2,
            color: color,
            alpha: 1,
            fastFade: true,
            originX: x,
            originY: y,
            maxDistance: maxDist
        });
    }
}

/**
 * Táº¡o má»™t Ä‘á»‘i tÆ°á»£ng hiá»‡u á»©ng dying vÃ  thÃªm vÃ o máº£ng healEffects.
 */
function spawnDyingEffect(z) {
    healEffects.push({
        x: z.x,
        y: z.y - z.radius,
        life: 60,
        maxLife: 60,
        text: 'â˜ ï¸',
        delay: 0  // No delay for death effect
    });
}
// Váº½ cÃ¡c hiá»‡u á»©ng há»“i mÃ¡u
function updateAndDrawHealEffects() {
    ctx.font = "0.8rem sans-serif";
    ctx.textAlign = "center";
    ctx.textBaseline = "middle";

    for (let i = healEffects.length - 1; i >= 0; i--) {
        const effect = healEffects[i];

        // LuÃ´n giáº£m life má»—i frame Ä‘á»ƒ hiá»‡u á»©ng biáº¿t khi nÃ o cáº§n biáº¿n máº¥t
        effect.life--;

        // Náº¿u cÃ²n delay, chá»‰ Ä‘á»©ng yÃªn táº¡i chá»—
        if (effect.delay > 0) {
            effect.delay--;
        } else {
            // Háº¿t delay thÃ¬ má»›i báº¯t Ä‘áº§u bay lÃªn
            effect.y -= 0.5;
        }

        // âœ¨ THAY Äá»”I: Sá»­ dá»¥ng mÃ u tá»« hiá»‡u á»©ng, náº¿u khÃ´ng cÃ³ thÃ¬ máº·c Ä‘á»‹nh lÃ  mÃ u tráº¯ng
        ctx.fillStyle = effect.color || "white";
        ctx.globalAlpha = effect.life / effect.maxLife;
        
        // Váº½ Ä‘Ãºng icon (text) cá»§a hiá»‡u á»©ng
        ctx.fillText(effect.text, effect.x, effect.y);

        // XÃ³a hiá»‡u á»©ng khi life <= 0
        if (effect.life <= 0) {
            healEffects.splice(i, 1);
        }
    }
    
    ctx.globalAlpha = 1; // Reset Ä‘á»™ má»
}

// ğŸ Quáº£n lÃ½ viá»‡c rÆ¡i váº­t pháº©m khi má»™t zombie bá»‹ tiÃªu diá»‡t.
function dropItem(x, y, isBoss = false, isBigBoss = false, isMiniBoss = false, isElite = false) {
  
    let finalDropCount = 0;
    const isLuckyActive = Date.now() < luckyBuffEndTime;

    // 1. XÃ¡c Ä‘á»‹nh Sá» LÆ¯á»¢NG váº­t pháº©m sáº½ rÆ¡i (logic gá»‘c cá»§a báº¡n, giá»¯ nguyÃªn)
    if (isBigBoss) {
        // BigBoss rÆ¡i ngáº«u nhiÃªn tá»« 5 Ä‘áº¿n 10 váº­t pháº©m
        finalDropCount = getRandomInt(5, 10);
    } else if (isBoss) {
        // Boss rÆ¡i ngáº«u nhiÃªn tá»« 3 Ä‘áº¿n 5 váº­t pháº©m
        finalDropCount = getRandomInt(3, 5);
    } else if (isMiniBoss) {
        // MiniBoss rÆ¡i ngáº«u nhiÃªn tá»« 2 Ä‘áº¿n 3 váº­t pháº©m
        finalDropCount = getRandomInt(2, 3);
    } else if (isElite) {
        // Elite rÆ¡i ngáº«u nhiÃªn tá»« 1 Ä‘áº¿n 2 váº­t pháº©m
        finalDropCount = getRandomInt(1, 2);
    } else {
        let dropChance = 0.1;
        if (isLuckyActive) {
            dropChance = 0.3; // TÄƒng tá»‰ lá»‡ rÆ¡i váº­t pháº©m khi cÃ³ buff Lucky
        }
        if (Math.random() < dropChance) {
            finalDropCount = 1;
        }
    }

    // Náº¿u cÃ³ buff Lucky, nhÃ¢n Ä‘Ã´i sá»‘ lÆ°á»£ng váº­t pháº©m rÆ¡i ra
    if (isLuckyActive) {
        finalDropCount *= 2;
    }
    // Náº¿u khÃ´ng cÃ³ váº­t pháº©m nÃ o rÆ¡i ra, káº¿t thÃºc hÃ m
    if (finalDropCount === 0) {
        return;
    }

    // 2. VÃ²ng láº·p Ä‘á»ƒ táº¡o ra tá»«ng váº­t pháº©m
    for (let i = 0; i < finalDropCount; i++) {
        const offsetX = (Math.random() - 0.5) * 30;
        const offsetY = (Math.random() - 0.5) * 30;
        const safeX = Math.min(worldWidth - wallThickness - 20, Math.max(wallThickness + 20, x + offsetX));
        const safeY = Math.min(worldHeight - wallThickness - 20, Math.max(wallThickness + 20, y + offsetY));
        
        // 3. Gá»i hÃ m má»›i Ä‘á»ƒ quyáº¿t Ä‘á»‹nh LOáº I váº­t pháº©m sáº½ rÆ¡i ra.
        // ToÃ n bá»™ khá»‘i if/else if dÃ i dÃ²ng trÆ°á»›c Ä‘Ã¢y Ä‘Æ°á»£c thay tháº¿ báº±ng 1 dÃ²ng duy nháº¥t.
        const type = determineItemDrop();

        // 4. ThÃªm váº­t pháº©m vÃ o game
        if (type) {
            items.push({ 
                x: safeX, 
                y: safeY, 
                type: type, 
                active: true, 
                bornAt: Date.now() // Sá»­ dá»¥ng 'bornAt' Ä‘á»ƒ tÆ°Æ¡ng thÃ­ch logic tá»± xÃ³a
            });
        }
    }
}

// ğŸ“¦ Khi ngÆ°á»i chÆ¡i nháº·t há»™p váº­t pháº©m Ä‘áº·c biá»‡t
function openItemBox() {
  const rewardCount = Math.floor(Math.random() * 3) + 1; // Nháº­n 1â€“3 loáº¡i ngáº«u nhiÃªn
  const rewards = [
    { type: 'energy', label: 'âš¡ Energy', icon: 'âš¡' },
    { type: 'mana', label: 'ğŸ’  Mana', icon: 'ğŸ’ ' },
    { type: 'hp', label: 'â¤ï¸ HP', icon: 'â¤ï¸' }
  ];

  const shuffled = rewards.sort(() => Math.random() - 0.5);
  const selected = shuffled.slice(0, rewardCount);
  const summary = [];

  selected.forEach(r => {
    const amount = Math.floor(Math.random() * 5) + 3;
    switch (r.type) {
      case 'energy': player.energy += amount; break;
      case 'mana': player.mana += amount; break;
      case 'hp': player.hearts += amount; break;
    }
    summary.push(`${r.icon} +${amount}`);
  });

  // ğŸ“¢ Gá»™p thÃ nh má»™t dÃ²ng thÃ´ng bÃ¡o duy nháº¥t
  showWarning(`ğŸ“¦ Há»™p quÃ : ${summary.join(', ')}`);
}
// HÃ m xá»­ lÃ½ khi nháº·t váº­t pháº©m Secret (phiÃªn báº£n Ä‘Ã£ cáº­p nháº­t tá»‰ lá»‡)
function activateSecretItem(item) {
    if (!item) return;

    const rand = Math.random(); // Táº¡o má»™t sá»‘ ngáº«u nhiÃªn tá»« 0 Ä‘áº¿n 1

    // --- Báº®T Äáº¦U LOGIC Má»šI ---

    // 50% cÆ¡ há»™i nháº­n Ä‘Æ°á»£c má»™t buff ngáº«u nhiÃªn
    if (rand < 0.50) {
        const buffs = ['lucky', 'power', 'crazy', 'exp'];
        const randomBuff = buffs[Math.floor(Math.random() * buffs.length)];
        
        showWarning(`â“: Nháº­n Ä‘Æ°á»£c buff ${randomBuff.toUpperCase()}!`);
        switch (randomBuff) {
            case 'lucky': luckyBuffEndTime = Date.now() + 45000; break;
            case 'power': powerBuffEndTime = Date.now() + 45000; break;
            case 'crazy': crazyBuffEndTime = Date.now() + 45000; break;
            case 'exp':   expBuffEndTime = Date.now() + 45000; break;
        }
    } 
    // 30% cÆ¡ há»™i tiáº¿p theo (tá»« 0.50 Ä‘áº¿n 0.80) nháº­n Ä‘Æ°á»£c Coin hoáº·c EXP
    else if (rand < 0.80) {
        // BÃªn trong 30% nÃ y, chia 50/50 cho Coin hoáº·c EXP
        if (Math.random() < 0.5) {
            // Nháº­n Ä‘Æ°á»£c Coin
            const coinBonus = Math.round((wave + player.level) * (Math.random() * 3 + 2));
            player.coins += coinBonus;
            showWarning(`â“: Nháº­n Ä‘Æ°á»£c ${coinBonus} ğŸª™!`);
        } else {
            // Nháº­n Ä‘Æ°á»£c EXP
            activateExpBonusItem(); // TÃ¡i sá»­ dá»¥ng hÃ m cÃ³ sáºµn Ä‘á»ƒ nháº­n EXP
        }
    } 
    // 20% cÆ¡ há»™i cÃ²n láº¡i (tá»« 0.80 Ä‘áº¿n 1.0) lÃ  ra Boss
    else {
        showWarning("Oh! No");
        createSpawnEffect(item.x, item.y);
        setTimeout(() => {
            showWarning("â“: Má»™t káº» Ä‘á»‹ch máº¡nh Ä‘Ã£ xuáº¥t hiá»‡n!");
            spawnBoss(item.x, item.y);
        }, 500); // Äá»£i 0.5 giÃ¢y Ä‘á»ƒ táº¡o hiá»‡u á»©ng
    }
    // --- Káº¾T THÃšC LOGIC Má»šI ---
}

// HÃ m xá»­ lÃ½ khi nháº·t váº­t pháº©m ExpBonus
function activateExpBonusItem() {
    // LÆ°á»£ng EXP thÆ°á»Ÿng = (wave + level) * (má»™t sá»‘ ngáº«u nhiÃªn tá»« 5 Ä‘áº¿n 10)
    const bonus = Math.round((wave + player.level) * (Math.random() * 5 + 5));
    player.exp += bonus;
    player.currentLevelExp += bonus;
    createExpGainEffect({x: player.x, y: player.y, radius: 20}, bonus);
    showWarning(`ğŸŒŸ ThÆ°á»Ÿng: +${bonus} EXP!`);
}
// ğŸ” Bullet Pooling
function getBullet() {
  return bulletPool.length ? bulletPool.pop() : { x: 0, y: 0, dx: 0, dy: 0, active: true };
}
function releaseBullet(bullet) {
    bullet.active = false;
    
    // âœ¨ Báº®T Äáº¦U PHáº¦N RESET TOÃ€N Bá»˜ THUá»˜C TÃNH Äáº¶C BIá»†T âœ¨
    delete bullet.isFairyBullet; // XÃ³a cá» cá»§a Ä‘áº¡n Fairy
    delete bullet.isPetBullet; // âœ¨ ThÃªm dÃ²ng nÃ y
    delete bullet.icon;        // âœ¨ ThÃªm dÃ²ng nÃ y
    delete bullet.stunDuration;// âœ¨ ThÃªm dÃ²ng nÃ y
    delete bullet.customDmg;     // XÃ³a sÃ¡t thÆ°Æ¡ng riÃªng cá»§a Clone
    delete bullet.color;         // XÃ³a mÃ u tÃ¹y chá»‰nh
    delete bullet.effect;        // XÃ³a hiá»‡u á»©ng cá»§a Ä‘áº¡n Fairy
    bullet.piercing = false;     // Reset thuá»™c tÃ­nh xuyÃªn tháº¥u vá» máº·c Ä‘á»‹nh
    
    // Reset cÃ¡c kiá»ƒu bay Ä‘áº·c biá»‡t
    bullet.curveMode = false;
    bullet.zigzagMode = false;
    bullet.spiralForwardMode = false;
    // âœ¨ Káº¾T THÃšC PHáº¦N RESET âœ¨

    bulletPool.push(bullet);
}

// ğŸ’¥ Explosion Pooling
function getExplosion(x, y) {
  const e = explosionPool.length ? explosionPool.pop() : { x: 0, y: 0, radius: 0, life: 0, active: true };
  e.x = x;
  e.y = y;
  e.radius = 0;
  e.life = 20;
  e.active = true;
  return e;
}
function releaseExplosion(e) {
  e.active = false;
  explosionPool.push(e);
}

// ğŸ’¥ Báº¯n Ä‘áº¡n tá»« zombie vá» phÃ­a player - shootEnemyBullet pooling
function shootEnemyBullet(z, speed = 0.6, chance = 1) { // Nháº­n cáº£ Ä‘á»‘i tÆ°á»£ng zombie 'z'
    if (Math.random() > chance) return;

    const angle = Math.atan2(player.y - z.y, player.x - z.x);
    const b = getEnemyBullet();
    b.x = z.x;
    b.y = z.y;
    b.dx = Math.cos(angle);
    b.dy = Math.sin(angle);
    b.speed = speed;
    b.damage = calculateZombieDamage(z); // âœ¨ TÃ­nh vÃ  lÆ°u sÃ¡t thÆ°Æ¡ng vÃ o Ä‘áº¡n
    b.hit = false;
    b.active = true;

    enemyBullets.push(b);
}

// object pooling cho enemyBullets
const enemyBulletPool = [];

function getEnemyBullet() {
  return enemyBulletPool.length
    ? enemyBulletPool.pop()
    : { x: 0, y: 0, dx: 0, dy: 0, speed: 1, hit: false, active: true };
}

function releaseEnemyBullet(b) {
  b.hit = false;
  b.active = false;
  enemyBulletPool.push(b);
}

// ğŸ§Ÿ Zombie Pooling
function getZombie() {
    let z = zombiePool.length ? zombiePool.pop() : {
        x: 0, y: 0, radius: 15, canHit: true, speed: 1,
        color: "hotpink", isBoss: false, isBigBoss: false,
        hp: 1, active: true, type: "normal", level: 1
    };

    // Reset láº¡i toÃ n bá»™ khi láº¥y tá»« pool
    z.active = true;
    z._killed = false;
    z.isBoss = false;
    z.isBigBoss = false;
    z.type = "normal";
    z.color = "hotpink";
    z.radius = 15;
    z.hp = 1;
    z.level = 1;
    z.baseSpeed = 0.1 + Math.random() * 0.1;
    z.speed = z.baseSpeed;
    z.canHit = true;
    return z;
}

function releaseZombie(z) {
  z.active = false;
  z.state = undefined;   
  zombiePool.push(z);
}
// ğŸ’¥ HÃ m tiÃªu diá»‡t zombie, dÃ¹ng chung cho má»i ká»¹ nÄƒng
function killZombie(z) {
  // --- BÆ¯á»šC 1: Xá»¬ LÃ BAN Äáº¦U ---

  // Náº¿u zombie Ä‘Ã£ bá»‹ xá»­ lÃ½ rá»“i hoáº·c khÃ´ng hoáº¡t Ä‘á»™ng, bá» qua Ä‘á»ƒ trÃ¡nh lá»—i
  if (z._killed || !z.active) return;
  z._killed = true; // ÄÃ¡nh dáº¥u lÃ  Ä‘Ã£ xá»­ lÃ½ Ä‘á»ƒ khÃ´ng gá»i láº¡i hÃ m nÃ y trÃªn cÃ¹ng 1 zombie

  // PhÃ¡t Ã¢m thanh vÃ  hiá»‡u á»©ng hÃ¬nh áº£nh
  playSound('sfx-zombie-die', 0.3);
  spawnDyingEffect(z);

  // Tráº£ Ä‘á»‘i tÆ°á»£ng zombie vá» "kho" (object pool) Ä‘á»ƒ tÃ¡i sá»­ dá»¥ng, tá»‘i Æ°u hiá»‡u nÄƒng
  releaseZombie(z);
  
  // --- BÆ¯á»šC 2: Cáº¬P NHáº¬T ÄIá»‚M Sá» ---

  // LuÃ´n cá»™ng 1 vÃ o 'score' Ä‘á»ƒ Ä‘áº¿m kill vÃ  tÃ­nh high score
  player.score++;
  zombieKillCount = player.score;

  // --- BÆ¯á»šC 3: TÃNH TOÃN EXP (LOGIC HOÃ€N CHá»ˆNH) ---

  let expBaseCalculated = 0; // Biáº¿n táº¡m Ä‘á»ƒ lÆ°u EXP gá»‘c trÆ°á»›c khi thÃªm yáº¿u tá»‘ ngáº«u nhiÃªn

  // 3.1. TÃ­nh EXP gá»‘c cho tá»«ng loáº¡i zombie
  if (z.isBigBoss) {
    // Äá»‘i vá»›i cÃ¡c loáº¡i boss, gá»i hÃ m tÃ­nh EXP tÄƒng tiáº¿n riÃªng
    expBaseCalculated = calculateScaledBossExp(1000, wave);
  } else if (z.isBoss) {
    expBaseCalculated = calculateScaledBossExp(100, wave);
  } else if (z.type === "miniBoss") {
    // Sá»­ dá»¥ng EXP cÆ¡ báº£n lÃ  50 Ä‘Ã£ sá»­a
    expBaseCalculated = calculateScaledBossExp(10, wave);
  } else {
    // Logic cho zombie thÆ°á»ng vÃ  Elite
    const base = z.isElite ? 5 : 1;
    const levelBonus = z.level - 1;
    const waveBonus = wave - 1; // ThÆ°á»Ÿng theo wave chá»‰ Ã¡p dá»¥ng cho zombie thÆ°á»ng/elite
    expBaseCalculated = base + levelBonus + waveBonus;
  }

  // 3.2. ThÃªm yáº¿u tá»‘ ngáº«u nhiÃªn +/- 10%
  // CÃ´ng thá»©c: giÃ¡ trá»‹ * (1 + (sá»‘ ngáº«u nhiÃªn tá»« -0.1 Ä‘áº¿n +0.1))
  const randomFactor = 1 + (Math.random() * 0.2 - 0.1); 
  let expGained = expBaseCalculated * randomFactor;

  // 3.3. LÃ m trÃ²n káº¿t quáº£ vÃ  Ä‘áº£m báº£o EXP nháº­n Ä‘Æ°á»£c luÃ´n Ã­t nháº¥t lÃ  1
  expGained = Math.max(1, Math.round(expGained));

  // 3.4. Ãp dá»¥ng cÃ¡c buff khÃ¡c náº¿u cÃ³ (vÃ­ dá»¥: buff x1.5 EXP)
  if (Date.now() < expBuffEndTime) {
    expGained = Math.round(expGained * 1.5);
  }
  
  // 3.5. Cá»™ng EXP vÃ o cho ngÆ°á»i chÆ¡i
  player.exp += expGained;
  player.currentLevelExp += expGained;
  createExpGainEffect(z, expGained);

  // --- BÆ¯á»šC 4: Cáº¬P NHáº¬T THá»NG KÃŠ VÃ€ RÆ I Váº¬T PHáº¨M ---

  // Cáº­p nháº­t thá»‘ng kÃª sá»‘ lÆ°á»£ng zombie Ä‘Ã£ diá»‡t theo tá»«ng loáº¡i
  if (z.level && z.level >= 1 && z.level <= 10) {
    zombieByLevel[z.level] = (zombieByLevel[z.level] || 0) + 1;
  }
  if (z.type === "miniBoss") {
    zombieByLevel.miniBoss = (zombieByLevel.miniBoss || 0) + 1;
  }
  if (z.isBoss && !z.isBigBoss) {
    zombieByLevel.boss = (zombieByLevel.boss || 0) + 1;
  }
  if (z.isBigBoss) {
    zombieByLevel.bigBoss = (zombieByLevel.bigBoss || 0) + 1;
  }
  
  // Gá»i hÃ m Ä‘á»ƒ xá»­ lÃ½ viá»‡c rÆ¡i váº­t pháº©m
  dropItem(z.x, z.y, z.isBoss, z.isBigBoss, z.type === "miniBoss", z.isElite);
}
/**
 * TÃ­nh toÃ¡n lÆ°á»£ng EXP yÃªu cáº§u Ä‘á»ƒ Ä‘áº¡t Ä‘Æ°á»£c cáº¥p Ä‘á»™ tiáº¿p theo.
 * @param {number} level - Cáº¥p Ä‘á»™ hiá»‡n táº¡i cá»§a ngÆ°á»i chÆ¡i.
 * @returns {number} Sá»‘ EXP cáº§n thiáº¿t Ä‘á»ƒ lÃªn cáº¥p.
 */
function calculateRequiredExp(level) {
    // --- Báº N CÃ“ THá»‚ TÃ™Y CHá»ˆNH CÃC THAM Sá» NÃ€Y ---
    // Há»‡ sá»‘ gia tÄƒng. Con sá»‘ nÃ y cÃ ng lá»›n, cÃ¡c cáº¥p Ä‘á»™ sau cÃ ng khÃ³.
    // 1.5 lÃ  má»™t khá»Ÿi Ä‘áº§u tá»‘t, báº¡n cÃ³ thá»ƒ thá»­ 1.6, 1.7... Ä‘á»ƒ lÃ m game khÃ³ hÆ¡n.
    const exponent = 1.5;
    // CÃ´ng thá»©c tÃ­nh: BaseEXP * (Level ^ Exponent)
    // Math.floor dÃ¹ng Ä‘á»ƒ lÃ m trÃ²n xuá»‘ng, cho ra má»™t con sá»‘ Ä‘áº¹p.
    return Math.floor(INITIAL_REQUIRED_EXP * Math.pow(level, exponent));
}
function calculateScaledBossExp(baseExp, currentWave) {
  // --- Báº N CÃ“ THá»‚ TÃ™Y CHá»ˆNH Há»† Sá» CÃ‚N Báº°NG Táº I ÄÃ‚Y ---

  // Má»—i wave sáº½ cá»™ng thÃªm bao nhiÃªu EXP cho boss.
  // VÃ­ dá»¥: 10 nghÄ©a lÃ  á»Ÿ wave 10, boss sáº½ Ä‘Æ°á»£c cá»™ng thÃªm 90 EXP.
  const SCALING_FACTOR_PER_WAVE = 10;

  // ---------------------------------------------------

  // LÆ°á»£ng EXP thÆ°á»Ÿng Ä‘Æ°á»£c tÃ­nh tá»« wave thá»© 2 trá»Ÿ Ä‘i.
  // (currentWave - 1) Ä‘á»ƒ Ä‘áº£m báº£o wave 1 khÃ´ng cÃ³ thÆ°á»Ÿng.
  const waveBonus = Math.max(0, (currentWave - 1) * SCALING_FACTOR_PER_WAVE);

  // Tráº£ vá» tá»•ng EXP cÆ¡ báº£n cá»™ng vá»›i pháº§n thÆ°á»Ÿng, lÃ m trÃ²n cho sá»‘ Ä‘áº¹p.
  return Math.round(baseExp + waveBonus);
}

/**
 * TÃ­nh toÃ¡n sÃ¡t thÆ°Æ¡ng cá»§a zombie dá»±a trÃªn loáº¡i, wave vÃ  level ngÆ°á»i chÆ¡i.
 * @param {object} z - Äá»‘i tÆ°á»£ng zombie.
 * @returns {number} SÃ¡t thÆ°Æ¡ng cuá»‘i cÃ¹ng (tá»‘i thiá»ƒu lÃ  1).
 */
function calculateZombieDamage(z) {
    let baseDamage = 1;

    if (z.isBigBoss) baseDamage = 5;
    else if (z.isBoss) baseDamage = 3;
    else if (z.type === 'miniBoss') baseDamage = 2;

// âœ… Giáº£m sÃ¡t thÆ°Æ¡ng cá»™ng thÃªm á»Ÿ wave & level tháº¥p
    const damageFromWave = Math.max(0, wave - 1);
    const damageFromPlayerLevel = Math.max(0, player.level - 1);

    let totalDamage = baseDamage + damageFromWave + damageFromPlayerLevel;
    
    // Kiá»ƒm tra xem zombie cÃ³ Ä‘ang bá»‹ suy yáº¿u khÃ´ng
    if (z.isWeakened && Date.now() < z.weakenEndTime) {
        // Náº¿u cÃ³, giáº£m 50% sÃ¡t thÆ°Æ¡ng
        totalDamage *= 0.5;
    } else if (z.isWeakened) {
        // Náº¿u háº¿t thá»i gian, xÃ³a cá»
        z.isWeakened = false;
    }
    // âœ¨ Káº¾T THÃšC KHá»I MÃƒ Má»šI âœ¨

    return Math.max(1, Math.floor(totalDamage));
}
// HÃ m xá»­ lÃ½ sÃ¡t thÆ°Æ¡ng vÃ o zombie, tá»± Ä‘á»™ng kiá»ƒm tra cháº¿t vÃ  hiá»‡u á»©ng
function dealDamageToZombie(z, dmg = 1) {
    let finalDamage = Math.max(1, Math.round(dmg));
    // --- LOGIC Má»šI CHO CRAZYMADNESSTIME ---
    if (Date.now() < crazyMadnessTimeEndTime) {
        // TÄƒng sÃ¡t thÆ°Æ¡ng x2 (váº«n giá»¯ nguyÃªn)
        finalDamage *= 2;

        // 1. Tá»‰ lá»‡ Crit giáº£m cÃ²n 10%
        const isCrit = Math.random() < 0.1;

        // Náº¿u crit thÃ nh cÃ´ng...
        if (isCrit) {
            // TÄƒng 2.5 láº§n sÃ¡t thÆ°Æ¡ng
            finalDamage *= 2.5;
            finalDamage = Math.round(finalDamage);

            // 2. Hiá»ƒn thá»‹ chá»¯ "Crit!" bay lÃªn tá»« zombie
            healEffects.push({
                x: z.x + 28 + (Math.random() - 0.5) * 5, // Vá»‹ trÃ­ ngang ngáº«u nhiÃªn Ä‘á»ƒ trÃ¡nh chá»“ng láº¥n
                y: z.y - z.radius - 15, // Hiá»‡n á»Ÿ vá»‹ trÃ­ cao hÆ¡n sá»‘ sÃ¡t thÆ°Æ¡ng má»™t chÃºt
                life: 90,   // Tá»“n táº¡i 1.5 giÃ¢y
                maxLife: 90,
                text: `Crit!`,
                delay: 0,
                color: 'orange' // MÃ u cam cho ná»•i báº­t
            });

            // 3. Há»“i mÃ¡u CHá»ˆ KHI crit thÃ nh cÃ´ng
            const lifestealAmount = Math.ceil(finalDamage * 0.5);
            if (lifestealAmount > 0) {
                player.hearts += lifestealAmount;
                createHealImpactEffect(player, lifestealAmount);
            }
        }
    }
    // --- Káº¾T THÃšC LOGIC Má»šI ---
    
    // GÃ¢y sÃ¡t thÆ°Æ¡ng vÃ  hiá»ƒn thá»‹ sá»‘ dmg báº­t ra (lÃ m trÃ²n cuá»‘i cÃ¹ng)
    z.hp -= Math.round(finalDamage);
    createDamageImpactEffect(z, Math.round(finalDamage));

    // Kiá»ƒm tra vÃ  tiÃªu diá»‡t zombie náº¿u háº¿t mÃ¡u
    if (!z._killed && z.hp <= 0) {
        killZombie(z);
    }
}

// ğŸ”ª Sword Pooling
function getSword() {
  return swordPool.length ? swordPool.pop() : {
    angle: 0,
    radius: 60,
    state: 'charging',
    chargeFrame: 90,
    x: 0,
    y: 0,
    target: null,
    fireDelay: 0,
    delay: 60
  };
}

function releaseSword(s) {
  swordPool.push(s);
}

// ğŸ”¥ Fireball Pooling
function getFireball() {
  return fireballPool.length ? fireballPool.pop() : {
    angle: 0,
    radius: 40,
    x: 0,
    y: 0
  };
}

function releaseFireball(f) {
  fireballPool.push(f);
}

// â„ï¸ Iceball Pooling
function getIceball() {
  return iceballPool.length ? iceballPool.pop() : {
    angle: 0,
    radius: 60,
    x: 0,
    y: 0
  };
}

function releaseIceball(i) {
  iceballPool.push(i);
}
// ğŸ§Š Hiá»ƒn thá»‹ cáº£nh bÃ¡o táº¡m thá»i
function showWarning(message, customStyle = {}) {
  // ğŸ”¸ Táº¡o khay náº¿u chÆ°a cÃ³
  const container = document.getElementById('notificationContainer')
        || (() => {
             const c = document.createElement('div');
             c.id = 'notificationContainer';
             document.body.appendChild(c);
             return c;
           })();

  // ğŸ”¸ Táº¡o popup
  const popup = document.createElement('div');
  popup.className  = 'warningPopup';
  popup.textContent = message;
  Object.assign(popup.style, customStyle);   // náº¿u cáº§n Ä‘á»•i mÃ u, v.v.

  container.appendChild(popup);

  /* Giá»›i háº¡n tá»‘i Ä‘a N popup Ä‘á»“ng thá»i */
  const MAX = 2;
  while (container.childElementCount > MAX) {
    container.firstElementChild.remove();
  }

  /* Tá»± xoÃ¡ sau 1,5 s */
  setTimeout(() => popup.remove(), 1500);
}
/* â”€â”€ Buffer gá»™p popup váº­t pháº©m cho PET â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
const petLootBuffer  = {};
let   petLootTimer   = null;
/* --- Buffer gá»™p popup cho NgÆ°á»i chÆ¡i --- */
const playerLootBuffer = {};
let playerLootTimer = null;

function queuePlayerLootPopup(icon, delay = 500) {
    playerLootBuffer[icon] = (playerLootBuffer[icon] || 0) + 1;

    clearTimeout(playerLootTimer);
    playerLootTimer = setTimeout(() => {
        const summary = Object.entries(playerLootBuffer)
            .map(([ico, c]) => `${ico} x${c}`)
            .join(', ');
        showWarning(`Nháº·t Ä‘Æ°á»£c: ${summary}`);
        // XÃ³a buffer sau khi hiá»ƒn thá»‹
        Object.keys(playerLootBuffer).forEach(k => delete playerLootBuffer[k]);
    }, delay);
}
function queuePetLootPopup(icon, delay = 500) { // <-- Äá»•i tÃªn hÃ m
  petLootBuffer[icon] = (petLootBuffer[icon] || 0) + 1; // <-- Äá»•i tÃªn buffer

  clearTimeout(petLootTimer); // <-- Äá»•i tÃªn timer
  petLootTimer = setTimeout(() => { // <-- Äá»•i tÃªn timer
    const summary = Object.entries(petLootBuffer) // <-- Äá»•i tÃªn buffer
                  .map(([ico,c]) => `${ico} x${c}`)
                  .join(', ');
    showWarning(`ğŸ° Pet nháº·t: ${summary}`);
    Object.keys(petLootBuffer).forEach(k => delete petLootBuffer[k]); // <-- Äá»•i tÃªn buffer
  }, delay);
}
// HÃ m báº¯n laze cho ngÆ°á»i chÆ¡i
function firePlayerLaser() {
    const now = Date.now();
    if (now - lastManualShootTime < manualShootCooldown) return;
    lastManualShootTime = now;

    if (zombies.length === 0) return;

    // TÃ¬m má»¥c tiÃªu vÃ  gÃ³c báº¯n (logic nÃ y giá»¯ nguyÃªn)
    const target = zombies.reduce((a, b) =>
        distance(a, player) < distance(b, player) ? a : b
    );
    const angle = Math.atan2(target.y - player.y, target.x - player.x);

    // âœ… THAY Äá»”I: Táº¡o ra 2 Ä‘á»‘i tÆ°á»£ng lazer, má»™t cho má»—i máº¯t
    playerLasers.push({ angle: angle, life: 20, eye: 'left' });
    playerLasers.push({ angle: angle, life: 20, eye: 'right' });

    // Pháº§n xá»­ lÃ½ sÃ¡t thÆ°Æ¡ng giá»¯ nguyÃªn
    const laserPathTargets = [];
    const dx = Math.cos(angle);
    const dy = Math.sin(angle);

    zombies.forEach(z => {
        if (z.active) {
            const proj = (z.x - player.x) * dx + (z.y - player.y) * dy;
            const perp = Math.abs((z.x - player.x) * dy - (z.y - player.y) * dx);
            if (proj > 0 && proj < 2000 && perp < 10) { 
                laserPathTargets.push(z);
            }
        }
    });

    if (laserPathTargets.length > 0) {
        laserPathTargets.sort((a, b) => distance(player, a) - distance(player, b));
        const firstTarget = laserPathTargets[0];

        laserPathTargets.forEach(z => {
            let finalDamage = (z === firstTarget) 
                ? playerUpgrades.damageBoost 
                : Math.max(1, Math.round(playerUpgrades.damageBoost * 0.5));
            dealDamageToZombie(z, finalDamage);
        });
    }
}

//ğŸ”« 4. Báº¯n Ä‘áº¡n & auto shoot
function shoot() {
  const now = Date.now();
  if (now - lastManualShootTime < manualShootCooldown) return;
  lastManualShootTime = now;

  const directionCount = playerUpgrades.fireRate;
  const bulletsPerDirection = 1;
  const angleOffset = Math.random() * Math.PI * 2;
  const speed = playerUpgrades.bulletSpeed;

  for (let i = 0; i < directionCount; i++) {
    const angle = angleOffset + (2 * Math.PI / directionCount) * i;

    for (let j = 0; j < bulletsPerDirection; j++) {
      const b = getBullet();
      b.x = player.x;
      b.y = player.y;
      b.dx = Math.cos(angle);
      b.dy = Math.sin(angle);
      b.speed = speed;
      b.active = true;
      bullets.push(b);
    }
  }
}

function autoShootBurst() {
  const now = Date.now(); // Láº¥y má»‘c thá»i gian hiá»‡n táº¡i Ä‘á»ƒ tÃ­nh toÃ¡n chÃ­nh xÃ¡c

  // --- 1. QUáº¢N LÃ THá»œI GIAN Há»’I GIá»®A CÃC LOáº T Báº®N ---

  // Láº¥y thá»i gian há»“i chiÃªu gá»‘c tá»« biáº¿n autoShootCooldown
  let currentCooldown = autoShootCooldown;

  // Ãp dá»¥ng cÃ¡c buff giÃºp báº¯n nhanh hÆ¡n náº¿u cÃ³
  if (supportAuraActive) {
    currentCooldown *= 0.8; // Ká»¹ nÄƒng HÃ o quang: giáº£m 20% thá»i gian há»“i chiÃªu
  }
  if (Date.now() < crazyMadnessTimeEndTime) {
    currentCooldown /= 2; // Buff CrazyMadnessTime: tá»‘c Ä‘á»™ báº¯n x2
  }

  // Kiá»ƒm tra xem Ä‘Ã£ Ä‘á»§ thá»i gian Ä‘á»ƒ báº¯t Ä‘áº§u má»™t loáº¡t báº¯n Má»šI chÆ°a
  if (now - lastAutoShootTime >= currentCooldown) {
    lastAutoShootTime = now; // Äáº·t láº¡i má»‘c thá»i gian cho loáº¡t báº¯n tiáº¿p theo
    autoBurstIndex = 0;      // Reset bá»™ Ä‘áº¿m sá»‘ Ä‘áº¡n Ä‘Ã£ báº¯n trong loáº¡t vá» 0
  }

  // --- 2. QUáº¢N LÃ VIá»†C Báº®N Tá»ªNG VIÃŠN TRONG Má»˜T LOáº T ---

  // Láº¥y sá»‘ lÆ°á»£ng Ä‘áº¡n cáº§n báº¯n trong má»™t loáº¡t tá»« chá»‰ sá»‘ nÃ¢ng cáº¥p cá»§a ngÆ°á»i chÆ¡i
  const bulletsPerDirection = playerUpgrades.lineBulletCount;

  // Náº¿u Ä‘Ã£ báº¯n Ä‘á»§ sá»‘ Ä‘áº¡n trong loáº¡t nÃ y rá»“i thÃ¬ dá»«ng láº¡i
  if (autoBurstIndex >= bulletsPerDirection) return;

  // Náº¿u chÆ°a Ä‘á»§ Ä‘á»™ trá»… giá»¯a cÃ¡c viÃªn Ä‘áº¡n (vÃ­ dá»¥ 100ms), thÃ¬ dá»«ng láº¡i.
  // Äiá»u nÃ y táº¡o ra hiá»‡u á»©ng báº¯n theo loáº¡t thay vÃ¬ báº¯n táº¥t cáº£ cÃ¹ng lÃºc.
  if (now - autoLastBurstTime < autoBurstDelay) return;

  // --- 3. TÃŒM Má»¤C TIÃŠU VÃ€ TÃNH TOÃN GÃ“C Báº®N ---

  // (Sá»­ dá»¥ng phiÃªn báº£n cáº£i tiáº¿n vá»›i táº§m báº¯n giá»›i háº¡n)
  const PLAYER_AUTOSHOOT_RANGE = 360; // Táº§m báº¯n tá»‘i Ä‘a cho tá»± Ä‘á»™ng báº¯n
  let nearestTarget = null;
  // So sÃ¡nh bÃ¬nh phÆ°Æ¡ng khoáº£ng cÃ¡ch Ä‘á»ƒ trÃ¡nh dÃ¹ng Math.sqrt() tá»‘n kÃ©m
  let minDistanceSq = PLAYER_AUTOSHOOT_RANGE * PLAYER_AUTOSHOOT_RANGE; 

  // DÃ¹ng vÃ²ng láº·p for Ä‘Æ¡n giáº£n Ä‘á»ƒ duyá»‡t qua táº¥t cáº£ zombie
  for (const z of zombies) {
    // Bá» qua nhá»¯ng zombie khÃ´ng hoáº¡t Ä‘á»™ng
    if (!z.active) continue;

    // TÃ­nh bÃ¬nh phÆ°Æ¡ng khoáº£ng cÃ¡ch
    const dSq = distanceSq(player, z);

    // Náº¿u zombie nÃ y gáº§n hÆ¡n má»¥c tiÃªu gáº§n nháº¥t hiá»‡n táº¡i VÃ€ náº±m trong táº§m báº¯n
    if (dSq < minDistanceSq) {
      minDistanceSq = dSq;    // Cáº­p nháº­t khoáº£ng cÃ¡ch gáº§n nháº¥t
      nearestTarget = z;      // GÃ¡n má»¥c tiÃªu má»›i
    }
  }

  // Náº¿u sau vÃ²ng láº·p khÃ´ng tÃ¬m tháº¥y má»¥c tiÃªu nÃ o, thoÃ¡t ra
  if (nearestTarget === null) return;

  // GÃ¡n target báº±ng má»¥c tiÃªu Ä‘Ã£ tÃ¬m tháº¥y
  const target = nearestTarget; 

  // TÃ­nh toÃ¡n gÃ³c báº¯n (radian) tá»« ngÆ°á»i chÆ¡i Ä‘áº¿n má»¥c tiÃªu
  const angle = Math.atan2(target.y - player.y, target.x - player.x);

  // --- 4. Táº O VÃ€ Báº®N Äáº N ---
  // (Pháº§n nÃ y bá»‹ thiáº¿u trong Ä‘oáº¡n code cá»§a báº¡n, tÃ´i Ä‘Ã£ thÃªm láº¡i cho Ä‘áº§y Ä‘á»§)
  
  const b = getBullet(); // Láº¥y má»™t viÃªn Ä‘áº¡n tá»« kho (object pooling)
  // Thiáº¿t láº­p cÃ¡c thuá»™c tÃ­nh cho viÃªn Ä‘áº¡n
  b.x = player.x;
  b.y = player.y;
  b.dx = Math.cos(angle); // HÆ°á»›ng di chuyá»ƒn theo trá»¥c X
  b.dy = Math.sin(angle); // HÆ°á»›ng di chuyá»ƒn theo trá»¥c Y
  b.speed = playerUpgrades.bulletSpeed;
  b.active = true;
  bullets.push(b); // ThÃªm viÃªn Ä‘áº¡n vÃ o danh sÃ¡ch Ä‘áº¡n Ä‘ang bay

  playSound('sfx-shoot', 0.01); // PhÃ¡t Ã¢m thanh báº¯n vá»›i Ã¢m lÆ°á»£ng nhá»

  // TÄƒng bá»™ Ä‘áº¿m sá»‘ Ä‘áº¡n Ä‘Ã£ báº¯n trong loáº¡t vÃ  cáº­p nháº­t thá»i gian
  autoBurstIndex++;
  autoLastBurstTime = now;
}

//ğŸ”ª 5. KÃ­ch hoáº¡t ká»¹ nÄƒng (KÃ­ch hoáº¡t ká»¹ nÄƒng & gÃ¡n nÃºt)
function activateSwordSkill() {
  if (swordActive) return;

  if (player.level < 1) return showWarning("ğŸ”ª YÃªu cáº§u Lv1");
  if (player.energy < 3) return showWarning("ğŸ”ª KhÃ´ng Ä‘á»§ 3âš¡");

  swordActive = true;
  swordEndTime = Date.now() + 60000;
  player.energy -= 3;
  document.getElementById("bladeBtn").classList.add("active");
  showWarning("ğŸ”ª KÃ­ch hoáº¡t ká»¹ nÄƒng Äao xoay");
  // âœ¨ KHá»I Táº O Bá»˜ ÄIá»€U KHIá»‚N Táº¤N CÃ”NG
  lastBladeLaunchTime = Date.now();
  nextBladeToAttack = 0;

  swords = [];
  const count = skillUpgrades.bladeCount;
  for (let i = 0; i < count; i++) {
    const homeAngle = (2 * Math.PI / count) * i;
    swords.push({
      state: 'orbiting',
      angle: homeAngle,
      homeAngle: homeAngle,
      orbitRadius: 60,
      hitZombies: new Set(),
      pierceCount: 0,
      bladeIndex: i
    });
  }
}
// âš”ï¸ Ká»¹ nÄƒng mÆ°a kiáº¿m
function activateDownwardSwords() {
  if (bladeActive) return;

  if (player.level < 2) return showWarning("âš”ï¸ YÃªu cáº§u Lv2");
  if (player.energy < 6) return showWarning("âš”ï¸ KhÃ´ng Ä‘á»§ 6âš¡");

  bladeActive = true;
  bladeEndTime = Date.now() + 60000;
  player.energy -= 6;
  document.getElementById("swordBtn").classList.add("active");
  showWarning("âš”ï¸ KÃ­ch hoáº¡t ká»¹ nÄƒng MÆ°a kiáº¿m");
  swordRainClouds = [];
  // Sá»‘ lÆ°á»£ng mÃ¢y sáº½ báº±ng cáº¥p Ä‘á»™ ká»¹ nÄƒng
  const cloudCount = skillUpgrades.swordLevel;
  
  for (let i = 0; i < cloudCount; i++) {
      // DÃ n Ä‘á»u cÃ¡c Ä‘Ã¡m mÃ¢y theo chiá»u ngang mÃ n hÃ¬nh
      const xPosition = (canvas.width / (cloudCount + 1)) * (i + 1);

      swordRainClouds.push({
          relativeX: xPosition,
          relativeY: 100 + (Math.random() - 0.5) * 20,
          driftSpeed: (Math.random() - 0.5) * 0.2,
          nextDropTime: Date.now() + Math.random() * 1000
      });
  }
}
// KÃ­ch hoáº¡t ká»¹ nÄƒng PET â€“ Thá» mÃ u há»“ng
function activatePet() {
  petActive       = true;                      // nay cháº¯c cháº¯n chÆ°a hoáº¡t Ä‘á»™ng
  petEndTime      = Date.now() + 60000;        // 60 s
  petLastHealTime = Date.now();

  petRabbit = {                                // speed tÃ­nh Ä‘á»™ng má»—i frame
    x      : player.x + 40,
    y      : player.y,
    radius : 14,
    attackTimer: 0
  };

  const btn        = document.getElementById("PetBtn");
  btn.innerText    = lastPetText;
  btn.classList.add("active");

  showWarning("ğŸ° Pet thá» Ä‘Ã£ ra tráº­n!");
}
// ğŸ–± GÃ¡n sá»± kiá»‡n nÃºt
// ğŸ”ª Ká»¹ nÄƒng Äao
document.getElementById("bladeBtn").onclick = () => {
  playSound('sfx-ui-click', 0.2);
  if (player.level < 1) return showWarning("ğŸ”ª YÃªu cáº§u Lv1");
  if (player.energy < 5) return showWarning("ğŸ”ª KhÃ´ng Ä‘á»§ 3âš¡");
  activateSwordSkill();
};
// âš”ï¸ Ká»¹ nÄƒng Kiáº¿m
document.getElementById("swordBtn").onclick = () => {
  playSound('sfx-ui-click', 0.2);
  if (player.level < 2) return showWarning("âš”ï¸ YÃªu cáº§u Lv2");
  if (player.energy < 6) return showWarning("âš”ï¸ KhÃ´ng Ä‘á»§ 6âš¡");
  activateDownwardSwords();
};
// ğŸ”¥ Ká»¹ nÄƒng Lá»­a
document.getElementById("fireBtn").onclick = () => {
  playSound('sfx-ui-click', 0.2);
  if (player.level < 3) return showWarning("ğŸ”¥ YÃªu cáº§u Lv3");
  if (player.energy < 8) return showWarning("ğŸ”¥ KhÃ´ng Ä‘á»§ 8âš¡");
  if (!fireActive) {
    fireActive = true;
    fireballs.length = 0;
    const fireCount = skillUpgrades.fireCount;
    for (let i = 0; i < fireCount; i++) {
      const angle = (2 * Math.PI / fireCount) * i;
      const f = getFireball();
      f.angle = angle;
      f.radius = 40;
      f.x = player.x + Math.cos(angle) * 40;
      f.y = player.y + Math.sin(angle) * 40;
      fireballs.push(f);
    }
    fireEndTime = Date.now() + 60000;
    player.energy -= 8;
    document.getElementById("fireBtn").classList.add("active");
    showWarning("ğŸ”¥ KÃ­ch hoáº¡t ká»¹ nÄƒng Lá»­a");

  }
};
// â„ï¸ Ká»¹ nÄƒng BÄƒng
document.getElementById("iceBtn").onclick = () => {
  playSound('sfx-ui-click', 0.2);
  if (player.level < 3)   return showWarning("â„ï¸ YÃªu cáº§u Lv3");
  if (player.energy < 12) return showWarning("â„ï¸ KhÃ´ng Ä‘á»§ 12âš¡");
  if (!iceActive) {
    iceActive  = true;
    iceballs.length = 0;                    // xoÃ¡ vÃ²ng cÅ©
    const iceCount = skillUpgrades.iceCount;
    for (let i = 0; i < iceCount; i++) {
      const angle = (2 * Math.PI / iceCount) * i;
      const b     = getIceball();
      b.angle  = angle;
      b.radius = 50;
      b.x = player.x + Math.cos(angle) * 60;
      b.y = player.y + Math.sin(angle) * 60;
      iceballs.push(b);
    }
    iceEndTime      = Date.now() + 60000;   // 60 s hiá»‡u lá»±c
    player.energy  -= 12;                   // trá»« nÄƒng lÆ°á»£ng Ä‘Ãºng 1 láº§n
    document.getElementById("iceBtn").classList.add("active");
    showWarning("â„ï¸ KÃ­ch hoáº¡t ká»¹ nÄƒng BÄƒng");
  }
};
// === Ká»¹ nÄƒng LÃ”I ===
document.getElementById("thunderBtn").onclick = () => {
  playSound('sfx-ui-click', 0.2);
  if (player.level < 5) return showWarning("ğŸ”µ YÃªu cáº§u Lv5");
  if (player.energy < 18) return showWarning("ğŸ”µ KhÃ´ng Ä‘á»§ 18âš¡");
  if (!thunderActive) {
    thunderActive = true;
    thunderBalls.length = 0;
    const thunderCount = skillUpgrades.thunderCount;
    for (let i = 0; i < thunderCount; i++) {
      const angle = (2 * Math.PI / thunderCount) * i;
      thunderBalls.push({
        angle,
        radius: 50,
        x: player.x + Math.cos(angle) * 70,
        y: player.y + Math.sin(angle) * 70,
        stunCooldown: 0,
        nextZapTime: Date.now() + Math.random() * 1500
      });
    }
    thunderEndTime = Date.now() + 60000;
    player.energy -= 18;
    document.getElementById("thunderBtn").classList.add("active");
    showWarning("â„ï¸ KÃ­ch hoáº¡t ká»¹ nÄƒng LÃ´i");
  }
};
// Auto báº¯n
document.getElementById("autoBtn").onclick = () => {
  playSound('sfx-ui-click', 0.2);
  autoShoot = !autoShoot;
  const btn = document.getElementById("autoBtn");
  if (autoShoot) {
    btn.classList.add("active");
    showWarning("ğŸ”« KÃ­ch hoáº¡t auto");
  } else {
    btn.classList.remove("active");
    showWarning("ğŸ”« Táº¯t auto!");
  }
};
// ğŸ° Ká»¹ nÄƒng Pet
document.getElementById("PetBtn").onclick = () => {
  playSound('sfx-ui-click', 0.2);
  if (petActive) return;                       // Ä‘ang cÃ³ thá» â†’ bá»
  if (player.energy < 5) {
    showWarning("ğŸ° KhÃ´ng Ä‘á»§ 5 âš¡");
    return;
  }
  activatePet();                               // kÃ­ch hoáº¡t thÃ nh cÃ´ng
  player.energy -= 5;                          // trá»« âš¡ duy nháº¥t 1 láº§n
};
// âœ¨ Ká»¹ nÄƒng HÃ o quang
document.getElementById("supportAuraBtn").onclick = () => {
  playSound('sfx-ui-click', 0.2);
    if (player.level < 6) return showWarning("âœ¨ YÃªu cáº§u Lv6");
    if (player.energy < 15) return showWarning("âœ¨ KhÃ´ng Ä‘á»§ 15âš¡");
    
    if (!supportAuraActive) {
        supportAuraActive = true;
        supportAuraEndTime = Date.now() + 60000;
        player.energy -= 15;
        showWarning("âœ¨ KÃ­ch hoáº¡t HÃ o quang!");
        document.getElementById("supportAuraBtn").classList.add("active");

        // Táº¡o hiá»‡u á»©ng cÃ¡c Ä‘Æ°á»ng ná»©t
        auraCrackLines = [];
        const crackCount = 30;
        const radius = 45;

        for (let i = 0; i < crackCount; i++) {
            const angle = Math.random() * Math.PI * 2;
            const distFromCenter = Math.random() * radius;
            const length = 5 + Math.random() * 10;
            
            const x1 = Math.cos(angle) * distFromCenter;
            const y1 = Math.sin(angle) * distFromCenter;
            const x2 = x1 + Math.cos(angle) * length;
            const y2 = y1 + Math.sin(angle) * length;

            auraCrackLines.push({ x1, y1, x2, y2 });
        }
    }
};
// ğŸ¦‹ KÃ­ch hoáº¡t ká»¹ nÄƒng Fairy activateFairySkill
document.getElementById("fairyBtn").onclick = () => {
  playSound('sfx-ui-click', 0.2);
  if (player.level < 7) return showWarning("ğŸ¦‹ YÃªu cáº§u Lv7");
  if (player.energy < 25) return showWarning("ğŸ¦‹ KhÃ´ng Ä‘á»§ 25âš¡");
  if (fairyActive) return; // KhÃ´ng kÃ­ch hoáº¡t náº¿u Ä‘ang trong thá»i gian há»“i

  fairyActive = true;
  fairyEndTime = Date.now() + 60000;
  player.energy -= 25;
  fairyDeathDefyAvailable = true; // KÃ­ch hoáº¡t kháº£ nÄƒng há»“i sinh

  // Táº¡o cÃ¡c Fairy dá»±a trÃªn cáº¥p Ä‘á»™ nÃ¢ng cáº¥p
  fairies = [];
  const count = skillUpgrades.fairyCount;
  for (let i = 0; i < count; i++) {
    fairies.push({
      angle: (2 * Math.PI / count) * i,
      orbitRadius: 50 + (i * 10), // CÃ¡c Fairy bay á»Ÿ quá»¹ Ä‘áº¡o khÃ¡c nhau
      bobOffset: Math.random() * Math.PI * 2, // Hiá»‡u á»©ng nháº¥p nhÃ´ riÃªng
      nextAttackTime: Date.now() + Math.random() * 2000
    });
  }

  showWarning("ğŸ¦‹ Triá»‡u há»“i Fairy!");
};

//ğŸ§Ÿ 6. Sinh zombie vÃ  boss
// ğŸ¨ MÃ u tÆ°Æ¡ng á»©ng cho zombie cáº¥p 1 â†’ 10
const zombieColorsByLevel = [
  "#00cc66", // Level 1 â€“ Xanh lÃ¡ sÃ¡ng (nháº¹ nhÃ ng)
  "#3399ff", // Level 2 â€“ Xanh dÆ°Æ¡ng (nháº¡t hÆ¡n boss)
  "#ffcc00", // Level 3 â€“ VÃ ng sÃ¡ng
  "#ff9900", // Level 4 â€“ Cam
  "#ff3333", // Level 5 â€“ Äá» sÃ¡ng
  "#cc00cc", // Level 6 â€“ TÃ­m
  "#9933ff", // Level 7 â€“ TÃ­m xanh Ä‘iá»‡n
  "#ff66cc", // Level 8 â€“ Há»“ng neon
  "#00ffff", // Level 9 â€“ Xanh cyan
  "#ffffff"  // Level 10 â€“ Tráº¯ng sÃ¡ng chÃ³i (gáº§n max)
];

// ğŸ“Š Báº£ng xÃ¡c suáº¥t cáº¥p Ä‘á»™ zombie theo tá»«ng wave
/**
 * TÃ­nh toÃ¡n cáº¥p Ä‘á»™ (sá»©c máº¡nh) cá»§a zombie, cho phÃ©p cáº£ 10 loáº¡i xuáº¥t hiá»‡n vá»›i tá»‰ lá»‡ thay Ä‘á»•i theo wave.
 * @param {number} wave - Sá»‘ wave hiá»‡n táº¡i.
 * @returns {number} Cáº¥p Ä‘á»™ cá»§a zombie (dÆ°á»›i dáº¡ng index tá»« 0 Ä‘áº¿n 9).
 */
function getZombieLevelByWave(wave) {
    // Wave 1 váº«n luÃ´n lÃ  wave khá»Ÿi Ä‘á»™ng vá»›i zombie yáº¿u nháº¥t.
    if (wave === 1) {
        return 0;
    }

    const MAX_ZOMBIE_LEVEL = 9; // CÃ³ 10 cáº¥p Ä‘á»™, tá»« index 0 Ä‘áº¿n 9.

    // 1. XÃ¡c Ä‘á»‹nh "trá»ng tÃ¢m Ä‘á»™ khÃ³" cho wave hiá»‡n táº¡i.
    // Con sá»‘ nÃ y sáº½ tÄƒng dáº§n khi wave tÄƒng, quyáº¿t Ä‘á»‹nh loáº¡i zombie nÃ o sáº½ phá»• biáº¿n nháº¥t.
    const centerLevel = (wave - 2) * 0.4;

    // 2. XÃ¡c Ä‘á»‹nh "Ä‘á»™ Ä‘a dáº¡ng". Con sá»‘ nÃ y cÃ ng lá»›n, cÃ¡c loáº¡i zombie xa trá»ng tÃ¢m cÃ ng cÃ³ cÆ¡ há»™i xuáº¥t hiá»‡n.
    const spread = 2.0 + (wave / 20);

    const weights = [];
    let totalWeight = 0;

    // 3. VÃ²ng láº·p qua táº¥t cáº£ 10 cáº¥p Ä‘á»™ zombie (0 Ä‘áº¿n 9) Ä‘á»ƒ tÃ­nh trá»ng sá»‘ (tá»‰ lá»‡ xuáº¥t hiá»‡n).
    for (let i = 0; i <= MAX_ZOMBIE_LEVEL; i++) {
        // CÃ´ng thá»©c nÃ y tÃ­nh toÃ¡n trá»ng sá»‘ dá»±a trÃªn mÃ´ hÃ¬nh Ä‘Æ°á»ng cong Chuáº©n (Gaussian curve).
        // Zombie cÃ³ cáº¥p Ä‘á»™ cÃ ng gáº§n "trá»ng tÃ¢m Ä‘á»™ khÃ³" thÃ¬ trá»ng sá»‘ cÃ ng cao, tá»‰ lá»‡ xuáº¥t hiá»‡n cÃ ng lá»›n.
        // Ngay cáº£ á»Ÿ wave cao, zombie cáº¥p tháº¥p váº«n cÃ³ má»™t trá»ng sá»‘ ráº¥t nhá» (nhÆ°ng khÃ¡c 0).
        const distance = i - centerLevel;
        const weight = Math.exp(-(distance * distance) / (2 * spread * spread));
        
        weights.push({ level: i, weight: weight });
        totalWeight += weight;
    }

    // 4. Chá»n ngáº«u nhiÃªn má»™t cáº¥p Ä‘á»™ dá»±a trÃªn cÃ¡c trá»ng sá»‘ Ä‘Ã£ tÃ­nh.
    const rand = Math.random() * totalWeight;
    let weightSum = 0;
    for (const item of weights) {
        weightSum += item.weight;
        if (rand < weightSum) {
            return item.level;
        }
    }

    return MAX_ZOMBIE_LEVEL; // Dá»± phÃ²ng náº¿u cÃ³ lá»—i xáº£y ra.
}
// Khá»Ÿi táº¡o Zombie
function spawnZombie() {
  const z = getZombie();
    // âœ¨ GÃN CHá»¦NG LOÃ€I NGáºªU NHIÃŠN âœ¨
  z.style = zombieTypes[Math.floor(Math.random() * zombieTypes.length)];
  const level = getZombieLevelByWave(wave); // cáº¥p tá»« 0â€“9
// HP zombie tÄƒng theo level player + random 1~10
// --- Báº®T Äáº¦U PHáº¦N TÃNH HP Cáº¢I TIáº¾N ---

    // Kiá»ƒm tra xem cÃ³ pháº£i lÃ  wave Ä‘áº§u tiÃªn khÃ´ng.
    // Wave 1 sáº½ cÃ³ cÃ¡ch tÃ­nh HP Ä‘áº·c biá»‡t Ä‘á»ƒ giÃºp ngÆ°á»i chÆ¡i dá»… khá»Ÿi Ä‘áº§u.
    if (wave === 1) {
        
        // GÃ¡n HP cho zombie lÃ  má»™t sá»‘ nguyÃªn ngáº«u nhiÃªn tá»« 1 Ä‘áº¿n 4.
        // Math.random() * 4 -> táº¡o sá»‘ tháº­p phÃ¢n ngáº«u nhiÃªn tá»« 0 Ä‘áº¿n 3.99...
        // Math.floor(...)   -> lÃ m trÃ²n xuá»‘ng (0, 1, 2, hoáº·c 3)
        // ... + 1           -> káº¿t quáº£ cuá»‘i cÃ¹ng lÃ  1, 2, 3, hoáº·c 4.
        z.hp = Math.floor(Math.random() * 4) + 1;

    } else {
        
        // Náº¿u khÃ´ng pháº£i wave 1 (tá»©c lÃ  tá»« wave 2 trá»Ÿ Ä‘i), Ã¡p dá»¥ng cÃ´ng thá»©c tÃ­nh HP phá»©c táº¡p hÆ¡n.
        // Cáº¥u hÃ¬nh cÃ¡c chá»‰ sá»‘ cÆ¡ báº£n Ä‘á»ƒ tÃ­nh toÃ¡n HP.
        const HP_CONFIG = {
            BASE_HP: 1,                  // HP tá»‘i thiá»ƒu cá»§a má»™t zombie.
            HP_PER_ZOMBIE_LEVEL: 5,      // LÆ°á»£ng HP Ä‘Æ°á»£c cá»™ng thÃªm cho má»—i cáº¥p cá»§a zombie.
            HP_PER_WAVE: 2.5,            // LÆ°á»£ng HP Ä‘Æ°á»£c cá»™ng thÃªm cho má»—i wave (Ä‘á»™ khÃ³ tÄƒng dáº§n).
            RANDOM_VARIANCE: 0.20,       // Tá»‰ lá»‡ ngáº«u nhiÃªn (+/- 20%) Ä‘á»ƒ HP cá»§a zombie Ä‘a dáº¡ng hÆ¡n.
            ELITE_CHANCE: 0.05,          // 5% tá»‰ lá»‡ xuáº¥t hiá»‡n zombie Tinh Anh.
            ELITE_HP_MULTIPLIER: 5       // Zombie Tinh Anh sáº½ cÃ³ lÆ°á»£ng HP nhÃ¢n lÃªn 5 láº§n.
        };

        // TÃ­nh toÃ¡n HP cÆ¡ báº£n trÆ°á»›c khi thÃªm yáº¿u tá»‘ ngáº«u nhiÃªn.
        // CÃ´ng thá»©c = HP gá»‘c + HP thÆ°á»Ÿng theo cáº¥p zombie + HP thÆ°á»Ÿng theo wave.
        // (wave - 1) Ä‘Æ°á»£c dÃ¹ng Ä‘á»ƒ Ä‘áº£m báº£o viá»‡c cá»™ng HP theo wave chá»‰ báº¯t Ä‘áº§u tá»« wave 2.
        let calculatedHp = HP_CONFIG.BASE_HP +
                           (level * HP_CONFIG.HP_PER_ZOMBIE_LEVEL) +
                           ((wave - 1) * HP_CONFIG.HP_PER_WAVE);

        // ThÃªm yáº¿u tá»‘ ngáº«u nhiÃªn vÃ o HP Ä‘Ã£ tÃ­nh.
        const variance = calculatedHp * HP_CONFIG.RANDOM_VARIANCE; // TÃ­nh toÃ¡n lÆ°á»£ng HP cÃ³ thá»ƒ thay Ä‘á»•i (+/- 20%).
        calculatedHp += Math.random() * variance * 2 - variance;   // Cá»™ng/trá»« ngáº«u nhiÃªn trong khoáº£ng Ä‘Ã³.

        // Kiá»ƒm tra xem zombie cÃ³ pháº£i lÃ  loáº¡i Tinh Anh (Elite) hay khÃ´ng.
        if (Math.random() < HP_CONFIG.ELITE_CHANCE) { // Náº¿u sá»‘ ngáº«u nhiÃªn nhá» hÆ¡n 0.05 (5%)
            calculatedHp *= HP_CONFIG.ELITE_HP_MULTIPLIER; // NhÃ¢n HP lÃªn 5 láº§n.
            z.isElite = true; // ÄÃ¡nh dáº¥u Ä‘Ã¢y lÃ  zombie Tinh Anh.
        } else {
            z.isElite = false; // ÄÃ¡nh dáº¥u Ä‘Ã¢y lÃ  zombie thÆ°á»ng.
        }

        // GÃ¡n HP cuá»‘i cÃ¹ng cho zombie, lÃ m trÃ²n vÃ  Ä‘áº£m báº£o khÃ´ng bao giá» nhá» hÆ¡n 1.
        z.hp = Math.max(1, Math.round(calculatedHp));
    }

    // --- Káº¾T THÃšC PHáº¦N TÃNH HP ---

    // LÆ°u láº¡i lÆ°á»£ng HP ban Ä‘áº§u cá»§a zombie Ä‘á»ƒ dÃ¹ng cho cÃ¡c logic khÃ¡c náº¿u cáº§n.
    z.baseHp = z.hp;
    z.level = level + 1; // cáº¥p tháº­t tá»« 1â€“10
    z.behaviorCheckCounter = 0; // Khá»Ÿi táº¡o bá»™ Ä‘áº¿m chu ká»³ hÃ nh vi
    z.showStatusIcon = Math.random() < 0.3; // GÃ¡n ngáº«u nhiÃªn cÃ³ hiá»ƒn thá»‹ icon hay khÃ´ng láº§n Ä‘áº§u tiÃªn
    z.lastDayBuffed = currentDay;
    z.isBuffed = false;
    z.nightBuffApplied = false;
    z.lastRegenTime = Date.now();

// ğŸ‘£ Di chuyá»ƒn ngáº«u nhiÃªn ban Ä‘áº§u
  z.state = "wandering";
  z.nextStateCheck = Date.now() + 3000; // kiá»ƒm tra má»—i 3s khi Ä‘ang chasing - kiá»ƒm tra má»—i giÃ¢y
  z.wanderTime = Date.now() + 2000 + Math.random() * 2000; // tá»« 2 Ä‘áº¿n 4 giÃ¢y
  z.wanderAngle = Math.random() * Math.PI * 2;
// ğŸ² Chá»n kiá»ƒu wander: 80% di chuyá»ƒn, 20% Ä‘á»©ng im
  z.wanderBehavior = Math.random() < 0.2 ? "pause" : "move";
  z.baseSpeed = 0.2 + Math.random() * 0.8; // tá»‘c Ä‘á»™ khi chasing - tá»‘c Ä‘á»™ khi Ä‘uá»•i theo
  z.speed = 0.15 + Math.random() * 0.5;   // tá»‘c Ä‘á»™ khi wandering - tá»‘c Ä‘á»™ khi lang thang
  z.color = zombieColorsByLevel[level];
  z.type = "normal";
  z.radius = 15;
  z.isBoss = false;

// ğŸ¯ Random mini boss (xuáº¥t hiá»‡n 2%) - Tá»· lá»‡ xuáº¥t hiá»‡n mini boss
if (Math.random() < 0.02) {
  z.type = "miniBoss";
  // HP mini boss tÄƒng theo wave vÃ  level player
  z.hp = 50 + wave + Math.floor(player.level / 2) + Math.floor(Math.random() * 20 + 1); 
  z.color = bossColors[Math.floor(Math.random() * bossColors.length)]; // MÃ u mini boss
  z.radius = 18;
  z.level = 99; // ÄÃ¡nh dáº¥u riÃªng Ä‘á»ƒ khÃ´ng tÃ­nh cáº¥p thÆ°á»ng
}

// ğŸ“ Táº¡o zombie ngáº«u nhiÃªn bÃªn trong báº£n Ä‘á»“
z.x = Math.random() * worldWidth;
z.y = Math.random() * worldHeight;
// ğŸ“ Äáº·t zombie
  zombies.push(z);
  zombieSpawnedCount++;
}

// MÃ u boss
const bossColors = [
  "#ff3333", // Äá» tÆ°Æ¡i
  "#ff8800", // Cam rá»±c
  "#ffaa00", // VÃ ng cam
  "#00ccff", // Xanh dÆ°Æ¡ng sÃ¡ng
  "#9933ff", // TÃ­m Ä‘áº­m
  "#00ff99", // Xanh ngá»c
  "#ff66cc", // Há»“ng neon
  "#ffffff", // Tráº¯ng láº¡nh
  "#888888", // XÃ¡m tro (boss mÃ¡y mÃ³c)
  "#00ffff"  // Xanh cyan Ã¡nh kim
];

function spawnBoss(spawnX, spawnY) { // ThÃªm 2 tham sá»‘ vá»‹ trÃ­
  const z = getZombie();

  // Náº¾U CÃ“ Vá»Š TRÃ Cá»¤ THá»‚ -> Táº O BOSS Táº I ÄÃ“
  if (spawnX !== undefined && spawnY !== undefined) {
      z.x = spawnX;
      z.y = spawnY;
  } else {   // ğŸ“ âŠ Chá»n vá»‹ trÃ­ ngáº«u nhiÃªn trong world
  // (worldWidth / worldHeight Ä‘Ã£ dÃ¹ng cho zombie thÆ°á»ng)
  do {
    z.x = Math.random() * worldWidth;
    z.y = Math.random() * worldHeight;
    // ğŸ“ â‹ Báº£o Ä‘áº£m khÃ´ng â€œÃºp sá»tâ€ player
  } while (distance(z, player) < 250); // â‰¥ 250 px má»›i cho xuáº¥t hiá»‡n
  }
  z.radius = 30;
  z.canHit = true;
  z.baseSpeed = 0.015 + Math.random() * 0.2; // LÆ°u tá»‘c Ä‘á»™ gá»‘c | Tá»‘c Ä‘á»™ boss
  z.speed = z.baseSpeed; // Tá»‘c Ä‘á»™ zombie
  z.isBoss = true;
  // HP boss tÄƒng theo wave vÃ  level player + random 1~100
  z.hp = 500 + wave * 2 + Math.floor(player.level / 2) + Math.floor(Math.random() * 100 + 1);
  z.baseHp = z.hp; // ğŸ”‘ Ghi nhá»› HP gá»‘c Ä‘á»ƒ reset ban ngÃ y
  z.type = "boss";
  z.level = 100; // level Boss
  z.color = bossColors[Math.floor(Math.random() * bossColors.length)]; // MÃ u boss
  z.active = true;
  z.state = "chasing";
  zombies.push(z);
  zombieSpawnedCount++;
  z.lastDayBuffed = currentDay;
  z.isBuffed = false;
  z.nightBuffApplied = false;
  z.lastRegenTime = Date.now();
}
// HÃ m sinh Big Boss ğŸ‘¹ â€“ boss máº¡nh nháº¥t
function spawnBigBoss() {
    const z = getZombie();
    z.active = true; // reset láº¡i cháº¯c cháº¯n
    z.state = "chasing";
    z._killed = false;

    do {
        z.x = Math.random() * worldWidth;
        z.y = Math.random() * worldHeight;
    } while (distance(z, player) < 250); // trÃ¡nh sinh gáº§n player

    z.radius = 120; // KÃ­ch thÆ°á»›c bigboss
    z.baseSpeed = 0.01 + Math.random() * 0.2;
    z.speed = z.baseSpeed;
    z.isBoss = true;
    z.isBigBoss = true; // ğŸ”‘ ÄÃ¡nh dáº¥u riÃªng bigBoss
    z.hp = 10000 + wave * 500 + Math.floor(Math.random() * 1000 + 250);
    z.baseHp = z.hp;
    z.type = "bigBoss";
    z.level = 999;
    z.color = "purple"; // Äá»•i mÃ u Ä‘á»ƒ dá»… phÃ¢n biá»‡t
    z.active = true;
z.lazerTimer = 0;
z.isLazerAttacking = false;
z.lazerDuration = 0;
    zombies.push(z);
    zombieSpawnedCount++;
    z.lastDayBuffed = currentDay;
    z.isBuffed = false;
    z.nightBuffApplied = false;
    z.lastRegenTime = Date.now();
}

//ğŸ§  7. Cáº­p nháº­t UI â€“ chá»‰ DOM
// ğŸ§Ÿ HÃ m cáº­p nháº­t Wave riÃªng biá»‡t (dÃ¹ng khi wave thay Ä‘á»•i)
function updateWaveUI() {
  document.getElementById("score-bottom").innerText = 
  `Level: ${player.level.toString().padStart(4, '0')} |âš¡: ${player.energy.toString().padStart(4, '0')}`;
  setTimeout(() => {
  document.getElementById("waveNumberDisplay").innerText = `Wave: ${wave}`;
}, 1000); // â±ï¸ hiá»ƒn thá»‹ sau 1 giÃ¢y
  document.getElementById("ui-mana").innerText = `ğŸ’  Mana: ${player.mana}`;
}
// DOM chá»‰ cáº­p nháº­t khi giÃ¡ trá»‹ thay Ä‘á»•i
let lastScore = -1, lastLevel = -1, lastEnergy = -1, lastHearts = -1, lastHighScore = -1; let lastMana = -1;
let lastBladeText = "", lastSwordText = "", lastFireText = "", lastIceText = "", lastFpsText = "", lastPetText = "";
let lastDay = -1, lastCoins = -1, lastExp = -1;
// HÃ m cáº­p nháº­t toÃ n bá»™ Giao diá»‡n NgÆ°á»i dÃ¹ng (UI), chá»‰ thá»±c hiá»‡n khi cÃ³ giÃ¡ trá»‹ thay Ä‘á»•i Ä‘á»ƒ tá»‘i Æ°u hiá»‡u suáº¥t
function updateUI() {
    // --- Cáº¬P NHáº¬T CÃC THÃ”NG TIN PHá»¤ ---

    // Cáº­p nháº­t hiá»ƒn thá»‹ ngÃ y, chá»‰ khi ngÃ y thay Ä‘á»•i
    if (currentDay !== lastDay) {
        document.getElementById('dayCounterDisplay').innerText = `NgÃ y: ${currentDay}`;
        lastDay = currentDay;
    }

    // Cáº­p nháº­t Ká»· lá»¥c (High Score) báº±ng player.score (sá»‘ kill)
    const highScore = parseInt(localStorage.getItem('highScore') || '0');
    if (player.score > highScore) {
        localStorage.setItem('highScore', player.score);
    }
    // Chá»‰ cáº­p nháº­t DOM khi giÃ¡ trá»‹ high score thá»±c sá»± thay Ä‘á»•i
    if (highScore !== lastHighScore) {
        document.getElementById("highScoreDisplay").innerText = `ğŸ† Ká»· lá»¥c: ${highScore}`;
        lastHighScore = highScore;
    }
    
    // --- Cáº¬P NHáº¬T THANH TRáº NG THÃI CHÃNH ---

    // Cáº­p nháº­t hiá»ƒn thá»‹ tiáº¿n trÃ¬nh EXP vÃ  HP
    const scoreTopDiv = document.getElementById("score-top");
    const required = player.requiredExp;
    const current = player.currentLevelExp;
    const remaining = required - current;

    // Táº¡o chuá»—i text má»›i cho EXP vÃ  HP
    const newExpText = `Exp: ${current.toString().padStart(4, '0')} |â¤ï¸: ${player.hearts.toString().padStart(4, '0')}`;
    // Chá»‰ cáº­p nháº­t DOM náº¿u text thay Ä‘á»•i Ä‘á»ƒ trÃ¡nh reflow khÃ´ng cáº§n thiáº¿t
    if (scoreTopDiv.innerText !== newExpText) {
        scoreTopDiv.innerText = newExpText;
    }
    
    // Cáº­p nháº­t tooltip vá»›i lÆ°á»£ng EXP cÃ²n láº¡i
    const newTooltip = `Exp cáº¥p tiáº¿p theo: ${remaining}`;
    if (scoreTopDiv.dataset.tooltip !== newTooltip) {
        scoreTopDiv.dataset.tooltip = newTooltip;
    }

    // Cáº­p nháº­t hiá»ƒn thá»‹ sá»‘ xu
    if (player.coins !== lastCoins) {
        const formattedCoins = player.coins.toString().padStart(4, '0');
        document.getElementById('coinCounterDisplay').innerText = `ğŸª™: ${formattedCoins}`;
        lastCoins = player.coins;
    }

    // Cáº­p nháº­t hiá»ƒn thá»‹ Level vÃ  Energy
    if (player.level !== lastLevel || player.energy !== lastEnergy) {
        lastLevel = player.level;
        lastEnergy = player.energy;
        updateWaveUI(); // Gá»i hÃ m con Ä‘á»ƒ cáº­p nháº­t text cho Level vÃ  Energy
    }

    // Cáº­p nháº­t hiá»ƒn thá»‹ Mana
    if (player.mana !== lastMana) {
        lastMana = player.mana;
        document.getElementById("ui-mana").innerText = `ğŸ’  Mana: ${player.mana}`;
    }

    // --- Cáº¬P NHáº¬T HIá»‚N THá»Š CÃC BUFF Táº M THá»œI ---
    
    // Cáº­p nháº­t hiá»ƒn thá»‹ cho buff Lucky
    const luckyDisplay = document.getElementById('luckyBuffDisplay');
    if (Date.now() < luckyBuffEndTime) {
        luckyDisplay.classList.remove('inactive');
        luckyDisplay.classList.add('active-glow');
        const timeLeft = Math.ceil((luckyBuffEndTime - Date.now()) / 1000);
        luckyDisplay.innerHTML = `ğŸ€ LuckyUp: <span>${timeLeft}</span>s`; // Sá»­a tÃªn
    } else {
        luckyDisplay.classList.add('inactive');
        luckyDisplay.classList.remove('active-glow');
        luckyDisplay.innerHTML = `ğŸ€ LuckyUp: <span>---</span>`; // Sá»­a tÃªn
    }

    // Cáº­p nháº­t hiá»ƒn thá»‹ cho buff Power
    const powerDisplay = document.getElementById('powerBuffDisplay');
    if (Date.now() < powerBuffEndTime) {
        powerDisplay.classList.remove('inactive');
        powerDisplay.classList.add('active-glow');
        const timeLeft = Math.ceil((powerBuffEndTime - Date.now()) / 1000);
        powerDisplay.innerHTML = `ğŸ PowerUp: <span>${timeLeft}</span>s`; // Sá»­a tÃªn
    } else {
        powerDisplay.classList.add('inactive');
        powerDisplay.classList.remove('active-glow');
        powerDisplay.innerHTML = `ğŸ PowerUp: <span>---</span>`; // Sá»­a tÃªn
    }
    
    // Cáº­p nháº­t hiá»ƒn thá»‹ cho buff Crazy
    const crazyDisplay = document.getElementById('crazyBuffDisplay');
    if (Date.now() < crazyBuffEndTime) {
        crazyDisplay.classList.remove('inactive');
        crazyDisplay.classList.add('active-glow');
        const timeLeft = Math.ceil((crazyBuffEndTime - Date.now()) / 1000);
        crazyDisplay.innerHTML = `ğŸ‚ CrazyUp: <span>${timeLeft}</span>s`; // Sá»­a tÃªn
    } else {
        crazyDisplay.classList.add('inactive');
        crazyDisplay.classList.remove('active-glow');
        crazyDisplay.innerHTML = `ğŸ‚ CrazyUp: <span>---</span>`; // Sá»­a tÃªn
    }

    // Cáº­p nháº­t hiá»ƒn thá»‹ cho buff ExpUp (Má»šI)
    const expDisplay = document.getElementById('expBuffDisplay');
    if (Date.now() < expBuffEndTime) {
        expDisplay.classList.remove('inactive');
        expDisplay.classList.add('active-glow');
        const timeLeft = Math.ceil((expBuffEndTime - Date.now()) / 1000);
        expDisplay.innerHTML = `ğŸŒ¿ ExpUp: <span>${timeLeft}</span>s`;
    } else {
        expDisplay.classList.add('inactive');
        expDisplay.classList.remove('active-glow');
        expDisplay.innerHTML = `ğŸŒ¿ ExpUp: <span>---</span>`;
    }
    // Cáº­p nháº­t hiá»ƒn thá»‹ cho buff Magnet
    const magnetDisplay = document.getElementById('magnetBuffDisplay');
    if (Date.now() < magnetBuffEndTime) {
        magnetDisplay.style.display = 'block'; // Hiá»‡n lÃªn
        magnetDisplay.classList.add('active-glow');
        const timeLeft = Math.ceil((magnetBuffEndTime - Date.now()) / 1000);
        magnetDisplay.innerHTML = `ğŸ§² Magnet: <span>${timeLeft}</span>s`;
    } else {
        magnetDisplay.style.display = 'none'; // áº¨n Ä‘i
        magnetDisplay.classList.remove('active-glow');
    }
    // Cáº­p nháº­t hiá»ƒn thá»‹ cho buff CrazyMadnessTime (Má»šI)
    const crazyMadnessDisplay = document.getElementById('crazymadnesstimeBuffDisplay');
    if (Date.now() < crazyMadnessTimeEndTime) {
        crazyMadnessDisplay.style.display = 'block'; // Hiá»‡n lÃªn
        crazyMadnessDisplay.classList.add('active-glow');
        const timeLeft = Math.ceil((crazyMadnessTimeEndTime - Date.now()) / 1000);
        crazyMadnessDisplay.innerHTML = `ğŸ’¢ CrazyMadnessTime: <span>${timeLeft}</span>s`;
    } else {
        crazyMadnessDisplay.style.display = 'none'; // áº¨n Ä‘i
        crazyMadnessDisplay.classList.remove('active-glow');
    }
}

// ğŸ§¿ TÃ¬m zombie cÃ²n sá»‘ng gáº§n player nháº¥t 
function findActiveZombie() {
  return zombies.find(z => z.active);
}

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   ğŸ° Cáº¬P NHáº¬T PET â€“ Gá»ŒI Má»–I FRAME
   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function updatePet() {
  const now = Date.now();
  if (!petActive || !petRabbit) return;

  /* háº±ng sá»‘ */
  const DIST_ITEM    = 360;
  const DIST_FOLLOW  = 480;
  const TOLERANCE    = 40;
  const PICK_DIST    = 16;
  const GIVE_UP_MS   = 3000;
  const MIN_PROGRESS = 20;    // pháº£i tiáº¿n â‰¥20 px sau 3 s

  /* tá»‘c Ä‘á»™ pet */
  petRabbit.speed = (player.speed ?? 1) + 0.4;

  /* 0. quay vá» náº¿u xa player quÃ¡ */
  if (distance(petRabbit, player) > DIST_FOLLOW) {
    moveTowards(petRabbit, player, petRabbit.speed * 1.6);
    petRabbit.target = null;
    return;
  }

  /* 1. chá»n má»¥c tiÃªu má»›i */
  if (!petRabbit.target || !petRabbit.target.active) {
    petRabbit.target = items
      .filter(it => {
        if (!it.active) return false;
        if (distance(petRabbit, it) > DIST_ITEM) return false;
        /* cáº¥m chá»n láº¡i item vá»«a bá» trong 2 s */
        if (it.id === lastGiveUpId &&
            Date.now() - lastGiveUpTime < RESELECT_CD) return false;
        return true;
      })
      .sort((a, b) => distance(petRabbit, a) - distance(petRabbit, b))[0] || null;

    if (petRabbit.target) {
      petRabbit.chaseStart    = Date.now();
      petRabbit.startDistance = distance(petRabbit, petRabbit.target);
    }
  }

  /* 2. Ä‘uá»•i & nháº·t */
  if (petRabbit.target) {
    const dNow     = distance(petRabbit, petRabbit.target);
    const elapsed  = Date.now() - petRabbit.chaseStart;
    const progress = petRabbit.startDistance - dNow;

    /* bá» náº¿u >3 s mÃ  tiáº¿n <20 px */
    if (elapsed > GIVE_UP_MS && progress < MIN_PROGRESS) {
      giveUp();
      return;
    }

    /* bá» náº¿u má»¥c tiÃªu láº¡i quÃ¡ xa player */
    if (distance(player, petRabbit.target) > DIST_FOLLOW) {
      giveUp();
      return;
    }

    moveTowards(petRabbit, petRabbit.target, petRabbit.speed);

    if (dNow < PICK_DIST) collectLoot();
  }
    /* 3. bÃ¡m player khi khÃ´ng cÃ³ má»¥c tiÃªu */
    else if (distance(petRabbit, player) > TOLERANCE) {
        moveTowards(petRabbit, player, petRabbit.speed * 1.2);
    }

    // âœ¨ Báº®T Äáº¦U LOGIC Táº¤N CÃ”NG Äáº¾M NGÆ¯á»¢C Má»šI âœ¨
    // 1. Äáº¿m ngÆ°á»£c thá»i gian há»“i chiÃªu
    if (petRabbit.attackTimer > 0) {
        petRabbit.attackTimer -= 1000 * globalDeltaTime; // Trá»« Ä‘i thá»i gian cá»§a frame vá»«a qua
    }

    // 2. Náº¿u Ä‘Ã£ háº¿t thá»i gian há»“i, tÃ¬m má»¥c tiÃªu vÃ  táº¥n cÃ´ng
    if (petRabbit.attackTimer <= 0) {
        const target = zombies
            .filter(z => z.active)
            .sort((a, b) => distance(petRabbit, a) - distance(petRabbit, b))[0];

        if (target) {
            // 3. Äáº·t láº¡i thá»i gian há»“i chiÃªu SAU KHI Ä‘Ã£ báº¯n
            petRabbit.attackTimer = 1000; // <-- Há»“i chiÃªu 1 giÃ¢y (1000ms)

            const b = getBullet();
            b.x = petRabbit.x;
            b.y = petRabbit.y;
            
            const angle = Math.atan2(target.y - petRabbit.y, target.x - petRabbit.x);
            b.dx = Math.cos(angle);
            b.dy = Math.sin(angle);
            
            b.isPetBullet = true;
            b.icon = 'ğŸ¥•';
            b.speed = 2;
            b.stunDuration = 1000;
            b.customDmg = 1 + (wave - 1) + (player.level - 1);
            
            bullets.push(b);
        }
    }
    // âœ¨ Káº¾T THÃšC LOGIC Táº¤N CÃ”NG âœ¨

    // Há»“i mÃ¡u vÃ  háº¿t giá» (giá»¯ nguyÃªn)
    if (now - petLastHealTime >= 3000) {
        petLastHealTime = now;
        player.hearts++;
        createHealImpactEffect(player, 1);
    }
    if (now >= petEndTime) {
        petActive = false;
        petRabbit = null;
        showWarning("ğŸ° Pet Ä‘Ã£ rá»i Ä‘i.");
    }
}

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   ğŸš€ Cáº¬P NHáº¬T TÃŠN Lá»¬A â€“ Gá»ŒI Má»–I FRAME
   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function updateMissiles() {
  // Láº·p ngÆ°á»£c Ä‘á»ƒ xÃ³a pháº§n tá»­ an toÃ n
  for (let i = missiles.length - 1; i >= 0; i--) {
    const m = missiles[i];
    let shouldRemove = false; // Cá» Ä‘á»ƒ quyáº¿t Ä‘á»‹nh cÃ³ xÃ³a tÃªn lá»­a khÃ´ng

    // --- Giai Ä‘oáº¡n chá» (delay) ---
    if (m.state === "delay") {
      m.delay--;
      if (m.delay <= 0) {
        m.state = "fly";
      }
      continue; 
    }

    // --- Cáº­p nháº­t di chuyá»ƒn & dáº«n hÆ°á»›ng ---
    if (m.target && m.target.active) {
      const desiredAngle = Math.atan2(m.target.y - m.y, m.target.x - m.x);
      const currentAngle = Math.atan2(m.dy, m.dx);
      const turnRate = 0.05;
      let delta = desiredAngle - currentAngle;
      if (delta > Math.PI) delta -= 2 * Math.PI;
      if (delta < -Math.PI) delta += 2 * Math.PI;
      const newAngle = currentAngle + Math.sign(delta) * Math.min(turnRate, Math.abs(delta));
      const speed = 2.5;
      m.dx = Math.cos(newAngle) * speed;
      m.dy = Math.sin(newAngle) * speed;
    }
    m.x += m.dx;
    m.y += m.dy;

    // --- GÃ¢y sÃ¡t thÆ°Æ¡ng xuyÃªn trÃªn Ä‘Æ°á»ng bay ---
    zombies.forEach(z => {
      if (z.active && !m.hitSet.has(z) && distance(m, z) < 20) {
        if (!z.missileHitCooldown || Date.now() > z.missileHitCooldown) {
          dealDamageToZombie(z, m.damage);
          m.hitSet.add(z);
          z.missileHitCooldown = Date.now() + 100;
        }
      }
    });

    // --- Kiá»ƒm tra Ä‘iá»u kiá»‡n Ä‘á»ƒ ná»• ---
    const travelDistance = distance({ x: m.startX, y: m.startY }, m);
    const hitTarget = m.target && m.target.active && distance(m, m.target) < 25;

    if (travelDistance > 360 || hitTarget) {
      // KÃ­ch hoáº¡t vá»¥ ná»• kÃ©p
      zombies.forEach(z => {
        if (z.active && distance(m, z) < 120) {
          dealDamageToZombie(z, m.damage);
        }
      });
      createParticleExplosion(m.x, m.y, 50, 'fire');
      setTimeout(() => {
        zombies.forEach(z => {
          if (z.active && distance(m, z) < 120) {
            dealDamageToZombie(z, m.damage * 0.5);
          }
        });
        const secondaryExplosion = getExplosion(m.x, m.y);
        secondaryExplosion.life = 15;
        explosions.push(secondaryExplosion);
      }, 200);
      shouldRemove = true;
    }

    if (shouldRemove) {
      missiles.splice(i, 1);
    }
  }
}

/* ================================
   1) LÆ¯á»šI KHÃ”NG GIAN (SPATIAL GRID)
   - Má»¥c tiÃªu: chá»‰ xÃ©t Ä‘á»‘i tÆ°á»£ng "á»Ÿ gáº§n" há»‘ Ä‘en.
   - KHÃ”NG táº¡o máº£ng má»›i má»—i frame -> trÃ¡nh GC.
   - Vá»›i world 3000x2000, cell 200 lÃ  há»£p lÃ½ (cÃ³ thá»ƒ chá»‰nh).
================================== */

const WORLD_W = 3000;
const WORLD_H = 2000;
const CELL_SIZE = 200; // nÃªn >= pullRadius lá»›n nháº¥t Ä‘á»ƒ giáº£m sá»‘ cell kiá»ƒm tra

const GRID_COLS = Math.ceil(WORLD_W / CELL_SIZE);
const GRID_ROWS = Math.ceil(WORLD_H / CELL_SIZE);
const GRID_COUNT = GRID_COLS * GRID_ROWS;

// Máº£ng cell tÃ¡i sá»­ dá»¥ng cho má»—i frame (má»—i cell lÃ  1 máº£ng reuse)
const gridZ = new Array(GRID_COUNT);
const gridB = new Array(GRID_COUNT);
for (let i = 0; i < GRID_COUNT; i++) {
    gridZ[i] = [];
    gridB[i] = [];
}

// Scratch array dÃ¹ng táº¡m cho má»—i há»‘ Ä‘en (khÃ´ng cáº¥p phÃ¡t má»›i)
const scratchCells = [];

// Giá»›i háº¡n & tÃ­nh chá»‰ sá»‘ cell tá»« toáº¡ Ä‘á»™
function clamp(v, min, max) {
    return v < min ? min : (v > max ? max : v);
}
function cellIndexFromXY(x, y) {
    // clamp Ä‘á»ƒ trÃ¡nh vÆ°á»£t ngoÃ i biÃªn
    x = clamp(x, 0, WORLD_W - 1);
    y = clamp(y, 0, WORLD_H - 1);
    const col = (x / CELL_SIZE) | 0;
    const row = (y / CELL_SIZE) | 0;
    return row * GRID_COLS + col;
}

// Liá»‡t kÃª cÃ¡c cell mÃ  má»™t hÃ¬nh trÃ²n (tÃ¢m cx,cy; bÃ¡n kÃ­nh r) cáº¯t qua
// Ghi tháº³ng vÃ o 'out' (scratchCells), khÃ´ng return máº£ng má»›i -> trÃ¡nh GC.
function cellsForCircle(cx, cy, r, out) {
    let minCol = ((cx - r) / CELL_SIZE) | 0;
    let maxCol = ((cx + r) / CELL_SIZE) | 0;
    let minRow = ((cy - r) / CELL_SIZE) | 0;
    let maxRow = ((cy + r) / CELL_SIZE) | 0;

    if (minCol < 0) minCol = 0;
    if (minRow < 0) minRow = 0;
    if (maxCol >= GRID_COLS) maxCol = GRID_COLS - 1;
    if (maxRow >= GRID_ROWS) maxRow = GRID_ROWS - 1;

    // Ghi trá»±c tiáº¿p chá»‰ sá»‘ cell vÃ o 'out'
    let k = 0;
    for (let r0 = minRow; r0 <= maxRow; r0++) {
        const base = r0 * GRID_COLS;
        for (let c = minCol; c <= maxCol; c++) {
            out[k++] = base + c;
        }
    }
    out.length = k; // cáº¯t chiá»u dÃ i vá» Ä‘Ãºng sá»‘ Ã´
}

/* ============================================
   2) Cáº¬P NHáº¬T CHá»ˆ Má»¤C KHÃ”NG GIAN CHO ENTITIES
   - Gá»i Má»˜T Láº¦N trÆ°á»›c khi update há»‘ Ä‘en má»—i frame.
   - KhÃ´ng táº¡o máº£ng má»›i: chá»‰ reset length = 0.
============================================= */

function clearSpatialGrid() {
    // GRID_COUNT nhá» (~150) nÃªn viá»‡c reset ráº¥t ráº»
    for (let i = 0; i < GRID_COUNT; i++) {
        gridZ[i].length = 0;
        gridB[i].length = 0;
    }
}

function updateSpatialIndex() {
    clearSpatialGrid();

    // Ghi zombie vÃ o lÆ°á»›i
    for (let i = 0; i < zombies.length; i++) {
        const z = zombies[i];
        if (!z.active) continue;
        const idx = cellIndexFromXY(z.x, z.y);
        gridZ[idx].push(z);
    }

    // Ghi Ä‘áº¡n Ä‘á»‹ch vÃ o lÆ°á»›i
    for (let i = 0; i < enemyBullets.length; i++) {
        const b = enemyBullets[i];
        if (!b.active) continue;
        const idx = cellIndexFromXY(b.x, b.y);
        gridB[idx].push(b);
    }
}

/* ============================================================
   3) updateBlackHoles Tá»I Æ¯U + GIá»® "Cáº¢M GIÃC" Báº¢N CÅ¨
   - Báº£n cÅ© vÃ´ tÃ¬nh Ã¡p lá»±c hÃºt & damage 2 láº§n/frame.
   - Äá»ƒ GIá»® Cáº¢M GIÃC: nhÃ¢n há»‡ sá»‘ bÃ¹, khÃ´ng nhÃ¢n Ä‘Ã´i vÃ²ng láº·p.
   - KhÃ´ng dÃ¹ng .filter(); duyá»‡t ngÆ°á»£c + splice Ä‘á»ƒ xoÃ¡.
   - Chá»‰ xÃ©t entity trong cÃ¡c cell giao vá»›i pullRadius.
   - Háº¡n cháº¿ Math.sqrt: chá»‰ sqrt khi cháº¯c cháº¯n trong pháº¡m vi.
   - TrÃ¡nh atan2/cos/sin: dÃ¹ng vector chuáº©n hoÃ¡ (dx,dy)/d.
============================================================= */

// Cháº¿ Ä‘á»™ â€œgiá»¯ cáº£m giÃ¡câ€ báº£n cÅ©:
const FEEL_COMPAT = true;

// Giá»¯ cáº£m giÃ¡c hÃºt:
// - Zombie: trÆ°á»›c Ä‘Ã¢y hÃºt 2 láº§n/frame *2 => ~*4 tá»•ng thá»ƒ -> dÃ¹ng 1 láº§n nhÆ°ng *4
// - Bullet: trÆ°á»›c Ä‘Ã¢y hÃºt 2 láº§n/frame -> dÃ¹ng 1 láº§n nhÆ°ng *2
const Z_PULL_MULT = FEEL_COMPAT ? 4 : 2;
const B_PULL_MULT = FEEL_COMPAT ? 2 : 1;

// âœ… KHÃ”NG x2 sÃ¡t thÆ°Æ¡ng: giá»¯ interval Ä‘Ãºng 30 tick nhÆ° báº£n gá»‘c
const DAMAGE_INTERVAL = 30;

// Particle: Ä‘á»ƒ gáº§n máº­t Ä‘á»™ thá»‹ giÃ¡c cÅ© (trÆ°á»›c bá»‹ gá»i trÃ¹ng)
const PARTICLE_INTERVAL = FEEL_COMPAT ? 2 : 3;

// (TÃ¹y chá»n) chá»‰ spawn háº¡t khi há»‘ Ä‘en trong mÃ n hÃ¬nh + Ä‘á»‡m
// TrÃ¡nh phÃ­ váº½ háº¡t khi á»Ÿ ráº¥t xa camera
function isCircleVisible(x, y, r, camera) {
    if (!camera) return true; // náº¿u khÃ´ng quáº£n lÃ½ camera thÃ¬ cá»© cho true
    const left   = camera.x - r - 64;
    const right  = camera.x + camera.w + r + 64;
    const top    = camera.y - r - 64;
    const bottom = camera.y + camera.h + r + 64;
    return (x >= left && x <= right && y >= top && y <= bottom);
}

function updateBlackHoles() {
    const now = Date.now(); // âœ… Ä‘o 1 láº§n/frame

    // Duyá»‡t ngÆ°á»£c Ä‘á»ƒ cÃ³ thá»ƒ splice xoÃ¡ pháº§n tá»­ an toÃ n
    for (let i = blackHoles.length - 1; i >= 0; i--) {
        const hole = blackHoles[i];

        // Háº¿t háº¡n sá»‘ng â†’ xoÃ¡ ngay, khÃ´ng xá»­ lÃ½ tiáº¿p
        if (now >= hole.endTime) {
            blackHoles.splice(i, 1);
            continue;
        }

        // Tick chá»‰ tÄƒng 1 láº§n/frame
        hole.tick++;

        // Cache thuá»™c tÃ­nh dÃ¹ng nhiá»u láº§n Ä‘á»ƒ giáº£m lookup
        const pullRadius = hole.pullRadius | 0;
        const pullSpeed  = hole.pullSpeed;
        const hx = hole.x, hy = hole.y;

        // Precompute cho kiá»ƒm tra pháº¡m vi
        const r2   = pullRadius * pullRadius;
        const invR = pullRadius > 0 ? (1 / pullRadius) : 0;

        // âœ… Damage theo Ä‘Ãºng báº£n cÅ©: má»—i 30 tick
        const damageThisTick = (hole.tick % DAMAGE_INTERVAL === 0);

        // Chá»‰ hÃºt khi cÃ³ bÃ¡n kÃ­nh & tá»‘c Ä‘á»™ hÃºt
        if (pullRadius > 0 && pullSpeed !== 0) {
            // Láº¥y danh sÃ¡ch cell giao vá»›i hÃ¬nh trÃ²n hÃºt (khÃ´ng táº¡o máº£ng má»›i)
            cellsForCircle(hx, hy, pullRadius, scratchCells);

            // Duyá»‡t tá»«ng cell á»©ng viÃªn
            for (let ci = 0; ci < scratchCells.length; ci++) {
                const idx = scratchCells[ci];

                // --- HÃºt zombie ---
                const cellZ = gridZ[idx];
                for (let zi = 0; zi < cellZ.length; zi++) {
                    const z = cellZ[zi];
                    if (!z.active) continue;

                    // Vector tá»« zombie Ä‘áº¿n tÃ¢m há»‘
                    const dx = hx - z.x;
                    const dy = hy - z.y;
                    const d2 = dx * dx + dy * dy;

                    // So sÃ¡nh bÃ¬nh phÆ°Æ¡ng khoáº£ng cÃ¡ch Ä‘á»ƒ trÃ¡nh sqrt sá»›m
                    if (d2 < r2) {
                        // Chá»‰ sqrt khi cháº¯c cháº¯n trong pháº¡m vi
                        const d = Math.sqrt(d2) || 1e-6; // trÃ¡nh chia 0
                        const invD = 1 / d;

                        // Lá»±c hÃºt giáº£m theo khoáº£ng cÃ¡ch: (1 - d/R) * pullSpeed * Z_PULL_MULT
                        const strength = (1 - d * invR) * pullSpeed * Z_PULL_MULT;

                        // Äáº©y zombie vá» phÃ­a tÃ¢m (chuáº©n hoÃ¡ vector â†’ khÃ´ng cáº§n atan2/cos/sin)
                        z.x += dx * invD * strength;
                        z.y += dy * invD * strength;

                        if (damageThisTick) {
                            dealDamageToZombie(z, hole.damage);
                        }
                    }
                }

                // --- HÃºt Ä‘áº¡n Ä‘á»‹ch ---
                const cellB = gridB[idx];
                for (let bi = 0; bi < cellB.length; bi++) {
                    const b = cellB[bi];
                    if (!b.active) continue;

                    const dx = hx - b.x;
                    const dy = hy - b.y;
                    const d2 = dx * dx + dy * dy;

                    if (d2 < r2) {
                        const d = Math.sqrt(d2) || 1e-6;
                        const invD = 1 / d;

                        // Äáº¡n dÃ¹ng há»‡ sá»‘ B_PULL_MULT Ä‘á»ƒ giá»¯ cáº£m giÃ¡c cÅ©
                        b.x += dx * invD * pullSpeed * B_PULL_MULT;
                        b.y += dy * invD * pullSpeed * B_PULL_MULT;

                        // Äá»§ gáº§n tÃ¢m â†’ thu há»“i/huá»·
                        if (d < 20) {
                            releaseEnemyBullet(b);
                        }
                    }
                }
            }
        }

        // Di chuyá»ƒn há»‘ Ä‘en (sau khi hÃºt), rá»“i clamp biÃªn
        hole.x = hx + hole.dx;
        hole.y = hy + hole.dy;

        if (hole.x < wallThickness) hole.x = wallThickness;
        else if (hole.x > worldWidth - wallThickness) hole.x = worldWidth - wallThickness;

        if (hole.y < wallThickness) hole.y = wallThickness;
        else if (hole.y > worldHeight - wallThickness) hole.y = worldHeight - wallThickness;

        // Spawn háº¡t (máº­t Ä‘á»™ gáº§n báº£n cÅ©). CÃ³ thá»ƒ cáº¯t bá» khi offscreen Ä‘á»ƒ tiáº¿t kiá»‡m.
        if (hole.tick % PARTICLE_INTERVAL === 0) {
            if (!globalThis.camera || isCircleVisible(hole.x, hole.y, pullRadius, globalThis.camera)) {
                createVortexParticle(hole.x, hole.y, pullRadius);
            }
        }
    }
}

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€ helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function moveTowards(obj, target, spd) {
  const ang = Math.atan2(target.y - obj.y, target.x - obj.x);
  obj.x += Math.cos(ang) * spd;
  obj.y += Math.sin(ang) * spd;
}
// Pet nháº·t váº­t pháº©m
function collectLoot() {
  playSound('sfx-pickup', 0.5); // PhÃ¡t Ã¢m thanh nháº·t váº­t pháº©m
  const t = petRabbit.target; // 't' chÃ­nh lÃ  Ä‘á»‘i tÆ°á»£ng váº­t pháº©m mÃ  Pet nháº·t Ä‘Æ°á»£c
  switch (t.type) {
    case "lucky": luckyBuffEndTime = Date.now() + 45000; queuePetLootPopup("ğŸ€"); playSound('sfx-powerup', 0.8); break;
    case "power": powerBuffEndTime = Date.now() + 45000; queuePetLootPopup("ğŸ"); playSound('sfx-powerup', 0.8); break;
    case "crazy": crazyBuffEndTime = Date.now() + 45000; queuePetLootPopup("ğŸ‚"); playSound('sfx-powerup', 0.8); break;
    case "exp": expBuffEndTime = Date.now() + 45000; queuePetLootPopup("ğŸŒ¿"); playSound('sfx-powerup', 0.8); break;
    case "magnet": magnetBuffEndTime = Date.now() + 30000; queuePetLootPopup("ğŸ§²"); playSound('sfx-powerup', 0.8); break;
    case "crazymadnesstime": crazyMadnessTimeEndTime = Date.now() + 30000; queuePetLootPopup("ğŸ’¢");
    playSound('sfx-powerup', 0.8); break;
    case "potion":
        const baseHeal = getRandomInt(10, 20);
        const bonusHeal = Math.round((player.level + wave) * 1.5);
        const totalHeal = baseHeal + bonusHeal;
        player.hearts += totalHeal;
        createHealImpactEffect(player, totalHeal);
        queuePetLootPopup("ğŸ’Š");
        playSound('sfx-powerup', 0.8);
        break;
    case "secret": activateSecretItem(t); queuePetLootPopup("â“"); playSound('sfx-powerup', 0.8); break;
    case "expBonus": activateExpBonusItem(); queuePetLootPopup("ğŸŒŸ"); playSound('sfx-powerup', 0.8); break;
    case "coin": player.coins++; queuePetLootPopup("ğŸª™"); playSound('sfx-pickup-coin', 0.5); break;
    case "energy": player.energy++; queuePetLootPopup("âš¡"); break;
    case "mana": player.mana++; queuePetLootPopup("ğŸ’ "); break;
    case "hp": player.hearts++; queuePetLootPopup("â¤ï¸"); break;
    case "box": openItemBox(); break;
}
  t.active = false;
  petRabbit.target = null;
}

function giveUp() {
  lastGiveUpId   = petRabbit.target.id;   // ghi nhá»› id
  lastGiveUpTime = Date.now();
  petRabbit.target = null;
  showWarning("ğŸ° Ä‘á»«ng Ä‘i xa, quay vá»!");
}
// Cáº­p nháº­t ká»¹ nÄƒng Ä‘ao xoay
function updateBlades() {
    if (!swordActive) return;

    const now = Date.now();
    const MAX_SEEK_RADIUS = 450;
    const BLADE_FLY_SPEED = 4;
    const BLADE_LAUNCH_INTERVAL = 100;

    if (now - lastBladeLaunchTime > BLADE_LAUNCH_INTERVAL) {
        const bladeToLaunch = swords[nextBladeToAttack];
        if (bladeToLaunch && bladeToLaunch.state === 'orbiting') {
            const target = zombies.find(z => z.active && distance(player, z) < MAX_SEEK_RADIUS);
            if (target) {
                bladeToLaunch.state = 'seeking';
                bladeToLaunch.hitZombies.clear();
                bladeToLaunch.pierceCount = 0;
            }
        }
        nextBladeToAttack = (nextBladeToAttack + 1) % swords.length;
        lastBladeLaunchTime = now;
    }

    const formationAngle = (now / 1500);
    swords.forEach(s => {
        switch (s.state) {
            case 'orbiting':
                s.angle = s.homeAngle + formationAngle;
                s.x = player.x + Math.cos(s.angle) * s.orbitRadius;
                s.y = player.y + Math.sin(s.angle) * s.orbitRadius;
                
                zombies.forEach(z => {
                    if (z.active && distance(s, z) < 20 && (!z.bladeOrbitCooldown || now > z.bladeOrbitCooldown)) {
                        // Sá»¬A Lá»–I: LÃ m trÃ²n sÃ¡t thÆ°Æ¡ng khi Ä‘ao Ä‘ang xoay quanh
                        const orbitingDamage = Math.max(1, Math.round(skillUpgrades.bladeDamage));
                        dealDamageToZombie(z, orbitingDamage);
                        z.bladeOrbitCooldown = now + 100;
                    }
                });
                break;

            case 'seeking':
                let nearestTarget = null;
                let minDistance = Infinity;
                zombies.forEach(z => {
                    if (z.active && !s.hitZombies.has(z)) {
                        const d = distance(s, z);
                        if (d < minDistance) { minDistance = d; nearestTarget = z; }
                    }
                });
                if (nearestTarget) {
                    const angle = Math.atan2(nearestTarget.y - s.y, nearestTarget.x - s.x);
                    s.x += Math.cos(angle) * BLADE_FLY_SPEED;
                    s.y += Math.sin(angle) * BLADE_FLY_SPEED;
                }
                zombies.forEach(z => {
                    if (z.active && !s.hitZombies.has(z) && distance(s, z) < 20) {
                        const originalDamage = skillUpgrades.bladeDamage + playerUpgrades.damageBoost;
                        let finalDamage;

                        if (s.pierceCount === 0) {
                            // Sá»¬A Lá»–I: LÃ m trÃ²n sÃ¡t thÆ°Æ¡ng cho má»¥c tiÃªu Ä‘áº§u tiÃªn
                            finalDamage = Math.max(1, Math.round(originalDamage));
                        } else {
                            // DÃ²ng nÃ y Ä‘Ã£ lÃ m trÃ²n sáºµn cho cÃ¡c má»¥c tiÃªu phÃ­a sau
                            finalDamage = Math.max(1, Math.round(originalDamage * 0.5));
                        }

                        dealDamageToZombie(z, finalDamage);
                        
                        s.hitZombies.add(z);
                        s.pierceCount++;
                        const impactExplosion = getExplosion(z.x, z.y);
                        impactExplosion.life = 10;
                        explosions.push(impactExplosion);
                    }
                });
                if (s.pierceCount >= 5 || distance(s, player) > MAX_SEEK_RADIUS || !nearestTarget) {
                    s.state = 'returning';
                }
                break;

            case 'returning':
                const angleToPlayer = Math.atan2(player.y - s.y, player.x - s.x);
                s.x += Math.cos(angleToPlayer) * 10;
                s.y += Math.sin(angleToPlayer) * 10;
                if (distance(s, player) < s.orbitRadius) {
                    s.state = 'orbiting';
                }
                break;
        }
    });
}

// Danh sÃ¡ch loáº¡i tÃ i nguyÃªn: táº¡o 1 láº§n, tÃ¡i sá»­ dá»¥ng
const SUPPLY_RESOURCE_TYPES = ["coin", "hp", "mana", "energy"];

/** KÃ­ch hoáº¡t sá»± kiá»‡n: táº¡o 3â€“7 kiá»‡n ğŸª‚ rÆ¡i tá»« trÃªn xuá»‘ng */
function triggerSupplyDrop() {
  playSound("sfx-nuke-fall", 0.4);
  showWarning("HÃ ng tiáº¿p táº¿ Ä‘ang Ä‘áº¿n!");

  const dropCount = getRandomInt(3, 7);

  // Chá»‘t snapshot camera/mÃ n hÃ¬nh táº¡i thá»i Ä‘iá»ƒm spawn (giá»¯ Ä‘Ãºng cáº£m giÃ¡c cÅ©)
  const camX = camera.x, camY = camera.y;
  const viewW = canvas.width, viewH = canvas.height;

  for (let i = 0; i < dropCount; i++) {
    supplyDrops.push({
      // id: performance.now() + i, // tuá»³ chá»n náº¿u báº¡n muá»‘n debug
      x: camX + Math.random() * viewW,
      y: camY - 50,
      speedY: 1 + Math.random() * 0.5, // ~1..1.5 px/frame @60fps
      finalY: camY + viewH - (50 + Math.random() * 50), // â€œcháº¡m Ä‘áº¥tâ€ gáº§n Ä‘Ã¡y mÃ n hÃ¬nh
      active: true
    });
  }
}

/** Cáº­p nháº­t rÆ¡i cho cÃ¡c kiá»‡n hÃ ng (gá»i trong update() má»—i frame) */
// KhÃ´ng dÃ¹ng dt: tá»‘c Ä‘á»™ rÆ¡i tÃ­nh theo "má»—i frame" (~60fps)
// Giá»¯ nguyÃªn cáº£m giÃ¡c spawn & cháº¡m Ä‘áº¥t nhÆ° báº£n cÅ©
function updateSupplyDrops() {
  for (let i = supplyDrops.length - 1; i >= 0; i--) {
    const drop = supplyDrops[i];

    // Náº¿u cÃ³ flag inactive thÃ¬ xoÃ¡ nhanh (swap-remove)
    if (!drop.active) {
      const last = supplyDrops.pop();
      if (i < supplyDrops.length) supplyDrops[i] = last;
      continue;
    }

    // RÆ¡i má»—i frame (khÃ´ng scale theo thá»i gian)
    drop.y += drop.speedY; // speedY ~ 1..1.5 Ä‘Ã£ set lÃºc spawn

    // Cháº¡m "Ä‘áº¥t" (finalY chá»‘t táº¡i thá»i Ä‘iá»ƒm spawn)
    if (drop.y > drop.finalY) {
      playSound("sfx-supply-drop-item", 0.5);

      const resourceCount = getRandomInt(2, 10);
      for (let j = 0; j < resourceCount; j++) {
        const type = SUPPLY_RESOURCE_TYPES[(Math.random() * SUPPLY_RESOURCE_TYPES.length) | 0];
        const offsetX = (Math.random() - 0.5) * 60;
        const offsetY = (Math.random() - 0.5) * 60;
        items.push({
          x: drop.x + offsetX,
          y: drop.y + offsetY,
          type,
          active: true,
          bornAt: Date.now(),
        });
      }

      // XoÃ¡ pháº§n tá»­ Ä‘Ã£ hoÃ n táº¥t (swap-remove)
      drop.active = false;
      const last = supplyDrops.pop();
      if (i < supplyDrops.length) supplyDrops[i] = last;
    }
  }
}

/** Váº½ kiá»‡n hÃ ng â€“ cÃ³ culling Ä‘á»ƒ giáº£m overdraw */
function drawSupplyDrops() {
  ctx.font = "2rem serif";
  ctx.textAlign = "center";
  ctx.textBaseline = "middle";

  const left   = camera.x - 64;
  const right  = camera.x + canvas.width  + 64;
  const top    = camera.y - 64;
  const bottom = camera.y + canvas.height + 64;

  for (let i = 0; i < supplyDrops.length; i++) {
    const d = supplyDrops[i];
    if (d.x >= left && d.x <= right && d.y >= top && d.y <= bottom) {
      ctx.fillText("ğŸª‚", d.x, d.y);
    }
  }
}

//ğŸ”„ 8. Cáº­p nháº­t logic game (Main loop logic)

/* ---------- CÃC BIáº¾N CACHE UI NHáº¸ ---------- */
const __uiCache = {
  waveText: "",
  bladeText: "",
  swordText: "",
  fireText: "",
  iceText: "",
  petText: "",
  auraText: "",
};

/* ---------- TIá»†N ÃCH NHANH, KHÃ”NG RÃC ---------- */
function removeAtSwap(arr, i) { const n = arr.length - 1; if (i < 0 || i > n) return; if (i !== n) arr[i] = arr[n]; arr.pop(); }
function clamp(v, a, b) { return v < a ? a : v > b ? b : v; }
function d2(ax, ay, bx, by) { const dx = ax - bx, dy = ay - by; return dx*dx + dy*dy; }
function setTextOnce(el, txt, cacheKey) { if (!el) return; if (__uiCache[cacheKey] !== txt) { el.innerText = txt; __uiCache[cacheKey] = txt; } }
function nearestZombieInRange(srcx, srcy, maxR) {
  const maxR2 = maxR * maxR; let best = null, bestD2 = maxR2;
  for (let i = 0; i < zombies.length; i++) {
    const z = zombies[i]; if (!z.active) continue;
    const dz2 = d2(srcx, srcy, z.x, z.y);
    if (dz2 < bestD2) { bestD2 = dz2; best = z; }
  }
  return best;
}
/* Top-K nearby (K nhá», vÃ­ dá»¥ sá»‘ clone â‰¤ 5) â€” chÃ¨n tuyáº¿n tÃ­nh, khÃ´ng sort toÃ n cá»¥c */
function kNearestZombiesByPlayer(k, maxR) {
  const K = Math.max(0, k|0); if (K === 0) return [];
  const maxR2 = maxR > 0 ? maxR*maxR : Infinity;
  const idx = new Array(K).fill(-1), dist = new Array(K).fill(Infinity);
  for (let i = 0; i < zombies.length; i++) {
    const z = zombies[i]; if (!z.active) continue;
    const dz2 = d2(player.x, player.y, z.x, z.y);
    if (dz2 >= maxR2) continue;
    // chÃ¨n vÃ o máº£ng top-K (nhá»), dá»‹ch trÃ¡i
    let pos = K - 1; if (dz2 < dist[pos]) { dist[pos] = dz2; idx[pos] = i;
      while (pos > 0 && dist[pos] < dist[pos-1]) { // bubble trÃ¡i
        const td = dist[pos-1]; dist[pos-1] = dist[pos]; dist[pos] = td;
        const ti = idx[pos-1]; idx[pos-1] = idx[pos]; idx[pos] = ti; pos--;
      }
    }
  }
  const out = [];
  for (let j = 0; j < K; j++) if (idx[j] !== -1) out.push(zombies[idx[j]]);
  return out;
}

/* ========== 1) BUFF CORE (power/crazy/lucky/exp/magnet) + halo xoay ========== */
function sysUpdateBuffCore(now) {
  buffEffects.power.active  = now < powerBuffEndTime;
  buffEffects.crazy.active  = now < crazyBuffEndTime;
  buffEffects.lucky.active  = now < luckyBuffEndTime;
  buffEffects.exp.active    = now < expBuffEndTime;
  buffEffects.magnet.active = now < magnetBuffEndTime;
  buffEffects.crazymadness.active = now < crazyMadnessTimeEndTime;
  for (const k in buffEffects) { const b = buffEffects[k]; if (b && b.active) b.angle += 0.01; }
}

/* ========== 2) PLAYER LASERS (giáº£m life, remove O(1)) ========== */
function sysUpdatePlayerLasers() {
  for (let i = playerLasers.length - 1; i >= 0; i--) {
    const l = playerLasers[i]; l.life--; if (l.life <= 0) removeAtSwap(playerLasers, i);
  }
}

/* ========== 3) WAVE TIMER + BIG BOSS (UI + respawn) ========== */
function sysUpdateWaveAndBoss(now) {
  if (!lastWaveTime) return;
  const elWave = document.getElementById("waveTimerDisplay");
  const elapsed = (now - lastWaveTime) / 1000;
  let remaining = waveTime - elapsed; if (remaining < 0) remaining = 0;

  const min = (remaining / 60) | 0, sec = (remaining | 0) % 60, cs = Math.floor((remaining - (remaining | 0)) * 100);
  setTextOnce(elWave, `${min.toString().padStart(2,'0')}:${sec.toString().padStart(2,'0')}:${cs.toString().padStart(2,'0')}`, "waveText");

  if (remaining <= 0) {
    wave++; pendingWave = wave; if (typeof showUpgradePopup === "function") showUpgradePopup();
    if (wave === 5) { bigBossRespawnTimer = 0; lastBigBossTimerUpdate = performance.now(); }
    lastWaveTime = now; if (typeof updateWaveUI === "function") updateWaveUI();
  }

  // BigBoss UI + respawn (Ä‘áº¿m thá»±c)
  let hasBoss = false;
  for (let i = 0; i < zombies.length; i++) { const z = zombies[i]; if (z.active && z.isBigBoss) { hasBoss = true; break; } }
  const box = document.getElementById("bigBossRespawnDisplay"); if (box) box.style.display = "block";
  if (wave < 5) { if (box) setTextOnce(box, "BigBoss: wait..", "bossText"); return; }

  if (!lastBigBossTimerUpdate) lastBigBossTimerUpdate = performance.now();
  if (!hasBoss) {
    const nowp = performance.now(); const dt = (nowp - lastBigBossTimerUpdate) / 1000;
    if (dt > 0) bigBossRespawnTimer += dt; lastBigBossTimerUpdate = nowp;
    const remain = Math.max(0, Math.ceil(bigBossRespawnInterval - bigBossRespawnTimer));
    if (box) setTextOnce(box, remain > 0 ? `BigBoss: -${remain.toString().padStart(3,'0')}s-` : "BigBoss: READY", "bossText");
    if (bigBossRespawnTimer >= bigBossRespawnInterval && typeof spawnBigBoss === "function") { spawnBigBoss(); bigBossRespawnTimer = 0; }
  } else {
    if (box) setTextOnce(box, "BigBoss: living", "bossText");
    bigBossRespawnTimer = 0; lastBigBossTimerUpdate = performance.now();
  }
}

/* ========== 4) SWORD (ğŸ”ª) â€” vÃ²ng lÆ°á»¡i Ä‘ao auto 30s + updateBlades() ========== */
function skillUpdateBladesUIAndSpawn(now) {
  if (!swordActive) return;
  if (now >= swordEndTime) {
    swordActive = false; swords.length = 0;
    const btn = document.getElementById("bladeBtn");
    if (btn) { btn.classList.remove("active"); btn.innerText = "ğŸ”ª Äao"; }
    return;
  }
  // UI
  const remain = Math.ceil((swordEndTime - now) / 1000);
  const btn = document.getElementById("bladeBtn");
  if (btn) setTextOnce(btn, `ğŸ”ª ${remain}s`, "bladeText");

  // Spawn náº¿u chÆ°a cÃ³
  if (swords.length === 0) {
    const count = skillUpgrades.bladeCount|0; nextFireIndex = 0;
    for (let i = 0; i < count; i++) {
      const s = getSword(); s.angle = (2*Math.PI / count) * i; s.radius = 60;
      s.state = 'charging'; s.chargeFrame = 90; s.fireDelay = 20 + i * 10; s.fireOrder = i;
      swords.push(s);
    }
  }
  // vÃ²ng Ä‘iá»u khiá»ƒn lÆ°á»¡i Ä‘ao gá»‘c cá»§a báº¡n:
  if (typeof updateBlades === "function") updateBlades();
}

/* ========== 5) BLADE RAIN (âš”ï¸) â€” mÃ¢y tháº£ kiáº¿m cÃ³ má»¥c tiÃªu ========== */
function skillUpdateBladeRain(now) {
  if (!bladeActive) return;
  if (now >= bladeEndTime) {
    bladeActive = false; downwardSwords.length = 0; swordRainClouds.length = 0;
    const btn = document.getElementById("swordBtn"); if (btn) { btn.classList.remove("active"); btn.innerText = "âš”ï¸ Kiáº¿m"; }
    return;
  }
  // UI
  const btn = document.getElementById("swordBtn"); if (btn) setTextOnce(btn, `âš”ï¸ ${Math.ceil((bladeEndTime - now)/1000)}s`, "swordText");

  // MÃ¢y trÃ´i + tháº£ kiáº¿m (khÃ´ng forEach)
  const SWORD_DROP_INTERVAL = Math.max(100, 1200 - (skillUpgrades.swordLevel * 100));
  for (let i = 0; i < swordRainClouds.length; i++) {
    const c = swordRainClouds[i];
    // drift
    c.relativeX += c.driftSpeed;
    if (c.relativeX < 50 || c.relativeX > canvas.width - 50) c.driftSpeed *= -1;
    // drop
    if (now > c.nextDropTime) {
      downwardSwords.push({ x: camera.x + c.relativeX, y: camera.y + c.relativeY + 20, speed: 4 + skillUpgrades.swordLevel * 0.2, vx: (Math.random()-0.5)*2 });
      c.nextDropTime = now + SWORD_DROP_INTERVAL + Math.random()*200;
    }
  }
  // Kiáº¿m rÆ¡i
  for (let i = downwardSwords.length - 1; i >= 0; i--) {
    const s = downwardSwords[i]; s.y += s.speed; s.x += s.vx;
    if (s.y > camera.y + canvas.height + 30) { removeAtSwap(downwardSwords, i); continue; }
    for (let j = 0; j < zombies.length; j++) {
      const z = zombies[j]; if (!z.active) continue;
      if (d2(s.x, s.y, z.x, z.y) < 400) { // 20^2
        if (!z.swordCooldown || now > z.swordCooldown) {
          dealDamageToZombie(z, skillUpgrades.swordDamage + playerUpgrades.damageBoost);
          z.swordCooldown = now + 100;
        }
      }
    }
  }
}

/* ========== 6) PLAYER MOVE + CAMERA + TOUCH ========== */
function sysUpdateMovementAndCamera() {
  let mx = 0, my = 0;
  if (keys.w) my -= 1; if (keys.s) my += 1; if (keys.a) mx -= 1; if (keys.d) mx += 1;
  if (mx !== 0 || my !== 0) {
    const len = Math.hypot(mx, my); mx /= len; my /= len;
    let v = player.speed;
    if (disguiseActive) v *= 1.5;
    if (supportAuraActive) v *= 1.2;
    player.x += mx * v; player.y += my * v;
    player.x = clamp(player.x, wallThickness + player.size, worldWidth - wallThickness - player.size);
    player.y = clamp(player.y, wallThickness + player.size, worldHeight - wallThickness - player.size);
    camera.x = clamp(player.x - canvas.width/2, 0, worldWidth - canvas.width);
    camera.y = clamp(player.y - canvas.height/2, 0, worldHeight - canvas.height);
  }
  // touch
  if (touchStartX !== null && touchMoveX !== null) {
    let dx = touchMoveX - touchStartX, dy = touchMoveY - touchStartY;
    const len = Math.hypot(dx, dy);
    if (len > 10) { dx /= len; dy /= len; player.x += dx * player.speed; player.y += dy * player.speed; }
  }
}

/* ========== 7) Ká»¸ NÄ‚NG Lá»¬A/BÄ‚NG â€” orbit + tia phá»¥ (khÃ´ng filter/sort) ========== */
function skillUpdateFireIce(now) {
  // ğŸ”¥ Fire
  if (fireActive) {
    const fireBtn = document.getElementById("fireBtn");
    const rem = Math.ceil((fireEndTime - now)/1000);
    if (rem > 0) setTextOnce(fireBtn, `ğŸ”¥ ${rem}s`, "fireText");
    else {
      fireActive = false; for (let i = 0; i < fireballs.length; i++) releaseFireball(fireballs[i]);
      fireballs.length = 0; if (fireBtn) { fireBtn.innerText = "ğŸ”¥ Lá»­a"; fireBtn.classList.remove("active"); }
    }
  }
  for (let i = 0; i < fireballs.length; i++) {
    const f = fireballs[i]; f.angle += 0.05;
    f.x = player.x + Math.cos(f.angle) * f.radius; f.y = player.y + Math.sin(f.angle) * f.radius;
    if (!f.nextSparkTime) f.nextSparkTime = 0;
    if (now > f.nextSparkTime) {
      f.nextSparkTime = now + 1500;
      // nearest trong 200
      const t = nearestZombieInRange(f.x, f.y, 200);
      if (t) {
        const sparkDamage = Math.max(1, Math.round((skillUpgrades.fireDamage + playerUpgrades.damageBoost) * 0.5));
        particles.push({ type: 'fire_spark', x: f.x, y: f.y, target: t, speed: 2, damage: sparkDamage });
      }
    }
    // cháº¡m trá»±c tiáº¿p
    for (let j = 0; j < zombies.length; j++) {
      const z = zombies[j]; if (!z.active) continue;
      if (d2(f.x, f.y, z.x, z.y) < 25*25) {
        if (!z.fireCooldown || now > z.fireCooldown) {
          dealDamageToZombie(z, skillUpgrades.fireDamage + playerUpgrades.damageBoost);
          z.fireCooldown = now + 100; z.onFireUntil = now + 400; z.burnEndTime = now + 3000;
          z.state = "wandering"; z.wanderTime = now + 3000 + Math.random()*2000; z.wanderAngle = Math.random()*Math.PI*2;
        }
      }
    }
  }

  // â„ï¸ Ice
  if (iceActive) {
    const iceBtn = document.getElementById("iceBtn");
    const rem = Math.ceil((iceEndTime - now)/1000);
    if (rem > 0) setTextOnce(iceBtn, `â„ï¸ ${rem}s`, "iceText");
    else {
      iceActive = false; for (let i = 0; i < iceballs.length; i++) releaseIceball(iceballs[i]);
      iceballs.length = 0; if (iceBtn) { iceBtn.innerText = "â„ï¸ BÄƒng"; iceBtn.classList.remove("active"); }
    }
  }
  for (let i = 0; i < iceballs.length; i++) {
    const f = iceballs[i]; f.angle += 0.03;
    f.x = player.x + Math.cos(f.angle) * f.radius; f.y = player.y + Math.sin(f.angle) * f.radius;
    if (!f.nextShardTime) f.nextShardTime = 0;
    if (now > f.nextShardTime) {
      f.nextShardTime = now + 2000;
      const t = nearestZombieInRange(f.x, f.y, 250);
      if (t) {
        const shardDamage = Math.max(1, Math.round((skillUpgrades.iceDamage + playerUpgrades.damageBoost) * 0.5));
        particles.push({ type: 'ice_shard', x: f.x, y: f.y, target: t, speed: 2, damage: shardDamage });
      }
    }
    // cháº¡m trá»±c tiáº¿p
    for (let j = 0; j < zombies.length; j++) {
      const z = zombies[j]; if (!z.active) continue;
      if (d2(f.x, f.y, z.x, z.y) < 25*25) {
        if (!z.iceCooldown || now > z.iceCooldown) {
          dealDamageToZombie(z, skillUpgrades.iceDamage + playerUpgrades.damageBoost);
          z.iceCooldown = now + 100; z.onIceUntil = now + 400; z.slowEndTime = now + 3000;
          z.state = "wandering"; z.wanderTime = now + 3000 + Math.random()*2000; z.wanderAngle = Math.random()*Math.PI*2;
        }
      }
    }
  }
}

/* ========== 8) PET UI NHáº¸ ========== */
function sysUpdatePetUI(now) {
  if (!petActive) return;
  const rem = Math.ceil((petEndTime - now)/1000), btn = document.getElementById("PetBtn");
  if (rem > 0) setTextOnce(btn, `ğŸ° ${rem}s`, "petText");
  else if (btn) { btn.innerText = "ğŸ° Pet"; btn.classList.remove("active"); }
}

/* ========== 9) BULLETS (player/clone/fairy/pet) & ENEMY BULLETS ========== */
function sysUpdateBullets() {
  for (let i = 0; i < bullets.length; i++) {
    const b = bullets[i]; if (!b.active) continue;
    // quá»¹ Ä‘áº¡o
    if (b.curveMode) {
      b.curveRadius += 0.6; b.angle += b.curveSpeed * 0.5;
      b.x = player.x + Math.cos(b.angle) * b.curveRadius; b.y = player.y + Math.sin(b.angle) * b.curveRadius;
    } else if (b.zigzagMode) {
      b.travel += b.speed; const off = Math.sin(b.travel * b.oscillateSpeed + b.oscillatePhase) * b.oscillateAmplitude, ang = b.baseAngle;
      b.x = b.startX + Math.cos(ang)*b.travel - Math.sin(ang)*off; b.y = b.startY + Math.sin(ang)*b.travel + Math.cos(ang)*off;
    } else if (b.spiralForwardMode) {
      b.travel += b.speed; const ang = b.baseAngle;
      const cx = b.startX + Math.cos(ang)*b.travel, cy = b.startY + Math.sin(ang)*b.travel;
      const offAng = b.spiralPhase + b.travel*b.spiralSpeed;
      b.x = cx + Math.cos(offAng)*b.spiralRadius; b.y = cy + Math.sin(offAng)*b.spiralRadius;
    } else { b.x += b.dx * b.speed; b.y += b.dy * b.speed; }

    // va cháº¡m zombies
    for (let j = 0; j < zombies.length; j++) {
      const z = zombies[j]; if (!z.active) continue;
      if (d2(b.x, b.y, z.x, z.y) < 20*20) {
        if (b.isFairyBullet) { // fairy
          if (b.effect === 'sleep') { z.isSleeping = true; z.sleepUntil = Date.now() + 3000; }
          else if (b.effect === 'wandering') { z.state = 'wandering'; z.wanderTime = Date.now() + 3000; }
          z.isWeakened = true; z.weakenEndTime = Date.now() + 5000; for (let k = 0; k < 4; k++) createFairyHitParticle(z);
          releaseBullet(b); break;
        } else if (b.isPetBullet) { // pet
          dealDamageToZombie(z, b.customDmg); z.stunnedByThunder = true; z.stunnedThunderUntil = Date.now() + b.stunDuration; releaseBullet(b); break;
        } else { // player/clone bÃ¬nh thÆ°á»ng
          const dmg = (b.customDmg !== undefined) ? b.customDmg : (playerUpgrades.damageBoost || 1);
          dealDamageToZombie(z, dmg);
          if (!b.piercing) { releaseBullet(b); break; }
        }
      }
    }
        const buffer = 50; // ThÃªm má»™t khoáº£ng Ä‘á»‡m nhá»
    if (b.x < camera.x - buffer || 
        b.x > camera.x + canvas.width + buffer ||
        b.y < camera.y - buffer || 
        b.y > camera.y + canvas.height + buffer) 
    {
        releaseBullet(b); // "XÃ³a" viÃªn Ä‘áº¡n báº±ng cÃ¡ch tráº£ nÃ³ vá» kho
    }
  }
}
function sysUpdateEnemyBullets(now) {
  for (let i = 0; i < enemyBullets.length; i++) {
    const b = enemyBullets[i]; if (!b.active) continue;
    b.x += b.dx * b.speed; b.y += b.dy * b.speed;

    // trÃºng player
    if (d2(b.x, b.y, player.x, player.y) < 15*15) {
      if (player.shieldActive) {
        playSound('sfx-shield-block', 0.3);
        const ang = Math.atan2(b.y - player.y, b.x - player.x), R = 48;
        const ix = player.x + Math.cos(ang)*R, iy = player.y + Math.sin(ang)*R;
        createShieldImpactEffect(ix, iy);
        releaseEnemyBullet(b); continue;
      }
      if (player.hitTimer === 0) {
        let damage = b.damage || 1; if (supportAuraActive) damage *= 0.5;
        player.hearts -= damage; player.hitTimer = 30; createDamageImpactEffect(player, damage);
        if (player.hearts <= 0) handlePlayerDeath();
      }
      b.hit = true;
    }
    const oob = b.x < -50 || b.x > worldWidth + 50 || b.y < -50 || b.y > worldHeight + 50;
    if (b.hit || oob) releaseEnemyBullet(b);
  }
}

/* ========== 10) ZOMBIES CORE: tráº¡ng thÃ¡i, debuff, báº¯n tráº£, va cháº¡m player ========== */
function sysUpdateZombies(now) {
  for (let i = 0; i < zombies.length; i++) {
    const z = zombies[i]; if (!z.active) continue;
    // Tá»I Æ¯U: Náº¿u zombie á»Ÿ quÃ¡ xa ngÆ°á»i chÆ¡i, bá» qua viá»‡c cáº­p nháº­t logic cho nÃ³
    const activationRange = canvas.width; // Khoáº£ng cÃ¡ch zombie báº¯t Ä‘áº§u "thá»©c dáº­y"
    if (distance(player, z) > activationRange) {
        continue; // Bá» qua táº¥t cáº£ logic bÃªn dÆ°á»›i cho con zombie nÃ y
    }
    // burn tick má»—i giÃ¢y
    if (z.burnEndTime && now < z.burnEndTime) {
      if (!z.lastBurnTick || now - z.lastBurnTick > 1000) { z.lastBurnTick = now;
        const burnDmg = Math.max(1, Math.round((skillUpgrades.fireDamage + playerUpgrades.damageBoost) * 0.25));
        dealDamageToZombie(z, burnDmg);
      }
    } else if (z.burnEndTime) z.burnEndTime = null;

    // slow
    const slowed = z.slowEndTime && now < z.slowEndTime; if (z.slowEndTime && now >= z.slowEndTime) z.slowEndTime = null;

    // stun thunder
    if (z.stunnedByThunder && now < z.stunnedThunderUntil) continue; else if (z.stunnedByThunder && now >= z.stunnedThunderUntil) z.stunnedByThunder = false;

    // buff theo ngÃ y/Ä‘Ãªm
    if (isNight()) {
      if (!z.nightBuffApplied) { const bonus = (Math.random()*9|0) + 2; z.hp += bonus; z.baseHp += bonus; z.nightBuffApplied = true; }
    } else z.nightBuffApplied = false;

    if (currentDay > (z.lastDayBuffed || 0)) { const sb = Math.round(z.baseHp * 0.1); z.hp += sb; z.baseHp += sb; z.lastDayBuffed = currentDay; z.isBuffed = true; }

    // regen/trá»« mÃ¡u 30s
    if (!z.lastRegenTime || now - z.lastRegenTime > 30000) {
      if (isNight()) { z.hp += 1; z.baseHp += 1; z.lastRegenTime = now; }
      else if (wave > 2) { z.hp -= 1; z.baseHp -= 1; z.lastRegenTime = now; if (z.hp <= 0 && !z._killed) killZombie(z); }
    }

    // state
    if (z.state === "wandering") {
      if (now >= z.wanderTime) { z.state = "chasing"; z.speed = z.baseSpeed; z.nextStateCheck = now + 3000; }
      else if (z.wanderBehavior === "move") {
        let v = z.speed; if (slowed) v *= 0.5; z.x += Math.cos(z.wanderAngle) * v; z.y += Math.sin(z.wanderAngle) * v;
      }
    } else if (z.state === "chasing") {
      if (now >= (z.nextStateCheck || 0) && !z.isBoss) {
        z.behaviorCheckCounter = (z.behaviorCheckCounter || 0) + 1;
        if (z.behaviorCheckCounter >= 3) { z.showStatusIcon = Math.random() < 0.3; z.behaviorCheckCounter = 0; }
        if (Math.random() < 0.6) z.nextStateCheck = now + 3000;
        else {
          const pauseChance = isNight() ? 0.1 : 0.2;
          z.state = "wandering"; z.wanderTime = now + 1500 + Math.random()*8500; z.wanderAngle = Math.random()*Math.PI*2;
          z.speed = 0.15 + Math.random()*0.05; z.wanderBehavior = Math.random() < pauseChance ? "pause" : "move"; continue;
        }
      }
      const ang = Math.atan2(player.y - z.y, player.x - z.x);
      let v = z.speed; if (!isNight()) v *= 0.7; if (slowed) v *= 0.5;
      z.x += Math.cos(ang) * v; z.y += Math.sin(ang) * v;
    }

    // báº¯n tráº£
    if (z.isBoss || z.type === "miniBoss") {
      if (!z.lastShoot) z.lastShoot = 0; if (now - z.lastShoot >= 8000) { z.lastShoot = now; shootEnemyBullet(z, 2, 0.8); }
    } else {
      if (!z.lastShoot) z.lastShoot = 0; if (now - z.lastShoot >= 60000) { z.lastShoot = now; shootEnemyBullet(z, 1 + Math.random()*0.5, 0.001); }
    }

    // va cháº¡m player
    if (d2(z.x, z.y, player.x, player.y) < (z.radius + player.size) ** 2) {
      if (player.shieldActive) {
        const R = 48, repel = R + z.radius; const dist = Math.sqrt(d2(z.x, z.y, player.x, player.y));
        if (dist < repel) {
          const now2 = now; if (!window.lastShieldBlockSoundTime || now2 - lastShieldBlockSoundTime > 100) { playSound('sfx-shield-block', 0.3); window.lastShieldBlockSoundTime = now2; }
          const ang = Math.atan2(z.y - player.y, z.x - player.x), push = (repel - dist) + 20;
          z.x += Math.cos(ang)*push; z.y += Math.sin(ang)*push; continue;
        }
      }
      const dist = Math.sqrt(d2(z.x, z.y, player.x, player.y));
      if (dist < z.radius + player.size) {
        // Bá»” SUNG KIá»‚M TRA Báº¤T Tá»¬ Cá»¦A PLAYER Táº I ÄÃ‚Y
        if (player.hitTimer === 0 && z.canHit) { 
          let dmg = calculateZombieDamage(z); 
          if (supportAuraActive) dmg *= 0.5;
          
          player.hearts -= dmg; 
          player.hitTimer = 30; // <-- QUAN TRá»ŒNG: KÃ­ch hoáº¡t láº¡i báº¥t tá»­ 0.5s sau va cháº¡m
          createDamageImpactEffect(player, dmg); 
          z.canHit = false; 
          setTimeout(() => { z.canHit = true; }, 500);
          
          if (player.hearts <= 0) handlePlayerDeath();
        }
        
        // Logic Ä‘áº©y lÃ¹i giá»¯ nguyÃªn
        const ang = Math.atan2(z.y - player.y, z.x - player.x), push = (z.radius + player.size - dist) + 1;
        z.x += Math.cos(ang)*push; z.y += Math.sin(ang)*push;
      }
    }

    // clamp map
    z.x = clamp(z.x, wallThickness + z.radius, worldWidth  - wallThickness - z.radius);
    z.y = clamp(z.y, wallThickness + z.radius, worldHeight - wallThickness - z.radius);
  }
}

/* ========== 11) ITEMS PICKUP + MAGNET + LEVEL-UP ========== */
function sysPickupItemsAndLevel(now) {
  // Magnet: hÃºt item (trá»« buff types)
  if (now < magnetBuffEndTime) {
    const R = 200, typesBlock = ['lucky','power','crazy','exp','magnet','secret','expBonus', 'crazymadnesstime'];
    for (let i = 0; i < items.length; i++) {
      const it = items[i]; if (!it.active) continue;
      let skip = false; for (let k = 0; k < typesBlock.length; k++) if (it.type === typesBlock[k]) { skip = true; break; }
      if (skip) continue;
      if (d2(player.x, player.y, it.x, it.y) < R*R) {
        const ang = Math.atan2(player.y - it.y, player.x - it.x); it.x += Math.cos(ang)*5; it.y += Math.sin(ang)*5;
      }
    }
  }
  // Pickup
  for (let i = 0; i < items.length; i++) {
    const it = items[i]; if (!it.active) continue;
    if (d2(it.x, it.y, player.x, player.y) < 20*20) {
      playSound('sfx-pickup', 0.5);
      switch (it.type) {
        case 'lucky':  luckyBuffEndTime  = now + 45000; playSound('sfx-powerup',0.8); break;
        case 'power':  powerBuffEndTime  = now + 45000; playSound('sfx-powerup',0.8); break;
        case 'crazy':  crazyBuffEndTime  = now + 45000; playSound('sfx-powerup',0.8); break;
        case 'exp':    expBuffEndTime    = now + 45000; playSound('sfx-powerup',0.8); break;
        case 'magnet': magnetBuffEndTime = now + 30000; playSound('sfx-powerup',0.8); break;
        case 'crazymadnesstime': crazyMadnessTimeEndTime = now + 30000; playSound('sfx-powerup',0.8); break;
        case 'secret': activateSecretItem(it); playSound('sfx-powerup',0.8); break;
        case 'expBonus': activateExpBonusItem(); playSound('sfx-powerup',0.8); break;
        case 'coin':   player.coins += 1;  queuePlayerLootPopup("ğŸª™"); break;
        case 'energy': player.energy += 1; queuePlayerLootPopup("âš¡"); break;
        case 'mana':   player.mana += 1;   queuePlayerLootPopup("ğŸ’ "); break;
        case 'hp':     player.hearts += 1; createHealImpactEffect(player, 1); queuePlayerLootPopup("â¤ï¸"); break;
        case 'potion': {
          const baseHeal = (Math.random()*11|0) + 10, bonus = Math.round((player.level + wave) * 1.5), total = baseHeal + bonus;
          player.hearts += total; createHealImpactEffect(player, total); showWarning(`ğŸ’Š +${total} HP`);
        } break;
        case 'box': openItemBox(); break;
      }
      it.active = false;
    }
  }

  // Level up: while xá»­ lÃ½ lÃªn nhiá»u cáº¥p
  while (player.currentLevelExp >= player.requiredExp) {
    const leftover = player.currentLevelExp - player.requiredExp;
    playSound('sfx-level-up'); player.level++;
    player.hearts += 1 + (UPGRADE_TIERS.hpBoost[playerUpgrades.hpBoost] || 0);
    player.energy += 10; player.mana += 10; playerUpgrades.damageBoost += 0.5; showWarning("+0.5 ğŸ’¥");

    const popup = document.getElementById("levelUpPopup");
    if (popup) { popup.style.animation = "none"; void popup.offsetWidth; popup.style.display = "block"; setTimeout(()=>{ popup.style.display="none"; }, 1200); }
    levelUpGlowTime = 60; if (typeof showSkillLevelUpPopup === "function") showSkillLevelUpPopup();
    if (player.level % 1 === 0 && typeof spawnBoss === "function") spawnBoss();

    player.currentLevelExp = leftover; player.requiredExp = calculateRequiredExp(player.level);
  }
}

/* ========== 12) EXPLOSIONS / EXPANDING / EXTRA SHOCKWAVES ========== */
function sysUpdateExplosionsAndShockwaves() {
  for (let i = 0; i < explosions.length; i++) {
    const e = explosions[i]; if (!e.active) continue;
    e.radius += 2; e.life--; if (e.life <= 0) releaseExplosion(e);
  }
  for (let i = expandingExplosions.length - 1; i >= 0; i--) {
    const exp = expandingExplosions[i]; const prevR = exp.radius;
    exp.radius += exp.maxRadius / exp.duration; exp.duration--;
    for (let j = 0; j < zombies.length; j++) {
      const z = zombies[j]; if (!z.active) continue;
      const dist = Math.sqrt(d2(exp.x, exp.y, z.x, z.y));
      if (dist >= prevR && dist < exp.radius && !exp.hitSet.has(z)) { dealDamageToZombie(z, exp.damage); exp.hitSet.add(z); }
    }
    if (exp.duration <= 0) removeAtSwap(expandingExplosions, i);
  }
  for (let i = extraShockwaves.length - 1; i >= 0; i--) {
    const sw = extraShockwaves[i]; sw.radius += 8; sw.alpha -= 0.012; if (sw.alpha <= 0) removeAtSwap(extraShockwaves, i);
  }
}

/* ========== 13) SATELLITES (laze xuyÃªn â€” nearest Æ°u tiÃªn) ========== */
function skillUpdateSatellites(now) {
  if (!satelliteActive) return;
  if (now >= satelliteEndTime) { satelliteActive = false; satellites.length = 0; return; }

  for (let i = 0; i < satellites.length; i++) {
    const sat = satellites[i];
    sat.angle += sat.orbitSpeed; sat.x = player.x + Math.cos(sat.angle)*sat.orbitRadius; sat.y = player.y + Math.sin(sat.angle)*sat.orbitRadius;
    if (!sat.laserCooldown) sat.laserCooldown = now;

    if (now >= sat.laserCooldown) {
      // nearest trong 500
      const t = nearestZombieInRange(sat.x, sat.y, 500);
      if (t) {
        playSound('sfx-laser', 0.5); sat.laserCooldown = now + 2000;
        sat.laserBeam = { angle: Math.atan2(t.y - sat.y, t.x - sat.x), life: 60, hitZombiesThisShot: new Set() };
      }
    }
    if (sat.laserBeam && sat.laserBeam.life > 0) {
      sat.laserBeam.life--;
      const x1 = sat.x, y1 = sat.y, ang = sat.laserBeam.angle, dx = Math.cos(ang), dy = Math.sin(ang);
      const sk = (function(){ for (let s=0; s<activeSkills.length; s++) { const a=activeSkills[s]; if (a && a.name==="Vá»‡ tinh laze") return a; } return null; })();
      const baseDmg = (sk && sk.baseDamage) || 5;

      // QuÃ©t táº¥t cáº£ má»¥c tiÃªu trÃªn tia (khÃ´ng sort): tÃ¬m first (gáº§n nháº¥t) + gÃ¢y dmg cho táº¥t cáº£
      let first = null, firstD2 = Infinity;
      const hitList = [];
      for (let j = 0; j < zombies.length; j++) {
        const z = zombies[j]; if (!z.active) continue;
        const proj = (z.x - x1)*dx + (z.y - y1)*dy; if (proj <= 0 || proj >= 500) continue;
        const perp = Math.abs((z.x - x1)*dy - (z.y - y1)*dx); if (perp >= 20) continue;
        hitList.push(z);
        const dz2 = d2(sat.x, sat.y, z.x, z.y);
        if (dz2 < firstD2) { firstD2 = dz2; first = z; }
      }
      if (hitList.length) {
        for (let j = 0; j < hitList.length; j++) {
          const z = hitList[j]; if (sat.laserBeam.hitZombiesThisShot.has(z)) continue;
          const dmg = (z === first) ? baseDmg : Math.max(1, Math.round(baseDmg * 0.5));
          dealDamageToZombie(z, dmg); sat.laserBeam.hitZombiesThisShot.add(z);
        }
      }
      if (sat.laserBeam.life <= 0) sat.laserBeam = null;
    }
  }
}

/* ========== 14) LIGHTNING â€” mÃ¢y vÃ²ng cung + strike ========== */
function skillUpdateLightning(now) {
  if (!lightningActive) return;
  const bobY = Math.sin(frame * 0.05) * 4;
  const n = lightningBolts.length, R = 80, spread = Math.PI * 0.7;

  for (let i = 0; i < n; i++) {
    const bolt = lightningBolts[i];
    let ang = -Math.PI/2; if (n > 1) { const start = -Math.PI/2 - spread/2, step = spread / (n-1); ang = start + i * step; }
    bolt.x = player.x + Math.cos(ang)*R; bolt.y = player.y + Math.sin(ang)*R + bobY;
    if (!bolt.nextZapTime) bolt.nextZapTime = 0;

    if (now > bolt.nextZapTime) {
      // nearest trong 240
      const t = nearestZombieInRange(bolt.x, bolt.y, 240);
      if (t) {
        dealDamageToZombie(t, bolt.damage / 2);
        activeLightningStrikes.push({ path: getZigZag(bolt, t, 4), life: 60, type: 'chain' });
        bolt.nextZapTime = now + 1000 + Math.random()*500;
      }
    }
  }

  // strike lá»›n: chá»n 1 zombie nhÃ¬n tháº¥y báº±ng reservoir sampling
  if (now > nextLightningStrikeTime) {
    let count = 0, target = null;
    for (let i = 0; i < zombies.length; i++) {
      const z = zombies[i]; if (!z.active) continue;
      if (z.x > camera.x && z.x < camera.x + canvas.width && z.y > camera.y && z.y < camera.y + canvas.height) {
        count++; if (Math.random() < (1 / count)) target = z; // reservoir
      }
    }
    if (target) {
      const start = { x: target.x, y: camera.y - 20 }, end = { x: target.x, y: target.y };
      activeLightningStrikes.push({ path: getZigZag(start, end, 8), life: 60 });
      if (lightningBolts.length) dealDamageToZombie(target, lightningBolts[0].damage);
      explosions.push(getExplosion(target.x, target.y));
    }
    const baseInterval = 800 / Math.max(1, lightningBolts.length); const rand = (Math.random()-0.5)*400;
    nextLightningStrikeTime = now + Math.max(100, baseInterval + rand);
  }
  // giáº£m life & dá»n tia
  for (let i = activeLightningStrikes.length - 1; i >= 0; i--) { const s = activeLightningStrikes[i]; s.life--; if (s.life <= 0) removeAtSwap(activeLightningStrikes, i); }
}

/* ========== 15) CLONES â€” nháº¯m K má»¥c tiÃªu gáº§n PLAYER (khÃ´ng sort) ========== */
function skillUpdateClones(now) {
  if (!clonesActive) return;
  if (now >= clonesEndTime) { clonesActive = false; clones.length = 0; return; }

  // Chá»n K má»¥c tiÃªu gáº§n ngÆ°á»i chÆ¡i
  const targets = kNearestZombiesByPlayer(clones.length, 600);

  for (let i = 0; i < clones.length; i++) {
    const c = clones[i]; const t = targets[i] || null;
    if (t) {
      const ang = Math.atan2(t.y - c.y, t.x - c.x), dist = Math.sqrt(d2(c.x, c.y, t.x, t.y));
      if (dist > 250) { c.x += Math.cos(ang)*c.moveSpeed; c.y += Math.sin(ang)*c.moveSpeed; }
      if (!c.lastShot) c.lastShot = 0; if (!c.shotCount) c.shotCount = 0;
      if (now - c.lastShot >= 1000) {
        c.lastShot = now; c.shotCount++;
        if (c.shotCount >= 3) {
          c.shotCount = 0; playSound('sfx-laser', 0.5);
          activeCloneLasers.push({ cloneId: c.id, endX: t.x, endY: t.y, life: 60 });
          dealDamageToZombie(t, c.baseDamage * 3);
        } else {
          const b = getBullet(); b.x = c.x; b.y = c.y; b.dx = Math.cos(ang); b.dy = Math.sin(ang); b.speed = 3; b.active = true; b.customDmg = c.baseDamage; b.color = "#ff66ff";
          bullets.push(b);
        }
      }
    } else {
      const dist = Math.sqrt(d2(c.x, c.y, player.x, player.y));
      if (dist > 150) { const angBack = Math.atan2(player.y - c.y, player.x - c.x); c.x += Math.cos(angBack)*c.moveSpeed; c.y += Math.sin(angBack)*c.moveSpeed; }
    }
    c.x = clamp(c.x, wallThickness, worldWidth - wallThickness); c.y = clamp(c.y, wallThickness, worldHeight - wallThickness);
  }

  for (let i = activeCloneLasers.length - 1; i >= 0; i--) { const L = activeCloneLasers[i]; L.life--; if (L.life <= 0) removeAtSwap(activeCloneLasers, i); }
}

/* ========== 16) BLOOD ORB (ğŸ©¸) ========== */
function skillUpdateBloodOrb(now) {
  if (!bloodOrbActive) return;
  if (now > bloodOrbEndTime) { bloodOrbActive = false; bloodOrbs.length = 0; return; }
  for (let i = 0; i < bloodOrbs.length; i++) {
    const o = bloodOrbs[i]; o.angle += 0.01; o.x = player.x + Math.cos(o.angle)*o.radius; o.y = player.y + Math.sin(o.angle)*o.radius;
    // nearest 300
    let best = null, bestD2 = 300*300;
    for (let j = 0; j < zombies.length; j++) { const z = zombies[j]; if (!z.active) continue; const dz2 = d2(o.x, o.y, z.x, z.y); if (dz2 < bestD2) { bestD2 = dz2; best = z; } }
    if (best !== o.target) { o.target = best; o.lockTime = now; }
    if (!o.target) continue;
    if ((now - (o.lockTime||0)) > 400 && (now - (window.bloodOrbLastDrain||0)) > 300) {
      window.bloodOrbLastDrain = now;
      let sk = null; for (let s=0; s<activeSkills.length; s++){const a=activeSkills[s]; if (a && a.name==="Quáº£ cáº§u háº¥p huyáº¿t"){sk=a;break;}}
      dealDamageToZombie(o.target, (sk && sk.baseDamage) || 1); player.hearts++; createHealImpactEffect(player, 1);
      for (let k = 0; k < 2; k++) createBloodOrbParticle(o);
      for (let k = 0; k < 2; k++) createBloodOrbParticleOnBeam(o);
    }
  }
}

/* ========== 17) THUNDER (ğŸ”µ) ========== */
function skillUpdateThunder(now) {
  if (!thunderActive) return;
  const btn = document.getElementById("thunderBtn"); const rem = Math.ceil((thunderEndTime - now)/1000);
  if (rem > 0) { if (btn) btn.innerText = `ğŸ”µ ${rem}s`; } else { thunderActive = false; thunderBalls.length = 0; if (btn){ btn.innerText="ğŸ”µ LÃ´i"; btn.classList.remove("active"); } return; }

  for (let i = 0; i < thunderBalls.length; i++) {
    const ball = thunderBalls[i];
    ball.angle += 0.02; ball.x = player.x + Math.cos(ball.angle)*ball.radius; ball.y = player.y + Math.sin(ball.angle)*ball.radius;
    for (let j = 0; j < zombies.length; j++) {
      const z = zombies[j]; if (!z.active) continue;
      if (d2(ball.x, ball.y, z.x, z.y) < 40*40) {
        if (!z.thunderCooldown || now > z.thunderCooldown) {
          dealDamageToZombie(z, skillUpgrades.thunderDamage + playerUpgrades.damageBoost);
          z.stunnedByThunder = true; z.stunnedThunderUntil = now + 800; z.thunderCooldown = now + 100;
          const ang = Math.atan2(z.y - player.y, z.x - player.x), push = 16; z.x += Math.cos(ang)*push; z.y += Math.sin(ang)*push;
        }
      }
    }
    if (!ball.nextZapTime) ball.nextZapTime = 0;
    if (now > ball.nextZapTime) {
      const t = nearestZombieInRange(ball.x, ball.y, 250);
      if (t) {
        dealDamageToZombie(t, (skillUpgrades.thunderDamage + playerUpgrades.damageBoost) / 2);
        t.stunnedByThunder = true; t.stunnedThunderUntil = now + 800;
        activeLightningStrikes.push({ path: getZigZag(ball, t, 4), life: 30, type: 'chain' });
        ball.nextZapTime = now + 2000;
      }
    }
  }
  // dá»n tia sÃ©t
  for (let i = activeLightningStrikes.length - 1; i >= 0; i--) { const s = activeLightningStrikes[i]; s.life--; if (s.life <= 0) removeAtSwap(activeLightningStrikes, i); }
}

/* ========== 18) SUPPORT AURA (âœ¨ Heal) ========== */
function skillUpdateSupportAura(now) {
  const btn = document.getElementById("supportAuraBtn");
  if (supportAuraActive) {
    if (now > supportAuraEndTime) {
      supportAuraActive = false; auraCrackLines.length = 0; auraLightBeams.length = 0; if (btn) btn.classList.remove("active");
    } else {
      if (!window.lastAuraHealTime) window.lastAuraHealTime = 0;
      if (now - lastAuraHealTime > 3000) {
        lastAuraHealTime = now;
        const totalHeal = Math.min(1 + skillUpgrades.auraHealLevel, 5);
        player.hearts += totalHeal; createHealImpactEffect(player, totalHeal);
      }
      // háº¡t + cá»™t sÃ¡ng nháº¹, throttle theo frame
      if (frame % 15 === 0) {
        const ax = (player.x - 50) + Math.random()*100;
        particles.push({ x: ax, y: player.y + player.size - 5, type:'aura_particle', vx:(Math.random()-0.5)*0.1, vy:-0.5 - Math.random()*0.5, size:0.5+Math.random()*0.5, color:'rgba(255,215,0,0.8)', alpha:1, alphaDecay:0.005 });
      }
      if (frame % 20 === 0) { const bx = (player.x - 50) + Math.random()*100; auraLightBeams.push({ x: bx, width: 0.5 + Math.random(), alpha: 0, life: 60, initialLife: 60 }); }
      const rem = Math.ceil((supportAuraEndTime - now)/1000); if (btn) setTextOnce(btn, `âœ¨ ${rem}s`, "auraText");
    }
  } else if (btn && btn.innerText !== "âœ¨ Heal") btn.innerText = "âœ¨ Heal";

  for (let i = auraLightBeams.length - 1; i >= 0; i--) {
    const b = auraLightBeams[i]; b.life--; b.alpha = Math.sin((1 - b.life / b.initialLife) * Math.PI); if (b.life <= 0) removeAtSwap(auraLightBeams, i);
  }
}

/* ========== 19) SPACE GATE (3-phase) â€” náº¿u Ä‘ang dÃ¹ng cá»•ng kiá»ƒu khÃ¡c, giá»¯ nguyÃªn ========== */
function sysUpdateSpaceGate(now) {
  // Náº¿u báº¡n Ä‘ang dÃ¹ng há»‡ thá»‘ng cá»•ng trong mÃ£ hiá»‡n táº¡i (player.isTeleporting / isGrowingAfterTeleport / spaceGateActive)
  // thÃ¬ khá»‘i dÆ°á»›i Ä‘Ã¢y giá»¯ nguyÃªn hÃ nh vi Ä‘Ã³, chá»‰ gom & comment láº¡i Ä‘á»ƒ Ä‘á»c dá»… hÆ¡n, khÃ´ng cáº¥p phÃ¡t.
  if (player.isTeleporting) {
    player.size *= 0.92; if (spaceGate) spaceGate.radius *= 0.92;
    if (player.size < 1) {
      player.isTeleporting = false; player.isGrowingAfterTeleport = true;
      const t = findSafeTeleportLocation(); player.x = t.x; player.y = t.y; lastTeleportTime = now;
      camera.x = clamp(player.x - canvas.width/2, 0, worldWidth - canvas.width);
      camera.y = clamp(player.y - canvas.height/2, 0, worldHeight - canvas.height);
      if (now < spaceGateEndTime) createNewGate(player.x, player.y); else { spaceGateActive = false; spaceGate = null; }
    }
  } else if (player.isGrowingAfterTeleport) {
    player.size += (player.originalSize - player.size) * 0.1;
    if (player.originalSize - player.size < 0.1) {
      player.size = player.originalSize; player.isGrowingAfterTeleport = false;
      const ang = Math.random() * Math.PI * 2; player.x += Math.cos(ang)*40; player.y += Math.sin(ang)*40;
    }
  } else if (spaceGateActive && spaceGate) {
    if (now > spaceGateEndTime) { spaceGateActive = false; spaceGate = null; }
    else {
      if (spaceGate.alpha < 1) spaceGate.alpha += 0.05; spaceGate.rotation += 0.04;
      if (frame % 3 === 0) {
        createGateOrbitParticle(spaceGate);
        const PR = 80, KR = 25, PS = 1.8, PR2 = PR*PR, KR2 = KR*KR, BPS = PS*2.5;
        for (let i = 0; i < zombies.length; i++) { const z = zombies[i]; if (!z.active) continue;
          const dz2 = d2(spaceGate.x, spaceGate.y, z.x, z.y);
          if (dz2 < PR2) {
            const ang = Math.atan2(spaceGate.y - z.y, spaceGate.x - z.x); z.x += Math.cos(ang)*PS; z.y += Math.sin(ang)*PS;
            if (!z.gateDamageCooldown || now > z.gateDamageCooldown) { dealDamageToZombie(z, spaceGate.damage); z.gateDamageCooldown = now + 500; }
          }
          if (dz2 < KR2) { killZombie(z); explosions.push(getExplosion(z.x, z.y)); }
        }
        for (let i = 0; i < enemyBullets.length; i++) { const b = enemyBullets[i]; if (!b.active) continue;
          const db2 = d2(spaceGate.x, spaceGate.y, b.x, b.y);
          if (db2 < PR2) { const ang = Math.atan2(spaceGate.y - b.y, spaceGate.x - b.x); b.x += Math.cos(ang)*BPS; b.y += Math.sin(ang)*BPS; if (db2 < KR2) { releaseEnemyBullet(b); explosions.push(getExplosion(b.x, b.y)); } }
        }
      }
      const canUse = now > lastTeleportTime + GATE_COOLDOWN;
      if (canUse && d2(player.x, player.y, spaceGate.x, spaceGate.y) < spaceGate.radius * spaceGate.radius) { player.originalSize = player.size; player.isTeleporting = true; }
    }
  }
}

/* ========== 20) FAIRY (ğŸ¦‹) ========== */
function skillUpdateFairy(now) {
  if (!fairyActive) return;
  const btn = document.getElementById("fairyBtn");
  if (now > fairyEndTime) {
    fairyActive = false; fairies.length = 0; playerUpgrades.damageBoost -= fairyDamageBonus; fairyDamageBonus = 0;
    if (btn) { btn.classList.remove("active"); btn.innerText = "ğŸ¦‹ Fairy"; }
    return;
  }
  if (btn) { btn.classList.add("active"); btn.innerText = `ğŸ¦‹ ${Math.ceil((fairyEndTime - now)/1000)}s`; }

  // buff heal/damage theo ngÃ y/Ä‘Ãªm
  let healAmt = isNight() ? (2 + skillUpgrades.fairyHealLevel*2) : (1 + skillUpgrades.fairyHealLevel*1);
  let dmgAmt  = isNight() ? (1 + skillUpgrades.fairyDamageLevel*0.5) : (2 + skillUpgrades.fairyDamageLevel);
  healAmt = Math.min(healAmt, isNight() ? 10 : 5);

  playerUpgrades.damageBoost -= fairyDamageBonus;
  fairyDamageBonus = dmgAmt * skillUpgrades.fairyCount;
  playerUpgrades.damageBoost += fairyDamageBonus;

  if (!window.lastFairyHealTime) window.lastFairyHealTime = 0;
  if (now - lastFairyHealTime > 3000) {
    const totalHeal = healAmt * skillUpgrades.fairyCount; player.hearts += totalHeal; lastFairyHealTime = now;
    if (totalHeal > 0) createHealImpactEffect(player, totalHeal);
  }

  for (let i = 0; i < fairies.length; i++) {
    const f = fairies[i]; f.angle += 0.02; const bob = Math.sin(frame*0.05 + f.bobOffset)*5;
    f.x = player.x + Math.cos(f.angle)*f.orbitRadius; f.y = player.y + Math.sin(f.angle)*f.orbitRadius + bob;
    if (frame % 5 === 0) createFairyParticle(f.x, f.y);

    if (!f.nextAttackTime) f.nextAttackTime = 0;
    if (now > f.nextAttackTime) {
      f.nextAttackTime = now + 1000;
      let nearest = null, bestD2 = 600*600;
      for (let j = 0; j < zombies.length; j++) {
        const z = zombies[j]; if (!z.active || z.isSleeping) continue;
        const dz2 = d2(f.x, f.y, z.x, z.y); if (dz2 < bestD2) { bestD2 = dz2; nearest = z; }
      }
      if (nearest) {
        const b = getBullet(); const ang = Math.atan2(nearest.y - f.y, nearest.x - f.x);
        b.x = f.x; b.y = f.y; b.dx = Math.cos(ang); b.dy = Math.sin(ang); b.speed = 2; b.isFairyBullet = true; b.piercing = false; b.effect = isNight() ? 'sleep' : 'wandering';
        bullets.push(b);
      }
    }
  }
}

/* ========== 21) Cáº¬P NHáº¬T BUFF CHIáº¾N Äáº¤U (Cá»™ng dá»“n hiá»‡u á»©ng) ========== */
function sysUpdateCombatBuffs(now) {
    // --- Xá»­ lÃ½ buff ğŸ’¢ CrazyMadnessTime (chá»‰ cÃ¡c chá»‰ sá»‘ cá»‘ Ä‘á»‹nh) ---
    const wasCrazyMadness = isCrazyMadnessTimeActive;
    isCrazyMadnessTimeActive = now < crazyMadnessTimeEndTime;

    if (isCrazyMadnessTimeActive && !wasCrazyMadness) {
        // KÃ­ch hoáº¡t buff: TÄƒng tá»‘c Ä‘á»™ cháº¡y x2
        const speedBonus = player.speed; // Tá»‘c Ä‘á»™ cháº¡y hiá»‡n táº¡i = 100% -> nhÃ¢n Ä‘Ã´i lÃ  cá»™ng thÃªm chÃ­nh nÃ³
        
        crazyMadnessTimeBuffStats = {
            speed: speedBonus,
        };
        player.speed += crazyMadnessTimeBuffStats.speed;
        updateStatsOverlay();

    } else if (!isCrazyMadnessTimeActive && wasCrazyMadness) {
        // Há»§y kÃ­ch hoáº¡t buff
        player.speed -= crazyMadnessTimeBuffStats.speed;
        crazyMadnessTimeBuffStats = {};
        updateStatsOverlay();
    }

    // --- Xá»­ lÃ½ buff ğŸ Power (hoáº¡t Ä‘á»™ng Ä‘á»™c láº­p) ---
    const wasPower = isPowerBuffActive;
    isPowerBuffActive = now < powerBuffEndTime;
    if (isPowerBuffActive && !wasPower) {
        powerBuffDamageBonus = (playerUpgrades.damageBoost * 1.5) + 2;
        playerUpgrades.damageBoost += powerBuffDamageBonus;
        updateStatsOverlay();
    } else if (!isPowerBuffActive && wasPower) {
        playerUpgrades.damageBoost -= powerBuffDamageBonus;
        powerBuffDamageBonus = 0;
        updateStatsOverlay();
    }

    // --- Xá»­ lÃ½ buff ğŸ‚ Crazy (hoáº¡t Ä‘á»™ng Ä‘á»™c láº­p) ---
    const wasCrazy = isCrazyBuffActive;
    isCrazyBuffActive = now < crazyBuffEndTime;
    if (isCrazyBuffActive && !wasCrazy) {
        const crazyD = (playerUpgrades.damageBoost * 0.5) + 1;
        crazyBuffStats = { speed: 1, bulletSpeed: 1, damage: crazyD, lineBulletCount: 1, fireRate: 10 };
        player.speed += crazyBuffStats.speed;
        playerUpgrades.bulletSpeed += crazyBuffStats.bulletSpeed;
        playerUpgrades.damageBoost += crazyBuffStats.damage;
        playerUpgrades.lineBulletCount += crazyBuffStats.lineBulletCount;
        playerUpgrades.fireRate += crazyBuffStats.fireRate;
        updateStatsOverlay();
    } else if (!isCrazyBuffActive && wasCrazy) {
        player.speed -= crazyBuffStats.speed;
        playerUpgrades.bulletSpeed -= crazyBuffStats.bulletSpeed;
        playerUpgrades.damageBoost -= crazyBuffStats.damage;
        playerUpgrades.lineBulletCount -= crazyBuffStats.lineBulletCount;
        playerUpgrades.fireRate -= crazyBuffStats.fireRate;
        crazyBuffStats = {};
        updateStatsOverlay();
    }
}
// ===== [Cáº¤U HÃŒNH] TTL cho item =====
const ITEM_TTL_MS = 15000; // 15 giÃ¢y â€” thá»i gian sá»‘ng tá»‘i Ä‘a cá»§a item

// (Tá»‘i Æ°u nháº¹) KhÃ´ng cáº§n quÃ©t má»—i frame; 200â€“500ms/láº§n lÃ  Ä‘á»§
let _nextItemTTLCheckAt = 0;

function pruneExpiredItems(now) {
  // Giáº£m táº§n suáº¥t quÃ©t Ä‘á»ƒ khÃ´ng tá»‘n CPU khi FPS cao
  if (now < _nextItemTTLCheckAt) return;
  _nextItemTTLCheckAt = now + 300; // quÃ©t má»—i 300ms

  // Duyá»‡t ngÆ°á»£c Ä‘á»ƒ xÃ³a an toÃ n
  for (let i = items.length - 1; i >= 0; i--) {
    const it = items[i];
    if (!it) continue;

    // Náº¿u chÆ°a cÃ³ bornAt (do cÃ¡c chá»— spawn chÆ°a set), khá»Ÿi táº¡o luÃ´n á»Ÿ láº§n gáº·p Ä‘áº§u
    if (it.bornAt == null) {
      it.bornAt = now;
      continue; // má»›i sinh (theo chuáº©n), Ä‘á»£i láº§n quÃ©t sau
    }

    // QuÃ¡ 30s thÃ¬ xÃ³a
    if ((now - it.bornAt) >= ITEM_TTL_MS) {
      // CÃ¡ch 1: xÃ³a nhanh, Ã­t side-effect (swap-pop) náº¿u báº¡n cÃ³ sáºµn helper removeAtSwap()
      if (typeof removeAtSwap === 'function') {
        removeAtSwap(items, i);
      } else {
        // CÃ¡ch 2: dÃ¹ng splice cho Ä‘Æ¡n giáº£n (Ä‘Ã£ duyá»‡t ngÆ°á»£c nÃªn an toÃ n)
        items.splice(i, 1);
      }
    }
  }
}

/* ========== 22) MAIN UPDATE â€” PIPELINE RÃ• RÃ€NG ========== */
function update() {
  const now = Date.now();
  if (!gameStarted || gameOver || isPaused) return;

  updateSkillCooldowns();

  if (player.hitTimer > 0) player.hitTimer--;

  // dying â†’ chá»‰ háº¡t
  if (player.isDying) { updateParticles(); return; }

  // 1) Buff lÃµi + Halo
  sysUpdateBuffCore(now);

  // 2) Player lasers
  sysUpdatePlayerLasers();

  // 3) Wave + BigBoss
  sysUpdateWaveAndBoss(now);

  // 4) Skill Äao vÃ²ng + LÆ°á»¡i kiáº¿m mÆ°a
  skillUpdateBladesUIAndSpawn(now);
  skillUpdateBladeRain(now);

  // 5) Movement + Camera + Touch
  sysUpdateMovementAndCamera();

  // 6) Auto shoot
  if (autoShoot && player.level >= 1) autoShootBurst();

  // 7) Fire/Ice
  skillUpdateFireIce(now);

  // 8) Pet UI nháº¹
  sysUpdatePetUI(now);

  // 9) Bullets (player/clone/fairy/pet) & Enemy bullets
  sysUpdateBullets();
  sysUpdateEnemyBullets(now);

  // 10) Zombies
  sysUpdateZombies(now);

  // 11) BigBoss lazer follow (náº¿u cÃ³)
  for (let i = 0; i < zombies.length; i++) { const z = zombies[i]; if (z.active) updateBigBossLazer(z, globalDeltaTime); }

  // 12a) TTL Items 30s â€” dá»n item quÃ¡ háº¡n TRÆ¯á»šC khi hÃºt/nháº·t Ä‘á»ƒ giáº£m chi phÃ­
  pruneExpiredItems(now);

  // 12) Items + Magnet + Level up
  sysPickupItemsAndLevel(now);

  // 13) Explosions & Shockwaves
  sysUpdateExplosionsAndShockwaves();

  if (levelUpGlowTime > 0) levelUpGlowTime--;

  // 14) Satellites
  skillUpdateSatellites(now);

  // 15) Lightning
  skillUpdateLightning(now);

  // 16) Clones
  skillUpdateClones(now);

  // 17) Blood Orb
  skillUpdateBloodOrb(now);

  // 18) Thunder
  skillUpdateThunder(now);

  // 19) Support Aura
  skillUpdateSupportAura(now);

  // 20) Space Gate
  sysUpdateSpaceGate(now);

  // 21) Fairy
  skillUpdateFairy(now);

  // 22) Power/Crazy Ã¡p chá»‰ sá»‘
  sysUpdateCombatBuffs(now);

  // 23) Particles/Pet/Missiles/Spatial/Black holes/Cleanup/UI/Music/Supply
  updateParticles();
  updatePet();
  updateMissiles();
  updateSpatialIndex();
  updateBlackHoles();
  cleanupInactiveObjects();
  updateUI();
  updateStatsOverlay();
  updateMusic();
  updateSupplyDrops();
}

// Cáº­p nháº­t cooldown cá»§a ká»¹ nÄƒng
function updateSkillCooldowns() {
    const listItems = document.querySelectorAll('#skills-list .skill-item');
    const now = Date.now();

    activeSkills.forEach((skill, index) => {
        const item = listItems[index];
        if (!item || !skill.endTime) return;

        if (now < skill.endTime) {
            const remain = Math.ceil((skill.endTime - now) / 1000);
            item.innerHTML = `<span class="skill-icon">${skill.icon}</span> ${skill.name} - ${remain}s`;
            item.classList.add('active');
        } else {
            skill.endTime = null; // Reset khi háº¿t giá»
            item.innerHTML = `<span class="skill-icon">${skill.icon}</span> ${skill.name} - ${skill.manaCost}ğŸ’ `;
            item.classList.remove('active');
        }
    });
}
// Lazer boss
function updateBigBossLazer(z, deltaTime) {
    if (!z.active || !z.isBigBoss) return;

    if (z.lazerDamageCooldown === undefined) z.lazerDamageCooldown = 0;
    if (z.isChargingLazer === undefined) z.isChargingLazer = false;

    const distanceToPlayer = distance(z, player);
    const ATTACK_RANGE = 600; // Táº§m báº¯t Ä‘áº§u ngáº¯m báº¯n
    const CHARGE_TIME = 2; // Thá»i gian ngáº¯m báº¯n lÃ  2 giÃ¢y
    
    // Láº¥y tháº» audio cá»§a Ã¢m thanh "gá»“ng"
    const chargeSound = document.getElementById('sfx-lazer-charging');

    // Náº¿u ngÆ°á»i chÆ¡i á»Ÿ ngoÃ i táº§m vÃ  boss khÃ´ng Ä‘ang báº¯n
    if (distanceToPlayer > ATTACK_RANGE && !z.isLazerAttacking) {
        // Náº¿u boss ÄANG gá»“ng thÃ¬ pháº£i táº¯t Ã¢m thanh Ä‘i
        if (z.isChargingLazer && chargeSound) {
            chargeSound.pause();
            chargeSound.currentTime = 0;
        }
        z.isChargingLazer = false;
        z.lazerTimer = 0;
    } 
    // Náº¿u ngÆ°á»i chÆ¡i á»Ÿ trong táº§m vÃ  boss chÆ°a lÃ m gÃ¬ cáº£
    else if (distanceToPlayer < ATTACK_RANGE && !z.isLazerAttacking && !z.isChargingLazer) {
        z.isChargingLazer = true; // Báº¯t Ä‘áº§u gá»“ng
        z.lazerTimer = 0;
        
        // Báº¯t Ä‘áº§u phÃ¡t Ã¢m thanh gá»“ng
        if (chargeSound) {
            chargeSound.volume = 0.5; // <-- THÃŠM DÃ’NG NÃ€Y (0.5 = 50% Ã¢m lÆ°á»£ng)
            chargeSound.play();
    }
  }
    // Náº¿u Ä‘ang trong giai Ä‘oáº¡n gá»“ng laze
    if (z.isChargingLazer) {
        z.lazerTimer += deltaTime;
        // Náº¿u gá»“ng Ä‘á»§ 2 giÃ¢y thÃ¬ báº¯n
        if (z.lazerTimer > CHARGE_TIME) {
            z.isChargingLazer = false;
            z.isLazerAttacking = true;
            
            // Dá»«ng Ã¢m thanh gá»“ng
            if (chargeSound) {
                chargeSound.pause();
                chargeSound.currentTime = 0;
            }
            // PhÃ¡t Ã¢m thanh báº¯n
            playSound('sfx-bigboss-laser', 0.5);
            
            z.lazerDuration = 2;
            z.lazerTimer = 0;
            z.lazerAngle = Math.atan2(player.y - z.y, player.x - z.x);
        }
    }

    // Giai Ä‘oáº¡n báº¯n tia lazer
    if (z.isLazerAttacking) {
        z.lazerDuration -= deltaTime;
        if (z.lazerDuration <= 0) {
            z.isLazerAttacking = false;
        }
        
        if (z.lazerAngle !== undefined) {
            const proj = (player.x - z.x) * Math.cos(z.lazerAngle) + (player.y - z.y) * Math.sin(z.lazerAngle);
            const perp = Math.abs((player.x - z.x) * Math.sin(z.lazerAngle) - (player.y - z.y) * Math.cos(z.lazerAngle));
            
            const lazerRange = 600;
            const lazerWidth = 18;
            const lazerCooldown = 60;

            if (proj > 0 && proj < lazerRange && perp < lazerWidth) {
                if (z.lazerDamageCooldown <= 0 && player.hearts > 0) {
                    if (player.shieldActive) {
                      const now = Date.now();
                        // DÃ¹ng chung cooldown vá»›i va cháº¡m zombie Ä‘á»ƒ trÃ¡nh spam Ã¢m thanh
                        if (now - lastShieldBlockSoundTime > 100) {
                            playSound('sfx-shield-block', 0.3); // 30% Ã¢m lÆ°á»£ng
                            lastShieldBlockSoundTime = now;
                        }
                        if (frame % 3 === 0) {
                            createParticleExplosion(player.x, player.y, 2, 'smoke');
                        }
                    } else {
                        const lazerDamage = calculateZombieDamage(z);
                        if (supportAuraActive) {
                            lazerDamage *= 0.5;
                        }
                        player.hearts -= lazerDamage;
                        z.lazerDamageCooldown = lazerCooldown;
                        createDamageImpactEffect(player, lazerDamage);
                        if (player.hearts <= 0) {
                            handlePlayerDeath(); 
                        }
                    }
                }
            }
          }
        
        if (z.lazerDamageCooldown > 0) z.lazerDamageCooldown--;
    }
}
// === ğŸŒ MINI MAP ===
// ToÃ n báº£n Ä‘á»“ rá»™ng 3000 x 2000 (cÃ³ thá»ƒ Ä‘iá»u chá»‰nh)
const worldWidth = 3000;
const worldHeight = 2000;
const wallThickness = 10; // Äá»™ dÃ y tÆ°á»ng viá»n báº£n Ä‘á»“
const miniMapCanvas = document.getElementById("miniMap");
const miniCtx = miniMapCanvas.getContext("2d");
let showMiniMap = false; //false Ä‘á»ƒ áº©n ban Ä‘áº§u

// Báº¯t phÃ­m M Ä‘á»ƒ báº­t/táº¯t
document.addEventListener("keydown", (e) => {
  if (e.key.toLowerCase() === "m") {
    showMiniMap = !showMiniMap;
    miniMapCanvas.style.display = showMiniMap ? "block" : "none";
  }
  // âŒ¨ï¸ áº¨n/hiá»‡n menu UI khi báº¥m phÃ­m t
  if (e.key.toLowerCase() === "t") {
    uiVisible = !uiVisible;
    const ui = document.getElementById("ui");
    ui.style.display = uiVisible ? "flex" : "none";
}
});

// HÃ m váº½ mini map
function drawMiniMap() {
  if (!showMiniMap) return;

  miniCtx.clearRect(0, 0, miniMapCanvas.width, miniMapCanvas.height);

  const scaleX = miniMapCanvas.width / worldWidth;
  const scaleY = miniMapCanvas.height / worldHeight;
 // ğŸ‘‡ má»›i thÃªm â€“ dá»… chá»‰nh kÃ­ch thÆ°á»›c sau nÃ y
  const ITEM_SIZE   = 1.2;   // chiá»u rá»™ng/ cao dáº¥u váº­t pháº©m (px trÃªn minimap)
  const ZOMBIE_SIZE = 2;     // zombie thÆ°á»ng (Ã´ vuÃ´ng)
  const DOT_PLAYER  = 3;     // bÃ¡n kÃ­nh cháº¥m player & boss/mini
    // --- Báº®T Äáº¦U PHáº¦N Bá»” SUNG ---
  // Váº½ cÃ¡c hÃ²m tiáº¿p táº¿ (ğŸª‚) Ä‘ang rÆ¡i
  supplyDrops.forEach(drop => {
      const mapX = drop.x * scaleX;
      const mapY = drop.y * scaleY;
      
      miniCtx.fillStyle = "cyan"; // Cháº¥m mÃ u xanh cyan cho dá»… tháº¥y
      miniCtx.beginPath();
      miniCtx.arc(mapX, mapY, 2, 0, Math.PI * 2); // Váº½ má»™t cháº¥m trÃ²n
      miniCtx.fill();
  });
  // --- Káº¾T THÃšC PHáº¦N Bá»” SUNG ---

// Draw items (energy, mana, hp)
for (let it of items) {
  if (!it.active) continue;
  switch (it.type) {
    case "crazymadnesstime": miniCtx.fillStyle = "#3b82f6"; break; // MÃ u xanh dÆ°Æ¡ng cho CrazyMadnessTime
    case "energy": miniCtx.fillStyle = "yellow"; break; // MÃ u vÃ ng cho nÄƒng lÆ°á»£ng
    case "mana": miniCtx.fillStyle = "cyan"; break; // MÃ u xanh lam cho mana
    case "hp": miniCtx.fillStyle = "lime"; break; // MÃ u xanh lÃ¡ cÃ¢y cho HP
    case "box": miniCtx.fillStyle = "blue"; break; // MÃ u xanh dÆ°Æ¡ng cho há»™p
    
    // ThÃªm cÃ¡c trÆ°á»ng há»£p má»›i cho cÃ¡c váº­t pháº©m Ä‘áº·c biá»‡t
    case "lucky": miniCtx.fillStyle = "#22c55e"; break; // MÃ u xanh lÃ¡ cÃ¢y cho Lucky
    case "power": miniCtx.fillStyle = "#ef4444"; break; // MÃ u Ä‘á» cho Power
    case "crazy": miniCtx.fillStyle = "#f59e0b"; break; // MÃ u vÃ ng cam cho Crazy
    case "exp": miniCtx.fillStyle = "#ffeb3b"; break; // MÃ u vÃ ng cho Exp
    case "magnet": miniCtx.fillStyle = "#8b5cf6"; break; // MÃ u tÃ­m cho Magnet
    case "secret": miniCtx.fillStyle = "violet"; break; // MÃ u tÃ­m Ä‘áº­m cho Secret
    case "expBonus": miniCtx.fillStyle = "gold"; break; // MÃ u vÃ ng kim cho ExpBonus
    case "potion": miniCtx.fillStyle = "red"; break; // VÃ­ dá»¥: cháº¥m mÃ u Ä‘á»

    default: miniCtx.fillStyle = "gray";
  }
  miniCtx.fillRect(it.x * scaleX - 0.5, it.y * scaleY - 0.5, 1, 1); // Váº½ kÃ­ch thÆ°á»›c váº­t pháº©m trÃªn minimap
}
// ğŸ’œ Váº½ clone trÃªn minimap
clones.forEach(clone => {
  const mapX = (clone.x / worldWidth) * miniMapCanvas.width;
  const mapY = (clone.y / worldHeight) * miniMapCanvas.height;
  miniCtx.fillStyle = "#cc66ff";
  miniCtx.beginPath();
  miniCtx.arc(mapX, mapY, 2, 0, Math.PI * 2);
  miniCtx.fill();
});
// ğŸŸ¦ Váº½ mÃ¡y bay trÃªn minimap
activePlanes.forEach(plane => {
  const mapX = (plane.x / worldWidth) * miniMapCanvas.width;
  const mapY = (plane.y / worldHeight) * miniMapCanvas.height;
  miniCtx.fillStyle = "#cc66ff";
  miniCtx.beginPath();
  miniCtx.arc(mapX, mapY, 2, 0, Math.PI * 2);
  miniCtx.fill();
});
  // Draw zombies
for (let z of zombies) {
  if (!z.active) continue;

  const mapX = (z.x / worldWidth) * miniMapCanvas.width;
  const mapY = (z.y / worldHeight) * miniMapCanvas.height;

  if (z.isBigBoss) {
    // BigBoss â€“ to nháº¥t, mÃ u rÃµ rÃ ng khÃ¡c háº³n
    miniCtx.fillStyle = "purple";
    miniCtx.beginPath();
    miniCtx.arc(mapX, mapY, 3, 0, Math.PI * 2);
    miniCtx.fill();
  } 
  else if (z.isBoss) {
    // ğŸ”´ Boss thÆ°á»ng â€“ mÃ u Ä‘á» hoáº·c cam, tuá»³ báº¡n
    miniCtx.fillStyle = "orange";
    miniCtx.beginPath();
    miniCtx.arc(mapX, mapY, 2, 0, Math.PI * 2);
    miniCtx.fill();
  } 
  else if (z.type === "miniBoss") {
    // ğŸŸ  MiniBoss â€“ khÃ¡c boss thÆ°á»ng chÃºt
    miniCtx.fillStyle = "gold";
    miniCtx.beginPath();
    miniCtx.arc(mapX, mapY, 1.5, 0, Math.PI * 2);
    miniCtx.fill();
  } 
  else {
    // ğŸ”² Zombie thÆ°á»ng â€“ vuÃ´ng nhá»
    miniCtx.fillStyle = "red";
    miniCtx.fillRect(mapX - 1, mapY - 1, 2, 2);
  }
}
  // Draw player
  miniCtx.fillStyle = "#00ccff";  // Xanh dÆ°Æ¡ng Ä‘á»“ng bá»™ tÃªn
  miniCtx.beginPath();
  miniCtx.arc(player.x * scaleX, player.y * scaleY, 2, 0, Math.PI * 2);
  miniCtx.fill();
  /* â€” cháº¥m pet Thá» mÃ u há»“ng â€” */
if (petRabbit && petActive) {
  miniCtx.fillStyle = "#ff4dc4";          // há»“ng Ä‘áº­m
  miniCtx.beginPath();
  miniCtx.arc(petRabbit.x * scaleX, petRabbit.y * scaleY, 2, 0, Math.PI * 2);
  miniCtx.fill();
}
}
// ğŸ¨ Váº½ Ä‘Æ°á»ng chÃ©o sá»c (diagonal stripes) trÃªn canvas
function drawDiagonalStripes(ctx, x, y, width, height, stripeColor = "#666", spacing = 10) {
  ctx.save();
  ctx.beginPath();
  ctx.rect(x, y, width, height);
  ctx.clip();

  ctx.strokeStyle = stripeColor;
  ctx.lineWidth = 1; // Äá»™ dÃ y Ä‘Æ°á»ng sá»c

  const maxLength = width + height;
  for (let i = -height; i < maxLength; i += spacing) {
    ctx.beginPath();
    ctx.moveTo(x + i, y);
    ctx.lineTo(x + i - height, y + height);
    ctx.stroke();
  }

  ctx.restore();
}
function drawBloodOrb(ctx) {
    if (!bloodOrbActive) return;
    bloodOrbs.forEach(o => {
        ctx.save();
        ctx.translate(o.x, o.y);

        // Quáº£ cáº§u tá»± xoay quanh chÃ­nh nÃ³
        ctx.rotate(frame / 100);

        // === Váº½ cÃ¡c gai dÃ i ===
        ctx.shadowBlur = 6;         // ThÃªm blur cho cÃ¡c gai
        ctx.shadowColor = "red";
        for (let i = 0; i < 12; i++) {
            const angle = (Math.PI * 2 / 12) * i;
            const x = Math.cos(angle) * 24; // Gai dÃ i hÆ¡n háº³n
            const y = Math.sin(angle) * 24;
            ctx.beginPath();
            ctx.moveTo(0, 0);
            ctx.lineTo(x, y);
            ctx.strokeStyle = "rgba(50, 0, 0, 0.7)";
            ctx.lineWidth = 2;
            ctx.stroke();
        }

        // === Váº½ vÃ²ng trÃ²n ngoÃ i tá»‘i, viá»n Ä‘á» bÃ³ng ===
        ctx.beginPath();
        ctx.arc(0, 0, 16, 0, Math.PI * 2);
        ctx.fillStyle = "rgba(60, 0, 0, 0.9)";
        ctx.strokeStyle = "rgba(255,0,0,0.7)";
        ctx.lineWidth = 2;
        ctx.fill();
        ctx.stroke();

        // === Váº½ vÃ²ng trÃ²n trong Ä‘á» nháº¡t, trong suá»‘t hÆ¡n ===
        ctx.beginPath();
        ctx.arc(0, 0, 10, 0, Math.PI * 2);
        ctx.fillStyle = "rgba(255, 80, 80, 0.05)"; // ğŸ“ Äá» ráº¥t nháº¡t, trong suá»‘t
        ctx.fill();
        ctx.restore();

        // === Icon ğŸ©¸ chÃ­nh giá»¯a ===
        ctx.font = "1rem Arial";
        ctx.textAlign = "center";
        ctx.textBaseline = "middle";
        ctx.fillStyle = "white";
        ctx.fillText("ğŸ©¸", o.x, o.y);

        // === Beam nhá»‹p tim ===
        if (!o.target) return;
        const z = o.target;
        ctx.beginPath();
        ctx.moveTo(o.x, o.y);
        const segments = 16;
        for (let i = 0; i <= segments; i++) {
            const t = i / segments;
            const x = o.x + (z.x - o.x) * t;
            const y = o.y + (z.y - o.y) * t + Math.sin(t * 6 * Math.PI + frame / 8) * 5;
            ctx.lineTo(x, y);
        }
        ctx.strokeStyle = "rgba(255,0,0,0.6)";
        ctx.lineWidth = 2;
        ctx.shadowBlur = 4;
        ctx.shadowColor = "red";
        ctx.stroke();
        ctx.shadowBlur = 0;
    });
}
/**
 * Táº¡o hiá»‡u á»©ng chá»¯ "+EXP" bay lÃªn khi nháº­n Ä‘Æ°á»£c kinh nghiá»‡m.
 * @param {object} target - Äá»‘i tÆ°á»£ng bá»‹ tiÃªu diá»‡t (thÆ°á»ng lÃ  zombie).
 * @param {number} amount - LÆ°á»£ng EXP nháº­n Ä‘Æ°á»£c.
 */
function createExpGainEffect(target, amount) {
    // Chá»‰ táº¡o hiá»‡u á»©ng náº¿u nháº­n Ä‘Æ°á»£c EXP
    if (amount <= 0) return;

    // Táº¡o popup sá»‘ EXP nháº­n Ä‘Æ°á»£c
    const radius = target.radius || target.size || 15;
    healEffects.push({
        x: target.x + 36 + (Math.random() - 0.5) * 10, // Lá»‡ch sang pháº£i
        y: target.y - radius,
        life: 120,
        maxLife: 120,
        text: `+${amount} exp`,
        delay: 0,
        color: 'gold' // MÃ u vÃ ng
    });
}
/**
 * Táº¡o hiá»‡u á»©ng há»“i mÃ¡u.
 * @param {object} target - Äá»‘i tÆ°á»£ng Ä‘Æ°á»£c há»“i mÃ¡u (player).
 * @param {number} amount - LÆ°á»£ng mÃ¡u Ä‘Æ°á»£c há»“i.
 */
function createHealImpactEffect(target, amount) {
    // Táº¡o popup sá»‘ mÃ¡u há»“i mÃ u xanh lÃ¡
    const radius = target.radius || target.size || 15;
    healEffects.push({
        x: target.x + (Math.random() - 0.5) * 10,
        y: target.y - radius * 2,
        life: 120,
        maxLife: 120,
        text: `+${amount}`,
        delay: 0,
        color: 'lime'
    });
}
/**
 * Táº¡o hiá»‡u á»©ng khi má»™t má»¥c tiÃªu bá»‹ dÃ­nh sÃ¡t thÆ°Æ¡ng.
 * @param {object} target - Äá»‘i tÆ°á»£ng bá»‹ dÃ­nh sÃ¡t thÆ°Æ¡ng (player hoáº·c zombie).
 * @param {number} amount - LÆ°á»£ng sÃ¡t thÆ°Æ¡ng.
 */
function createDamageImpactEffect(target, amount) {
    // --- Báº®T Äáº¦U THÃŠM Má»šI ---
    // Náº¿u Ä‘á»‘i tÆ°á»£ng chá»‹u sÃ¡t thÆ°Æ¡ng lÃ  ngÆ°á»i chÆ¡i, phÃ¡t Ã¢m thanh "hurt"
    if (target === player) {
        playSound('sfx-player-hurt', 0.3); // PhÃ¡t á»Ÿ 30% Ã¢m lÆ°á»£ng
    }
    // --- Káº¾T THÃšC THÃŠM Má»šI ---

    let effectColor, particleColor;
    
    if (target === player) {
        // Náº¿u lÃ  ngÆ°á»i chÆ¡i, mÃ¡u váº«n mÃ u Ä‘á»
        effectColor = '#ff4c4c';
        particleColor = 'rgba(255, 0, 0, 0.7)';
    } else {
        // âœ¨ THAY Äá»”I: Náº¿u lÃ  zombie, mÃ¡u sáº½ mÃ u tÃ­m
        effectColor = 'violet';                      // MÃ u cho chá»¯ -HP
        particleColor = 'rgba(190, 80, 220, 0.7)'; // MÃ u cho háº¡t "mÃ¡u"
    }

    // Táº¡o popup sá»‘ sÃ¡t thÆ°Æ¡ng (dÃ¹ng mÃ u Ä‘Ã£ chá»n)
    const radius = target.radius || target.size || 15;
    healEffects.push({
        x: target.x + (Math.random() - 0.5) * 10,
        y: target.y - radius * 2,
        life: 120,
        maxLife: 120,
        text: `-${amount}`,
        delay: 0,
        color: effectColor
    });

    // Táº¡o hiá»‡u á»©ng vá»‡t mÃ¡u (dÃ¹ng mÃ u Ä‘Ã£ chá»n)
    for (let i = 0; i < 2; i++) {
        const angle = Math.random() * Math.PI * 2;
        const speed = Math.random() * 1.5 + 0.5;
        particles.push({
            x: target.x, y: target.y,
            vx: Math.cos(angle) * speed,
            vy: Math.sin(angle) * speed,
            size: Math.random() * 2 + 1,
            color: particleColor,
            alpha: 1,
            fastFade: 0.012
        });
    }
}
// hÃ m hiá»‡u á»©ng cháº·n Ä‘áº¡n
function createShieldImpactEffect(x, y) {
    // Táº¡o ra 5 tia lá»­a nhá» bay ra ngáº«u nhiÃªn
    for (let i = 0; i < 3; i++) {
        const angle = Math.random() * Math.PI * 2;
        const speed = Math.random() * 1.5 + 0.5;
        particles.push({
            x: x, y: y,
            vx: Math.cos(angle) * speed,
            vy: Math.sin(angle) * speed,
            size: Math.random() * 2 + 1,
            color: `rgba(0, 255, 255, ${Math.random() * 0.5 + 0.5})`, // MÃ u xanh cyan
            alpha: 1,
            fastFade: true // Tan biáº¿n nhanh
        });
    }
}

function createBloodOrbParticleOnBeam(orb) {
    if (!orb.target) return;

    // Random vá»‹ trÃ­ dá»c theo beam tá»« quáº£ cáº§u tá»›i zombie
    const t = Math.random(); // Tá»« 0 Ä‘áº¿n 1
    const x = orb.x + (orb.target.x - orb.x) * t;
    const y = orb.y + (orb.target.y - orb.y) * t;

    const dx = orb.x - x;
    const dy = orb.y - y;
    const speed = 0.5 + Math.random() * 0.5;

    particles.push({
        x: x,
        y: y,
        vx: dx * 0.02 * speed,
        vy: dy * 0.02 * speed,
        alpha: 1,
        size: 1 + Math.random() * 1,
        color: 'rgba(255, 0, 0, 0.6)',
        fastFade: true // ÄÃ¡nh dáº¥u háº¡t tan nhanh
    });
}
// Váº½ Fairy vÃ  hiá»‡u á»©ng háº¡t
function createFairyParticle(x, y) {
    particles.push({
        // Loáº¡i háº¡t nÃ y khÃ´ng cáº§n type vÃ¬ dÃ¹ng logic máº·c Ä‘á»‹nh
        x: x,
        y: y,
        vx: (Math.random() - 0.5) * 0.5,
        vy: (Math.random() - 0.5) * 0.5,
        size: Math.random() * 0.5 + 0.5,
        color: 'rgba(0, 255, 255, 0.7)', // MÃ u xanh cyan phÃ¡t sÃ¡ng
        alpha: 1,
        fastFade: true // Má» nhanh
    });
}
// Táº¡o 1 háº¡t nhá» bay ngÆ°á»£c vÃ o quáº£ cáº§u má»—i khi hÃºt mÃ¡u
function createBloodOrbParticle(orb) {
  createSuctionDust(orb.x, orb.y, 40, "rgba(255,0,0,0.6)", true);
}
/**
 * Sinh 1 háº¡t bá»¥i bay vÃ o (cx, cy)
 * @param {number} cx, cy   â€“ toáº¡ Ä‘á»™ tÃ¢m cáº§n hÃºt
 * @param {number} spread   â€“ khoáº£ng Ä‘áº·t háº¡t (máº·c Ä‘á»‹nh 250-300 px)
 * @param {string} color    â€“ mÃ u/Ä‘á»™ má» háº¡t
 * @param {boolean} fast    â€“ tan nhanh (dÃ¹ng cho tia mÃ¡u)
 */
function createSuctionDust(cx, cy, spread = 250,
                           color = "rgba(200,200,200,0.5)",
                           fast = false) {
  const a      = Math.random() * Math.PI * 2;
  const r      = spread + Math.random() * 50;
  const px     = cx + Math.cos(a) * r;
  const py     = cy + Math.sin(a) * r;
  const speed  = 0.02;

  particles.push({
    x : px,          y : py,
    vx: (cx - px) * speed,
    vy: (cy - py) * speed,
    size  : 1 + Math.random() * 2,
    alpha : 1,
    color ,
    fastFade: fast // Náº¿u true, háº¡t sáº½ tan biáº¿n nhanh
  });
}
// HÃ m má»›i táº¡o háº¡t lá»‘c xoÃ¡y cho cá»•ng khÃ´ng gian
function createGateOrbitParticle(gate) {
    const angle = Math.random() * Math.PI * 2;
    // BÃ¡n kÃ­nh quá»¹ Ä‘áº¡o sáº½ hÆ¡i lá»›n hÆ¡n bÃ¡n kÃ­nh cá»§a cá»•ng má»™t chÃºt
    const orbitRadius = gate.radius * (1.1 + Math.random() * 0.2);

    particles.push({
        type: 'gate_orbit', // Loáº¡i háº¡t má»›i Ä‘á»ƒ xá»­ lÃ½ riÃªng
        cx: gate.x,
        cy: gate.y,
        orbitRadius: orbitRadius,
        angle: angle,
        orbitSpeed: 0.01 + Math.random() * 0.015, // Tá»‘c Ä‘á»™ xoay ngáº«u nhiÃªn
        size: 1 + Math.random() * 1.5,
        alpha: 0.9,
        life: 60 + Math.floor(Math.random() * 30), // Tuá»•i thá» cá»§a háº¡t (frame)
        color: 'rgba(255, 220, 0, 0.8)' // MÃ u vÃ ng
    });
}
// HÃ m má»›i táº¡o háº¡t lá»‘c xoÃ¡y cho há»‘ Ä‘en
function createVortexParticle(cx, cy, spawnRadius) {
    const angle = Math.random() * Math.PI * 2;
    // Táº¡o háº¡t á»Ÿ má»™t khoáº£ng ngáº«u nhiÃªn bÃªn ngoÃ i rÃ¬a
    const radius = spawnRadius * (0.8 + Math.random() * 0.4);

    particles.push({
        type: 'blackhole_vortex', // ÄÃ¡nh dáº¥u Ä‘Ã¢y lÃ  háº¡t lá»‘c xoÃ¡y
        cx: cx,                   // LÆ°u tá»a Ä‘á»™ tÃ¢m Ä‘á»ƒ xoay quanh
        cy: cy,
        orbitRadius: radius,      // Khoáº£ng cÃ¡ch ban Ä‘áº§u tá»›i tÃ¢m
        angle: angle,             // GÃ³c ban Ä‘áº§u
        pullSpeed: 0.5 + Math.random() * 0.5, // Tá»‘c Ä‘á»™ bá»‹ hÃºt vÃ o
        orbitSpeed: 0.02 + Math.random() * 0.001, // Tá»‘c Ä‘á»™ xoay
        size: 1.5 + Math.random() * 1.5,
        alpha: 0.8,
        color: 'rgba(10, 10, 20, 0.7)' // MÃ u tÃ­m Ä‘áº­m vÅ© trá»¥
    });
}
function triggerPlayerDyingEffect() {
  playSound('sfx-player-explode', 0.2); // PhÃ¡t Ã¢m thanh ná»•
    // Táº¡o má»™t vá»¥ ná»• cÃ¡c háº¡t mÃ u Ä‘á» táº¡i vá»‹ trÃ­ ngÆ°á»i chÆ¡i
    for (let i = 0; i < 150; i++) {
        const angle = Math.random() * Math.PI * 2;
        const speed = Math.random() * 6 + 2; // Tá»‘c Ä‘á»™ háº¡t ngáº«u nhiÃªn
        const color = `rgba(255, ${Math.random() * 100}, ${Math.random() * 50}, ${Math.random() * 0.5 + 0.5})`;

        particles.push({
            x: player.x,
            y: player.y,
            vx: Math.cos(angle) * speed,
            vy: Math.sin(angle) * speed,
            size: Math.random() * 4 + 2,
            color: color,
            alpha: 1,
            fastFade: true 
        });
    }
}
function handlePlayerDeath() {
      // Kiá»ƒm tra xem ká»¹ nÄƒng Fairy cÃ³ thá»ƒ cá»©u máº¡ng khÃ´ng
    if (fairyActive && fairyDeathDefyAvailable) {
        fairyDeathDefyAvailable = false; // DÃ¹ng háº¿t 1 láº§n cá»©u máº¡ng
        player.hearts = 1000; // Há»“i láº¡i 10 HP
        player.hitTimer = 180; // Báº¥t tá»­ 3 giÃ¢y
        showWarning("ğŸ¦‹ Fairy Ä‘Ã£ cá»©u báº¡n!");
        
        return; 
    }

    if (player.isDying) return; // NgÄƒn viá»‡c gá»i láº¡i nhiá»u láº§n

    // --- Báº®T Äáº¦U THÃŠM Má»šI ---
    
    // Dá»«ng táº¥t cáº£ nháº¡c ná»n Ä‘ang phÃ¡t
    stopAllMusic();
    
    // PhÃ¡t Ã¢m thanh thua cuá»™c
    playSound('sfx-game-over');

    // --- Káº¾T THÃšC THÃŠM Má»šI ---

    player.isDying = true;
    triggerPlayerDyingEffect();

    // Sau 2 giÃ¢y, hiá»‡n mÃ n hÃ¬nh Game Over
    setTimeout(() => {
        gameOver = true;
        document.getElementById("gameOverPanel").classList.add("visible");
    }, 1500); // 1.5 giÃ¢y Ä‘á»ƒ hiá»‡u á»©ng ká»‹p diá»…n ra
}
// Cáº­p nháº­t tráº¡ng thÃ¡i cá»§a táº¥t cáº£ cÃ¡c háº¡t hiá»‡u á»©ng trong má»—i khung hÃ¬nh
function updateParticles() {
    for (let i = particles.length - 1; i >= 0; i--) {
        const p = particles[i];

// LOGIC Cáº¢I TIáº¾N: Di chuyá»ƒn vÃ  xá»­ lÃ½ va cháº¡m cho icon lá»­a/bÄƒng
        if (p.type === 'fire_spark' || p.type === 'ice_shard') {
            if (!p.target || !p.target.active) {
                particles.splice(i, 1);
                continue;
            }
            
            const angle = Math.atan2(p.target.y - p.y, p.target.x - p.x);
            p.rotation = angle;
            p.x += Math.cos(angle) * p.speed;
            p.y += Math.sin(angle) * p.speed;

            // Náº¿u icon Ä‘Ã£ bay tá»›i gáº§n má»¥c tiÃªu
            if (distance(p, p.target) < p.speed) {
                // GÃ¢y sÃ¡t thÆ°Æ¡ng vÃ  hiá»‡u á»©ng Táº I ÄÃ‚Y
                if (p.target.active) {
                    dealDamageToZombie(p.target, p.damage);
                    if (p.type === 'fire_spark') {
                        p.target.burnEndTime = Date.now() + 3000;
                        // Bá»” SUNG: ThÃªm hiá»‡u á»©ng hÃ¬nh áº£nh bá»‘c chÃ¡y
                        p.target.onFireUntil = Date.now() + 400;
                    } else { // 'ice_shard'
                        p.target.slowEndTime = Date.now() + 3000;
                        // Bá»” SUNG: ThÃªm hiá»‡u á»©ng hÃ¬nh áº£nh Ä‘Ã³ng bÄƒng
                        p.target.onIceUntil = Date.now() + 400;
                    }
                }
                particles.splice(i, 1); // XÃ³a icon sau khi Ä‘Ã£ trÃºng
            }
            continue;
        }
        // (CÃ¡c logic xá»­ lÃ½ háº¡t khÃ¡c giá»¯ nguyÃªn)
        if (p.type === 'blackhole_vortex') {
            p.orbitRadius -= p.pullSpeed;
            p.angle += p.orbitSpeed;
            p.x = p.cx + Math.cos(p.angle) * p.orbitRadius;
            p.y = p.cy + Math.sin(p.angle) * p.orbitRadius;
            p.alpha -= 0.015;
            if (p.orbitRadius <= 1 || p.alpha <= 0) {
                particles.splice(i, 1);
                continue;
            }
        } else if (p.type === 'fairy_status_effect') {
            if (p.target && p.target.active) {
                p.angle += 0.1;
                p.x = p.target.x + Math.cos(p.angle) * p.orbitRadius;
                p.y = p.target.y + Math.sin(p.angle) * p.orbitRadius;
                p.life--;
            } else {
                p.life -= 5;
            }
            p.alpha = p.life / p.maxLife;
            if (p.life <= 0) {
                particles.splice(i, 1);
                continue;
            }
        } else if (p.type === 'gate_orbit') {
            p.angle += p.orbitSpeed;
            p.x = p.cx + Math.cos(p.angle) * p.orbitRadius;
            p.y = p.cy + Math.sin(p.angle) * p.orbitRadius;
            p.life--;
            p.alpha = p.life / 90;
            if (p.life <= 0) {
                particles.splice(i, 1);
                continue;
            }
        } else if (p.type === 'aura_particle') {
            p.x += p.vx;
            p.y += p.vy;
            p.alpha -= p.alphaDecay;
        } else {
            if (p.maxDistance !== undefined) {
                const distSq = (p.x - p.originX) ** 2 + (p.y - p.originY) ** 2;
                if (distSq > p.maxDistance ** 2) {
                    p.alpha -= 0.1;
                }
            }
            p.x += p.vx;
            p.y += p.vy;
            if (typeof p.fastFade === 'number') {
                p.alpha -= p.fastFade;
            } else if (p.fastFade === true) {
                p.alpha -= 0.006;
            } else {
                p.alpha -= 0.0006;
            }
        }
        if (p.alpha <= 0) {
            if (particles[i] === p) {
                particles.splice(i, 1);
            }
        }
    }
}
// Váº½ táº¥t cáº£ cÃ¡c háº¡t hiá»‡u á»©ng lÃªn canvas
function drawParticles(ctx) {
    particles.forEach(p => {
        // LOGIC Váº¼ Má»šI: Váº½ Ä‘á»‘m lá»­a vÃ  máº£nh bÄƒng tÃ¹y chá»‰nh
        if (p.type === 'fire_spark' || p.type === 'ice_shard') {
            ctx.save();
            // Di chuyá»ƒn vÃ  xoay canvas Ä‘áº¿n vá»‹ trÃ­ vÃ  hÆ°á»›ng cá»§a viÃªn Ä‘áº¡n
            ctx.translate(p.x, p.y);
            ctx.rotate(p.rotation || 0);

            if (p.type === 'fire_spark') {
                // Váº½ Ä‘á»‘m lá»­a: Gá»“m má»™t "Ä‘uÃ´i" mÃ u cam vÃ  má»™t "Ä‘áº§u" mÃ u vÃ ng sÃ¡ng
                // ÄuÃ´i lá»­a (má» hÆ¡n)
                ctx.globalAlpha = 0.6;
                ctx.fillStyle = '#ff8c00'; // DarkOrange
                ctx.beginPath();
                ctx.arc(-3, 0, 5, 0, Math.PI * 2); // VÃ²ng trÃ²n lá»›n hÆ¡n á»Ÿ phÃ­a sau
                ctx.fill();

                // Äáº§u lá»­a (sÃ¡ng rÃµ)
                ctx.globalAlpha = 1.0;
                ctx.fillStyle = '#ffd700'; // Gold
                ctx.beginPath();
                ctx.arc(2, 0, 4, 0, Math.PI * 2); // VÃ²ng trÃ²n nhá» hÆ¡n á»Ÿ phÃ­a trÆ°á»›c
                ctx.fill();
            } else { // 'ice_shard'
                // Váº½ máº£nh bÄƒng: má»™t hÃ¬nh thoi dÃ i, sáº¯c nhá»n
                ctx.fillStyle = '#afeeee'; // PaleTurquoise
                ctx.strokeStyle = '#ffffff';
                ctx.lineWidth = 1;
                ctx.beginPath();
                ctx.moveTo(8, 0);   // MÅ©i nhá»n
                ctx.lineTo(-4, -4); // Cáº¡nh trÃªn
                ctx.lineTo(-8, 0);  // ÄuÃ´i
                ctx.lineTo(-4, 4);  // Cáº¡nh dÆ°á»›i
                ctx.closePath();
                ctx.fill();
                ctx.stroke();
            }
            ctx.restore();
            return; // Bá» qua, khÃ´ng váº½ háº¡t trÃ²n máº·c Ä‘á»‹nh
        }

        // Logic váº½ cÃ¡c háº¡t máº·c Ä‘á»‹nh (giá»¯ nguyÃªn)
        ctx.globalAlpha = p.alpha;
        ctx.fillStyle = p.color;
        ctx.shadowColor = 'purple';
        ctx.shadowBlur = 8;
        ctx.beginPath();
        ctx.arc(p.x, p.y, p.size, 0, Math.PI * 2);
        ctx.fill();
        ctx.shadowBlur = 0;
    });
    // Reset Ä‘á»™ trong suá»‘t vá» máº·c Ä‘á»‹nh
    ctx.globalAlpha = 1;
}
// === ğŸŒ— NGÃ€Y ÄÃŠM ===
function updateDayNight() {
    const now = Date.now();
    const deltaTime = (now - lastUpdateTime) / 1000;
    lastUpdateTime = now;

    dayTime += deltaTime / dayDuration;
    if (dayTime >= 1) {
        dayTime -= 1; // Reset vá» 0 liÃªn tá»¥c
        currentDay++; // TÄƒng sá»‘ ngÃ y khi má»™t ngÃ y má»›i báº¯t Ä‘áº§u        
    }
    // LÆ°u láº¡i Ä‘á»ƒ chá»— khÃ¡c dÃ¹ng
    globalDeltaTime = deltaTime;
}

function drawBackgroundByTime(ctx) {
    const w = canvas.width;
    const h = canvas.height;

    // ğŸ•’ TÃ­nh giá» 0 - 23
    const hour = Math.floor(dayTime * 24) % 24;
    // --- Báº®T Äáº¦U LOGIC Má»šI ---
// Náº¿u lÃ  9h sÃ¡ng vÃ  sá»± kiá»‡n chÆ°a Ä‘Æ°á»£c kÃ­ch hoáº¡t trong ngÃ y hÃ´m nay
if (hour === 9 && !morningDropTriggered) {
    triggerSupplyDrop();
    morningDropTriggered = true; // ÄÃ¡nh dáº¥u Ä‘Ã£ kÃ­ch hoáº¡t 9h
}
// Náº¿u lÃ  12h trÆ°a vÃ  sá»± kiá»‡n chÆ°a Ä‘Æ°á»£c kÃ­ch hoáº¡t trong ngÃ y hÃ´m nay
else if (hour === 12 && !morningDropTriggered12h) {
    triggerSupplyDrop();
    morningDropTriggered12h = true; // ÄÃ¡nh dáº¥u Ä‘Ã£ kÃ­ch hoáº¡t 12h
}
// Náº¿u lÃ  15h chiá»u vÃ  sá»± kiá»‡n chÆ°a Ä‘Æ°á»£c kÃ­ch hoáº¡t trong ngÃ y hÃ´m nay
else if (hour === 15 && !morningDropTriggered15h) {
    triggerSupplyDrop();
    morningDropTriggered15h = true; // ÄÃ¡nh dáº¥u Ä‘Ã£ kÃ­ch hoáº¡t 15h
}
// Reset láº¡i cÃ¡c cá» khi qua ngÃ y má»›i (vÃ­ dá»¥: lÃºc 0h)
else if (hour === 0) {
    morningDropTriggered = false;
    morningDropTriggered12h = false;
    morningDropTriggered15h = false;
}
    // --- Káº¾T THÃšC LOGIC Má»šI ---

    // ğŸŒ— XÃ¡c Ä‘á»‹nh Ä‘á»™ tá»‘i / sÃ¡ng theo thá»±c táº¿
    let darkness = 0;

    if (hour >= 0 && hour < 4) {
        darkness = 0.6;
    } else if (hour >= 4 && hour < 6) {
        darkness = (6 - hour) / 2 * 0.6; // tá»« 0.6 -> 0
    } else if (hour >= 6 && hour < 11) {
        darkness = 0;
    } else if (hour >= 11 && hour < 13) {
        darkness = -0.1; // sÃ¡ng hÆ¡n bÃ¬nh thÆ°á»ng
    } else if (hour >= 13 && hour < 17) {
        darkness = 0;
    } else if (hour >= 17 && hour < 19) {
        darkness = (hour - 17) / 2 * 0.4; // tá»« 0 -> 0.4
    } else if (hour >= 19 && hour <= 23) {
        darkness = 0.6;
    }

    // ğŸŒ“ Phá»§ tá»‘i hoáº·c lÃ m sÃ¡ng hÆ¡n
    if (darkness > 0) {
        ctx.fillStyle = `rgba(0, 0, 0, ${darkness})`;
        ctx.fillRect(0, 0, w, h);
    } else if (darkness < 0) {
        ctx.fillStyle = `rgba(255, 255, 255, ${-darkness})`;
        ctx.fillRect(0, 0, w, h);
    }

    // â˜€ï¸ / ğŸŒ™ Váº½ biá»ƒu tÆ°á»£ng bÃ¡o ngÃ y / Ä‘Ãªm
    const iconX = 28;
    const iconY = 82; // Vá»‹ trÃ­ máº·t trá»i

    if (hour >= 6 && hour < 18) {
        ctx.beginPath();
        ctx.arc(iconX, iconY, 14, 0, Math.PI * 2);
        ctx.fillStyle = '#FFD966';
        ctx.fill();
        ctx.strokeStyle = '#CC9900';
        ctx.stroke();
    } else {
        ctx.beginPath();
        ctx.arc(iconX, iconY, 12, 0, Math.PI * 2);
        ctx.fillStyle = `rgba(200, 200, 255, 0.8)`;
        ctx.fill();
        ctx.beginPath();
        ctx.arc(iconX - 4, iconY - 2, 10, 0, Math.PI * 2);
        ctx.fillStyle = `rgba(0,0,0,0.6)`;
        ctx.fill();
    }

    // ğŸ•’ Sá»‘ giá» 0-23
    ctx.fillStyle = '#fff';
    ctx.font = '12px Arial';
    ctx.textAlign = 'left';
    ctx.textBaseline = 'middle';
    ctx.fillText(`${hour}`, iconX + 20, iconY);
}
const balloonColors = ['#f87171', '#fbbf24', '#34d399', '#60a5fa', '#c084fc'];
function randomizeBackground() {
    backgroundStars = [];
    backgroundBirds = [];
    backgroundTrees = [];
    backgroundClouds = [];
    backgroundPlanes = [];
    backgroundMushrooms = [];
    backgroundRocks = [];
    backgroundBalloons = [];
    backgroundSeeds = [];
    backgroundBigStars = [];

const bigStarCount = isNight() ? 10 : 3;
for (let i = 0; i < bigStarCount; i++) {
    backgroundBigStars.push([
        Math.random() * worldWidth,
        Math.random() * (worldHeight / 2)
    ]);
}
    // â­ NgÃ´i sao nhá», tráº£i dÃ i ná»­a trÃªn map
const starCount = isNight() ? 300 : 50; // Ban Ä‘Ãªm nhiá»u hÆ¡n, ban ngÃ y Ã­t hÆ¡n
for (let i = 0; i < starCount; i++) {
    backgroundStars.push([
        Math.random() * worldWidth,
        Math.random() * (worldHeight / 2)
    ]);
}
    // ğŸ•Šï¸ Chim, bay á»Ÿ cao trung bÃ¬nh
    for (let i = 0; i < 15; i++) {
        backgroundBirds.push([
            Math.random() * worldWidth,
            50 + Math.random() * 100
        ]);
    }

    // ğŸŒ³ CÃ¢y phÃ­a xa dÆ°á»›i máº·t Ä‘áº¥t
    for (let i = 0; i < 50; i++) {
        backgroundTrees.push([
            Math.random() * worldWidth,
            worldHeight - 150 + Math.random() * 20
        ]);
    }

    // â˜ï¸ MÃ¢y Ä‘Æ¡n giáº£n phÃ­a trÃªn cÃ¢y
for (let i = 0; i < 5; i++) {
    backgroundClouds.push({
        x: Math.random() * worldWidth,
        y: worldHeight - 250 - Math.random() * 200,
        size: 0.5 + Math.random() * 1.5,
        speed: 0.05 + Math.random() * 0.1,
        isDark: Math.random() < 0.2 // 20% lÃ  mÃ¢y xÃ¡m
    });
}
    // âœˆï¸ ğŸ›©ï¸MÃ¡y bay Ä‘Æ¡n giáº£n phÃ­a trÃªn mÃ¢y
const planeIcons = ['âœˆï¸', 'ğŸ›©ï¸', 'ğŸš€'];
// NhÃ³m 1: Dá»c rÃ¬a trÃ¡i world map
for (let i = 0; i < 1; i++) {
    backgroundPlanes.push({
        x: -200 - Math.random() * 200,  // rÃ¬a trÃ¡i ngoÃ i map
        y: worldHeight / 2 + Math.random() * (worldHeight / 2), // giá»¯a xuá»‘ng dÆ°á»›i
        vx: 0.5 + Math.random() * 0.3,
        vy: -0.3 - Math.random() * 0.2,
        size: 0.8 + Math.random() * 1.5,
        opacity: 0.4 + Math.random() * 0.5,
        icon: planeIcons[Math.floor(Math.random() * planeIcons.length)]
    });
}
// NhÃ³m 2: Tráº£i dÃ i phÃ­a dÆ°á»›i toÃ n báº£n Ä‘á»“
for (let i = 0; i < 2; i++) {
    backgroundPlanes.push({
        x: Math.random() * worldWidth,
        y: worldHeight - 100 - Math.random() * 100,
        vx: 0.5 + Math.random() * 0.3,
        vy: -0.3 - Math.random() * 0.2,
        size: 0.8 + Math.random() * 1.5,
        opacity: 0.4 + Math.random() * 0.5,
        icon: planeIcons[Math.floor(Math.random() * planeIcons.length)]
    });
}
    // ğŸ„ Náº¥m dÆ°á»›i Ä‘áº¥t
    for (let i = 0; i < 30; i++) {
        backgroundMushrooms.push([
            Math.random() * worldWidth,
            worldHeight - 70 + Math.random() * 10
        ]);
    }

    // ğŸª¨ ÄÃ¡ nhá» dÆ°á»›i Ä‘áº¥t
    for (let i = 0; i < 30; i++) {
        backgroundRocks.push([
            Math.random() * worldWidth,
            worldHeight - 70 + Math.random() * 10
        ]);
    }

    // ğŸˆ BÃ³ng bay mÃ u ngáº«u nhiÃªn giá»¯a map
for (let i = 0; i < 5; i++) {
    backgroundBalloons.push({
        x: Math.random() * worldWidth,
        y: worldHeight - 300 - Math.random() * 100,
        vx: -0.05 + Math.random() * 0.1, // bay nháº¹ trÃ¡i/pháº£i
        speed: 0.15 + Math.random() * 0.1, // bay lÃªn cháº­m
        color: balloonColors[Math.floor(Math.random() * balloonColors.length)]
    });
}
    // ğŸŒ¼ Hoa bá»“ cÃ´ng anh xuáº¥t hiá»‡n tháº¥p, bay lÃªn cao
for (let i = 0; i < 15; i++) {
    backgroundSeeds.push({
        x: Math.random() * worldWidth,
        y: worldHeight - 300 - Math.random() * 100,
        vx: -0.1 + Math.random() * 0.2, // ngáº«u nhiÃªn tá»« -0.1 (trÃ¡i) -> +0.1 (pháº£i)
        speed: 0.02 + Math.random() * 0.05
    });
}
}
function drawCuteCloud(ctx, x, y, scale = 1, isDark = false) {
    ctx.save();
    ctx.translate(x, y);
    ctx.scale(scale, scale);
    const gradient = ctx.createLinearGradient(0, -20, 0, 20);
    if (isDark) {
        gradient.addColorStop(0, 'rgba(150, 150, 150, 0.5)');
        gradient.addColorStop(1, 'rgba(100, 100, 100, 0.4)');
    } else {
        gradient.addColorStop(0, 'rgba(255, 255, 255, 0.9)');
        gradient.addColorStop(1, 'rgba(230, 230, 230, 0.7)');
    }
    ctx.fillStyle = gradient;
    ctx.beginPath();
    ctx.arc(-30, 0, 20, Math.PI * 0.5, Math.PI * 1.5);
    ctx.arc(0, -20, 35, Math.PI, 0);
    ctx.arc(30, 0, 20, Math.PI * 1.5, Math.PI * 0.5);
    ctx.closePath();
    ctx.shadowColor = 'rgba(0,0,0,0.1)';
    ctx.shadowBlur = 10;
    ctx.shadowOffsetY = 4;
    ctx.fill();
    ctx.restore();
}
if (prevIsNight !== isNight()) {
    randomizeBackground();
    prevIsNight = isNight();
}

function isNight() {
    const hour = Math.floor(dayTime * 24) % 24;
    return hour >= 19 || hour < 6;
}
// HÃ¬nh ná»n
function drawBackground() {
    // ===== Báº¦U TRá»œI =====
    const skyGradient = ctx.createLinearGradient(0, 0, 0, canvas.height);
    skyGradient.addColorStop(0, '#0f172a');
    skyGradient.addColorStop(0.6, '#1e3a8a');
    skyGradient.addColorStop(1, '#60a5fa');
    ctx.fillStyle = skyGradient;
    ctx.fillRect(0, 0, canvas.width, canvas.height);

// ===== SAO NHá» =====
backgroundStars.forEach(([x, y], index) => {
    const flicker = (Math.sin(performance.now() / 1000 + index) + 1) / 2; // 0 ~ 1 cháº­m, nháº¥p nhÃ¡y nháº¹
    const alpha = isNight() ? 0.5 + flicker * 0.5 : 0.1; // ÄÃªm sÃ¡ng 0.5-1, ngÃ y má» nháº¹
    ctx.fillStyle = `rgba(255, 255, 255, ${alpha})`;
    ctx.fillRect(x - camera.x, y - camera.y, 1, 1);
});

// ===== SAO Lá»šN =====
backgroundBigStars.forEach(([x, y], index) => {
    const flicker = (Math.sin(performance.now() / 1500 + index) + 1) / 2; // cháº­m hÆ¡n sao nhá»
    const alpha = isNight() ? 0.7 + flicker * 0.3 : 0.1;
    ctx.fillStyle = `rgba(255, 214, 64, ${alpha})`; // MÃ u vÃ ng nháº¡t giá»‘ng sao tháº­t

    ctx.fillRect(x - 2 - camera.x, y - camera.y, 4, 1);
    ctx.fillRect(x - camera.x, y - 2 - camera.y, 1, 4);
});

    // ===== CHIM =====
    ctx.strokeStyle = 'rgba(255,255,255,0.35)';
    ctx.beginPath();
    backgroundBirds.forEach(([x, y]) => {
        ctx.moveTo(x - camera.x, y - camera.y);
        ctx.lineTo(x + 4 - camera.x, y - 3 - camera.y);
        ctx.lineTo(x + 8 - camera.x, y - camera.y);
    });
    ctx.stroke();

    // ===== CÃ‚Y XA =====
    ctx.fillStyle = '#14532d';
    backgroundTrees.forEach(([x, y]) => {
        ctx.fillRect(x - camera.x, y - camera.y, 4, 40);
        ctx.beginPath();
        ctx.arc(x + 2 - camera.x, y - 10 - camera.y, 10, 0, Math.PI * 2);
        ctx.fill();
    });

    // ===== CÃ‚Y Lá»šN =====
    ctx.fillStyle = '#14532d';
    ctx.fillRect(120 - camera.x, worldHeight - 180 - camera.y, 10, 100);
    ctx.beginPath();
    ctx.arc(125 - camera.x, worldHeight - 180 - camera.y, 30, 0, Math.PI * 2);
    ctx.fill();
    for (let i = 0; i < 3; i++) {
        let x = 160 + i * 20;
        ctx.fillRect(x - camera.x, worldHeight - 130 - camera.y, 5, 50);
        ctx.beginPath();
        ctx.arc(x + 2.5 - camera.x, worldHeight - 130 - camera.y, 10, 0, Math.PI * 2);
        ctx.fill();
    }

    // ===== MÃ‚Y CUTE =====
backgroundClouds.forEach((cloud) => {
    cloud.x += cloud.speed;
    if (cloud.x - camera.x > canvas.width + 150) {
        cloud.x = camera.x - 200;
    }
    drawCuteCloud(ctx, cloud.x - camera.x, cloud.y - camera.y, cloud.size, cloud.isDark);
});
    // ===== MÃY BAY =====
backgroundPlanes.forEach(plane => {
    plane.x += plane.vx;
    plane.y += plane.vy;

    if (plane.x > worldWidth + 300 || plane.y < camera.y - 300) {
        if (Math.random() < 0.5) {
            // Reset kiá»ƒu dá»c rÃ¬a trÃ¡i
            plane.x = -200 - Math.random() * 200;
            plane.y = worldHeight / 2 + Math.random() * (worldHeight / 2);
        } else {
            // Reset kiá»ƒu dÆ°á»›i map tráº£i ngang
            plane.x = Math.random() * worldWidth;
            plane.y = worldHeight - 100 - Math.random() * 100;
        }
        plane.vx = 0.5 + Math.random() * 0.3;
        plane.vy = -0.3 - Math.random() * 0.2;
    }

    const posX = plane.x - camera.x;
    const posY = plane.y - camera.y;

    ctx.save();
    ctx.globalAlpha = plane.opacity;
    ctx.font = `${18 * plane.size}px Arial`;
    ctx.fillText(plane.icon, posX, posY);
    ctx.restore();
});
    // ===== Cá» =====
    ctx.fillStyle = '#16a34a';
    ctx.beginPath();
    ctx.moveTo(0 - camera.x, worldHeight - 80 - camera.y);
    for (let i = 0; i <= worldWidth; i += 30) {
        ctx.lineTo(i + 15 - camera.x, worldHeight - 100 + (i % 60 ? -10 : 10) - camera.y);
    }
    ctx.lineTo(worldWidth - camera.x, worldHeight - 80 - camera.y);
    ctx.lineTo(worldWidth - camera.x, worldHeight - camera.y);
    ctx.lineTo(0 - camera.x, worldHeight - camera.y);
    ctx.closePath();
    ctx.fill();

    // ===== Äáº¤T =====
    ctx.fillStyle = '#fbd38d';
    ctx.fillRect(0 - camera.x, worldHeight - 80 - camera.y, worldWidth, 40);
    ctx.fillStyle = '#d97706';
    ctx.fillRect(0 - camera.x, worldHeight - 40 - camera.y, worldWidth, 4);

    // ===== Náº¤M =====
    backgroundMushrooms.forEach(([x, y]) => {
        ctx.fillStyle = '#b91c1c';
        ctx.beginPath();
        ctx.arc(x - camera.x, y - camera.y, 4, 0, Math.PI);
        ctx.fill();
        ctx.fillStyle = '#92400e';
        ctx.fillRect(x - 1 - camera.x, y - camera.y, 2, 5);
    });

    // ===== ÄÃ =====
    ctx.fillStyle = '#444';
    backgroundRocks.forEach(([x, y]) => {
        ctx.beginPath();
        ctx.ellipse(x - camera.x, y - camera.y, 3, 2, 0, 0, Math.PI * 2);
        ctx.fill();
    });

    // ===== BÃ“NG BAY =====
backgroundBalloons.forEach(balloon => {
    balloon.x += balloon.vx;
    balloon.y -= balloon.speed;

    // Khi bay quÃ¡ cao so vá»›i camera thÃ¬ reset vá» dÆ°á»›i tháº¥p
    if (balloon.y < camera.y + 100) {
        balloon.x = Math.random() * worldWidth;
        balloon.y = worldHeight - 300 - Math.random() * 100;
        balloon.vx = -0.05 + Math.random() * 0.1;
        balloon.speed = 0.15 + Math.random() * 0.1;
    }

    // Váº½ dÃ¢y nhá»
    ctx.strokeStyle = 'rgba(0,0,0,0.5)';
    ctx.beginPath();
    ctx.moveTo(balloon.x - camera.x, balloon.y + 20 - camera.y);
    ctx.lineTo(balloon.x - camera.x, balloon.y + 30 - camera.y);
    ctx.stroke();

    // Váº½ bÃ³ng bay
    ctx.fillStyle = balloon.color;
    ctx.beginPath();
    ctx.ellipse(balloon.x - camera.x, balloon.y - camera.y, 10, 15, 0, 0, Math.PI * 2);
    ctx.fill();

    // Hiá»‡u á»©ng sÃ¡ng nháº¹
    ctx.fillStyle = 'rgba(255,255,255,0.5)';
    ctx.beginPath();
    ctx.ellipse(balloon.x - 4 - camera.x, balloon.y - 6 - camera.y, 2, 4, 0, 0, Math.PI * 2);
    ctx.fill();
});
    // ===== HOA Bá»’ CÃ”NG ANH =====
    ctx.strokeStyle = 'rgba(255,255,255,0.7)';
    ctx.lineWidth = 0.5;
    backgroundSeeds.forEach((seed) => {
        seed.x += seed.vx;
        seed.y -= seed.speed;

        if (seed.y < camera.y + 100) {
            seed.x = Math.random() * worldWidth;
            seed.y = worldHeight - 300 - Math.random() * 100;
            seed.vx = -0.1 + Math.random() * 0.2;
            seed.speed = 0.02 + Math.random() * 0.05;
        }

        let posX = seed.x - camera.x;
        let posY = seed.y - camera.y;

        ctx.beginPath();
        ctx.moveTo(posX, posY);
        ctx.lineTo(posX, posY + 6);
        ctx.stroke();

        ctx.beginPath();
        for (let i = 0; i < 8; i++) {
            let angle = (Math.PI * 2 / 8) * i;
            let endX = posX + Math.cos(angle) * 4;
            let endY = posY + Math.sin(angle) * 2;
            ctx.moveTo(posX, posY);
            ctx.lineTo(endX, endY);
        }
        ctx.stroke();
    });
}
/**
 * Váº½ hiá»‡u á»©ng HÃ o quang Há»— trá»£ dÆ°á»›i chÃ¢n ngÆ°á»i chÆ¡i
 */
function drawSupportAura(ctx) {
    if (!supportAuraActive) return;

    const centerX = player.x;
    const centerY = player.y + player.size - 5;
    const rotationInner = Date.now() / 4000; // Tá»‘c Ä‘á»™ xoay cá»§a hoa vÄƒn bÃªn trong
    const rotationOuter = -Date.now() / 5000; // Tá»‘c Ä‘á»™ xoay ngÆ°á»£c chiá»u cá»§a vÃ²ng ngoÃ i

    // --- Báº¯t Ä‘áº§u váº½ vÃ²ng trÃ²n bÃªn trong (GIá»® NGUYÃŠN) ---
    const radiusXInner = 50;
    const radiusYInner = 25;
    
    ctx.save();
    ctx.beginPath();
    ctx.ellipse(centerX, centerY, radiusXInner, radiusYInner, 0, 0, Math.PI * 2);
    const gradient = ctx.createRadialGradient(centerX, centerY, 0, centerX, centerY, radiusXInner);
    gradient.addColorStop(0, 'rgba(100, 80, 20, 0.5)');
    gradient.addColorStop(1, 'rgba(50, 40, 0, 0.4)');
    ctx.fillStyle = gradient;
    ctx.fill();
    ctx.clip(); 
    
    ctx.strokeStyle = `rgba(255, 215, 0, 0.7)`;
    ctx.lineWidth = 1.5;
    ctx.shadowColor = "gold";
    ctx.shadowBlur = 10;
    
    auraCrackLines.forEach(line => {
        const r_x1 = line.x1 * Math.cos(rotationInner) - line.y1 * Math.sin(rotationInner);
        const r_y1 = line.x1 * Math.sin(rotationInner) + line.y1 * Math.cos(rotationInner);
        const r_x2 = line.x2 * Math.cos(rotationInner) - line.y2 * Math.sin(rotationInner);
        const r_y2 = line.x2 * Math.sin(rotationInner) + line.y2 * Math.cos(rotationInner);
        ctx.beginPath();
        ctx.moveTo(centerX + r_x1, centerY + r_y1 * 0.5);
        ctx.lineTo(centerX + r_x2, centerY + r_y2 * 0.5);
        ctx.stroke();
    });
    ctx.restore();
    // --- Káº¿t thÃºc váº½ vÃ²ng trÃ²n bÃªn trong ---


    // --- (Má»šI) Váº½ vÃ²ng trÃ²n bÃªn ngoÃ i cÃ³ hoa vÄƒn vÃ  xoay ngÆ°á»£c chiá»u ---
    const radiusXOuter = 52; // BÃ¡n kÃ­nh vÃ²ng ngoÃ i lá»›n hÆ¡n
    const radiusYOuter = 26;

    ctx.save();
    // 1. Váº½ viá»n phÃ¡t sÃ¡ng
    ctx.beginPath();
    ctx.ellipse(centerX, centerY, radiusXOuter, radiusYOuter, 0, 0, Math.PI * 2);
    ctx.strokeStyle = `rgba(255, 230, 150, 0.3)`;
    ctx.lineWidth = 2;
    ctx.shadowColor = "gold";
    ctx.shadowBlur = 10;
    ctx.stroke();

    // 2. Váº½ hoa vÄƒn lÃ  cÃ¡c cháº¥m nhá» xoay ngÆ°á»£c chiá»u
    const numDots = 40;
    for (let i = 0; i < numDots; i++) {
        const angle = (Math.PI * 2 / numDots) * i + rotationOuter;
        const dotRadius = 0.5;
        const dotX = centerX + Math.cos(angle) * radiusXOuter;
        const dotY = centerY + Math.sin(angle) * radiusYOuter;

        ctx.beginPath();
        ctx.arc(dotX, dotY, dotRadius, 0, Math.PI * 2);
        ctx.fillStyle = 'rgba(255, 230, 150, 0.8)';
        ctx.fill();
    }
    ctx.restore();
}
function drawAuraLightBeams(ctx) {
    if (!supportAuraActive) return;

    ctx.save();
    auraLightBeams.forEach(beam => {
        const groundY = player.y + player.size - 5;
        const height = 100; // Chiá»u cao cá»§a cá»™t sÃ¡ng

        // Táº¡o gradient má» dáº§n vá» phÃ­a trÃªn
        const gradient = ctx.createLinearGradient(beam.x, groundY, beam.x, groundY - height);
        gradient.addColorStop(0, `rgba(255, 215, 0, ${beam.alpha * 0.5})`);
        gradient.addColorStop(1, `rgba(255, 215, 0, 0)`);
        
        ctx.fillStyle = gradient;
        ctx.fillRect(beam.x - beam.width / 2, groundY - height, beam.width, height);
    });
    ctx.restore();
}
// HÃ m con Ä‘á»ƒ váº½ 2 Ä‘Ã³m sÃ¡ng cho má»™t hiá»‡u á»©ng buff cá»¥ thá»ƒ
function drawSingleBuffEffect(effect) {
    const centerX = player.x;
    const centerY = player.y;
    const baseRadius = player.size + 15;

    // --- TÃ­nh toÃ¡n vá»‹ trÃ­ vÃ  váº½ vá»‡t sÃ¡ng (Trail) ---
    const trailLength = 5;
    for (let i = 1; i <= trailLength; i++) {
        const trailAngle = effect.angle - (0.05 * i);
        const radiusX = baseRadius + Math.sin(trailAngle / 2) * 8;
        const radiusY = baseRadius * 0.6;
        const x1 = centerX + Math.cos(trailAngle) * radiusX;
        const y1 = centerY + Math.sin(trailAngle * 2) * radiusY;
        const x2 = centerX - Math.cos(trailAngle) * radiusX;
        const y2 = centerY - Math.sin(trailAngle * 2) * radiusY;

        const alpha = 1.0 - (i / trailLength);
        ctx.globalAlpha = alpha * 0.5;
        ctx.fillStyle = effect.color;

        ctx.beginPath();
        ctx.arc(x1, y1, 3 - i * 0.5, 0, Math.PI * 2); // KÃ­ch thÆ°á»›c Ä‘Ã³m sÃ¡ng
        ctx.fill();
        ctx.beginPath();
        ctx.arc(x2, y2, 3 - i * 0.5, 0, Math.PI * 2);
        ctx.fill();
    }

    // --- Váº½ ÄÃ³m sÃ¡ng chÃ­nh ---
    ctx.globalAlpha = 1.0;
    const currentRadiusX = baseRadius + Math.sin(effect.angle / 2) * 8;
    const currentRadiusY = baseRadius * 0.6;
    const currentX1 = centerX + Math.cos(effect.angle) * currentRadiusX;
    const currentY1 = centerY + Math.sin(effect.angle * 2) * currentRadiusY;
    const currentX2 = centerX - Math.cos(effect.angle) * currentRadiusX;
    const currentY2 = centerY - Math.sin(effect.angle * 2) * currentRadiusY;

    ctx.fillStyle = effect.color;
    ctx.beginPath();
    ctx.arc(currentX1, currentY1, 3, 0, Math.PI * 2); // KÃ­ch thÆ°á»›c Ä‘Ã³m sÃ¡ng
    ctx.fill();
    ctx.beginPath();
    ctx.arc(currentX2, currentY2, 3, 0, Math.PI * 2);
    ctx.fill();
}
//ğŸ¨ 9. Váº½ khung hÃ¬nh (draw canvas)
function draw() {
  ctx.clearRect(0, 0, canvas.width, canvas.height);
  drawBackground();
  drawBackgroundByTime(ctx);
  ctx.save();
  ctx.translate(-camera.x, -camera.y); // dá»‹ch toÃ n bá»™ há»‡ tá»a Ä‘á»™ theo camera

// ğŸ§± Váº½ tÆ°á»ng dÃ y cÃ³ sá»c chÃ©o
ctx.fillStyle = "#123"; // ná»n tá»‘i
ctx.fillRect(0, 0, worldWidth, wallThickness); // TrÃªn
ctx.fillRect(0, worldHeight - wallThickness, worldWidth, wallThickness); // DÆ°á»›i
ctx.fillRect(0, 0, wallThickness, worldHeight); // TrÃ¡i
ctx.fillRect(worldWidth - wallThickness, 0, wallThickness, worldHeight); // Pháº£i

// ğŸ¨ Váº½ sá»c chÃ©o lÃªn tá»«ng cáº¡nh
drawDiagonalStripes(ctx, 0, 0, worldWidth, wallThickness); // TrÃªn
drawDiagonalStripes(ctx, 0, worldHeight - wallThickness, worldWidth, wallThickness); // DÆ°á»›i
drawDiagonalStripes(ctx, 0, 0, wallThickness, worldHeight); // TrÃ¡i
drawDiagonalStripes(ctx, worldWidth - wallThickness, 0, wallThickness, worldHeight); // Pháº£i
// (Má»šI) Váº½ HÃ o quang Há»— trá»£ dÆ°á»›i chÃ¢n
drawSupportAura(ctx);
drawAuraLightBeams(ctx);
  // 1. Váº¼ CÃC ÄÃ“M SÃNG á» PHÃA SAU PLAYER
  for (const buff in buffEffects) {
      const effect = buffEffects[buff];
      // Kiá»ƒm tra xem Ä‘Ã³m sÃ¡ng cÃ³ Ä‘ang á»Ÿ ná»­a trÃªn quá»¹ Ä‘áº¡o khÃ´ng
      if (effect.active && Math.sin(effect.angle * 2) < 0) {
          ctx.save();
          ctx.shadowColor = effect.color;
          ctx.shadowBlur = 15;
          drawSingleBuffEffect(effect);
          ctx.restore();
      }
  }
  // 2. Váº¼ PLAYER
if (!player.isDying && player.size > 0.1) {
// ğŸ¯ Váº½ tÃªn ngÆ°á»i chÆ¡i trÃªn Ä‘áº§u
ctx.font = "1rem sans-serif";
ctx.fillStyle = "#00ccff"; // ğŸ’™ MÃ u xanh dÆ°Æ¡ng
ctx.shadowColor = "#00ccff";
ctx.shadowBlur = 8;
ctx.textAlign = "center";
ctx.textBaseline = "bottom";
ctx.fillText(player.name, player.x, player.y - player.size - 4); // Váº½ tÃªn trÃªn Ä‘áº§u player
// --- Báº®T Äáº¦U: Váº½ chá»¯ hiá»‡u á»©ng trÃªn Ä‘áº§u player ---
    let buffTextYOffset = player.y - player.size - 20;
    ctx.font = "0.8rem sans-serif";
    ctx.textAlign = "center";
    
    const now = Date.now();
    const isExpActive = now < expBuffEndTime;
    const isCrazyActive = now < crazyBuffEndTime;
    const isPowerActive = now < powerBuffEndTime;
    const isLuckyActive = now < luckyBuffEndTime;
    const isCrazyMadnessActive = now < crazyMadnessTimeEndTime;
    // Váº¼ CRAZYMADNESSTIME
    if (now < crazyMadnessTimeEndTime) {
        ctx.fillStyle = "#0613c5"; // MÃ u xanh dÆ°Æ¡ng
        ctx.shadowColor = "white";
        ctx.shadowBlur = 2;
        ctx.fillText("ğŸ’¢ CrazyMadnessTime", player.x, buffTextYOffset);
        buffTextYOffset -= 18; // Dá»‹ch chá»¯ tiáº¿p theo lÃªn trÃªn
    }
    // Váº½ ExpUp (Má»šI)
    if (isExpActive) {
        ctx.fillStyle = "#ffeb3b"; // MÃ u vÃ ng
        ctx.shadowColor = "white";
        ctx.shadowBlur = 2;
        ctx.fillText("ğŸŒ¿ ExpUp", player.x, buffTextYOffset);
        buffTextYOffset -= 18; // Dá»‹ch chá»¯ tiáº¿p theo lÃªn trÃªn
    }
    
    // Váº½ Crazy
    if (isCrazyActive) {
        ctx.fillStyle = "#f59e0b";
        ctx.shadowColor = "white";
        ctx.shadowBlur = 2;
        ctx.fillText("ğŸ‚ CrazyUp", player.x, buffTextYOffset);
        buffTextYOffset -= 18;
    }
    
    // Váº½ Power
    if (isPowerActive) {
        ctx.fillStyle = "#ef4444";
        ctx.shadowColor = "white";
        ctx.shadowBlur = 2;
        ctx.fillText("ğŸ PowerUp", player.x, buffTextYOffset);
        buffTextYOffset -= 18;
    }

    // Váº½ Lucky
    if (isLuckyActive) {
        ctx.fillStyle = "#22c55e";
        ctx.shadowColor = "white";
        ctx.shadowBlur = 2;
        ctx.fillText("ğŸ€ LuckyUp", player.x, buffTextYOffset);
    }

    ctx.shadowBlur = 0; // Reset hiá»‡u á»©ng
    // --- Káº¾T THÃšC: Váº½ chá»¯ hiá»‡u á»©ng trÃªn Ä‘áº§u player ---
ctx.shadowBlur = 0; // reset sau khi váº½
ctx.shadowColor = "transparent";
// Váº½ hÃ¬nh trÃ²n player
if (disguiseActive) {
    // --- (Má»šI) LOGIC Cáº¢NH BÃO NHáº¤P NHÃY ---
    const remainingTime = disguiseEndTime - Date.now();
    let shouldDraw = true;

    // Náº¿u thá»i gian cÃ²n láº¡i dÆ°á»›i 2 giÃ¢y
    if (remainingTime < 3000 && remainingTime > 0) {
        // Nháº¥p nhÃ¡y má»—i 150 mili giÃ¢y
        if (Math.floor(Date.now() / 150) % 2 === 0) {
            shouldDraw = false;
        }
    }
    
    // Chá»‰ váº½ náº¿u khÃ´ng trong giai Ä‘oáº¡n "táº¯t" cá»§a hiá»‡u á»©ng
    if (shouldDraw) {
        // ğŸ¸ Váº½ áº¿ch thay cho player (logic váº½ giá»¯ nguyÃªn)
        ctx.save();
        ctx.font = "2rem serif";
        ctx.textAlign = "center";
        ctx.textBaseline = "middle";
        ctx.shadowColor = "lime";
        ctx.shadowBlur = 8;
        ctx.globalAlpha = 0.6;
        ctx.fillStyle = "white";
        ctx.fillText("ğŸ¸", player.x, player.y);
        ctx.restore();
    }
} else {
  // ğŸ§ Váº½ player bÃ¬nh thÆ°á»ng
  ctx.beginPath();
  ctx.arc(player.x, player.y, player.size, 0, Math.PI * 2);

  if (levelUpGlowTime > 0) {
    ctx.shadowBlur = 4;
    ctx.shadowColor = "gold";
    ctx.fillStyle = "gold";
  } else {
    ctx.shadowBlur = 0;
    ctx.shadowColor = "transparent";
    ctx.fillStyle = (player.hitTimer % 10 < 5) ? "#ff4c4c" : "#00ff00";
  }
}
  ctx.fill();
  ctx.lineWidth = 2.2;
  ctx.strokeStyle = "rgba(0, 255, 255, 0.4)";
  ctx.shadowColor = "rgba(0, 255, 255, 0.25)";
  ctx.stroke();
    // 3. Váº¼ CÃC ÄÃ“M SÃNG á» PHÃA TRÆ¯á»šC PLAYER
  for (const buff in buffEffects) {
      const effect = buffEffects[buff];
      // Kiá»ƒm tra xem Ä‘Ã³m sÃ¡ng cÃ³ Ä‘ang á»Ÿ ná»­a dÆ°á»›i quá»¹ Ä‘áº¡o khÃ´ng
      if (effect.active && Math.sin(effect.angle * 2) >= 0) {
          ctx.save();
          ctx.shadowColor = effect.color;
          ctx.shadowBlur = 15;
          drawSingleBuffEffect(effect);
          ctx.restore();
      }
  }
      // âœ¨âœ¨ Dá»œI TOÃ€N Bá»˜ KHá»I Váº¼ Máº®T VÃ€ MIá»†NG VÃ€O ÄÃ‚Y âœ¨âœ¨
    if (zombies.length > 0) {
        const target = zombies.reduce((a, b) => distance(a, player) < distance(b, player) ? a : b);
        const angle = Math.atan2(target.y - player.y, target.x - player.x);
        const eyeOffsetX = Math.cos(angle) * (player.size * 0.3); // Äiá»u chá»‰nh theo size
        const eyeOffsetY = Math.sin(angle) * (player.size * 0.3);
        const mouthOffsetX = Math.cos(angle) * (player.size * 0.5);
        const mouthOffsetY = Math.sin(angle) * (player.size * 0.5);

        // Máº¯t trÃ¡i
        ctx.beginPath();
        ctx.arc(player.x + eyeOffsetX - (player.size * 0.2), player.y + eyeOffsetY - (player.size * 0.2), 2, 0, Math.PI * 2);
        ctx.fillStyle = "white";
        ctx.fill();

        // Máº¯t pháº£i
        ctx.beginPath();
        ctx.arc(player.x + eyeOffsetX + (player.size * 0.2), player.y + eyeOffsetY - (player.size * 0.2), 2, 0, Math.PI * 2);
        ctx.fill();

        // Miá»‡ng
        ctx.beginPath();
        ctx.arc(player.x + mouthOffsetX, player.y + mouthOffsetY + (player.size * 0.15), 2, 0, Math.PI);
        ctx.strokeStyle = "white";
        ctx.lineWidth = 1;
        ctx.stroke();
    }
}
if (playerTeleportState.isTeleporting || playerTeleportState.alpha < 1) {
    ctx.restore();
}

// ğŸ­ Váº½ cÃ¡c áº£o áº£nh phÃ¢n thÃ¢n
clones.forEach((c,i) => {
  ctx.save();
  ctx.beginPath();
  ctx.arc(c.x, c.y, player.size * 0.75, 0, Math.PI * 2);
  ctx.fillStyle = "rgba(255, 255, 255, 0.4)";
  ctx.shadowBlur = 8;
  ctx.shadowColor = "#aaaaff";
  ctx.fill();
  ctx.lineWidth = 1.5;
  ctx.strokeStyle = "rgba(0,255,255,0.6)";
  ctx.stroke();
  ctx.restore();

  // ğŸ‘ï¸ Máº¯t cá»§a clone
  ctx.beginPath();
  ctx.arc(c.x - 3, c.y - 5, 1.5, 0, Math.PI * 2);
  ctx.arc(c.x + 3, c.y - 5, 1.5, 0, Math.PI * 2);
  ctx.fillStyle = "white";
  ctx.fill();
// ğŸ‘„ Miá»‡ng clone
  ctx.beginPath();
  ctx.arc(c.x, c.y + 4, 5, 0, Math.PI); // ná»­a cung trÃ²n hÆ°á»›ng lÃªn (miá»‡ng cÆ°á»i)
  ctx.strokeStyle = "rgba(0, 100, 200, 0.6)";
  ctx.lineWidth = 1.2;
  ctx.stroke();
   // ğŸ·ï¸ TÃªn clone (Clone 1, 2, ...)
  ctx.font = "bold 12px Segoe UI";
  ctx.fillStyle = "#00ccff"; // MÃ u xanh dÆ°Æ¡ng
  ctx.textAlign = "center";
  ctx.fillText(`Clone ${i + 1}`, c.x, c.y - 22);
});

  bullets.forEach(b => {
  if (!b.active) return; // ğŸ›¡ bá» qua Ä‘áº¡n Ä‘Ã£ bá»‹ gá»¡
ctx.save();
ctx.translate(b.x, b.y);
    // Náº¿u lÃ  Ä‘áº¡n cá»§a Fairy, váº½ nÃ³ theo kiá»ƒu khÃ¡c
    if (b.isFairyBullet) {
        ctx.fillStyle = 'rgba(100, 255, 150, 0.9)';
        ctx.shadowColor = 'lime';
        ctx.shadowBlur = 8;
        ctx.beginPath();
        ctx.arc(0, 0, 5, 0, Math.PI * 2);
        ctx.fill();
    }
    // 2. Náº¿u lÃ  Ä‘áº¡n CÃ  rá»‘t cá»§a Pet
    else if (b.isPetBullet) {
        ctx.font = "1.2rem serif";
        ctx.textAlign = "center";
        ctx.textBaseline = "middle";
        ctx.fillText(b.icon, 0, 0); // Váº½ icon cÃ  rá»‘t ğŸ¥•
    }
    // 3. CÃ¡c loáº¡i Ä‘áº¡n cÃ²n láº¡i (cá»§a ngÆ°á»i chÆ¡i, clone...)
    else {
        if (b.piercing) {
            b.rotation = (b.rotation || 0) + 0.3;
            ctx.rotate(b.rotation);
            ctx.fillStyle = b.color || "cyan";
            ctx.beginPath();
            ctx.moveTo(-6, -3);
            ctx.lineTo(6, 0);
            ctx.lineTo(-6, 3);
            ctx.closePath();
            ctx.shadowBlur = 4;
            ctx.shadowColor = b.color || "cyan";
            ctx.fill();
        } else {
            ctx.beginPath();
            ctx.arc(0, 0, 5, 0, Math.PI * 2);
            ctx.fillStyle = b.color || "yellow";
            ctx.fill();
        }
    }
    ctx.restore();
});
// Váº½ tia laze cá»§a ngÆ°á»i chÆ¡i
  const eyeOffsetDistance = player.size * 0.4; 

  playerLasers.forEach(laser => {
      // 1. TÃ­nh toÃ¡n vector vuÃ´ng gÃ³c vá»›i hÆ°á»›ng báº¯n Ä‘á»ƒ xÃ¡c Ä‘á»‹nh vá»‹ trÃ­ 2 máº¯t
      const perpAngle = laser.angle + Math.PI / 2;
      const offsetX = Math.cos(perpAngle) * eyeOffsetDistance;
      const offsetY = Math.sin(perpAngle) * eyeOffsetDistance;

      let startX, startY;

      // 2. XÃ¡c Ä‘á»‹nh Ä‘iá»ƒm báº¯t Ä‘áº§u cá»§a tia lazer dá»±a trÃªn lÃ  máº¯t 'trÃ¡i' hay 'pháº£i'
      if (laser.eye === 'left') {
          startX = player.x - offsetX;
          startY = player.y - offsetY;
      } else { // 'right'
          startX = player.x + offsetX;
          startY = player.y + offsetY;
      }

      // 3. Äiá»ƒm káº¿t thÃºc cá»§a tia lazer (ráº¥t xa)
      const endX = startX + Math.cos(laser.angle) * 2000;
      const endY = startY + Math.sin(laser.angle) * 2000;

      // 4. Báº¯t Ä‘áº§u váº½ tia lazer (logic style giá»¯ nguyÃªn)
      ctx.save();
      ctx.beginPath();
      ctx.moveTo(startX, startY);
      ctx.lineTo(endX, endY);
      
      ctx.strokeStyle = "cyan";
      ctx.lineWidth = 4;
      ctx.shadowColor = "cyan";
      ctx.shadowBlur = 10;
      ctx.globalAlpha = laser.life / 20; // Má» dáº§n

      ctx.stroke();
      ctx.restore();
  });

// ğŸ”« Váº½ Ä‘áº¡n tá»« boss & mini boss
enemyBullets.forEach(b => {
  ctx.beginPath();
  ctx.arc(b.x, b.y, 5, 0, Math.PI * 2);
  ctx.fillStyle = "red";
  ctx.fill();
});
// Váº½ bigboss
function drawBigBoss(ctx, z) {
    const { x, y, radius, hp } = z; // Láº¥y cÃ¡c thuá»™c tÃ­nh tá»« 'z' Ä‘á»ƒ dÃ¹ng bÃªn dÆ°á»›i
    ctx.save();
    ctx.translate(x, y);

    // Ãnh sÃ¡ng ná»n
    ctx.beginPath();
    ctx.arc(0, 0, radius + 20, 0, Math.PI * 2);
    ctx.fillStyle = "#123";
    ctx.shadowColor = "#a445f5";
    ctx.shadowBlur = 20;
    ctx.fill();
    ctx.shadowBlur = 0;
    // Hiá»‡u á»©ng vÃ²ng xoÃ¡y bÃªn trong boss
    ctx.save();
    ctx.globalAlpha = 0.08;
    ctx.strokeStyle = "#a445f5";
    ctx.lineWidth = 1;

    const numCircles = 6;
    for (let i = 0; i < numCircles; i++) {
        ctx.beginPath();
        ctx.arc(0, 0, (radius / 6) * (i + 1), 0, Math.PI * 2);
        ctx.stroke();
    }

    ctx.globalAlpha = 1;
    ctx.restore();

    // Tay trÃ¡i
    ctx.beginPath();
    ctx.moveTo(-radius * 0.55, -radius * 0.1);
    ctx.quadraticCurveTo(-radius, 0, -radius * 0.9, radius * 0.3);
    ctx.quadraticCurveTo(-radius * 0.8, radius * 0.1, -radius * 0.5, 0);
    ctx.closePath();
    ctx.fillStyle = "#4e2d6d";
    ctx.fill();

    // Tay pháº£i
    ctx.beginPath();
    ctx.moveTo(radius * 0.55, -radius * 0.1);
    ctx.quadraticCurveTo(radius, 0, radius * 0.9, radius * 0.3);
    ctx.quadraticCurveTo(radius * 0.8, radius * 0.1, radius * 0.5, 0);
    ctx.closePath();
    ctx.fill();

    // ChÃ¢n trÃ¡i (dÃ i hÆ¡n)
    ctx.beginPath();
    ctx.moveTo(-20, radius * 0.4);
    ctx.lineTo(-30, radius * 0.8);
    ctx.lineTo(-10, radius * 0.8);
    ctx.lineTo(0, radius * 0.4);
    ctx.closePath();
    ctx.fill();

    // ChÃ¢n pháº£i (dÃ i hÆ¡n)
    ctx.beginPath();
    ctx.moveTo(20, radius * 0.4);
    ctx.lineTo(30, radius * 0.8);
    ctx.lineTo(10, radius * 0.8);
    ctx.lineTo(0, radius * 0.4);
    ctx.closePath();
    ctx.fill();

    // CÆ¡ thá»ƒ
    ctx.beginPath();
    ctx.moveTo(-radius * 0.6, -radius * 0.1);
    ctx.bezierCurveTo(-radius * 0.75, radius * 0.3, -30, radius * 0.6, 0, radius * 0.5);
    ctx.bezierCurveTo(30, radius * 0.6, radius * 0.75, radius * 0.3, radius * 0.6, -radius * 0.1);
    ctx.closePath();
    ctx.fillStyle = "#4e2d6d";
    ctx.fill();

    // Bá»¥ng rÃ¡ch
    ctx.beginPath();
    ctx.moveTo(-15, 20);
    ctx.lineTo(0, 30);
    ctx.lineTo(15, 20);
    ctx.lineTo(0, 40);
    ctx.closePath();
    ctx.fillStyle = "#8b1f1f";
    ctx.fill();

    // Äáº§u
    ctx.beginPath();
    ctx.ellipse(0, -radius * 0.35, 45, 60, 0, 0, Math.PI * 2);
    ctx.fillStyle = "#6f3c9c";
    ctx.fill();
    ctx.strokeStyle = "#26142e";
    ctx.lineWidth = 3;
    ctx.stroke();

    // Máº¯t Ä‘á» glow
    function eye(x, y) {
        ctx.beginPath();
        ctx.arc(x, y, 8, 0, Math.PI * 2);
        ctx.fillStyle = "#ff3333";
        ctx.shadowColor = "#ff0000";
        ctx.shadowBlur = 12;
        ctx.fill();
        ctx.shadowBlur = 0;
    }
    eye(-18, -radius * 0.4);
    eye(18, -radius * 0.4);

    // LÃ´ng mÃ y
    ctx.strokeStyle = "#2e163a";
    ctx.lineWidth = 3;
    ctx.beginPath();
    ctx.moveTo(-28, -radius * 0.47);
    ctx.lineTo(-8, -radius * 0.5);
    ctx.stroke();
    ctx.beginPath();
    ctx.moveTo(28, -radius * 0.47);
    ctx.lineTo(8, -radius * 0.5);
    ctx.stroke();

    // TÃ³c
    ctx.beginPath();
    ctx.arc(0, -radius * 0.6, 30, Math.PI, 0);
    ctx.fillStyle = "#1e0f2a";
    ctx.fill();

    // MÅ©i
    ctx.beginPath();
    ctx.moveTo(-5, -radius * 0.2);
    ctx.lineTo(0, -radius * 0.15);
    ctx.lineTo(5, -radius * 0.2);
    ctx.fillStyle = "#3a1f4d";
    ctx.fill();

    // Miá»‡ng Ä‘en + rÄƒng nanh Ä‘en
    ctx.beginPath();
    ctx.moveTo(-18, -radius * 0.1);
    ctx.quadraticCurveTo(0, 0, 18, -radius * 0.1);
    ctx.quadraticCurveTo(0, 10, -18, -radius * 0.1);
    ctx.closePath();
    ctx.fillStyle = "#120000";
    ctx.fill();

    // RÄƒng nanh Ä‘en nhá»
    ctx.fillStyle = "#120000";
    function fang(x, y, h, flip = 1) {
        ctx.beginPath();
        ctx.moveTo(x, y);
        ctx.lineTo(x + 3 * flip, y + h);
        ctx.lineTo(x - 3 * flip, y + h);
        ctx.closePath();
        ctx.fill();
    }
    fang(-8, -radius * 0.1 + 5, 6);
    fang(8, -radius * 0.1 + 5, 6);

    // Váº¿t ná»©t Ä‘áº§u
    ctx.beginPath();
    ctx.moveTo(-10, -radius * 0.6);
    ctx.lineTo(-5, -radius * 0.5);
    ctx.lineTo(-15, -radius * 0.4);
    ctx.lineTo(-5, -radius * 0.3);
    ctx.strokeStyle = "#4b2b60";
    ctx.lineWidth = 2;
    ctx.stroke();

    // Sáº¹o máº·t
    ctx.beginPath();
    ctx.moveTo(22, -8);
    ctx.lineTo(18, 3);
    ctx.lineTo(28, 6);
    ctx.strokeStyle = "#8a477e";
    ctx.stroke();

    // Sáº¹o ngá»±c
    ctx.beginPath();
    ctx.moveTo(-18, 28);
    ctx.lineTo(-8, 38);
    ctx.lineTo(-22, 48);
    ctx.stroke();

    // GiÃ¡p vai
    ctx.fillStyle = "#2b2b2b";
    ctx.beginPath();
    ctx.moveTo(-55, -5);
    ctx.quadraticCurveTo(-90, 10, -70, 35);
    ctx.quadraticCurveTo(-40, 20, -35, 25);
    ctx.closePath();
    ctx.fill();

    ctx.beginPath();
    ctx.moveTo(55, -5);
    ctx.quadraticCurveTo(90, 10, 70, 35);
    ctx.quadraticCurveTo(40, 20, 35, 25);
    ctx.closePath();
    ctx.fill();

    // Sá»«ng vá»¡
    function horn(x, y, flip = 1) {
        ctx.beginPath();
        ctx.moveTo(x, y);
        ctx.bezierCurveTo(x + 15 * flip, y - 35, x + 25 * flip, y - 55, x + 10 * flip, y);
        ctx.lineTo(x + 4 * flip, y);
        ctx.closePath();
        ctx.fillStyle = "#444";
        ctx.fill();
        ctx.strokeStyle = "#222";
        ctx.stroke();
    }
    horn(-30, -radius * 0.6, -1);
    horn(30, -radius * 0.6, 1);

    // BOSS + HP
    ctx.font = `${radius * 0.3}px sans-serif`;
    ctx.fillStyle = "violet";
    ctx.textAlign = "center";
    ctx.strokeStyle = "#bb99ff";
    ctx.lineWidth = 2;
    ctx.strokeText(`BOSS ${hp}`, 0, -radius - 30); // ThÃªm viá»n chá»¯
    ctx.fillText(`BOSS ${hp}`, 0, -radius - 30); // TÃªn boss
    // âœ¨ THÃŠM HIá»†U á»¨NG Cáº¢NH BÃO KHI BOSS ÄANG NGáº®M Báº®N
    if (z.isChargingLazer) {
        // Váº½ má»™t tia laser má»ng, má», mÃ u Ä‘á» tá»« boss Ä‘áº¿n ngÆ°á»i chÆ¡i
        const chargeProgress = z.lazerTimer / 2; // 2 lÃ  CHARGE_TIME
        const alpha = 0.3 + chargeProgress * 0.4; // Äá»™ má» tÄƒng dáº§n
        
        ctx.save();
        ctx.beginPath();
        // Äiá»ƒm báº¯t Ä‘áº§u lÃ  giá»¯a 2 máº¯t cá»§a boss
        ctx.moveTo(0, -z.radius * 0.4); 
        // Äiá»ƒm káº¿t thÃºc lÃ  vá»‹ trÃ­ cá»§a ngÆ°á»i chÆ¡i (tÃ­nh tÆ°Æ¡ng Ä‘á»‘i)
        const relativePlayerX = player.x - z.x;
        const relativePlayerY = player.y - z.y;
        ctx.lineTo(relativePlayerX, relativePlayerY);
        
        ctx.strokeStyle = `rgba(255, 0, 0, ${alpha})`;
        ctx.lineWidth = 1;
        ctx.shadowColor = 'red';
        ctx.shadowBlur = 10;
        ctx.stroke();
        ctx.restore();
        }
        ctx.restore();
}
function drawBigBossLazer(ctx, z) {
    if (!z.isBigBoss || !z.isLazerAttacking || z.lazerAngle === undefined) return;

    ctx.save();
    ctx.translate(z.x, z.y);

    // Váº½ vÃ²ng trÃ²n phÃ¡t sÃ¡ng á»Ÿ tÃ¢m báº¯n
    ctx.save();
    ctx.beginPath();
    ctx.arc(0, 0, 28, 0, Math.PI * 2);
    ctx.fillStyle = "rgba(200,100,255,0.18)";
    ctx.shadowColor = "violet";
    ctx.shadowBlur = 22;
    ctx.fill();
    ctx.shadowBlur = 0;
    ctx.restore();

    // Váº½ vÃ²ng trÃ²n nhá» hÆ¡n, Ä‘áº­m hÆ¡n á»Ÿ tÃ¢m
    ctx.save();
    ctx.beginPath();
    ctx.arc(0, 0, 12, 0, Math.PI * 2);
    ctx.fillStyle = "rgba(200,100,255,0.45)";
    ctx.shadowColor = "violet";
    ctx.shadowBlur = 12;
    ctx.fill();
    ctx.shadowBlur = 0;
    ctx.restore();

    // Váº½ tia lazer
    ctx.rotate(z.lazerAngle);
    ctx.strokeStyle = "rgba(200, 100, 255, 0.7)";
    ctx.lineWidth = 8;
    ctx.shadowColor = "violet";
    ctx.shadowBlur = 24;
    ctx.beginPath();
    ctx.moveTo(0, 0);
    const lazerRange = 600; // Äáº£m báº£o biáº¿n nÃ y cÃ³ tá»“n táº¡i
    ctx.lineTo(lazerRange, 0);
    ctx.stroke();
    ctx.restore();

    // âœ¨ THAY Äá»”I: Sá»­ dá»¥ng 'z' thay vÃ¬ 'bigBoss'
    const endX = z.x + Math.cos(z.lazerAngle) * lazerRange;
    const endY = z.y + Math.sin(z.lazerAngle) * lazerRange;
    const glowRadius = 30;

    const glow = ctx.createRadialGradient(endX, endY, 0, endX, endY, glowRadius);
    glow.addColorStop(0, 'rgba(255, 255, 255, 0.8)');
    glow.addColorStop(0.4, 'rgba(128, 0, 128, 0.5)');
    glow.addColorStop(1, 'rgba(128, 0, 128, 0)');

    ctx.fillStyle = glow;
    ctx.beginPath();
    ctx.arc(endX, endY, glowRadius, 0, Math.PI * 2);
    ctx.fill();
}

// Váº½ toÃ n bá»™ zombie hoáº¡t Ä‘á»™ng kÃ¨m icon, HP, tráº¡ng thÃ¡i, biá»ƒu cáº£m (tá»‘i Æ°u fillText)
// VÃ²ng láº·p zombie
zombies.forEach(z => { 
    // âœ¨ Báº®T Äáº¦U ÄOáº N MÃƒ TÄ‚NG HP Má»šI âœ¨
    // Kiá»ƒm tra xem zombie cÃ³ sá»‘ng sÃ³t qua ngÃ y má»›i khÃ´ng
    if (currentDay > z.lastDayBuffed) {
        const hpIncreaseMultiplier = 1.1; // TÄƒng 10% HP má»—i ngÃ y
        // TÄƒng cáº£ HP hiá»‡n táº¡i vÃ  HP gá»‘c Ä‘á»ƒ buff cÃ³ hiá»‡u lá»±c vÄ©nh viá»…n
        z.hp = Math.round(z.hp * hpIncreaseMultiplier);
        z.baseHp = Math.round(z.baseHp * hpIncreaseMultiplier);
        z.lastDayBuffed = currentDay; // Cáº­p nháº­t ngÃ y Ä‘Ã£ Ä‘Æ°á»£c buff
        z.isBuffed = true; // Táº¡o hiá»‡u á»©ng nháº¥p nhÃ¡y trong 60 frame (khoáº£ng 1 giÃ¢y)
    }
    // âœ¨ Káº¾T THÃšC ÄOáº N MÃƒ TÄ‚NG HP Má»šI âœ¨
  if (!z.active) return;
  // ğŸ†• Váº½ BigBoss giá»‘ng Boss nhÆ°ng riÃªng block Ä‘á»ƒ dá»… quáº£n lÃ½
  if (z.isBigBoss) {
    drawBigBoss(ctx, z);
    drawBigBossLazer(ctx, z);
    return;
  }
ctx.save();

// âœ¨ Glow cho Boss hoáº·c MiniBoss
if (z.isBoss || z.type === "miniBoss") {
  ctx.shadowColor = z.color || "#ffffff";
  ctx.shadowBlur = z.isBoss ? 4 : 2;
} else {
  ctx.shadowColor = "transparent";
  ctx.shadowBlur = 0;
}

// ğŸ”µ Náº¿u zombie bá»‹ stun bá»Ÿi lÃ´i
if (z.stunned && Date.now() < z.stunnedUntil) {
  ctx.shadowColor = "#00e5ff";
  ctx.shadowBlur = 8;
  ctx.fillStyle = "#b3f0ff";
}
// ğŸ”¥ Náº¿u zombie bá»‹ trÃºng lá»­a
else if (z.onFireUntil && Date.now() < z.onFireUntil) {
  ctx.shadowColor = "orange";
  ctx.shadowBlur = 8;
  ctx.fillStyle = "#ffb347";
}
// â„ï¸ Náº¿u zombie bá»‹ trÃºng bÄƒng
else if (z.onIceUntil && Date.now() < z.onIceUntil) {
  ctx.shadowColor = "#00e5ff";
  ctx.shadowBlur = 8;
  ctx.fillStyle = "#b3e0ff";
}
else {
  ctx.fillStyle = z.color || "#ff69b4";
}

// ğŸ¯ Váº½ hÃ¬nh trÃ²n zombie
ctx.beginPath();
ctx.arc(z.x, z.y, z.radius, 0, Math.PI * 2);
ctx.fill();
ctx.restore();

// --- Báº®T Äáº¦U ÄOáº N MÃƒ Cáº¦N THÃŠM ---

// Váº½ chi tiáº¿t dá»±a trÃªn style cá»§a zombie
switch (z.style) {
    case "Walker": // Zombie Ä‘i bá»™ thÃ´ng thÆ°á»ng
        ctx.fillStyle = "#333";
        ctx.fillRect(z.x - 5, z.y - 10, 10, 4); // Váº¿t ná»©t trÃªn Ä‘áº§u
        break;

    case "Brute": // Zombie to khá»e, trÃ¢u bÃ²
        ctx.fillStyle = "#4a4a4a"; // GiÃ¡p vai
        ctx.fillRect(z.x - 15, z.y - 8, 30, 8);
        ctx.fillStyle = "darkred"; // Máº¯t Ä‘á»
        ctx.beginPath();
        ctx.arc(z.x, z.y, 4, 0, Math.PI * 2);
        ctx.fill();
        break;

    case "Spitter": // Zombie phun Ä‘á»™c
        ctx.fillStyle = "yellow"; // TÃºi Ä‘á»™c
        ctx.beginPath();
        ctx.arc(z.x, z.y + 4, 8, 0, Math.PI * 2);
        ctx.fill();
        ctx.strokeStyle = "orange";
        ctx.stroke();
        break;

    case "Mutant": // Zombie Ä‘á»™t biáº¿n
        ctx.fillStyle = "purple"; // CÃ¡c khá»‘i u
        ctx.beginPath();
        ctx.arc(z.x - 8, z.y - 8, 6, 0, Math.PI * 2);
        ctx.fill();
        ctx.beginPath();
        ctx.arc(z.x + 10, z.y, 8, 0, Math.PI * 2);
        ctx.fill();
        break;
    case "Cyber":
      ctx.fillStyle = "#00ffff";
      ctx.fillRect(z.x - 10, z.y - 3, 20, 6);
      break;
    case "Hunter":
      ctx.fillStyle = "#654321";
      ctx.fillRect(z.x - 4, z.y - 8, 8, 16);
      ctx.fillStyle = "#432";
      ctx.fillRect(z.x - 6, z.y + 6, 12, 4);
      break;
    case "Shadow":
      ctx.fillStyle = "#333";
      ctx.fillRect(z.x - 10, z.y - 4, 20, 8);
      ctx.fillStyle = "red";
      ctx.fillRect(z.x - 5, z.y - 2, 10, 4);
      break;
    case "Arcanist":
      ctx.fillStyle = "purple";
      ctx.beginPath();
      ctx.arc(z.x, z.y, 12, Math.PI, 2 * Math.PI);
      ctx.fill();
      ctx.fillStyle = "#ff0";
      ctx.fillRect(z.x - 3, z.y - 5, 6, 10);
      break;
    case "Soldier":
      ctx.fillStyle = "green";
      ctx.fillRect(z.x - 10, z.y - 8, 20, 5);
      ctx.fillStyle = "#444";
      ctx.fillRect(z.x - 3, z.y, 6, 12);
      break;
    case "Robot":
      ctx.fillStyle = "red";
      ctx.beginPath();
      ctx.arc(z.x, z.y - 3, 3, 0, Math.PI * 2);
      ctx.fill();
      ctx.fillStyle = "#888";
      ctx.fillRect(z.x - 8, z.y + 4, 16, 4);
      break;
    case "Knight":
      ctx.fillStyle = "#999";
      ctx.beginPath();
      ctx.arc(z.x, z.y - 4, 10, 0, Math.PI);
      ctx.fill();
      ctx.fillStyle = "#555";
      ctx.fillRect(z.x - 6, z.y, 12, 4);
      break;
    case "Rogue":
      ctx.strokeStyle = "orange";
      ctx.lineWidth = 2;
      ctx.beginPath();
      ctx.arc(z.x, z.y, 6, 0, Math.PI * 2);
      ctx.stroke();
      break;
    case "Wraith":
      ctx.fillStyle = "#333";
      ctx.beginPath();
      ctx.arc(z.x, z.y, 14, 0, Math.PI * 2);
      ctx.fill();
      ctx.fillStyle = "aqua";
      ctx.beginPath();
      ctx.arc(z.x, z.y - 4, 2.5, 0, Math.PI * 2);
      ctx.fill();
      break;
    case "Astronaut":
      ctx.strokeStyle = "#ccc";
      ctx.lineWidth = 2;
      ctx.beginPath();
      ctx.arc(z.x, z.y, 14, 0, Math.PI * 2);
      ctx.stroke();
      ctx.fillStyle = "#999";
      ctx.fillRect(z.x - 4, z.y + 2, 8, 4);
      break;
    case "Beast":
      ctx.fillStyle = "brown";
      ctx.fillRect(z.x - 5, z.y + 5, 10, 6);
      ctx.fillStyle = "#333";
      ctx.fillRect(z.x - 3, z.y - 6, 6, 3);
      break;
    case "Spectre":
      ctx.fillStyle = "lime";
      ctx.beginPath();
      ctx.arc(z.x, z.y, 12, 0, Math.PI * 2);
      ctx.fill();
      ctx.strokeStyle = "#0f0";
      ctx.stroke();
      break;
    case "Ninja":
      ctx.fillStyle = "#111";
      ctx.fillRect(z.x - 8, z.y - 8, 16, 16);
      ctx.fillStyle = "red";
      ctx.fillRect(z.x - 4, z.y - 2, 8, 4);
      break;
    case "Samurai":
      ctx.fillStyle = "#444";
      ctx.fillRect(z.x - 10, z.y - 6, 20, 12);
      ctx.strokeStyle = "#c00";
      ctx.strokeRect(z.x - 10, z.y - 6, 20, 12);
      break;
    case "Alien":
      ctx.fillStyle = "lime";
      ctx.beginPath();
      ctx.ellipse(z.x, z.y, 10, 14, 0, 0, Math.PI * 2);
      ctx.fill();
      break;
    case "Skeleton":
      ctx.fillStyle = "#ddd";
      ctx.fillRect(z.x - 6, z.y - 10, 12, 20);
      ctx.strokeStyle = "#000";
      ctx.strokeRect(z.x - 6, z.y - 10, 12, 20);
      break;
    case "Mage":
      ctx.fillStyle = "violet";
      ctx.beginPath();
      ctx.arc(z.x, z.y - 4, 8, 0, Math.PI * 2);
      ctx.fill();
      ctx.fillStyle = "yellow";
      ctx.fillRect(z.x - 2, z.y + 2, 4, 10);
      break;
    case "Ghost":
      ctx.fillStyle = "#aaa";
      ctx.beginPath();
      ctx.arc(z.x, z.y, 14, 0, Math.PI);
      ctx.fill();
      ctx.fillRect(z.x - 14, z.y, 28, 10);
      break;
    case "Monk":
      ctx.fillStyle = "#964B00";
      ctx.fillRect(z.x - 6, z.y - 8, 12, 16);
      ctx.fillStyle = "gold";
      ctx.fillRect(z.x - 3, z.y, 6, 10);
      break;
    case "Cyborg":
      ctx.fillStyle = "#999";
      ctx.fillRect(z.x - 10, z.y - 6, 20, 12);
      ctx.fillStyle = "red";
      ctx.fillRect(z.x + 6, z.y - 2, 4, 4);
      break;
    case "Shaman":
      ctx.fillStyle = "green";
      ctx.beginPath();
      ctx.arc(z.x, z.y, 12, 0, Math.PI * 2);
      ctx.fill();
      ctx.fillStyle = "white";
      ctx.fillRect(z.x - 2, z.y - 8, 4, 16);
      break;
    case "Demon":
      ctx.fillStyle = "darkred";
      ctx.beginPath();
      ctx.arc(z.x, z.y, 14, 0, Math.PI * 2);
      ctx.fill();
      ctx.fillStyle = "#444";
      ctx.fillRect(z.x - 6, z.y, 12, 8);
      break;
    case "Angel":
      ctx.fillStyle = "#fff";
      ctx.beginPath();
      ctx.arc(z.x, z.y, 12, 0, Math.PI * 2);
      ctx.fill();
      ctx.fillStyle = "gold";
      ctx.beginPath();
      ctx.arc(z.x, z.y - 14, 4, 0, Math.PI * 2);
      ctx.stroke();
      break;
    case "Guardian":
      ctx.fillStyle = "#555";
      ctx.fillRect(z.x - 10, z.y - 10, 20, 20);
      ctx.strokeStyle = "yellow";
      ctx.strokeRect(z.x - 10, z.y - 10, 20, 20);
      break;
    case "Pilot":
      ctx.fillStyle = "#005588";
      ctx.fillRect(z.x - 8, z.y - 8, 16, 16);
      ctx.fillStyle = "#eee";
      ctx.fillRect(z.x - 4, z.y - 4, 8, 4);
      break;
    case "Engineer":
      ctx.fillStyle = "#b8860b";
      ctx.fillRect(z.x - 10, z.y - 6, 20, 12);
      ctx.fillStyle = "#222";
      ctx.fillRect(z.x - 2, z.y - 2, 4, 4);
      break;
    case "Android":
      ctx.fillStyle = "#666";
      ctx.fillRect(z.x - 10, z.y - 10, 20, 20);
      ctx.fillStyle = "blue";
      ctx.beginPath();
      ctx.arc(z.x, z.y - 5, 3, 0, Math.PI * 2);
      ctx.fill();
      break;
    case "Starfighter":
      ctx.fillStyle = "#800080";
      ctx.beginPath();
      ctx.moveTo(z.x - 10, z.y + 10);
      ctx.lineTo(z.x, z.y - 10);
      ctx.lineTo(z.x + 10, z.y + 10);
      ctx.closePath();
      ctx.fill();
      break;
    case "Commander":
      ctx.fillStyle = "#333366";
      ctx.fillRect(z.x - 12, z.y - 8, 24, 16);
      ctx.fillStyle = "gold";
      ctx.fillRect(z.x - 8, z.y - 4, 16, 8);
      break;
    case "Medic":
      ctx.fillStyle = "#fff";
      ctx.fillRect(z.x - 10, z.y - 10, 20, 20);
      ctx.fillStyle = "red";
      ctx.fillRect(z.x - 8, z.y - 2, 16, 4);
      ctx.fillRect(z.x - 2, z.y - 8, 4, 16);
      break;
    case "Barbarian":
      ctx.fillStyle = "#8B4513";
      ctx.fillRect(z.x - 8, z.y - 10, 16, 20);
      ctx.fillStyle = "#555";
      ctx.fillRect(z.x - 10, z.y - 12, 20, 4);
      break;
    case "Paladin":
      ctx.fillStyle = "#ffd700";
      ctx.fillRect(z.x - 10, z.y - 10, 20, 20);
      ctx.fillStyle = "#4682B4";
      ctx.fillRect(z.x - 6, z.y - 6, 12, 12);
      break;
    case "Druid":
      ctx.fillStyle = "#228B22";
      ctx.fillRect(z.x - 10, z.y - 10, 20, 20);
      ctx.fillStyle = "brown";
      ctx.fillRect(z.x - 4, z.y - 12, 8, 4);
      break;
    case "Necromancer":
      ctx.fillStyle = "#000";
      ctx.fillRect(z.x - 10, z.y - 10, 20, 20);
      ctx.fillStyle = "darkgreen";
      ctx.beginPath();
      ctx.arc(z.x, z.y - 4, 6, 0, Math.PI * 2);
      ctx.fill();
      break;
    case "Archer":
      ctx.fillStyle = "#556B2F";
      ctx.fillRect(z.x - 8, z.y - 8, 16, 16);
      ctx.strokeStyle = "brown";
      ctx.lineWidth = 2;
      ctx.beginPath();
      ctx.moveTo(z.x + 5, z.y - 10);
      ctx.lineTo(z.x + 15, z.y);
      ctx.stroke();
      break;
    case "Sorcerer":
      ctx.fillStyle = "#8A2BE2";
      ctx.beginPath();
      ctx.arc(z.x, z.y, 15, 0, Math.PI * 2);
      ctx.fill();
      ctx.fillStyle = "#ffff00";
      ctx.beginPath();
      ctx.arc(z.x, z.y, 5, 0, Math.PI * 2);
      ctx.fill();
      break;
    case "Bard":
      ctx.fillStyle = "#DC143C";
      ctx.fillRect(z.x - 8, z.y - 8, 16, 16);
      ctx.fillStyle = "#DAA520";
      ctx.beginPath();
      ctx.arc(z.x, z.y + 8, 6, 0, Math.PI * 2);
      ctx.fill();
      break;
    case "Cleric":
      ctx.fillStyle = "#F8F8FF";
      ctx.fillRect(z.x - 10, z.y - 10, 20, 20);
      ctx.fillStyle = "#B22222";
      ctx.fillRect(z.x - 2, z.y - 10, 4, 20);
      break;
    case "Vampire":
      ctx.fillStyle = "#8B0000";
      ctx.beginPath();
      ctx.ellipse(z.x, z.y, 12, 18, 0, 0, Math.PI * 2);
      ctx.fill();
      ctx.fillStyle = "#fff";
      ctx.fillRect(z.x - 2, z.y + 8, 4, 4);
      break;
    case "Werewolf":
      ctx.fillStyle = "#696969";
      ctx.beginPath();
      ctx.arc(z.x, z.y, 16, 0, Math.PI * 2);
      ctx.fill();
      ctx.fillStyle = "brown";
      ctx.beginPath();
      ctx.moveTo(z.x - 8, z.y - 10);
      ctx.lineTo(z.x - 4, z.y - 16);
      ctx.lineTo(z.x, z.y - 10);
      ctx.fill();
      break;
    case "Goblin":
      ctx.fillStyle = "#3CB371";
      ctx.beginPath();
      ctx.ellipse(z.x, z.y, 10, 15, 0, 0, Math.PI * 2);
      ctx.fill();
      ctx.fillStyle = "#8B4513";
      ctx.beginPath();
      ctx.moveTo(z.x + 6, z.y - 8);
      ctx.lineTo(z.x + 10, z.y - 12);
      ctx.lineTo(z.x + 12, z.y - 8);
      ctx.fill();
      break;
    case "Elf":
      ctx.fillStyle = "#008000";
      ctx.beginPath();
      ctx.ellipse(z.x, z.y, 10, 16, 0, 0, Math.PI * 2);
      ctx.fill();
      ctx.fillStyle = "lightgoldenrodyellow";
      ctx.beginPath();
      ctx.moveTo(z.x + 8, z.y - 10);
      ctx.lineTo(z.x + 14, z.y - 6);
      ctx.lineTo(z.x + 8, z.y - 2);
      ctx.fill();
      break;
    case "Dwarf":
      ctx.fillStyle = "#A52A2A";
      ctx.fillRect(z.x - 10, z.y - 10, 20, 20);
      ctx.fillStyle = "#8B4513";
      ctx.fillRect(z.x - 8, z.y + 6, 16, 8);
      break;
    case "Orc":
      ctx.fillStyle = "#4B0082";
      ctx.beginPath();
      ctx.arc(z.x, z.y, 16, 0, Math.PI * 2);
      ctx.fill();
      ctx.fillStyle = "#00FF7F";
      ctx.beginPath();
      ctx.moveTo(z.x + 5, z.y + 5);
      ctx.lineTo(z.x + 10, z.y + 10);
      ctx.lineTo(z.x + 5, z.y + 15);
      ctx.fill();
      break;
    case "Detective":
      ctx.fillStyle = "#4682B4";
      ctx.fillRect(z.x - 8, z.y - 10, 16, 20);
      ctx.fillStyle = "#333";
      ctx.fillRect(z.x - 10, z.y - 12, 20, 4);
      break;
    case "Swat":
      ctx.fillStyle = "#2F4F4F";
      ctx.fillRect(z.x - 12, z.y - 12, 24, 24);
      ctx.fillStyle = "#808080";
      ctx.fillRect(z.x - 4, z.y - 10, 8, 4);
      break;
    case "Firefighter":
      ctx.fillStyle = "#FF4500";
      ctx.fillRect(z.x - 10, z.y - 10, 20, 20);
      ctx.fillStyle = "#8B0000";
      ctx.fillRect(z.x - 4, z.y - 12, 8, 4);
      break;
    case "Doctor":
      ctx.fillStyle = "#ADD8E6";
      ctx.fillRect(z.x - 10, z.y - 10, 20, 20);
      ctx.fillStyle = "red";
      ctx.fillRect(z.x - 8, z.y - 2, 16, 4);
      ctx.fillRect(z.x - 2, z.y - 8, 4, 16);
      break;
}
// --- Káº¾T THÃšC ÄOáº N MÃƒ Cáº¦N THÃŠM ---

// âš¡ Hiá»‡u á»©ng Ä‘iá»‡n Ä‘á»™ng khi bá»‹ stun bá»Ÿi lÃ´i
if (z.stunnedByThunder && Date.now() < z.stunnedThunderUntil) {
  // Hiá»‡u á»©ng tia Ä‘iá»‡n Ä‘á»™ng
  ctx.save();
  ctx.strokeStyle = "#00ffff"; // Xanh Ä‘iá»‡n sÃ¡ng hÆ¡n
  ctx.lineWidth = 1;
  ctx.shadowColor = "#00ffff";
  ctx.shadowBlur = 8;
  for (let i = 0; i < 2; i++) {
    const angle = Math.random() * Math.PI * 2;
    const r1 = z.radius + 2;
    const r2 = z.radius + 4 + Math.random() * 4;
    ctx.beginPath();
    ctx.moveTo(z.x + Math.cos(angle) * r1, z.y + Math.sin(angle) * r1);
    ctx.lineTo(z.x + Math.cos(angle) * r2, z.y + Math.sin(angle) * r2);
    ctx.stroke();
  }
  ctx.restore();

  // Hiá»‡n chá»¯ "CHOÃNG" ná»•i báº­t trÃªn Ä‘áº§u
  ctx.save();
  ctx.font = "0.8rem Arial";
  ctx.textAlign = "center";
  ctx.textBaseline = "bottom";
  ctx.fillStyle = "#00ffff";
  ctx.shadowColor = "#00ffff";
  ctx.shadowBlur = 12;
  ctx.globalAlpha = 0.92;
  ctx.fillText("ChoÃ¡ng", z.x, z.y - z.radius - 18);
  ctx.globalAlpha = 1;
  ctx.shadowBlur = 0;
  ctx.restore();
}
    // Hiá»‡n chá»¯ "ChÃ¡y" khi zombie bá»‹ Ä‘á»‘t
    if (z.burnEndTime && Date.now() < z.burnEndTime) {
      ctx.save();
      ctx.font = "0.8rem Arial";
      ctx.textAlign = "center";
      ctx.textBaseline = "bottom";
      ctx.fillStyle = "orange"; // MÃ u cam cho hiá»‡u á»©ng chÃ¡y
      ctx.shadowColor = "red";
      ctx.shadowBlur = 10;
      // Váº½ chá»¯ "ChÃ¡y" á»Ÿ cÃ¹ng vá»‹ trÃ­ vá»›i chá»¯ "ChoÃ¡ng"
      ctx.fillText("ChÃ¡y", z.x, z.y - z.radius - 18);
      ctx.restore();
    }

    // Hiá»‡n chá»¯ "Cháº­m" khi zombie bá»‹ lÃ m cháº­m
    if (z.slowEndTime && Date.now() < z.slowEndTime) {
      ctx.save();
      ctx.font = "0.8rem Arial";
      ctx.textAlign = "center";
      ctx.textBaseline = "bottom";
      ctx.fillStyle = "#87ceeb"; // MÃ u xanh da trá»i cho hiá»‡u á»©ng cháº­m
      ctx.shadowColor = "blue";
      ctx.shadowBlur = 10;
      // Váº½ chá»¯ "Cháº­m" á»Ÿ cÃ¹ng vá»‹ trÃ­ vá»›i chá»¯ "ChoÃ¡ng"
      ctx.fillText("Cháº­m", z.x, z.y - z.radius - 18);
      ctx.restore();
    }

// ğŸ”¥ Hiá»‡u á»©ng lá»­a Ä‘á»™ng khi bá»‹ trÃºng lá»­a
if (z.onFireUntil && Date.now() < z.onFireUntil) {
  ctx.save();
  // Lá»›p sÃ¡ng cam phá»§ ngoÃ i (chá»‰ 1 láº§n shadowBlur)
  ctx.globalAlpha = 0.5;
  ctx.beginPath();
  ctx.arc(z.x, z.y, z.radius + 2, 0, Math.PI * 2);
  ctx.fillStyle = "rgba(255,120,0,0.25)";
  ctx.shadowColor = "orange";
  ctx.shadowBlur = 12;
  ctx.fill();
  ctx.shadowBlur = 0;

  // Váº½ 2 ngá»n lá»­a Ä‘á»™ng (fill, khÃ´ng blur)
  for (let i = 0; i < 2; i++) {
    const angle = (Math.PI * 2 / 2) * i + frame / 15;
    const len = 10 + Math.sin(frame / 7 + i + frame / 10) * 3;
    ctx.save();
    ctx.translate(z.x + Math.cos(angle) * (z.radius - 2), z.y + Math.sin(angle) * (z.radius - 2));
    ctx.rotate(angle);
    ctx.beginPath();
    ctx.moveTo(0, 0);
    ctx.quadraticCurveTo(2, -len / 2, 0, -len);
    ctx.quadraticCurveTo(-2, -len / 2, 0, 0);
    ctx.fillStyle = "rgba(255,140,0,0.85)";
    ctx.globalAlpha = 0.8;
    ctx.fill();
    ctx.restore();
  }
  ctx.restore();
}

// â„ï¸ Hiá»‡u á»©ng bÄƒng Ä‘á»™ng khi bá»‹ trÃºng bÄƒng
if (z.onIceUntil && Date.now() < z.onIceUntil) {
  ctx.save();
  // Lá»›p bÄƒng phá»§ ngoÃ i (chá»‰ 1 láº§n shadowBlur)
  ctx.globalAlpha = 0.7;
  ctx.beginPath();
  ctx.arc(z.x, z.y, z.radius + 2, 0, Math.PI * 2);
  ctx.fillStyle = "rgba(180,220,255,0.45)";
  ctx.shadowColor = "#b3e0ff";
  ctx.shadowBlur = 10;
  ctx.fill();
  ctx.shadowBlur = 0;

  // Váº½ 2 tinh thá»ƒ bÄƒng nhá» (fill, khÃ´ng blur)
  for (let i = 0; i < 2; i++) {
    const angle = (Math.PI * 2 / 2) * i + frame / 30;
    const len = 7 + Math.sin(frame / 8 + i) * 1.5;
    ctx.save();
    ctx.translate(z.x + Math.cos(angle) * (z.radius + 4), z.y + Math.sin(angle) * (z.radius + 4));
    ctx.rotate(angle + frame / 40);
    ctx.beginPath();
    ctx.moveTo(0, 0);
    ctx.lineTo(2, -len / 2);
    ctx.lineTo(0, -len);
    ctx.lineTo(-2, -len / 2);
    ctx.closePath();
    ctx.fillStyle = "#e0f7fa";
    ctx.globalAlpha = 0.7;
    ctx.fill();
    ctx.restore();
  }
  ctx.restore();
}
// âœ¨âœ¨ MÃ£ hiá»ƒn thá»‹ tÃªn Ä‘Æ°á»£c thÃªm vÃ o Ä‘Ã¢y âœ¨âœ¨
// Chá»n mÃ u chá»¯: náº¿u lÃ  Tinh Anh thÃ¬ mÃ u Ä‘á», khÃ´ng thÃ¬ mÃ u tráº¯ng
ctx.fillStyle = z.isElite ? "#ff4c4c" : "#fff"; 
ctx.font = "12px sans-serif";
ctx.textAlign = "center";
ctx.shadowBlur = 0;
ctx.fillText(z.style || 'Normal', z.x, z.y + z.radius + 18);

// === ğŸ†• fillText gá»™p toÃ n bá»™ thÃ´ng tin ===
ctx.save();

// ğŸ§  Font chung
ctx.fillStyle = "#fff";
ctx.textAlign = "center";
ctx.textBaseline = "middle";

// ğŸ…°ï¸ Váº½ cáº¥p + HP trÃªn Ä‘áº§u zombie
let levelChar = "";
if (z.isBoss) levelChar = "SS";
else if (z.type === "miniBoss") levelChar = "S";
else levelChar = String.fromCharCode(96 + (z.level || 1));

// âœ¨ Giáº£m kÃ­ch thÆ°á»›c font náº¿u lÃ  boss hoáº·c mini boss
let levelFontSize = z.radius * 0.9; // máº·c Ä‘á»‹nh cho zombie thÆ°á»ng
if (z.type === "miniBoss") levelFontSize = z.radius * 0.6;
if (z.isBoss) levelFontSize = z.radius * 0.5;

ctx.font = `${levelFontSize}px sans-serif`;
ctx.textAlign = "center";
ctx.textBaseline = "middle"; // Vá»‹ trÃ­ icon zombie
ctx.fillStyle = z.color || "#fff";
// 1. Táº¡o chuá»—i HP cÆ¡ báº£n
let hpText = `${levelChar}-${z.hp}`;
// 2. Náº¿u zombie vá»«a Ä‘Æ°á»£c buff, thÃªm dáº¥u "+" vÃ o chuá»—i
if (z.isBuffed) {
    hpText += "*";
}
// 3. Váº½ chuá»—i text cuá»‘i cÃ¹ng lÃªn mÃ n hÃ¬nh
ctx.fillText(hpText, z.x, z.y - z.radius - 8);

// ğŸ§Ÿ Váº½ icon zombie á»Ÿ giá»¯a thÃ¢n
ctx.font = `${z.radius * 1.5}px sans-serif`;
const iconChar = z.isBoss ? "ğŸ’€" : "";
ctx.fillText(iconChar, z.x, z.y);

// ğŸ˜´ Tráº¡ng thÃ¡i (chá»‰ zombie thÆ°á»ng & cÃ³ icon)
// ğŸ¯ Hiá»ƒn thá»‹ icon hÃ nh vi: ğŸ˜¡ khi chasing, ğŸ˜«/ğŸ’¤Zzz khi wandering (30%)
let behaviorIcon = null;
// Boss sáº½ khÃ´ng cÃ³ icon tráº¡ng thÃ¡i
if (!z.isBoss && z.state === "chasing" && z.showStatusIcon) {
  behaviorIcon = "ğŸ˜¡";
} else if (!z.isBoss && z.type !== "miniBoss" && z.state === "wandering") {
  const isSleeping = z.wanderBehavior === "pause";

  // ğŸ’¤ Äang lang thang & Ä‘á»©ng im
  if (isSleeping && isNight()) {
    behaviorIcon = "ğŸ’¤"; // ğŸ’¯ luÃ´n hiá»ƒn thá»‹ khi ban Ä‘Ãªm
  } else if (z.showStatusIcon) {
    behaviorIcon = isSleeping ? "ğŸ’¤" : "ğŸ˜«"; // NgÃ y thÆ°á»ng theo 30%
  }
}
    // Váº½ icon Suy yáº¿u náº¿u cÃ³
    if (z.isWeakened && Date.now() < z.weakenEndTime) {
        ctx.font = `${z.radius}px sans-serif`;
        ctx.textAlign = "right"; // Váº½ bÃªn pháº£i
        ctx.textBaseline = "top";
        ctx.fillStyle = "#ff4c4c"; // MÃ u Ä‘á»
        ctx.fillText("ğŸ’¥â¬‡ï¸", z.x - z.radius * -1, z.y - z.radius * 3);
    }

if (behaviorIcon) {
  ctx.font = `${z.radius}px sans-serif`;
  ctx.textAlign = "left";
  ctx.textBaseline = "top";
  ctx.fillStyle = "#fff";
  ctx.fillText(behaviorIcon, z.x + z.radius * 0.6, z.y - z.radius * 1.2);
}
ctx.restore();

  // ğŸ’¬ Biá»ƒu cáº£m (chá»‰ zombie thÆ°á»ng má»›i cÃ³)
  if (!z.isBoss && z.iconToDraw) {
    ctx.save();
    ctx.font = `${z.radius * 1.2}px serif`;
    ctx.textAlign = "left";
    ctx.textBaseline = "middle";
    ctx.fillStyle = "#fff";
    ctx.shadowColor = "#000";
    ctx.shadowBlur = 4;
ctx.font = `${z.radius}px sans-serif`;
ctx.textAlign = "left";
ctx.textBaseline = "top";
ctx.fillStyle = "#fff";
ctx.fillText(z.iconToDraw, z.x + z.radius * 0.6, z.y - z.radius * 1.2);
    ctx.restore();
}
});

// Váº½ lá»›p khiÃªn náº¿u Ä‘ang hoáº¡t Ä‘á»™ng
function drawHex3D(ctx, x, y, size) {
  const gradient = ctx.createRadialGradient(x, y, size * 0.3, x, y, size);
  gradient.addColorStop(0, "rgba(0,255,255,0.25)");
  gradient.addColorStop(1, "rgba(0,200,255,0.05)");

  ctx.beginPath();
  for (let i = 0; i < 6; i++) {
    const angle = Math.PI / 3 * i;
    const px = x + size * Math.cos(angle);
    const py = y + size * Math.sin(angle);
    if (i === 0) ctx.moveTo(px, py);
    else ctx.lineTo(px, py);
  }
  ctx.closePath();
  ctx.fillStyle = gradient;
  ctx.strokeStyle = "rgba(0,255,255,0.1)";
  ctx.lineWidth = 0.8;
  ctx.fill();
  ctx.stroke();
}

if (player.shieldActive) {
// VÃ²ng trÃ²n ngoÃ i cÃ¹ng
  const pulse = Math.sin(Date.now() / 200) * 2;
  ctx.save();
  ctx.globalAlpha = 0.6;
  ctx.beginPath();
  ctx.arc(player.x, player.y, 48 + pulse, 0, Math.PI * 2);
  ctx.strokeStyle = "rgba(0,200,255,0.7)";
  ctx.lineWidth = 4;
  ctx.shadowColor = "#00eaff";
  ctx.shadowBlur = 10;
  ctx.stroke();
  ctx.restore();

// Váº½ máº¡ng lÆ°á»›i lá»¥c giÃ¡c Ä‘á»u trong khiÃªn
const hexSize = 10;
const spacingX = hexSize * Math.sqrt(3);
const spacingY = hexSize * 1.5;
const radius = 45;
const angleOffset = Date.now() / 3000; // GÃ³c xoay theo thá»i gian

for (let row = -5; row <= 5; row++) {
  for (let col = -5; col <= 5; col++) {
    const offsetX = (row % 2 === 0) ? 0 : spacingX / 2;
    const x0 = col * spacingX + offsetX;
    const y0 = row * spacingY;

    const dx = x0;
    const dy = y0;
    const dist = Math.sqrt(dx * dx + dy * dy);

    if (dist < radius) {
// ğŸ‘‰ Xoay Ä‘iá»ƒm quanh tÃ¢m player
      const angle = angleOffset;
      const rotatedX = dx * Math.cos(angle) - dy * Math.sin(angle);
      const rotatedY = dx * Math.sin(angle) + dy * Math.cos(angle);
      const px = player.x + rotatedX;
      const py = player.y + rotatedY;
      drawHex3D(ctx, px, py, hexSize);
}
}
}
}

// Váº½ vá»‡ tinh laze ğŸ›°ï¸
satellites.forEach(sat => {
  ctx.save();
  ctx.translate(sat.x, sat.y);
  ctx.shadowBlur = 10;
  ctx.shadowColor = "cyan";
  ctx.fillStyle = "white";
  ctx.font = "1.2rem serif";
  ctx.textAlign = "center";
  ctx.textBaseline = "middle";
  ctx.fillText("ğŸ›°ï¸", 0, 0);
  ctx.restore();
});

explosions.forEach(e => {
  ctx.beginPath();
  ctx.arc(e.x, e.y, e.radius, 0, Math.PI * 2);
  ctx.fillStyle = `rgba(255, 200, 0, ${e.life / 20})`;
  ctx.fill();
});
// Váº½ tia laze cho tá»«ng vá»‡ tinh
satellites.forEach(sat => {
  if (sat.laserBeam && sat.laserBeam.life > 0) {
    const x1 = sat.x, y1 = sat.y;
    const angle = sat.laserBeam.angle;
    const x2 = x1 + Math.cos(angle) * 500;
    const y2 = y1 + Math.sin(angle) * 500;

    ctx.save();
    ctx.beginPath();
    ctx.moveTo(x1, y1);
    ctx.lineTo(x2, y2);
    ctx.strokeStyle = "rgba(0, 255, 255, 0.8)";
    ctx.lineWidth = 3;
    ctx.shadowColor = "cyan";
    ctx.shadowBlur = 12;
    ctx.stroke();
    ctx.restore();
  }
});
// Váº½ UFO
if (ufoActive) {
ufos.forEach(ufo => {
    // THÃŠM VÃ€O: Logic kiá»ƒm tra vÃ  Ä‘á»•i hÆ°á»›ng bay
    if (Date.now() > ufo.nextDirectionChangeTime) {
        // Háº¿t giá», táº¡o tá»‘c Ä‘á»™ ngáº«u nhiÃªn má»›i
        ufo.speedX = (Math.random() - 0.5) * 2;
        ufo.speedY = (Math.random() - 0.5) * 0.5;

        // Äáº·t láº¡i má»‘c thá»i gian cho láº§n Ä‘á»•i hÆ°á»›ng tiáº¿p theo
        ufo.nextDirectionChangeTime = Date.now() + ufo.directionChangeInterval;
    }

    // --- Di chuyá»ƒn UFO ---
    ufo.relativeX += ufo.speedX;
    ufo.relativeY += ufo.speedY;

        // --- Giá»¯ UFO trong khung hÃ¬nh (hiá»‡u á»©ng "dá»™i tÆ°á»ng") ---
        // Dá»™i cáº¡nh trÃ¡i/pháº£i
        if (ufo.relativeX < 0 || ufo.relativeX > canvas.width) {
            ufo.speedX *= -1;
        }
        // Dá»™i cáº¡nh trÃªn/dÆ°á»›i (trong má»™t khoáº£ng giá»›i háº¡n)
        if (ufo.relativeY < 120 || ufo.relativeY > 360) {
            ufo.speedY *= -1;
        }

        // --- Logic táº¥n cÃ´ng ---
        if (Date.now() > ufo.laserCooldown) {
            // Tá»a Ä‘á»™ thá»±c cá»§a UFO trÃªn báº£n Ä‘á»“
            const ufoWorldX = camera.x + ufo.relativeX;
            const ufoWorldY = camera.y + ufo.relativeY;
            
            // TÃ¬m zombie gáº§n nháº¥t Ä‘á»ƒ báº¯n
            const target = zombies.find(z => z.active && distance({x: ufoWorldX, y: ufoWorldY}, z) < 400);

            if (target) {
              playSound('sfx-laser', 0.5);
                const angle = Math.atan2(target.y - ufoWorldY, target.x - ufoWorldX);
                ufo.angle = angle; // LÆ°u gÃ³c báº¯n Ä‘á»ƒ váº½ tia laser
                ufo.laserLife = 30; // Tia laser tá»“n táº¡i trong 0.5 giÃ¢y

                // GÃ¢y sÃ¡t thÆ°Æ¡ng cho táº¥t cáº£ zombie trÃªn Ä‘Æ°á»ng báº¯n
                zombies.forEach(z => {
                    if (!z.active) return;
                    const dx = Math.cos(angle), dy = Math.sin(angle);
                    const proj = (z.x - ufoWorldX) * dx + (z.y - ufoWorldY) * dy;
                    const perp = Math.abs((z.x - ufoWorldX) * dy - (z.y - ufoWorldY) * dx);
                    if (proj > 0 && proj < 1200 && perp < 20) {
                        dealDamageToZombie(z, ufo.damage);
                    }
                });
            }
            // Äáº·t láº¡i thá»i gian há»“i chiÃªu
            ufo.laserCooldown = Date.now() + 1500; // Báº¯n má»—i 1.5 giÃ¢y
        }
        
        if (ufo.laserLife > 0) ufo.laserLife--;
    });
}
ufos.forEach(ufo => {
    // TÃ­nh toÃ¡n tá»a Ä‘á»™ váº½ thá»±c táº¿ dá»±a trÃªn camera vÃ  vá»‹ trÃ­ tÆ°Æ¡ng Ä‘á»‘i
    const drawX = camera.x + ufo.relativeX;
    const drawY = camera.y + ufo.relativeY;

    // UFO icon
    ctx.save();
    ctx.translate(drawX, drawY); // <-- DÃ¹ng tá»a Ä‘á»™ má»›i
    ctx.shadowBlur = 10;
    ctx.shadowColor = "red";
    ctx.fillStyle = "white";
    ctx.font = "1.4rem serif";
    ctx.textAlign = "center";
    ctx.textBaseline = "middle";
    ctx.fillText("ğŸ›¸", 0, 0);
    ctx.restore();

    // Tia laser Ä‘á»
    if (ufo.laserLife > 0) {
        const x1 = drawX; // <-- DÃ¹ng tá»a Ä‘á»™ má»›i
        const y1 = drawY; // <-- DÃ¹ng tá»a Ä‘á»™ má»›i
        const laserLength = 1200;
        const x2 = x1 + Math.cos(ufo.angle) * laserLength;
        const y2 = y1 + Math.sin(ufo.angle) * laserLength;

        ctx.save();
        ctx.beginPath();
        ctx.moveTo(x1, y1);
        ctx.lineTo(x2, y2);
        ctx.strokeStyle = "rgba(255, 0, 0, 0.8)";
        ctx.lineWidth = 3;
        ctx.shadowColor = "red";
        ctx.shadowBlur = 15;
        ctx.stroke();
        ctx.restore();
    }
});
// Váº½ cÃ¡c vÃ²ng ná»• phá»¥ cá»§a bom háº¡t nhÃ¢n
extraShockwaves.forEach(sw => {
  ctx.save();
  ctx.beginPath();
  ctx.arc(sw.x, sw.y, sw.radius, 0, Math.PI * 2);
  ctx.strokeStyle = sw.color;
  ctx.globalAlpha = sw.alpha;
  ctx.lineWidth = 3;
  ctx.shadowColor = sw.color;
  ctx.shadowBlur = 12;
  ctx.stroke();
  ctx.restore();
});

drawItems();
drawSupplyDrops();
drawEffects();

// ğŸ¨ Váº½ váº­t pháº©m hiá»‡n cÃ³ trÃªn mÃ n hÃ¬nh
function drawItems() {
  items.forEach(it => {
    if (!it.active) return;
    ctx.save();

    // CÃ i Ä‘áº·t font chá»¯ vÃ  cÄƒn chá»‰nh cho váº­t pháº©m
    ctx.font = "0.9rem serif";
    ctx.textAlign = "center";
    ctx.textBaseline = "middle";
    let icon, color;

    // Chá»n icon vÃ  mÃ u sáº¯c phÃ¹ há»£p vá»›i tá»«ng váº­t pháº©m
    switch (it.type) {
      case 'potion':
        icon = "ğŸ’Š";
        color = "red";
        break;
      case 'lucky':
        icon = "ğŸ€";
        color = "#22c55e";
        break;
      case 'power':
        icon = "ğŸ";
        color = "#ef4444";
        break;
      case 'crazy': 
        icon = "ğŸ‚";
        color = "#f59e0b";
        break;
      case 'exp': 
        icon = "ğŸŒ¿";
        color = "#ffeb3b";
        break;
      // --- Báº®T Äáº¦U PHáº¦N Bá»” SUNG ---
      case 'magnet':
        icon = "ğŸ§²";
        color = "#8b5cf6"; // MÃ u tÃ­m
        break;
      case 'secret':
        icon = "â“";
        color = "#ffeb3b"; // MÃ u vÃ ng
        break;
      case 'expBonus':
        icon = "ğŸŒŸ";
        color = "#ffeb3b"; // MÃ u vÃ ng
        break;
      case 'crazymadnesstime':
        icon = "ğŸ’¢";
        color = "#0613c5"; // MÃ u xanh dÆ°Æ¡ng Ä‘á»“ng bá»™ vá»›i halo vÃ  UI
        break;
      // --- Káº¾T THÃšC PHáº¦N Bá»” SUNG ---
      case 'coin':
        icon = "ğŸª™";
        color = "gold";
        break;
      case 'energy':
        icon = "âš¡";
        color = "gold";
        break;
      case 'mana':
        icon = "ğŸ’ ";
        color = "cyan";
        break;
      case 'hp':
        icon = "â¤ï¸";
        color = "red";
        break;
      case 'box':
        icon = "ğŸ“¦";
        color = "#fff";
        break;
    }

    // Táº¡o hiá»‡u á»©ng nháº¹ (bÃ³ng Ä‘á»• vÃ  chuyá»ƒn Ä‘á»™ng nháº¹ nhÃ ng)
    if (icon) {
        ctx.shadowBlur = 3;
        ctx.shadowColor = color;
        ctx.fillStyle = color;
        const bob = Math.sin(frame / 10 + it.x + it.y) * 2;
        ctx.fillText(icon, it.x, it.y + bob);
    }
    ctx.restore();
  });
}
// ğŸŒ©ï¸ Váº½ tia sÃ©t
function drawLightningBolts() {
    // âœ¨ THAY Äá»”I: Chá»‰ cháº¡y náº¿u má»™t trong hai ká»¹ nÄƒng (BÃ£o sÃ©t hoáº·c LÃ´i) Ä‘ang hoáº¡t Ä‘á»™ng
    if (!lightningActive && !thunderActive) return;
    
    ctx.save();
    
    // Váº½ cÃ¡c Ä‘Ã¡m mÃ¢y cá»§a BÃ£o sÃ©t (náº¿u cÃ³)
    if (lightningActive) {
        lightningBolts.forEach(bolt => {
            ctx.font = "2rem serif";
            ctx.textAlign = "center";
            ctx.textBaseline = "middle";
            ctx.fillStyle = "yellow";
            ctx.shadowColor = "gold";
            ctx.shadowBlur = 8;
            ctx.fillText("ğŸŒ©ï¸", bolt.x, bolt.y);
        });
    }

    // Váº½ cÃ¡c tia sÃ©t Ä‘ang hoáº¡t Ä‘á»™ng (cho cáº£ hai ká»¹ nÄƒng)
    activeLightningStrikes.forEach(strike => {
        if (strike.type === 'chain') {
            const path = strike.path;
            const alpha = strike.life / 30;
            ctx.beginPath();
            ctx.moveTo(path[0].x, path[0].y);
            for (let i = 1; i < path.length; i++) ctx.lineTo(path[i].x, path[i].y);
            ctx.strokeStyle = `rgba(255, 255, 255, ${alpha})`;
            ctx.lineWidth = 1.5;
            ctx.shadowColor = "white";
            ctx.shadowBlur = 10;
            ctx.stroke();
        } else {
            // --- Váº½ SÃ‰T CHÃNH (vÃ ng, dÃ y, tá»« trÃªn trá»i) ---
            const path = strike.path;
            if (path.length < 2) return;
            const endPoint = path[path.length - 1];
            const alpha = strike.life / 60;

            if (strike.life > 35) { 
                ctx.beginPath();
                ctx.arc(endPoint.x, endPoint.y, 20, 0, Math.PI * 2);
                ctx.fillStyle = `rgba(255, 255, 200, ${alpha * 0.8})`;
                ctx.shadowColor = "yellow"; ctx.shadowBlur = 20;
                ctx.fill(); ctx.shadowBlur = 0;
            }
            
            ctx.shadowColor = "yellow"; ctx.shadowBlur = 20;
            for (let i = 1; i < path.length; i++) {
                const p = i / (path.length - 1);
                const lw = 4 * (1 - p);
                ctx.beginPath();
                ctx.moveTo(path[i-1].x, path[i-1].y);
                ctx.lineTo(path[i].x, path[i].y);
                ctx.strokeStyle = `rgba(255, 255, 0, ${alpha * 0.6})`;
                ctx.lineWidth = lw;
                ctx.stroke();
            }
            
            ctx.shadowBlur = 0;
            for (let i = 1; i < path.length; i++) {
                const p = i / (path.length - 1);
                const lw = 1.5 * (1 - p);
                ctx.beginPath();
                ctx.moveTo(path[i-1].x, path[i-1].y);
                ctx.lineTo(path[i].x, path[i].y);
                ctx.strokeStyle = `rgba(255, 255, 255, ${alpha})`;
                ctx.lineWidth = lw;
                ctx.stroke();
            }
        }
    });

    ctx.restore();
}

function drawBlackHole() {
  // ğŸ“¦ Lá»c ra cÃ¡c mÃ¡y bay sáº¯p bá»‹ hÃºt
  const blackHolePlanes = activePlanes.filter(p => p.x > worldWidth - 200);

  if (blackHolePlanes.length === 0) return; // âŒ KhÃ´ng cÃ³ mÃ¡y bay nÃ o gáº§n há»‘ Ä‘en thÃ¬ khÃ´ng váº½

  // ğŸ“ XÃ¡c Ä‘á»‹nh vá»‹ trÃ­ há»‘ Ä‘en dá»±a trÃªn mÃ¡y bay gáº§n nháº¥t
  const blackHoleX = worldWidth - 100;

  // ğŸ¯ TÃ­nh trung bÃ¬nh Ä‘á»™ cao cÃ¡c mÃ¡y bay Ä‘ang tá»›i gáº§n
  const blackHoleY = blackHolePlanes.reduce((sum, p) => sum + p.y, 0) / blackHolePlanes.length;

  // ğŸ”µ Hiá»‡u á»©ng phá»“ng nháº¹
  const pulse = Math.sin(Date.now() / 300);
  const radius = 40 + pulse * 5;

  // ğŸ¨ Váº½ há»‘ Ä‘en
  ctx.save();
  ctx.beginPath();
  ctx.arc(blackHoleX, blackHoleY, radius, 0, Math.PI * 2);
  ctx.fillStyle = "black";
  ctx.shadowColor = "purple";
  ctx.shadowBlur = 20;
  ctx.fill();
  ctx.restore();
}
if (petRabbit && petActive) {
  const { x, y, radius } = petRabbit;

  /* â€” thÃ¢n â€” */
  ctx.beginPath();
  ctx.arc(x, y, radius, 0, Math.PI * 2);
  ctx.fillStyle   = "#fff0fa";   // thÃ¢n tráº¯ng-há»“ng
  ctx.fill();
  ctx.strokeStyle = "#ff7ad9";   // viá»n há»“ng nháº¡t
  ctx.lineWidth   = 2;
  ctx.stroke();

  /* â€” tai â€” */
  ctx.beginPath();
  ctx.ellipse(x - 6, y - 18, 3, 6, 0, 0, Math.PI * 2);
  ctx.ellipse(x + 6, y - 18, 3, 6, 0, 0, Math.PI * 2);
  ctx.fill();
  ctx.stroke();

  /* â€” máº¯t â€” */
  ctx.beginPath();
  ctx.arc(x - 4, y - 3, 1.5, 0, Math.PI * 2);
  ctx.arc(x + 4, y - 3, 1.5, 0, Math.PI * 2);
  ctx.fillStyle = "#000";
  ctx.fill();

  /* â€” miá»‡ng â€” */
  ctx.beginPath();
  ctx.arc(x, y + 4, 2, 0, Math.PI);
  ctx.strokeStyle = "#000";
  ctx.stroke();

  /* â€” tÃªn â€œThá»â€ â€” */
  ctx.font         = "0.8rem sans-serif";
  ctx.fillStyle    = "#ff7ad9";   // cÃ¹ng mÃ u viá»n
  ctx.shadowColor  = "#ff7ad9";
  ctx.shadowBlur   = 8;
  ctx.textAlign    = "center";
  ctx.textBaseline = "bottom";
  ctx.fillText("Thá»", x, y - radius - 10);
  ctx.shadowBlur   = 0;
  ctx.shadowColor  = "transparent";
}

// ================== Váº¼ Cá»”NG KHÃ”NG GIAN ==================
if (spaceGateActive && spaceGate && spaceGate.radius > 0.1) { // Sá»­ dá»¥ng radius > 0.1
    ctx.save();
    // Ãp dá»¥ng hiá»‡u á»©ng má» dáº§n khi cá»•ng má»›i xuáº¥t hiá»‡n
    ctx.globalAlpha = spaceGate.alpha;

    const x = spaceGate.x;
    const y = spaceGate.y;
    const radius = spaceGate.radius;

    // Lá»›p hÃ o quang bÃªn ngoÃ i
// Lá»›p hÃ o quang bÃªn ngoÃ i
const pulse = Math.sin(frame * 0.1) * 5;
ctx.beginPath();
// âœ¨ Sá»¬A Lá»–I: DÃ¹ng Math.max Ä‘á»ƒ Ä‘áº£m báº£o bÃ¡n kÃ­nh khÃ´ng bao giá» Ã¢m
ctx.arc(x, y, Math.max(0, radius + pulse), 0, Math.PI * 2); 
ctx.fillStyle = `rgba(255, 100, 0, 0.2)`;
ctx.fill();

    // VÃ²ng xoÃ¡y lá»­a trung tÃ¢m
    const gradient = ctx.createRadialGradient(x, y, 0, x, y, radius);
    gradient.addColorStop(0, 'rgba(255, 255, 180, 0.9)');
    gradient.addColorStop(0.5, 'rgba(255, 180, 0, 0.8)');
    gradient.addColorStop(1, 'rgba(200, 50, 0, 0.5)');
    
    ctx.beginPath();
    ctx.arc(x, y, radius, 0, Math.PI * 2);
    ctx.fillStyle = gradient;
    ctx.fill();

    // Viá»n ngoÃ i phÃ¡t sÃ¡ng
    ctx.beginPath();
    ctx.arc(x, y, radius, 0, Math.PI * 2);
    ctx.strokeStyle = "gold";
    ctx.lineWidth = 3;
    ctx.shadowColor = "orange";
    ctx.shadowBlur = 15;
    ctx.stroke();

    // CÃ¡c tia lá»­a xoÃ¡y bÃªn trong
    ctx.strokeStyle = "rgba(255, 255, 255, 0.6)";
    ctx.lineWidth = 1.5;
    ctx.shadowColor = "yellow";
    ctx.shadowBlur = 15;
    for (let i = 0; i < 4; i++) {
        ctx.beginPath();
        const startAngle = spaceGate.rotation + (i * Math.PI / 2);
        const endAngle = startAngle + Math.PI * 0.8;
        ctx.arc(x, y, radius * (0.3 + (i * 0.15)), startAngle, endAngle);
        ctx.stroke();
    }
    
    ctx.restore();
}

// Äoáº¡n nÃ y xá»­ lÃ½ viá»‡c lÃ m má» ngÆ°á»i chÆ¡i khi dá»‹ch chuyá»ƒn, giá»¯ nguyÃªn
if (playerTeleportState.isTeleporting || playerTeleportState.alpha < 1) {
    ctx.save();
    ctx.globalAlpha = playerTeleportState.alpha;
}

drawParticles(ctx);

drawBloodOrb(ctx);
drawBlackHole();
drawLightningBolts(); // ğŸŒ©ï¸ Váº½ tia sÃ©t
updateAndDrawHealEffects();
ctx.restore(); // káº¿t thÃºc dá»‹ch chuyá»ƒn camera
drawMiniMap();
// ğŸ¨ Váº½ báº£n Ä‘á»“ thu nhá»
}

// ğŸ¨ Váº½ táº¥t cáº£ hiá»‡u á»©ng ká»¹ nÄƒng gá»n láº¡i
function drawEffects() {
  // === THÃŠM VÃ€O: Váº¼ ÄÃM MÃ‚Y Cá»¦A MÆ¯A KIáº¾M ===
    swordRainClouds.forEach(cloud => {
        ctx.save();
        // Vá»‹ trÃ­ váº½ = vá»‹ trÃ­ camera + vá»‹ trÃ­ tÆ°Æ¡ng Ä‘á»‘i cá»§a mÃ¢y
        const drawX = camera.x + cloud.relativeX;
        const drawY = camera.y + cloud.relativeY;
        
        ctx.font = "2rem serif";
        ctx.fillStyle = "rgba(255, 255, 255, 0.9)";
        ctx.shadowColor = "rgba(0, 0, 0, 0.3)";
        ctx.shadowBlur = 2;
        ctx.textAlign = "center";
        ctx.textBaseline = "middle";
        ctx.fillText("â˜ï¸", drawX, drawY);
        ctx.restore();
    });
    // âœ¨ ThÃªm vÃ²ng láº·p nÃ y vÃ o Ä‘á»ƒ váº½ cÃ¡c Fairy
    fairies.forEach(fairy => {
        ctx.save();
        ctx.font = "1.2rem serif";
        ctx.textAlign = "center";
        ctx.textBaseline = "middle";
        ctx.shadowColor = "cyan";
        ctx.shadowBlur = 15;
        ctx.fillStyle = 'white'; 
        ctx.fillText("ğŸ¦‹", fairy.x, fairy.y);
        ctx.restore();
    });
    
  fireballs.forEach(f => {
    ctx.save();
    ctx.translate(f.x, f.y);
    ctx.shadowBlur = 8;
    ctx.shadowColor = "orange";
    ctx.fillStyle = "orange";
    ctx.font = "1.3rem serif";
    ctx.textAlign = "center";
    ctx.textBaseline = "middle";
    ctx.fillText("ğŸ”¥", 0, 0);
    ctx.restore();
  });

  iceballs.forEach(f => {
    ctx.save();
    ctx.translate(f.x, f.y);
    ctx.shadowBlur = 8;
    ctx.shadowColor = "#00e5ff";
    ctx.fillStyle = "#00e5ff";
    ctx.font = "1.3rem serif";
// ctx.font = (f.radius * 0.9) + " serif"; Ká»¹ nÄƒng to ra khi lÃªn level
    ctx.textAlign = "center";
    ctx.textBaseline = "middle";
    ctx.fillText("â„ï¸", 0, 0);
    ctx.restore();
  });
// Váº½ quáº£ cáº§u lÃ´i
if (thunderActive) {
  thunderBalls.forEach(f => {
    ctx.save();
    ctx.translate(f.x, f.y);
    ctx.shadowBlur = 8;
    ctx.shadowColor = "#00e5ff";
    ctx.fillStyle = "#00e5ff";
    ctx.font = "1rem serif";
    ctx.textAlign = "center";
    ctx.textBaseline = "middle";
    ctx.fillText("ğŸ”µ", 0, 0);
    // Hiá»‡u á»©ng Ä‘iá»‡n xung quanh
    for (let i = 0; i < 6; i++) {
      const angle = (Math.PI * 2 / 6) * i + frame / 10;
      ctx.beginPath();
      ctx.arc(Math.cos(angle) * 12, Math.sin(angle) * 12, 2, 0, Math.PI * 2);
      ctx.fillStyle = "#b3f0ff";
      ctx.fill();
    }
    ctx.restore();
  });
}

swords.forEach(s => {
    ctx.save();
    ctx.translate(s.x, s.y);
    if (s.state === 'charging') {
  ctx.shadowBlur = 8; // Hiá»‡u á»©ng bÃ³ng má»
  ctx.shadowColor = '#00ffff';
  ctx.fillStyle = '#00ffff';
} else {
  ctx.shadowBlur = 0;
  ctx.fillStyle = 'white';
}
    ctx.font = "1.2rem serif";
//ctx.font = (s.radius * 0.9) + " serif";
    ctx.textAlign = "center";
    ctx.textBaseline = "middle";
    ctx.fillText("ğŸ”ª", 0, 0);
    ctx.restore();
  });

downwardSwords.forEach(s => {
  ctx.save();
  ctx.translate(s.x, s.y);
  ctx.shadowBlur = 8;
  ctx.shadowColor = '#00ffff';
  ctx.fillStyle = 'white';
  ctx.font = "1.2rem serif";
  ctx.textAlign = "center";
  ctx.textBaseline = "middle";
  ctx.fillText("âš”ï¸", 0, 0);
  ctx.restore();
});
// Váº½ tÃªn lá»­a
missiles.forEach(m => {
  ctx.save();
  ctx.translate(m.x, m.y);
  ctx.shadowColor = m.state === "delay" ? "gray" : "orange";
  ctx.shadowBlur = 8;
  ctx.fillStyle = "white";
  ctx.font = "1.3rem serif";
  ctx.textAlign = "center";
  ctx.textBaseline = "middle";
  ctx.fillText("ğŸš€", 0, 0);
  ctx.restore();
});

// ğŸ’£ B52 Bombs + ğŸ›¬ MÃ¡y bay
ctx.save();
ctx.textAlign = "center";
ctx.textBaseline = "middle";
ctx.font = "1.3rem serif";
ctx.shadowBlur = 8;
ctx.shadowColor = "black";

// ğŸ›¬ Váº½ mÃ¡y bay Ä‘ang hoáº¡t Ä‘á»™ng
activePlanes.forEach(plane => {
  ctx.fillStyle = "cyan";
ctx.save();
  ctx.shadowBlur = 4;
  ctx.shadowColor = "cyan";
ctx.translate(plane.x, plane.y);
ctx.scale(plane.scale ?? 1, plane.scale ?? 1);
ctx.globalAlpha = plane.opacity ?? 1;
ctx.fillText("ğŸ›¬", 0, 0);
ctx.restore();
});

// ğŸ’£ Váº½ tá»«ng quáº£ bom Ä‘ang rÆ¡i hoáº·c sáº¯p ná»•
bombsB52.forEach(bomb => {
  if (bomb.exploded) return;
  ctx.fillStyle = bomb.landed ? "orange" : "white";
  ctx.fillText("ğŸ’£", bomb.x, bomb.y);
});

ctx.restore();
// â˜¢ï¸ Váº½ bom háº¡t nhÃ¢n
nuclearBombs.forEach(bomb => {
// ----------- Váº½ bom háº¡t nhÃ¢n khi chÆ°a ná»• -----------
if (!bomb.exploded) {
  let offsetX = 0, offsetY = 0;

  // ğŸ”” Náº¿u cÃ²n â‰¤ 3 giÃ¢y vÃ  Ä‘Ã£ cháº¡m Ä‘áº¥t â†’ rung láº¯c
  if (bomb.landed && bomb.timerAfterLand <= 180) {
    offsetX = (Math.random() - 0.5) * 4;
    offsetY = (Math.random() - 0.5) * 4;
  }

  ctx.save();
  // Váº½ icon bom â˜¢ï¸ to, sÃ¡ng (cÃ³ rung)
  ctx.font = "2.2rem serif";
  ctx.textAlign = "center";
  ctx.textBaseline = "middle";
  ctx.shadowBlur = 12;
  ctx.shadowColor = "orange";
  ctx.fillStyle = "white";
  ctx.fillText("â˜¢ï¸", bomb.x + offsetX, bomb.y + offsetY);

  // -- Náº¿u Ä‘Ã£ cháº¡m Ä‘áº¥t, váº½ icon ğŸ’¥ vÃ  giÃ¢y countdown náº±m ngang --
  if (bomb.landed) {
    const baseY = bomb.y - 35;
    const iconX = bomb.x - 1;
    const secX  = bomb.x + 1;

    // Váº½ icon ğŸ’¥ nhá»
    ctx.font = "1rem serif";
    ctx.shadowBlur = 2;
    ctx.textAlign = "right";
    ctx.fillStyle = "#ffb300";
    ctx.fillText("ğŸ’¥", iconX, baseY);

    // Váº½ sá»‘ giÃ¢y nhá», mÃ u Ä‘á»
    ctx.font = "1rem sans-serif";
    ctx.fillStyle = "#ff3333";
    ctx.textAlign = "left";
    let sec = Math.max(1, Math.ceil(bomb.timerAfterLand / 60));
    ctx.fillText(`${sec}`, secX, baseY - 2);
  }

  ctx.restore();
}

// ----------- Váº½ hiá»‡u á»©ng sÃ³ng xung kÃ­ch khi bom phÃ¡t ná»• -----------
if (bomb.exploded && bomb.shockwave) {
// Hiá»‡u á»©ng vÃ²ng ná»• chÃ­nh â€“ nÃ©t to, vÃ ng Ä‘áº­m rÃµ rÃ ng
  ctx.save();
  ctx.beginPath();
  ctx.arc(bomb.x, bomb.y, bomb.shockwaveRadius, 0, Math.PI * 2);
  ctx.strokeStyle = "rgba(255, 222, 44, 0.88)";   // VÃ ng tÆ°Æ¡i, gáº§n nhÆ° vÃ ng nguyÃªn cháº¥t
  ctx.lineWidth = 16;
  ctx.shadowBlur = 32;
  ctx.shadowColor = "#ffec70";
  ctx.globalAlpha = 0.58; // Äáº­m vÃ  rÃµ
  ctx.stroke();
  ctx.restore();

  // Viá»n ngoÃ i phá»¥ - vÃ ng tráº¯ng, rÃµ hÆ¡n, táº¡o cáº£m giÃ¡c â€œhÃ o quangâ€
  ctx.save();
  ctx.beginPath();
  ctx.arc(bomb.x, bomb.y, bomb.shockwaveRadius + 8, 0, Math.PI * 2);
  ctx.strokeStyle = "rgba(255,255,180,0.73)";
  ctx.lineWidth = 7;
  ctx.shadowBlur = 28;
  ctx.shadowColor = "#fffbe2";
  ctx.globalAlpha = 0.45;
  ctx.stroke();
  ctx.restore();
}
});
blackHoles.forEach(h => {
  ctx.save();
  ctx.beginPath();
  ctx.arc(h.x, h.y, h.radius, 0, Math.PI * 2);
  ctx.fillStyle = "rgba(0, 0, 0, 0.5)";
  ctx.shadowColor = "purple";
  ctx.shadowBlur = 20;
  ctx.fill();
  ctx.closePath();

  // Icon giá»¯a há»‘ Ä‘en
  ctx.font = "2rem serif";
  ctx.fillStyle = "#fff";
  ctx.textAlign = "center";
  ctx.textBaseline = "middle";
  ctx.fillText("ğŸ•³ï¸", h.x, h.y);
  ctx.restore();
});
// Váº½ lazer cho clone
activeCloneLasers.forEach(laser => {
    // TÃ¬m clone Ä‘Ã£ báº¯n ra tia lazer nÃ y báº±ng ID
    const firingClone = clones.find(c => c.id === laser.cloneId);

    // Chá»‰ váº½ tia lazer náº¿u clone Ä‘Ã³ cÃ²n tá»“n táº¡i
    if (firingClone) {
        ctx.save();
        ctx.beginPath();
        // Äiá»ƒm báº¯t Ä‘áº§u cá»§a lazer lÃ  vá»‹ trÃ­ HIá»†N Táº I cá»§a clone
        ctx.moveTo(firingClone.x, firingClone.y);
        ctx.lineTo(laser.endX, laser.endY);
        
        ctx.strokeStyle = `rgba(255, 100, 255, ${laser.life / 120})`;
        ctx.lineWidth = 6;
        ctx.shadowColor = "#ff00ff";
        ctx.shadowBlur = 20;
        
        ctx.stroke();
        ctx.restore();
    }

  });
}

//ğŸ” 10. VÃ²ng láº·p chÃ­nh vÃ  khá»Ÿi táº¡o game
let fps = 0, lastFrameTime = performance.now(), frameCount = 0, lastFpsUpdate = performance.now(); // biáº¿n cáº­p nháº­t FPS

function loop() {
  updateDayNight(); // <-- chá»‰ gá»i 1 láº§n á»Ÿ Ä‘Ã¢y trÃ¡nh láº·p láº¡i
  const now = performance.now();
  frameCount++;

// Cáº­p nháº­t FPS má»—i 500ms
if (now - lastFpsUpdate >= 500) {
    fps = Math.round((frameCount * 1000) / (now - lastFpsUpdate));
    const fpsText = `FPS: ${fps}`;
if (fpsText !== lastFpsText) {
  lastFpsText = fpsText;
  document.getElementById("fpsCounter").innerText = fpsText;
}
    frameCount = 0;
    lastFpsUpdate = now;
}

  update();
  draw();
  frame++;
  
if (frame % 60 === 0 && gameStarted) {
// Giá»›i háº¡n zombie tá»‘i Ä‘a lÃ  200 - Sá»‘ lÆ°á»£ng zombie hiá»‡n táº¡i
if (zombies.length < 200) {
    const spawnCount = Math.min(1, 200 - zombies.length);
    for (let i = 0; i < spawnCount; i++) {
    spawnZombie();
}
}
}
requestAnimationFrame(loop);
}

// â–¶ï¸ Khá»Ÿi cháº¡y ban Ä‘áº§u
spawnZombie();
loop();

//ğŸ§¼ 11. CÃ¡c Ä‘oáº¡n khá»Ÿi táº¡o UI sau canvas
// HÃ m báº¯t Ä‘áº§u game
function startGame() {
  playSound('sfx-game-start', 0.3); // PhÃ¡t Ã¢m thanh báº¯t Ä‘áº§u game
//  spawnBigBoss(); // chá»‰ Ä‘á»ƒ test

  randomizeBackground();
  // Hiá»ƒn thá»‹ tá»•ng Ä‘iá»ƒm
  document.getElementById("highScoreDisplay").innerText = `ğŸ† Ká»· lá»¥c: ${localStorage.getItem('highScore') || 0}`;
  const nameInput = document.getElementById("playerNameInput");
  player.name = nameInput.value.trim() || "Player";
  document.getElementById("startMenu").style.display = "none";
  gameStarted = true;
  waveTimer = waveTime;
  // THÃŠM DÃ’NG NÃ€Y Äá»‚ Báº¬T NHáº C Ná»€N
  playRandomNormalMusic(); // Báº¯t Ä‘áº§u phÃ¡t nháº¡c ngáº«u nhiÃªn
  showUpgradePopup();        // ğŸ Gá»i nÃ¢ng cáº¥p trÆ°á»›c
  pendingWave = wave;        // ğŸŒŠ Wave sáº½ hiá»ƒn thá»‹ sau khi nÃ¢ng cáº¥p xong
}
/**
 * Thiáº¿t láº­p láº¡i toÃ n bá»™ tráº¡ng thÃ¡i cá»§a game Ä‘á»ƒ báº¯t Ä‘áº§u má»™t lÆ°á»£t chÆ¡i má»›i.
 * HÃ m nÃ y khÃ´ng táº£i láº¡i trang, giÃºp tiáº¿t kiá»‡m thá»i gian vÃ  tÃ i nguyÃªn.
 */
function resetGame() {
    console.log("Resetting game state...");

    // 1. áº¨n cÃ¡c giao diá»‡n khÃ´ng cáº§n thiáº¿t
    document.getElementById('gameOverPanel').classList.remove('visible');
    document.getElementById('pauseMenu').classList.add('hidden');
    
    // 2. Reset cÃ¡c biáº¿n tráº¡ng thÃ¡i cá»‘t lÃµi cá»§a game
    gameOver = false;
    isPaused = false;
    gameStarted = true; // Game Ä‘Æ°á»£c báº¯t Ä‘áº§u ngay láº­p tá»©c
    wave = 1;
    waveTimer = waveTime;
    lastWaveTime = Date.now();
    frame = 0;
    currentDay = 1;
    dayTime = 0.25; // Reset láº¡i thá»i gian trong ngÃ y vá» 6h sÃ¡ng
    zombieSpawnedCount = 0;
    bigBossRespawnTimer = 0;
    pendingWave = null;
    // 3. Reset toÃ n bá»™ tráº¡ng thÃ¡i cá»§a ngÆ°á»i chÆ¡i vá» ban Ä‘áº§u
    player.hearts = 10;
    player.energy = 0;
    player.mana = 0;
    player.coins = 0;
    player.level = 1;
    player.speed = 1;
    player.exp = 0;
    player.currentLevelExp = 0;
    player.requiredExp = INITIAL_REQUIRED_EXP;
    player.score = 0;
    zombieKillCount = 0;
    player.isDying = false;
    player.x = canvas.width / 2; // ÄÆ°a player vá» giá»¯a mÃ n hÃ¬nh
    player.y = canvas.height / 2;

    // 4. Reset cÃ¡c chá»‰ sá»‘ nÃ¢ng cáº¥p cá»§a ngÆ°á»i chÆ¡i
    // QUAN TRá»ŒNG: Xem lÆ°u Ã½ á»Ÿ dÆ°á»›i vá» cÃ¡c nÃ¢ng cáº¥p vÄ©nh viá»…n
    playerUpgrades.fireRate = 1;
    playerUpgrades.damageBoost = 1;
    playerUpgrades.hpBoost = 0;
    playerUpgrades.bulletSpeed = 1;
    playerUpgrades.lineBulletCount = 1;

    // 5. Reset cÃ¡c nÃ¢ng cáº¥p ká»¹ nÄƒng
    skillUpgrades.bladeCount = 2;
    skillUpgrades.bladeDamage = 1;
    skillUpgrades.swordLevel = 1;
    skillUpgrades.swordDamage = 3;
    skillUpgrades.fireCount = 2;
    skillUpgrades.fireDamage = 1;
    skillUpgrades.iceCount = 2;
    skillUpgrades.iceDamage = 2;
    skillUpgrades.thunderCount = 2;
    skillUpgrades.thunderDamage = 3;
    skillUpgrades.auraHealLevel = 0;
    skillUpgrades.fairyCount = 1;
    skillUpgrades.fairyHealLevel = 0;
    skillUpgrades.fairyDamageLevel = 0;

    // 6. Dá»n dáº¹p táº¥t cáº£ cÃ¡c máº£ng chá»©a Ä‘á»‘i tÆ°á»£ng trong game
    // CÃ¡ch .length = 0 lÃ  cÃ¡ch xÃ³a máº£ng hiá»‡u quáº£ nháº¥t, khÃ´ng "gÃ¢y rÃ¡c"
    zombies.length = 0;
    bullets.length = 0;
    enemyBullets.length = 0;
    items.length = 0;
    explosions.length = 0;
    particles.length = 0;
    swords.length = 0;
    downwardSwords.length = 0;
    fireballs.length = 0;
    iceballs.length = 0;
    thunderBalls.length = 0;
    fairies.length = 0;
    clones.length = 0;
    activeSkills.length = 0; // XÃ³a cÃ¡c ká»¹ nÄƒng Ä‘Ã£ há»c
    supplyDrops.length = 0;
    // --- Dá»n dáº¹p cÃ¡c máº£ng chá»©a Ä‘á»‘i tÆ°á»£ng cá»§a ká»¹ nÄƒng ---
    satellites.length = 0;
    ufos.length = 0;
    lightningBolts.length = 0;
    activeLightningStrikes.length = 0;
    blackHoles.length = 0;
    bloodOrbs.length = 0;
    missiles.length = 0;
    nuclearBombs.length = 0;
    bombsB52.length = 0;
    activePlanes.length = 0;
    auraCrackLines.length = 0;
    auraLightBeams.length = 0;
// 7. Reset tráº¡ng thÃ¡i vÃ  thá»i gian há»“i cá»§a cÃ¡c ká»¹ nÄƒng/buff
    lastManualShootTime = 0; // Reset thá»i gian há»“i báº¯n tay
    lastAutoShootTime = 0;   // Reset thá»i gian há»“i auto-shoot
    autoBurstIndex = 0;      // Reset loáº¡t Ä‘áº¡n cá»§a auto-shoot
    autoLastBurstTime = 0;
    levelUpGlowTime = 0;     // Táº¯t hiá»‡u á»©ng sÃ¡ng khi lÃªn cáº¥p

    // Dá»n dáº¹p cÃ¡c bá»™ Ä‘á»‡m thÃ´ng bÃ¡o váº­t pháº©m Ä‘á»ƒ trÃ¡nh popup thá»«a
    clearTimeout(playerLootTimer);
    clearTimeout(petLootTimer);
    Object.keys(playerLootBuffer).forEach(k => delete playerLootBuffer[k]);
    Object.keys(petLootBuffer).forEach(k => delete petLootBuffer[k]);

    // Dá»n dáº¹p cÃ¡c Ä‘á»‘i tÆ°á»£ng thá»‘ng kÃª
    // CÃ¡ch nÃ y sáº½ xÃ³a sáº¡ch cÃ¡c key trong object
    for (let key in zombieByLevel) {
        delete zombieByLevel[key];
    }
    for (let key in skillStats) {
        delete skillStats[key];
    }
    // --- Reset cÃ¡c Buff nháº·t Ä‘Æ°á»£c ---
    luckyBuffEndTime = 0;
    powerBuffEndTime = 0;
    isPowerBuffActive = false;
    powerBuffDamageBonus = 0;
    crazyBuffEndTime = 0;
    isCrazyBuffActive = false;
    crazyBuffStats = {};
    expBuffEndTime = 0;
    magnetBuffEndTime = 0;
    crazyMadnessTimeEndTime = 0;
    isCrazyMadnessTimeActive = false;
    crazyMadnessTimeBuffStats = {};

    // --- Reset cÃ¡c Ká»¹ nÄƒng Passive (cÃ³ nÃºt báº¥m trÃªn UI) ---
    autoShoot = false; // Táº¯t auto-shoot Ä‘á»ƒ ngÆ°á»i chÆ¡i tá»± báº­t láº¡i
    
    swordActive = false;
    swordEndTime = 0;
    
    bladeActive = false;
    bladeEndTime = 0;
    
    fireActive = false;
    fireEndTime = 0;
    
    iceActive = false;
    iceEndTime = 0;
    
    thunderActive = false;
    thunderEndTime = 0;
    
    petActive = false;
    petEndTime = 0;
    petRabbit = null;
    
    supportAuraActive = false;
    supportAuraEndTime = 0;

    fairyActive = false;
    fairyEndTime = 0;
    fairyDeathDefyAvailable = false;
    fairyDamageBonus = 0;

    // --- Reset cÃ¡c Ká»¹ nÄƒng Active (há»c khi lÃªn cáº¥p) ---
    player.shieldActive = false;
    if (player.shieldEndTime) player.shieldEndTime = 0;

    satelliteActive = false;
    satelliteEndTime = 0;
    
    ufoActive = false;
    ufoEndTime = 0;

    lightningActive = false;
    lightningEndTime = 0;
    
    disguiseActive = false;
    disguiseEndTime = 0;

    clonesActive = false;
    clonesEndTime = 0;

    bloodOrbActive = false;
    bloodOrbEndTime = 0;

    spaceGateActive = false;
    spaceGateEndTime = 0;
    spaceGate = null;
    
    // 8. Cáº­p nháº­t láº¡i toÃ n bá»™ giao diá»‡n (UI)
    updateUI();
    updateStatsOverlay();
    updateSkillsList(); // Cáº­p nháº­t láº¡i báº£ng ká»¹ nÄƒng (sáº½ trá»‘ng)
    document.querySelectorAll('#ui button.active').forEach(btn => btn.classList.remove('active'));

    // 9. Báº­t láº¡i nháº¡c ná»n máº·c Ä‘á»‹nh vÃ  sinh lá»©a zombie Ä‘áº§u tiÃªn
    playRandomNormalMusic();
    spawnZombie();
    showUpgradePopup(); // Hiá»ƒn thá»‹ nÃ¢ng cáº¥p cho lÆ°á»£t chÆ¡i má»›i
}

// HÃ m báº­t/táº¯t Shop
function toggleShop() {
    const shop = document.getElementById('shopOverlay');
    if (!shop) return;
    const isHidden = shop.classList.toggle('hidden');
    isPaused = !isHidden;

    if (!isHidden) {
        populateShop(); // Khi má»Ÿ shop, hiá»ƒn thá»‹ cÃ¡c váº­t pháº©m
    }
}

// HÃ m hiá»ƒn thá»‹ cÃ¡c váº­t pháº©m trong Shop
function populateShop() {
    const container = document.getElementById('shopItemsContainer');
    container.innerHTML = ''; // XÃ³a cÃ¡c váº­t pháº©m cÅ©

    document.getElementById('shopCoinBalance').innerText = player.coins;

    shopItems.forEach(item => {
        const itemDiv = document.createElement('div');
        itemDiv.className = 'shop-item';

        // THAY Äá»”I: Bá» tháº» div.cost vÃ  hiá»ƒn thá»‹ giÃ¡ tiá»n ngay trÃªn nÃºt Mua
        itemDiv.innerHTML = `
            <div class="icon">${item.icon}</div>
            <div class="name">${item.name}</div>
            <button onclick="purchaseShopItem('${item.id}')">${item.cost} ğŸª™</button>
        `;
        container.appendChild(itemDiv);
    });
}

// HÃ m xá»­ lÃ½ khi mua má»™t váº­t pháº©m
function purchaseShopItem(itemId) {
    const item = shopItems.find(i => i.id === itemId);
    if (!item) return;

    if (player.coins >= item.cost) {
        player.coins -= item.cost;
        playSound('sfx-powerup', 0.8); // Ã‚m thanh mua thÃ nh cÃ´ng
        showWarning(`ÄÃ£ mua: ${item.name}!`);
        // Ãp dá»¥ng hiá»‡u á»©ng váº­t pháº©m
        switch (item.id) {
            case 'buy_10_mana':
                player.mana += item.value;
                break;
            case 'buy_10_energy':
                player.energy += item.value;
                break;
            case 'buy_5_hp':
                player.hearts += item.value;
                break;
            case 'buy_12_hp':
                player.hearts += item.value;
                break;
            case 'buy_damage':
                playerUpgrades.damageBoost += item.value;
                break;
        }

        // Cáº­p nháº­t láº¡i giao diá»‡n shop vÃ  UI chÃ­nh
        populateShop();
        updateUI();
        updateStatsOverlay();
    } else {
        showWarning("KhÃ´ng Ä‘á»§ xu!"); // ThÃ´ng bÃ¡o khÃ´ng Ä‘á»§ tiá»n
    }
}
// ğŸŒŠ Hiá»‡n popup "Wave X báº¯t Ä‘áº§u"
function showWavePopup() {
  const popup = document.getElementById("wavePopup");
  popup.innerText = `Wave ${wave} báº¯t Ä‘áº§u!`;
  popup.style.animation = "none";
  void popup.offsetWidth; // force reflow Ä‘á»ƒ reset animation
  popup.style.display = "block";
  popup.style.animation = "waveFade 1s ease-out forwards";
  setTimeout(() => {
    popup.style.display = "none";
  }, 2000); // áº©n sau 2 giÃ¢y
}

// ğŸ¯ GiÃ¡ trá»‹ theo cáº¥p Ä‘á»™ ká»¹ nÄƒng (má»—i cáº¥p tÄƒng dáº§n)
const UPGRADE_TIERS = {
  fireRate: [1, 2, 3],
  damageBoost: [0.5, 1, 1.5],
  hpBoost: [5, 10, 15],            
  bulletSpeed: [0.25, 0.5, 1]
};

// ğŸŒŸ Hiá»ƒn thá»‹ popup chá»n nÃ¢ng cáº¥p ká»¹ nÄƒng
function showUpgradePopup() {
  playSound('sfx-wave-up', 0.3); // PhÃ¡t Ã¢m thanh nÃ¢ng cáº¥p
  const popup = document.getElementById("upgradePopup");
  const container = document.getElementById("upgradeChoices");
  container.innerHTML = "";

  // ğŸ“Œ Báº£ng giÃ¡ trá»‹ tÆ°Æ¡ng á»©ng vá»›i tá»«ng báº­c nÃ¢ng cáº¥p
  const UPGRADE_VALUES = {
    Báº¡c: { fireRate: 1, damageBoost: 0.5, hpBoost: 5, bulletSpeed: 0.25 },
    VÃ ng: { fireRate: 2, damageBoost: 1, hpBoost: 10, bulletSpeed: 0.5 },
    Kim: { fireRate: 3, damageBoost: 1.5, hpBoost: 15, bulletSpeed: 1 },
    Rare: { moveSpeed: 0.2 } // ğŸ‘Ÿ tá»‘c Ä‘á»™ cháº¡y â€“ báº­c hiáº¿m
  };
  // ğŸ– MÃ u viá»n tÆ°Æ¡ng á»©ng tá»«ng báº­c
  const TIER_COLORS = {
    Báº¡c: "#aaa",
    VÃ ng: "gold",
    Kim: "#c770ff",
    Rare: "#3399ff" // mÃ u xanh báº­c hiáº¿m
  };
  // Giá»›i háº¡n nÃ¢ng cáº¥p ká»¹ nÄƒng
  const MAX_FIRE_RATE = 21; // ğŸ”« hÆ°á»›ng báº¯n
  const MAX_LINE_BULLETS = 10; // ğŸ”« sá»‘ lÆ°á»£ng Ä‘áº¡n
  const MAX_MOVE_SPEED = 3; // ğŸ‘Ÿ tá»‘c Ä‘á»™ di chuyá»ƒn tá»‘i Ä‘a
  const MAX_BULLET_SPEED = 10; // ğŸš€ tá»‘c Ä‘á»™ Ä‘áº¡n tá»‘i Ä‘a

  const allUpgrades = [];

  // ğŸ”ª Äao â€“ tÄƒng sá»‘ lÆ°á»£ng (tá»‘i Ä‘a 20), sau Ä‘Ã³ tÄƒng sÃ¡t thÆ°Æ¡ng
  // THÃŠM ÄIá»€U KIá»†N: Chá»‰ hiá»ƒn thá»‹ nÃ¢ng cáº¥p khi ngÆ°á»i chÆ¡i Ä‘áº¡t level 1
  if (player.level >= 1) {
    if (skillUpgrades.bladeCount < 20) {
      const tier = randomTier();
      const value = { Báº¡c: 1, VÃ ng: 2, Kim: 3 }[tier];
      allUpgrades.push({
        name: `ğŸ”ª +${value} Ä‘ao xoay`,
        tier,
        effect: () => {
          skillUpgrades.bladeCount = Math.min(skillUpgrades.bladeCount + value, 20);
          showWarning(`ğŸ”ª +${value} Ä‘ao`);
          updateStatsOverlay();
        }
      });
    } else {
      const tier = randomTier();
      const value = { Báº¡c: 0.5, VÃ ng: 1, Kim: 1.5 }[tier];
      allUpgrades.push({
        name: `ğŸ”ª +${value} sÃ¡t thÆ°Æ¡ng Ä‘ao`,
        tier,
        effect: () => {
          skillUpgrades.bladeDamage += value;
          showWarning(`ğŸ”ª +${value} dmg`);
          updateStatsOverlay();
        }
      });
    }
  }

  // âš”ï¸ Kiáº¿m â€“ tÄƒng cáº¥p (tá»‘i Ä‘a 10), sau Ä‘Ã³ tÄƒng sÃ¡t thÆ°Æ¡ng
  // THÃŠM ÄIá»€U KIá»†N: Chá»‰ hiá»ƒn thá»‹ nÃ¢ng cáº¥p khi ngÆ°á»i chÆ¡i Ä‘áº¡t level 2
  if (player.level >= 2) {
    if (skillUpgrades.swordLevel < 10) {
      const tier = randomTier();
      const value = { Báº¡c: 1, VÃ ng: 2, Kim: 3 }[tier];
      allUpgrades.push({
        name: `âš”ï¸ +${value} cáº¥p mÆ°a kiáº¿m`,
        tier,
        effect: () => {
          skillUpgrades.swordLevel = Math.min(skillUpgrades.swordLevel + value, 10);
          showWarning(`âš”ï¸ +${value} cáº¥p kiáº¿m`);
          updateStatsOverlay();
        }
      });
    } else {
      const tier = randomTier();
      const value = { Báº¡c: 0.5, VÃ ng: 1, Kim: 1.5 }[tier];
      allUpgrades.push({
        name: `âš”ï¸ +${value} sÃ¡t thÆ°Æ¡ng kiáº¿m`,
        tier,
        effect: () => {
          skillUpgrades.swordDamage += value;
          showWarning(`âš”ï¸ +${value} dmg`);
          updateStatsOverlay();
        }
      });
    }
  }

  // ğŸ”¥ Lá»­a â€“ tÄƒng sá»‘ lÆ°á»£ng (tá»‘i Ä‘a 10), sau Ä‘Ã³ tÄƒng sÃ¡t thÆ°Æ¡ng
  // THÃŠM ÄIá»€U KIá»†N: Chá»‰ hiá»ƒn thá»‹ nÃ¢ng cáº¥p khi ngÆ°á»i chÆ¡i Ä‘áº¡t level 3
  if (player.level >= 3) {
    if (skillUpgrades.fireCount < 10) {
      const tier = randomTier();
      const value = { Báº¡c: 1, VÃ ng: 2, Kim: 3 }[tier];
      allUpgrades.push({
        name: `ğŸ”¥ +${value} cáº§u lá»­a`,
        tier,
        effect: () => {
          skillUpgrades.fireCount = Math.min(skillUpgrades.fireCount + value, 10);
          showWarning(`ğŸ”¥ +${value} lá»­a`);
          updateStatsOverlay();
        }
      });
    } else {
      const tier = randomTier();
      const value = { Báº¡c: 0.5, VÃ ng: 1, Kim: 1.5 }[tier];
      allUpgrades.push({
        name: `ğŸ”¥ +${value} sÃ¡t thÆ°Æ¡ng lá»­a`,
        tier,
        effect: () => {
          skillUpgrades.fireDamage += value;
          showWarning(`ğŸ”¥ +${value} dmg`);
          updateStatsOverlay();
        }
      });
    }
  }

  // â„ï¸ BÄƒng â€“ tÄƒng sá»‘ lÆ°á»£ng (tá»‘i Ä‘a 10), sau Ä‘Ã³ tÄƒng sÃ¡t thÆ°Æ¡ng
  // THÃŠM ÄIá»€U KIá»†N: Chá»‰ hiá»ƒn thá»‹ nÃ¢ng cáº¥p khi ngÆ°á»i chÆ¡i Ä‘áº¡t level 3
  if (player.level >= 3) {
    if (skillUpgrades.iceCount < 10) {
      const tier = randomTier();
      const value = { Báº¡c: 1, VÃ ng: 2, Kim: 3 }[tier];
      allUpgrades.push({
        name: `â„ï¸ +${value} cáº§u bÄƒng`,
        tier,
        effect: () => {
          skillUpgrades.iceCount = Math.min(skillUpgrades.iceCount + value, 10);
          showWarning(`â„ï¸ +${value} bÄƒng`);
          updateStatsOverlay();
        }
      });
    } else {
      const tier = randomTier();
      const value = { Báº¡c: 0.5, VÃ ng: 1, Kim: 1.5 }[tier];
      allUpgrades.push({
        name: `â„ï¸ +${value} sÃ¡t thÆ°Æ¡ng bÄƒng`,
        tier,
        effect: () => {
          skillUpgrades.iceDamage += value;
          showWarning(`â„ï¸ +${value} dmg`);
          updateStatsOverlay();
        }
      });
    }
  }
  
  // ğŸ”µ LÃ´i â€“ tÄƒng sá»‘ lÆ°á»£ng (tá»‘i Ä‘a 6), sau Ä‘Ã³ tÄƒng sÃ¡t thÆ°Æ¡ng
  // THÃŠM ÄIá»€U KIá»†N: Chá»‰ hiá»ƒn thá»‹ nÃ¢ng cáº¥p khi ngÆ°á»i chÆ¡i Ä‘áº¡t level 5
  if (player.level >= 5) {
    if (skillUpgrades.thunderCount < 6) {
      const tier = randomTier();
      const value = 1;
      allUpgrades.push({
        name: `ğŸ”µ +${value} cáº§u lÃ´i`,
        tier,
        effect: () => {
          skillUpgrades.thunderCount = Math.min(skillUpgrades.thunderCount + value, 6);
          showWarning(`ğŸ”µ +${value} cáº§u lÃ´i`);
          updateStatsOverlay();
        }
      });
    } else {
      const tier = randomTier();
      const value = { Báº¡c: 1, VÃ ng: 2, Kim: 3 }[tier];
      allUpgrades.push({
        name: `ğŸ”µ +${value} sÃ¡t thÆ°Æ¡ng lÃ´i`,
        tier,
        effect: () => {
          skillUpgrades.thunderDamage += value;
          showWarning(`ğŸ”µ +${value} dmg lÃ´i`);
          updateStatsOverlay();
        }
      });
    }
  }

  // ğŸ”« HÆ°á»›ng báº¯n â€“ náº¿u chÆ°a max
  if (playerUpgrades.fireRate < MAX_FIRE_RATE) {
    const tier = randomTier();
    const value = UPGRADE_VALUES[tier].fireRate;
    allUpgrades.push({
      name: "ğŸ”« HÆ°á»›ng báº¯n",
      key: "fireRate",
      tier,
      value,
      effect: () => {
        const added = Math.min(playerUpgrades.fireRate + value, MAX_FIRE_RATE) - playerUpgrades.fireRate;
        playerUpgrades.fireRate += added;
        showWarning(`ğŸ”« +${added} hÆ°á»›ng báº¯n`);
        updateStatsOverlay();
      }
    });
  }

  // ğŸ’¥ SÃ¡t thÆ°Æ¡ng â€“ luÃ´n cÃ³ thá»ƒ nÃ¢ng
  {
    const tier = randomTier();
    const value = UPGRADE_VALUES[tier].damageBoost;
    allUpgrades.push({
      name: "ğŸ’¥ SÃ¡t thÆ°Æ¡ng",
      key: "damageBoost",
      tier,
      value,
      effect: () => {
        playerUpgrades.damageBoost += value;
        showWarning(`ğŸ’¥ +${value} sÃ¡t thÆ°Æ¡ng`);
        updateStatsOverlay();
      }
    });
  }

  // â¤ï¸ MÃ¡u â€“ luÃ´n cÃ³ thá»ƒ nÃ¢ng
  {
    const tier = randomTier();
    const value = UPGRADE_VALUES[tier].hpBoost;
    allUpgrades.push({
      name: "â¤ï¸ TÄƒng mÃ¡u",
      key: "hpBoost",
      tier,
      value,
      effect: () => {
        player.hearts += value;
        playerUpgrades.hpBoost += 1;
        showWarning(`â¤ï¸ +${value}`);
        updateUI();
        updateStatsOverlay();
      }
    });
  }

  // ğŸ’¨ Tá»‘c Ä‘á»™ Ä‘áº¡n tá»‘i Ä‘a 10
  if (playerUpgrades.bulletSpeed < MAX_BULLET_SPEED) {
    const tier = randomTier();
    const value = UPGRADE_VALUES[tier].bulletSpeed;
    allUpgrades.push({
      name: "ğŸ’¨ Tá»‘c Ä‘á»™ Ä‘áº¡n",
      key: "bulletSpeed",
      tier,
      value,
      effect: () => {
        const added = Math.min(playerUpgrades.bulletSpeed + value, MAX_BULLET_SPEED) - playerUpgrades.bulletSpeed;
        playerUpgrades.bulletSpeed += added;
        showWarning(`ğŸ’¨ +${added.toFixed(1)} tá»‘c Ä‘á»™ Ä‘áº¡n`);
        updateStatsOverlay();
      }
    });
  }

  // ğŸ§¨ Sá»‘ lÆ°á»£ng Ä‘áº¡n â€“ náº¿u chÆ°a max
  if (playerUpgrades.lineBulletCount < MAX_LINE_BULLETS) {
    const tier = randomTier();
    const value = 1;
    allUpgrades.push({
      name: "ğŸ§¨ sá»‘ lÆ°á»£ng Ä‘áº¡n",
      key: "lineBulletCount",
      tier,
      value,
      effect: () => {
        playerUpgrades.lineBulletCount += value;
        showWarning(`ğŸ§¨ +${value} viÃªn má»—i hÃ ng`);
        updateStatsOverlay();
      }
    });
  }

  // ğŸ‘Ÿ Tá»‘c Ä‘á»™ cháº¡y â€“ hiáº¿m vÃ  chá»‰ 1 cáº¥p (náº¿u chÆ°a max)
  if (player.speed < MAX_MOVE_SPEED) {
    const value = UPGRADE_VALUES.Rare.moveSpeed;
    allUpgrades.push({
      name: "ğŸ‘Ÿ Tá»‘c Ä‘á»™ cháº¡y",
      key: "moveSpeed",
      tier: "Rare",
      value,
      effect: () => {
        player.speed = Math.min(player.speed + value, MAX_MOVE_SPEED);
        showWarning(`ğŸ‘Ÿ +${value.toFixed(1)} tá»‘c Ä‘á»™`);
        updateStatsOverlay();
      }
    });
  }
  
  // --- NÃ¢ng cáº¥p ká»¹ nÄƒng Fairy ---
  // THÃŠM ÄIá»€U KIá»†N: Chá»‰ hiá»ƒn thá»‹ nÃ¢ng cáº¥p khi ngÆ°á»i chÆ¡i Ä‘áº¡t level 7
  if (player.level >= 7) {
    if (skillUpgrades.fairyCount < 3) {
      allUpgrades.push({
        name: `ğŸ¦‹ +1 Fairy (Tá»‘i Ä‘a 3)`,
        tier: "Kim",
        effect: () => {
          skillUpgrades.fairyCount++;
          showWarning(`ğŸ¦‹ Sá»‘ lÆ°á»£ng Fairy: ${skillUpgrades.fairyCount}`);
        }
      });
    } else {
      // Khi Ä‘Ã£ Ä‘á»§ 3 Fairy, báº¯t Ä‘áº§u nÃ¢ng cáº¥p chá»‰ sá»‘
      // NÃ¢ng cáº¥p há»“i mÃ¡u
      const healTier = randomTier();
      const healValue = { Báº¡c: 1, VÃ ng: 2, Kim: 3 }[healTier];
      allUpgrades.push({
        name: `ğŸ¦‹ +${healValue} Há»“i mÃ¡u/giÃ¢y`,
        tier: healTier,
        effect: () => {
          skillUpgrades.fairyHealLevel += healValue;
          showWarning(`ğŸ¦‹ NÃ¢ng cáº¥p há»“i mÃ¡u!`);
        }
      });

      // NÃ¢ng cáº¥p sÃ¡t thÆ°Æ¡ng
      const dmgTier = randomTier();
      const dmgValue = { Báº¡c: 1, VÃ ng: 2, Kim: 3 }[dmgTier];
      allUpgrades.push({
        name: `ğŸ¦‹ +${dmgValue} SÃ¡t thÆ°Æ¡ng`,
        tier: dmgTier,
        effect: () => {
          skillUpgrades.fairyDamageLevel += dmgValue;
          showWarning(`ğŸ¦‹ NÃ¢ng cáº¥p sÃ¡t thÆ°Æ¡ng!`);
        }
      });
    }
  }
  
  // --- NÃ¢ng cáº¥p Há»“i mÃ¡u cho HÃ o quang ---
  // THÃŠM ÄIá»€U KIá»†N: Chá»‰ hiá»ƒn thá»‹ nÃ¢ng cáº¥p khi ngÆ°á»i chÆ¡i Ä‘áº¡t level 6
  if (player.level >= 6) {
    const currentAuraHeal = 1 + skillUpgrades.auraHealLevel;
    if (currentAuraHeal < 5) { // Chá»‰ hiá»ƒn thá»‹ náº¿u chÆ°a Ä‘áº¡t tá»‘i Ä‘a
      const tier = randomTier();
      const value = { Báº¡c: 1, VÃ ng: 2, Kim: 3 }[tier];

      allUpgrades.push({
        name: `âœ¨ +${value} Há»“i mÃ¡u`,
        tier: tier,
        effect: () => {
          skillUpgrades.auraHealLevel += value;
          const finalHeal = Math.min(1 + skillUpgrades.auraHealLevel, 5);
          showWarning(`âœ¨ Há»“i mÃ¡u: ${finalHeal} HP/3s`);
          updateStatsOverlay(); // Cáº­p nháº­t báº£ng thá»‘ng kÃª náº¿u cÃ³
        }
      });
    }
  }

  // ğŸ² XÃ¡o trá»™n vÃ  chá»n ngáº«u nhiÃªn 3 nÃ¢ng cáº¥p
  const choices = allUpgrades.sort(() => Math.random() - 0.5).slice(0, 3);
  // ğŸ–±ï¸ Táº¡o nÃºt cho tá»«ng nÃ¢ng cáº¥p
  choices.forEach(up => {
    const btn = document.createElement("button");
    btn.innerText = up.name;
    btn.style.borderColor = TIER_COLORS[up.tier];
    btn.onclick = () => {
      playSound('sfx-upgrade-select'); // <-- THÃŠM Ã‚M THANH KHI CLICK
      up.effect();
      popup.classList.remove('visible'); // <-- DÃ¹ng class Ä‘á»ƒ áº©n popup
      isPaused = false;
      lastWaveTime = Date.now();

      if (pendingWave !== null) {
        setTimeout(() => {
          showWavePopup();
          pendingWave = null;
        }, 500);
      }
    };
    container.appendChild(btn);
  });

  popup.classList.add('visible'); // <-- DÃ¹ng class Ä‘á»ƒ hiá»‡n popup
  isPaused = true;
}
// ğŸ› ï¸ Hiá»ƒn thá»‹ thÃ´ng bÃ¡o khi nÃ¢ng cáº¥p thÃ nh cÃ´ng
// ğŸ² Chá»n báº­c nÃ¢ng cáº¥p ngáº«u nhiÃªn theo tá»· lá»‡
function randomTier() {
  const tiers = ["Báº¡c", "VÃ ng", "Kim"];
  const weights = [0.7, 0.25, 0.05]; // tá»· lá»‡ gáº·p: 60% Báº¡c, 30% VÃ ng, 10% Kim
  const r = Math.random();
  let sum = 0;
  for (let i = 0; i < tiers.length; i++) {
    sum += weights[i];
    if (r < sum) return tiers[i];
  }
  return "Báº¡c"; // fallback náº¿u cÃ³ lá»—i
}

// ğŸŒŸ Hiá»ƒn thá»‹ popup chá»n ká»¹ nÄƒng khi tÄƒng level
/* ========= Cáº¤U HÃŒNH ========= */
const MAX_LV = {                         // giá»›i háº¡n sá»‘-lÆ°á»£ng
  ufo        : 3,                        // UFO táº¥n cÃ´ng
  missile    : 5,                        // tÃªn lá»­a F18
  lightning  : 5,                        // tia sÃ©t diá»‡n rá»™ng
  satellite  : 2,                        // vá»‡ tinh laze
  blackhole  : 2,                        // Há»‘ Ä‘en
  bloodorb   : 2
};

/* tÃªn ngáº¯n â†’ regex nháº­n diá»‡n chuá»—i nÃ¢ng cáº¥p */
const UP_RX = {
  ufo       : /\+1 UFO/i,
  missile   : /\+1 tÃªn lá»­a/i,
  lightning : /\+1 tia sÃ©t/i,
  satellite : /\+1 vá»‡ tinh/i,
  blackhole : /\+1 há»‘ Ä‘en/i,
  bloodorb  : /\+1 quáº£ cáº§u/i
};

/* ========= TRá»¢ GIÃšP ========= */
const rand    = arr => arr[Math.random() * arr.length | 0];          // pickRandom
const shuffle = a => a.sort(() => Math.random() - .5);               // Fisherâ€“Yates 1-liner

/* kiá»ƒm tra 1 nÃ¢ng cáº¥p cÃ³ â€œháº¿t Ä‘Ã¡tâ€ chÆ°a */
function isOverLimit(upgrade){
  const key = Object.keys(UP_RX).find(k => UP_RX[k].test(upgrade.name));
  if (!key) return false;                                            // gÃ³i sÃ¡t thÆ°Æ¡ng, v.v.
  const active = activeSkills.find(s => s.name === upgrade.skillName);
  return active && (active.level || 0) >= MAX_LV[key];
}

/* ========= POPUP ========= */
function showSkillLevelUpPopup() {
  isPaused = true; // â¸ï¸
  const popup = document.getElementById('skillPopup');
  
  // Sá»­a lá»—i: Láº¥y Ä‘Ãºng container cá»§a popup ká»¹ nÄƒng thay vÃ¬ popup nÃ¢ng cáº¥p wave
  const container = document.getElementById('skillChoices'); 
  container.innerHTML = '';

  /* 1ï¸âƒ£ Lá»c ká»¹ nÄƒng chÆ°a há»c & nÃ¢ng cáº¥p há»£p lá»‡ */
  // THAY Äá»”I Cá»T LÃ•I Náº°M á» ÄÃ‚Y
  // Lá»c cÃ¡c ká»¹ nÄƒng chÆ°a há»c VÃ€ ngÆ°á»i chÆ¡i Ä‘Ã£ Ä‘á»§ cáº¥p Ä‘á»™ yÃªu cáº§u
  const unlearned = skillsData.filter((skill, index) => {
    const requiredLevel = index + 1; // Skill á»Ÿ vá»‹ trÃ­ 0 -> yÃªu cáº§u lv 1, vá»‹ trÃ­ 1 -> yÃªu cáº§u lv 2, ...
    return player.level >= requiredLevel && !activeSkills.includes(skill);
  });
  
  const upgrades = activeSkills
    .flatMap(sk => (sk.upgrades || []).map(up => ({ ...up, skillName: sk.name })))
    .filter(up => !isOverLimit(up)); // bá» gÃ³i max

  /* 2ï¸âƒ£ GhÃ©p pool & chá»n 3 lá»±a chá»n */
  let choices;
  if (unlearned.length) { // LuÃ´n Æ°u tiÃªn cÃ³ â‰¥1 skill má»›i náº¿u cÃ³ thá»ƒ
    const pickNew = rand(unlearned);
    const pool = [...unlearned.filter(s => s !== pickNew), ...upgrades];
    choices = [pickNew, ...shuffle(pool).slice(0, 2)];
  } else { // ÄÃ£ há»c háº¿t cÃ¡c ká»¹ nÄƒng cÃ³ thá»ƒ há»c á»Ÿ level hiá»‡n táº¡i
    const unique = {}; // má»—i skill 1 upgrade ngáº«u nhiÃªn
    upgrades.forEach(up => (unique[up.skillName] ||= []).push(up));
    choices = shuffle(Object.values(unique).map(rand)).slice(0, 3);
  }

  /* 3ï¸âƒ£ Render nÃºt báº¥m */
  choices.forEach(ch => {
    const btn = document.createElement('button');
    if (ch.icon){
      btn.textContent = `${ch.icon} ${ch.name}`;
      btn.onclick = () => {
        playSound('sfx-upgrade-select'); // <-- THÃŠM Ã‚M THANH
        learnSkill(skillsData.indexOf(ch));
        popup.style.display = 'none';
        isPaused = false;
      };
    } else {
      btn.textContent = ch.name;
      btn.style.borderColor = {Báº¡c:'#aaa',VÃ ng:'gold',Kim:'#c770ff',Äá»:'red'}[ch.tier] || '#ccc';
      btn.onclick = () => {
        playSound('sfx-upgrade-select'); // <-- THÃŠM Ã‚M THANH
        ch.effect?.();
        showWarning(` ${ch.name}`);
        popup.style.display = 'none';
        isPaused = false;
      };
    }
    container.appendChild(btn);
  });

  popup.style.display = 'block';
}

// ğŸ§¾ Cáº­p nháº­t thÃ´ng tin thá»‘ng kÃª trong overlay
function updateStatsOverlay() {
  /* ğŸ‘‡ 1. TÃ­nh láº¡i tá»•ng má»—i láº§n váº½ */
  const alive  = zombies.length;      // Ä‘ang cÃ²n trÃªn báº£n Ä‘á»“
  const killed = zombieKillCount;     // Ä‘Ã£ tiÃªu diá»‡t
  const total  = alive + killed;      // tá»•ng thá»±c
document.getElementById("stat-damage").innerText =
  `ğŸ’¥ SÃ¡t thÆ°Æ¡ng: ${(playerUpgrades.damageBoost || 1).toFixed(1)}`;
  document.getElementById("stat-spawned").innerText = `ğŸ§Ÿ Tá»•ng sá»‘ zombie: ${total}`;
  document.getElementById("stat-alive").innerText   = `ğŸ§Ÿ Äang cÃ²n sá»‘ng: ${alive}`;
  document.getElementById("stat-total").innerText   = `ğŸ§Ÿ ÄÃ£ tiÃªu diá»‡t: ${killed}`;
  document.getElementById("stat-speed").innerText = `ğŸ’¨ Tá»‘c Ä‘á»™: ${playerUpgrades.bulletSpeed.toFixed(1)}`;
  document.getElementById("stat-fireRate").innerText = `ğŸ”« HÆ°á»›ng báº¯n: ${playerUpgrades.fireRate}`;
  document.getElementById("stat-lineCount").innerText = `ğŸ§¨ Sá»‘ lÆ°á»£ng Ä‘áº¡n: ${playerUpgrades.lineBulletCount}`;
  document.getElementById("stat-moveSpeed").innerText = `ğŸ‘Ÿ Tá»‘c Ä‘á»™ cháº¡y: ${player.speed.toFixed(1)}`;
  // ğŸ”ª Thá»‘ng kÃª ká»¹ nÄƒng máº·c Ä‘á»‹nh
document.getElementById("stat-blade").innerText = `ğŸ”ª Äao: ${skillUpgrades.bladeCount} Ä‘ao, ${skillUpgrades.bladeDamage.toFixed(1)} dmg`;
document.getElementById("stat-sword").innerText = `âš”ï¸ Kiáº¿m: Lv${skillUpgrades.swordLevel}, ${skillUpgrades.swordDamage.toFixed(1)} dmg`;
document.getElementById("stat-fire").innerText = `ğŸ”¥ Lá»­a: ${skillUpgrades.fireCount} lá»­a, ${skillUpgrades.fireDamage.toFixed(1)} dmg`;
document.getElementById("stat-ice").innerText = `â„ï¸ BÄƒng: ${skillUpgrades.iceCount} bÄƒng, ${skillUpgrades.iceDamage.toFixed(1)} dmg`;
document.getElementById("stat-thunder").innerText = `ğŸ”µ LÃ´i: ${skillUpgrades.thunderCount} cáº§u, ${skillUpgrades.thunderDamage.toFixed(1)} dmg`;
// Ká»¹ nÄƒng khÃ¡c
const skillText = Object.entries(skillStats)
    .map(([key, value]) => `${key}: ${value}`)
    .join("<br>");
    document.getElementById("stat-skills").innerHTML = skillText;

// ğŸ§Ÿ Zombie theo cáº¥p: chá»‰ hiá»ƒn thá»‹ tá»« Cáº¥p 1 â†’ 10
  let breakdown = "";
  for (let i = 1; i <= 10; i++) {
    breakdown += `<div>ğŸ§Ÿ Cáº¥p ${i}: ${zombieByLevel[i] || 0}</div>`;
  }

// ğŸ’€ Thá»‘ng kÃª Mini Boss & Boss á»Ÿ cuá»‘i
  const miniBossLine = `<div>ğŸ’€ Mini Boss: ${zombieByLevel.miniBoss || 0}</div>`;
  const bossLine = `<div>ğŸ’€ Boss: ${zombieByLevel.boss || 0}</div>`;
  const bigBossLine = `<div>ğŸ’€ BigBoss: ${zombieByLevel.bigBoss || 0}</div>`;
  document.getElementById("stat-breakdown").innerHTML =
  breakdown + miniBossLine + bossLine + bigBossLine;
}
const activeSkills = [];

// Ká»¹ nÄƒng máº«u
const skillsData = [
  {
    name: "KhiÃªn báº£o vá»‡",
    icon: "ğŸ›¡ï¸",
    manaCost: 10,
    duration: 60000,
    description: "Táº¡o má»™t vÃ²ng báº£o vá»‡ xung quanh ngÆ°á»i chÆ¡i cháº¯n má»i sÃ¡t thÆ°Æ¡ng."
  },
  {
    name: "Vá»‡ tinh laze",
    icon: "ğŸ›°ï¸",
    manaCost: 20,
    duration: 30000,
    baseDamage: 3,
    description: "Triá»‡u há»“i vá»‡ tinh xoay quanh ngÆ°á»i chÆ¡i vÃ  báº¯n laze xuyÃªn zombie."
  },
{
  name: "TÃªn lá»­a F18",
  icon: "ğŸš€",
  manaCost: 25,
  duration: 30000,
  baseDamage: 6,
  description: "Gá»i 1~5 tÃªn lá»­a bay vÃ²ng trÃ²n quanh ngÆ°á»i chÆ¡i vÃ  xuyÃªn phÃ¡ zombie.",
  upgrades: []
},
{
  name: "UFO táº¥n cÃ´ng",
  icon: "ğŸ›¸",
  manaCost: 30,
  duration: 30000,
  baseDamage: 5,
  description: "Gá»i UFO bay ngang mÃ n hÃ¬nh, báº¯n laze Ä‘á» xuá»‘ng zombie má»—i giÃ¢y.",
  upgrades: []
},
{
  name: "BÃ£o sÃ©t",
  icon: "ğŸŒ©ï¸",
  manaCost: 35,
  duration: 33000,
  baseDamage: 8,
  description: "Gá»i sÃ©t ngáº«u nhiÃªn Ä‘Ã¡nh quanh báº£n Ä‘á»“.",
  upgrades: []
},
{
  name: "Bom B52",
  icon: "ğŸ’£",
  manaCost: 52,
  duration: 52000,
  baseDamage: 10,
  description: "MÃ¡y bay mang theo Bom B52 tháº£ hÃ ng loáº¡t tiÃªu diá»‡t zombie."
},
  {
    name: "áº¢o áº£nh phÃ¢n thÃ¢n",
    icon: "ğŸ­",
    manaCost: 20,
    duration: 45000,
    baseDamage: 5,
    description: "Triá»‡u há»“i 2 báº£n sao há»— trá»£ báº¯n."
  },
  {
    name: "Há»‘ Ä‘en",
    icon: "ğŸ•³ï¸",
    manaCost: 60,
    duration: 30000,
    baseDamage: 7,
    description: "Táº¡o má»™t há»‘ Ä‘en hÃºt zombie xung quanh."
  },
  {
    name: "Biáº¿n hÃ¬nh",
    icon: "ğŸ¸",
    manaCost: 5,
    duration: 10000,
    description: "Giáº£ dáº¡ng thÃ nh áº¿ch Ä‘á»“ng  thá»i tÄƒng tá»‘c cháº¡y, zombie sáº½ bá» Ä‘i khÃ´ng táº¥n cÃ´ng trong 5s."
  },
  {
    name: "Boom háº¡t nhÃ¢n",
    icon: "â˜¢ï¸",
    manaCost: 100,
    duration: 20000,
    baseDamage: 100,
    description: "Bom háº¡t nhÃ¢n phÃ¡t ná»• toÃ n báº£n Ä‘á»“, sÃ¡t thÆ°Æ¡ng cá»±c lá»›n."
  },
{
    name: "Quáº£ cáº§u háº¥p huyáº¿t",
    icon: "ğŸ©¸",
    manaCost: 25,
    duration: 25000,
    baseDamage: 2,
    description: "Triá»‡u há»“i quáº£ cáº§u Ä‘á» bay quanh ngÆ°á»i chÆ¡i.\nMá»—i giÃ¢y hÃºt mÃ¡u zombie gáº§n nháº¥t, gÃ¢y sÃ¡t thÆ°Æ¡ng vÃ  há»“i 1 HP.",
    upgrades: []
},
{
    name: "Cá»•ng KhÃ´ng Gian",
    icon: "ğŸŒ€",
    manaCost: 50,
    duration: 30000,
    baseDamage: 10,
    description: "Má»Ÿ má»™t cá»•ng dá»‹ch chuyá»ƒn trong 30 giÃ¢y. BÆ°á»›c vÃ o cá»•ng sáº½ Ä‘Æ°a báº¡n Ä‘áº¿n má»™t vá»‹ trÃ­ ngáº«u nhiÃªn an toÃ n trÃªn báº£n Ä‘á»“."
  },
];
/* Ä‘áº·t sau khai bÃ¡o skillsData */
const skillTooltipMap = Object.fromEntries(
  skillsData.map(sk => [
    sk.name,
    `${sk.icon} ${sk.name}\nâ”€ Mana ${sk.manaCost}ğŸ’ , ${sk.duration/1000}s\n${sk.description}`
  ])
);

// ğŸ§ª ThÃªm nÃ¢ng cáº¥p cho tá»«ng ká»¹ nÄƒng cÃ³ baseDamage
skillsData.forEach(skill => {
  if (skill.baseDamage !== undefined) {
      skill.upgrades = [
{
        name: `${skill.icon} +1 sÃ¡t thÆ°Æ¡ng`,
        tier: "Báº¡c",
        effect: () => { skill.baseDamage += 1; 
        updateSkillsList(); 
}
},
{
      name: `${skill.icon} +2 sÃ¡t thÆ°Æ¡ng`,
      tier: "VÃ ng",
      effect: () => { skill.baseDamage += 2;
      updateSkillsList();
}
},
{
        name: `${skill.icon} +3 sÃ¡t thÆ°Æ¡ng`,
        tier: "Kim",
        effect: () => { skill.baseDamage += 3;
        updateSkillsList();
}
}
];

    if (skill.name === "BÃ£o sÃ©t") {
    skill.upgrades.push({
    name: "ğŸŒ©ï¸ +1 tia sÃ©t (tá»‘i Ä‘a 5)",
    tier: "Äá»",
    effect: () => {
  const skill = activeSkills.find(s => s.name === "BÃ£o sÃ©t");
  if (skill) {
    skill.level = (skill.level || 0) + 1;
    showWarning("ğŸŒ©ï¸ +1 tia sÃ©t!");
    updateSkillsList();
}
}
});
}
if (skill.name === "Há»‘ Ä‘en") {
  skill.upgrades.push({
    name: "ğŸ•³ï¸ +1 há»‘ Ä‘en (tá»‘i Ä‘a 2)",
    tier: "Äá»",
    effect: () => {
      const skill = activeSkills.find(s => s.name === "Há»‘ Ä‘en");
      if (skill) {
        skill.level = Math.min((skill.level || 0) + 1, 2); // +1 tá»›i tá»‘i Ä‘a 2 há»‘ Ä‘en
        showWarning("ğŸ•³ï¸ +1 há»‘ Ä‘en!");
        updateSkillsList();
      }
    }
  });
}

if (skill.name === "Vá»‡ tinh laze") {
  skill.upgrades.push({
    name: "ğŸ›°ï¸ +1 vá»‡ tinh (tá»‘i Ä‘a 2)",
    tier: "Äá»",
    effect: () => {
      const skill = activeSkills.find(s => s.name === "Vá»‡ tinh laze");
      if (skill) {
        skill.level = Math.min((skill.level || 0) + 1, 2); // +1 tá»›i tá»‘i Ä‘a 2 vá»‡ tinh
        showWarning("ğŸ›°ï¸ +1 vá»‡ tinh!");
        updateSkillsList();
}
}
});
}

if (skill.name === "UFO táº¥n cÃ´ng") {
  skill.upgrades.push({
    name: "ğŸ›¸ +1 UFO (tá»‘i Ä‘a 3)",
    tier: "Äá»",
effect: () => {
  const skill = activeSkills.find(s => s.name === "UFO táº¥n cÃ´ng");
  if (skill) {
    skill.level = (skill.level || 0) + 1;
    showWarning("ğŸ›¸ +1 UFO!");
    updateSkillsList();
}
}
});
}

// ğŸ¯ Náº¿u lÃ  ká»¹ nÄƒng TÃªn lá»­a thÃ¬ thÃªm nÃ¢ng cáº¥p sá»‘ lÆ°á»£ng
    if (skill.name === "TÃªn lá»­a F18") {
      skill.upgrades.push({
        name: `${skill.icon} +1 tÃªn lá»­a (tá»‘i Ä‘a 5)`,
        tier: "Äá»",
effect: () => {
  const skill = activeSkills.find(s => s.name === "TÃªn lá»­a F18");
  if (skill) {
    skill.level = (skill.level || 0) + 1;
    showWarning("ğŸš€ +1 tÃªn lá»­a!");
    updateSkillsList();
}
}
});
}
if (skill.name === "Quáº£ cáº§u háº¥p huyáº¿t") {
    skill.upgrades.push({
        name: "ğŸ©¸ +1 quáº£ cáº§u (tá»‘i Ä‘a 2)",
        tier: "Äá»",
        effect: () => {
            const skill = activeSkills.find(s => s.name === "Quáº£ cáº§u háº¥p huyáº¿t");
            if (skill) {
                skill.level = Math.min((skill.level || 0) + 1, 2);
                showWarning("ğŸ©¸ +1 Quáº£ cáº§u!");
                updateSkillsList();
            }
        }
    });
}
}
});
// ğŸ” GhÃ©p mÃ´ táº£ chi tiáº¿t cho má»—i skill
function buildSkillTooltip(skill) {
  const secs = (skill.duration ?? 0) / 1000;
  const rows = [
    `${skill.icon} ${skill.name}`,
    `Mana: ${skill.manaCost}ğŸ’   â€¢  Thá»i gian: ${secs ? secs + " s" : "tá»©c thÃ¬"}`,
  ];

  // --- SÃ¡t thÆ°Æ¡ng hiá»‡n táº¡i (náº¿u cÃ³) ---
  if (skill.baseDamage !== undefined)
    rows.push(`SÃ¡t thÆ°Æ¡ng: ${skill.baseDamage}`);

  // --- Level hiá»‡n táº¡i cá»§a cÃ¡c nÃ¢ng cáº¥p Ä‘á» ---
  if (skill.level !== undefined)
    rows.push(`Cáº¥p hiá»‡n táº¡i: ${skill.level}`);

  // --- Danh sÃ¡ch nÃ¢ng cáº¥p kháº£ dá»¥ng ---
  /*if (skill.upgrades?.length) {
    rows.push("NÃ¢ng cáº¥p:");
    skill.upgrades.forEach(u => rows.push(`â€¢ ${u.name}  [${u.tier}]`));
  }*/

  // --- MÃ´ táº£ gá»‘c --- "", chÃ¨n trÆ°á»›c mÃ´ táº£ náº¿u cÃ³
  if (skill.description) rows.push(`MÃ´ táº£: ${skill.description}`);

  return rows.join("\n");
}
// ğŸ§ª HÃ m há»c ká»¹ nÄƒng má»›i
function updateSkillsList() {
    const list = document.getElementById('skills-list');
    list.innerHTML = ''; // XÃ³a cÃ¡c item cÅ©
    
    // Chá»‰ táº¡o láº¡i cÃ¡c item trong danh sÃ¡ch ká»¹ nÄƒng
    activeSkills.forEach(skill => {
        const div = document.createElement('div');
        div.className = 'skill-item';
        div.dataset.tooltip = buildSkillTooltip(skill);

        // LuÃ´n hiá»ƒn thá»‹ thÃ´ng tin cÆ¡ báº£n
        div.innerHTML = `<span class="skill-icon">${skill.icon}</span> ${skill.name} - ${skill.manaCost}ğŸ’ `;

        // GÃ¡n sá»± kiá»‡n click trá»±c tiáº¿p
        div.onclick = () => {
            // Kiá»ƒm tra Ä‘iá»u kiá»‡n ngay khi click
            if (player.mana >= skill.manaCost && (!skill.endTime || Date.now() > skill.endTime)) {
                activateSkill(skill);
            }
        };
        
        list.appendChild(div);
    });

    // GÃ¡n láº¡i sá»± kiá»‡n cho tooltip (giá»¯ nguyÃªn logic gá»‘c cá»§a báº¡n)
    document.querySelectorAll('#skills-list .skill-item[data-tooltip]').forEach(it => {
        it.addEventListener('mouseenter', () => {
            const ln = (it.dataset.tooltip.match(/\n/g)?.length || 0) + 1;
            const hTip = ln * 18 + 12;
            const r = it.getBoundingClientRect();
            const gap = 8;
            const overTop = Math.max(gap - r.top, 0);
            const overBottom = Math.max((r.top + hTip) - (innerHeight - gap), 0);
            const shiftValue = overTop - overBottom;
            it.style.setProperty('--tip-shift', `${shiftValue}px`);
        });

        it.addEventListener('mouseleave', () => {
            it.style.removeProperty('--tip-shift');
        });
    });
}

// ğŸ§ª Test: ThÃªm ká»¹ nÄƒng báº¥t ká»³ báº±ng phÃ­m sá»‘ 1â€“9, 0
document.addEventListener("keydown", (e) => {
    // THÃŠM DÃ’NG KIá»‚M TRA:
    // Náº¿u ngÆ°á»i dÃ¹ng Ä‘ang gÃµ trong má»™t Ã´ INPUT, hÃ£y thoÃ¡t ra ngay vÃ  khÃ´ng lÃ m gÃ¬ cáº£.
    if (e.target.tagName === 'INPUT') {
        return;
    }

    const keys = "1234567890-=";
    const index = keys.indexOf(e.key);

    // Náº¿u phÃ­m Ä‘Æ°á»£c nháº¥n náº±m trong danh sÃ¡ch phÃ­m test
    if (index >= 0 && skillsData[index]) {
        // Gá»i trá»±c tiáº¿p hÃ m learnSkill Ä‘á»ƒ Ä‘áº£m báº£o logic Ä‘á»“ng nháº¥t
        learnSkill(index);
    }
});

function activateSkill(skill) {
  // Kiá»ƒm tra náº¿u khÃ´ng Ä‘á»§ mana hoáº·c ká»¹ nÄƒng Ä‘ang há»“i chiÃªu
  if (!skill || player.mana < skill.manaCost || (skill.endTime && Date.now() < skill.endTime)) {
    return;
  }
  playSound('sfx-ui-click', 0.2); // PhÃ¡t Ã¢m thanh khi kÃ­ch hoáº¡t ká»¹ nÄƒng
  player.mana -= skill.manaCost;
  // GÃ¡n thá»i gian káº¿t thÃºc há»“i chiÃªu vÃ o chÃ­nh Ä‘á»‘i tÆ°á»£ng skill
  skill.endTime = Date.now() + skill.duration;

  // Logic kÃ­ch hoáº¡t hiá»‡u á»©ng cá»§a ká»¹ nÄƒng (giá»¯ nguyÃªn)
  switch (skill.name) {
    case "KhiÃªn báº£o vá»‡": activateShield(skill); break;
    case "Vá»‡ tinh laze":
      // --- Báº®T Äáº¦U ÄOáº N MÃƒ Má»šI ---
      satelliteActive = true;
      satelliteEndTime = Date.now() + skill.duration;
      
      const satCount = Math.min(skill.level || 1, 2);
      const orbitRadius = 60; // Báº¡n cÃ³ thá»ƒ chá»‰nh bÃ¡n kÃ­nh quay á»Ÿ Ä‘Ã¢y
      const orbitSpeed = 0.002; // Báº¡n cÃ³ thá»ƒ chá»‰nh tá»‘c Ä‘á»™ quay á»Ÿ Ä‘Ã¢y

      satellites = []; // XÃ³a cÃ¡c vá»‡ tinh cÅ©
      for (let i = 0; i < satCount; i++) {
          satellites.push({
              // GÃ¡n cho má»—i vá»‡ tinh má»™t gÃ³c ban Ä‘áº§u Ä‘á»ƒ chÃºng cÃ¡ch Ä‘á»u nhau
              angle: (2 * Math.PI / satCount) * i, 
              orbitRadius: orbitRadius,
              orbitSpeed: orbitSpeed
          });
      }
      showWarning(`${skill.icon} ${skill.name}!`); // Giá»¯ láº¡i thÃ´ng bÃ¡o
      // --- Káº¾T THÃšC ÄOáº N MÃƒ Má»šI ---
      break;
    case "TÃªn lá»­a F18": activateTwinMissiles(skill); break;
    case "UFO táº¥n cÃ´ng": activateUFO(skill); break;
    case "BÃ£o sÃ©t": activateLightning(skill); break;
    case "Bom B52": activateBombs(skill); break;
    case "áº¢o áº£nh phÃ¢n thÃ¢n": activateClones(skill); break;
    case "Há»‘ Ä‘en": activateBlackHole(skill); break;
    case "Biáº¿n hÃ¬nh": activateDisguise(skill); break;
    case "Boom háº¡t nhÃ¢n": activateNuclearBomb(skill); break;
    case "Quáº£ cáº§u háº¥p huyáº¿t": activateBloodOrb(skill); break;
    case "Cá»•ng KhÃ´ng Gian": activateSpaceGate(skill); break;
  }

// LÃ m sÃ¡ng nÃºt ká»¹ nÄƒng tÆ°Æ¡ng á»©ng vÃ  Ä‘áº¿m ngÆ°á»£c
const list = document.getElementById('skills-list').children;
for (let i = 0; i < list.length; i++) {
  const item = list[i];
  if (item.textContent.includes(skill.name)) {
    item.classList.add("active");
    const endTime = Date.now() + skill.duration;
    const interval = setInterval(() => {
      const remain = Math.ceil((endTime - Date.now()) / 1000);
      if (remain > 0) {
        item.innerHTML = `<span class="skill-icon">${skill.icon}</span> ${skill.name} - ${remain}s`;
} else {
        item.classList.remove("active");
        item.innerHTML = `<span class="skill-icon">${skill.icon}</span> ${skill.name} - ${skill.manaCost}ğŸ’ `;
        clearInterval(interval);
}
}, 1000);
break;
}
}
// Hiá»ƒn thá»‹ thÃ´ng bÃ¡o ká»¹ nÄƒng Ä‘Ã£ kÃ­ch hoáº¡t
  showWarning(`${skill.icon} ${skill.name}!`);
}
// ğŸ§Ÿâ€â™‚ï¸ Ká»¹ nÄƒng: Táº¡o cÃ¡c ká»¹ nÄƒng Ä‘áº·c biá»‡t cho ngÆ°á»i chÆ¡i
// ğŸ›¡ï¸ KhiÃªn báº£o vá»‡: Táº¡o lá»›p cháº¯n cháº·n sÃ¡t thÆ°Æ¡ng vÃ  hiá»ƒn thá»‹ hiá»‡u á»©ng
function activateShield(skill) {
  player.shieldActive = true;
  player.shieldEndTime = Date.now() + skill.duration;

  setTimeout(() => {
    player.shieldActive = false;
}, skill.duration);
}

// ğŸš€ TÃªn lá»­a F18: 2 tÃªn lá»­a bay quanh ngÆ°á»i chÆ¡i, xuyÃªn vÃ  gÃ¢y sÃ¡t thÆ°Æ¡ng zombie
function activateTwinMissiles(skill) {
const createMissilePair = () => {
    // 1. Lá»c ra nhá»¯ng zombie cÃ²n sá»‘ng vÃ  trong pháº¡m vi 360px quanh ngÆ°á»i chÆ¡i
    const potentialTargets = zombies.filter(z => z.active && distance(player, z) <= 360);

    // 2. Náº¿u khÃ´ng cÃ³ má»¥c tiÃªu nÃ o trong táº§m, khÃ´ng lÃ m gÃ¬ cáº£
    if (potentialTargets.length === 0) return;

    // 3. Sáº¯p xáº¿p cÃ¡c má»¥c tiÃªu Ä‘á»ƒ tÃ¬m ra con xa nháº¥t
potentialTargets.sort((a, b) => distance(player, b) - distance(player, a));
// BÃ¢y giá» potentialTargets lÃ  má»™t danh sÃ¡ch Ä‘Ã£ Ä‘Æ°á»£c sáº¯p xáº¿p tá»« xa Ä‘áº¿n gáº§n

// Láº¥y sá»‘ lÆ°á»£ng tÃªn lá»­a tá»« cáº¥p ká»¹ nÄƒng
const missileCount = Math.min(skill.level || 1, 5);
for (let i = 0; i < missileCount; i++) {
    // Náº¿u khÃ´ng cÃ²n Ä‘á»§ má»¥c tiÃªu trong danh sÃ¡ch, dá»«ng táº¡o tÃªn lá»­a
    if (i >= potentialTargets.length) break;

    // THAY Äá»”I: GÃ¡n má»—i tÃªn lá»­a cho má»™t má»¥c tiÃªu khÃ¡c nhau theo thá»© tá»± tá»« xa Ä‘áº¿n gáº§n
    const target = potentialTargets[i]; 
    
    const angleOffset = Math.random() * Math.PI * 2;
    const radius = 40;
    const x = player.x + Math.cos(angleOffset) * radius;
    const y = player.y + Math.sin(angleOffset) * radius;

    missiles.push({
        x, y,
        dx: 0,
        dy: 0,
        target, // <-- Má»—i tÃªn lá»­a giá» Ä‘Ã£ cÃ³ má»¥c tiÃªu riÃªng
        damage: skill.baseDamage,
        delay: 120,
        state: "delay",
        startX: x,
        startY: y,
        hitSet: new Set()
    });
}
};

// ğŸŸ¢ Táº¡o NGAY láº­p tá»©c
  createMissilePair();

// â± Sau Ä‘Ã³ tiáº¿p tá»¥c táº¡o má»—i 2s
  const interval = setInterval(createMissilePair, 2000);
  setTimeout(() => clearInterval(interval), skill.duration);
}

// UFO táº¥n cÃ´ng
function activateUFO(skill) {
  ufoActive = true;
  ufoEndTime = Date.now() + skill.duration;
  
  // XÃ¡c Ä‘á»‹nh sá»‘ lÆ°á»£ng UFO dá»±a trÃªn cáº¥p ká»¹ nÄƒng
  const ufoCount = Math.min(skill.level || 3, 3); // Tá»‘i Ä‘a 3 UFO
  const damage = skill.baseDamage;

ufos = Array.from({ length: ufoCount }, (_, i) => {
    // Thá»i gian ngáº«u nhiÃªn tá»« 1-3 giÃ¢y cho má»—i láº§n Ä‘á»•i hÆ°á»›ng
    const interval = 1000 + Math.random() * 2000; 

    return {
        relativeX: 80 + Math.random() * 120,
        relativeY: 120 + Math.random() * 120,
        speedX: (Math.random() - 0.5) * 2,
        speedY: (Math.random() - 0.5) * 1.5,
        
        // THÃŠM VÃ€O:
        directionChangeInterval: interval, // Khoáº£ng thá»i gian giá»¯a 2 láº§n Ä‘á»•i hÆ°á»›ng
        nextDirectionChangeTime: Date.now() + interval, // Má»‘c thá»i gian Ä‘á»ƒ Ä‘á»•i hÆ°á»›ng tiáº¿p theo

    damage,
    laserCooldown: Date.now() + Math.random() * 1000, // Thá»i gian báº¯n ngáº«u nhiÃªn lÃºc Ä‘áº§u
    laserLife: 0,
    angle: 0
};
});
  // XÃ³a UFO sau khi háº¿t thá»i gian ká»¹ nÄƒng
  setTimeout(() => {
    ufoActive = false;
    ufos = [];
  }, skill.duration);
}

// === Helper: váº½ Ä‘Æ°á»ng sÃ©t ngoáº±n ngoÃ¨o =========================
function getZigZag(start, target, segments = 8, jitter = 20) {
  const pts = [start];                         // Ä‘iá»ƒm Ä‘áº§u lÃ  Ä‘Ã¡m mÃ¢y
  for (let i = 1; i < segments; i++) {
    const t = i / segments;                    // ná»™i suy tuyáº¿n tÃ­nh
    pts.push({
      x: start.x + (target.x - start.x) * t + (Math.random() - 0.5) * jitter,
      y: start.y + (target.y - start.y) * t + (Math.random() - 0.5) * jitter
    });
  }
    pts.push({
      x: target.x + (Math.random() - 0.5) * jitter,
      y: target.y + (Math.random() - 0.5) * jitter
});
  return pts;                                  // máº£ng [{x,y}, â€¦]
}

// ğŸŒ©ï¸ bÃ£o sÃ©t: Gá»i sÃ©t ngáº«u nhiÃªn gÃ¢y sÃ¡t thÆ°Æ¡ng diá»‡n rá»™ng
function activateLightning(skill) {
    lightningActive = true;
    lightningStartTime = Date.now(); // Sá»­ dá»¥ng biáº¿n nÃ y lÃ m má»‘c thá»i gian báº¯t Ä‘áº§u
    lightningEndTime = lightningStartTime + skill.duration;

    const boltCount = Math.min(skill.level || 5, MAX_LV.lightning);
    lightningBolts = []; // Reset láº¡i cÃ¡c Ä‘Ã¡m mÃ¢y
    for (let i = 0; i < boltCount; i++) {
    lightningBolts.push({
        // ÄÃ£ xÃ³a offsetX
        damage: skill.baseDamage,
        nextZapTime: Date.now() + Math.random() * 1000 // Thá»i gian cho láº§n phÃ³ng sÃ©t tiáº¿p theo
        });
    }
    
    // Háº¹n giá» Ä‘á»ƒ táº¯t ká»¹ nÄƒng
    setTimeout(() => {
        lightningActive = false;
        lightningBolts = [];
    }, skill.duration);
}

// KÃ­ch hoáº¡t ká»¹ nÄƒng Bom B52 - tÃ¡i sá»­ dá»¥ng hÃ m activateBombs
function spawnPlanes(skill, amount = 3) {
  const planeYBase = player.y - 180; // Vá»‹ trÃ­ mÃ¡y bay báº¯t Ä‘áº§u

  for (let i = 0; i < amount; i++) {
    const plane = {
      x: -100,
      y: planeYBase - i * 20,
      targetY: planeYBase - i * 20,
      vx: 1.5 + i * 0.5,
      lastDropTime: Date.now(),
      nextDropDelay: 5000 + i * 500 + Math.random() * 300,

      // ğŸ‘‡ Hiá»‡u á»©ng biáº¿n máº¥t
      scale: 1,
      opacity: 1,
      disappearing: false
    };

    activePlanes.push(plane);

    // âœ… Cáº­p nháº­t tá»‘c Ä‘á»™ ngang má»—i 1â€“5 giÃ¢y
    function schedulePlaneSpeedAdjust() {
      const delay = Math.random() * (5000 - 1000) + 1000;
      plane._speedTimeout = setTimeout(() => {
        plane.vx = Math.random() * (5 - 0.5) + 0.5;
        schedulePlaneSpeedAdjust(); // Gá»i láº¡i Ä‘á»ƒ láº·p
      }, delay);
    }

    // âœ… Cáº­p nháº­t Ä‘á»™ cao dao Ä‘á»™ng má»—i 1â€“5 giÃ¢y
    function schedulePlaneHeightAdjust() {
      const delay = Math.random() * (5000 - 1000) + 1000;
      plane._heightTimeout = setTimeout(() => {
        plane.targetY += (Math.random() - 0.5) * 40; // dao Ä‘á»™ng Â±20
        schedulePlaneHeightAdjust(); // Láº·p tiáº¿p
      }, delay);
    }

    // ğŸ”„ KÃ­ch hoáº¡t 2 chu ká»³ Ä‘iá»u chá»‰nh
    schedulePlaneSpeedAdjust();
    schedulePlaneHeightAdjust();

    // ğŸ® Cáº­p nháº­t chuyá»ƒn Ä‘á»™ng vÃ  tháº£ bom Ä‘á»‹nh ká»³
    const planeInterval = setInterval(() => {
      const now = Date.now();

      // â¡ Di chuyá»ƒn theo tá»‘c Ä‘á»™ hiá»‡n táº¡i
      plane.x += plane.vx;

      // ğŸ“ˆ Bay mÆ°á»£t Ä‘áº¿n targetY
      plane.y += (plane.targetY - plane.y) * 0.05;

      // ğŸ’£ Tháº£ bom náº¿u Ä‘áº¿n thá»i Ä‘iá»ƒm
      if (now - plane.lastDropTime > plane.nextDropDelay) {
        plane.lastDropTime = now;
        plane.nextDropDelay = 1000 + Math.random() * 2000; // tá»« 1â€“3s

        const targetY = plane.y + 100 + Math.random() * (canvas.height * 0.9); // 90%
        bombsB52.push({
          x: plane.x,
          y: plane.y,
          vy: 3,
          exploded: false,
          landed: false,
          finalY: targetY,
          timerAfterLand: 180,
          radius: 15,
          damage: skill.baseDamage
        });
      }

      // ğŸŒ€ Khi gáº§n rÃ¬a map thÃ¬ báº¯t Ä‘áº§u biáº¿n máº¥t
      if (!plane.disappearing && plane.x > worldWidth - 180) {
        plane.disappearing = true;
      }

      // ğŸ§¼ Hiá»‡u á»©ng thu nhá» vÃ  xoÃ¡ mÃ¡y bay
      if (plane.disappearing) {
        plane.scale *= 0.95;
        plane.opacity -= 0.05;

        if (plane.scale < 0.1 || plane.opacity <= 0) {
          clearInterval(planeInterval);
          clearTimeout(plane._speedTimeout);
          clearTimeout(plane._heightTimeout);
          activePlanes.splice(activePlanes.indexOf(plane), 1);
        }
      }
    }, 50);
  }
}
const planeWaves = [
  { delay: 0, amount: 1 },      // táº¡o 3 mÃ¡y bay ngay láº­p tá»©c
  { delay: 3000, amount: 1 },  // táº¡o 5 mÃ¡y bay sau 30s
  { delay: 6000, amount: 1 },
  { delay: 9000, amount: 1 },  // táº¡o 2 mÃ¡y bay sau 60s
];
// ğŸ’£ Bom B52: rÆ¡i xuá»‘ng, ná»• khi trÃºng zombie, náº¿u khÃ´ng trÃºng thÃ¬ ná»• sau 5s khi cháº¡m Ä‘áº¥t
function activateBombs(skill) {
  const skillEndTime = Date.now() + skill.duration;

  planeWaves.forEach(wave => {
    setTimeout(() => {
      spawnPlanes(skill, wave.amount);
    }, wave.delay);
  });
  // ğŸ’£ Update bom rÆ¡i nhÆ° cÅ©
  const updateInterval = setInterval(() => {
    for (let i = bombsB52.length - 1; i >= 0; i--) {
      const bomb = bombsB52[i];
      if (bomb.exploded) continue;

      if (!bomb.landed) {
        bomb.y += bomb.vy;
        for (let z of zombies) {
          if (z.active && distance(bomb, z) < bomb.radius + z.radius) {
            explodeB52Bomb(bomb);
            bombsB52.splice(i, 1);
            break;
          }
        }
        if (bomb.y >= bomb.finalY) {
          bomb.y = bomb.finalY;
          bomb.landed = true;
        }
      } else {
        bomb.timerAfterLand--;
        if (bomb.timerAfterLand <= 0) {
          explodeB52Bomb(bomb);
          bombsB52.splice(i, 1);
        }
      }
    }

    if (Date.now() > skillEndTime && bombsB52.length === 0) {
      clearInterval(updateInterval);
    }
  }, 1000 / 60);

function explodeB52Bomb(bomb) {
    bomb.exploded = true;

    // âœ¨ Báº®T Äáº¦U PHáº¦N Cáº¢I TIáº¾N âœ¨
    // 1. Vá»¥ ná»• chÃ­nh (100% sÃ¡t thÆ°Æ¡ng)
    zombies.forEach(z => {
        if (z.active && distance(bomb, z) < 200) { // BÃ¡n kÃ­nh ná»• 200px
            dealDamageToZombie(z, bomb.damage);
        }
    });
    createParticleExplosion(bomb.x, bomb.y, 50, 'fire'); // Hiá»‡u á»©ng ná»• chÃ­nh

    // 2. Vá»¥ ná»• phá»¥ (50% sÃ¡t thÆ°Æ¡ng) sau 0.2 giÃ¢y
    setTimeout(() => {
        zombies.forEach(z => {
            if (z.active && distance(bomb, z) < 200) {
                // GÃ¢y thÃªm 50% sÃ¡t thÆ°Æ¡ng
                dealDamageToZombie(z, bomb.damage * 0.5); 
            }
        });
        // Táº¡o má»™t vá»¥ ná»• nhá» hÆ¡n Ä‘á»ƒ bÃ¡o hiá»‡u
        const secondaryExplosion = getExplosion(bomb.x, bomb.y);
        secondaryExplosion.life = 15;
        explosions.push(secondaryExplosion);
    }, 200); // 200ms = 0.2 giÃ¢y
    // âœ¨ Káº¾T THÃšC PHáº¦N Cáº¢I TIáº¾N âœ¨
}
}
// ğŸ­ áº¢o áº£nh phÃ¢n thÃ¢n: Táº¡o 2 báº£n sao báº¯n Ä‘áº¡n há»— trá»£
function activateClones(skill) {
  clonesActive = true;
  clonesEndTime = Date.now() + skill.duration;
  clones = [];

  const moveAngle = Math.random() * Math.PI * 2; // hÆ°á»›ng di chuyá»ƒn chung

  for (let i = 0; i < 2; i++) {
    const offset = (i === 0 ? -40 : 40); // clone trÃ¡i vÃ  pháº£i cÃ¡ch nhau 80px
    clones.push({
      x: player.x + Math.cos(moveAngle + Math.PI / 2) * offset,
      y: player.y + Math.sin(moveAngle + Math.PI / 2) * offset,
      moveAngle: moveAngle,
      moveSpeed: 1.2,                     // Tá»‘c Ä‘á»™ di chuyá»ƒn clone
      baseDamage: skill.baseDamage || 5, // SÃ¡t thÆ°Æ¡ng riÃªng
      lastShot: 0,
      id: Date.now() + i, // Táº¡o 1 ID tia lazer
      shotCount: 0
    });
  }
}
// ğŸ•³ï¸ Há»‘ Ä‘en: HÃºt zombie vÃ o tÃ¢m vÃ  gÃ¢y sÃ¡t thÆ°Æ¡ng liÃªn tá»¥c
function activateBlackHole(skill) {
  const holeCount = Math.min(skill.level || 2, 2);
  
  // âœ¨ THAY Äá»”I: TÃ¡ch biá»‡t kÃ­ch thÆ°á»›c vÃ  pháº¡m vi hÃºt
  const VISUAL_RADIUS = 150;  // KÃ­ch thÆ°á»›c há»‘ Ä‘en sáº½ Ä‘Æ°á»£c váº½ trÃªn mÃ n hÃ¬nh
  const PULL_RADIUS = 200; // Pháº¡m vi hÃºt zombie xung quanh

  const firstAngle = Math.random() * Math.PI * 2;

  for (let i = 0; i < holeCount; i++) {
    const angle = firstAngle + (i * Math.PI);
    const distance = 80 + Math.random() * 80;

    const x = player.x + Math.cos(angle) * distance;
    const y = player.y + Math.sin(angle) * distance;

    blackHoles.push({
      x: x,
      y: y,
      radius: VISUAL_RADIUS,     // GÃ¡n kÃ­ch thÆ°á»›c Váº¼
      pullRadius: PULL_RADIUS,   // âœ¨ THÃŠM Má»šI: GÃ¡n pháº¡m vi HÃšT
      damage: skill.baseDamage,
      pullSpeed: 3.5,
      tick: 0,
      endTime: Date.now() + skill.duration,
      dx: (Math.random() - 0.5) * 0.1,
      dy: (Math.random() - 0.5) * 0.1
    });
  }
}

// ğŸ¸ Biáº¿n hÃ¬nh: Zombie táº¡m thá»i khÃ´ng phÃ¡t hiá»‡n ngÆ°á»i chÆ¡i (áº©n thÃ¢n)
function activateDisguise(skill) {
  disguiseActive = true;
  disguiseEndTime = Date.now() + skill.duration;

  // (Má»šI) Buff táº¡m thá»i khi kÃ­ch hoáº¡t
  player.hearts += 20;
  showWarning("ğŸ¸ Biáº¿n hÃ¬nh! +20 HP & TÄƒng tá»‘c!");

  zombies.forEach(z => {
    if (!z.isBoss) {
      z.state = "wandering";
      z.wanderTime = Date.now() + 6000 + Math.random() * 4000;// Thá»i gian Ä‘i lang thang ngáº«u nhiÃªn tá»« 6s Ä‘áº¿n 10s
      z.wanderAngle = Math.random() * Math.PI * 2;

      // ğŸ’¬ Biá»ƒu cáº£m ngáº«u nhiÃªn náº¿u khÃ´ng pháº£i boss
      if (Math.random() < 0.6) {
        const expressions = ["ğŸ˜•", "ğŸ¤¢", "ğŸ˜´", "ğŸ˜³", "ğŸ¤®"];
        z.iconToDraw = expressions[Math.floor(Math.random() * expressions.length)];
        setTimeout(() => { z.iconToDraw = null; }, 5000); // Biá»ƒu cáº£m biáº¿n máº¥t sau 5s
      }
    }
  });
// Khi háº¿t thá»i gian
setTimeout(() => {
    disguiseActive = false;
    player.hearts = Math.max(1, player.hearts - 20);
    showWarning("ğŸ¸ Háº¿t biáº¿n hÃ¬nh!");

    // --- LOGIC BOM KHÃ“I ---
    // 1. Táº¡o hiá»‡u á»©ng khÃ³i hÃ¬nh áº£nh
    createParticleExplosion(player.x, player.y, 70, 'smoke');

    // 2. Äáº©y lÃ¹i vÃ  lÃ m choÃ¡ng zombie á»Ÿ gáº§n
    const pushRadius = 300;
    const pushForce = 30;

    zombies.forEach(z => {
        if (z.active && distance(player, z) < pushRadius) {
            const angle = Math.atan2(z.y - player.y, z.x - player.x);
            z.x += Math.cos(angle) * pushForce;
            z.y += Math.sin(angle) * pushForce;
            z.state = "wandering"; // Buá»™c zombie Ä‘i lang thang
        }
    });

}, skill.duration);

}
// MÃ u cho bom háº¡t nhÃ¢n khi phÃ¡t ná»•
const colors = [
    "rgba(255,255,255,0.7)", // tráº¯ng
    "rgba(255,0,0,0.7)",     // Ä‘á»
    "rgba(0,255,0,0.7)",     // xanh lÃ¡
    "rgba(0,200,255,0.7)",   // cyan
    "rgba(255,200,0,0.7)",   // vÃ ng
    "rgba(255,0,255,0.7)"    // tÃ­m
];
// â˜¢ï¸ Bom Háº¡t NhÃ¢n: RÆ¡i xuá»‘ng giá»¯a mÃ n hÃ¬nh, Ä‘áº¿m ngÆ°á»£c 5s rá»“i táº¡o vÃ²ng ná»• lan rá»™ng
function activateNuclearBomb(skill) {
    if (nuclearBombs.length >= 1) return;
    document.getElementById('sfx-nuke-fall').play(); // PhÃ¡t Ã¢m thanh bom rÆ¡i
    nuclearBombs.push({
        x: player.x,
        y: 100,
        vy: 3.5,
        exploded: false,
        landed: false,
        timerAfterLand: 5 * 60,
        damage: skill.baseDamage * 10,
        radius: 22,
        finalY: player.y,
        shockwave: false,
        shockwaveRadius: 0,
        shockwaveSpeed: 2
    });
    const updateInterval = setInterval(() => {
        if (nuclearBombs.length === 0) {
            clearInterval(updateInterval);
            return;
        }

        const bomb = nuclearBombs[0];
        if (bomb.exploded && !bomb.shockwave) return;
        // ğŸ’¨ Khi bom cháº¡m Ä‘áº¥t â€“ táº¡o háº¡t bá»¥i bay vÃ o tÃ¢m bom
        if (bomb.landed && !bomb.exploded) {
        for (let i = 0; i < 2; i++) {
        createSuctionDust(bomb.x, bomb.y, 0.6); // Tá»‘c Ä‘á»™ tan nhanh cháº­m
        }
        }
        // Bom rÆ¡i xuá»‘ng
        if (!bomb.landed) {
            bomb.y += bomb.vy;
            if (bomb.y >= bomb.finalY) {
                bomb.landed = true;
                bomb.y = bomb.finalY;
                playSound('sfx-nuke-time', 0.8); // PhÃ¡t Ã¢m thanh Ä‘áº¿m giá»
            }
        }
        // Äáº¿m ngÆ°á»£c ná»•
        else if (!bomb.exploded) {
            bomb.timerAfterLand--;
            if (bomb.timerAfterLand <= 0) {
                explodeNuclearBomb(bomb);
            }
        }

        // SÃ³ng xung kÃ­ch sau khi ná»•
        if (bomb.exploded && bomb.shockwave) {
            bomb.shockwaveRadius += bomb.shockwaveSpeed;
            zombies.forEach(z => {
                if (z.active && distance(bomb, z) < bomb.shockwaveRadius) {
                    // Chá»‰ gÃ¢y sÃ¡t thÆ°Æ¡ng náº¿u zombie khÃ´ng cÃ³ cooldown
                    if (!z.nukeCooldown || Date.now() > z.nukeCooldown) {
                        dealDamageToZombie(z, bomb.damage);
                        
                        // Äáº·t láº¡i cooldown 1 giÃ¢y cho con zombie nÃ y
                        z.nukeCooldown = Date.now() + 1000; // 1s má»›i nháº­n láº¡i sÃ¡t thÆ°Æ¡ng
                    }
                }
            });
            enemyBullets.forEach(b => {
                if (!b.active) return;
                if (distance(bomb, b) < bomb.shockwaveRadius) {
                    releaseEnemyBullet(b);
                    explosions.push(getExplosion(b.x, b.y));
                }
            });
            if (bomb.shockwaveRadius > Math.max(canvas.width, canvas.height) * 1.4) {
                nuclearBombs.shift();
                bomb.shockwave = false;
            }
        }
    }, 1000 / 60);
    // HÃ m phÃ¡t ná»•
    function explodeNuclearBomb(bomb) {
        // Dá»«ng Ã¢m thanh cÃ²i hÃº/rÆ¡i
        const fallSound = document.getElementById('sfx-nuke-fall');
        if (fallSound) {
            fallSound.pause();
            fallSound.currentTime = 0; // Reset Ä‘á»ƒ láº§n sau cÃ³ thá»ƒ phÃ¡t láº¡i tá»« Ä‘áº§u
        }
        // PhÃ¡t Ã¢m thanh ná»•
        playSound('sfx-nuke-explode', 1.0); // PhÃ¡t á»Ÿ 100% Ã¢m lÆ°á»£ng

        bomb.exploded = true;
        bomb.shockwave = true;
        bomb.shockwaveRadius = 0;
        explosions.push(getExplosion(bomb.x, bomb.y)); // ğŸ’¥ hiá»‡u á»©ng ná»• nhá» trung tÃ¢m
        // ğŸŒŠ ThÃªm 2 vÃ²ng ná»• phá»¥ má»—i 2 giÃ¢y
        setTimeout(() => {
            extraShockwaves.push({
                x: bomb.x,
                y: bomb.y,
                radius: 0,
                maxRadius: 300,
                color: "red",
                alpha: 1
            });
        }, 2000);
        setTimeout(() => {
            extraShockwaves.push({
                x: bomb.x,
                y: bomb.y,
                radius: 0,
                maxRadius: 400,
                color: "cyan",
                alpha: 1
            });
        }, 4000);
        // ğŸ’¨ Háº¡t bá»¥i bay ra khi bom phÃ¡t ná»•
        for (let i = 0; i < 60; i++) {
    const angle = Math.random() * Math.PI * 2;
    const speed = Math.random() * 1 + 0.5;
    const color = colors[Math.floor(Math.random() * colors.length)]; // mÃ u ngáº«u nhiÃªn
    particles.push({
        x: bomb.x,
        y: bomb.y,
        vx: Math.cos(angle) * speed,
        vy: Math.sin(angle) * speed,
        size: Math.random() * 3 + 1,
        color: color,
        alpha: 1
    });
}
}
}
// ğŸ©¸ Quáº£ cáº§u háº¥p huyáº¿t
function activateBloodOrb(skill) {
    bloodOrbActive = true;
    bloodOrbEndTime = Date.now() + skill.duration;

    // XÃ¡c Ä‘á»‹nh sá»‘ lÆ°á»£ng quáº£ cáº§u theo level (tá»‘i Ä‘a 2)
    const maxCount = Math.min(skill.level || 2, 2); // Tá»‘i Ä‘a 2 quáº£ cáº§u háº¥p huyáº¿t
    bloodOrbCount = maxCount;

    bloodOrbs = Array.from({ length: maxCount }, (_, i) => ({
        angle: (2 * Math.PI / maxCount) * i,
        radius: 60,
        x: player.x,
        y: player.y
    }));
}
// ================== Cá»”NG KHÃ”NG GIAN ==================

// HÃ m tÃ¬m má»™t vá»‹ trÃ­ an toÃ n Ä‘á»ƒ dá»‹ch chuyá»ƒn Ä‘áº¿n
function findSafeTeleportLocation() {
    let bestLocation = null;
    let lowestZombieCount = Infinity;
    const MAX_ATTEMPTS = 20; // Thá»­ tÃ¬m 20 láº§n vÃ  chá»n Ä‘iá»ƒm tá»‘t nháº¥t

    const bosses = zombies.filter(z => z.isBoss || z.isBigBoss);

    for (let i = 0; i < MAX_ATTEMPTS; i++) {
        // Táº¡o vá»‹ trÃ­ ngáº«u nhiÃªn trong báº£n Ä‘á»“, trá»« Ä‘i vÃ¹ng rÃ¬a
        const padding = 100;
        const x = Math.random() * (worldWidth - padding * 2) + padding;
        const y = Math.random() * (worldHeight - padding * 2) + padding;
        
        let isValid = true;

        // 1. Kiá»ƒm tra khoáº£ng cÃ¡ch vá»›i Boss
        for (const boss of bosses) {
            if (distance({x, y}, boss) < 500) {
                isValid = false;
                break;
            }
        }
        if (!isValid) continue; // Bá» qua vá»‹ trÃ­ nÃ y náº¿u quÃ¡ gáº§n boss

        // 2. Äáº¿m sá»‘ lÆ°á»£ng zombie xung quanh
        let nearbyZombies = 0;
        for (const z of zombies) {
            if (distance({x, y}, z) < 300) {
                nearbyZombies++;
            }
        }

        // 3. Chá»n vá»‹ trÃ­ cÃ³ Ã­t zombie nháº¥t
        if (nearbyZombies < lowestZombieCount) {
            lowestZombieCount = nearbyZombies;
            bestLocation = { x, y };
        }
    }

    // Náº¿u khÃ´ng tÃ¬m Ä‘Æ°á»£c vá»‹ trÃ­ nÃ o, tráº£ vá» má»™t vá»‹ trÃ­ ngáº«u nhiÃªn xa ngÆ°á»i chÆ¡i
    if (!bestLocation) {
        return {
            x: Math.random() * worldWidth,
            y: Math.random() * worldHeight
        };
    }
    
    return bestLocation;
}

// HÃ m táº¡o má»™t cá»•ng má»›i
function createNewGate(x, y) {
    const safeX = Math.max(wallThickness + 60, Math.min(worldWidth - wallThickness - 60, x));
    const safeY = Math.max(wallThickness + 60, Math.min(worldHeight - wallThickness - 60, y));
    const initialRadius = 40; // BÃ¡n kÃ­nh ban Ä‘áº§u
    spaceGate = {
        x: safeX,
        y: safeY,
        radius: initialRadius,
        originalRadius: initialRadius, // âœ¨ THÃŠM DÃ’NG NÃ€Y: LÆ°u láº¡i bÃ¡n kÃ­nh gá»‘c
        damage: 2,
        rotation: 0,
        alpha: 0 // Váº«n giá»¯ alpha Ä‘á»ƒ cá»•ng má»›i hiá»‡n ra mÆ°á»£t mÃ 
    };
}

// HÃ m kÃ­ch hoáº¡t chÃ­nh
function activateSpaceGate(skill) {
  // Náº¿u Ä‘Ã£ cÃ³ cá»•ng rá»“i thÃ¬ khÃ´ng táº¡o ná»¯a
  if (spaceGateActive) return;

  spaceGateActive = true;
  spaceGateEndTime = Date.now() + skill.duration;

  // Táº¡o cá»•ng ngay trÆ°á»›c máº·t ngÆ°á»i chÆ¡i má»™t khoáº£ng
  // XÃ¡c Ä‘á»‹nh hÆ°á»›ng dá»±a trÃªn phÃ­m Ä‘ang nháº¥n, hoáº·c ngáº«u nhiÃªn náº¿u Ä‘á»©ng yÃªn
  const angle = (keys.a || keys.d || keys.w || keys.s) 
                ? Math.atan2((keys.s ? 1 : 0) - (keys.w ? 1 : 0), (keys.d ? 1 : 0) - (keys.a ? 1 : 0))
                : (zombies.length > 0 ? Math.atan2(zombies[0].y - player.y, zombies[0].x - player.x) : 0);
  const distance = 150;

  createNewGate(player.x + Math.cos(angle) * distance, player.y + Math.sin(angle) * distance, skill.baseDamage);
}

// HÃ m táº¡o cá»•ng má»›i (thay tháº¿ hÃ m cÅ©)
function createNewGate(x, y, damage) {
    // Giá»›i háº¡n vá»‹ trÃ­ cá»•ng khÃ´ng bá»‹ táº¡o ra ngoÃ i báº£n Ä‘á»“
    const safeX = Math.max(wallThickness + 60, Math.min(worldWidth - wallThickness - 60, x));
    const safeY = Math.max(wallThickness + 60, Math.min(worldHeight - wallThickness - 60, y));

    spaceGate = {
        x: safeX,
        y: safeY,
        radius: 50,       // BÃ¡n kÃ­nh hiá»‡u á»©ng cá»§a cá»•ng
        damage: damage,   // SÃ¡t thÆ°Æ¡ng cÆ¡ báº£n
        rotation: 0,
        alpha: 0,         // Äá»™ má» ban Ä‘áº§u (Ä‘á»ƒ lÃ m hiá»‡u á»©ng hiá»‡n ra)
        particles: []     // Máº£ng chá»©a cÃ¡c háº¡t lá»­a trang trÃ­
    };
}
// ğŸ“Œ Báº­t/táº¯t báº£ng ká»¹ nÄƒng báº±ng phÃ­m X
document.addEventListener('keydown', (e) => {
  if (e.key.toLowerCase() === 'x') {
    document.getElementById('skillsOverlay').classList.toggle('hidden');
    updateSkillsList();
  }
});

// ThÃªm ká»¹ nÄƒng má»›i (gá»i hÃ m nÃ y khi lÃªn cáº¥p)
function learnSkill(index) {
  const skill = skillsData[index];
if (!activeSkills.includes(skill)) {
  activeSkills.push(skill);
  /* Sá»¬A khá»‘i gÃ¡n level */
  skill.level = 1;              // â† luÃ´n báº¯t Ä‘áº§u á»Ÿ cáº¥p 1
if (skill.baseDamage !== undefined && skill.level === undefined) {
  skill.level = 0;
}
  updateSkillsList();
  showWarning(`ğŸ‰ Há»c ká»¹ nÄƒng: ${skill.icon} ${skill.name}`);
}
}

// ğŸ¯ PhÃ­m Z Ä‘á»ƒ báº­t/táº¯t báº£ng thá»‘ng kÃª
document.addEventListener("keydown", (e) => {
  if (e.key.toLowerCase() === "z") {
    const panel = document.getElementById("statsOverlay");
    panel.classList.toggle("hidden");
}
});

// ğŸ¯ GÃ¡n phÃ­m ` Ä‘á»ƒ báº­t/táº¯t FPS
document.addEventListener("keydown", (e) => {
  if (e.key === "`") {
    const fpsDiv = document.getElementById("fpsCounter");
    fpsDiv.style.display = fpsDiv.style.display === "none" ? "block" : "none";
}
});
function showGuide() {
  playSound('sfx-ui-click', 0.2);
  document.getElementById("guideOverlay").style.display = "block";
}
function hideGuide() {
  playSound('sfx-ui-click', 0.2);
  document.getElementById("guideOverlay").style.display = "none";
}
function showInfo() {
  playSound('sfx-ui-click', 0.2);
  document.getElementById("infoOverlay").style.display = "block";
}
function hideInfo() {
  playSound('sfx-ui-click', 0.2);
  document.getElementById("infoOverlay").style.display = "none";
}

// --- LOGIC CHO DEBUG MENU (PhiÃªn báº£n thanh kÃ©o) ---

// HÃ m má»Ÿ/Ä‘Ã³ng menu
function toggleDebugMenu() {
    const debugMenu = document.getElementById('debugMenu');
    if (!debugMenu) return;

    const isHidden = debugMenu.classList.toggle('hidden');
    isPaused = !isHidden;

    if (!isHidden) {
        populateDebugMenu();
    }
}

// HÃ€M Cáº¬P NHáº¬T: Äiá»n giÃ¡ trá»‹ vÃ o menu
function populateDebugMenu() {
    const setSliderValue = (id, value) => {
        const slider = document.getElementById(id);
        if (slider) {
            slider.value = value;
            const valueSpan = slider.nextElementSibling;
            if (valueSpan) {
                if (slider.step.includes('.')) {
                    valueSpan.textContent = parseFloat(value).toFixed(1);
                } else {
                    valueSpan.textContent = value;
                }
            }
        }
    };

    // Chá»‰ sá»‘ cÆ¡ báº£n & game
    document.getElementById('debug-exp').value = player.exp;
    setSliderValue('debug-wave', wave);
    setSliderValue('debug-dayTime', (dayTime * 24).toFixed(1));
    setSliderValue('debug-level', player.level);
    setSliderValue('debug-hp', player.hearts);
    setSliderValue('debug-mana', player.mana);
    setSliderValue('debug-energy', player.energy);
    setSliderValue('debug-moveSpeed', player.speed);
    setSliderValue('debug-damage', playerUpgrades.damageBoost);
    setSliderValue('debug-fireRate', playerUpgrades.fireRate);
    setSliderValue('debug-bulletSpeed', playerUpgrades.bulletSpeed);
    setSliderValue('debug-lineCount', playerUpgrades.lineBulletCount);
    setSliderValue('debug-coin', player.coins);
    
    // Chá»‰ sá»‘ ká»¹ nÄƒng passive
    setSliderValue('debug-bladeCount', skillUpgrades.bladeCount);
    setSliderValue('debug-bladeDamage', skillUpgrades.bladeDamage);
    setSliderValue('debug-swordLevel', skillUpgrades.swordLevel);
    setSliderValue('debug-swordDamage', skillUpgrades.swordDamage);
    setSliderValue('debug-fireCount', skillUpgrades.fireCount);
    setSliderValue('debug-fireDamage', skillUpgrades.fireDamage);
    setSliderValue('debug-iceCount', skillUpgrades.iceCount);
    setSliderValue('debug-iceDamage', skillUpgrades.iceDamage);
    setSliderValue('debug-thunderCount', skillUpgrades.thunderCount);
    setSliderValue('debug-thunderDamage', skillUpgrades.thunderDamage);
    setSliderValue('debug-auraHealLevel', skillUpgrades.auraHealLevel);
    setSliderValue('debug-fairyCount', skillUpgrades.fairyCount);
    setSliderValue('debug-fairyHealLevel', skillUpgrades.fairyHealLevel);
    setSliderValue('debug-fairyDamageLevel', skillUpgrades.fairyDamageLevel);

    // Cáº­p nháº­t giÃ¡ trá»‹ cho cÃ¡c thanh trÆ°á»£t ká»¹ nÄƒng active
    skillsData.forEach(skill => {
        const learnedSkill = activeSkills.find(s => s.name === skill.name);
        const currentData = learnedSkill || skill;
        const safeIdName = skill.name.replace(/\s/g, '-');

        if (document.getElementById(`debug-level-${safeIdName}`)) {
            setSliderValue(`debug-level-${safeIdName}`, currentData.level || 1);
        }
        if (document.getElementById(`debug-damage-${safeIdName}`)) {
            setSliderValue(`debug-damage-${safeIdName}`, currentData.baseDamage);
        }
    });
}

// HÃ€M Cáº¬P NHáº¬T: Ãp dá»¥ng cÃ¡c thay Ä‘á»•i
function applyDebugChanges() {
    // Chá»‰ sá»‘ cÆ¡ báº£n & game (giá»¯ nguyÃªn)
    player.exp = parseInt(document.getElementById('debug-exp').value);
    wave = parseInt(document.getElementById('debug-wave').value);
    dayTime = parseFloat(document.getElementById('debug-dayTime').value) / 24;
    updateWaveUI();
    player.level = parseInt(document.getElementById('debug-level').value);
    player.requiredExp = calculateRequiredExp(player.level);
    player.hearts = parseInt(document.getElementById('debug-hp').value);
    player.mana = parseInt(document.getElementById('debug-mana').value);
    player.energy = parseInt(document.getElementById('debug-energy').value);
    player.speed = parseFloat(document.getElementById('debug-moveSpeed').value);
    playerUpgrades.damageBoost = parseFloat(document.getElementById('debug-damage').value);
    playerUpgrades.fireRate = parseInt(document.getElementById('debug-fireRate').value);
    playerUpgrades.bulletSpeed = parseFloat(document.getElementById('debug-bulletSpeed').value);
    playerUpgrades.lineBulletCount = parseInt(document.getElementById('debug-lineCount').value);
    player.coins = parseInt(document.getElementById('debug-coin').value);

    // Chá»‰ sá»‘ ká»¹ nÄƒng passive (giá»¯ nguyÃªn)
    skillUpgrades.bladeCount = parseInt(document.getElementById('debug-bladeCount').value);
    skillUpgrades.bladeDamage = parseFloat(document.getElementById('debug-bladeDamage').value);
    skillUpgrades.swordLevel = parseInt(document.getElementById('debug-swordLevel').value);
    skillUpgrades.swordDamage = parseFloat(document.getElementById('debug-swordDamage').value);
    skillUpgrades.fireCount = parseInt(document.getElementById('debug-fireCount').value);
    skillUpgrades.fireDamage = parseFloat(document.getElementById('debug-fireDamage').value);
    skillUpgrades.iceCount = parseInt(document.getElementById('debug-iceCount').value);
    skillUpgrades.iceDamage = parseFloat(document.getElementById('debug-iceDamage').value);
    skillUpgrades.thunderCount = parseInt(document.getElementById('debug-thunderCount').value);
    skillUpgrades.thunderDamage = parseFloat(document.getElementById('debug-thunderDamage').value);
    skillUpgrades.auraHealLevel = parseInt(document.getElementById('debug-auraHealLevel').value);
    skillUpgrades.fairyCount = parseInt(document.getElementById('debug-fairyCount').value);
    skillUpgrades.fairyHealLevel = parseInt(document.getElementById('debug-fairyHealLevel').value);
    skillUpgrades.fairyDamageLevel = parseInt(document.getElementById('debug-fairyDamageLevel').value);
    
    // --- Báº®T Äáº¦U Sá»¬A Lá»–I LOGIC Ká»¸ NÄ‚NG ACTIVE ---
    skillsData.forEach(skill => {
        const safeIdName = skill.name.replace(/\s/g, '-');
        const levelSlider = document.getElementById(`debug-level-${safeIdName}`);
        const damageSlider = document.getElementById(`debug-damage-${safeIdName}`);
        let hasChanges = false;

        const learnedSkill = activeSkills.find(s => s.name === skill.name);
        const currentData = learnedSkill || skill;

        if (levelSlider) {
            const newLevel = parseInt(levelSlider.value);
            if (newLevel !== (currentData.level || 1)) {
                skill.level = newLevel;
                hasChanges = true;
            }
        }
        
        if (damageSlider) {
            const newDamage = parseFloat(damageSlider.value);
            if (newDamage !== currentData.baseDamage) {
                skill.baseDamage = newDamage;
                hasChanges = true;
            }
        }
        
        // Náº¿u cÃ³ thay Ä‘á»•i vÃ  ká»¹ nÄƒng chÆ°a Ä‘Æ°á»£c há»c -> tá»± Ä‘á»™ng há»c
        if (hasChanges && !activeSkills.includes(skill)) {
            // Äáº£m báº£o gÃ¡n level 1 khi há»c láº§n Ä‘áº§u, giá»‘ng nhÆ° hÃ m learnSkill()
            if (skill.level === undefined) {
                skill.level = 1;
            }
            activeSkills.push(skill);
        }
    });
    // --- Káº¾T THÃšC Sá»¬A Lá»–I ---

    updateUI();
    updateStatsOverlay();
    // QUAN TRá»ŒNG: Gá»i updateSkillsList() á»Ÿ cuá»‘i Ä‘á»ƒ lÃ m má»›i giao diá»‡n ká»¹ nÄƒng vÃ  tooltip
    updateSkillsList(); 
    showWarning('ğŸ”§ CÃ¡c chá»‰ sá»‘ Ä‘Ã£ Ä‘Æ°á»£c cáº­p nháº­t!');
}

// Äá»£i cho Ä‘áº¿n khi toÃ n bá»™ tÃ i liá»‡u HTML Ä‘Æ°á»£c táº£i xong rá»“i má»›i cháº¡y mÃ£ bÃªn trong
document.addEventListener('DOMContentLoaded', function () {
    const loadingOverlay = document.getElementById('loadingOverlay');
    const loadingText = document.getElementById('loadingText');
    const startMenu = document.getElementById('startMenu');
/*
    loadingOverlay.style.display = 'none'; // áº¨n mÃ n hÃ¬nh loading Ä‘i
    startMenu.style.display = 'flex';     // Hiá»‡n menu chÃ­nh lÃªn ngay láº­p tá»©c
*/
    // 1. áº¨n menu chÃ­nh Ä‘i ngay tá»« Ä‘áº§u
    startMenu.style.display = 'none';

    // 2. Báº¯t Ä‘áº§u quÃ¡ trÃ¬nh táº£i audio (giá»¯ nguyÃªn)
    initAudioPool(
        5,
        (loaded, total) => {
            loadingText.innerText = `Äang táº£i tÃ i nguyÃªn... (${loaded}/${total})`;
        },
        // 3. Cáº¬P NHáº¬T LOGIC KHI Táº¢I XONG
        () => {
            console.log("Audio resources fully loaded and ready.");
            loadingText.innerText = 'Sáºµn sÃ ng!';

            // ---- Báº®T Äáº¦U THAY Äá»”I ----
            // Giá»¯ mÃ n hÃ¬nh "Sáºµn sÃ ng!" thÃªm 1 giÃ¢y Ä‘á»ƒ audio thá»±c sá»± Ä‘Æ°á»£c giáº£i mÃ£
            setTimeout(() => {
                // Báº¯t Ä‘áº§u quÃ¡ trÃ¬nh chuyá»ƒn Ä‘á»•i
                loadingOverlay.classList.add('hidden'); // Báº¯t Ä‘áº§u lÃ m má» mÃ n hÃ¬nh loading
                startMenu.style.display = 'flex';     // Hiá»‡n menu chÃ­nh lÃªn

                // Sau khi hiá»‡u á»©ng má» káº¿t thÃºc, áº©n háº³n loading overlay Ä‘i
                // Ä‘á»ƒ khÃ´ng cháº·n click chuá»™t vÃ o menu
                setTimeout(() => {
                    loadingOverlay.style.display = 'none';
                }, 500); // Thá»i gian nÃ y pháº£i khá»›p vá»›i transition trong CSS

            }, 1000); // <-- Chá» 1 giÃ¢y (1000ms)
            // ---- Káº¾T THÃšC THAY Äá»”I ----
        }
    );
    // GÃ¡n sá»± kiá»‡n nháº¥n phÃ­m '/' vÃ  'o'
    document.addEventListener('keydown', (e) => {
        switch (e.key) {
            case '/':
                e.preventDefault();
                if (debugKeyTimer === null) {
                    debugKeyTimer = setTimeout(() => {
                        toggleDebugMenu();
                        debugKeyTimer = null;
                    }, 500); // Äá»£i 0.5 giÃ¢y trÆ°á»›c khi má»Ÿ menu
                }
                break;

            case 'o':
                if (gameStarted && !gameOver) {
                    toggleShop();
                }
                break;
        }
    });

    // Báº¯t sá»± kiá»‡n khi ngÆ°á»i dÃ¹ng THáº¢ phÃ­m `/` RA
    document.addEventListener('keyup', (e) => {
        if (e.key === '/') {
            if (debugKeyTimer) {
                clearTimeout(debugKeyTimer);
                debugKeyTimer = null;
            }
        }
    });

    // GÃ¡n sá»± kiá»‡n cho cÃ¡c nÃºt báº¥m "Ãp dá»¥ng" vÃ  "ÄÃ³ng"
    const applyBtn = document.getElementById('applyDebugChanges');
    if (applyBtn) {
        applyBtn.onclick = applyDebugChanges;
    }

    const closeBtn = document.getElementById('closeDebugMenu');
    if (closeBtn) {
        closeBtn.onclick = toggleDebugMenu;
    }

    // GÃ¡n sá»± kiá»‡n 'input' cho táº¥t cáº£ thanh kÃ©o Ä‘á»ƒ cáº­p nháº­t sá»‘ hiá»ƒn thá»‹ khi ngÆ°á»i dÃ¹ng kÃ©o
    const sliders = document.querySelectorAll('#debugMenu input[type="range"]');
    sliders.forEach(slider => {
        const valueSpan = slider.nextElementSibling;
        if (valueSpan) {
            slider.addEventListener('input', () => {
                if (slider.step.includes('.')) {
                    valueSpan.textContent = parseFloat(slider.value).toFixed(1);
                } else {
                    valueSpan.textContent = slider.value;
                }
            });
        }
    });

    // Tá»± Ä‘á»™ng phÃ¡t bÃ i hÃ¡t ngáº«u nhiÃªn khÃ¡c khi má»™t bÃ i hÃ¡t bÃ¬nh thÆ°á»ng káº¿t thÃºc
    normalMusicTracks.forEach(id => {
        const track = document.getElementById(id);
        if (track) {
            track.addEventListener('ended', function () {
                if (currentMusicState === 'normal') {
                    playRandomNormalMusic();
                }
            });
        }
    });

    // GÃ¡n sá»± kiá»‡n nÃºt Ä‘Ã³ng Shop
    const closeShopBtn = document.getElementById('closeShopBtn');
    if (closeShopBtn) {
        closeShopBtn.onclick = toggleShop;
    }

    // --- Káº¾T THÃšC: Ná»˜I DUNG Tá»ª KHá»I DOMContentLoaded THá»¨ NHáº¤T ---

    // --- Báº®T Äáº¦U: Ná»˜I DUNG Tá»ª KHá»I DOMContentLoaded THá»¨ HAI ---

    // Báº¯t sá»± kiá»‡n phÃ­m ESC
    document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') {
            if (gameStarted && !gameOver) {
                togglePauseMenu();
            }
        }
    });

    // GÃ¡n sá»± kiá»‡n cho cÃ¡c nÃºt trong Pause Menu
    document.getElementById('resumeBtn').onclick = togglePauseMenu;
    document.getElementById('restartBtnPause').onclick = resetGame;
    document.getElementById('guideBtnPause').onclick = showGuide;
    document.getElementById('infoBtnPause').onclick = showInfo;
    document.getElementById('exitBtn').onclick = () => location.reload();

    // GÃ¡n sá»± kiá»‡n cho cÃ¡c thanh trÆ°á»£t Ã¢m lÆ°á»£ng
    const masterSlider = document.getElementById('volume-master');
    const musicSlider = document.getElementById('volume-music');
    const sfxSlider = document.getElementById('volume-sfx');

    if (masterSlider) {
        masterSlider.addEventListener('input', () => {
            masterVolume = parseFloat(masterSlider.value);
            masterSlider.nextElementSibling.textContent = `${Math.round(masterVolume*100)}%`;
            updateAllMusicVolume();
        });
    }
    if (musicSlider) {
        musicSlider.addEventListener('input', () => {
            musicVolume = parseFloat(musicSlider.value);
            musicSlider.nextElementSibling.textContent = `${Math.round(musicVolume*100)}%`;
            updateAllMusicVolume();
        });
    }
    if (sfxSlider) {
        sfxSlider.addEventListener('input', () => {
            sfxVolume = parseFloat(sfxSlider.value);
            sfxSlider.nextElementSibling.textContent = `${Math.round(sfxVolume*100)}%`;
        });
    }

    // --- Káº¾T THÃšC: Ná»˜I DUNG Tá»ª KHá»I DOMContentLoaded THá»¨ HAI ---
    
}); // <-- Káº¿t thÃºc khá»‘i DOMContentLoaded duy nháº¥t
// --- LOGIC CHO PAUSE MENU ---

function togglePauseMenu() {
    const menu = document.getElementById('pauseMenu');
    if (!menu) return; // ThÃªm kiá»ƒm tra Ä‘á»ƒ trÃ¡nh lá»—i

    const isHidden = menu.classList.toggle('hidden');
    isPaused = !isHidden;
    
    // Khi má»Ÿ menu, cáº­p nháº­t giÃ¡ trá»‹ cÃ¡c thanh trÆ°á»£t vá» giÃ¡ trá»‹ hiá»‡n táº¡i
    if (!isHidden) {
        document.getElementById('volume-master').value = masterVolume;
        document.getElementById('volume-music').value = musicVolume;
        document.getElementById('volume-sfx').value = sfxVolume;
        // Cáº­p nháº­t text hiá»ƒn thá»‹ %
        document.querySelector('#volume-master + .range-value').textContent = `${Math.round(masterVolume*100)}%`;
        document.querySelector('#volume-music + .range-value').textContent = `${Math.round(musicVolume*100)}%`;
        document.querySelector('#volume-sfx + .range-value').textContent = `${Math.round(sfxVolume*100)}%`;
    }
}

</script>
<!-- ğŸŒŸ Popup khi lÃªn cáº¥p -->
<div id="levelUpPopup">Level Up!</div>
<!-- ğŸŒŸ Popup chá»n nÃ¢ng cáº¥p -->
<div id="upgradePopup">
  <h3 class="upgradeTitle">â« Chá»n nÃ¢ng cáº¥p</h3>
  <div id="upgradeChoices" class="upgradeChoices"></div>
</div>

<!-- ğŸ“Š Overlay hiá»ƒn thá»‹ thá»‘ng sá»‘ ká»¹ nÄƒng -->
<div id="statsOverlay" class="hidden">
  <h3>ğŸ“Š Thá»‘ng kÃª</h3>
  <div id="highScoreDisplay" style="text-align: center; font-weight: 300; margin: 2px 0; position: relative; top: -6px;">
  ğŸ† Ká»· lá»¥c: 0
  </div>
  <div id="stat-moveSpeed">ğŸ‘Ÿ Tá»‘c Ä‘á»™ cháº¡y: - </div>
  <div id="stat-damage">ğŸ’¥ SÃ¡t thÆ°Æ¡ng: - </div>
  <div id="stat-fireRate">ğŸ”« HÆ°á»›ng báº¯n: - </div>
  <div id="stat-speed">ğŸ’¨ Tá»‘c Ä‘á»™: - </div>
  <div id="stat-lineCount">ğŸ§¨ Sá»‘ lÆ°á»£ng Ä‘áº¡n: - </div>
  <div id="stat-blade">ğŸ”ª Äao: -</div>
  <div id="stat-sword">âš”ï¸ Kiáº¿m: -</div>
  <div id="stat-fire">ğŸ”¥ Lá»­a: -</div>
  <div id="stat-ice">â„ï¸ BÄƒng: -</div>
  <div id="stat-thunder">ğŸ”µ LÃ´i: -</div>
  <div id="stat-skills"></div> <!-- ká»¹ nÄƒng khÃ¡c -->
  <div id="stat-spawned">ğŸ§Ÿ Tá»•ng sá»‘ zombie: 0</div>
  <div id="stat-alive">ğŸ§Ÿ Äang cÃ²n sá»‘ng: 0</div>
  <div id="stat-total">ğŸ§Ÿ ÄÃ£ tiÃªu diá»‡t: 0</div>
  <div id="stat-breakdown">
    <!-- sáº½ Ä‘Æ°á»£c cáº­p nháº­t báº±ng JS -->
  </div>
</div>
<!-- ğŸ“š Báº£ng Ká»¹ NÄƒng Active má»Ÿ báº±ng phÃ­m X -->
<div id="skillsOverlay" class="hidden">
<h3>ğŸ“š Ká»¹ nÄƒng Active</h3>
<div id="ui-mana" style="text-align: center; font-weight: 300; margin: 2px 0; position: relative; top: -2px;">ğŸ’  Mana: 0</div>
<div id="skills-list"></div>
</div>

<!-- ğŸ¯ Hiá»ƒn thá»‹ FPS realtime -->
<div id="fpsCounter" style="
  display: none;
  position: fixed;
  top: 0.2rem;
  left: 0.3rem;
  color: lime;
  background: rgba(0, 0, 0, 0);
  padding: 0.4rem 0.8rem;
  border-radius: 0.5rem;
  font-family: monospace;
  font-size: 0.9rem;
  z-index: 9999;
  pointer-events: none;
">
FPS: --
</div>
<!-- ğŸ“ Popup ká»¹ nÄƒng khi lÃªn cáº¥p -->
<div id="skillPopup">
  <h3>ğŸ“ Chá»n ká»¹ nÄƒng hoáº·c nÃ¢ng cáº¥p</h3>
  <div class="upgradeChoices" id="skillChoices"></div>
</div>
<div id="notificationContainer" aria-live="polite"></div>

<!-- Báº£ng menu gá»¡ lá»—i (Debug Menu) -->
<div id="debugMenu" class="infoOverlay hidden">
  <h3>ğŸ”§ Debug Menu </h3>
  <div class="debug-grid">
    
    <label for="debug-level">ğŸ§‘â€ğŸ¦° Level:</label>
    <div class="range-container">
      <input type="range" id="debug-level" min="1" max="100" step="1">
      <span class="range-value">1</span>
    </div>
    <label for="debug-hp">â¤ï¸ HP:</label>
    <div class="range-container">
      <input type="range" id="debug-hp" min="1" max="1000" step="1">
      <span class="range-value">10</span>
    </div>
    <label for="debug-mana">ğŸ’  Mana:</label>
    <div class="range-container">
      <input type="range" id="debug-mana" min="0" max="1000" step="1">
      <span class="range-value">10</span>
    </div>
    <label for="debug-energy">âš¡ Energy:</label>
    <div class="range-container">
      <input type="range" id="debug-energy" min="0" max="1000" step="1">
      <span class="range-value">10</span>
    </div>
    <label for="debug-coin">ğŸª™ Coin:</label>
    <div class="range-container">
      <input type="range" id="debug-coin" min="0" max="1000" step="1">
      <span class="range-value">10</span>
    </div>
    <label for="debug-moveSpeed">ğŸ‘Ÿ Tá»‘c Ä‘á»™ cháº¡y:</label>
    <div class="range-container">
      <input type="range" id="debug-moveSpeed" min="0.5" max="5" step="0.1">
      <span class="range-value">1.0</span>
    </div>
    <label for="debug-damage">ğŸ’¥ SÃ¡t thÆ°Æ¡ng:</label>
    <div class="range-container">
      <input type="range" id="debug-damage" min="1" max="100" step="0.5">
      <span class="range-value">1.0</span>
    </div>
    <label for="debug-fireRate">ğŸ”« HÆ°á»›ng báº¯n:</label>
    <div class="range-container">
      <input type="range" id="debug-fireRate" min="1" max="21" step="1">
      <span class="range-value">1</span>
    </div>
    <label for="debug-bulletSpeed">ğŸ’¨ Tá»‘c Ä‘á»™ Ä‘áº¡n:</label>
    <div class="range-container">
      <input type="range" id="debug-bulletSpeed" min="0.5" max="10" step="0.1">
      <span class="range-value">1.0</span>
    </div>
    <label for="debug-lineCount">ğŸ§¨ Sá»‘ lÆ°á»£ng Ä‘áº¡n:</label>
    <div class="range-container">
      <input type="range" id="debug-lineCount" min="1" max="10" step="1">
      <span class="range-value">1</span>
    </div>
    <h4 class="debug-subtitle" colspan="2">Tráº¡ng thÃ¡i Game</h4>

    <label for="debug-exp">Exp:</label>
    <input type="number" id="debug-exp" class="custom-input" min="0" max="999999">

    <label for="debug-wave">Wave:</label>
    <div class="range-container">
      <input type="range" id="debug-wave" min="1" max="100" step="1">
      <span class="range-value">1</span>
    </div>

    <label for="debug-dayTime">Giá» trong ngÃ y:</label>
    <div class="range-container">
      <input type="range" id="debug-dayTime" min="0" max="23.5" step="0.5">
      <span class="range-value">6.0</span>
    </div>

    <h4 class="debug-subtitle" colspan="2">Ká»¹ nÄƒng Active</h4>
    <div id="debug-active-skills-container" class="debug-skill-grid">
        
        <div class="debug-skill-wrapper">
            <h5>ğŸ›°ï¸ Vá»‡ tinh laze</h5>
            <div class="debug-skill-controls">
                <label for="debug-level-Vá»‡-tinh-laze">Level:</label>
                <div class="range-container"><input type="range" id="debug-level-Vá»‡-tinh-laze" min="1" max="2" step="1" value="1"><span class="range-value">1</span></div>
                <label for="debug-damage-Vá»‡-tinh-laze">SÃ¡t thÆ°Æ¡ng:</label>
                <div class="range-container"><input type="range" id="debug-damage-Vá»‡-tinh-laze" min="0" max="100" step="1" value="3"><span class="range-value">3</span></div>
            </div>
        </div>

        <div class="debug-skill-wrapper">
            <h5>ğŸš€ TÃªn lá»­a F18</h5>
            <div class="debug-skill-controls">
                <label for="debug-level-TÃªn-lá»­a-F18">Level:</label>
                <div class="range-container"><input type="range" id="debug-level-TÃªn-lá»­a-F18" min="1" max="5" step="1" value="1"><span class="range-value">1</span></div>
                <label for="debug-damage-TÃªn-lá»­a-F18">SÃ¡t thÆ°Æ¡ng:</label>
                <div class="range-container"><input type="range" id="debug-damage-TÃªn-lá»­a-F18" min="0" max="100" step="1" value="6"><span class="range-value">6</span></div>
            </div>
        </div>

        <div class="debug-skill-wrapper">
            <h5>ğŸ›¸ UFO táº¥n cÃ´ng</h5>
            <div class="debug-skill-controls">
                <label for="debug-level-UFO-táº¥n-cÃ´ng">Level:</label>
                <div class="range-container"><input type="range" id="debug-level-UFO-táº¥n-cÃ´ng" min="1" max="3" step="1" value="1"><span class="range-value">1</span></div>
                <label for="debug-damage-UFO-táº¥n-cÃ´ng">SÃ¡t thÆ°Æ¡ng:</label>
                <div class="range-container"><input type="range" id="debug-damage-UFO-táº¥n-cÃ´ng" min="0" max="100" step="1" value="5"><span class="range-value">5</span></div>
            </div>
        </div>
        
        <div class="debug-skill-wrapper">
            <h5>ğŸŒ©ï¸ BÃ£o sÃ©t</h5>
            <div class="debug-skill-controls">
                <label for="debug-level-BÃ£o-sÃ©t">Level:</label>
                <div class="range-container"><input type="range" id="debug-level-BÃ£o-sÃ©t" min="1" max="5" step="1" value="1"><span class="range-value">1</span></div>
                <label for="debug-damage-BÃ£o-sÃ©t">SÃ¡t thÆ°Æ¡ng:</label>
                <div class="range-container"><input type="range" id="debug-damage-BÃ£o-sÃ©t" min="0" max="100" step="1" value="8"><span class="range-value">8</span></div>
            </div>
        </div>
        
        <div class="debug-skill-wrapper">
            <h5>ğŸ’£ Bom B52</h5>
            <div class="debug-skill-controls">
                <label for="debug-damage-Bom-B52">SÃ¡t thÆ°Æ¡ng:</label>
                <div class="range-container"><input type="range" id="debug-damage-Bom-B52" min="0" max="100" step="1" value="10"><span class="range-value">10</span></div>
            </div>
        </div>

        <div class="debug-skill-wrapper">
            <h5>ğŸ­ áº¢o áº£nh phÃ¢n thÃ¢n</h5>
            <div class="debug-skill-controls">
                <label for="debug-damage-áº¢o-áº£nh-phÃ¢n-thÃ¢n">SÃ¡t thÆ°Æ¡ng:</label>
                <div class="range-container"><input type="range" id="debug-damage-áº¢o-áº£nh-phÃ¢n-thÃ¢n" min="0" max="100" step="1" value="5"><span class="range-value">5</span></div>
            </div>
        </div>

        <div class="debug-skill-wrapper">
            <h5>ğŸ•³ï¸ Há»‘ Ä‘en</h5>
            <div class="debug-skill-controls">
                <label for="debug-level-Há»‘-Ä‘en">Level:</label>
                <div class="range-container"><input type="range" id="debug-level-Há»‘-Ä‘en" min="1" max="2" step="1" value="1"><span class="range-value">1</span></div>
                <label for="debug-damage-Há»‘-Ä‘en">SÃ¡t thÆ°Æ¡ng:</label>
                <div class="range-container"><input type="range" id="debug-damage-Há»‘-Ä‘en" min="0" max="100" step="1" value="7"><span class="range-value">7</span></div>
            </div>
        </div>

        <div class="debug-skill-wrapper">
            <h5>â˜¢ï¸ Boom háº¡t nhÃ¢n</h5>
            <div class="debug-skill-controls">
                <label for="debug-damage-Boom-háº¡t-nhÃ¢n">SÃ¡t thÆ°Æ¡ng:</label>
                <div class="range-container"><input type="range" id="debug-damage-Boom-háº¡t-nhÃ¢n" min="0" max="200" step="5" value="100"><span class="range-value">100</span></div>
            </div>
        </div>
        
        <div class="debug-skill-wrapper">
            <h5>ğŸ©¸ Quáº£ cáº§u háº¥p huyáº¿t</h5>
            <div class="debug-skill-controls">
                <label for="debug-level-Quáº£-cáº§u-háº¥p-huyáº¿t">Level:</label>
                <div class="range-container"><input type="range" id="debug-level-Quáº£-cáº§u-háº¥p-huyáº¿t" min="1" max="2" step="1" value="1"><span class="range-value">1</span></div>
                <label for="debug-damage-Quáº£-cáº§u-háº¥p-huyáº¿t">SÃ¡t thÆ°Æ¡ng:</label>
                <div class="range-container"><input type="range" id="debug-damage-Quáº£-cáº§u-háº¥p-huyáº¿t" min="0" max="100" step="1" value="2"><span class="range-value">2</span></div>
            </div>
        </div>
        
        <div class="debug-skill-wrapper">
            <h5>ğŸŒ€ Cá»•ng KhÃ´ng Gian</h5>
            <div class="debug-skill-controls">
                <label for="debug-damage-Cá»•ng-KhÃ´ng-Gian">SÃ¡t thÆ°Æ¡ng:</label>
                <div class="range-container"><input type="range" id="debug-damage-Cá»•ng-KhÃ´ng-Gian" min="0" max="100" step="1" value="99"><span class="range-value">99</span></div>
            </div>
        </div>
    </div>

    <h4 class="debug-subtitle" colspan="2">NÃ¢ng cáº¥p Ká»¹ nÄƒng</h4>

    <label for="debug-bladeCount">ğŸ”ª Sá»‘ lÆ°á»£ng Ä‘ao:</label>
    <div class="range-container">
        <input type="range" id="debug-bladeCount" min="2" max="20" step="1">
        <span class="range-value">2</span>
    </div>
    <label for="debug-bladeDamage">ğŸ”ª SÃ¡t thÆ°Æ¡ng Ä‘ao:</label>
    <div class="range-container">
        <input type="range" id="debug-bladeDamage" min="1" max="50" step="0.5">
        <span class="range-value">1.0</span>
    </div>
    <label for="debug-swordLevel">âš”ï¸ Cáº¥p mÆ°a kiáº¿m:</label>
    <div class="range-container">
        <input type="range" id="debug-swordLevel" min="1" max="10" step="1">
        <span class="range-value">1</span>
    </div>
    <label for="debug-swordDamage">âš”ï¸ SÃ¡t thÆ°Æ¡ng kiáº¿m:</label>
    <div class="range-container">
        <input type="range" id="debug-swordDamage" min="1" max="50" step="0.5">
        <span class="range-value">1.0</span>
    </div>
    <label for="debug-fireCount">ğŸ”¥ Sá»‘ lÆ°á»£ng lá»­a:</label>
    <div class="range-container">
        <input type="range" id="debug-fireCount" min="2" max="10" step="1">
        <span class="range-value">2</span>
    </div>
    <label for="debug-fireDamage">ğŸ”¥ SÃ¡t thÆ°Æ¡ng lá»­a:</label>
    <div class="range-container">
        <input type="range" id="debug-fireDamage" min="1" max="50" step="0.5">
        <span class="range-value">1.0</span>
    </div>
    <label for="debug-iceCount">â„ï¸ Sá»‘ lÆ°á»£ng bÄƒng:</label>
    <div class="range-container">
        <input type="range" id="debug-iceCount" min="2" max="10" step="1">
        <span class="range-value">2</span>
    </div>
    <label for="debug-iceDamage">â„ï¸ SÃ¡t thÆ°Æ¡ng bÄƒng:</label>
    <div class="range-container">
        <input type="range" id="debug-iceDamage" min="1" max="50" step="0.5">
        <span class="range-value">1.0</span>
    </div>
    <label for="debug-thunderCount">ğŸ”µ Sá»‘ lÆ°á»£ng lÃ´i:</label>
    <div class="range-container">
        <input type="range" id="debug-thunderCount" min="2" max="6" step="1">
        <span class="range-value">2</span>
    </div>
    <label for="debug-thunderDamage">ğŸ”µ SÃ¡t thÆ°Æ¡ng lÃ´i:</label>
    <div class="range-container">
        <input type="range" id="debug-thunderDamage" min="1" max="50" step="0.5">
        <span class="range-value">1.0</span>
    </div>
<label for="debug-auraHealLevel">âœ¨ Cáº¥p há»“i mÃ¡u Aura:</label>
    <div class="range-container">
        <input type="range" id="debug-auraHealLevel" min="0" max="5" step="1">
        <span class="range-value">0</span>
    </div>

    <label for="debug-fairyCount">ğŸ¦‹ Sá»‘ lÆ°á»£ng Fairy:</label>
    <div class="range-container">
        <input type="range" id="debug-fairyCount" min="1" max="3" step="1">
        <span class="range-value">1</span>
    </div>

    <label for="debug-fairyHealLevel">ğŸ¦‹ Cáº¥p há»“i mÃ¡u Fairy:</label>
    <div class="range-container">
        <input type="range" id="debug-fairyHealLevel" min="0" max="10" step="1">
        <span class="range-value">0</span>
    </div>
    
    <label for="debug-fairyDamageLevel">ğŸ¦‹ Cáº¥p sÃ¡t thÆ°Æ¡ng Fairy:</label>
    <div class="range-container">
        <input type="range" id="debug-fairyDamageLevel" min="0" max="10" step="1">
        <span class="range-value">0</span>
    </div>

  </div>
  <div class="debug-buttons">
    <button id="applyDebugChanges">Ãp dá»¥ng</button>
    <button id="closeDebugMenu">ÄÃ³ng</button>
  </div>
</div>

<!--Menu game ESC-->
<div id="pauseMenu" class="infoOverlay hidden">
  <h2>CÃ i Ä‘áº·t</h2>
  
  <div class="settings-section">
    <h3>Ã‚m thanh</h3>
    <div class="debug-grid">
      <label for="volume-master">Ã‚m lÆ°á»£ng Tá»•ng:</label>
      <div class="range-container">
        <input type="range" id="volume-master" min="0" max="1" step="0.05" value="1">
        <span class="range-value">100%</span>
      </div>
      
      <label for="volume-music">Nháº¡c ná»n:</label>
      <div class="range-container">
        <input type="range" id="volume-music" min="0" max="1" step="0.05" value="0.5">
        <span class="range-value">50%</span>
      </div>

      <label for="volume-sfx">Hiá»‡u á»©ng (SFX):</label>
      <div class="range-container">
        <input type="range" id="volume-sfx" min="0" max="1" step="0.05" value="0.8">
        <span class="range-value">80%</span>
      </div>
    </div>
  </div>

  <div class="pause-menu-buttons">
    <button id="resumeBtn">Tiáº¿p tá»¥c</button>
    <button id="restartBtnPause">ChÆ¡i láº¡i</button>
    <button id="guideBtnPause">HÆ°á»›ng dáº«n</button>
    <button id="infoBtnPause">ThÃ´ng tin</button>
    <button id="exitBtn">Menu</button>
  </div>
</div>
<!-- â„¹ï¸ Overlay Shop -->
<div id="shopOverlay" class="infoOverlay hidden">
  <h2><i class="fas fa-store"></i> Cá»­a hÃ ng Zombie Survivor </h2>
  <div class="shop-balance">Xu: <span id="shopCoinBalance">0</span> ğŸª™</div>
  
  <div id="shopItemsContainer" class="shop-grid">
    </div>

  <div class="shop-buttons">
    <button id="closeShopBtn">ÄÃ³ng</button>
  </div>
</div>

<!-- ğŸµ Ã‚m thanh ná»n vÃ  hiá»‡u á»©ng Ã¢m thanh -->
<audio id="music-background" src="sounds/background-music.mp3"></audio>
<audio id="music-background-2" src="sounds/background-music-2.mp3"></audio>
<audio id="music-background-3" src="sounds/background-music-3.mp3"></audio>
<audio id="music-boss" src="sounds/boss-music.mp3" loop></audio>

<audio id="sfx-shoot" src="sounds/shoot.mp3"></audio>
<audio id="sfx-zombie-die" src="sounds/zombie-die.mp3"></audio>
<audio id="sfx-pickup" src="sounds/pickup.mp3"></audio>
<audio id="sfx-pickup-coin" src="sounds/pickup-coin.mp3"></audio>
<audio id="sfx-level-up" src="sounds/level-up.mp3"></audio>
<audio id="sfx-laser" src="sounds/laser.mp3"></audio>
<audio id="sfx-bigboss-laser" src="sounds/bigboss-laser.mp3" loop></audio>
<audio id="sfx-nuke-fall" src="sounds/nuke-fall.mp3"></audio>
<audio id="sfx-nuke-explode" src="sounds/nuke-explode.mp3"></audio>
<audio id="sfx-lazer-charging" src="sounds/lazer-charging.mp3" loop></audio>
<audio id="sfx-shield-block" src="sounds/shield-block.mp3"></audio>
<audio id="sfx-game-over" src="sounds/game-over.mp3"></audio>
<audio id="sfx-player-hurt" src="sounds/player-hurt.mp3"></audio>
<audio id="sfx-player-explode" src="sounds/player-explode.mp3"></audio>
<audio id="sfx-powerup" src="sounds/powerup.mp3"></audio>
<audio id="sfx-game-start" src="sounds/game-start.mp3"></audio>
<audio id="sfx-ui-click" src="sounds/ui-click.mp3"></audio>
<audio id="sfx-lucky-loop" src="sounds/lucky-active-loop.mp3" loop></audio>
<audio id="sfx-power-loop" src="sounds/power-active-loop.mp3" loop></audio>
<audio id="sfx-upgrade-select" src="sounds/upgrade-select.mp3"></audio>
<audio id="sfx-wave-up" src="sounds/wave-up.mp3"></audio>
<audio id="sfx-nuke-time" src="sounds/nuke-time.mp3"></audio>
<audio id="sfx-crazy-loop" src="sounds/crazy-active-loop.mp3" loop></audio>
<audio id="sfx-exp-loop" src="sounds/exp-active-loop.mp3" loop></audio>
<audio id="sfx-supply-drop-item" src="sounds/supply-drop-item.mp3"></audio>

</body>
</html>
