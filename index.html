<!--ğŸ® Zombie Survivor  âœ¨ Version: 1.1  ğŸ–‹ï¸ TÃ¡c giáº£: Dang -->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Zombie Survivor - Dang</title>
<style>
  :root {
  /* ğŸ¨ MÃ u sáº¯c chÃ­nh */
  --color-bg-dark: #111;
  --color-primary: #00ffff;
  --color-accent: gold;
  --color-danger: #ff4c4c;
  --color-text: #e0f7fa;
  --color-hover-bg: #22404c;
  --color-hover-border: #3d6c78;
  --color-title: #aefeff;
  --glow-title: 0 0 6px #7f7fff, 0 0 12px #4d4dfb;
 
  /* ğŸŒˆ MÃ u sáº¯c giao diá»‡n */
  --menu-width: 24rem;
  --menu-min-height: 20rem;
  --menu-radius: 1rem;
  --menu-padding: 2rem 1.5rem;

  /* ğŸ”˜ MÃ u button riÃªng */
  --btn-bg: #1a2b33;
  --btn-border: #294e5a;

  /* ğŸ”¤ KÃ­ch thÆ°á»›c font chá»¯ */
  --font-xs: 0.75rem;
  --font-sm: 0.9rem;
  --font-md: 1rem;
  --font-lg: 1.25rem;
  --font-xl: 1.5rem;
  --font-xxl: 2.5rem;

  /* ğŸ“ KÃ­ch thÆ°á»›c padding/margin chuáº©n */
  --space-xs: 0.4rem;
  --space-sm: 0.6rem;
  --space-md: 1rem;
  --space-lg: 1.5rem;
  --space-xl: 2rem;

  /* ğŸŒŸ Äá»™ sÃ¡ng bÃ³ng / hiá»‡u á»©ng */
  --glow-primary: 0 0 8px var(--color-primary);
  --glow-accent: 0 0 8px var(--color-accent);
}

  body { margin: 0; background: #111; overflow: hidden; font-family: sans-serif; }
  canvas { display: block; margin: auto; transition: background 1s ease; }
/* ğŸ¯ Giao diá»‡n chÃ­nh */
#ui {
  position: absolute;
  top: 0vh; /* cÃ¡ch top theo chiá»u cao mÃ n hÃ¬nh */
  left: 50%;
  transform: translateX(-50%);
  display: flex;
  gap: 0.5rem; /* khoáº£ng cÃ¡ch giá»¯a cÃ¡c nÃºt */
  padding: 0.7rem 1.5rem; 
  background: rgb(0, 0, 0); /* ná»n trong suá»‘t */
  border-radius: 0rem;
  width: 90%; /* tá»· lá»‡ theo chiá»u ngang */
  max-width: 57rem; /* giá»›i háº¡n tá»‘i Ä‘a */
  justify-content: center;
  z-index: 1000;
  flex-wrap: wrap;
}

/* ğŸ”˜ NÃºt trong UI (nhá» gá»n hÆ¡n nÃºt máº·c Ä‘á»‹nh) */
#ui button {
  padding: 0.6rem 0.6rem;
  font-size: 0.75rem;
  min-width: 4.5rem;
  margin-bottom: 0.6rem;
  margin-top: 0.6rem;
}

/* ğŸ”˜ NÃºt máº·c Ä‘á»‹nh cho toÃ n giao diá»‡n */
button {
  font-family: 'Segoe UI', sans-serif;
  padding: 0.65rem 1.25rem;
  font-size: 1rem;
  cursor: pointer;
  min-width: 5rem;
  text-align: center;
  background-color: #1a2b33;
  border: 0.125rem solid #294e5a;
  border-radius: 0.5rem;
  color: #e0f7fa;
  transition: all 0.2s ease;
  box-shadow: 0 0.125rem 0.3rem rgba(0, 0, 0, 0.2);
}

/* ğŸ” Hiá»‡u á»©ng hover cho nÃºt */
button:hover {
  background-color: #22404c;
  border-color: #3d6c78;
  color: #ffffff;
  transform: translateY(-0.06rem);
}

/* ğŸ–± Hiá»‡u á»©ng khi click giá»¯ */
button:active {
  transform: scale(0.97);
  box-shadow: 0 0.06rem 0.2rem rgba(0, 0, 0, 0.3);
}

/* âœ³ï¸ NÃºt Ä‘ang active (Ä‘Æ°á»£c chá»n) */
button.active {
  border-color: #00ffff;
  box-shadow: 0 0 0.625rem #00ffffaa;
}

/* Tráº¡ng thÃ¡i active dÃ¹ng cho nhiá»u thÃ nh pháº§n */
.active {
  outline: 0.125rem solid gold;
  border-radius: 0.5rem;
}

/* ğŸ“Š VÃ¹ng hiá»ƒn thá»‹ Ä‘iá»ƒm sá»‘ hoáº·c thÃ´ng tin */
#score {
  display: flex;
  flex-direction: column;
  justify-content: center;
  align-items: center;
  min-width: 7.5rem;
  text-align: center;
  color: white;
  font-size: 1rem;
  padding: 0.3rem 0.6rem;
}

/* ğŸ”„ NÃºt restart Ä‘áº·c biá»‡t */
#restartBtn {
  padding: 0.75rem 1.75rem;
  font-weight: bold;
  background-color: #1c2e36;
  border: 0.125rem solid #3a6b75;
  border-radius: 0.5rem;
  font-size: 1rem;
  color: #aefeff;
  cursor: pointer;
  transition: 0.25s ease;
}

/* ğŸ–± Hover cho restart */
#restartBtn:hover {
  background-color: #28515f;
  color: white;
  transform: translateY(-0.06rem);
}

/* â³ Hiá»ƒn thá»‹ Ä‘á»“ng há»“ Ä‘áº¿m wave */
#waveTimerDisplay {
  position: fixed;
  top: 12vh;
  left: 46%;
  transform: translateX(-50%);
  font-size: 1.2rem;
  color: gold;
  z-index: 10;
  text-shadow: 0 0 8px gold;
  font-weight: bold;
  font-family: 'Courier New', monospace;
  letter-spacing: 0.1rem;
  pointer-events: none;
}

/* ğŸŒŠ Popup khi báº¯t Ä‘áº§u Wave */
#wavePopup {
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  font-size: 2.5rem;
  font-weight: bold;
  color: #fff3b0;
  text-shadow:
    0 0 6px #ffd54f,
    0 0 12px #ffb300;
  background: none;
  border: none;
  pointer-events: none;
  z-index: 1000;
  transition: opacity 0.5s ease;
  opacity: 0;
}

/* âœ¨ Animation xuáº¥t hiá»‡n má»m mÆ°á»£t */
@keyframes waveFade {
  0% {
    opacity: 0;
    transform: translate(-50%, -50%) scale(0.7);
  }
  50% {
    opacity: 1;
    transform: translate(-50%, -50%) scale(1.05);
  }
  100% {
    opacity: 1;
    transform: translate(-50%, -50%) scale(1);
  }
}

/* ğŸ“‹ Menu báº¯t Ä‘áº§u game */
#startMenu {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 1rem;
  width: 90%;
  position: fixed;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  color: white;
  border-radius: var(--menu-radius);
  padding: var(--menu-padding);
  max-width: var(--menu-width);
  min-height: var(--menu-min-height);
  text-align: center;
  background: linear-gradient(to bottom, #0e1a26, #0a121a);
  backdrop-filter: blur(6px);
  border: 1px solid #446688;
  box-shadow:
    0 0 8px rgba(102, 170, 255, 0.1),
    inset 0 0 6px rgba(102, 170, 255, 0.05);
  z-index: 9999;
}
#startMenu:hover {
  box-shadow:
    0 0 12px rgb(0, 153, 255),
    inset 0 0 8px rgba(0, 187, 255, 0.393);
}
#startMenu .btn-group {
  display: flex;
  flex-wrap: wrap;
  justify-content: center;
  gap: 1rem;
}
#startMenu button {
  min-width: 10rem;
}

/* ğŸŒŸ Popup khi lÃªn cáº¥p */
#levelUpPopup {
  position: fixed;
  top: 20%;
  left: 50%;
  transform: translate(-50%, -50%);
  font-size: 2.5rem;
  color: gold;
  font-weight: bold;
  text-shadow: 0 0 15px #ffff00;
  display: none;
  z-index: 2000;
}

/* ğŸ’€ Panel Game Over hiá»ƒn thá»‹ khi thua */
.gameOverPanel {
  position: fixed;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  color: white;
  display: none;
  flex-direction: column;
  align-items: center;
  backdrop-filter: blur(6px);
  z-index: 2000;
  padding: 2rem 1rem;
  border: 2px solid #ff5722;
  background: linear-gradient(145deg, #1a0f0f, #300d0d);
  box-shadow: 0 0 1rem #ff572288;
  border-radius: 1rem;
  text-align: center;
}

/* ğŸ¯ TiÃªu Ä‘á» Game Over */
.gameOverTitle {
  color: #ff5722;
  font-size: 2.5rem;
  text-shadow: 0 0 4px #ffff00, 0 0 4px #ffff00;
  margin-bottom: 1rem;
}

/* ğŸ” NÃºt ChÆ¡i láº¡i trong Game Over Panel */
.restartButton {
  margin-top: 1rem;
  padding: 0.75rem 2rem;
  font-size: 1.2rem;
  font-weight: 300;
  background-color: #330000;
  color: #fff5cc;
  border: 2px solid #ff9800;
  border-radius: 0.75rem;
  cursor: pointer;
  box-shadow: 0 0 0.5rem #ff5722aa;
  transition: all 0.25s ease;
  text-shadow: 0 0 3px #ffaa00;
}

.restartButton:hover {
  background-color: #551100;
  color: #ffffff;
  transform: scale(1.05);
  box-shadow: 0 0 1rem #ff5722cc;
}

/* ğŸ•¹ï¸ TiÃªu Ä‘á» game á»Ÿ menu báº¯t Ä‘áº§u */
.gameTitle {
  font-size: 2.5rem;
  font-weight: 900;
  color: var(--color-title);
  text-shadow: var(--glow-title);
  margin-bottom: 1.5rem;
  font-family: 'Segoe UI', sans-serif;
}

/* âš ï¸ Popup cáº£nh bÃ¡o (dÃ¹ng cho showWarning) */
.warningPopup{
  position:fixed;
  top:20%;                /* â‘  Ä‘áº·t tÃ¢m dá»c  */
  left:50%;               /* â‘¡ Ä‘áº·t tÃ¢m ngang */
  transform:translate(-50%,-50%); /* â‘¢ kÃ©o ngÆ°á»£c láº¡i 50 % kÃ­ch thÆ°á»›c chÃ­nh nÃ³ */
  background:rgba(0,32,64,.9);
  color:var(--color-text);
  padding:var(--space-sm) var(--space-lg);
  border-radius:.75rem;
  font:var(--font-md) 'Segoe UI',sans-serif;
  font-weight:500;
  z-index:9999;
  box-shadow:0 0 10px #00bcd4aa;
  pointer-events:none;
  animation:popupFade 1.5s ease-out forwards;
  max-width:70vw;         /* náº¿u text quÃ¡ dÃ i sáº½ tá»± xuá»‘ng hÃ ng */
  text-align:center;
}

/*  VÃ¬ transform nay Ä‘Ã£ chá»©a translate(-50%,-50%),
    animation chá»‰ láº¯c trá»¥c Y thÃªm má»™t chÃºt  */
@keyframes popupFade{
  0%   {opacity:0; transform:translate(-50%,-30%);}
  10%  {opacity:1; transform:translate(-50%,-50%);}
  90%  {opacity:1; transform:translate(-50%,-50%);}
  100% {opacity:0; transform:translate(-50%,-70%);}
}
#notificationContainer{
  position: fixed;
  top: 20%;
  left: 50%;
  transform: translate(-50%, -50%);   /* cÄƒn Ä‘Ãºng tÃ¢m nhÆ° popup cÅ© */
  display: flex;
  flex-direction: column;             /* xáº¿p dá»c */
  align-items: center;                /* má»—i popup váº«n giá»¯a ngang */
  gap: .5rem;                         /* khoáº£ng cÃ¡ch giá»¯a cÃ¡c popup */
  pointer-events: none;
  z-index: 10000;
}

/* âœ¨ Popup bÃªn trong khay â€“ bá» fixed & translate cÅ© */
#notificationContainer .warningPopup{
  position: relative;                 /* relative â†’ theo khay */
  left: auto; top: 0;
  transform: none;                    /* khay Ä‘Ã£ lo cÄƒn giá»¯a */
  animation: popupFadeStack 1.5s ease-out forwards;
}

/* Hiá»‡u á»©ng gáº§n giá»‘ng cÅ© nhÆ°ng khÃ´ng chá»©a -50% ná»¯a */
@keyframes popupFadeStack{
  0%   {opacity:0;   transform: translateY(20px);}
  10%  {opacity:1;   transform: translateY(0);}
  90%  {opacity:1;}
  100% {opacity:0;   transform: translateY(-20px);}
}

/* ğŸŒŸ Giao diá»‡n popup nÃ¢ng cáº¥p */
#upgradePopup {
  display: none;
  position: fixed;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  background: rgba(0, 0, 0, 0.85);
  border: 2px solid gold;
  padding: 2rem;
  border-radius: 1rem;
  z-index: 9999;
  max-width: 42rem;
  width: 90%;
  text-align: center;
  box-shadow: 0 0 15px gold;
}

.upgradeTitle {
  color: gold;
  font-size: 1.8rem;
  font-weight: bold;
  margin-bottom: 1.5rem;
  text-shadow: 0 0 6px gold;
  margin-top: 1rem;
}

.upgradeChoices {
  display: flex;
  justify-content: space-evenly;
  gap: 1rem;
  flex-wrap: wrap;
}

.upgradeChoices button {
  padding: 0.8rem 1.2rem;
  border: 2px solid #ccc;
  border-radius: 0.6rem;
  background: #111;
  color: white;
  font-size: 1rem;
  font-weight: bold;
  min-width: 8rem;
  cursor: pointer;
  transition: 0.2s ease;
}

.upgradeChoices button:hover {
  background: #22404c;
  border-color: gold;
  color: #fff;
  box-shadow: 0 0 10px gold;
}

/* ğŸ“Š Overlay thá»‘ng kÃª */
#statsOverlay {
  position: fixed;
  top: 0.2rem;
  right: 0.5rem;
  background: rgba(0, 0, 0, 0.7);
  border: 2px solid #00ffff;
  border-radius: 1rem;
  padding: 1rem;
  color: #e0f7fa;
  font-size: 0.95rem;
  line-height: 1.5;
  z-index: 9999;
  width: 15rem;
  font-family: 'Segoe UI', sans-serif;
}

#statsOverlay h3 {
  font-size: 1rem;
  margin-top: 0;
  margin-bottom: 0.5rem;
  color: gold;
  text-align: center;
}

#statsOverlay.hidden {
  display: none;
}
/* ğŸ“š Giao diá»‡n báº£ng ká»¹ nÄƒng active */
#skillsOverlay {
  position: fixed;
  top: 0.2rem;
  left: 0.5rem;
  background: rgba(0, 0, 0, 0.7);
  border: 2px solid #00ffff;
  border-radius: 1rem;
  padding: 1rem;
  color: #e0f7fa;
  font-size: 0.95rem;
  line-height: 1.5;
  z-index: 9999;
  width: 15rem;
  font-family: 'Segoe UI', sans-serif;
}

#skillsOverlay h3 {
  font-size: 1rem;
  margin-top: 0;
  margin-bottom: 0.5rem;
  color: gold;
  text-align: center;
}

#skillsOverlay.hidden {
  display: none;
}

.skill-item {
  margin-bottom: 0.5rem;
  padding: 0.4rem;
  background: rgba(255, 255, 255, 0.1);
  border-radius: 0.5rem;
  cursor: pointer;
  transition: background 0.3s;
}

.skill-item:hover {
  background: rgba(0, 255, 255, 0.3);
}

.skill-icon {
  font-size: 1.2rem;
  margin-right: 0.5rem;
}
#skillPopup {
  display: none;
  position: fixed;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  background: rgba(0, 32, 64, 0.9);
  border: 2px solid #00ffff;
  padding: 2rem;
  border-radius: 1rem;
  z-index: 9999;
  max-width: 42rem;
  width: 90%;
  text-align: center;
  box-shadow: 0 0 15px #00ffffaa;
}

#skillPopup h3 {
  color: #00ffff;
  font-size: 1.6rem;
  font-weight: bold;
  margin-bottom: 1.2rem;
  text-shadow: 0 0 6px #00ffff;
}

#skillPopup .upgradeChoices {
  display: flex;
  justify-content: space-evenly;
  gap: 1rem;
  flex-wrap: wrap;
}

#skillPopup .upgradeChoices button {
  padding: 0.8rem 1rem;
  border: 2px solid #0d1aa0; /* mÃ u ká»¹ nÄƒng active */
  border-radius: 0.6rem;
  background: #001f2f;
  color: white;
  font-size: 1rem;
  font-weight: bold;
  min-width: 9rem;
  cursor: pointer;
  transition: 0.2s ease;
}
#skillPopup .upgradeChoices button:hover {
  background: #003344;
  border-color: cyan;
  box-shadow: 0 0 10px cyan;
}

.skill-item.active {
  border: 2px solid #00ffff;
  background: rgba(0, 255, 255, 0.2);
  box-shadow: 0 0 8px cyan;
  pointer-events: none; /* khÃ´ng cho click vÃ o ká»¹ nÄƒng Ä‘Ã£ chá»n */
}
.infoOverlay {
  position: fixed;
  top: 50%; left: 50%;
  transform: translate(-50%, -50%);
  background: rgba(10, 25, 40, 0.95); /* xanh Ä‘en dá»‹u */
  border: 2px solid #446688;
  border-radius: var(--menu-radius);
  max-width: 24rem;
  min-height: 22rem;
  width: 90%;
  padding: var(--menu-padding);
  box-shadow: 0 0 10px rgba(50, 100, 150, 0.3);
  color: #eef;
  z-index: 9999;
  font-family: 'Segoe UI', sans-serif;
  font-size: 0.95rem;
  line-height: 1.6; /* khoáº£ng cÃ¡ch dÃ²ng */
  text-align: center;
}
.spacer {
  height: 2rem;  /* hoáº·c 4rem tÃ¹y Ä‘á»™ cao báº¡n muá»‘n */
}
/* ğŸ”§ Spacer cÃ¢n báº±ng layout trong overlay hÆ°á»›ng dáº«n */
.spacerguide {
  height: 2rem; /* khoáº£ng cÃ¡ch giá»¯a cÃ¡c má»¥c */
}

.infoOverlay button {
  min-width: 10rem;
}
.custom-input {
  font-family: 'Segoe UI', sans-serif;
  padding: 0.65rem 1.25rem;
  font-size: 0.9rem;
  min-width: 6.5rem;
  width: 100%;
  max-width: 7.2rem;
  text-align: center;
  background-color: #1a2b33;
  border: 0.125rem solid #294e5a;
  border-radius: 0.5rem;
  color: #e0f7fa;
  transition: all 0.2s ease;
  box-shadow: 0 0.125rem 0.3rem rgba(0, 0, 0, 0.2);
}

.custom-input:focus {
  outline: none;
  background-color: #22404c;
  border-color: #3d6c78;
  color: #ffffff;
  box-shadow: 0 0 0.625rem #00ffffaa;
}
#waveNumberDisplay {
  position: fixed;
  top: 12vh; /* giá»‘ng waveTimerDisplay */
  left: 52.5%; /* lá»‡ch pháº£i so vá»›i thá»i gian á»Ÿ 50% */
  transform: translateX(-50%);
  font-size: 1.1rem;
  color: #aefeff;
  font-weight: bold;
  text-shadow: 0 0 6px #00ffff;
  z-index: 10;
  pointer-events: none;
}
#miniMap {
  position: fixed;
  top: 4.8rem;
  right: 18.2rem;
  width: 150px;
  height: 150px;
  border: 2px solid #00ffff;
  border-radius: 0.5rem;
  background: rgba(0, 0, 0, 0.4);
  z-index: 9999;
  display: none; /* áº©n mini map ban Ä‘áº§u */
}
/* Tooltip cho item trong báº£ng ká»¹ nÄƒng (phÃ­m X) */
.skill-item[data-tooltip] {
  position: relative;
}
.skill-item[data-tooltip]::after {
  content: attr(data-tooltip);
  position: absolute;
  left: 102%;               /* hiá»‡n bÃªn pháº£i báº£ng */
  top: -2rem;
  transform: translateY(var(--tip-shift,0)); /* Dá»ŠCH theo biáº¿n */
  margin-left: .6rem;
  min-width: 18rem;
  white-space: pre-line;    /* xuá»‘ng dÃ²ng theo \n */
  padding: .55rem .7rem;
  font-size: .8rem;
  background: rgba(0,0,0,.85);
  color: #e0f7fa;
  border: 1px solid #00ffff;
  border-radius: .5rem;
  pointer-events: none;
  opacity: 0;
  transition: opacity .25s;
  z-index: 10000;
}
.skill-item:hover::after { opacity: 1; }
#bigBossRespawnDisplay {
    position: fixed;
    top: 12vh;
    left: 24vw;
    background: rgba(0, 0, 0, 0.6);
    border: 2px solid violet;
    border-radius: 0.5rem;
    padding: 0.4rem 0.8rem;
    color: violet;
    font-family: 'Courier New', monospace;
    font-size: 0.8rem;
    text-align: center;
    min-width: 6rem;
    z-index: 10;
    text-shadow: 0 0 5px violet;
}
#ui button[data-tooltip] {
  position: relative;
}

#ui button[data-tooltip]::after {
  content: attr(data-tooltip);
  position: absolute;
  left: 112%;
  top: 4rem;
  transform: translateX(-38%);
  margin-left: .6rem;
  min-width: 18rem;
  white-space: pre-line;
  padding: .55rem .7rem;
  font-size: .8rem;
  background: rgba(0, 0, 0, 0.85);
  color: #e0f7fa;
  border: 1px solid #00ffff;
  border-radius: .5rem;
  pointer-events: none;
  opacity: 0;
  transition: opacity .25s;
  text-align: left; /* ğŸ‘ˆ ÄÃ¢y lÃ  thá»© báº¡n Ä‘ang thiáº¿u */
  z-index: 10000;
}

#ui button:hover::after {
  opacity: 1;
}

/* káº¿t thÃºc style */
</style>
</head>
<body>
<div id="ui">
  <button id="autoBtn" data-tooltip="âš™ï¸ Auto:
- Tá»± Ä‘á»™ng táº¥n cÃ´ng zombie gáº§n nháº¥t
- TiÃªu hao: 0 âš¡">âš™ï¸ Auto</button>

  <button id="bladeBtn" data-tooltip="ğŸ”ª Ká»¹ nÄƒng Äao:
- Táº¡o 2 thanh Ä‘ao xoay quanh
- Tá»‘i Ä‘a táº¡o Ä‘Æ°á»£c 20 Ä‘ao
- Bay vÃ o zombie gáº§n nháº¥t
- YÃªu cáº§u level 1
- SÃ¡t thÆ°Æ¡ng: 1
- Hiá»‡u lá»±c: 30s â±
- TiÃªu hao: 3 âš¡">ğŸ”ª Äao</button>

  <button id="swordBtn" data-tooltip="âš”ï¸ Ká»¹ nÄƒng Kiáº¿m:
- Táº¡o mÆ°a kiáº¿m rÆ¡i tá»«ng Ä‘á»£t
- Sá»‘ lÆ°á»£ng kiáº¿m tÄƒng theo level
- Bay vÃ o zombie gáº§n nháº¥t
- YÃªu cáº§u level 2
- SÃ¡t thÆ°Æ¡ng: 1
- Hiá»‡u lá»±c: 30s â±
- TiÃªu hao: 6 âš¡">âš”ï¸ Kiáº¿m</button>

  <button id="fireBtn" data-tooltip="ğŸ”¥ Ká»¹ nÄƒng Lá»­a:
- Táº¡o 2 quáº£ cáº§u lá»­a quay quanh
- Táº¡o Ä‘Æ°á»£c tá»‘i Ä‘a 10 quáº£ cáº§u lá»­a
- TiÃªu diá»‡t zombie cháº¡m vÃ o
- YÃªu cáº§u level 3
- SÃ¡t thÆ°Æ¡ng: 1
- Hiá»‡u lá»±c: 45s â±
- TiÃªu hao: 8 âš¡">ğŸ”¥ Lá»­a</button>

  <button id="iceBtn" data-tooltip="â„ï¸ Ká»¹ nÄƒng BÄƒng (má»Ÿ khÃ³a Lv10):
- Táº¡o 2 quáº£ cáº§u bÄƒng lá»›n xoay quanh
- Táº¡o Ä‘Æ°á»£c tá»‘i Ä‘a 10 quáº£ cáº§u bÄƒng
- GÃ¢y sÃ¡t thÆ°Æ¡ng diá»‡n rá»™ng
- YÃªu cáº§u level 3
- SÃ¡t thÆ°Æ¡ng: 1
- Hiá»‡u lá»±c: 60s â±
- TiÃªu hao: 12 âš¡">â„ï¸ BÄƒng</button>

  <button id="thunderBtn" data-tooltip="ğŸ§ª Ká»¹ nÄƒng thunder (test):
- Táº¡o 2 quáº£ cáº§u lÃ´i xoay quanh
- Táº¡o Ä‘Æ°á»£c tá»‘i Ä‘a 6 quáº£ cáº§u
- GÃ¢y sÃ¡t thÆ°Æ¡ng diá»‡n rá»™ng
- YÃªu cáº§u level 5
- SÃ¡t thÆ°Æ¡ng: 1
- Hiá»‡u lá»±c: 60s â±
- TiÃªu hao: 18 âš¡">ğŸ§ª LÃ´i</button>

  <button id="thunderBtn" data-tooltip="ğŸ§ª Ká»¹ nÄƒng thunder (test):
- Táº¡o 2 quáº£ cáº§u lÃ´i xoay quanh
- Táº¡o Ä‘Æ°á»£c tá»‘i Ä‘a 6 quáº£ cáº§u
- GÃ¢y sÃ¡t thÆ°Æ¡ng diá»‡n rá»™ng
- YÃªu cáº§u level 5
- SÃ¡t thÆ°Æ¡ng: 1
- Hiá»‡u lá»±c: 60s â±
- TiÃªu hao: 18 âš¡">ğŸ§ª test1</button>

  <button id="thunderBtn" data-tooltip="ğŸ§ª Ká»¹ nÄƒng thunder (test):
- Táº¡o 2 quáº£ cáº§u lÃ´i xoay quanh
- Táº¡o Ä‘Æ°á»£c tá»‘i Ä‘a 6 quáº£ cáº§u
- GÃ¢y sÃ¡t thÆ°Æ¡ng diá»‡n rá»™ng
- YÃªu cáº§u level 5
- SÃ¡t thÆ°Æ¡ng: 1
- Hiá»‡u lá»±c: 60s â±
- TiÃªu hao: 18 âš¡">ğŸ§ª test2</button>

  <button id="PetBtn" data-tooltip="ğŸ° Ká»¹ nÄƒng Pet:
- Ká»¹ nÄƒng thá»­ nghiá»‡m
- (ChÆ°a hoáº¡t Ä‘á»™ng)
- TiÃªu hao: 5 âš¡
- Hiá»‡u lá»±c: 20s â±
- Há»— trá»£: nháº·t váº­t pháº©m">ğŸ° Pet</button>

  <div id="score">
    <div id="score-top">Kill: 0 | â¤ï¸: 10</div>
    <div id="score-bottom">Level: 1 | âš¡: 0</div>
  </div>
</div>
<canvas id="game" width="960" height="720"></canvas>

<!-- ğŸ“‹ Menu báº¯t Ä‘áº§u game -->
<div id="startMenu">
  <h2 class="gameTitle">Zombie Survivor</h2>
<input type="text" id="playerNameInput" placeholder="Nháº­p tÃªn cá»§a báº¡n" class="custom-input" />
  <button onclick="startGame()">ğŸ® Báº¯t Ä‘áº§u</button>
  <button onclick="showGuide()">ğŸ“˜ HÆ°á»›ng dáº«n</button>
  <button onclick="showInfo()">â„¹ï¸ ThÃ´ng tin</button>
</div>
<div id="guideOverlay" class="infoOverlay" style="display: none;">
<h3 style="margin-top: 0; color: #66aaff;">ğŸ“˜ HÆ°á»›ng dáº«n chÆ¡i</h3>
  <ul style="text-align: left;">
    <li>TiÃªu diá»‡t zombie Ä‘á»ƒ lÃªn cáº¥p</li>
    <li>Má»—i wave chá»n 1 nÃ¢ng cáº¥p ká»¹ nÄƒng</li>
    <li>Má»—i level chá»n ká»¹ nÄƒng chá»§ Ä‘á»™ng</li>
    <li>Ká»¹ nÄƒng dÃ¹ng nÄƒng lÆ°á»£ng hoáº·c mana</li>
    <li>Mana rÆ¡i tá»« boss Ä‘á»ƒ dÃ¹ng ká»¹ nÄƒng Ä‘áº·c biá»‡t</li>
    <li>Báº¥m X: má»Ÿ danh sÃ¡ch ká»¹ nÄƒng</li>
    <li>Báº¥m Z: má»Ÿ báº£ng thá»‘ng kÃª</li>
    <li>Báº¥m M: má»Ÿ báº£ng báº£n Ä‘á»“</li>
    <li>Váº­t pháº©m má»›i: Energy, Mana, HP, Box</li>
  </ul>
  <div class="spacerguide"></div> <!-- ğŸ‘ˆ dÃ²ng Ä‘á»‡m -->
  <button onclick="hideGuide()">ÄÃ³ng</button>
</div>
<div id="infoOverlay" class="infoOverlay" style="display: none;">
  <h3 style="margin-top: 0; color: #66aaff;">â„¹ï¸ ThÃ´ng tin</h3>
  <div class="infoContent">
    <p>PhiÃªn báº£n: 1.2<br>
       TÃ¡c giáº£: Dang<br>
       Cáº­p nháº­t: 2025-07-18</p>
    <p style="margin: 0; text-align: left;"><strong style="color: #00cc66;">ğŸ†• New</strong></p>
    <!-- Pháº§n cÃ³ thá»ƒ cuá»™n vÃ  canh trÃ¡i -->
    <div style="max-height: 128px;overflow-y: auto;scrollbar-width: none;
    -ms-overflow-style: none;text-align: left;">
      <ul style="padding-left: 20px;margin-top: 2px;list-style-type: disc;">
        <li>ThÃªm minimap</li>
        <li>TÄƒng giá»›i háº¡n báº£n Ä‘á»“</li>
        <li>TÄƒng giá»›i háº¡n sá»‘ lÆ°á»£ng Zombie</li>
        <li>ThÃªm Boss to hÆ¡n</li>
        <li>Cáº£i tiáº¿n má»™t sá»‘ ká»¹ nÄƒng</li>
        <li>ThÃªm há»‡ thá»‘ng ngÃ y Ä‘Ãªm</li>
        <!-- CÃ¡c má»¥c má»›i cÃ³ thá»ƒ thÃªm á»Ÿ Ä‘Ã¢y -->
      </ul>
    </div>
    <!-- áº¨n scrollbar trÃªn Chrome/Safari -->
    <style>
      .infoContent div::-webkit-scrollbar {
        display: none;
      }
    </style>
  </div>
  <div class="spacer"></div>
  <button onclick="hideInfo()">ÄÃ³ng</button>
</div>

<!-- ğŸ’€ Game Over Panel -->
<div id="gameOverPanel" class="gameOverPanel" style="display: none;">
  <h2 class="gameOverTitle">Game Over</h2>
  <button onclick="location.reload()" class="restartButton">ChÆ¡i láº¡i</button>
</div>

<!-- ğŸŒŠ Popup khi báº¯t Ä‘áº§u má»—i Wave -->
<div id="wavePopup">Wave 1</div>

<!-- â³ Äá»“ng há»“ Ä‘áº¿m thá»i gian wave -->
<div id="bigBossRespawnDisplay">BigBoss: --</div>
<div id="waveTimerDisplay">01:30:00</div>
<div id="waveNumberDisplay">Wave: 1</div>
<!-- Mini map -->
<canvas id="miniMap" width="150" height="150"></canvas>
<script>
// ğŸ§± 1. Biáº¿n toÃ n cá»¥c â€“ Cáº¥u hÃ¬nh & Khá»Ÿi táº¡o
let camera = { x: 0, y: 0 }; // ğŸ“· Vá»‹ trÃ­ camera
let backgroundStars = [];
let backgroundBirds = [];
let backgroundTrees = [];
let backgroundClouds = [];
let backgroundPlanes = [];
let backgroundMushrooms = [];
let backgroundRocks = [];
let backgroundBalloons = [];
let backgroundSeeds = [];
let dayTime = 0;
let dayDirection = 1; // giá»¯ láº¡i cá» nÃ y nhÆ° cÅ©
const dayDuration = 600; // 1 vÃ²ng ngÃ y Ä‘Ãªm = 96 giÃ¢y thá»±c táº¿
let lastUpdateTime = Date.now();
let prevIsNight = isNight();
let backgroundBigStars = [];
let globalDeltaTime = 0;

let lastBigBossTimerUpdate = performance.now();
let bigBossRespawnTimer = 0;
const bigBossRespawnInterval = 3; // giÃ¢y

// ğŸ”« Cáº¥u hÃ¬nh báº¯n
let shootCooldown = 1000;        // â± Delay giá»¯a má»—i Ä‘á»£t báº¯n
let lastShootBatchTime = 0;      // â± Má»‘c thá»i gian Ä‘á»£t báº¯n
let currentBurstShots = 0;       // ğŸ’¥ Sá»‘ viÃªn Ä‘Ã£ báº¯n trong Ä‘á»£t
let lastShootTime = 0;           // ğŸ•’ Thá»i Ä‘iá»ƒm báº¯n gáº§n nháº¥t
let autoBurstIndex = 0;
let autoLastBurstTime = 0;
let clickShotMode = 4; // 0: xoáº¯n á»‘c, 1: zigzag, 2: spiral, 3: xuyÃªn tháº³ng, 4: máº·c Ä‘á»‹nh

const autoBurstDelay = 100; // ms delay giá»¯a tá»«ng viÃªn trong auto

// ğŸ§Ÿ Thá»‘ng kÃª â€“ Ká»¹ nÄƒng & zombie
let zombieKillCount = 0;
let zombieSpawnedCount = 0;
let zombieByLevel = {};
for (let i = 1; i <= 10; i++) zombieByLevel[i] = 0;
zombieByLevel.boss = 0;
zombieByLevel.miniBoss = 0;
let skillStats = {};             // ğŸ“Š Thá»‘ng kÃª ká»¹ nÄƒng

// ğŸ§ Tráº¡ng thÃ¡i ngÆ°á»i chÆ¡i
const player = {
  x: 480, y: 360, size: 20, speed: 1,
  hearts: 10, energy: 1, mana: 1,
  level: 1, score: 0,
  hitTimer: 0,
  name: "Player"
};

// ğŸŒŸ Tráº¡ng thÃ¡i nÃ¢ng cáº¥p
const playerUpgrades = {
  fireRate: 1,          // ğŸ”« HÆ°á»›ng báº¯n
  damageBoost: 1,       // ğŸ’¥ SÃ¡t thÆ°Æ¡ng cÆ¡ báº£n cá»™ng thÃªm
  hpBoost: 0,           // â¤ï¸ Sá»‘ láº§n Ä‘Ã£ tÄƒng mÃ¡u
  bulletSpeed: 1,       // ğŸ’¨ Tá»‘c Ä‘á»™ Ä‘áº¡n
  lineBulletCount: 1    // ğŸ§¨ Sá»‘ lÆ°á»£ng Ä‘áº¡n
};
// ğŸŒŸ Biáº¿n nÃ¢ng cáº¥p ká»¹ nÄƒng máº·c Ä‘á»‹nh (ğŸ”ª Äao, âš”ï¸ Kiáº¿m, ğŸ”¥ Lá»­a, â„ï¸ BÄƒng)
const skillUpgrades = {
  // ğŸ”ª Äao: sá»‘ lÆ°á»£ng Ä‘ao vÃ  sÃ¡t thÆ°Æ¡ng tá»«ng Ä‘ao
  bladeCount: 2,           // báº¯t Ä‘áº§u 2 Ä‘ao, tá»‘i Ä‘a 20
  bladeDamage: 1,          // sÃ¡t thÆ°Æ¡ng tá»«ng Ä‘ao

  // âš”ï¸ Kiáº¿m: cáº¥p Ä‘á»™ mÆ°a kiáº¿m (sá»‘ lÆ°á»£ng + sÃ¡t thÆ°Æ¡ng)
  swordLevel: 1,           // cáº¥p Ä‘á»™ mÆ°a kiáº¿m, tÄƒng sá»‘ lÆ°á»£ng theo cáº¥p
  swordDamage: 1,          // sÃ¡t thÆ°Æ¡ng má»—i kiáº¿m

  // ğŸ”¥ Lá»­a: sá»‘ lÆ°á»£ng cáº§u lá»­a vÃ  sÃ¡t thÆ°Æ¡ng
  fireCount: 2,            // báº¯t Ä‘áº§u 2 quáº£ cáº§u, tá»‘i Ä‘a 10
  fireDamage: 1,           // sÃ¡t thÆ°Æ¡ng má»—i quáº£

  // â„ï¸ BÄƒng: sá»‘ lÆ°á»£ng cáº§u bÄƒng vÃ  sÃ¡t thÆ°Æ¡ng
  iceCount: 2,             // báº¯t Ä‘áº§u 2 quáº£ cáº§u, tá»‘i Ä‘a 10
  iceDamage: 1             // sÃ¡t thÆ°Æ¡ng má»—i quáº£
};
let petActive = false;
let petEndTime = 0;
let petRabbit = null;
let petLastHealTime = 0;
/* â”€â”€ chá»‘ng chá»n láº¡i mÃ³n Ä‘á»“ vá»«a bá» â”€â”€ */
let lastGiveUpId   = null;   // id mÃ³n Ä‘á»“ vá»«a bá»‹ bá»
let lastGiveUpTime = 0;      // má»‘c thá»i gian bá»
const RESELECT_CD  = 2000;   // 2 000 ms â†’ cáº¥m chá»n láº¡i 2 s

// âš™ï¸ Tráº¡ng thÃ¡i Ä‘iá»u khiá»ƒn & ká»¹ nÄƒng
let lastManualShootTime = 0;
const manualShootCooldown = 1000; // delay 1 giÃ¢y
let lastAutoShootTime = 0;
const autoShootCooldown = 1000;

let keys = {}, autoShoot = false;
let fireActive = false, iceActive = false;
let swordActive = false, bladeActive = false;
let frame = 0, gameOver = false;
let isPaused = false;
let pendingWave = null;
let uiVisible = true; // Tráº¡ng thÃ¡i hiá»ƒn thá»‹ UI

let nextFireIndex = 0; // Ká»¹ nÄƒng Ä‘ao xoay

// Ká»¹ nÄƒng active
let satelliteActive = false;
let satelliteEndTime = 0;
let satellites = [];

let ufoActive = false; // Ká»¹ nÄƒng UFO
let ufoEndTime = 0;
let ufoCooldown = 0;
let ufoCount = 1;
let ufos = [];
// ========================= âš¡ Lightning â€“ tráº¡ng thÃ¡i & dá»¯ liá»‡u =========================
let lightningActive = false; // Ká»¹ nÄƒng sÃ©t - tráº¡ng thÃ¡i & dá»¯ liá»‡u
let lightningEndTime = 0;
let lightningBolts = [];

let disguiseActive = false;
let disguiseEndTime = 0;

let clones = []; // ğŸ­ Global â€“ lÆ°u cÃ¡c báº£n sao hiá»‡n táº¡i
let clonesActive = false;
let clonesEndTime = 0;

let blackHoles = []; // Danh sÃ¡ch há»‘ Ä‘en
let extraShockwaves = []; // ğŸŒŠ cÃ¡c vÃ²ng ná»• phá»¥ lan ra

let bloodOrbActive = false;
let bloodOrbEndTime = 0;
let bloodOrbs = []; // [{ angle, radius, x, y }]
let bloodOrbCount = 1; // vá» sau nÃ¢ng cáº¥p +1 quáº£ cáº§u
let bloodOrbLastDrain = 0;
let particles = [];

// ğŸŒŠ Quáº£n lÃ½ wave
let wave = 1;
let waveTime = 180; // Thá»i gian má»—i wave
let waveTimer = waveTime;
let lastWaveTime = null;
let gameStarted = false;

// â± Thá»i gian ká»¹ nÄƒng
let fireTimer = 0, fireEndTime = 0;
let iceTimer = 0, iceEndTime = 0;
let swordTimer = 0, swordEndTime = 0;
let bladeTimer = 0, bladeEndTime = 0;
let levelUpGlowTime = 0;

// ğŸ“± Äiá»u khiá»ƒn cáº£m á»©ng
let touchStartX = null, touchStartY = null;
let touchMoveX = null, touchMoveY = null;

// ğŸ® Danh sÃ¡ch cÃ¡c Ä‘á»‘i tÆ°á»£ng trong game
let enemyBullets = []; // Zombie báº¯n tráº£
let zombies = [];
let bullets = [];
let swords = [];
let downwardSwords = [];
let fireballs = [];
let iceballs = [];
let items = [];
let explosions = [];
let missiles = []; // ğŸš€ Danh sÃ¡ch tÃªn lá»­a Ä‘ang bay
let expandingExplosions = []; // â˜¢ï¸ CÃ¡c vÃ²ng ná»• lan rá»™ng (dÃ¹ng cho bom háº¡t nhÃ¢n)
let activeNukes = []; // â˜¢ï¸ Danh sÃ¡ch bom háº¡t nhÃ¢n Ä‘ang hoáº¡t Ä‘á»™ng
let nuclearBombs = []; // Máº£ng lÆ°u trá»¯ riÃªng bom háº¡t nhÃ¢n
let bombsB52 = []; // ğŸ’£ Danh sÃ¡ch bom B52
let activePlanes = [];   // ğŸ›¬ Danh sÃ¡ch mÃ¡y bay Ä‘ang hoáº¡t Ä‘á»™ng

// ğŸ”§ Váº½ Canvas
const canvas = document.getElementById("game");
const ctx = canvas.getContext("2d");

// ğŸŒ€ Object Pooling
const bulletPool = [];
const explosionPool = [];
const zombiePool = [];
const swordPool = [];
const fireballPool = [];
const iceballPool = [];

//ğŸ“² 2. Sá»± kiá»‡n Ä‘iá»u khiá»ƒn bÃ n phÃ­m, chuá»™t, cáº£m á»©ng
// âŒ¨ï¸ BÃ n phÃ­m di chuyá»ƒn
document.addEventListener("keydown", e => keys[e.key.toLowerCase()] = true);
document.addEventListener("keyup", e => keys[e.key.toLowerCase()] = false);

// ğŸ–± Click chuá»™t Ä‘á»ƒ báº¯n
canvas.addEventListener("click", () => {
  const now = Date.now();
  if (now - lastManualShootTime < manualShootCooldown) return;
  lastManualShootTime = now;

  if (zombies.length === 0) return;

  const target = zombies.reduce((a, b) =>
    distance(a, player) < distance(b, player) ? a : b
  );

  const angle = Math.atan2(target.y - player.y, target.x - player.x);
  const bullet = getBullet();
  bullet.x = player.x;
  bullet.y = player.y;
  bullet.speed = playerUpgrades.bulletSpeed;
  bullet.active = true;
  bullet.color = "cyan";
  bullet.piercing = true;
  bullet.rotation = 0;

  // ======= Kiá»ƒu báº¯n tÃ¹y theo clickShotMode =======
if (clickShotMode === 0) {
  // ğŸ”„ Xoáº¯n á»‘c quanh player
  bullet.curveMode = true;
  bullet.angle = angle;
  bullet.curveRadius = 0;
  bullet.curveSpeed = 0.1 + Math.random() * 0.05;

} else if (clickShotMode === 1) {
  // â†”ï¸ Zigzag
  bullet.zigzagMode = true;
  bullet.baseAngle = angle;
  bullet.oscillatePhase = Math.random() * Math.PI * 2;
  bullet.oscillateSpeed = 0.2;
  bullet.oscillateAmplitude = 20;
  bullet.travel = 0;
  bullet.startX = player.x;
  bullet.startY = player.y;

} else if (clickShotMode === 2) {
  // ğŸ¯ Xoáº¯n á»‘c bay tháº³ng
  bullet.spiralForwardMode = true;
  bullet.baseAngle = angle;
  bullet.travel = 0;
  bullet.spiralRadius = 15;
  bullet.spiralSpeed = 0.3;
  bullet.spiralPhase = Math.random() * Math.PI * 2;
  bullet.startX = player.x;
  bullet.startY = player.y;

} else if (clickShotMode === 3) {
  // ğŸ¯ Kiá»ƒu 3 â€“ XuyÃªn tháº³ng
  bullet.dx = Math.cos(angle);
  bullet.dy = Math.sin(angle);
  bullet.piercing = true;

} else if (clickShotMode === 4) {
  // ğŸ”µ Kiá»ƒu 4 â€“ Giá»‘ng auto shoot
  bullet.dx = Math.cos(angle);
  bullet.dy = Math.sin(angle);
  bullet.piercing = false; // â— khÃ´ng xuyÃªn
}
  // ================================================

  bullets.push(bullet);
});
// GÃ¡n sá»± kiá»‡n middle click (chuá»™t giá»¯a) Ä‘á»ƒ chuyá»ƒn kiá»ƒu báº¯n
canvas.addEventListener("mousedown", (e) => {
  if (e.button === 1) {
    clickShotMode = (clickShotMode + 1) % 5;
    const modeNames = [
      "ğŸ”„ Xoáº¯n á»‘c", 
      "â†”ï¸ Zigzag", 
      "ğŸ¯ Xoáº¯n bay tháº³ng", 
      "ğŸ¯ XuyÃªn tháº³ng", 
      "ğŸ”µ Máº·c Ä‘á»‹nh"
    ];
    showWarning(`Kiá»ƒu: ${modeNames[clickShotMode]}`);
    e.preventDefault();
  }
});

// Sá»­ dá»¥ng phÃ­m Space Ä‘á»ƒ báº¯n
document.addEventListener("keydown", e => {
  if (e.code === 'Space') shoot();
});

// ğŸ“± Äiá»u khiá»ƒn cáº£m á»©ng
canvas.addEventListener("touchstart", e => {
  const touch = e.touches[0];
  touchStartX = touch.clientX;
  touchStartY = touch.clientY;
});
canvas.addEventListener("touchmove", e => {
  const touch = e.touches[0];
  touchMoveX = touch.clientX;
  touchMoveY = touch.clientY;
  e.preventDefault(); // ngÄƒn cuá»™n trang
});
canvas.addEventListener("touchend", () => {
  touchStartX = null;
  touchStartY = null;
  touchMoveX = null;
  touchMoveY = null;
});

//ğŸ’¥ 3. HÃ m há»— trá»£ tiá»‡n Ã­ch
function distance(a, b) {
return Math.hypot(a.x - b.x, a.y - b.y);}

// ğŸ HÃ m quáº£n lÃ½ rÆ¡i váº­t pháº©m khi zombie bá»‹ tiÃªu diá»‡t
function dropItem(x, y, isBoss = false, isMiniBoss = false) {
  // Boss rÆ¡i 5 váº­t pháº©m, mini boss rÆ¡i 2 váº­t pháº©m, zombie thÆ°á»ng theo xÃ¡c suáº¥t
  const dropCount = isBoss ? 5 : isMiniBoss ? 2 : (Math.random() < 0.3 ? 1 : 0); // xÃ¡c suáº¥t 30% rÆ¡i váº­t pháº©m
  for (let i = 0; i < dropCount; i++) {
    // Táº¡o lá»‡ch ngáº«u nhiÃªn nhá» Ä‘á»ƒ váº­t pháº©m rÆ¡i tá»± nhiÃªn hÆ¡n
    const offsetX = (Math.random() - 0.5) * 30;
    const offsetY = (Math.random() - 0.5) * 30;

    const safeX = Math.min(worldWidth  - wallThickness - 20,
        Math.max(wallThickness + 20, x + offsetX));
    const safeY = Math.min(worldHeight - wallThickness - 20,
        Math.max(wallThickness + 20, y + offsetY));
    // Chá»n ngáº«u nhiÃªn loáº¡i váº­t pháº©m rÆ¡i theo xÃ¡c suáº¥t
    const itemRand = Math.random();
    let type;
    if (itemRand < 0.01) type = 'box';
    else if (itemRand < 0.34) type = 'energy';
    else if (itemRand < 0.67) type = 'mana';
    else type = 'hp';

    items.push({ x: safeX, y: safeY, type, active: true });
  }
}

// ğŸ“¦ Khi ngÆ°á»i chÆ¡i nháº·t há»™p váº­t pháº©m Ä‘áº·c biá»‡t
function openItemBox() {
  const rewardCount = Math.floor(Math.random() * 3) + 1; // Nháº­n 1â€“3 loáº¡i ngáº«u nhiÃªn
  const rewards = [
    { type: 'energy', label: 'âš¡ Energy', icon: 'âš¡' },
    { type: 'mana', label: 'ğŸ’  Mana', icon: 'ğŸ’ ' },
    { type: 'hp', label: 'â¤ï¸ HP', icon: 'â¤ï¸' }
  ];

  const shuffled = rewards.sort(() => Math.random() - 0.5);
  const selected = shuffled.slice(0, rewardCount);
  const summary = [];

  selected.forEach(r => {
    const amount = Math.floor(Math.random() * 5) + 3;
    switch (r.type) {
      case 'energy': player.energy += amount; break;
      case 'mana': player.mana += amount; break;
      case 'hp': player.hearts += amount; break;
    }
    summary.push(`${r.icon} +${amount}`);
  });

  // ğŸ“¢ Gá»™p thÃ nh má»™t dÃ²ng thÃ´ng bÃ¡o duy nháº¥t
  showWarning(`ğŸ“¦ Há»™p quÃ : ${summary.join(', ')}`);
}

// ğŸ” Bullet Pooling
function getBullet() {
  return bulletPool.length ? bulletPool.pop() : { x: 0, y: 0, dx: 0, dy: 0, active: true };
}
function releaseBullet(bullet) {
    bullet.active = false;
    delete bullet.customDmg;      // â­ xoÃ¡ sÃ¡t thÆ°Æ¡ng tuá»³ chá»‰nh
    bullet.curveMode = false;     // â”
    bullet.zigzagMode = false;    // â”‚ náº¿u báº¡n dÃ¹ng cÃ¡c mode nÃ y
    bullet.spiralForwardMode = false; //â”˜
    bulletPool.push(bullet);
}

// ğŸ’¥ Explosion Pooling
function getExplosion(x, y) {
  const e = explosionPool.length ? explosionPool.pop() : { x: 0, y: 0, radius: 0, life: 0, active: true };
  e.x = x;
  e.y = y;
  e.radius = 0;
  e.life = 20;
  e.active = true;
  return e;
}
function releaseExplosion(e) {
  e.active = false;
  explosionPool.push(e);
}

// ğŸ’¥ Báº¯n Ä‘áº¡n tá»« zombie vá» phÃ­a player - shootEnemyBullet pooling
function shootEnemyBullet(x, y, speed = 0.6, chance = 1) {
  if (Math.random() > chance) return;

  const angle = Math.atan2(player.y - y, player.x - x);
  const b = getEnemyBullet();
  b.x = x;
  b.y = y;
  b.dx = Math.cos(angle);
  b.dy = Math.sin(angle);
  b.speed = speed;
  b.hit = false;
  b.active = true;

  enemyBullets.push(b);
}

// object pooling cho enemyBullets
const enemyBulletPool = [];

function getEnemyBullet() {
  return enemyBulletPool.length
    ? enemyBulletPool.pop()
    : { x: 0, y: 0, dx: 0, dy: 0, speed: 1, hit: false, active: true };
}

function releaseEnemyBullet(b) {
  b.hit = false;
  b.active = false;
  enemyBulletPool.push(b);
}

// ğŸ§Ÿ Zombie Pooling
function getZombie() {
    let z = zombiePool.length ? zombiePool.pop() : {
        x: 0, y: 0, radius: 15, canHit: true, speed: 1,
        color: "hotpink", isBoss: false, isBigBoss: false,
        hp: 1, active: true, type: "normal", level: 1
    };

    // Reset láº¡i toÃ n bá»™ khi láº¥y tá»« pool
    z.active = true;
    z._killed = false;
    z.isBoss = false;
    z.isBigBoss = false;
    z.type = "normal";
    z.color = "hotpink";
    z.radius = 15;
    z.hp = 1;
    z.level = 1;
    z.baseSpeed = 0.1 + Math.random() * 0.1;
    z.speed = z.baseSpeed;
    z.canHit = true;

    return z;
}

function releaseZombie(z) {
  z.active = false;
  zombiePool.push(z);
}
// ğŸ’¥ HÃ m tiÃªu diá»‡t zombie, dÃ¹ng chung cho má»i ká»¹ nÄƒng
function killZombie(z) {
  if (z._killed || !z.active) return;
  z._killed = true;

  // ğŸ§Ÿ Gá»¡ khá»i mÃ n vÃ  cá»™ng thá»‘ng kÃª
  releaseZombie(z);
  zombieKillCount++;

  // ğŸ¯ Cá»™ng Ä‘iá»ƒm khi tiÃªu diá»‡t
  player.score++;

  // ğŸ“Š Äáº¿m theo cáº¥p (level 1-10)
if (z.level && z.level >= 1 && z.level <= 10) {
    zombieByLevel[z.level] = (zombieByLevel[z.level] || 0) + 1;
}

// ğŸ’€ Äáº¿m miniBoss náº¿u lÃ  loáº¡i Ä‘Ã³
if (z.type === "miniBoss") {
    zombieByLevel.miniBoss = (zombieByLevel.miniBoss || 0) + 1;
}

// ğŸ’€ Äáº¿m boss chÃ­nh (boss thÆ°á»ng)
if (z.isBoss && !z.isBigBoss) {
    zombieByLevel.boss = (zombieByLevel.boss || 0) + 1;
}

// ğŸ’œ Äáº¿m BigBoss riÃªng biá»‡t
if (z.isBigBoss) {
    zombieByLevel.bigBoss = (zombieByLevel.bigBoss || 0) + 1;
}

  // ğŸ RÆ¡i váº­t pháº©m táº¡i vá»‹ trÃ­ zombie
  dropItem(z.x, z.y, z.isBoss, z.type === "miniBoss");
}

// ğŸ§  HÃ m xá»­ lÃ½ sÃ¡t thÆ°Æ¡ng vÃ o zombie, tá»± Ä‘á»™ng kiá»ƒm tra cháº¿t vÃ  hiá»‡u á»©ng
function dealDamageToZombie(z, dmg = 1) {
  z.hp -= dmg;
  if (!z._killed && z.hp <= 0) killZombie(z);
  explosions.push(getExplosion(z.x, z.y));
}

// ğŸ”ª Sword Pooling
function getSword() {
  return swordPool.length ? swordPool.pop() : {
    angle: 0,
    radius: 60,
    state: 'charging',
    chargeFrame: 90,
    x: 0,
    y: 0,
    target: null,
    fireDelay: 0,
    delay: 60
  };
}

function releaseSword(s) {
  swordPool.push(s);
}

// ğŸ”¥ Fireball Pooling
function getFireball() {
  return fireballPool.length ? fireballPool.pop() : {
    angle: 0,
    radius: 40,
    x: 0,
    y: 0
  };
}

function releaseFireball(f) {
  fireballPool.push(f);
}

// â„ï¸ Iceball Pooling
function getIceball() {
  return iceballPool.length ? iceballPool.pop() : {
    angle: 0,
    radius: 60,
    x: 0,
    y: 0
  };
}

function releaseIceball(i) {
  iceballPool.push(i);
}
// ğŸ§Š Hiá»ƒn thá»‹ cáº£nh bÃ¡o táº¡m thá»i
function showWarning(message, customStyle = {}) {
  // ğŸ”¸ Táº¡o khay náº¿u chÆ°a cÃ³
  const container = document.getElementById('notificationContainer')
        || (() => {
             const c = document.createElement('div');
             c.id = 'notificationContainer';
             document.body.appendChild(c);
             return c;
           })();

  // ğŸ”¸ Táº¡o popup
  const popup = document.createElement('div');
  popup.className  = 'warningPopup';
  popup.textContent = message;
  Object.assign(popup.style, customStyle);   // náº¿u cáº§n Ä‘á»•i mÃ u, v.v.

  container.appendChild(popup);

  /* Giá»›i háº¡n tá»‘i Ä‘a N popup Ä‘á»“ng thá»i */
  const MAX = 2;
  while (container.childElementCount > MAX) {
    container.firstElementChild.remove();
  }

  /* Tá»± xoÃ¡ sau 1,5 s */
  setTimeout(() => popup.remove(), 1500);
}
/* â”€â”€ Buffer gá»™p popup váº­t pháº©m â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
const lootBuffer  = {};     // { "âš¡":3, "ğŸ’ ":2, "â¤ï¸":1 }
let   lootTimer   = null;   // id setTimeout

function queueLootPopup(icon, delay = 500) {
  lootBuffer[icon] = (lootBuffer[icon] || 0) + 1;

  clearTimeout(lootTimer);
  lootTimer = setTimeout(() => {
    const summary = Object.entries(lootBuffer)
                  .map(([ico,c]) => `${ico} x${c}`)
                  .join(', ');
    showWarning(`ğŸ° Pet nháº·t: ${summary}`);
    Object.keys(lootBuffer).forEach(k => delete lootBuffer[k]);
  }, delay);
}

//ğŸ”« 4. Báº¯n Ä‘áº¡n & auto shoot
function shoot() {
  const now = Date.now();
  if (now - lastManualShootTime < manualShootCooldown) return;
  lastManualShootTime = now;

  const directionCount = playerUpgrades.fireRate;
  const bulletsPerDirection = 1;
  const angleOffset = Math.random() * Math.PI * 2;
  const speed = playerUpgrades.bulletSpeed;

  for (let i = 0; i < directionCount; i++) {
    const angle = angleOffset + (2 * Math.PI / directionCount) * i;

    for (let j = 0; j < bulletsPerDirection; j++) {
      const b = getBullet();
      b.x = player.x;
      b.y = player.y;
      b.dx = Math.cos(angle);
      b.dy = Math.sin(angle);
      b.speed = speed;
      b.active = true;
      bullets.push(b);
    }
  }
}

function autoShootBurst() {
  const now = Date.now();
  if (now - lastAutoShootTime >= autoShootCooldown) {
    lastAutoShootTime = now;
    autoBurstIndex = 0;
  }

  const bulletsPerDirection = playerUpgrades.lineBulletCount;
  if (autoBurstIndex >= bulletsPerDirection) return;
  if (now - autoLastBurstTime < autoBurstDelay) return;
  if (zombies.length === 0) return;

  const target = zombies.reduce((a, b) =>
    distance(a, player) < distance(b, player) ? a : b
  );
  const angle = Math.atan2(target.y - player.y, target.x - player.x);

  const b = getBullet();
  b.x = player.x;
  b.y = player.y;
  b.dx = Math.cos(angle);
  b.dy = Math.sin(angle);
  b.speed = playerUpgrades.bulletSpeed;
  b.active = true;
  bullets.push(b);

  autoBurstIndex++;
  autoLastBurstTime = now;
}

//âš”ï¸ 5. KÃ­ch hoáº¡t ká»¹ nÄƒng (KÃ­ch hoáº¡t ká»¹ nÄƒng & gÃ¡n nÃºt)
function activateSwordSkill() {
  if (!swordActive && player.energy >= 3) {
    swordActive = true;
    swordEndTime = Date.now() + 60000;
    player.energy -= 3;
    document.getElementById("bladeBtn").classList.add("active");}}

function activateDownwardSwords() {
  if (!bladeActive && player.energy >= 6) {
    bladeActive = true;
    bladeEndTime = Date.now() + 30000;
    player.energy -= 6;
    document.getElementById("swordBtn").classList.add("active");}}

// KÃ­ch hoáº¡t ká»¹ nÄƒng PET â€“ Thá» mÃ u há»“ng
function activatePet() {
  petActive       = true;                      // nay cháº¯c cháº¯n chÆ°a hoáº¡t Ä‘á»™ng
  petEndTime      = Date.now() + 60000;        // 60 s
  petLastHealTime = Date.now();

  petRabbit = {                                // speed tÃ­nh Ä‘á»™ng má»—i frame
    x      : player.x + 40,
    y      : player.y,
    radius : 14
  };

  const btn        = document.getElementById("PetBtn");
  btn.innerText    = lastPetText;
  btn.classList.add("active");

  showWarning("ğŸ° Pet thá» Ä‘Ã£ ra tráº­n!");
}
// ğŸ–± GÃ¡n sá»± kiá»‡n nÃºt
// ğŸ”ª Ká»¹ nÄƒng Äao
document.getElementById("bladeBtn").onclick = () => {
  if (player.level < 1) return showWarning("ğŸ”ª YÃªu cáº§u Lv1");
  if (player.energy < 3) return showWarning("ğŸ”ª KhÃ´ng Ä‘á»§ 3âš¡");
  activateSwordSkill();
};
// âš”ï¸ Ká»¹ nÄƒng Kiáº¿m
document.getElementById("swordBtn").onclick = () => {
  if (player.level < 2) return showWarning("âš”ï¸ YÃªu cáº§u Lv2");
  if (player.energy < 6) return showWarning("âš”ï¸ KhÃ´ng Ä‘á»§ 6âš¡");
  activateDownwardSwords();
};
// ğŸ”¥ Ká»¹ nÄƒng Lá»­a
document.getElementById("fireBtn").onclick = () => {
  if (player.level < 3) return showWarning("ğŸ”¥ YÃªu cáº§u Lv3");
  if (player.energy < 8) return showWarning("ğŸ”¥ KhÃ´ng Ä‘á»§ 8âš¡");
  if (!fireActive) {
    fireActive = true;
    fireballs.length = 0;
    const fireCount = skillUpgrades.fireCount;
    for (let i = 0; i < fireCount; i++) {
      const angle = (2 * Math.PI / fireCount) * i;
      const f = getFireball();
      f.angle = angle;
      f.radius = 40;
      f.x = player.x + Math.cos(angle) * 40;
      f.y = player.y + Math.sin(angle) * 40;
      fireballs.push(f);
    }
    fireEndTime = Date.now() + 45000;
    player.energy -= 8;
    document.getElementById("fireBtn").classList.add("active");
  }
};
// â„ï¸ Ká»¹ nÄƒng BÄƒng
document.getElementById("iceBtn").onclick = () => {
  if (player.level < 3)   return showWarning("â„ï¸ YÃªu cáº§u Lv3");
  if (player.energy < 12) return showWarning("â„ï¸ KhÃ´ng Ä‘á»§ 12âš¡");
  if (!iceActive) {
    iceActive  = true;
    iceballs.length = 0;                    // xoÃ¡ vÃ²ng cÅ©
    const iceCount = skillUpgrades.iceCount;
    for (let i = 0; i < iceCount; i++) {
      const angle = (2 * Math.PI / iceCount) * i;
      const b     = getIceball();
      b.angle  = angle;
      b.radius = 60;
      b.x = player.x + Math.cos(angle) * 60;
      b.y = player.y + Math.sin(angle) * 60;
      iceballs.push(b);
    }
    iceEndTime      = Date.now() + 60000;   // 60 s hiá»‡u lá»±c
    player.energy  -= 12;                   // trá»« nÄƒng lÆ°á»£ng Ä‘Ãºng 1 láº§n
    document.getElementById("iceBtn").classList.add("active");
  }
};
// Auto báº¯n
document.getElementById("autoBtn").onclick = () => {
  autoShoot = !autoShoot;
  const btn = document.getElementById("autoBtn");
  if (autoShoot) {
    btn.classList.add("active");
  } else {
    btn.classList.remove("active");
  }
};
// ğŸ° Ká»¹ nÄƒng Pet
document.getElementById("PetBtn").onclick = () => {
  if (petActive) return;                       // Ä‘ang cÃ³ thá» â†’ bá»
  if (player.energy < 5) {
    showWarning("ğŸ° KhÃ´ng Ä‘á»§ 5 âš¡");
    return;
  }
  activatePet();                               // kÃ­ch hoáº¡t thÃ nh cÃ´ng
  player.energy -= 5;                          // trá»« âš¡ duy nháº¥t 1 láº§n
};

//ğŸ§Ÿ 6. Sinh zombie vÃ  boss
// ğŸ¨ MÃ u tÆ°Æ¡ng á»©ng cho zombie cáº¥p 1 â†’ 10
const zombieColorsByLevel = [
  "#00cc66", // Level 1 â€“ Xanh lÃ¡ sÃ¡ng (nháº¹ nhÃ ng)
  "#3399ff", // Level 2 â€“ Xanh dÆ°Æ¡ng (nháº¡t hÆ¡n boss)
  "#ffcc00", // Level 3 â€“ VÃ ng sÃ¡ng
  "#ff9900", // Level 4 â€“ Cam
  "#ff3333", // Level 5 â€“ Äá» sÃ¡ng
  "#cc00cc", // Level 6 â€“ TÃ­m
  "#9933ff", // Level 7 â€“ TÃ­m xanh Ä‘iá»‡n
  "#ff66cc", // Level 8 â€“ Há»“ng neon
  "#00ffff", // Level 9 â€“ Xanh cyan
  "#ffffff"  // Level 10 â€“ Tráº¯ng sÃ¡ng chÃ³i (gáº§n max)
];

// ğŸ“Š Báº£ng xÃ¡c suáº¥t cáº¥p Ä‘á»™ zombie theo tá»«ng wave
function getZombieLevelByWave(wave) {
  const levelTable = {
    1:  [100],
    2:  [70, 30],
    3:  [50, 50],
    4:  [40, 60],
    5:  [30, 70],
    6:  [20, 50, 30],
    7:  [15, 50, 35],
    8:  [10, 50, 40],
    9:  [5, 50, 45],
    10: [0, 50, 50],
    11: [20, 30, 20, 30],
    12: [15, 30, 25, 30],
    13: [10, 30, 30, 30],
    14: [5, 30, 35, 30],
    15: [0, 30, 40, 30],
    16: [0, 20, 40, 40],
    17: [0, 10, 40, 50],
    18: [0, 0, 40, 60],
    19: [0, 0, 30, 70],
    20: [0, 0, 20, 80],
    21: [0, 0, 10, 40, 50],
    22: [0, 0, 5, 35, 60],
    23: [0, 0, 5, 25, 60, 5],
    24: [0, 0, 0, 20, 50, 20, 10],
    25: [0, 0, 0, 15, 40, 25, 15, 5],
    26: [0, 0, 0, 10, 35, 25, 20, 10],
    27: [0, 0, 0, 5, 25, 25, 25, 15, 5],
    28: [0, 0, 0, 0, 20, 25, 25, 20, 10],
    29: [0, 0, 0, 0, 15, 20, 25, 25, 15],
    30: [0, 0, 0, 0, 10, 15, 25, 25, 20, 5]
  };

  // ğŸ‘‡ fallback khi wave > 30: zombie cáº¥p 1â€“10
  const fallback = [1, 1, 10, 10, 15, 15, 15, 15, 10, 8];
  const table = levelTable[wave] || fallback;
  const rand = Math.random() * 100;
  let sum = 0;
  for (let i = 0; i < table.length; i++) {
    sum += table[i];
    if (rand < sum) return i;
  }
  return table.length - 1;
}
// Khá»Ÿi táº¡o Zombie
function spawnZombie() {
  const z = getZombie();
  const level = getZombieLevelByWave(wave); // cáº¥p tá»« 0â€“9
// HP zombie tÄƒng theo level player + random 1~10
  if (wave >= 10) {
  z.hp = level + 1 + Math.floor(player.level / 2) + Math.floor(Math.random() * 10 + 1);
} else {
  z.hp = level + 1;
}
  z.baseHp = z.hp; // ğŸ”‘ Ghi nhá»› HP gá»‘c Ä‘á»ƒ reset ban ngÃ y
  z.level = level + 1; // cáº¥p tháº­t tá»« 1â€“10
// ğŸ‘£ Di chuyá»ƒn ngáº«u nhiÃªn ban Ä‘áº§u
  z.state = "wandering";
  z.nextStateCheck = Date.now() + 3000; // kiá»ƒm tra má»—i 3s khi Ä‘ang chasing - kiá»ƒm tra má»—i giÃ¢y
  z.wanderTime = Date.now() + 2000 + Math.random() * 2000; // tá»« 2 Ä‘áº¿n 4 giÃ¢y
  z.wanderAngle = Math.random() * Math.PI * 2;
// ğŸ² Chá»n kiá»ƒu wander: 80% di chuyá»ƒn, 20% Ä‘á»©ng im
  z.wanderBehavior = Math.random() < 0.2 ? "pause" : "move";
  z.baseSpeed = 0.02 + Math.random() * 0.3; // tá»‘c Ä‘á»™ khi chasing - tá»‘c Ä‘á»™ khi Ä‘uá»•i theo
  z.speed = 0.015 + Math.random() * 0.05;   // tá»‘c Ä‘á»™ khi wandering - tá»‘c Ä‘á»™ khi lang thang
  z.color = zombieColorsByLevel[level];
  z.type = "normal";
  z.radius = 15;
  z.isBoss = false;
  z.showStatusIcon = Math.random() < 0.3; // 30% zombie thÆ°á»ng hiá»ƒn thá»‹ icon tráº¡ng thÃ¡i

// ğŸ¯ Random mini boss (xuáº¥t hiá»‡n 2%) - Tá»· lá»‡ xuáº¥t hiá»‡n mini boss
if (Math.random() < 0.02) {
  z.type = "miniBoss";
  // HP mini boss tÄƒng theo wave vÃ  level player
  z.hp = 50 + wave + Math.floor(player.level / 2) + Math.floor(Math.random() * 20 + 1); 
  z.color = bossColors[Math.floor(Math.random() * bossColors.length)]; // MÃ u mini boss
  z.radius = 18;
  z.level = 99; // ÄÃ¡nh dáº¥u riÃªng Ä‘á»ƒ khÃ´ng tÃ­nh cáº¥p thÆ°á»ng
}

// ğŸ“ Táº¡o zombie ngáº«u nhiÃªn bÃªn trong báº£n Ä‘á»“
z.x = Math.random() * worldWidth;
z.y = Math.random() * worldHeight;
// ğŸ“ Äáº·t zombie
  zombies.push(z);
  zombieSpawnedCount++;
}

// MÃ u boss
const bossColors = [
  "#ff3333", // Äá» tÆ°Æ¡i
  "#ff8800", // Cam rá»±c
  "#ffaa00", // VÃ ng cam
  "#00ccff", // Xanh dÆ°Æ¡ng sÃ¡ng
  "#9933ff", // TÃ­m Ä‘áº­m
  "#00ff99", // Xanh ngá»c
  "#ff66cc", // Há»“ng neon
  "#ffffff", // Tráº¯ng láº¡nh
  "#888888", // XÃ¡m tro (boss mÃ¡y mÃ³c)
  "#00ffff"  // Xanh cyan Ã¡nh kim
];

function spawnBoss() {
  const z = getZombie();
   // ğŸ“ âŠ Chá»n vá»‹ trÃ­ ngáº«u nhiÃªn trong world
  // (worldWidth / worldHeight Ä‘Ã£ dÃ¹ng cho zombie thÆ°á»ng)
  do {
    z.x = Math.random() * worldWidth;
    z.y = Math.random() * worldHeight;
    // ğŸ“ â‹ Báº£o Ä‘áº£m khÃ´ng â€œÃºp sá»tâ€ player
  } while (distance(z, player) < 250); // â‰¥ 250 px má»›i cho xuáº¥t hiá»‡n

  z.radius = 30;
  z.canHit = true;
  z.baseSpeed = 0.015 + Math.random() * 0.03; // LÆ°u tá»‘c Ä‘á»™ gá»‘c | Tá»‘c Ä‘á»™ boss
  z.speed = z.baseSpeed; // Báº¯t Ä‘áº§u báº±ng tá»‘c Ä‘á»™ gá»‘c
  z.isBoss = true;
  // HP boss tÄƒng theo wave vÃ  level player + random 1~100
  z.hp = 100 + wave * 2 + Math.floor(player.level / 2) + Math.floor(Math.random() * 100 + 1);
  z.baseHp = z.hp; // ğŸ”‘ Ghi nhá»› HP gá»‘c Ä‘á»ƒ reset ban ngÃ y
  z.type = "boss";
  z.level = 100; // level Boss
  z.color = bossColors[Math.floor(Math.random() * bossColors.length)]; // MÃ u boss
  z.active = true;
  zombies.push(z);
  zombieSpawnedCount++;
}
function spawnBigBoss() {
    const z = getZombie();
    z.active = true; // reset láº¡i cháº¯c cháº¯n
    z._killed = false;

    do {
        z.x = Math.random() * worldWidth;
        z.y = Math.random() * worldHeight;
    } while (distance(z, player) < 250); // trÃ¡nh sinh gáº§n player

    z.radius = 120; // KÃ­ch thÆ°á»›c bigboss
    z.baseSpeed = 0.01 + Math.random() * 0.2;
    z.speed = z.baseSpeed;
    z.isBoss = true;
    z.isBigBoss = true; // ğŸ”‘ ÄÃ¡nh dáº¥u riÃªng bigBoss
    z.hp = 10000 + wave * 500 + Math.floor(Math.random() * 1000 + 250);
    z.baseHp = z.hp;
    z.type = "bigBoss";
    z.level = 999;
    z.color = "purple"; // Äá»•i mÃ u Ä‘á»ƒ dá»… phÃ¢n biá»‡t
    z.active = true;
    zombies.push(z);
    zombieSpawnedCount++;
}

//ğŸ§  7. Cáº­p nháº­t UI â€“ chá»‰ DOM
// ğŸ§Ÿ HÃ m cáº­p nháº­t Wave riÃªng biá»‡t (dÃ¹ng khi wave thay Ä‘á»•i)
function updateWaveUI() {
  document.getElementById("score-bottom").innerText = `Level: ${player.level} |âš¡: ${player.energy}`;
  setTimeout(() => {
  document.getElementById("waveNumberDisplay").innerText = `Wave: ${wave}`;
}, 1000); // â±ï¸ hiá»ƒn thá»‹ sau 1 giÃ¢y
  document.getElementById("ui-mana").innerText = `ğŸ’  Mana: ${player.mana}`;
}
// DOM chá»‰ cáº­p nháº­t khi giÃ¡ trá»‹ thay Ä‘á»•i
let lastScore = -1, lastLevel = -1, lastEnergy = -1, lastHearts = -1, lastHighScore = -1; let lastMana = -1;
let lastBladeText = "", lastSwordText = "", lastFireText = "", lastIceText = "", lastFpsText = "", lastPetText = "";

function updateUI() {
  const highScore = parseInt(localStorage.getItem('highScore') || '0');
  if (player.score > highScore) {
    localStorage.setItem('highScore', player.score);
}
  if (
    player.score !== lastScore ||
    player.hearts !== lastHearts ||
    highScore !== lastHighScore
  ) {
    lastScore = player.score;
    lastHearts = player.hearts;
    lastHighScore = highScore;
    document.getElementById("score-top").innerText =`Kill: ${player.score} | â¤ï¸: ${player.hearts}`;
    document.getElementById("highScoreDisplay").innerText = `ğŸ† Ká»· lá»¥c: ${highScore}`;
  }

  if (
    player.level !== lastLevel ||
    player.energy !== lastEnergy
  ) {
    lastLevel = player.level;
    lastEnergy = player.energy;
    updateWaveUI(); // ğŸ§Ÿ tÃ¡ch riÃªng hiá»ƒn thá»‹ wave
  }
  if (player.mana !== lastMana) {
  lastMana = player.mana;
  document.getElementById("ui-mana").innerText = `ğŸ’  Mana: ${player.mana}`;
}
}

// HÃ m Ä‘iá»u phá»‘i theo tráº¡ng thÃ¡i sword
function updateSwordByState(s) {
  switch (s.state) {
    case 'charging': return updateSwordCharging(s);
    case 'readyToFire': return updateSwordReady(s);
    case 'flying': return updateSwordFlying(s);
    default: return true;
  }
}

// âš™ï¸ Äao Ä‘ang xoay quanh ngÆ°á»i chÆ¡i trong tráº¡ng thÃ¡i "charging"
function updateSwordCharging(s) {
// Giáº£m thá»i gian xoay cÃ²n láº¡i
  s.chargeFrame--;
// Cáº­p nháº­t gÃ³c quay & vá»‹ trÃ­ Ä‘ao theo gÃ³c
  s.angle += 0.015;
  s.x = player.x + Math.cos(s.angle) * s.radius;
  s.y = player.y + Math.sin(s.angle) * s.radius;
// Kiá»ƒm tra va cháº¡m zombie gáº§n Ä‘ao
  checkSwordHitsNearbyZombie(s);
// Khi xoay Ä‘á»§ thá»i gian â†’ chuyá»ƒn sang tráº¡ng thÃ¡i "readyToFire"
  if (s.chargeFrame <= 0) {
    s.state = 'readyToFire';
    s.fireDelay = 30; // thá»i gian chá» trÆ°á»›c khi báº¯t Ä‘áº§u bay
  }
  return true; // giá»¯ Ä‘ao trong máº£ng
}

// â³ Äao Ä‘ang chá» sáºµn Ä‘á»ƒ bay ra sau khi xoay xong
function updateSwordReady(s) {
//  Má»—i Ä‘ao chá»‰ bay khi Ä‘áº¿n lÆ°á»£t mÃ¬nh
  if (s.fireOrder === nextFireIndex) {
    s.fireDelay--;
    if (s.fireDelay <= 0) {
      s.state = 'flying';
      s.target = findActiveZombie();
      nextFireIndex++; // chuyá»ƒn lÆ°á»£t sang Ä‘ao tiáº¿p theo
    }
  }
  return true;
}

// ğŸš€ Äao bay vá» phÃ­a má»¥c tiÃªu (zombie)
function updateSwordFlying(s) {
// Náº¿u khÃ´ng cÃ³ target hoáº·c zombie Ä‘Ã£ cháº¿t â†’ tÃ¬m láº¡i zombie má»›i
  if (!s.target || !s.target.active) {
    s.target = findActiveZombie();
    if (!s.target) return true; // chÆ°a cÃ³ zombie â†’ giá»¯ Ä‘ao chá» tiáº¿p
  }
// Di chuyá»ƒn Ä‘ao hÆ°á»›ng tá»›i má»¥c tiÃªu
  moveSwordTowardsTarget(s);
// Kiá»ƒm tra va cháº¡m vá»›i má»¥c tiÃªu
  if (distance(s, s.target) < 25) {
    handleSwordHit(s); // xá»­ lÃ½ trÃºng Ä‘á»‹ch
    return false;      // loáº¡i Ä‘ao sau khi trÃºng
  }
  return true; // tiáº¿p tá»¥c bay
}

// ğŸ“ Di chuyá»ƒn Ä‘ao bay Ä‘áº¿n má»¥c tiÃªu
function moveSwordTowardsTarget(s) {
  const dx = s.target.x - s.x;
  const dy = s.target.y - s.y;
  const angle = Math.atan2(dy, dx);
  s.x += Math.cos(angle) * 5;
  s.y += Math.sin(angle) * 5;
}

// ğŸ’¥ Xá»­ lÃ½ khi Ä‘ao bay trÃºng má»¥c tiÃªu
function handleSwordHit(s) {
  dealDamageToZombie(s.target, playerUpgrades.damageBoost || 1);
}

// ğŸ§¿ TÃ¬m zombie cÃ²n sá»‘ng gáº§n player nháº¥t 
function findActiveZombie() {
  return zombies.find(z => z.active);
}

function checkSwordHitsNearbyZombie(s) {
  const target = zombies.find(z => z.active && distance(s, z) < 20);
  if (target) {
  dealDamageToZombie(target, skillUpgrades.bladeDamage + playerUpgrades.damageBoost);
  }
}
/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   ğŸ° Cáº¬P NHáº¬T PET â€“ Gá»ŒI Má»–I FRAME
   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function updatePet() {
  if (!petActive || !petRabbit) return;

  /* háº±ng sá»‘ */
  const DIST_ITEM    = 360;
  const DIST_FOLLOW  = 480;
  const TOLERANCE    = 40;
  const PICK_DIST    = 16;
  const GIVE_UP_MS   = 3000;
  const MIN_PROGRESS = 20;    // pháº£i tiáº¿n â‰¥20 px sau 3 s

  /* tá»‘c Ä‘á»™ */
  petRabbit.speed = (player.speed ?? 1) + 0.4;

  /* 0. quay vá» náº¿u xa player quÃ¡ */
  if (distance(petRabbit, player) > DIST_FOLLOW) {
    moveTowards(petRabbit, player, petRabbit.speed * 1.6);
    petRabbit.target = null;
    return;
  }

  /* 1. chá»n má»¥c tiÃªu má»›i */
  if (!petRabbit.target || !petRabbit.target.active) {
    petRabbit.target = items
      .filter(it => {
        if (!it.active) return false;
        if (distance(petRabbit, it) > DIST_ITEM) return false;
        /* cáº¥m chá»n láº¡i item vá»«a bá» trong 2 s */
        if (it.id === lastGiveUpId &&
            Date.now() - lastGiveUpTime < RESELECT_CD) return false;
        return true;
      })
      .sort((a, b) => distance(petRabbit, a) - distance(petRabbit, b))[0] || null;

    if (petRabbit.target) {
      petRabbit.chaseStart    = Date.now();
      petRabbit.startDistance = distance(petRabbit, petRabbit.target);
    }
  }

  /* 2. Ä‘uá»•i & nháº·t */
  if (petRabbit.target) {
    const dNow     = distance(petRabbit, petRabbit.target);
    const elapsed  = Date.now() - petRabbit.chaseStart;
    const progress = petRabbit.startDistance - dNow;

    /* bá» náº¿u >3 s mÃ  tiáº¿n <20 px */
    if (elapsed > GIVE_UP_MS && progress < MIN_PROGRESS) {
      giveUp();
      return;
    }

    /* bá» náº¿u má»¥c tiÃªu láº¡i quÃ¡ xa player */
    if (distance(player, petRabbit.target) > DIST_FOLLOW) {
      giveUp();
      return;
    }

    moveTowards(petRabbit, petRabbit.target, petRabbit.speed);

    if (dNow < PICK_DIST) collectLoot();
  }
  /* 3. bÃ¡m player khi khÃ´ng cÃ³ má»¥c tiÃªu */
  else if (distance(petRabbit, player) > TOLERANCE) {
    moveTowards(petRabbit, player, petRabbit.speed * 1.2);
  }

  /* 4. há»“i mÃ¡u & háº¿t giá» */
  if (Date.now() - petLastHealTime >= 10000) {
    petLastHealTime = Date.now();
    player.hearts++;
    showWarning("â¤ï¸ Pet há»“i mÃ¡u!");
  }
    if (Date.now() >= petEndTime) { // kiá»ƒm tra háº¿t thá»i gian ngay Ä‘áº§u hÃ m Ä‘áº£m báº£o luÃ´n cháº¡y Ä‘Ãºng lÃºc
    petActive = false;
    petRabbit = null;
    showWarning("ğŸ° Pet Ä‘Ã£ rá»i Ä‘i.");
  }
}

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€ helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function moveTowards(obj, target, spd) {
  const ang = Math.atan2(target.y - obj.y, target.x - obj.x);
  obj.x += Math.cos(ang) * spd;
  obj.y += Math.sin(ang) * spd;
}

function collectLoot() {
  const t = petRabbit.target;
  switch (t.type) {
    case "energy": player.energy++; queueLootPopup("âš¡"); break;
    case "mana":   player.mana++;   queueLootPopup("ğŸ’ "); break;
    case "hp":     player.hearts++; queueLootPopup("â¤ï¸"); break;
    case "box":    openItemBox(); break;
  }
  t.active = false;
  petRabbit.target = null;
}

function giveUp() {
  lastGiveUpId   = petRabbit.target.id;   // ghi nhá»› id
  lastGiveUpTime = Date.now();
  petRabbit.target = null;
  showWarning("ğŸ° Ä‘á»«ng Ä‘i xa, quay vá»!");
}

//ğŸ”„ 8. Cáº­p nháº­t logic game (Main loop logic)
function update() {
  if (!gameStarted || gameOver || isPaused) return; // khÃ´ng cáº­p nháº­t khi chÆ°a báº¯t Ä‘áº§u, game over hoáº·c táº¡m dá»«ng
// Cáº­p nháº­t wave logic
// â± Äáº¿m thá»i gian cÃ²n láº¡i cá»§a wave
if (lastWaveTime) {
  const elapsed = (Date.now() - lastWaveTime) / 1000; // giÃ¢y Ä‘Ã£ trÃ´i qua
  const remaining = Math.max(0, waveTime - elapsed);  // thá»i gian cÃ²n láº¡i
  const min = Math.floor(remaining / 60);
  const sec = Math.floor(remaining % 60);
  const ms = Math.floor((remaining - Math.floor(remaining)) * 100); // láº¥y 2 chá»¯ sá»‘ sau dáº¥u .
  document.getElementById("waveTimerDisplay").innerText =
  `${min.toString().padStart(2, '0')}:${sec.toString().padStart(2, '0')}:${ms.toString().padStart(2, '0')}`;

if (remaining <= 0) {
  wave++;
  pendingWave = wave;         // ğŸŒŠ lÆ°u wave Ä‘á»ƒ hiá»ƒn thá»‹ sau
  showUpgradePopup();         // ğŸ hiá»ƒn thá»‹ nÃ¢ng cáº¥p trÆ°á»›c
  // Khi lÃªn wave 5, reset thá»i gian BigBoss Ä‘áº¿m tá»« 0
    if (wave === 5) {
        bigBossRespawnTimer = 0;
        lastBigBossTimerUpdate = performance.now();
    }
  lastWaveTime = Date.now();  // â±ï¸ reset timer
  updateWaveUI();
}
}
// Thá»i gian bigboss há»“i sinh
const existingBigBoss = zombies.find(z => z.active && z.isBigBoss);
const bigBossRemain = Math.max(0, Math.ceil(bigBossRespawnInterval - bigBossRespawnTimer));

const box = document.getElementById("bigBossRespawnDisplay");
box.style.display = "block"; // LuÃ´n hiá»ƒn thá»‹

if (wave < 5) {
    box.innerText = "BigBoss: --";
} else {
    box.innerText = existingBigBoss ? "BigBoss: living" : `BigBoss: ${bigBossRemain}s`;
}
// Xá»­ lÃ½ ká»¹ nÄƒng Äao ğŸ”ª tá»± táº¡o liÃªn tá»¥c trong 30s
if (swordActive) {
  if (Date.now() >= swordEndTime) {
    swordActive = false;
    swords.length = 0;
    document.getElementById("bladeBtn").classList.remove("active");
    document.getElementById("bladeBtn").innerText = "ğŸ”ª Äao";
  } else {
    const remain = Math.ceil((swordEndTime - Date.now()) / 1000);
// ğŸ¯ Cáº­p nháº­t bladeBtn náº¿u khÃ¡c giÃ¡ trá»‹ trÆ°á»›c Ä‘Ã³
const bladeRemain = Math.ceil((swordEndTime - Date.now()) / 1000);
const bladeText = `ğŸ”ª ${bladeRemain}s`;
if (bladeText !== lastBladeText) {
  lastBladeText = bladeText;
  document.getElementById("bladeBtn").innerText = bladeText;
}

// ğŸ”ª Táº¡o Ä‘ao má»›i náº¿u chÆ°a cÃ³
if (swords.length === 0) {
  swordTimer = 0;
  const count = skillUpgrades.bladeCount; // ğŸ”ª Sá»‘ Ä‘ao tá»« nÃ¢ng cáº¥p
  nextFireIndex = 0;
for (let i = 0; i < count; i++) {
  const angle = (2 * Math.PI / count) * i;
  const s = getSword(); // hoáº·c táº¡o sword má»›i
  s.angle = angle;
  s.radius = 60;
  s.state = 'charging';
  s.chargeFrame = 90;
  s.fireDelay = 20 + i * 10; // tá»«ng Ä‘ao delay khÃ¡c nhau
  s.fireOrder = i; //  Ä‘Ã¡nh sá»‘ Ä‘ao
  swords.push(s);
}
}
}
}
// ğŸ¯ Tá»‘i Æ°u xá»­ lÃ½ tráº¡ng thÃ¡i cá»§a swords
swords = swords.filter(updateSwordByState);
// === Xá»¬ LÃ Ká»¸ NÄ‚NG KIáº¾M (tá»« trÃªn cao) ===
if (bladeActive) {
if (Date.now() >= bladeEndTime) {
    bladeActive = false;
    downwardSwords.length = 0;
    document.getElementById("swordBtn").classList.remove("active");
    document.getElementById("swordBtn").innerText = "âš”ï¸ Kiáº¿m";
  } else {
    const remain = Math.ceil((bladeEndTime - Date.now()) / 1000);
// ğŸ¯ Cáº­p nháº­t swordBtn náº¿u khÃ¡c giÃ¡ trá»‹ trÆ°á»›c Ä‘Ã³
  const swordRemain = Math.ceil((bladeEndTime - Date.now()) / 1000);
  const swordText = `âš”ï¸ ${swordRemain}s`;
if (swordText !== lastSwordText) {
  lastSwordText = swordText;
  document.getElementById("swordBtn").innerText = swordText;
}

// ğŸŒ§ï¸ Táº¡o mÆ°a kiáº¿m má»—i 12 frame
if (frame % 12 === 0) {
  const count = Math.floor(Math.random() * 2) + skillUpgrades.swordLevel; // chá»‰ 1â€“2 kiáº¿m má»—i Ä‘á»£t
  for (let i = 0; i < count; i++) {
    const x = Math.random() * canvas.width;
    downwardSwords.push({
      x,
      y: -20,
      speed: 5 + Math.random() * 1.5 // rÆ¡i mÆ°á»£t
    });
  }
}
// ğŸ¯ Di chuyá»ƒn vÃ  xá»­ lÃ½ kiáº¿m rÆ¡i
downwardSwords.forEach((s, si) => {
  s.y += s.speed;
  zombies.forEach((z) => {
    if (!z.active) return;
    if (distance(s, z) < 25) {
  dealDamageToZombie(z, skillUpgrades.swordDamage + playerUpgrades.damageBoost);
}
});
});

// âŒ XoÃ¡ kiáº¿m rÆ¡i quÃ¡ mÃ n hÃ¬nh
downwardSwords = downwardSwords.filter(s => s.y < canvas.height + 30);
}
}
if (gameOver) return;
// ğŸ” Giáº£m thá»i gian miá»…n sÃ¡t thÆ°Æ¡ng
if (player.hitTimer > 0) {
  player.hitTimer--;
}

// Player move
let moveX = 0;
let moveY = 0;

if (keys.w) moveY -= 1;
if (keys.s) moveY += 1;
if (keys.a) moveX -= 1;
if (keys.d) moveX += 1;

if (moveX !== 0 || moveY !== 0) {
  const length = Math.hypot(moveX, moveY);
  moveX /= length;
  moveY /= length;
  player.x += moveX * player.speed;
  player.y += moveY * player.speed;
  // Giá»›i háº¡n player trong báº£n Ä‘á»“
player.x = Math.max(wallThickness + player.size, Math.min(worldWidth - wallThickness - player.size, player.x));
player.y = Math.max(wallThickness + player.size, Math.min(worldHeight - wallThickness - player.size, player.y));
// ğŸ¥ Cáº­p nháº­t camera sao cho player luÃ´n á»Ÿ giá»¯a mÃ n hÃ¬nh
camera.x = player.x - canvas.width / 2;
camera.y = player.y - canvas.height / 2;

// Giá»›i háº¡n camera trong báº£n Ä‘á»“
camera.x = Math.max(0, Math.min(worldWidth - canvas.width, camera.x));
camera.y = Math.max(0, Math.min(worldHeight - canvas.height, camera.y));
}

// === Xá»­ lÃ½ Ä‘iá»u khiá»ƒn cáº£m á»©ng ===
if (touchStartX !== null && touchMoveX !== null) {
  let dx = touchMoveX - touchStartX;
  let dy = touchMoveY - touchStartY;
  const len = Math.hypot(dx, dy);
  if (len > 10) { // chá»‰ di chuyá»ƒn náº¿u vuá»‘t Ä‘á»§ lá»›n
    dx /= len;
    dy /= len;
    player.x += dx * player.speed;
    player.y += dy * player.speed;
  }
}

if (autoShoot && player.level >= 1) autoShootBurst();

// === Ká»¹ nÄƒng Lá»¬A ===
  if (fireActive) {
    const remaining = Math.ceil((fireEndTime - Date.now()) / 1000);
    const fireBtn = document.getElementById("fireBtn");
    if (remaining > 0) {
const fireText = `ğŸ”¥ ${remaining}s`;
if (fireText !== lastFireText) {
  lastFireText = fireText;
  fireBtn.innerText = fireText;
}
    } else {
fireActive = false;
fireballs.forEach(f => releaseFireball(f));
fireballs.length = 0;
fireBtn.innerText = "ğŸ”¥ Lá»­a";
fireBtn.classList.remove("active");
    }}

// === Ká»¹ nÄƒng BÄ‚NG ===
  if (iceActive) {
    const remaining = Math.ceil((iceEndTime - Date.now()) / 1000);
    const iceBtn = document.getElementById("iceBtn");
    if (remaining > 0) {
const iceText = `â„ï¸ ${remaining}s`;
if (iceText !== lastIceText) {
  lastIceText = iceText;
  iceBtn.innerText = iceText;
}
} 
else
{
iceActive = false;
iceballs.forEach(i => releaseIceball(i));
iceballs.length = 0;
iceBtn.innerText = "â„ï¸ BÄƒng";
iceBtn.classList.remove("active");
}}
// === Ká»¹ nÄƒng PET ===
if (petActive) {
  const remaining = Math.ceil((petEndTime - Date.now()) / 1000);  
  const petBtn    = document.getElementById("PetBtn");

  if (remaining > 0) {
    const petText = `ğŸ° ${remaining}s`;
    if (petText !== lastPetText) {        // trÃ¡nh gÃ¡n DOM thá»«a
      lastPetText      = petText;
      petBtn.innerText = petText;
    }
  } else {
    // Háº¿t giá»
    petBtn.innerText = "ğŸ° Pet";
    petBtn.classList.remove("active");
  }
}

updateBullets(); // gá»i hÃ m Ä‘Ã£ viáº¿t sá»­ dá»¥ng object pooling
zombies.forEach(z => {
  // ğŸ”„ Ban Ä‘Ãªm buff +5 ~ +10 HP, ban ngÃ y reset HP vá» gá»‘c
if (isNight()) {
    if (!z.hpNightBuffed) {
        z.hp += Math.floor(Math.random() * 46) + 5; // +5 ~ +10 HP
        z.hpNightBuffed = true;
    }
} else {
    if (z.hpNightBuffed) {
        z.hp = z.baseHp;
        z.hpNightBuffed = false;
    }
}
  // ğŸ‘£ Cáº­p nháº­t hÆ°á»›ng di chuyá»ƒn theo tráº¡ng thÃ¡i
  // ğŸ§  AI hÃ nh vi zombie

  if (z.state === "wandering") {
    if (Date.now() >= z.wanderTime) { // Kiá»ƒm tra thá»i gian lang thang
      z.state = "chasing";
      z.speed = z.baseSpeed;
      z.nextStateCheck = Date.now() + 3000;
    } else {
      // ğŸ‘£ Di chuyá»ƒn hoáº·c Ä‘á»©ng yÃªn
      if (z.wanderBehavior === "move") {
        z.x += Math.cos(z.wanderAngle) * z.speed;
        z.y += Math.sin(z.wanderAngle) * z.speed;
      }
      // Náº¿u pause thÃ¬ khÃ´ng lÃ m gÃ¬ (Ä‘á»©ng yÃªn)
    }
  } else if (z.state === "chasing") {
    if (Date.now() >= z.nextStateCheck) {
      z.nextStateCheck = Date.now() + 3000;

      // âŒ Boss khÃ´ng Ä‘Æ°á»£c chuyá»ƒn sang wandering
      if (!z.isBoss) {
        const pauseChance = isNight() ? 1 : 0.2; // ğŸŒ™ ÄÃªm 100%, ngÃ y 20%
        z.state = "wandering";
        z.wanderTime = Date.now() + 1500 + Math.random() * 8500; // Thá»i gian hÃ nh vi Zzz tá»« 1.5s - 10s
        z.wanderAngle = Math.random() * Math.PI * 2;
        z.speed = 0.15 + Math.random() * 0.05;
        z.wanderBehavior = Math.random() < pauseChance ? "pause" : "move"; // 50% Ä‘Ãªm, 20% ngÃ y
        return;
      }
    }
    // ğŸ‘Š Náº¿u váº«n chasing â†’ Ä‘uá»•i theo player
    const angle = Math.atan2(player.y - z.y, player.x - z.x);
    z.x += Math.cos(angle) * z.speed;
    z.y += Math.sin(angle) * z.speed;
  }

  // Zombie báº¯n tráº£
  // ğŸ§  Boss hoáº·c mini boss báº¯n 1 láº§n má»—i 10 giÃ¢y
  if (z.isBoss || z.type === "miniBoss") {
    if (!z.lastShoot) z.lastShoot = 0;
    const now = Date.now();
    if (now - z.lastShoot >= 8000) { // Boss báº¯n má»—i 8 giÃ¢y
      z.lastShoot = now;
      shootEnemyBullet(z.x, z.y, 0.8, 0.8); // 80% xÃ¡c suáº¥t
    }
  }

  // ğŸ‘¾ Zombie thÆ°á»ng chá»‰ báº¯n sau má»—i 60s vÃ  cÃ³ 1% xÃ¡c suáº¥t
  if (!z.isBoss && z.type !== "miniBoss") {
    if (!z.lastShoot) z.lastShoot = 0;
    const now = Date.now();
    if (now - z.lastShoot >= 60000) { // Zombie thÆ°á»ng báº¯n má»—i 60 giÃ¢y
      z.lastShoot = now;
      shootEnemyBullet(z.x, z.y, 0.6 + Math.random() * 0.6, 0.001); // 0.1% xÃ¡c suáº¥t
    }
  }

  // ğŸ§Ÿ Xá»­ lÃ½ va cháº¡m vá»›i player
  if (distance(z, player) < z.radius + player.size) {
    // ğŸ›¡ï¸ Náº¿u khiÃªn Ä‘ang hoáº¡t Ä‘á»™ng, zombie khÃ´ng Ä‘Æ°á»£c phÃ©p vÃ o bÃªn trong
    if (player.shieldActive) {
      const shieldRadius = 48;
      const repelDistance = shieldRadius + z.radius;
      const dist = distance(z, player);
      if (dist < repelDistance) {
        const dx = z.x - player.x;
        const dy = z.y - player.y;
        const angle = Math.atan2(dy, dx);
        const pushBack = (repelDistance - dist) + 20;
        z.x += Math.cos(angle) * pushBack;
        z.y += Math.sin(angle) * pushBack;
        return;
      }
    }

    const dist = distance(z, player);
    if (dist < z.radius + player.size) {
      if (z.canHit) {
        player.hearts--;
        explosions.push(getExplosion(z.x, z.y));
        z.canHit = false;
        setTimeout(() => { z.canHit = true; }, 500);
        if (player.hearts <= 0) {
          gameOver = true;
          document.getElementById("gameOverPanel").style.display = "flex";
        }
      }
      const dx = z.x - player.x;
      const dy = z.y - player.y;
      const angle = Math.atan2(dy, dx);
      const pushBack = (z.radius + player.size - dist) + 1;
      z.x += Math.cos(angle) * pushBack;
      z.y += Math.sin(angle) * pushBack;
    }
  }

  // ğŸš« Giá»›i háº¡n zombie khÃ´ng vÆ°á»£t khá»i báº£n Ä‘á»“
  z.x = Math.max(wallThickness + z.radius, Math.min(worldWidth - wallThickness - z.radius, z.x));
  z.y = Math.max(wallThickness + z.radius, Math.min(worldHeight - wallThickness - z.radius, z.y));
});
// BigBoss logic - Táº¡o bigboss vÃ  há»“i sinh má»—i 60s
// ğŸ¯ BigBoss chá»‰ báº¯t Ä‘áº§u Ä‘áº¿m tá»« wave 5 trá»Ÿ lÃªn
if (wave >= 5) {
    // Kiá»ƒm tra xem hiá»‡n táº¡i cÃ³ BigBoss tá»“n táº¡i khÃ´ng
    const existingBigBoss = zombies.find(z => z.active && z.isBigBoss);

    if (!existingBigBoss) {
        // Náº¿u vá»«a má»›i vÃ o wave 5, reset timer
        if (wave === 5 && bigBossRespawnTimer === 0) {
            bigBossRespawnTimer = 0;
            lastBigBossTimerUpdate = performance.now();
        }

        // Äáº¿m thá»i gian thá»±c Ä‘á»ƒ há»“i sinh
        const now = performance.now();
        const elapsed = (now - lastBigBossTimerUpdate) / 1000;
        bigBossRespawnTimer += elapsed;
        lastBigBossTimerUpdate = now;

        if (bigBossRespawnTimer >= bigBossRespawnInterval) {
            spawnBigBoss();
            bigBossRespawnTimer = 0;
        }
    } else {
        // Náº¿u BigBoss cÃ²n sá»‘ng, reset timer Ä‘áº¿m láº¡i tá»« Ä‘áº§u
        lastBigBossTimerUpdate = performance.now();
        bigBossRespawnTimer = 0;
    }
}
// ğŸ”¥ Ká»¹ nÄƒng Lá»­a Cáº­p nháº­t fireballs - ká»¹ nÄƒng lá»­a quay quanh player vÃ  gÃ¢y sÃ¡t thÆ°Æ¡ng
fireballs = fireballs.filter(f => {
// Cáº­p nháº­t vá»‹ trÃ­ fireball quay quanh player
  f.angle += 0.05;
  f.x = player.x + Math.cos(f.angle) * f.radius;
  f.y = player.y + Math.sin(f.angle) * f.radius;

// Kiá»ƒm tra va cháº¡m vá»›i zombie
  zombies.forEach(z => {
    if (!z.active) return;
    if (distance(f, z) < 25) {
  dealDamageToZombie(z, skillUpgrades.fireDamage + playerUpgrades.damageBoost);
      z.state = "wandering"; // chuyá»ƒn sang tráº¡ng thÃ¡i wandering
      z.wanderTime = Date.now() + 3000 + Math.random() * 2000; // 3â€“5 giÃ¢y lang thang
      z.wanderAngle = Math.random() * Math.PI * 2; // gÃ³c ngáº«u nhiÃªn
}
}
);
// Giá»¯ láº¡i náº¿u ká»¹ nÄƒng váº«n Ä‘ang hoáº¡t Ä‘á»™ng
  return fireActive;
}
);
// â„ï¸ Ká»¹ nÄƒng BÄƒng Cáº­p nháº­t iceballs - ká»¹ nÄƒng bÄƒng quay quanh player vÃ  gÃ¢y sÃ¡t thÆ°Æ¡ng
iceballs = iceballs.filter(f => {
// Cáº­p nháº­t vá»‹ trÃ­ iceball quay quanh player
  f.angle += 0.03;
  f.x = player.x + Math.cos(f.angle) * f.radius;
  f.y = player.y + Math.sin(f.angle) * f.radius;
// Kiá»ƒm tra va cháº¡m vá»›i zombie
  zombies.forEach(z => {
    if (!z.active) return;
    if (distance(f, z) < 25) {
  dealDamageToZombie(z, skillUpgrades.iceDamage + playerUpgrades.damageBoost);
// LÃ m cháº­m zombie khi trÃºng bÄƒng - Ä‘oáº¡n nÃ y test
      z.speed *= 0.5; // giáº£m 50% tá»‘c Ä‘á»™
      z.state = "wandering"; // chuyá»ƒn sang tráº¡ng thÃ¡i wandering
      z.wanderTime = Date.now() + 3000 + Math.random() * 2000; // 3â€“5 giÃ¢y lang thang
      z.wanderAngle = Math.random() * Math.PI * 2; // gÃ³c ngáº«u nhiÃªn
}
}
);
// Giá»¯ láº¡i náº¿u ká»¹ nÄƒng váº«n Ä‘ang hoáº¡t Ä‘á»™ng
  return iceActive;
}
);
// ğŸ¯ Xá»­ lÃ½ nháº·t váº­t pháº©m khi ngÆ°á»i chÆ¡i tiáº¿n láº¡i gáº§n // Nháº·t item âš¡
items.forEach(it => {
  if (!it.active) return;
  if (distance(it, player) < 20) { // Náº¿u ngÆ°á»i chÆ¡i cháº¡m vÃ o váº­t pháº©m
    switch (it.type) {
      case 'energy':
        player.energy += 1;
        showWarning('âš¡ +1 Energy');
        break;
      case 'mana':
        player.mana += 1;
        showWarning('ğŸ’  +1 Mana');
        break;
      case 'hp':
        player.hearts += 1;
        showWarning('â¤ï¸ +1 HP');
        break;
      case 'box':
        openItemBox(); // Má»Ÿ há»™p váº­t pháº©m Ä‘áº·c biá»‡t
        break;
    }
    it.active = false; // Váº­t pháº©m biáº¿n máº¥t sau khi nháº·t
  }
});

items = items.filter(it => it.active);
const requiredScore = player.level * 300; // TÄƒng level #TÄƒng cáº¥p
if (player.score >= requiredScore) {
  player.level++;
  player.hearts += 1 + (UPGRADE_TIERS.hpBoost[playerUpgrades.hpBoost] || 0);
  player.energy += 2; // ğŸ thÆ°á»Ÿng 2 nÄƒng lÆ°á»£ng khi lÃªn cáº¥p
  player.mana += 2;   // ğŸ’  thÆ°á»Ÿng 2 mana khi lÃªn cáº¥p
  playerUpgrades.damageBoost += 0.5; // ğŸ’¥ TÄƒng sÃ¡t thÆ°Æ¡ng má»—i level
  showWarning("+0.5 ğŸ’¥", { top: "30%", left: "45%", transform: "translate(-50%, -50%)"});

// ğŸª„ Hiá»ƒn thá»‹ popup level
  const popup = document.getElementById("levelUpPopup");
  popup.style.animation = "none"; // reset náº¿u Ä‘Ã£ cÃ³ hiá»‡u á»©ng trÆ°á»›c Ä‘Ã³
  void popup.offsetWidth;         // trigger reflow
  popup.style.display = "block";
  setTimeout(() => {
    popup.style.display = "none";
  }, 1200);
  levelUpGlowTime = 60; // ~1s sÃ¡ng vÃ ng
  showSkillLevelUpPopup(); // <-- gá»i thÃªm popup chá»n ká»¹ nÄƒng

// ğŸ¯ Má»—i 2 cáº¥p táº¡o boss
  if (player.level % 1 === 0) {
  spawnBoss();
}}
  updateExplosions(); // dÃ¹ng object pooling thay splice
  // ğŸŒŠ Cáº­p nháº­t cÃ¡c vÃ²ng ná»• phá»¥
extraShockwaves = extraShockwaves.filter(sw => {
  sw.radius += 8; // tÄƒng bÃ¡n kÃ­nh má»—i frame
  sw.alpha -= 0.012; // giáº£m Ä‘á»™ má» dáº§n
  return sw.alpha > 0;
});

if (levelUpGlowTime > 0) levelUpGlowTime--;
// ğŸ¯ Cáº­p nháº­t bullets â€“ dÃ¹ng object pooling thay vÃ¬ splice
function updateBullets() {
  for (let i = 0; i < bullets.length; i++) {
    const b = bullets[i];
    if (!b.active) continue;

// ğŸƒ Di chuyá»ƒn Ä‘áº¡n theo hÆ°á»›ng vÃ  tá»‘c Ä‘á»™ lÆ°u riÃªng
if (b.curveMode) {
  // ğŸ”„ Xoáº¯n á»‘c quanh player
  b.curveRadius += 0.6;
  b.angle += b.curveSpeed * 0.5;
  b.x = player.x + Math.cos(b.angle) * b.curveRadius;
  b.y = player.y + Math.sin(b.angle) * b.curveRadius;

} else if (b.zigzagMode) {
  // â†”ï¸ Zigzag
  b.travel += b.speed;
  const offset = Math.sin(b.travel * b.oscillateSpeed + b.oscillatePhase) * b.oscillateAmplitude;
  const angle = b.baseAngle;
  b.x = b.startX + Math.cos(angle) * b.travel - Math.sin(angle) * offset;
  b.y = b.startY + Math.sin(angle) * b.travel + Math.cos(angle) * offset;

} else if (b.spiralForwardMode) {
  // ğŸ¯ Xoáº¯n á»‘c bay tháº³ng
  b.travel += b.speed;
  const angle = b.baseAngle;
  const centerX = b.startX + Math.cos(angle) * b.travel;
  const centerY = b.startY + Math.sin(angle) * b.travel;
  const offsetAngle = b.spiralPhase + b.travel * b.spiralSpeed;
  const offsetX = Math.cos(offsetAngle) * b.spiralRadius;
  const offsetY = Math.sin(offsetAngle) * b.spiralRadius;
  b.x = centerX + offsetX;
  b.y = centerY + offsetY;

} else {
  // ğŸŸ¡ Máº·c Ä‘á»‹nh: Ä‘áº¡n bay tháº³ng
  b.x += b.dx * b.speed;
  b.y += b.dy * b.speed;
}

for (let j = 0; j < zombies.length; j++) {
  const z = zombies[j];
  if (!z.active) continue;

if (distance(b, z) < 20) {
// âœ¨ NEW: chá»‰ dÃ¹ng customDmg náº¿u Ä‘áº¡n Ä‘Ã³ Ä‘Ã£ gÃ¡n sáºµn baseDamage,
// cÃ²n láº¡i thÃ¬ má»›i rÆ¡i vá» damageBoost chung cá»§a ngÆ°á»i chÆ¡i.
const dmg = (b.customDmg !== undefined)
            ? b.customDmg                        // Clone & má»i skill gÃ¡n sáºµn baseDamage
            : (playerUpgrades.damageBoost || 1); // Äáº¡n thÆ°á»ng cá»§a ngÆ°á»i chÆ¡i
dealDamageToZombie(z, dmg);
if (!b.piercing) {
    releaseBullet(b);
    break;
}
}
}
}
  bullets = bullets.filter(b => b.active);
}

function updateEnemyBullets() {
  for (let i = 0; i < enemyBullets.length; i++) {
    const b = enemyBullets[i];
    if (!b.active) continue;
    b.x += b.dx * b.speed;
    b.y += b.dy * b.speed;
    // Náº¿u trÃºng ngÆ°á»i chÆ¡i
    if (distance(b, player) < 15) {
    if (player.shieldActive) {
    // Äá»¡ Ä‘áº¡n, khÃ´ng máº¥t mÃ¡u
    releaseEnemyBullet(b);
    continue;
  }
if (player.hitTimer === 0) {
        player.hearts--;
        player.hitTimer = 30;
        explosions.push(getExplosion(b.x, b.y));

if (player.hearts <= 0) {
          gameOver = true;
          document.getElementById("gameOverPanel").style.display = "flex";
}
}
b.hit = true;
}
// Náº¿u ra khá»i mÃ n hÃ¬nh
    const outOfBounds =
      b.x < -50 || b.x > worldWidth + 50 ||
      b.y < -50 || b.y > worldHeight + 50;
if (b.hit || outOfBounds) {
      releaseEnemyBullet(b);
}
}
// Chá»‰ giá»¯ láº¡i cÃ¡c Ä‘áº¡n cÃ²n active
  enemyBullets = enemyBullets.filter(b => b.active);
}
// ğŸ’¥ Cáº­p nháº­t hiá»‡u á»©ng ná»• â€“ thay tháº¿ splice báº±ng release
function updateExplosions() {
  explosions.forEach(e => {
    if (!e.active) return;
    e.radius += 2;
    e.life--;
    if (e.life <= 0) {
      releaseExplosion(e);
    }
  });
}
// ğŸ’¥ Xá»­ lÃ½ cÃ¡c vÃ²ng ná»• lan (dÃ¹ng cho bom háº¡t nhÃ¢n)
expandingExplosions = expandingExplosions.filter(exp => {
  const prevRadius = exp.radius;
  exp.radius += exp.maxRadius / exp.duration;
  exp.duration--;
// ğŸ’€ GÃ¢y sÃ¡t thÆ°Æ¡ng khi vÃ²ng vá»«a cháº¡m tá»›i zombie
  zombies.forEach(z => {
    const dist = distance(exp, z);
    if (z.active && dist >= prevRadius && dist < exp.radius && !exp.hitSet.has(z)) {
    dealDamageToZombie(z, exp.damage);
    exp.hitSet.add(z);
    }
  }
);
    return exp.duration > 0;
});

if (satelliteActive) {
  if (Date.now() >= satelliteEndTime) {
    satelliteActive = false;
    satellites = [];
  } else {
// Cáº­p nháº­t vá»‹ trÃ­ vá»‡ tinh
    const satCount = satellites.length;
    if (satCount === 2) {
      satellites[0].x = player.x + 30; satellites[0].y = player.y - 30;
      satellites[1].x = player.x - 30; satellites[1].y = player.y - 30;
    } else if (satCount === 1) {
      satellites[0].x = player.x + 30; satellites[0].y = player.y - 30;
    }

// Xá»­ lÃ½ má»—i vá»‡ tinh Ä‘á»u báº¯n laze Ä‘á»™c láº­p
    satellites.forEach((sat, idx) => {
      if (!sat.laserCooldown) sat.laserCooldown = 0;
// báº¯n má»—i 2s
      if (Date.now() - sat.laserCooldown >= 2000) {
        sat.laserCooldown = Date.now();
        const target = zombies.find(z => z.active && distance(sat, z) < 300);
        if (target) {
          const angle = Math.atan2(target.y - sat.y, target.x - sat.x);
          sat.laserBeam = {
            angle: angle,
            life: 60,
            damageCooldown: 0
          };
        }
      }
// Xá»­ lÃ½ damage cho laserBeam náº¿u tá»“n táº¡i
      if (sat.laserBeam && sat.laserBeam.life > 0) {
        sat.laserBeam.life--;
        if (sat.laserBeam.damageCooldown > 0) sat.laserBeam.damageCooldown--;

// XÃ¡c Ä‘á»‹nh gá»‘c báº¯n
        const x1 = sat.x, y1 = sat.y;
        const angle = sat.laserBeam.angle;
        const dx = Math.cos(angle), dy = Math.sin(angle);

        zombies.forEach(z => {
          if (!z.active) return;
// Kiá»ƒm tra zombie gáº§n tia báº¯n
          const proj = (z.x - x1) * dx + (z.y - y1) * dy;
          const perp = Math.abs((z.x - x1) * dy - (z.y - y1) * dx);

if (proj > 0 && proj < 500 && perp < 20) {
if (sat.laserBeam.damageCooldown <= 0) {
// SÃ¡t thÆ°Æ¡ng laze (cÃ³ thá»ƒ cho sÃ¡t thÆ°Æ¡ng = baseDamage cá»§a skill)
  const skill = activeSkills.find(s => s.name === "Vá»‡ tinh laze");
  dealDamageToZombie(z, (skill?.baseDamage ?? 5) * 2); // gá»£i Ã½: tÄƒng damage cho cáº£m giÃ¡c Ä‘Ã£ nÃ¢ng cáº¥p
  sat.laserBeam.damageCooldown = 5;
}
}
});
// Háº¿t thá»i gian thÃ¬ xÃ³a tia
if (sat.laserBeam.life <= 0) sat.laserBeam = null;
}
});
}
}

// ğŸŒ©ï¸ Ká»¹ nÄƒng SÃ©t
if (lightningActive) { // cáº­p nháº­t logic má»—i frame
  const now   = Date.now();
  const bobY  = Math.sin(frame * 0.05) * 4;        // mÃ¢y nháº¥p nhÃ´
  const cycle = (now - lightningStartTime) % 5500; // 5s báº¯n /0.5s nghá»‰
  const shoot = cycle < 5000;

  lightningBolts.forEach(bolt => {
    // Vá»‹ trÃ­ cloud luÃ´n theo player
    bolt.x = player.x + bolt.offsetX;
    bolt.y = player.y - 90 + bobY;

    // Xá»­ lÃ½ strike Ä‘Ã£ cÃ³
if (bolt.currentStrike) {
  bolt.currentStrike.life--;
  // ğŸ” Cáº­p nháº­t path Ä‘á»ƒ luÃ´n báº¯t Ä‘áº§u tá»« vá»‹ trÃ­ bolt hiá»‡n táº¡i
  const target = bolt.currentStrike.target;
  if (target && target.active) {
    bolt.currentStrike.path = getZigZag({x: bolt.x, y: bolt.y + 8}, target, 8);
  }
  if (bolt.currentStrike.life <= 0) bolt.currentStrike = null;
}
    // Báº¯n má»›i
    if (shoot && now - bolt.lastShot >= 1000) {
      const target = zombies
        .filter(z => z.active && distance(bolt, z) < 360) // chá»‰ báº¯n zombie trong bÃ¡n kÃ­nh 360
        .sort((a,b)=>distance(bolt,a)-distance(bolt,b))[0];

      if (target) {
        bolt.lastShot = now;
        dealDamageToZombie(target, bolt.damage);
        explosions.push(getExplosion(target.x, target.y)); // hiá»‡u á»©ng ná»•

        // Táº¡o Ä‘Æ°á»ng zig-zag
        bolt.currentStrike = {
          path: getZigZag({x: bolt.x, y: bolt.y+8}, target, 8),
          life: 60, // 1s tá»“n táº¡i
          target: target // lÆ°u zombie Ä‘á»ƒ cáº­p nháº­t
        };
      }
    }
  });
}
blackHoles = blackHoles.filter(hole => {
  if (Date.now() >= hole.endTime) return false; // háº¿t thá»i gian thÃ¬ xoÃ¡
  hole.tick++;

  // ğŸ§² HÃºt zombie xung quanh vÃ o há»‘ Ä‘en
  zombies.forEach(z => {
    if (!z.active) return;
    const d = distance(hole, z);
    if (d < hole.radius) {
      const angle = Math.atan2(hole.y - z.y, hole.x - z.x);
      z.x += Math.cos(angle) * hole.pullSpeed;
      z.y += Math.sin(angle) * hole.pullSpeed;

      // ğŸ’¥ GÃ¢y sÃ¡t thÆ°Æ¡ng má»—i 30 frame (giá»¯ nguyÃªn)
      if (hole.tick % 30 === 0) {
        dealDamageToZombie(z, hole.damage);
      }
    }
  });

  // ğŸ§² HÃºt Ä‘áº¡n zombie vÃ o há»‘ Ä‘en (má»›i thÃªm)
  enemyBullets.forEach(b => {
    if (!b.active) return;
    const d = distance(hole, b);
    if (d < hole.radius) {
      const angle = Math.atan2(hole.y - b.y, hole.x - b.x);
      b.x += Math.cos(angle) * hole.pullSpeed;
      b.y += Math.sin(angle) * hole.pullSpeed;

      if (d < 20) {
        releaseEnemyBullet(b); // ğŸ’¥ XÃ³a Ä‘áº¡n náº¿u vÃ o gáº§n tÃ¢m
      }
    }
  });
// â• Di chuyá»ƒn cháº­m
hole.x += hole.dx;
hole.y += hole.dy;

// ğŸš« Giá»›i háº¡n trong báº£n Ä‘á»“
hole.x = Math.max(wallThickness, Math.min(worldWidth - wallThickness, hole.x));
hole.y = Math.max(wallThickness, Math.min(worldHeight - wallThickness, hole.y));
  // â€”â€” Spawn bá»¥i bá»‹ hÃºt â€”â€” //
  if (hole.tick % 5 === 0) {               // 60 fps â†’ 12 háº¡t/giÃ¢y
  createSuctionDust(hole.x, hole.y, hole.radius + 60);
}
  return true;
});
// ğŸ¯ Clone tá»± tÃ¬m zombie gáº§n vÃ  báº¯n
if (clonesActive) {
  // â± Háº¿t thá»i gian hoáº¡t Ä‘á»™ng â†’ xÃ³a clone
  if (Date.now() >= clonesEndTime) {
    clonesActive = false;
    clones = [];
  } else {
    clones.forEach(clone => {
      // ğŸ¯ TÃ¬m zombie gáº§n nháº¥t trong pháº¡m vi 600px
      const target = zombies.find(z => z.active && distance(clone, z) < 600);

      if (target) {
        const angle = Math.atan2(target.y - clone.y, target.x - clone.x);
        const dist = distance(clone, target);

        // ğŸ‘£ Chá»‰ di chuyá»ƒn náº¿u clone cÃ¡ch zombie > 250px
        if (dist > 250) {
          clone.x += Math.cos(angle) * clone.moveSpeed;  // tá»‘c Ä‘á»™ di chuyá»ƒn
          clone.y += Math.sin(angle) * clone.moveSpeed;
        }
        // ğŸ”« Báº¯n Ä‘áº¡n má»—i 1s náº¿u trong táº§m
        if (Date.now() - clone.lastShot >= 1000) {
          clone.lastShot = Date.now();
          const b = getBullet();
          b.x = clone.x;
          b.y = clone.y;
          b.dx = Math.cos(angle);
          b.dy = Math.sin(angle);
          b.speed = 3;                        // tá»‘c Ä‘á»™ Ä‘áº¡n
          b.active = true;
          b.customDmg = clone.baseDamage;     // sÃ¡t thÆ°Æ¡ng riÃªng clone
          b.color = "#ff66ff"; // ğŸ’œ Ä‘áº¡n clone hiá»‡n mÃ u tÃ­m
          bullets.push(b);
        }
      } else {
// ğŸ˜´ Náº¿u khÃ´ng cÃ³ zombie â†’ clone lÆ°á»£n quanh player trong pháº¡m vi 600
const distFromPlayer = distance(clone, player);
if (distFromPlayer > 600) {
  // âš ï¸ ÄÃ£ vÆ°á»£t xa 600 â†’ Ã©p quay Ä‘áº§u vÃ  kÃ©o vá» gáº§n player ngay láº­p tá»©c
  const angleBack = Math.atan2(player.y - clone.y, player.x - clone.x);
  clone.x += Math.cos(angleBack) * clone.moveSpeed * 2;
  clone.y += Math.sin(angleBack) * clone.moveSpeed * 2;

  // Cáº­p nháº­t hÆ°á»›ng di chuyá»ƒn láº¡i náº¿u cáº§n tiáº¿p tá»¥c di chuyá»ƒn tá»± do sau Ä‘Ã³
  clone.moveAngle = angleBack;
} else {
  // ğŸŒ€ Náº¿u cÃ²n trong pháº¡m vi â†’ tiáº¿p tá»¥c lÆ°á»£n tá»± do
  clone.x += Math.cos(clone.moveAngle) * clone.moveSpeed;
  clone.y += Math.sin(clone.moveAngle) * clone.moveSpeed;
}

      }

      // ğŸ§± Giá»›i háº¡n clone trong báº£n Ä‘á»“
      clone.x = Math.max(wallThickness, Math.min(worldWidth - wallThickness, clone.x));
      clone.y = Math.max(wallThickness, Math.min(worldHeight - wallThickness, clone.y));
      // âš–ï¸ Giá»¯ khoáº£ng cÃ¡ch giá»¯a 2 clone tá»‘i thiá»ƒu 20px
if (clones.length === 2) {
  const a = clones[0], b = clones[1];
  const dx = b.x - a.x;
  const dy = b.y - a.y;
  const dist = Math.sqrt(dx * dx + dy * dy);
  const minDist = 40; // khoáº£ng cÃ¡ch tá»‘i thiá»ƒu giá»¯a 2 clone

  if (dist < minDist && dist > 0.1) {
    const push = (minDist - dist) / 2;
    const angle = Math.atan2(dy, dx);
    const offsetX = Math.cos(angle) * push;
    const offsetY = Math.sin(angle) * push;

    // Ä‘áº©y nháº¹ má»—i clone ra xa nhau
    a.x -= offsetX;
    a.y -= offsetY;
    b.x += offsetX;
    b.y += offsetY;
  }
}

    });
  }
}
// === Ká»¹ nÄƒng "ğŸ©¸ Quáº£ Cáº§u Háº¥p Huyáº¿t"
if (bloodOrbActive) {
    if (Date.now() > bloodOrbEndTime) {
        bloodOrbActive = false;
        bloodOrbs = [];
        return; // Káº¿t thÃºc ká»¹ nÄƒng ngay khi háº¿t thá»i gian
    }

    bloodOrbs.forEach(o => {
        o.angle += 0.01; // Tá»‘c Ä‘á»™ xoay quanh player
        o.x = player.x + Math.cos(o.angle) * o.radius;
        o.y = player.y + Math.sin(o.angle) * o.radius;

        // TÃ¬m zombie gáº§n nháº¥t trong bÃ¡n kÃ­nh 300
        let nearest = null;
        let nearestDist = Infinity;
        zombies.forEach(z => {
            if (!z.active) return;
            const d = distance(o, z);
            if (d < 300 && d < nearestDist) {
                nearest = z;
                nearestDist = d;
            }
        });

        if (nearest !== o.target) {
            o.target = nearest;
            o.lockTime = Date.now();
        }

        if (!o.target) return;

        // Chá»‰ hÃºt mÃ¡u sau khi lock má»¥c tiÃªu 0.4 giÃ¢y
        if (Date.now() - o.lockTime > 400 && Date.now() - bloodOrbLastDrain > 300) {
            bloodOrbLastDrain = Date.now();
            const skill = activeSkills.find(s => s.name === "Quáº£ cáº§u háº¥p huyáº¿t");
            dealDamageToZombie(o.target, skill?.baseDamage || 1);
            player.hearts++;
            showWarning("â¤ï¸ HÃºt mÃ¡u +1");
            // Trong update Blood Orb má»—i láº§n hÃºt mÃ¡u:
for (let i = 0; i < 2; i++) {
    createBloodOrbParticle(o);
}
// Trong hÃºt mÃ¡u Blood Orb:
for (let i = 0; i < 2; i++) {
    createBloodOrbParticleOnBeam(o);
}
}
});
}
updateParticles();

updatePet();   // ğŸ° xá»­ lÃ½ pet má»—i frame

zombies = zombies.filter(z => z.active);

  updateUI();
  updateStatsOverlay();
  updateEnemyBullets();
}
// === ğŸŒ MINI MAP ===
// ToÃ n báº£n Ä‘á»“ rá»™ng 3000 x 2000 (cÃ³ thá»ƒ Ä‘iá»u chá»‰nh)
const worldWidth = 3000;
const worldHeight = 2000;
const wallThickness = 10; // Äá»™ dÃ y tÆ°á»ng viá»n báº£n Ä‘á»“
const miniMapCanvas = document.getElementById("miniMap");
const miniCtx = miniMapCanvas.getContext("2d");
let showMiniMap = false; //false Ä‘á»ƒ áº©n ban Ä‘áº§u

// Báº¯t phÃ­m M Ä‘á»ƒ báº­t/táº¯t
document.addEventListener("keydown", (e) => {
  if (e.key.toLowerCase() === "m") {
    showMiniMap = !showMiniMap;
    miniMapCanvas.style.display = showMiniMap ? "block" : "none";
  }
  // âŒ¨ï¸ áº¨n/hiá»‡n menu UI khi báº¥m phÃ­m C
  if (e.key.toLowerCase() === "c") {
    uiVisible = !uiVisible;
    const ui = document.getElementById("ui");
    ui.style.display = uiVisible ? "flex" : "none";
}
});

// HÃ m váº½ mini map
function drawMiniMap() {
  if (!showMiniMap) return;

  miniCtx.clearRect(0, 0, miniMapCanvas.width, miniMapCanvas.height);

  const scaleX = miniMapCanvas.width / worldWidth;
  const scaleY = miniMapCanvas.height / worldHeight;
 // ğŸ‘‡ má»›i thÃªm â€“ dá»… chá»‰nh kÃ­ch thÆ°á»›c sau nÃ y
  const ITEM_SIZE   = 1.2;   // chiá»u rá»™ng/ cao dáº¥u váº­t pháº©m (px trÃªn minimap)
  const ZOMBIE_SIZE = 2;     // zombie thÆ°á»ng (Ã´ vuÃ´ng)
  const DOT_PLAYER  = 3;     // bÃ¡n kÃ­nh cháº¥m player & boss/mini
  // Draw items (energy, mana, hp)
  for (let it of items) {
    if (!it.active) continue;
    switch (it.type) {
      case "energy": miniCtx.fillStyle = "yellow"; break; // MÃ u vÃ ng cho nÄƒng lÆ°á»£ng
      case "mana": miniCtx.fillStyle = "cyan"; break; // MÃ u xanh lam cho mana
      case "hp": miniCtx.fillStyle = "lime"; break; // MÃ u xanh lÃ¡ cÃ¢y cho HP
      case "box": miniCtx.fillStyle = "blue"; break; // MÃ u xanh dÆ°Æ¡ng cho há»™p
      default: miniCtx.fillStyle = "gray";
    }
    miniCtx.fillRect(it.x * scaleX - 0.5, it.y * scaleY - 0.5, 1, 1); // Váº½ kÃ­ch thÆ°á»›c váº­t pháº©m trÃªn minimap
  }
// ğŸ’œ Váº½ clone trÃªn minimap
clones.forEach(clone => {
  const mapX = (clone.x / worldWidth) * miniMapCanvas.width;
  const mapY = (clone.y / worldHeight) * miniMapCanvas.height;
  miniCtx.fillStyle = "#cc66ff";
  miniCtx.beginPath();
  miniCtx.arc(mapX, mapY, 2, 0, Math.PI * 2);
  miniCtx.fill();
});
// ğŸŸ¦ Váº½ mÃ¡y bay trÃªn minimap
activePlanes.forEach(plane => {
  const mapX = (plane.x / worldWidth) * miniMapCanvas.width;
  const mapY = (plane.y / worldHeight) * miniMapCanvas.height;
  miniCtx.fillStyle = "#cc66ff";
  miniCtx.beginPath();
  miniCtx.arc(mapX, mapY, 2, 0, Math.PI * 2);
  miniCtx.fill();
});
  // Draw zombies
for (let z of zombies) {
  if (!z.active) continue;

  const mapX = (z.x / worldWidth) * miniMapCanvas.width;
  const mapY = (z.y / worldHeight) * miniMapCanvas.height;

  if (z.isBigBoss) {
    // ğŸ’š BigBoss â€“ to nháº¥t, mÃ u rÃµ rÃ ng khÃ¡c háº³n
    miniCtx.fillStyle = "purple";
    miniCtx.beginPath();
    miniCtx.arc(mapX, mapY, 3, 0, Math.PI * 2);
    miniCtx.fill();
  } 
  else if (z.isBoss) {
    // ğŸ”´ Boss thÆ°á»ng â€“ mÃ u Ä‘á» hoáº·c cam, tuá»³ báº¡n
    miniCtx.fillStyle = "orange";
    miniCtx.beginPath();
    miniCtx.arc(mapX, mapY, 2, 0, Math.PI * 2);
    miniCtx.fill();
  } 
  else if (z.type === "miniBoss") {
    // ğŸŸ  MiniBoss â€“ khÃ¡c boss thÆ°á»ng chÃºt
    miniCtx.fillStyle = "gold";
    miniCtx.beginPath();
    miniCtx.arc(mapX, mapY, 1.5, 0, Math.PI * 2);
    miniCtx.fill();
  } 
  else {
    // ğŸ”² Zombie thÆ°á»ng â€“ vuÃ´ng nhá»
    miniCtx.fillStyle = "red";
    miniCtx.fillRect(mapX - 1, mapY - 1, 2, 2);
  }
}
  // Draw player
  miniCtx.fillStyle = "#00ccff";  // Xanh dÆ°Æ¡ng Ä‘á»“ng bá»™ tÃªn
  miniCtx.beginPath();
  miniCtx.arc(player.x * scaleX, player.y * scaleY, 2, 0, Math.PI * 2);
  miniCtx.fill();
  /* â€” cháº¥m pet Thá» mÃ u há»“ng â€” */
if (petRabbit && petActive) {
  miniCtx.fillStyle = "#ff4dc4";          // há»“ng Ä‘áº­m
  miniCtx.beginPath();
  miniCtx.arc(petRabbit.x * scaleX, petRabbit.y * scaleY, 2, 0, Math.PI * 2);
  miniCtx.fill();
}
}
// ğŸ¨ Váº½ Ä‘Æ°á»ng chÃ©o sá»c (diagonal stripes) trÃªn canvas
function drawDiagonalStripes(ctx, x, y, width, height, stripeColor = "#666", spacing = 10) {
  ctx.save();
  ctx.beginPath();
  ctx.rect(x, y, width, height);
  ctx.clip();

  ctx.strokeStyle = stripeColor;
  ctx.lineWidth = 1; // Äá»™ dÃ y Ä‘Æ°á»ng sá»c

  const maxLength = width + height;
  for (let i = -height; i < maxLength; i += spacing) {
    ctx.beginPath();
    ctx.moveTo(x + i, y);
    ctx.lineTo(x + i - height, y + height);
    ctx.stroke();
  }

  ctx.restore();
}
function drawBloodOrb(ctx) {
    if (!bloodOrbActive) return;
    bloodOrbs.forEach(o => {
        ctx.save();
        ctx.translate(o.x, o.y);

        // Quáº£ cáº§u tá»± xoay quanh chÃ­nh nÃ³
        ctx.rotate(frame / 100);

        // === Váº½ cÃ¡c gai dÃ i ===
        ctx.shadowBlur = 6;         // ThÃªm blur cho cÃ¡c gai
        ctx.shadowColor = "red";
        for (let i = 0; i < 12; i++) {
            const angle = (Math.PI * 2 / 12) * i;
            const x = Math.cos(angle) * 24; // Gai dÃ i hÆ¡n háº³n
            const y = Math.sin(angle) * 24;
            ctx.beginPath();
            ctx.moveTo(0, 0);
            ctx.lineTo(x, y);
            ctx.strokeStyle = "rgba(50, 0, 0, 0.7)";
            ctx.lineWidth = 2;
            ctx.stroke();
        }

        // === Váº½ vÃ²ng trÃ²n ngoÃ i tá»‘i, viá»n Ä‘á» bÃ³ng ===
        ctx.beginPath();
        ctx.arc(0, 0, 16, 0, Math.PI * 2);
        ctx.fillStyle = "rgba(60, 0, 0, 0.9)";
        ctx.strokeStyle = "rgba(255,0,0,0.7)";
        ctx.lineWidth = 2;
        ctx.fill();
        ctx.stroke();

        // === Váº½ vÃ²ng trÃ²n trong Ä‘á» nháº¡t, trong suá»‘t hÆ¡n ===
        ctx.beginPath();
        ctx.arc(0, 0, 10, 0, Math.PI * 2);
        ctx.fillStyle = "rgba(255, 80, 80, 0.05)"; // ğŸ“ Äá» ráº¥t nháº¡t, trong suá»‘t
        ctx.fill();
        ctx.restore();

        // === Icon ğŸ©¸ chÃ­nh giá»¯a ===
        ctx.font = "1rem Arial";
        ctx.textAlign = "center";
        ctx.textBaseline = "middle";
        ctx.fillStyle = "white";
        ctx.fillText("ğŸ©¸", o.x, o.y);

        // === Beam nhá»‹p tim ===
        if (!o.target) return;
        const z = o.target;
        ctx.beginPath();
        ctx.moveTo(o.x, o.y);
        const segments = 16;
        for (let i = 0; i <= segments; i++) {
            const t = i / segments;
            const x = o.x + (z.x - o.x) * t;
            const y = o.y + (z.y - o.y) * t + Math.sin(t * 6 * Math.PI + frame / 8) * 5;
            ctx.lineTo(x, y);
        }
        ctx.strokeStyle = "rgba(255,0,0,0.6)";
        ctx.lineWidth = 2;
        ctx.shadowBlur = 4;
        ctx.shadowColor = "red";
        ctx.stroke();
        ctx.shadowBlur = 0;
    });
}
function createBloodOrbParticleOnBeam(orb) {
    if (!orb.target) return;

    // Random vá»‹ trÃ­ dá»c theo beam tá»« quáº£ cáº§u tá»›i zombie
    const t = Math.random(); // Tá»« 0 Ä‘áº¿n 1
    const x = orb.x + (orb.target.x - orb.x) * t;
    const y = orb.y + (orb.target.y - orb.y) * t;

    const dx = orb.x - x;
    const dy = orb.y - y;
    const speed = 0.5 + Math.random() * 0.5;

    particles.push({
        x: x,
        y: y,
        vx: dx * 0.02 * speed,
        vy: dy * 0.02 * speed,
        alpha: 1,
        size: 1 + Math.random() * 1,
        color: 'rgba(255, 0, 0, 0.6)',
        fastFade: true // ÄÃ¡nh dáº¥u háº¡t tan nhanh
    });
}

// Táº¡o 1 háº¡t nhá» bay ngÆ°á»£c vÃ o quáº£ cáº§u má»—i khi hÃºt mÃ¡u
function createBloodOrbParticle(orb) {
  createSuctionDust(orb.x, orb.y, 40, "rgba(255,0,0,0.6)", true);
}
/**
 * Sinh 1 háº¡t bá»¥i bay vÃ o (cx, cy)
 * @param {number} cx, cy   â€“ toáº¡ Ä‘á»™ tÃ¢m cáº§n hÃºt
 * @param {number} spread   â€“ khoáº£ng Ä‘áº·t háº¡t (máº·c Ä‘á»‹nh 250-300 px)
 * @param {string} color    â€“ mÃ u/Ä‘á»™ má» háº¡t
 * @param {boolean} fast    â€“ tan nhanh (dÃ¹ng cho tia mÃ¡u)
 */
function createSuctionDust(cx, cy, spread = 250,
                           color = "rgba(200,200,200,0.5)",
                           fast = false) {
  const a      = Math.random() * Math.PI * 2;
  const r      = spread + Math.random() * 50;
  const px     = cx + Math.cos(a) * r;
  const py     = cy + Math.sin(a) * r;
  const speed  = 0.02;

  particles.push({
    x : px,          y : py,
    vx: (cx - px) * speed,
    vy: (cy - py) * speed,
    size  : 1 + Math.random() * 2,
    alpha : 1,
    color ,
    fastFade: fast
  });
}
// Update vá»‹ trÃ­ háº¡t, giáº£m dáº§n alpha Ä‘á»ƒ biáº¿n máº¥t
function updateParticles() {
    particles.forEach(p => {
        p.x += p.vx;
        p.y += p.vy;
        // Háº¡t hÃºt mÃ¡u tan nhanh, háº¡t khÃ¡c tan cháº­m
        if (p.fastFade) {
            p.alpha -= 0.006; // tan cá»±c nhanh
        } else {
            p.alpha -= 0.0006; // tan mÆ°á»£t mÆ°á»£t ~5s
        }
    });
    particles = particles.filter(p => p.alpha > 0);
}
// Váº½ háº¡t mÃ¡u bay vá» quáº£ cáº§u
function drawParticles(ctx) {
    particles.forEach(p => {
        ctx.globalAlpha = p.alpha;
        ctx.fillStyle = p.color;
        ctx.beginPath();
        ctx.arc(p.x, p.y, p.size, 0, Math.PI * 2);
        ctx.fill();
        ctx.globalAlpha = 1;
    });
}
function updateDayNight() {
    const now = Date.now();
    const deltaTime = (now - lastUpdateTime) / 1000;
    lastUpdateTime = now;

    dayTime += deltaTime / dayDuration;
    if (dayTime >= 1) {
        dayTime -= 1; // Reset vá» 0 liÃªn tá»¥c
    }
    // LÆ°u láº¡i Ä‘á»ƒ chá»— khÃ¡c dÃ¹ng
    globalDeltaTime = deltaTime;
}

function drawBackgroundByTime(ctx) {
    const w = canvas.width;
    const h = canvas.height;

    // ğŸ•’ TÃ­nh giá» 0 - 23
    const hour = Math.floor(dayTime * 24) % 24;

    // ğŸŒ— XÃ¡c Ä‘á»‹nh Ä‘á»™ tá»‘i / sÃ¡ng theo thá»±c táº¿
    let darkness = 0;

    if (hour >= 0 && hour < 4) {
        darkness = 0.6;
    } else if (hour >= 4 && hour < 6) {
        darkness = (6 - hour) / 2 * 0.6; // tá»« 0.6 -> 0
    } else if (hour >= 6 && hour < 11) {
        darkness = 0;
    } else if (hour >= 11 && hour < 13) {
        darkness = -0.2; // sÃ¡ng hÆ¡n bÃ¬nh thÆ°á»ng
    } else if (hour >= 13 && hour < 17) {
        darkness = 0;
    } else if (hour >= 17 && hour < 19) {
        darkness = (hour - 17) / 2 * 0.4; // tá»« 0 -> 0.4
    } else if (hour >= 19 && hour <= 23) {
        darkness = 0.6;
    }

    // ğŸŒ“ Phá»§ tá»‘i hoáº·c lÃ m sÃ¡ng hÆ¡n
    if (darkness > 0) {
        ctx.fillStyle = `rgba(0, 0, 0, ${darkness})`;
        ctx.fillRect(0, 0, w, h);
    } else if (darkness < 0) {
        ctx.fillStyle = `rgba(255, 255, 255, ${-darkness})`;
        ctx.fillRect(0, 0, w, h);
    }

    // â˜€ï¸ / ğŸŒ™ Váº½ biá»ƒu tÆ°á»£ng bÃ¡o ngÃ y / Ä‘Ãªm
    const iconX = 30;
    const iconY = 100;

    if (hour >= 6 && hour < 18) {
        ctx.beginPath();
        ctx.arc(iconX, iconY, 14, 0, Math.PI * 2);
        ctx.fillStyle = '#FFD966';
        ctx.fill();
        ctx.strokeStyle = '#CC9900';
        ctx.stroke();
    } else {
        ctx.beginPath();
        ctx.arc(iconX, iconY, 12, 0, Math.PI * 2);
        ctx.fillStyle = `rgba(200, 200, 255, 0.8)`;
        ctx.fill();
        ctx.beginPath();
        ctx.arc(iconX - 4, iconY - 2, 10, 0, Math.PI * 2);
        ctx.fillStyle = `rgba(0,0,0,0.6)`;
        ctx.fill();
    }

    // ğŸ•’ Sá»‘ giá» 0-23
    ctx.fillStyle = '#fff';
    ctx.font = '12px Arial';
    ctx.textAlign = 'left';
    ctx.textBaseline = 'middle';
    ctx.fillText(`${hour}`, iconX + 20, iconY);
}
const balloonColors = ['#f87171', '#fbbf24', '#34d399', '#60a5fa', '#c084fc'];
function randomizeBackground() {
    backgroundStars = [];
    backgroundBirds = [];
    backgroundTrees = [];
    backgroundClouds = [];
    backgroundPlanes = [];
    backgroundMushrooms = [];
    backgroundRocks = [];
    backgroundBalloons = [];
    backgroundSeeds = [];
    backgroundBigStars = [];

const bigStarCount = isNight() ? 10 : 3;
for (let i = 0; i < bigStarCount; i++) {
    backgroundBigStars.push([
        Math.random() * worldWidth,
        Math.random() * (worldHeight / 2)
    ]);
}
    // â­ NgÃ´i sao nhá», tráº£i dÃ i ná»­a trÃªn map
const starCount = isNight() ? 300 : 50; // Ban Ä‘Ãªm nhiá»u hÆ¡n, ban ngÃ y Ã­t hÆ¡n
for (let i = 0; i < starCount; i++) {
    backgroundStars.push([
        Math.random() * worldWidth,
        Math.random() * (worldHeight / 2)
    ]);
}
    // ğŸ•Šï¸ Chim, bay á»Ÿ cao trung bÃ¬nh
    for (let i = 0; i < 15; i++) {
        backgroundBirds.push([
            Math.random() * worldWidth,
            50 + Math.random() * 100
        ]);
    }

    // ğŸŒ³ CÃ¢y phÃ­a xa dÆ°á»›i máº·t Ä‘áº¥t
    for (let i = 0; i < 50; i++) {
        backgroundTrees.push([
            Math.random() * worldWidth,
            worldHeight - 150 + Math.random() * 20
        ]);
    }

    // â˜ï¸ MÃ¢y Ä‘Æ¡n giáº£n phÃ­a trÃªn cÃ¢y
for (let i = 0; i < 5; i++) {
    backgroundClouds.push({
        x: Math.random() * worldWidth,
        y: worldHeight - 250 - Math.random() * 200,
        size: 0.5 + Math.random() * 1.5,
        speed: 0.05 + Math.random() * 0.1,
        isDark: Math.random() < 0.2 // 20% lÃ  mÃ¢y xÃ¡m
    });
}
    // âœˆï¸ ğŸ›©ï¸MÃ¡y bay Ä‘Æ¡n giáº£n phÃ­a trÃªn mÃ¢y
const planeIcons = ['âœˆï¸', 'ğŸ›©ï¸', 'ğŸš€'];
// NhÃ³m 1: Dá»c rÃ¬a trÃ¡i world map
for (let i = 0; i < 3; i++) {
    backgroundPlanes.push({
        x: -200 - Math.random() * 200,  // rÃ¬a trÃ¡i ngoÃ i map
        y: worldHeight / 2 + Math.random() * (worldHeight / 2), // giá»¯a xuá»‘ng dÆ°á»›i
        vx: 0.5 + Math.random() * 0.3,
        vy: -0.3 - Math.random() * 0.2,
        size: 0.8 + Math.random() * 1.5,
        opacity: 0.4 + Math.random() * 0.5,
        icon: planeIcons[Math.floor(Math.random() * planeIcons.length)]
    });
}
// NhÃ³m 2: Tráº£i dÃ i phÃ­a dÆ°á»›i toÃ n báº£n Ä‘á»“
for (let i = 0; i < 3; i++) {
    backgroundPlanes.push({
        x: Math.random() * worldWidth,
        y: worldHeight - 100 - Math.random() * 100,
        vx: 0.5 + Math.random() * 0.3,
        vy: -0.3 - Math.random() * 0.2,
        size: 0.8 + Math.random() * 1.5,
        opacity: 0.4 + Math.random() * 0.5,
        icon: planeIcons[Math.floor(Math.random() * planeIcons.length)]
    });
}
    // ğŸ„ Náº¥m dÆ°á»›i Ä‘áº¥t
    for (let i = 0; i < 30; i++) {
        backgroundMushrooms.push([
            Math.random() * worldWidth,
            worldHeight - 70 + Math.random() * 10
        ]);
    }

    // ğŸª¨ ÄÃ¡ nhá» dÆ°á»›i Ä‘áº¥t
    for (let i = 0; i < 30; i++) {
        backgroundRocks.push([
            Math.random() * worldWidth,
            worldHeight - 70 + Math.random() * 10
        ]);
    }

    // ğŸˆ BÃ³ng bay mÃ u ngáº«u nhiÃªn giá»¯a map
for (let i = 0; i < 10; i++) {
    backgroundBalloons.push({
        x: Math.random() * worldWidth,
        y: worldHeight - 300 - Math.random() * 100,
        vx: -0.05 + Math.random() * 0.1, // bay nháº¹ trÃ¡i/pháº£i
        speed: 0.15 + Math.random() * 0.1, // bay lÃªn cháº­m
        color: balloonColors[Math.floor(Math.random() * balloonColors.length)]
    });
}
    // ğŸŒ¼ Hoa bá»“ cÃ´ng anh xuáº¥t hiá»‡n tháº¥p, bay lÃªn cao
for (let i = 0; i < 35; i++) {
    backgroundSeeds.push({
        x: Math.random() * worldWidth,
        y: worldHeight - 300 - Math.random() * 100,
        vx: -0.1 + Math.random() * 0.2, // ngáº«u nhiÃªn tá»« -0.1 (trÃ¡i) -> +0.1 (pháº£i)
        speed: 0.02 + Math.random() * 0.05
    });
}
}
function drawCuteCloud(ctx, x, y, scale = 1, isDark = false) {
    ctx.save();
    ctx.translate(x, y);
    ctx.scale(scale, scale);
    const gradient = ctx.createLinearGradient(0, -20, 0, 20);
    if (isDark) {
        gradient.addColorStop(0, 'rgba(150, 150, 150, 0.5)');
        gradient.addColorStop(1, 'rgba(100, 100, 100, 0.4)');
    } else {
        gradient.addColorStop(0, 'rgba(255, 255, 255, 0.9)');
        gradient.addColorStop(1, 'rgba(230, 230, 230, 0.7)');
    }
    ctx.fillStyle = gradient;
    ctx.beginPath();
    ctx.arc(-30, 0, 20, Math.PI * 0.5, Math.PI * 1.5);
    ctx.arc(0, -20, 35, Math.PI, 0);
    ctx.arc(30, 0, 20, Math.PI * 1.5, Math.PI * 0.5);
    ctx.closePath();
    ctx.shadowColor = 'rgba(0,0,0,0.1)';
    ctx.shadowBlur = 10;
    ctx.shadowOffsetY = 4;
    ctx.fill();
    ctx.restore();
}
if (prevIsNight !== isNight()) {
    randomizeBackground();
    prevIsNight = isNight();
}

function isNight() {
    const hour = Math.floor(dayTime * 24) % 24;
    return hour >= 19 || hour < 6;
}
// HÃ¬nh ná»n
function drawBackground() {
    // ===== Báº¦U TRá»œI =====
    const skyGradient = ctx.createLinearGradient(0, 0, 0, canvas.height);
    skyGradient.addColorStop(0, '#0f172a');
    skyGradient.addColorStop(0.6, '#1e3a8a');
    skyGradient.addColorStop(1, '#60a5fa');
    ctx.fillStyle = skyGradient;
    ctx.fillRect(0, 0, canvas.width, canvas.height);

// ===== SAO NHá» =====
backgroundStars.forEach(([x, y], index) => {
    const flicker = (Math.sin(performance.now() / 1000 + index) + 1) / 2; // 0 ~ 1 cháº­m, nháº¥p nhÃ¡y nháº¹
    const alpha = isNight() ? 0.5 + flicker * 0.5 : 0.1; // ÄÃªm sÃ¡ng 0.5-1, ngÃ y má» nháº¹
    ctx.fillStyle = `rgba(255, 255, 255, ${alpha})`;
    ctx.fillRect(x - camera.x, y - camera.y, 1, 1);
});

// ===== SAO Lá»šN =====
backgroundBigStars.forEach(([x, y], index) => {
    const flicker = (Math.sin(performance.now() / 1500 + index) + 1) / 2; // cháº­m hÆ¡n sao nhá»
    const alpha = isNight() ? 0.7 + flicker * 0.3 : 0.1;
    ctx.fillStyle = `rgba(255, 214, 64, ${alpha})`; // MÃ u vÃ ng nháº¡t giá»‘ng sao tháº­t

    ctx.fillRect(x - 2 - camera.x, y - camera.y, 4, 1);
    ctx.fillRect(x - camera.x, y - 2 - camera.y, 1, 4);
});

    // ===== CHIM =====
    ctx.strokeStyle = 'rgba(255,255,255,0.35)';
    ctx.beginPath();
    backgroundBirds.forEach(([x, y]) => {
        ctx.moveTo(x - camera.x, y - camera.y);
        ctx.lineTo(x + 4 - camera.x, y - 3 - camera.y);
        ctx.lineTo(x + 8 - camera.x, y - camera.y);
    });
    ctx.stroke();

    // ===== CÃ‚Y XA =====
    ctx.fillStyle = '#14532d';
    backgroundTrees.forEach(([x, y]) => {
        ctx.fillRect(x - camera.x, y - camera.y, 4, 40);
        ctx.beginPath();
        ctx.arc(x + 2 - camera.x, y - 10 - camera.y, 10, 0, Math.PI * 2);
        ctx.fill();
    });

    // ===== CÃ‚Y Lá»šN =====
    ctx.fillStyle = '#14532d';
    ctx.fillRect(120 - camera.x, worldHeight - 180 - camera.y, 10, 100);
    ctx.beginPath();
    ctx.arc(125 - camera.x, worldHeight - 180 - camera.y, 30, 0, Math.PI * 2);
    ctx.fill();
    for (let i = 0; i < 3; i++) {
        let x = 160 + i * 20;
        ctx.fillRect(x - camera.x, worldHeight - 130 - camera.y, 5, 50);
        ctx.beginPath();
        ctx.arc(x + 2.5 - camera.x, worldHeight - 130 - camera.y, 10, 0, Math.PI * 2);
        ctx.fill();
    }

    // ===== MÃ‚Y CUTE =====
backgroundClouds.forEach((cloud) => {
    cloud.x += cloud.speed;
    if (cloud.x - camera.x > canvas.width + 150) {
        cloud.x = camera.x - 200;
    }
    drawCuteCloud(ctx, cloud.x - camera.x, cloud.y - camera.y, cloud.size, cloud.isDark);
});
    // ===== MÃY BAY =====
backgroundPlanes.forEach(plane => {
    plane.x += plane.vx;
    plane.y += plane.vy;

    if (plane.x > worldWidth + 300 || plane.y < camera.y - 300) {
        if (Math.random() < 0.5) {
            // Reset kiá»ƒu dá»c rÃ¬a trÃ¡i
            plane.x = -200 - Math.random() * 200;
            plane.y = worldHeight / 2 + Math.random() * (worldHeight / 2);
        } else {
            // Reset kiá»ƒu dÆ°á»›i map tráº£i ngang
            plane.x = Math.random() * worldWidth;
            plane.y = worldHeight - 100 - Math.random() * 100;
        }
        plane.vx = 0.5 + Math.random() * 0.3;
        plane.vy = -0.3 - Math.random() * 0.2;
    }

    const posX = plane.x - camera.x;
    const posY = plane.y - camera.y;

    ctx.save();
    ctx.globalAlpha = plane.opacity;
    ctx.font = `${18 * plane.size}px Arial`;
    ctx.fillText(plane.icon, posX, posY);
    ctx.restore();
});
    // ===== Cá» =====
    ctx.fillStyle = '#16a34a';
    ctx.beginPath();
    ctx.moveTo(0 - camera.x, worldHeight - 80 - camera.y);
    for (let i = 0; i <= worldWidth; i += 30) {
        ctx.lineTo(i + 15 - camera.x, worldHeight - 100 + (i % 60 ? -10 : 10) - camera.y);
    }
    ctx.lineTo(worldWidth - camera.x, worldHeight - 80 - camera.y);
    ctx.lineTo(worldWidth - camera.x, worldHeight - camera.y);
    ctx.lineTo(0 - camera.x, worldHeight - camera.y);
    ctx.closePath();
    ctx.fill();

    // ===== Äáº¤T =====
    ctx.fillStyle = '#fbd38d';
    ctx.fillRect(0 - camera.x, worldHeight - 80 - camera.y, worldWidth, 40);
    ctx.fillStyle = '#d97706';
    ctx.fillRect(0 - camera.x, worldHeight - 40 - camera.y, worldWidth, 4);

    // ===== Náº¤M =====
    backgroundMushrooms.forEach(([x, y]) => {
        ctx.fillStyle = '#b91c1c';
        ctx.beginPath();
        ctx.arc(x - camera.x, y - camera.y, 4, 0, Math.PI);
        ctx.fill();
        ctx.fillStyle = '#92400e';
        ctx.fillRect(x - 1 - camera.x, y - camera.y, 2, 5);
    });

    // ===== ÄÃ =====
    ctx.fillStyle = '#444';
    backgroundRocks.forEach(([x, y]) => {
        ctx.beginPath();
        ctx.ellipse(x - camera.x, y - camera.y, 3, 2, 0, 0, Math.PI * 2);
        ctx.fill();
    });

    // ===== BÃ“NG BAY =====
backgroundBalloons.forEach(balloon => {
    balloon.x += balloon.vx;
    balloon.y -= balloon.speed;

    // Khi bay quÃ¡ cao so vá»›i camera thÃ¬ reset vá» dÆ°á»›i tháº¥p
    if (balloon.y < camera.y + 100) {
        balloon.x = Math.random() * worldWidth;
        balloon.y = worldHeight - 300 - Math.random() * 100;
        balloon.vx = -0.05 + Math.random() * 0.1;
        balloon.speed = 0.15 + Math.random() * 0.1;
    }

    // Váº½ dÃ¢y nhá»
    ctx.strokeStyle = 'rgba(0,0,0,0.5)';
    ctx.beginPath();
    ctx.moveTo(balloon.x - camera.x, balloon.y + 20 - camera.y);
    ctx.lineTo(balloon.x - camera.x, balloon.y + 30 - camera.y);
    ctx.stroke();

    // Váº½ bÃ³ng bay
    ctx.fillStyle = balloon.color;
    ctx.beginPath();
    ctx.ellipse(balloon.x - camera.x, balloon.y - camera.y, 10, 15, 0, 0, Math.PI * 2);
    ctx.fill();

    // Hiá»‡u á»©ng sÃ¡ng nháº¹
    ctx.fillStyle = 'rgba(255,255,255,0.5)';
    ctx.beginPath();
    ctx.ellipse(balloon.x - 4 - camera.x, balloon.y - 6 - camera.y, 2, 4, 0, 0, Math.PI * 2);
    ctx.fill();
});
    // ===== HOA Bá»’ CÃ”NG ANH =====
    ctx.strokeStyle = 'rgba(255,255,255,0.7)';
    ctx.lineWidth = 0.5;
    backgroundSeeds.forEach((seed) => {
        seed.x += seed.vx;
        seed.y -= seed.speed;

        if (seed.y < camera.y + 100) {
            seed.x = Math.random() * worldWidth;
            seed.y = worldHeight - 300 - Math.random() * 100;
            seed.vx = -0.1 + Math.random() * 0.2;
            seed.speed = 0.02 + Math.random() * 0.05;
        }

        let posX = seed.x - camera.x;
        let posY = seed.y - camera.y;

        ctx.beginPath();
        ctx.moveTo(posX, posY);
        ctx.lineTo(posX, posY + 6);
        ctx.stroke();

        ctx.beginPath();
        for (let i = 0; i < 8; i++) {
            let angle = (Math.PI * 2 / 8) * i;
            let endX = posX + Math.cos(angle) * 4;
            let endY = posY + Math.sin(angle) * 2;
            ctx.moveTo(posX, posY);
            ctx.lineTo(endX, endY);
        }
        ctx.stroke();
    });
}

//ğŸ¨ 9. Váº½ khung hÃ¬nh (draw canvas)
function draw() {
  ctx.clearRect(0, 0, canvas.width, canvas.height);
  updateDayNight();
  drawBackground();
  drawBackgroundByTime(ctx);
  ctx.save();
  ctx.translate(-camera.x, -camera.y); // dá»‹ch toÃ n bá»™ há»‡ tá»a Ä‘á»™ theo camera

// ğŸ§± Váº½ tÆ°á»ng dÃ y cÃ³ sá»c chÃ©o
ctx.fillStyle = "#123"; // ná»n tá»‘i
ctx.fillRect(0, 0, worldWidth, wallThickness); // TrÃªn
ctx.fillRect(0, worldHeight - wallThickness, worldWidth, wallThickness); // DÆ°á»›i
ctx.fillRect(0, 0, wallThickness, worldHeight); // TrÃ¡i
ctx.fillRect(worldWidth - wallThickness, 0, wallThickness, worldHeight); // Pháº£i

// ğŸ¨ Váº½ sá»c chÃ©o lÃªn tá»«ng cáº¡nh
drawDiagonalStripes(ctx, 0, 0, worldWidth, wallThickness); // TrÃªn
drawDiagonalStripes(ctx, 0, worldHeight - wallThickness, worldWidth, wallThickness); // DÆ°á»›i
drawDiagonalStripes(ctx, 0, 0, wallThickness, worldHeight); // TrÃ¡i
drawDiagonalStripes(ctx, worldWidth - wallThickness, 0, wallThickness, worldHeight); // Pháº£i

// ğŸ¯ Váº½ tÃªn ngÆ°á»i chÆ¡i trÃªn Ä‘áº§u
ctx.font = "1rem sans-serif";
ctx.fillStyle = "#00ccff"; // ğŸ’™ MÃ u xanh dÆ°Æ¡ng
ctx.shadowColor = "#00ccff";
ctx.shadowBlur = 8;
ctx.textAlign = "center";
ctx.textBaseline = "bottom";
ctx.fillText(player.name, player.x, player.y - player.size - 4); // Váº½ tÃªn trÃªn Ä‘áº§u player
ctx.shadowBlur = 0; // reset sau khi váº½
ctx.shadowColor = "transparent";
// Váº½ hÃ¬nh trÃ²n player
if (disguiseActive) {
  // ğŸ¸ Váº½ áº¿ch thay cho player
  ctx.save();
  ctx.font = "2rem serif";
  ctx.textAlign = "center";
  ctx.textBaseline = "middle";
  ctx.shadowColor = "lime";
  ctx.shadowBlur = 8;
  ctx.globalAlpha = 0.6;
  ctx.fillStyle = "white";
  ctx.fillText("ğŸ¸", player.x, player.y);
  ctx.restore();
} else {
  // ğŸ§ Váº½ player bÃ¬nh thÆ°á»ng
  ctx.beginPath();
  ctx.arc(player.x, player.y, player.size, 0, Math.PI * 2);

  if (levelUpGlowTime > 0) {
    ctx.shadowBlur = 4;
    ctx.shadowColor = "gold";
    ctx.fillStyle = "gold";
  } else {
    ctx.shadowBlur = 0;
    ctx.shadowColor = "transparent";
    ctx.fillStyle = (player.hitTimer % 10 < 5) ? "#ff4c4c" : "#00ff00";
  }

  ctx.fill();
  ctx.lineWidth = 2.2;
  ctx.strokeStyle = "rgba(0, 255, 255, 0.4)";
  ctx.shadowColor = "rgba(0, 255, 255, 0.25)";
  ctx.stroke();
}
// ğŸ­ Váº½ cÃ¡c áº£o áº£nh phÃ¢n thÃ¢n
clones.forEach((c,i) => {
  ctx.save();
  ctx.beginPath();
  ctx.arc(c.x, c.y, player.size * 0.75, 0, Math.PI * 2);
  ctx.fillStyle = "rgba(255, 255, 255, 0.4)";
  ctx.shadowBlur = 8;
  ctx.shadowColor = "#aaaaff";
  ctx.fill();
  ctx.lineWidth = 1.5;
  ctx.strokeStyle = "rgba(0,255,255,0.6)";
  ctx.stroke();
  ctx.restore();

  // ğŸ‘ï¸ Máº¯t cá»§a clone
  ctx.beginPath();
  ctx.arc(c.x - 3, c.y - 5, 1.5, 0, Math.PI * 2);
  ctx.arc(c.x + 3, c.y - 5, 1.5, 0, Math.PI * 2);
  ctx.fillStyle = "white";
  ctx.fill();
// ğŸ‘„ Miá»‡ng clone
  ctx.beginPath();
  ctx.arc(c.x, c.y + 4, 5, 0, Math.PI); // ná»­a cung trÃ²n hÆ°á»›ng lÃªn (miá»‡ng cÆ°á»i)
  ctx.strokeStyle = "rgba(0, 100, 200, 0.6)";
  ctx.lineWidth = 1.2;
  ctx.stroke();
   // ğŸ·ï¸ TÃªn clone (Clone 1, 2, ...)
  ctx.font = "bold 12px Segoe UI";
  ctx.fillStyle = "#00ccff"; // MÃ u xanh dÆ°Æ¡ng
  ctx.textAlign = "center";
  ctx.fillText(`Clone ${i + 1}`, c.x, c.y - 22);
});

  bullets.forEach(b => {
  if (!b.active) return; // ğŸ›¡ bá» qua Ä‘áº¡n Ä‘Ã£ bá»‹ gá»¡
ctx.save();
ctx.translate(b.x, b.y);
if (b.piercing) {
  b.rotation = (b.rotation || 0) + 0.3;
  ctx.rotate(b.rotation);
  ctx.fillStyle = b.color || "cyan";
  ctx.beginPath();
  ctx.moveTo(-6, -3); // Váº½ Ä‘áº¡n zigzag
  ctx.lineTo(6, 0);
  ctx.lineTo(-6, 3);
  ctx.closePath();
  ctx.shadowBlur = 4; // ThÃªm hiá»‡u á»©ng phÃ¡t sÃ¡ng
  ctx.shadowColor = b.color || "cyan";
  ctx.fill();
} else {
  ctx.beginPath();
  ctx.arc(0, 0, 5, 0, Math.PI * 2); // Váº½ hÃ¬nh trÃ²n Ä‘áº¡n
  ctx.fillStyle = b.color || "yellow";
  //ctx.shadowBlur = 8;
  //ctx.shadowColor = b.color || "yellow"; // hiá»‡u á»©ng sÃ¡ng cÃ¹ng mÃ u
  ctx.fill();
}
ctx.restore();
});

// ğŸ”« Váº½ Ä‘áº¡n tá»« boss & mini boss
enemyBullets.forEach(b => {
  ctx.beginPath();
  ctx.arc(b.x, b.y, 5, 0, Math.PI * 2);
  ctx.fillStyle = "red";
  ctx.fill();
});
// Váº½ bigboss
function drawBigBoss(ctx, x, y, radius, hp) {
    ctx.save();
    ctx.translate(x, y);

    // Ãnh sÃ¡ng ná»n
    ctx.beginPath();
    ctx.arc(0, 0, radius + 20, 0, Math.PI * 2);
    ctx.fillStyle = "#150d25";
    ctx.shadowColor = "#a445f5";
    ctx.shadowBlur = 50;
    ctx.fill();
    ctx.shadowBlur = 0;

    // Tay trÃ¡i
    ctx.beginPath();
    ctx.moveTo(-radius * 0.55, -radius * 0.1);
    ctx.quadraticCurveTo(-radius, 0, -radius * 0.9, radius * 0.3);
    ctx.quadraticCurveTo(-radius * 0.8, radius * 0.1, -radius * 0.5, 0);
    ctx.closePath();
    ctx.fillStyle = "#4e2d6d";
    ctx.fill();

    // Tay pháº£i
    ctx.beginPath();
    ctx.moveTo(radius * 0.55, -radius * 0.1);
    ctx.quadraticCurveTo(radius, 0, radius * 0.9, radius * 0.3);
    ctx.quadraticCurveTo(radius * 0.8, radius * 0.1, radius * 0.5, 0);
    ctx.closePath();
    ctx.fill();

    // ChÃ¢n trÃ¡i (dÃ i hÆ¡n)
    ctx.beginPath();
    ctx.moveTo(-20, radius * 0.4);
    ctx.lineTo(-30, radius * 0.8);
    ctx.lineTo(-10, radius * 0.8);
    ctx.lineTo(0, radius * 0.4);
    ctx.closePath();
    ctx.fill();

    // ChÃ¢n pháº£i (dÃ i hÆ¡n)
    ctx.beginPath();
    ctx.moveTo(20, radius * 0.4);
    ctx.lineTo(30, radius * 0.8);
    ctx.lineTo(10, radius * 0.8);
    ctx.lineTo(0, radius * 0.4);
    ctx.closePath();
    ctx.fill();

    // CÆ¡ thá»ƒ
    ctx.beginPath();
    ctx.moveTo(-radius * 0.6, -radius * 0.1);
    ctx.bezierCurveTo(-radius * 0.75, radius * 0.3, -30, radius * 0.6, 0, radius * 0.5);
    ctx.bezierCurveTo(30, radius * 0.6, radius * 0.75, radius * 0.3, radius * 0.6, -radius * 0.1);
    ctx.closePath();
    ctx.fillStyle = "#4e2d6d";
    ctx.fill();

    // Bá»¥ng rÃ¡ch
    ctx.beginPath();
    ctx.moveTo(-15, 20);
    ctx.lineTo(0, 30);
    ctx.lineTo(15, 20);
    ctx.lineTo(0, 40);
    ctx.closePath();
    ctx.fillStyle = "#8b1f1f";
    ctx.fill();

    // Äáº§u
    ctx.beginPath();
    ctx.ellipse(0, -radius * 0.35, 45, 60, 0, 0, Math.PI * 2);
    ctx.fillStyle = "#6f3c9c";
    ctx.fill();
    ctx.strokeStyle = "#26142e";
    ctx.lineWidth = 3;
    ctx.stroke();

    // Máº¯t Ä‘á» glow
    function eye(x, y) {
        ctx.beginPath();
        ctx.arc(x, y, 8, 0, Math.PI * 2);
        ctx.fillStyle = "#ff3333";
        ctx.shadowColor = "#ff0000";
        ctx.shadowBlur = 20;
        ctx.fill();
        ctx.shadowBlur = 0;
    }
    eye(-18, -radius * 0.4);
    eye(18, -radius * 0.4);

    // LÃ´ng mÃ y
    ctx.strokeStyle = "#2e163a";
    ctx.lineWidth = 3;
    ctx.beginPath();
    ctx.moveTo(-28, -radius * 0.47);
    ctx.lineTo(-8, -radius * 0.5);
    ctx.stroke();
    ctx.beginPath();
    ctx.moveTo(28, -radius * 0.47);
    ctx.lineTo(8, -radius * 0.5);
    ctx.stroke();

    // TÃ³c
    ctx.beginPath();
    ctx.arc(0, -radius * 0.6, 30, Math.PI, 0);
    ctx.fillStyle = "#1e0f2a";
    ctx.fill();

    // MÅ©i
    ctx.beginPath();
    ctx.moveTo(-5, -radius * 0.2);
    ctx.lineTo(0, -radius * 0.15);
    ctx.lineTo(5, -radius * 0.2);
    ctx.fillStyle = "#3a1f4d";
    ctx.fill();

    // Miá»‡ng Ä‘en + rÄƒng nanh Ä‘en
    ctx.beginPath();
    ctx.moveTo(-18, -radius * 0.1);
    ctx.quadraticCurveTo(0, 0, 18, -radius * 0.1);
    ctx.quadraticCurveTo(0, 10, -18, -radius * 0.1);
    ctx.closePath();
    ctx.fillStyle = "#120000";
    ctx.fill();

    // RÄƒng nanh Ä‘en nhá»
    ctx.fillStyle = "#120000";
    function fang(x, y, h, flip = 1) {
        ctx.beginPath();
        ctx.moveTo(x, y);
        ctx.lineTo(x + 3 * flip, y + h);
        ctx.lineTo(x - 3 * flip, y + h);
        ctx.closePath();
        ctx.fill();
    }
    fang(-8, -radius * 0.1 + 5, 6);
    fang(8, -radius * 0.1 + 5, 6);

    // Váº¿t ná»©t Ä‘áº§u
    ctx.beginPath();
    ctx.moveTo(-10, -radius * 0.6);
    ctx.lineTo(-5, -radius * 0.5);
    ctx.lineTo(-15, -radius * 0.4);
    ctx.lineTo(-5, -radius * 0.3);
    ctx.strokeStyle = "#4b2b60";
    ctx.lineWidth = 2;
    ctx.stroke();

    // Sáº¹o máº·t
    ctx.beginPath();
    ctx.moveTo(22, -8);
    ctx.lineTo(18, 3);
    ctx.lineTo(28, 6);
    ctx.strokeStyle = "#8a477e";
    ctx.stroke();

    // Sáº¹o ngá»±c
    ctx.beginPath();
    ctx.moveTo(-18, 28);
    ctx.lineTo(-8, 38);
    ctx.lineTo(-22, 48);
    ctx.stroke();

    // GiÃ¡p vai
    ctx.fillStyle = "#2b2b2b";
    ctx.beginPath();
    ctx.moveTo(-55, -5);
    ctx.quadraticCurveTo(-90, 10, -70, 35);
    ctx.quadraticCurveTo(-40, 20, -35, 25);
    ctx.closePath();
    ctx.fill();

    ctx.beginPath();
    ctx.moveTo(55, -5);
    ctx.quadraticCurveTo(90, 10, 70, 35);
    ctx.quadraticCurveTo(40, 20, 35, 25);
    ctx.closePath();
    ctx.fill();

    // Sá»«ng vá»¡
    function horn(x, y, flip = 1) {
        ctx.beginPath();
        ctx.moveTo(x, y);
        ctx.bezierCurveTo(x + 15 * flip, y - 35, x + 25 * flip, y - 55, x + 10 * flip, y);
        ctx.lineTo(x + 4 * flip, y);
        ctx.closePath();
        ctx.fillStyle = "#444";
        ctx.fill();
        ctx.strokeStyle = "#222";
        ctx.stroke();
    }
    horn(-30, -radius * 0.6, -1);
    horn(30, -radius * 0.6, 1);

    // BIG + HP
    ctx.font = `${radius * 0.3}px sans-serif`;
    ctx.fillStyle = "violet";
    ctx.textAlign = "center";
    ctx.strokeStyle = "#bb99ff";
    ctx.lineWidth = 2;
    ctx.strokeText(`BIG ${hp}`, 0, -radius - 30);
    ctx.fillText(`BIG ${hp}`, 0, -radius - 30);

    ctx.restore();
}
// Váº½ toÃ n bá»™ zombie hoáº¡t Ä‘á»™ng kÃ¨m icon, HP, tráº¡ng thÃ¡i, biá»ƒu cáº£m (tá»‘i Æ°u fillText)
zombies.forEach(z => {
  if (!z.active) return;
  // ğŸ†• Váº½ BigBoss giá»‘ng Boss nhÆ°ng riÃªng block Ä‘á»ƒ dá»… quáº£n lÃ½
if (z.isBigBoss) {
    drawBigBoss(ctx, z.x, z.y, z.radius, z.hp);
    return;
}
  ctx.save();

// âœ¨ Glow cho Boss hoáº·c MiniBoss
  if (z.isBoss || z.type === "miniBoss") {
    ctx.shadowColor = z.color || "#ffffff";
    ctx.shadowBlur = z.isBoss ? 4 : 2;
  } else {
    ctx.shadowColor = "transparent";
    ctx.shadowBlur = 0;
  }

// ğŸ¯ Váº½ hÃ¬nh trÃ²n zombie
  ctx.beginPath();
  ctx.arc(z.x, z.y, z.radius, 0, Math.PI * 2);
  ctx.fillStyle = z.color || "#ff69b4";
  ctx.fill();
  ctx.restore();

// === ğŸ†• fillText gá»™p toÃ n bá»™ thÃ´ng tin ===
ctx.save();

// ğŸ§  Font chung
ctx.fillStyle = "#fff";
ctx.textAlign = "center";
ctx.textBaseline = "middle";

// ğŸ…°ï¸ Váº½ cáº¥p + HP trÃªn Ä‘áº§u zombie
let levelChar = "";
if (z.isBoss) levelChar = "SS";
else if (z.type === "miniBoss") levelChar = "S";
else levelChar = String.fromCharCode(96 + (z.level || 1));

// âœ¨ Giáº£m kÃ­ch thÆ°á»›c font náº¿u lÃ  boss hoáº·c mini boss
let levelFontSize = z.radius * 0.9; // máº·c Ä‘á»‹nh cho zombie thÆ°á»ng
if (z.type === "miniBoss") levelFontSize = z.radius * 0.6;
if (z.isBoss) levelFontSize = z.radius * 0.5;

ctx.font = `${levelFontSize}px sans-serif`;
ctx.textAlign = "center";
ctx.textBaseline = "middle"; // Vá»‹ trÃ­ icon zombie
ctx.fillStyle = z.color || "#fff";
ctx.fillText(`${levelChar}-${z.hp}`, z.x, z.y - z.radius - 8); // Chá»¯ trÃªn Ä‘áº§u zombie

// ğŸ§Ÿ Váº½ icon zombie á»Ÿ giá»¯a thÃ¢n
ctx.font = `${z.radius * 1.5}px sans-serif`;
const iconChar = z.isBoss ? "ğŸ’€" : "ğŸ§Ÿ";
ctx.fillText(iconChar, z.x, z.y);

// ğŸ˜´ Tráº¡ng thÃ¡i (chá»‰ zombie thÆ°á»ng & cÃ³ icon)
// ğŸ¯ Hiá»ƒn thá»‹ icon hÃ nh vi: ğŸ˜¡ khi chasing, ğŸ˜–/ğŸ’¤Zzz khi wandering (30%)
let behaviorIcon = null;
// Boss sáº½ khÃ´ng cÃ³ icon tráº¡ng thÃ¡i
if (!z.isBoss && z.state === "chasing" && z.showStatusIcon) {
  behaviorIcon = "ğŸ˜¡";
} else if (!z.isBoss && z.type !== "miniBoss" && z.state === "wandering") {
  const isSleeping = z.wanderBehavior === "pause";

  // ğŸ’¤ Äang lang thang & Ä‘á»©ng im
  if (isSleeping && isNight()) {
    behaviorIcon = "ğŸ’¤"; // ğŸ’¯ luÃ´n hiá»ƒn thá»‹ khi ban Ä‘Ãªm
  } else if (z.showStatusIcon) {
    behaviorIcon = isSleeping ? "ğŸ’¤" : "ğŸ˜–"; // NgÃ y thÆ°á»ng theo 30%
  }
}

if (behaviorIcon) {
  ctx.font = `${z.radius}px sans-serif`;
  ctx.textAlign = "left";
  ctx.textBaseline = "top";
  ctx.fillStyle = "#fff";
  ctx.fillText(behaviorIcon, z.x + z.radius * 0.6, z.y - z.radius * 1.2);
}
ctx.restore();

  // ğŸ’¬ Biá»ƒu cáº£m (chá»‰ zombie thÆ°á»ng má»›i cÃ³)
  if (!z.isBoss && z.iconToDraw) {
    ctx.save();
    ctx.font = `${z.radius * 1.2}px serif`;
    ctx.textAlign = "left";
    ctx.textBaseline = "middle";
    ctx.fillStyle = "#fff";
    ctx.shadowColor = "#000";
    ctx.shadowBlur = 4;
ctx.font = `${z.radius}px sans-serif`;
ctx.textAlign = "left";
ctx.textBaseline = "top";
ctx.fillStyle = "#fff";
ctx.fillText(z.iconToDraw, z.x + z.radius * 0.6, z.y - z.radius * 1.2);
    ctx.restore();
}
});
// Máº¯t vÃ  miá»‡ng xoay theo hÆ°á»›ng zombie gáº§n nháº¥t
if (zombies.length > 0) {
  const target = zombies.reduce((a, b) => distance(a, player) < distance(b, player) ? a : b);
  const angle = Math.atan2(target.y - player.y, target.x - player.x);
  const eyeOffsetX = Math.cos(angle) * 6;
  const eyeOffsetY = Math.sin(angle) * 6;
  const mouthOffsetX = Math.cos(angle) * 10;
  const mouthOffsetY = Math.sin(angle) * 10;

// Máº¯t trÃ¡i
  ctx.beginPath();
  ctx.arc(player.x + eyeOffsetX - 4, player.y + eyeOffsetY - 4, 2, 0, Math.PI * 2);
  ctx.fillStyle = "white";
  ctx.fill();

// Máº¯t pháº£i
  ctx.beginPath();
  ctx.arc(player.x + eyeOffsetX + 4, player.y + eyeOffsetY - 4, 2, 0, Math.PI * 2);
  ctx.fill();

// Miá»‡ng
  ctx.beginPath();
  ctx.arc(player.x + mouthOffsetX, player.y + mouthOffsetY + 3, 2, 0, Math.PI);
  ctx.strokeStyle = "white";
  ctx.lineWidth = 1;
  ctx.stroke();
}
// Váº½ lá»›p khiÃªn náº¿u Ä‘ang hoáº¡t Ä‘á»™ng
function drawHex3D(ctx, x, y, size) {
  const gradient = ctx.createRadialGradient(x, y, size * 0.3, x, y, size);
  gradient.addColorStop(0, "rgba(0,255,255,0.25)");
  gradient.addColorStop(1, "rgba(0,200,255,0.05)");

  ctx.beginPath();
  for (let i = 0; i < 6; i++) {
    const angle = Math.PI / 3 * i;
    const px = x + size * Math.cos(angle);
    const py = y + size * Math.sin(angle);
    if (i === 0) ctx.moveTo(px, py);
    else ctx.lineTo(px, py);
  }
  ctx.closePath();
  ctx.fillStyle = gradient;
  ctx.strokeStyle = "rgba(0,255,255,0.1)";
  ctx.lineWidth = 0.8;
  ctx.fill();
  ctx.stroke();
}

if (player.shieldActive) {
// VÃ²ng trÃ²n ngoÃ i cÃ¹ng
  const pulse = Math.sin(Date.now() / 200) * 2;
  ctx.save();
  ctx.globalAlpha = 0.6;
  ctx.beginPath();
  ctx.arc(player.x, player.y, 48 + pulse, 0, Math.PI * 2);
  ctx.strokeStyle = "rgba(0,200,255,0.7)";
  ctx.lineWidth = 4;
  ctx.shadowColor = "#00eaff";
  ctx.shadowBlur = 10;
  ctx.stroke();
  ctx.restore();

// Váº½ máº¡ng lÆ°á»›i lá»¥c giÃ¡c Ä‘á»u trong khiÃªn
const hexSize = 10;
const spacingX = hexSize * Math.sqrt(3);
const spacingY = hexSize * 1.5;
const radius = 45;
const angleOffset = Date.now() / 3000; // GÃ³c xoay theo thá»i gian

for (let row = -5; row <= 5; row++) {
  for (let col = -5; col <= 5; col++) {
    const offsetX = (row % 2 === 0) ? 0 : spacingX / 2;
    const x0 = col * spacingX + offsetX;
    const y0 = row * spacingY;

    const dx = x0;
    const dy = y0;
    const dist = Math.sqrt(dx * dx + dy * dy);

    if (dist < radius) {
// ğŸ‘‰ Xoay Ä‘iá»ƒm quanh tÃ¢m player
      const angle = angleOffset;
      const rotatedX = dx * Math.cos(angle) - dy * Math.sin(angle);
      const rotatedY = dx * Math.sin(angle) + dy * Math.cos(angle);
      const px = player.x + rotatedX;
      const py = player.y + rotatedY;
      drawHex3D(ctx, px, py, hexSize);
}
}
}
}

// Váº½ vá»‡ tinh laze ğŸ›°ï¸
satellites.forEach(sat => {
  ctx.save();
  ctx.translate(sat.x, sat.y);
  ctx.shadowBlur = 10;
  ctx.shadowColor = "cyan";
  ctx.fillStyle = "white";
  ctx.font = "1.2rem serif";
  ctx.textAlign = "center";
  ctx.textBaseline = "middle";
  ctx.fillText("ğŸ›°ï¸", 0, 0);
  ctx.restore();
});

explosions.forEach(e => {
  ctx.beginPath();
  ctx.arc(e.x, e.y, e.radius, 0, Math.PI * 2);
  ctx.fillStyle = `rgba(255, 200, 0, ${e.life / 20})`;
  ctx.fill();
});
// Váº½ tia laze cho tá»«ng vá»‡ tinh
satellites.forEach(sat => {
  if (sat.laserBeam && sat.laserBeam.life > 0) {
    const x1 = sat.x, y1 = sat.y;
    const angle = sat.laserBeam.angle;
    const x2 = x1 + Math.cos(angle) * 500;
    const y2 = y1 + Math.sin(angle) * 500;

    ctx.save();
    ctx.beginPath();
    ctx.moveTo(x1, y1);
    ctx.lineTo(x2, y2);
    ctx.strokeStyle = "rgba(0, 255, 255, 0.8)";
    ctx.lineWidth = 3;
    ctx.shadowColor = "cyan";
    ctx.shadowBlur = 12;
    ctx.stroke();
    ctx.restore();
  }
});
if (ufoActive) {
    ufos.forEach(ufo => {
    ufo.x += ufo.speed;

// Náº¿u Ä‘i háº¿t trÃ¡i mÃ n hÃ¬nh â†’ vÃ²ng láº¡i bÃªn pháº£i
    if (ufo.x < -100) {
      ufo.x = canvas.width + 100;
      ufo.y = 300 + (Math.random() * 150 - 150); // VÃ²ng láº¡i trÃªn cao
}

// Báº¯n laze má»—i 1s
    if (Date.now() - ufo.laserCooldown > 1000) {
      ufo.laserCooldown = Date.now();
      ufo.laserLife = 60;

// TÃ¬m má»¥c tiÃªu gáº§n nháº¥t
      const origin = { x: ufo.x, y: ufo.y };
      const target = zombies.find(z => z.active && distance(origin, z) < 300);
if (target) {
        const angle = Math.atan2(target.y - ufo.y, target.x - ufo.x);
        ufo.angle = angle;

// GÃ¢y sÃ¡t thÆ°Æ¡ng xuyÃªn
    zombies.forEach(z => {
if (!z.active) return;
    const dx = Math.cos(angle), dy = Math.sin(angle);
    const proj = (z.x - ufo.x) * dx + (z.y - ufo.y) * dy;
    const perp = Math.abs((z.x - ufo.x) * dy - (z.y - ufo.y) * dx);
// Náº¿u zombie náº±m gáº§n Ä‘Æ°á»ng báº¯n vÃ  trong khoáº£ng báº¯n
if (proj > 0 && proj < 1200 && perp < 20) {
    dealDamageToZombie(z, ufo.damage);
}
});
}
}
if (ufo.laserLife > 0) ufo.laserLife--;
});
}
ufos.forEach(ufo => {
  // UFO icon
  ctx.save();
  ctx.translate(ufo.x, ufo.y);
  ctx.shadowBlur = 10;
  ctx.shadowColor = "red";
  ctx.fillStyle = "white";
  ctx.font = "1.4rem serif";
  ctx.textAlign = "center";
  ctx.textBaseline = "middle";
  ctx.fillText("ğŸ›¸", 0, 0);
  ctx.restore();

  // Tia laze Ä‘á»
  if (ufo.laserLife > 0) {
    const x1 = ufo.x;
    const y1 = ufo.y;
const laserLength = 1200; // hoáº·c 1000 náº¿u báº¡n muá»‘n xuyÃªn toÃ n báº£n Ä‘á»“
const x2 = x1 + Math.cos(ufo.angle) * laserLength;
const y2 = y1 + Math.sin(ufo.angle) * laserLength;

    ctx.save();
    ctx.beginPath();
    ctx.moveTo(x1, y1);
    ctx.lineTo(x2, y2);
    ctx.strokeStyle = "rgba(255, 0, 0, 0.8)";
    ctx.lineWidth = 3;
    ctx.shadowColor = "red";
    ctx.shadowBlur = 15;
    ctx.stroke();
    ctx.restore();
  }
});
extraShockwaves.forEach(sw => {
  ctx.save();
  ctx.beginPath();
  ctx.arc(sw.x, sw.y, sw.radius, 0, Math.PI * 2);
  ctx.strokeStyle = sw.color;
  ctx.globalAlpha = sw.alpha;
  ctx.lineWidth = 3;
  ctx.shadowColor = sw.color;
  ctx.shadowBlur = 12;
  ctx.stroke();
  ctx.restore();
});

drawItems();
drawEffects();

// ğŸ¨ Váº½ váº­t pháº©m hiá»‡n cÃ³ trÃªn mÃ n hÃ¬nh
function drawItems() {
  items.forEach(it => {
    if (!it.active) return;
    ctx.save();

// CÃ i Ä‘áº·t font chá»¯ vÃ  cÄƒn chá»‰nh cho váº­t pháº©m
    ctx.font = "0.9rem serif";
    ctx.textAlign = "center";
    ctx.textBaseline = "middle";
    let icon, color;

// Chá»n icon vÃ  mÃ u sáº¯c phÃ¹ há»£p vá»›i tá»«ng váº­t pháº©m
    switch (it.type) {
      case 'energy':
        icon = "âš¡";
        color = "gold";
        break;
      case 'mana':
        icon = "ğŸ’ ";
        color = "cyan";
        break;
      case 'hp':
        icon = "â¤ï¸";
        color = "red";
        break;
      case 'box':
        icon = "ğŸ“¦";
        color = "#fff";
        break;
}

// Táº¡o hiá»‡u á»©ng nháº¹ (bÃ³ng Ä‘á»• vÃ  chuyá»ƒn Ä‘á»™ng nháº¹ nhÃ ng)
    ctx.shadowBlur = 3;
    ctx.shadowColor = color;
    ctx.fillStyle = color;
    const bob = Math.sin(frame / 10 + it.x + it.y) * 2;
    ctx.fillText(icon, it.x, it.y + bob);
    ctx.restore();
  });
}
// ğŸŒ©ï¸ Váº½ tia sÃ©t
function drawLightningBolts() { // render mÃ¢y & tia sÃ©t
  if (!lightningActive) return;

  ctx.save();                      // â‘  báº£o toÃ n camera
  lightningBolts.forEach(bolt => {
    /* â˜ï¸ 1. Váº½ mÃ¢y */
    ctx.save();
    ctx.font = "2rem serif";
    ctx.textAlign = "center";
    ctx.textBaseline = "middle";
    ctx.fillStyle = "yellow";
    ctx.shadowColor = "gold";
    ctx.shadowBlur = 16;
    ctx.fillText("ğŸŒ©ï¸", bolt.x, bolt.y);
    ctx.restore();

    /* âš¡ 2. Váº½ Ä‘Æ°á»ng sÃ©t ngoáº±n ngoÃ¨o (náº¿u Ä‘ang tá»“n táº¡i) */
    if (bolt.currentStrike) {
      const pts = bolt.currentStrike.path;
      ctx.save();
      ctx.beginPath();
      ctx.moveTo(pts[0].x, pts[0].y);
      for (let i = 1; i < pts.length; i++) ctx.lineTo(pts[i].x, pts[i].y);
      ctx.strokeStyle = "rgba(255,255,0,0.9)";
      ctx.lineWidth = 2;
      ctx.shadowColor = "yellow";
      ctx.shadowBlur = 22;
      ctx.stroke();
      ctx.restore();
    }
  });
  ctx.restore();                   // â‘¡ khÃ´i phá»¥c camera
}
function drawBlackHole() {
  // ğŸ“¦ Lá»c ra cÃ¡c mÃ¡y bay sáº¯p bá»‹ hÃºt
  const blackHolePlanes = activePlanes.filter(p => p.x > worldWidth - 200);

  if (blackHolePlanes.length === 0) return; // âŒ KhÃ´ng cÃ³ mÃ¡y bay nÃ o gáº§n há»‘ Ä‘en thÃ¬ khÃ´ng váº½

  // ğŸ“ XÃ¡c Ä‘á»‹nh vá»‹ trÃ­ há»‘ Ä‘en dá»±a trÃªn mÃ¡y bay gáº§n nháº¥t
  const blackHoleX = worldWidth - 100;

  // ğŸ¯ TÃ­nh trung bÃ¬nh Ä‘á»™ cao cÃ¡c mÃ¡y bay Ä‘ang tá»›i gáº§n
  const blackHoleY = blackHolePlanes.reduce((sum, p) => sum + p.y, 0) / blackHolePlanes.length;

  // ğŸ”µ Hiá»‡u á»©ng phá»“ng nháº¹
  const pulse = Math.sin(Date.now() / 300);
  const radius = 40 + pulse * 5;

  // ğŸ¨ Váº½ há»‘ Ä‘en
  ctx.save();
  ctx.beginPath();
  ctx.arc(blackHoleX, blackHoleY, radius, 0, Math.PI * 2);
  ctx.fillStyle = "black";
  ctx.shadowColor = "purple";
  ctx.shadowBlur = 20;
  ctx.fill();
  ctx.restore();
}
if (petRabbit && petActive) {
  const { x, y, radius } = petRabbit;

  /* â€” thÃ¢n â€” */
  ctx.beginPath();
  ctx.arc(x, y, radius, 0, Math.PI * 2);
  ctx.fillStyle   = "#fff0fa";   // thÃ¢n tráº¯ng-há»“ng
  ctx.fill();
  ctx.strokeStyle = "#ff7ad9";   // viá»n há»“ng nháº¡t
  ctx.lineWidth   = 2;
  ctx.stroke();

  /* â€” tai â€” */
  ctx.beginPath();
  ctx.ellipse(x - 6, y - 18, 3, 6, 0, 0, Math.PI * 2);
  ctx.ellipse(x + 6, y - 18, 3, 6, 0, 0, Math.PI * 2);
  ctx.fill();
  ctx.stroke();

  /* â€” máº¯t â€” */
  ctx.beginPath();
  ctx.arc(x - 4, y - 3, 1.5, 0, Math.PI * 2);
  ctx.arc(x + 4, y - 3, 1.5, 0, Math.PI * 2);
  ctx.fillStyle = "#000";
  ctx.fill();

  /* â€” miá»‡ng â€” */
  ctx.beginPath();
  ctx.arc(x, y + 4, 2, 0, Math.PI);
  ctx.strokeStyle = "#000";
  ctx.stroke();

  /* â€” tÃªn â€œThá»â€ â€” */
  ctx.font         = "0.8rem sans-serif";
  ctx.fillStyle    = "#ff7ad9";   // cÃ¹ng mÃ u viá»n
  ctx.shadowColor  = "#ff7ad9";
  ctx.shadowBlur   = 8;
  ctx.textAlign    = "center";
  ctx.textBaseline = "bottom";
  ctx.fillText("Thá»", x, y - radius - 10);
  ctx.shadowBlur   = 0;
  ctx.shadowColor  = "transparent";
}
drawParticles(ctx);

drawBloodOrb(ctx);
drawBlackHole();
drawLightningBolts(); // ğŸŒ©ï¸ Váº½ tia sÃ©t
ctx.restore(); // káº¿t thÃºc dá»‹ch chuyá»ƒn camera
drawMiniMap();
// ğŸ¨ Váº½ báº£n Ä‘á»“ thu nhá»
}

// ğŸ¨ Váº½ táº¥t cáº£ hiá»‡u á»©ng ká»¹ nÄƒng gá»n láº¡i
function drawEffects() {
  fireballs.forEach(f => {
    ctx.save();
    ctx.translate(f.x, f.y);
    ctx.shadowBlur = 8;
    ctx.shadowColor = "orange";
    ctx.fillStyle = "orange";
    ctx.font = "1.3rem serif";
    ctx.textAlign = "center";
    ctx.textBaseline = "middle";
    ctx.fillText("ğŸ”¥", 0, 0);
    ctx.restore();
  });

  iceballs.forEach(f => {
    ctx.save();
    ctx.translate(f.x, f.y);
    ctx.shadowBlur = 10;
    ctx.shadowColor = "#00e5ff";
    ctx.fillStyle = "#00e5ff";
    ctx.font = "1.3rem serif";
// ctx.font = (f.radius * 0.9) + " serif"; Ká»¹ nÄƒng to ra khi lÃªn level
    ctx.textAlign = "center";
    ctx.textBaseline = "middle";
    ctx.fillText("â„ï¸", 0, 0);
    ctx.restore();
  });

swords.forEach(s => {
    ctx.save();
    ctx.translate(s.x, s.y);
    if (s.state === 'charging') {
  ctx.shadowBlur = 2; // Hiá»‡u á»©ng bÃ³ng má»
  ctx.shadowColor = '#00ffff';
  ctx.fillStyle = '#00ffff';
} else {
  ctx.shadowBlur = 0;
  ctx.fillStyle = 'white';
}
    ctx.font = "1.2rem serif";
//ctx.font = (s.radius * 0.9) + " serif";
    ctx.textAlign = "center";
    ctx.textBaseline = "middle";
    ctx.fillText("ğŸ”ª", 0, 0);
    ctx.restore();
  });

downwardSwords.forEach(s => {
  ctx.save();
  ctx.translate(s.x, s.y);
  ctx.shadowBlur = 10;
  ctx.shadowColor = '#00ffff';
  ctx.fillStyle = 'white';
  ctx.font = "1.2rem serif";
  ctx.textAlign = "center";
  ctx.textBaseline = "middle";
  ctx.fillText("âš”ï¸", 0, 0);
  ctx.restore();
});
// Váº½ tÃªn lá»­a
missiles.forEach(m => {
  ctx.save();
  ctx.translate(m.x, m.y);
  ctx.shadowColor = m.state === "delay" ? "gray" : "orange";
  ctx.shadowBlur = 8;
  ctx.fillStyle = "white";
  ctx.font = "1.5rem serif";
  ctx.textAlign = "center";
  ctx.textBaseline = "middle";
  ctx.fillText("ğŸš€", 0, 0);
  ctx.restore();
});
missiles = missiles.filter(m => {
  if (m.state === "delay") {
    m.delay--;
    if (m.delay <= 0) {
      m.state = "fly";
    }
    return true;
  }

  // ğŸ¯ Bay dáº«n hÆ°á»›ng tá»›i zombie má»¥c tiÃªu (bay má»m nhÆ° tÃªn lá»­a)
  if (m.target && m.target.active) {
    const desiredAngle = Math.atan2(m.target.y - m.y, m.target.x - m.x);
    const currentAngle = Math.atan2(m.dy, m.dx);

    // ğŸ” Chuyá»ƒn hÆ°á»›ng dáº§n
    const turnRate = 0.05; // ğŸ¯ Ä‘á»™ linh hoáº¡t â€“ tÄƒng náº¿u muá»‘n xoay nhanh
    let delta = desiredAngle - currentAngle;
    if (delta > Math.PI) delta -= 2 * Math.PI;
    if (delta < -Math.PI) delta += 2 * Math.PI;

    const newAngle = currentAngle + Math.sign(delta) * Math.min(turnRate, Math.abs(delta));
    const speed = 3.5; // ğŸš€ tá»‘c Ä‘á»™ tÃªn lá»­a â€“ giáº£m náº¿u muá»‘n bay cháº­m hÆ¡n

    m.dx = Math.cos(newAngle) * speed;
    m.dy = Math.sin(newAngle) * speed;
  }

  m.x += m.dx;
  m.y += m.dy;
  m.life--;

  // ğŸ’¥ Ná»• diá»‡n rá»™ng
if (m.life <= 0 || (m.target && distance(m, m.target) < 25 && m.target.active)) {
    zombies.forEach(z => {
if (z.active && distance(m, z) < 120) { // 80 lÃ  bÃ¡n kÃ­nh ná»•
    dealDamageToZombie(z, m.damage);
}
});
    explosions.push(getExplosion(m.x, m.y));
    return false;
}

if (m.life <= 0) {
    explosions.push(getExplosion(m.x, m.y));
    return false;
}

  return true;
});
// ğŸ’£ B52 Bombs + ğŸ›¬ MÃ¡y bay
ctx.save();
ctx.textAlign = "center";
ctx.textBaseline = "middle";
ctx.font = "1.5rem serif";
ctx.shadowBlur = 8;
ctx.shadowColor = "black";

// ğŸ›¬ Váº½ mÃ¡y bay Ä‘ang hoáº¡t Ä‘á»™ng
activePlanes.forEach(plane => {
  ctx.fillStyle = "cyan";
ctx.save();
  ctx.shadowBlur = 2;
  ctx.shadowColor = "cyan";
ctx.translate(plane.x, plane.y);
ctx.scale(plane.scale ?? 1, plane.scale ?? 1);
ctx.globalAlpha = plane.opacity ?? 1;
ctx.fillText("ğŸ›¬", 0, 0);
ctx.restore();
});

// ğŸ’£ Váº½ tá»«ng quáº£ bom Ä‘ang rÆ¡i hoáº·c sáº¯p ná»•
bombsB52.forEach(bomb => {
  if (bomb.exploded) return;
  ctx.fillStyle = bomb.landed ? "orange" : "white";
  ctx.fillText("ğŸ’£", bomb.x, bomb.y);
});

ctx.restore();
// â˜¢ï¸ Váº½ bom háº¡t nhÃ¢n
nuclearBombs.forEach(bomb => {
// ----------- Váº½ bom háº¡t nhÃ¢n khi chÆ°a ná»• -----------
if (!bomb.exploded) {
  let offsetX = 0, offsetY = 0;

  // ğŸ”” Náº¿u cÃ²n â‰¤ 3 giÃ¢y vÃ  Ä‘Ã£ cháº¡m Ä‘áº¥t â†’ rung láº¯c
  if (bomb.landed && bomb.timerAfterLand <= 180) {
    offsetX = (Math.random() - 0.5) * 4;
    offsetY = (Math.random() - 0.5) * 4;
  }

  ctx.save();
  // Váº½ icon bom â˜¢ï¸ to, sÃ¡ng (cÃ³ rung)
  ctx.font = "2.2rem serif";
  ctx.textAlign = "center";
  ctx.textBaseline = "middle";
  ctx.shadowBlur = 12;
  ctx.shadowColor = "orange";
  ctx.fillStyle = "white";
  ctx.fillText("â˜¢ï¸", bomb.x + offsetX, bomb.y + offsetY);

  // -- Náº¿u Ä‘Ã£ cháº¡m Ä‘áº¥t, váº½ icon ğŸ’¥ vÃ  giÃ¢y countdown náº±m ngang --
  if (bomb.landed) {
    const baseY = bomb.y - 35;
    const iconX = bomb.x - 1;
    const secX  = bomb.x + 1;

    // Váº½ icon ğŸ’¥ nhá»
    ctx.font = "1rem serif";
    ctx.shadowBlur = 2;
    ctx.textAlign = "right";
    ctx.fillStyle = "#ffb300";
    ctx.fillText("ğŸ’¥", iconX, baseY);

    // Váº½ sá»‘ giÃ¢y nhá», mÃ u Ä‘á»
    ctx.font = "1rem sans-serif";
    ctx.fillStyle = "#ff3333";
    ctx.textAlign = "left";
    let sec = Math.max(1, Math.ceil(bomb.timerAfterLand / 60));
    ctx.fillText(`${sec}`, secX, baseY - 2);
  }

  ctx.restore();
}

// ----------- Váº½ hiá»‡u á»©ng sÃ³ng xung kÃ­ch khi bom phÃ¡t ná»• -----------
if (bomb.exploded && bomb.shockwave) {
// Hiá»‡u á»©ng vÃ²ng ná»• chÃ­nh â€“ nÃ©t to, vÃ ng Ä‘áº­m rÃµ rÃ ng
  ctx.save();
  ctx.beginPath();
  ctx.arc(bomb.x, bomb.y, bomb.shockwaveRadius, 0, Math.PI * 2);
  ctx.strokeStyle = "rgba(255, 222, 44, 0.88)";   // VÃ ng tÆ°Æ¡i, gáº§n nhÆ° vÃ ng nguyÃªn cháº¥t
  ctx.lineWidth = 16;
  ctx.shadowBlur = 42;
  ctx.shadowColor = "#ffec70";
  ctx.globalAlpha = 0.58; // Äáº­m vÃ  rÃµ
  ctx.stroke();
  ctx.restore();

  // Viá»n ngoÃ i phá»¥ - vÃ ng tráº¯ng, rÃµ hÆ¡n, táº¡o cáº£m giÃ¡c â€œhÃ o quangâ€
  ctx.save();
  ctx.beginPath();
  ctx.arc(bomb.x, bomb.y, bomb.shockwaveRadius + 8, 0, Math.PI * 2);
  ctx.strokeStyle = "rgba(255,255,180,0.73)";
  ctx.lineWidth = 7;
  ctx.shadowBlur = 28;
  ctx.shadowColor = "#fffbe2";
  ctx.globalAlpha = 0.45;
  ctx.stroke();
  ctx.restore();
}
});
blackHoles.forEach(h => {
  ctx.save();
  ctx.beginPath();
  ctx.arc(h.x, h.y, h.radius, 0, Math.PI * 2);
  ctx.fillStyle = "rgba(0, 0, 0, 0.5)";
  ctx.shadowColor = "purple";
  ctx.shadowBlur = 20;
  ctx.fill();
  ctx.closePath();

  // Icon giá»¯a há»‘ Ä‘en
  ctx.font = "2rem serif";
  ctx.fillStyle = "#fff";
  ctx.textAlign = "center";
  ctx.textBaseline = "middle";
  ctx.fillText("ğŸ•³ï¸", h.x, h.y);
  ctx.restore();
});
}

//ğŸ” 10. VÃ²ng láº·p chÃ­nh vÃ  khá»Ÿi táº¡o game
let fps = 0, lastFrameTime = performance.now(), frameCount = 0, lastFpsUpdate = performance.now(); // biáº¿n cáº­p nháº­t FPS

function loop() {
  const now = performance.now();
  frameCount++;

// Cáº­p nháº­t FPS má»—i 500ms
if (now - lastFpsUpdate >= 500) {
    fps = Math.round((frameCount * 1000) / (now - lastFpsUpdate));
    const fpsText = `FPS: ${fps}`;
if (fpsText !== lastFpsText) {
  lastFpsText = fpsText;
  document.getElementById("fpsCounter").innerText = fpsText;
}
    frameCount = 0;
    lastFpsUpdate = now;
}

  update();
  draw();
  frame++;
  
if (frame % 30 === 0 && gameStarted) {
// Giá»›i háº¡n zombie tá»‘i Ä‘a lÃ  300 - Sá»‘ lÆ°á»£ng zombie hiá»‡n táº¡i
if (zombies.length < 300) {
    const spawnCount = Math.min(1, 300 - zombies.length);
    for (let i = 0; i < spawnCount; i++) {
    spawnZombie();
}
}
}
updateDayNight();

requestAnimationFrame(loop);
}

// â–¶ï¸ Khá»Ÿi cháº¡y ban Ä‘áº§u
spawnZombie();
loop();

//ğŸ§¼ 11. CÃ¡c Ä‘oáº¡n khá»Ÿi táº¡o UI sau canvas
// HÃ m báº¯t Ä‘áº§u game
function startGame() {
  spawnBigBoss(); // chá»‰ Ä‘á»ƒ test

  randomizeBackground();
  // Hiá»ƒn thá»‹ tá»•ng Ä‘iá»ƒm
  document.getElementById("highScoreDisplay").innerText = `ğŸ† Ká»· lá»¥c: ${localStorage.getItem('highScore') || 0}`;
  const nameInput = document.getElementById("playerNameInput");
  player.name = nameInput.value.trim() || "Player";
  document.getElementById("startMenu").style.display = "none";
  gameStarted = true;
  waveTimer = waveTime;
  showUpgradePopup();        // ğŸ Gá»i nÃ¢ng cáº¥p trÆ°á»›c
  pendingWave = wave;        // ğŸŒŠ Wave sáº½ hiá»ƒn thá»‹ sau khi nÃ¢ng cáº¥p xong
//Test
// ğŸš€ TÄƒng nhanh Ä‘á»ƒ test wave 20+
/* wave = 5;
  player.level = 1;
  player.score = 3000; // Äáº£m báº£o Ä‘á»§ Ä‘iá»ƒm Ä‘á»ƒ khÃ´ng bá»‹ tá»¥t cáº¥p */
//Test
}

// ğŸŒŠ Hiá»‡n popup "Wave X báº¯t Ä‘áº§u"
function showWavePopup() {
  const popup = document.getElementById("wavePopup");
  popup.innerText = `Wave ${wave} báº¯t Ä‘áº§u!`;
  popup.style.animation = "none";
  void popup.offsetWidth; // force reflow Ä‘á»ƒ reset animation
  popup.style.display = "block";
  popup.style.animation = "waveFade 1s ease-out forwards";
  setTimeout(() => {
    popup.style.display = "none";
  }, 2000); // áº©n sau 2 giÃ¢y
}

// ğŸ¯ GiÃ¡ trá»‹ theo cáº¥p Ä‘á»™ ká»¹ nÄƒng (má»—i cáº¥p tÄƒng dáº§n)
const UPGRADE_TIERS = {
  fireRate: [1, 2, 3],
  damageBoost: [0.5, 1, 1.5],
  hpBoost: [2, 3, 5],            
  bulletSpeed: [0.25, 0.5, 1]
};

// ğŸŒŸ Hiá»ƒn thá»‹ popup chá»n nÃ¢ng cáº¥p ká»¹ nÄƒng
function showUpgradePopup() {
  const popup = document.getElementById("upgradePopup");
  const container = document.getElementById("upgradeChoices");
  container.innerHTML = "";

// ğŸ“Œ Báº£ng giÃ¡ trá»‹ tÆ°Æ¡ng á»©ng vá»›i tá»«ng báº­c nÃ¢ng cáº¥p
const UPGRADE_VALUES = {
  Báº¡c:  { fireRate: 1, damageBoost: 0.5, hpBoost: 2, bulletSpeed: 0.25 },
  VÃ ng: { fireRate: 2,  damageBoost: 1,   hpBoost: 3, bulletSpeed: 0.5 },
  Kim:  { fireRate: 3,    damageBoost: 1.5, hpBoost: 5, bulletSpeed: 1 },
  Rare: { moveSpeed: 0.2 } // ğŸ‘Ÿ tá»‘c Ä‘á»™ cháº¡y â€“ báº­c hiáº¿m
};
// ğŸ– MÃ u viá»n tÆ°Æ¡ng á»©ng tá»«ng báº­c
const TIER_COLORS = {
  Báº¡c: "#aaa",
  VÃ ng: "gold",
  Kim: "#c770ff",
  Rare: "#3399ff" // ğŸ’š mÃ u xanh báº­c hiáº¿m
};
// Giá»›i háº¡n nÃ¢ng cáº¥p ká»¹ nÄƒng
const MAX_FIRE_RATE = 21; // ğŸ”« hÆ°á»›ng báº¯n
const MAX_LINE_BULLETS = 10; // ğŸ”« sá»‘ lÆ°á»£ng Ä‘áº¡n
const MAX_MOVE_SPEED = 3; // ğŸ‘Ÿ tá»‘c Ä‘á»™ di chuyá»ƒn tá»‘i Ä‘a
const MAX_BULLET_SPEED = 10; // ğŸš€ tá»‘c Ä‘á»™ Ä‘áº¡n tá»‘i Ä‘a

const allUpgrades = [];

// ğŸ”ª Äao â€“ tÄƒng sá»‘ lÆ°á»£ng (tá»‘i Ä‘a 20), sau Ä‘Ã³ tÄƒng sÃ¡t thÆ°Æ¡ng
if (skillUpgrades.bladeCount < 20) {
  const tier = randomTier();
  const value = { Báº¡c: 1, VÃ ng: 2, Kim: 3 }[tier];
  allUpgrades.push({
  name: `ğŸ”ª +${value} Ä‘ao xoay quanh`,
  tier,
  effect: () => {
skillUpgrades.bladeCount = Math.min(skillUpgrades.bladeCount + value, 20);
  showWarning(`ğŸ”ª +${value} Ä‘ao`);
  updateStatsOverlay();
}
});
} else {
  const tier = randomTier();
  const value = { Báº¡c: 0.5, VÃ ng: 1, Kim: 1.5 }[tier];
allUpgrades.push({
  name: `ğŸ”ª +${value} sÃ¡t thÆ°Æ¡ng Ä‘ao`,
  tier,
  effect: () => {
skillUpgrades.bladeDamage += value;
  showWarning(`ğŸ”ª +${value} dmg`);
  updateStatsOverlay();
}
});
}

// âš”ï¸ Kiáº¿m â€“ tÄƒng cáº¥p (tá»‘i Ä‘a 10), sau Ä‘Ã³ tÄƒng sÃ¡t thÆ°Æ¡ng
if (skillUpgrades.swordLevel < 10) {
  const tier = randomTier();
  const value = { Báº¡c: 1, VÃ ng: 2, Kim: 3 }[tier];
  allUpgrades.push({
    name: `âš”ï¸ +${value} cáº¥p mÆ°a kiáº¿m`,
    tier,
    effect: () => {
skillUpgrades.swordLevel = Math.min(skillUpgrades.swordLevel + value, 10);
      showWarning(`âš”ï¸ +${value} cáº¥p kiáº¿m`);
      updateStatsOverlay();
}
});
} else {
  const tier = randomTier();
  const value = { Báº¡c: 0.5, VÃ ng: 1, Kim: 1.5 }[tier];
  allUpgrades.push({
    name: `âš”ï¸ +${value} sÃ¡t thÆ°Æ¡ng kiáº¿m`,
    tier,
    effect: () => {
    skillUpgrades.swordDamage += value;
    showWarning(`âš”ï¸ +${value} dmg`);
    updateStatsOverlay();
}
});
}

// ğŸ”¥ Lá»­a â€“ tÄƒng sá»‘ lÆ°á»£ng (tá»‘i Ä‘a 10), sau Ä‘Ã³ tÄƒng sÃ¡t thÆ°Æ¡ng
if (skillUpgrades.fireCount < 10) {
  const tier = randomTier();
  const value = { Báº¡c: 1, VÃ ng: 2, Kim: 3 }[tier];
  allUpgrades.push({
    name: `ğŸ”¥ +${value} cáº§u lá»­a`,
    tier,
    effect: () => {
    skillUpgrades.fireCount = Math.min(skillUpgrades.fireCount + value, 10);
    showWarning(`ğŸ”¥ +${value} lá»­a`);
    updateStatsOverlay();
}
});
} else {
  const tier = randomTier();
  const value = { Báº¡c: 0.5, VÃ ng: 1, Kim: 1.5 }[tier];
  allUpgrades.push({
    name: `ğŸ”¥ +${value} sÃ¡t thÆ°Æ¡ng lá»­a`,
    tier,
    effect: () => {
    skillUpgrades.fireDamage += value;
    showWarning(`ğŸ”¥ +${value} dmg`);
    updateStatsOverlay();
}
});
}

// â„ï¸ BÄƒng â€“ tÄƒng sá»‘ lÆ°á»£ng (tá»‘i Ä‘a 10), sau Ä‘Ã³ tÄƒng sÃ¡t thÆ°Æ¡ng
if (skillUpgrades.iceCount < 10) {
  const tier = randomTier();
  const value = { Báº¡c: 1, VÃ ng: 2, Kim: 3 }[tier];
  allUpgrades.push({
    name: `â„ï¸ +${value} cáº§u bÄƒng`,
    tier,
    effect: () => {
    skillUpgrades.iceCount = Math.min(skillUpgrades.iceCount + value, 10);
    showWarning(`â„ï¸ +${value} bÄƒng`);
    updateStatsOverlay();
}
});
} else {
  const tier = randomTier();
  const value = { Báº¡c: 0.5, VÃ ng: 1, Kim: 1.5 }[tier];
  allUpgrades.push({
    name: `â„ï¸ +${value} sÃ¡t thÆ°Æ¡ng bÄƒng`,
    tier,
    effect: () => {
    skillUpgrades.iceDamage += value;
    showWarning(`â„ï¸ +${value} dmg`);
    updateStatsOverlay();
}
});
}

// ğŸ”« HÆ°á»›ng báº¯n â€“ náº¿u chÆ°a max
if (playerUpgrades.fireRate < MAX_FIRE_RATE) {
  const tier = randomTier();
  const value = UPGRADE_VALUES[tier].fireRate;
  allUpgrades.push({
    name: "ğŸ”« HÆ°á»›ng báº¯n",
    key: "fireRate",
    tier,
    value,
effect: () => {
  const added = Math.min(playerUpgrades.fireRate + value, MAX_FIRE_RATE) - playerUpgrades.fireRate;
  playerUpgrades.fireRate += added;
  showWarning(`ğŸ”« +${added} hÆ°á»›ng báº¯n`);
  updateStatsOverlay();
}
});
}

// ğŸ’¥ SÃ¡t thÆ°Æ¡ng â€“ luÃ´n cÃ³ thá»ƒ nÃ¢ng
{
  const tier = randomTier();
  const value = UPGRADE_VALUES[tier].damageBoost;
  allUpgrades.push({
    name: "ğŸ’¥ SÃ¡t thÆ°Æ¡ng",
    key: "damageBoost",
    tier,
    value,
effect: () => {
  playerUpgrades.damageBoost += value;
  showWarning(`ğŸ’¥ +${value} sÃ¡t thÆ°Æ¡ng`);
  updateStatsOverlay();
}
});
}

// â¤ï¸ MÃ¡u â€“ luÃ´n cÃ³ thá»ƒ nÃ¢ng
{
  const tier = randomTier();
  const value = UPGRADE_VALUES[tier].hpBoost;
  allUpgrades.push({
    name: "â¤ï¸ TÄƒng mÃ¡u",
    key: "hpBoost",
    tier,
    value,
    effect: () => {
      player.hearts += value;
      playerUpgrades.hpBoost += 1;
      showWarning(`â¤ï¸ +${value}`);
      updateUI();
      updateStatsOverlay();
    }
  });
}

// ğŸ’¨ Tá»‘c Ä‘á»™ Ä‘áº¡n tá»‘i Ä‘a 10
if (playerUpgrades.bulletSpeed < MAX_BULLET_SPEED) {
  const tier = randomTier();
  const value = UPGRADE_VALUES[tier].bulletSpeed;
  allUpgrades.push({
    name: "ğŸ’¨ Tá»‘c Ä‘á»™ Ä‘áº¡n",
    key: "bulletSpeed",
    tier,
    value,
    effect: () => {
      const added = Math.min(playerUpgrades.bulletSpeed + value, MAX_BULLET_SPEED) - playerUpgrades.bulletSpeed;
      playerUpgrades.bulletSpeed += added;
      showWarning(`ğŸ’¨ +${added.toFixed(1)} tá»‘c Ä‘á»™ Ä‘áº¡n`);
      updateStatsOverlay();
    }
  });
}

// ğŸ§¨ Sá»‘ lÆ°á»£ng Ä‘áº¡n â€“ náº¿u chÆ°a max
if (playerUpgrades.lineBulletCount < MAX_LINE_BULLETS) {
  const tier = randomTier();
  const value = 1;
  allUpgrades.push({
    name: "ğŸ§¨ sá»‘ lÆ°á»£ng Ä‘áº¡n",
    key: "lineBulletCount",
    tier,
    value,
    effect: () => {
      playerUpgrades.lineBulletCount += value;
      showWarning(`ğŸ§¨ +${value} viÃªn má»—i hÃ ng`);
      updateStatsOverlay();
    }
  });
}

// ğŸ‘Ÿ Tá»‘c Ä‘á»™ cháº¡y â€“ hiáº¿m vÃ  chá»‰ 1 cáº¥p (náº¿u chÆ°a max)
if (player.speed < MAX_MOVE_SPEED) {
  const value = UPGRADE_VALUES.Rare.moveSpeed;
  allUpgrades.push({
    name: "ğŸ‘Ÿ Tá»‘c Ä‘á»™ cháº¡y",
    key: "moveSpeed",
    tier: "Rare",
    value,
    effect: () => {
      player.speed = Math.min(player.speed + value, MAX_MOVE_SPEED);
      showWarning(`ğŸ‘Ÿ +${value.toFixed(1)} tá»‘c Ä‘á»™`);
      updateStatsOverlay();
    }
  });
}


// ğŸ² XÃ¡o trá»™n vÃ  chá»n ngáº«u nhiÃªn 3 nÃ¢ng cáº¥p
const choices = allUpgrades.sort(() => Math.random() - 0.5).slice(0, 3);
// ğŸ–±ï¸ Táº¡o nÃºt cho tá»«ng nÃ¢ng cáº¥p
choices.forEach(up => {
const btn = document.createElement("button");
    btn.innerText = up.name;
    btn.style.borderColor = TIER_COLORS[up.tier]; // viá»n theo báº­c
 btn.onclick = () => {
  up.effect(); // thá»±c thi nÃ¢ng cáº¥p
  popup.style.display = "none";
  isPaused = false;
  lastWaveTime = Date.now(); // â±ï¸ báº¯t Ä‘áº§u Ä‘áº¿m thá»i gian

// â³ Chá» 500ms má»›i hiá»ƒn thá»‹ wave
if (pendingWave !== null) {
    setTimeout(() => {
      showWavePopup();
      pendingWave = null;
    }, 500);
}
};
    container.appendChild(btn);
});

  popup.style.display = "block"; // hiá»ƒn thá»‹ popup
  isPaused = true; // â¸ï¸ Táº¡m dá»«ng game
  popup.style.display = "block";
}

// ğŸ² Chá»n báº­c nÃ¢ng cáº¥p ngáº«u nhiÃªn theo tá»· lá»‡
function randomTier() {
  const tiers = ["Báº¡c", "VÃ ng", "Kim"];
  const weights = [0.7, 0.25, 0.05]; // tá»· lá»‡ gáº·p: 60% Báº¡c, 30% VÃ ng, 10% Kim
  const r = Math.random();
  let sum = 0;
  for (let i = 0; i < tiers.length; i++) {
    sum += weights[i];
    if (r < sum) return tiers[i];
  }
  return "Báº¡c"; // fallback náº¿u cÃ³ lá»—i
}

// ğŸŒŸ Hiá»ƒn thá»‹ popup chá»n ká»¹ nÄƒng khi tÄƒng level
/* ========= Cáº¤U HÃŒNH ========= */
const MAX_LV = {                         // giá»›i háº¡n sá»‘-lÆ°á»£ng
  ufo        : 3,                        // UFO táº¥n cÃ´ng
  missile    : 5,                        // tÃªn lá»­a F18
  lightning  : 5,                        // tia sÃ©t diá»‡n rá»™ng
  satellite  : 2,                        // vá»‡ tinh laze
  blackhole  : 2,                        // Há»‘ Ä‘en
  bloodorb   : 2
};

/* tÃªn ngáº¯n â†’ regex nháº­n diá»‡n chuá»—i nÃ¢ng cáº¥p */
const UP_RX = {
  ufo       : /\+1 UFO/i,
  missile   : /\+1 tÃªn lá»­a/i,
  lightning : /\+1 tia sÃ©t/i,
  satellite : /\+1 vá»‡ tinh/i,
  blackhole : /\+1 há»‘ Ä‘en/i,
  bloodorb  : /\+1 quáº£ cáº§u/i
};

/* ========= TRá»¢ GIÃšP ========= */
const rand    = arr => arr[Math.random() * arr.length | 0];          // pickRandom
const shuffle = a => a.sort(() => Math.random() - .5);               // Fisherâ€“Yates 1-liner

/* kiá»ƒm tra 1 nÃ¢ng cáº¥p cÃ³ â€œháº¿t Ä‘Ã¡tâ€ chÆ°a */
function isOverLimit(upgrade){
  const key = Object.keys(UP_RX).find(k => UP_RX[k].test(upgrade.name));
  if (!key) return false;                                            // gÃ³i sÃ¡t thÆ°Æ¡ng, v.v.
  const active = activeSkills.find(s => s.name === upgrade.skillName);
  return active && (active.level || 0) >= MAX_LV[key];
}

/* ========= POPUP ========= */
function showSkillLevelUpPopup(){
  isPaused = true;                                                   // â¸ï¸

  const popup     = document.getElementById('skillPopup');
  const container = document.getElementById('skillChoices');
  container.innerHTML = '';

  /* 1ï¸âƒ£ ká»¹ nÄƒng chÆ°a há»c & nÃ¢ng cáº¥p há»£p lá»‡ */
  const unlearned = skillsData.filter(sk => !activeSkills.includes(sk));
  const upgrades  = activeSkills
      .flatMap(sk => (sk.upgrades || []).map(up => ({ ...up, skillName: sk.name })))
      .filter(up => !isOverLimit(up));                               // bá» gÃ³i max

  /* 2ï¸âƒ£ ghÃ©p pool & chá»n 3 lá»±a chá»n */
  let choices;
  if (unlearned.length){                                             // luÃ´n cÃ³ â‰¥1 skill má»›i
    const pickNew = rand(unlearned);
    const pool    = [...unlearned.filter(s => s!==pickNew), ...upgrades];
    choices = [pickNew, ...shuffle(pool).slice(0, 2)];
  } else {                                                           // Ä‘Ã£ há»c háº¿t
    const unique = {};                                               // má»—i skill 1 upgrade ngáº«u nhiÃªn
    upgrades.forEach(up => (unique[up.skillName] ||= []).push(up));
    choices = shuffle(Object.values(unique).map(rand)).slice(0, 3);
  }

  /* 3ï¸âƒ£ render nÃºt */
  choices.forEach(ch => {
    const btn = document.createElement('button');
    if (ch.icon){                                                    // ká»¹ nÄƒng má»›i
      btn.textContent = `${ch.icon} ${ch.name}`;
      btn.onclick = () => {
        learnSkill(skillsData.indexOf(ch));
        popup.style.display = 'none';
        isPaused = false;                                            // â–¶ï¸
      };
    } else {                                                         // nÃ¢ng cáº¥p
      btn.textContent = ch.name;
      btn.style.borderColor =
        {Báº¡c:'#aaa',VÃ ng:'gold',Kim:'#c770ff',Äá»:'red'}[ch.tier] || '#ccc';
      btn.onclick = () => {
        ch.effect?.();              // thá»±c thi
        showWarning(` ${ch.name}`);
        popup.style.display = 'none';
        isPaused = false;            // â–¶ï¸
      };
    }
    container.appendChild(btn);
  });

  popup.style.display = 'block';
}

// ğŸ§¾ Cáº­p nháº­t thÃ´ng tin thá»‘ng kÃª trong overlay
function updateStatsOverlay() {
  /* ğŸ‘‡ 1. TÃ­nh láº¡i tá»•ng má»—i láº§n váº½ */
  const alive  = zombies.length;      // Ä‘ang cÃ²n trÃªn báº£n Ä‘á»“
  const killed = zombieKillCount;     // Ä‘Ã£ tiÃªu diá»‡t
  const total  = alive + killed;      // tá»•ng thá»±c
document.getElementById("stat-damage").innerText =
  `ğŸ’¥ SÃ¡t thÆ°Æ¡ng: ${(playerUpgrades.damageBoost || 1).toFixed(1)}`;
  document.getElementById("stat-spawned").innerText = `ğŸ§Ÿ Tá»•ng sá»‘ zombie: ${total}`;
  document.getElementById("stat-alive").innerText   = `ğŸ§Ÿ Äang cÃ²n sá»‘ng: ${alive}`;
  document.getElementById("stat-total").innerText   = `ğŸ§Ÿ ÄÃ£ tiÃªu diá»‡t: ${killed}`;
  document.getElementById("stat-speed").innerText = `ğŸ’¨ Tá»‘c Ä‘á»™: ${playerUpgrades.bulletSpeed.toFixed(1)}`;
  document.getElementById("stat-fireRate").innerText = `ğŸ”« HÆ°á»›ng báº¯n: ${playerUpgrades.fireRate}`;
  document.getElementById("stat-lineCount").innerText = `ğŸ§¨ Sá»‘ lÆ°á»£ng Ä‘áº¡n: ${playerUpgrades.lineBulletCount}`;
  document.getElementById("stat-moveSpeed").innerText = `ğŸ‘Ÿ Tá»‘c Ä‘á»™ cháº¡y: ${player.speed.toFixed(1)}`;
  // ğŸ”ª Thá»‘ng kÃª ká»¹ nÄƒng máº·c Ä‘á»‹nh
document.getElementById("stat-blade").innerText = `ğŸ”ª Äao: ${skillUpgrades.bladeCount} Ä‘ao, ${skillUpgrades.bladeDamage.toFixed(1)} dmg`;
document.getElementById("stat-sword").innerText = `âš”ï¸ Kiáº¿m: Lv${skillUpgrades.swordLevel}, ${skillUpgrades.swordDamage.toFixed(1)} dmg`;
document.getElementById("stat-fire").innerText = `ğŸ”¥ Lá»­a: ${skillUpgrades.fireCount} lá»­a, ${skillUpgrades.fireDamage.toFixed(1)} dmg`;
document.getElementById("stat-ice").innerText = `â„ï¸ BÄƒng: ${skillUpgrades.iceCount} bÄƒng, ${skillUpgrades.iceDamage.toFixed(1)} dmg`;
// Ká»¹ nÄƒng khÃ¡c
const skillText = Object.entries(skillStats)
    .map(([key, value]) => `${key}: ${value}`)
    .join("<br>");
    document.getElementById("stat-skills").innerHTML = skillText;

// ğŸ§Ÿ Zombie theo cáº¥p: chá»‰ hiá»ƒn thá»‹ tá»« Cáº¥p 1 â†’ 10
  let breakdown = "";
  for (let i = 1; i <= 10; i++) {
    breakdown += `<div>ğŸ§Ÿ Cáº¥p ${i}: ${zombieByLevel[i] || 0}</div>`;
  }

// ğŸ’€ Thá»‘ng kÃª Mini Boss & Boss á»Ÿ cuá»‘i
  const miniBossLine = `<div>ğŸ’€ Mini Boss: ${zombieByLevel.miniBoss || 0}</div>`;
  const bossLine = `<div>ğŸ’€ Boss: ${zombieByLevel.boss || 0}</div>`;
  const bigBossLine = `<div>ğŸ’€ BigBoss: ${zombieByLevel.bigBoss || 0}</div>`;
  document.getElementById("stat-breakdown").innerHTML =
  breakdown + miniBossLine + bossLine + bigBossLine;
}
const activeSkills = [];

// Ká»¹ nÄƒng máº«u
const skillsData = [
  {
    name: "KhiÃªn báº£o vá»‡",
    icon: "ğŸ›¡ï¸",
    manaCost: 10,
    duration: 60000,
    description: "Táº¡o má»™t vÃ²ng báº£o vá»‡ xung quanh ngÆ°á»i chÆ¡i trong 30 giÃ¢y."
  },
  {
    name: "Vá»‡ tinh laze",
    icon: "ğŸ›°ï¸",
    manaCost: 15,
    duration: 30000,
    baseDamage: 5,
    description: "Triá»‡u há»“i vá»‡ tinh xoay quanh ngÆ°á»i chÆ¡i vÃ  báº¯n laze xuyÃªn zombie."
  },
{
  name: "TÃªn lá»­a F18",
  icon: "ğŸš€",
  manaCost: 15,
  duration: 30000,
  baseDamage: 6,
  description: "Gá»i 2 tÃªn lá»­a bay vÃ²ng trÃ²n quanh ngÆ°á»i chÆ¡i vÃ  xuyÃªn phÃ¡ zombie.",
  upgrades: []
},
{
  name: "UFO táº¥n cÃ´ng",
  icon: "ğŸ›¸",
  manaCost: 15,
  duration: 30000,
  baseDamage: 5,
  description: "Gá»i UFO bay ngang mÃ n hÃ¬nh, báº¯n laze Ä‘á» xuá»‘ng zombie má»—i giÃ¢y.",
  upgrades: []
},
{
  name: "SÃ©t Ä‘Ã¡nh diá»‡n rá»™ng",
  icon: "ğŸŒ©ï¸",
  manaCost: 20,
  duration: 33000,
  baseDamage: 8,
  description: "Gá»i sÃ©t ngáº«u nhiÃªn Ä‘Ã¡nh quanh báº£n Ä‘á»“.",
  upgrades: []
},
{
  name: "Bom B52",
  icon: "ğŸ’£",
  manaCost: 25,
  duration: 52000,
  baseDamage: 10,
  description: "Má»—i giÃ¢y rÆ¡i 1 bom, phÃ¡t ná»• sau 1-3 giÃ¢y hoáº·c khi cháº¡m zombie."
},
  {
    name: "áº¢o áº£nh phÃ¢n thÃ¢n",
    icon: "ğŸ­",
    manaCost: 30,
    duration: 45000,
    baseDamage: 5,
    description: "Triá»‡u há»“i 2 báº£n sao há»— trá»£ báº¯n."
  },
  {
    name: "Há»‘ Ä‘en",
    icon: "ğŸ•³ï¸",
    manaCost: 30,
    duration: 30000,
    baseDamage: 7,
    description: "Táº¡o má»™t há»‘ Ä‘en hÃºt zombie xung quanh."
  },
  {
    name: "Biáº¿n hÃ¬nh",
    icon: "ğŸ¸",
    manaCost: 5,
    duration: 6000,
    description: "Giáº£ dáº¡ng thÃ nh áº¿ch, zombie sáº½ bá» Ä‘i khÃ´ng táº¥n cÃ´ng trong 5s."
  },
  {
    name: "Boom háº¡t nhÃ¢n",
    icon: "â˜¢ï¸",
    manaCost: 100,
    duration: 20000,
    baseDamage: 100,
    description: "Bom háº¡t nhÃ¢n phÃ¡t ná»• toÃ n báº£n Ä‘á»“, sÃ¡t thÆ°Æ¡ng cá»±c lá»›n."
  },
{
    name: "Quáº£ cáº§u háº¥p huyáº¿t",
    icon: "ğŸ©¸",
    manaCost: 45,
    duration: 25000,
    baseDamage: 2,
    description: "Triá»‡u há»“i quáº£ cáº§u Ä‘á» bay quanh ngÆ°á»i chÆ¡i.\nMá»—i giÃ¢y hÃºt mÃ¡u zombie gáº§n nháº¥t, gÃ¢y sÃ¡t thÆ°Æ¡ng vÃ  há»“i 1 HP.",
    upgrades: []
},
  {
    name: "Ká»¹ nÄƒng B",
    icon: "ğŸ…±ï¸",
    manaCost: 0,
    duration: 0,
    description: "Ká»¹ nÄƒng thá»­ nghiá»‡m B"
  },
];
/* Ä‘áº·t sau khai bÃ¡o skillsData */
const skillTooltipMap = Object.fromEntries(
  skillsData.map(sk => [
    sk.name,
    `${sk.icon} ${sk.name}\nâ”€ Mana ${sk.manaCost}ğŸ’ , ${sk.duration/1000}s\n${sk.description}`
  ])
);

// ğŸ§ª ThÃªm nÃ¢ng cáº¥p cho tá»«ng ká»¹ nÄƒng cÃ³ baseDamage
skillsData.forEach(skill => {
  if (skill.baseDamage !== undefined) {
      skill.upgrades = [
{
        name: `${skill.icon} +1 sÃ¡t thÆ°Æ¡ng`,
        tier: "Báº¡c",
        effect: () => { skill.baseDamage += 1; 
        updateSkillsList(); 
}
},
{
      name: `${skill.icon} +2 sÃ¡t thÆ°Æ¡ng`,
      tier: "VÃ ng",
      effect: () => { skill.baseDamage += 2;
      updateSkillsList();
}
},
{
        name: `${skill.icon} +3 sÃ¡t thÆ°Æ¡ng`,
        tier: "Kim",
        effect: () => { skill.baseDamage += 3;
        updateSkillsList();
}
}
];

    if (skill.name === "SÃ©t Ä‘Ã¡nh diá»‡n rá»™ng") {
    skill.upgrades.push({
    name: "ğŸŒ©ï¸ +1 tia sÃ©t (tá»‘i Ä‘a 5)",
    tier: "Äá»",
    effect: () => {
  const skill = activeSkills.find(s => s.name === "SÃ©t Ä‘Ã¡nh diá»‡n rá»™ng");
  if (skill) {
    skill.level = (skill.level || 0) + 1;
    showWarning("ğŸŒ©ï¸ +1 tia sÃ©t!");
    updateSkillsList();
}
}
});
}
if (skill.name === "Há»‘ Ä‘en") {
  skill.upgrades.push({
    name: "ğŸ•³ï¸ +1 há»‘ Ä‘en (tá»‘i Ä‘a 2)",
    tier: "Äá»",
    effect: () => {
      const skill = activeSkills.find(s => s.name === "Há»‘ Ä‘en");
      if (skill) {
        skill.level = Math.min((skill.level || 0) + 1, 2); // +1 tá»›i tá»‘i Ä‘a 2 há»‘ Ä‘en
        showWarning("ğŸ•³ï¸ +1 há»‘ Ä‘en!");
        updateSkillsList();
      }
    }
  });
}

if (skill.name === "Vá»‡ tinh laze") {
  skill.upgrades.push({
    name: "ğŸ›°ï¸ +1 vá»‡ tinh (tá»‘i Ä‘a 2)",
    tier: "Äá»",
    effect: () => {
      const skill = activeSkills.find(s => s.name === "Vá»‡ tinh laze");
      if (skill) {
        skill.level = Math.min((skill.level || 0) + 1, 2); // +1 tá»›i tá»‘i Ä‘a 2 vá»‡ tinh
        showWarning("ğŸ›°ï¸ +1 vá»‡ tinh!");
        updateSkillsList();
}
}
});
}

if (skill.name === "UFO táº¥n cÃ´ng") {
  skill.upgrades.push({
    name: "ğŸ›¸ +1 UFO (tá»‘i Ä‘a 3)",
    tier: "Äá»",
effect: () => {
  const skill = activeSkills.find(s => s.name === "UFO táº¥n cÃ´ng");
  if (skill) {
    skill.level = (skill.level || 0) + 1;
    showWarning("ğŸ›¸ +1 UFO!");
    updateSkillsList();
}
}
});
}

// ğŸ¯ Náº¿u lÃ  ká»¹ nÄƒng TÃªn lá»­a thÃ¬ thÃªm nÃ¢ng cáº¥p sá»‘ lÆ°á»£ng
    if (skill.name === "TÃªn lá»­a F18") {
      skill.upgrades.push({
        name: `${skill.icon} +1 tÃªn lá»­a (tá»‘i Ä‘a 5)`,
        tier: "Äá»",
effect: () => {
  const skill = activeSkills.find(s => s.name === "TÃªn lá»­a F18");
  if (skill) {
    skill.level = (skill.level || 0) + 1;
    showWarning("ğŸš€ +1 tÃªn lá»­a!");
    updateSkillsList();
}
}
});
}
if (skill.name === "Quáº£ cáº§u háº¥p huyáº¿t") {
    skill.upgrades.push({
        name: "ğŸ©¸ +1 quáº£ cáº§u (tá»‘i Ä‘a 2)",
        tier: "Äá»",
        effect: () => {
            const skill = activeSkills.find(s => s.name === "Quáº£ cáº§u háº¥p huyáº¿t");
            if (skill) {
                skill.level = Math.min((skill.level || 0) + 1, 2);
                showWarning("ğŸ©¸ +1 Quáº£ cáº§u!");
                updateSkillsList();
            }
        }
    });
}
}
});
// ğŸ” GhÃ©p mÃ´ táº£ chi tiáº¿t cho má»—i skill
function buildSkillTooltip(skill) {
  const secs = (skill.duration ?? 0) / 1000;
  const rows = [
    `${skill.icon} ${skill.name}`,
    `Mana: ${skill.manaCost}ğŸ’   â€¢  Thá»i gian: ${secs ? secs + " s" : "tá»©c thÃ¬"}`,
  ];

  // --- SÃ¡t thÆ°Æ¡ng hiá»‡n táº¡i (náº¿u cÃ³) ---
  if (skill.baseDamage !== undefined)
    rows.push(`SÃ¡t thÆ°Æ¡ng: ${skill.baseDamage}`);

  // --- Level hiá»‡n táº¡i cá»§a cÃ¡c nÃ¢ng cáº¥p Ä‘á» ---
  if (skill.level !== undefined)
    rows.push(`Cáº¥p hiá»‡n táº¡i: ${skill.level}`);

  // --- Danh sÃ¡ch nÃ¢ng cáº¥p kháº£ dá»¥ng ---
  /*if (skill.upgrades?.length) {
    rows.push("NÃ¢ng cáº¥p:");
    skill.upgrades.forEach(u => rows.push(`â€¢ ${u.name}  [${u.tier}]`));
  }*/

  // --- MÃ´ táº£ gá»‘c --- "", chÃ¨n trÆ°á»›c mÃ´ táº£ náº¿u cÃ³
  if (skill.description) rows.push(`MÃ´ táº£: ${skill.description}`);

  return rows.join("\n");
}
// ğŸ§ª HÃ m há»c ká»¹ nÄƒng má»›i
function updateSkillsList() {
  const list = document.getElementById('skills-list');
  list.innerHTML = '';
  activeSkills.forEach(skill => {
    const div = document.createElement('div');
    div.className = 'skill-item';
    // gÃ¡n tooltip ğŸ’¡
    div.dataset.tooltip = buildSkillTooltip(skill);
   // div.dataset.tooltip = skillTooltipMap[skill.name] || skill.description || '';
    // Hiá»ƒn thá»‹ mana & disable náº¿u khÃ´ng Ä‘á»§
    const canUse = player.mana >= skill.manaCost;
    div.innerHTML = `<span class="skill-icon">${skill.icon}</span> ${skill.name} - ${skill.manaCost}ğŸ’ `;

    if (!canUse) {
      div.style.opacity = 0.5;
      div.style.pointerEvents = 'none';
}

    div.onclick = () => {
      activateSkill(skill); // Gá»i hÃ m Ä‘Ã£ Ä‘á»‹nh nghÄ©a
};

    list.appendChild(div);
});
/* sau khi render skills list: */
document.querySelectorAll('.skill-item[data-tooltip]').forEach(it=>{
  it.addEventListener('mouseenter',()=>{
    /* ---------- 1. Æ¯á»šC LÆ¯á»¢NG CAO TOOLTIP ---------- */
    const ln    = (it.dataset.tooltip.match(/\n/g)?.length || 0) + 1; // sá»‘ dÃ²ng
    const hTip  = ln * 18 + 12;      // 14 px/line + padding (â‰ˆ)

    /* ---------- 2. TÃNH Dá»ŠCH LÃŠN/XUá»NG ---------- */
    const r     = it.getBoundingClientRect();
    const gap   = 8;
    const overTop    = Math.max(gap - r.top, 0);                       // thiáº¿u phÃ­a trÃªn
    const overBottom = Math.max((r.top + hTip) - (innerHeight - gap), 0);
    const shiftValue = overTop - overBottom;                           // + xuá»‘ng | â€“ lÃªn

    it.style.setProperty('--tip-shift', `${shiftValue}px`);
  });

  it.addEventListener('mouseleave',()=>{
    it.style.removeProperty('--tip-shift');
  });
});
}
// ğŸ§ª Test: ThÃªm ká»¹ nÄƒng báº¥t ká»³ báº±ng phÃ­m sá»‘ 1â€“9, 0
document.addEventListener("keydown", (e) => {
  const keys = "1234567890-=";
  const index = keys.indexOf(e.key);
  if (index >= 0 && skillsData[index] && !activeSkills.includes(skillsData[index])) {
  activeSkills.push(skillsData[index]);
  showWarning(`ğŸ§ª ÄÃ£ thÃªm ká»¹ nÄƒng: ${skillsData[index].name}`);
  updateSkillsList();
}
});

function activateSkill(skill) {
  if (!skill || player.mana < skill.manaCost) return;
  player.mana -= skill.manaCost;
  switch (skill.name) {
    case "KhiÃªn báº£o vá»‡": activateShield(skill); break;
    case "Vá»‡ tinh laze":
      satelliteActive = true;
      satelliteEndTime = Date.now() + skill.duration;
      // Sá»‘ lÆ°á»£ng vá»‡ tinh = 1 + (skill.level || 0), tá»‘i Ä‘a 2
      const satCount = Math.min(skill.level, 2);// náº¿u khÃ´ng cÃ³ level thÃ¬ máº·c Ä‘á»‹nh lÃ  1
      // Vá»‹ trÃ­ vá»‡ tinh: 1 bÃªn pháº£i, 1 bÃªn trÃ¡i player
      satellites = [];
      if (satCount === 1) {
      satellites.push({ x: player.x + 30, y: player.y - 30 });
  } else {
    satellites.push({ x: player.x + 30, y: player.y - 30 });  // pháº£i
    satellites.push({ x: player.x - 30, y: player.y - 30 });  // trÃ¡i
  }
    break;
    case "TÃªn lá»­a F18": activateTwinMissiles(skill); break;
    case "UFO táº¥n cÃ´ng": activateUFO(skill); break;
    case "SÃ©t Ä‘Ã¡nh diá»‡n rá»™ng": activateLightning(skill); break;
    case "Bom B52": activateBombs(skill); break;
    case "áº¢o áº£nh phÃ¢n thÃ¢n": activateClones(skill); break;
    case "Há»‘ Ä‘en": activateBlackHole(skill); break;
    case "Biáº¿n hÃ¬nh": activateDisguise(skill); break;
    case "Boom háº¡t nhÃ¢n": activateNuclearBomb(skill); break;
    case 'Quáº£ cáº§u háº¥p huyáº¿t':activateBloodOrb(skill); break;
  }
// LÃ m sÃ¡ng nÃºt ká»¹ nÄƒng tÆ°Æ¡ng á»©ng vÃ  Ä‘áº¿m ngÆ°á»£c
const list = document.getElementById('skills-list').children;
for (let i = 0; i < list.length; i++) {
  const item = list[i];
  if (item.textContent.includes(skill.name)) {
    item.classList.add("active");
    const endTime = Date.now() + skill.duration;
    const interval = setInterval(() => {
      const remain = Math.ceil((endTime - Date.now()) / 1000);
      if (remain > 0) {
        item.innerHTML = `<span class="skill-icon">${skill.icon}</span> ${skill.name} - ${remain}s`;
} else {
        item.classList.remove("active");
        item.innerHTML = `<span class="skill-icon">${skill.icon}</span> ${skill.name} - ${skill.manaCost}ğŸ’ `;
        clearInterval(interval);
}
}, 1000);
break;
}
}
// Hiá»ƒn thá»‹ thÃ´ng bÃ¡o ká»¹ nÄƒng Ä‘Ã£ kÃ­ch hoáº¡t
  showWarning(`${skill.icon} ${skill.name}!`);
}
// ğŸ§Ÿâ€â™‚ï¸ Ká»¹ nÄƒng: Táº¡o cÃ¡c ká»¹ nÄƒng Ä‘áº·c biá»‡t cho ngÆ°á»i chÆ¡i
// ğŸ›¡ï¸ KhiÃªn báº£o vá»‡: Táº¡o lá»›p cháº¯n cháº·n sÃ¡t thÆ°Æ¡ng vÃ  hiá»ƒn thá»‹ hiá»‡u á»©ng
function activateShield(skill) {
  player.shieldActive = true;
  player.shieldEndTime = Date.now() + skill.duration;

  setTimeout(() => {
    player.shieldActive = false;
}, skill.duration);
}

// ğŸš€ TÃªn lá»­a F18: 2 tÃªn lá»­a bay quanh ngÆ°á»i chÆ¡i, xuyÃªn vÃ  gÃ¢y sÃ¡t thÆ°Æ¡ng zombie
function activateTwinMissiles(skill) {
  const createMissilePair = () => {
  const targets = zombies.filter(z => z.active);
if (targets.length === 0) return;
  const missileCount = Math.min(0 + (skill.level || 1), 5); // Tá»‘i Ä‘a 5 tÃªn lá»­a
for (let i = 0; i < missileCount; i++) {
      const angleOffset = Math.random() * Math.PI * 2;
      const radius = 40;
      const x = player.x + Math.cos(angleOffset) * radius;
      const y = player.y + Math.sin(angleOffset) * radius;
      const target = targets[Math.floor(Math.random() * targets.length)];

      missiles.push({
        x, y,
        dx: 0,
        dy: 0,
        target,
        damage: skill.baseDamage,
        delay: 120,       // â± chá» 2 giÃ¢y
        life: 360,        // sá»‘ng thÃªm 3s sau khi bay - thá»i gian sá»‘ng tÃªn lá»­a
        state: "delay"
});
}
};

// ğŸŸ¢ Táº¡o NGAY láº­p tá»©c
  createMissilePair();

// â± Sau Ä‘Ã³ tiáº¿p tá»¥c táº¡o má»—i 2s
  const interval = setInterval(createMissilePair, 2000);
  setTimeout(() => clearInterval(interval), skill.duration);
}

// UFO táº¥n cÃ´ng
function activateUFO(skill) {
  ufoActive = true;
  ufoEndTime = Date.now() + skill.duration;
  ufoCooldown = 0;

  const maxCount = Math.min(0 + (skill.level || 0), 3);
  ufoCount = maxCount;

  const damage = skill.baseDamage;

ufos = Array.from({ length: maxCount }, (_, i) => ({
    x: canvas.width + 100 + i * 150, // báº¯t Ä‘áº§u ngoÃ i rÃ¬a pháº£i
    y: 300,                  // cá»‘ Ä‘á»‹nh vÃ¹ng phÃ­a trÃªn - y cÃ ng cÃ ng thÃ¬ cÃ ng tháº¥p
    speed: -0.5, // Tá»‘c Ä‘á»™ bay cá»§a UFO, giáº£m Ä‘á»ƒ cháº­m
    damage,
    laserCooldown: 0,
    laserLife: 0,
    angle: 0
  }));

  setTimeout(() => {
    ufoActive = false;
    ufos = [];
  }, skill.duration);
}
// === Helper: váº½ Ä‘Æ°á»ng sÃ©t ngoáº±n ngoÃ¨o =========================
function getZigZag(start, target, segments = 8, jitter = 20) {
  const pts = [start];                         // Ä‘iá»ƒm Ä‘áº§u lÃ  Ä‘Ã¡m mÃ¢y
  for (let i = 1; i < segments; i++) {
    const t = i / segments;                    // ná»™i suy tuyáº¿n tÃ­nh
    pts.push({
      x: start.x + (target.x - start.x) * t + (Math.random() - 0.5) * jitter,
      y: start.y + (target.y - start.y) * t + (Math.random() - 0.5) * jitter
    });
  }
    pts.push({
      x: target.x + (Math.random() - 0.5) * jitter,
      y: target.y + (Math.random() - 0.5) * jitter
});
  return pts;                                  // máº£ng [{x,y}, â€¦]
}

// ğŸŒ©ï¸ SÃ©t Ä‘Ã¡nh diá»‡n rá»™ng: Gá»i sÃ©t ngáº«u nhiÃªn gÃ¢y sÃ¡t thÆ°Æ¡ng diá»‡n rá»™ng
function activateLightning(skill) { // KÃ­ch hoáº¡t ká»¹ nÄƒng sÃ©t
  lightningActive   = true;
  lightningStartTime = Date.now();
  lightningEndTime   = lightningStartTime + skill.duration;

  const boltCount = Math.min(skill.level, MAX_LV.lightning); // â‰¤5
  lightningBolts  = [];                         // reset
  const spread    = 80;                         // rá»™ng 2*80 = 160px

  for (let i = 0; i < boltCount; i++) {
    const offsetX = (i - (boltCount - 1) / 2) * spread; // -80,0,80,â€¦
    lightningBolts.push({
      offsetX,
      x: 0, y: 0,            // sáº½ Ä‘Æ°á»£c tÃ­nh má»—i frame
      damage: skill.baseDamage,
      lastShot: 0,
      phase: Math.random() * Math.PI * 2,     // bob cloud
      currentStrike: null                     // sáº½ chá»©a path & life
    });
  }
  setTimeout(() => { lightningActive = false; lightningBolts = []; }, skill.duration);
}
// KÃ­ch hoáº¡t ká»¹ nÄƒng Bom B52 - tÃ¡i sá»­ dá»¥ng hÃ m activateBombs
function spawnPlanes(skill, amount = 3) {
  const planeYBase = player.y - 180; // Vá»‹ trÃ­ mÃ¡y bay báº¯t Ä‘áº§u

  for (let i = 0; i < amount; i++) {
    const plane = {
      x: -100,
      y: planeYBase - i * 20,
      targetY: planeYBase - i * 20,
      vx: 1.5 + i * 0.5,
      lastDropTime: Date.now(),
      nextDropDelay: 5000 + i * 500 + Math.random() * 300,

      // ğŸ‘‡ Hiá»‡u á»©ng biáº¿n máº¥t
      scale: 1,
      opacity: 1,
      disappearing: false
    };

    activePlanes.push(plane);

    // âœ… Cáº­p nháº­t tá»‘c Ä‘á»™ ngang má»—i 1â€“5 giÃ¢y
    function schedulePlaneSpeedAdjust() {
      const delay = Math.random() * (5000 - 1000) + 1000;
      plane._speedTimeout = setTimeout(() => {
        plane.vx = Math.random() * (5 - 0.5) + 0.5;
        schedulePlaneSpeedAdjust(); // Gá»i láº¡i Ä‘á»ƒ láº·p
      }, delay);
    }

    // âœ… Cáº­p nháº­t Ä‘á»™ cao dao Ä‘á»™ng má»—i 1â€“5 giÃ¢y
    function schedulePlaneHeightAdjust() {
      const delay = Math.random() * (5000 - 1000) + 1000;
      plane._heightTimeout = setTimeout(() => {
        plane.targetY += (Math.random() - 0.5) * 40; // dao Ä‘á»™ng Â±20
        schedulePlaneHeightAdjust(); // Láº·p tiáº¿p
      }, delay);
    }

    // ğŸ”„ KÃ­ch hoáº¡t 2 chu ká»³ Ä‘iá»u chá»‰nh
    schedulePlaneSpeedAdjust();
    schedulePlaneHeightAdjust();

    // ğŸ® Cáº­p nháº­t chuyá»ƒn Ä‘á»™ng vÃ  tháº£ bom Ä‘á»‹nh ká»³
    const planeInterval = setInterval(() => {
      const now = Date.now();

      // â¡ Di chuyá»ƒn theo tá»‘c Ä‘á»™ hiá»‡n táº¡i
      plane.x += plane.vx;

      // ğŸ“ˆ Bay mÆ°á»£t Ä‘áº¿n targetY
      plane.y += (plane.targetY - plane.y) * 0.05;

      // ğŸ’£ Tháº£ bom náº¿u Ä‘áº¿n thá»i Ä‘iá»ƒm
      if (now - plane.lastDropTime > plane.nextDropDelay) {
        plane.lastDropTime = now;
        plane.nextDropDelay = 1000 + Math.random() * 2000; // tá»« 1â€“3s

        const targetY = plane.y + 100 + Math.random() * (canvas.height * 0.9); // 90%
        bombsB52.push({
          x: plane.x,
          y: plane.y,
          vy: 3,
          exploded: false,
          landed: false,
          finalY: targetY,
          timerAfterLand: 180,
          radius: 15,
          damage: skill.baseDamage
        });
      }

      // ğŸŒ€ Khi gáº§n rÃ¬a map thÃ¬ báº¯t Ä‘áº§u biáº¿n máº¥t
      if (!plane.disappearing && plane.x > worldWidth - 180) {
        plane.disappearing = true;
      }

      // ğŸ§¼ Hiá»‡u á»©ng thu nhá» vÃ  xoÃ¡ mÃ¡y bay
      if (plane.disappearing) {
        plane.scale *= 0.95;
        plane.opacity -= 0.05;

        if (plane.scale < 0.1 || plane.opacity <= 0) {
          clearInterval(planeInterval);
          clearTimeout(plane._speedTimeout);
          clearTimeout(plane._heightTimeout);
          activePlanes.splice(activePlanes.indexOf(plane), 1);
        }
      }
    }, 50);
  }
}
const planeWaves = [
  { delay: 0, amount: 1 },      // táº¡o 3 mÃ¡y bay ngay láº­p tá»©c
  { delay: 3000, amount: 1 },  // táº¡o 5 mÃ¡y bay sau 30s
  { delay: 6000, amount: 1 },
  { delay: 9000, amount: 1 },  // táº¡o 2 mÃ¡y bay sau 60s
];
// ğŸ’£ Bom B52: rÆ¡i xuá»‘ng, ná»• khi trÃºng zombie, náº¿u khÃ´ng trÃºng thÃ¬ ná»• sau 5s khi cháº¡m Ä‘áº¥t
function activateBombs(skill) {
  const skillEndTime = Date.now() + skill.duration;

  planeWaves.forEach(wave => {
    setTimeout(() => {
      spawnPlanes(skill, wave.amount);
    }, wave.delay);
  });
  // ğŸ’£ Update bom rÆ¡i nhÆ° cÅ©
  const updateInterval = setInterval(() => {
    for (let i = bombsB52.length - 1; i >= 0; i--) {
      const bomb = bombsB52[i];
      if (bomb.exploded) continue;

      if (!bomb.landed) {
        bomb.y += bomb.vy;
        for (let z of zombies) {
          if (z.active && distance(bomb, z) < bomb.radius + z.radius) {
            explodeB52Bomb(bomb);
            bombsB52.splice(i, 1);
            break;
          }
        }
        if (bomb.y >= bomb.finalY) {
          bomb.y = bomb.finalY;
          bomb.landed = true;
        }
      } else {
        bomb.timerAfterLand--;
        if (bomb.timerAfterLand <= 0) {
          explodeB52Bomb(bomb);
          bombsB52.splice(i, 1);
        }
      }
    }

    if (Date.now() > skillEndTime && bombsB52.length === 0) {
      clearInterval(updateInterval);
    }
  }, 1000 / 60);

  function explodeB52Bomb(bomb) {
    bomb.exploded = true;
    explosions.push(getExplosion(bomb.x, bomb.y));
    zombies.forEach(z => {
      if (z.active && distance(bomb, z) < 240) {
        dealDamageToZombie(z, bomb.damage);
      }
    });
  }
}
// ğŸ­ áº¢o áº£nh phÃ¢n thÃ¢n: Táº¡o 2 báº£n sao báº¯n Ä‘áº¡n há»— trá»£
function activateClones(skill) {
  clonesActive = true;
  clonesEndTime = Date.now() + skill.duration;
  clones = [];

  const moveAngle = Math.random() * Math.PI * 2; // hÆ°á»›ng di chuyá»ƒn chung

  for (let i = 0; i < 2; i++) {
    const offset = (i === 0 ? -40 : 40); // clone trÃ¡i vÃ  pháº£i cÃ¡ch nhau 80px
    clones.push({
      x: player.x + Math.cos(moveAngle + Math.PI / 2) * offset,
      y: player.y + Math.sin(moveAngle + Math.PI / 2) * offset,
      moveAngle: moveAngle,
      moveSpeed: 1.2,                     // Tá»‘c Ä‘á»™ di chuyá»ƒn clone
      baseDamage: skill.baseDamage || 5, // SÃ¡t thÆ°Æ¡ng riÃªng
      lastShot: 0
    });
  }
}
// ğŸ•³ï¸ Há»‘ Ä‘en: HÃºt zombie vÃ o tÃ¢m vÃ  gÃ¢y sÃ¡t thÆ°Æ¡ng liÃªn tá»¥c
function activateBlackHole(skill) {
  const holeCount = Math.min(skill.level, 2); // Tá»‘i Ä‘a 2 há»‘ Ä‘en
  const radius = 150; // bÃ¡n kÃ­nh há»‘ Ä‘en
  const holePositions = [];

  // ğŸŒ€ Táº¡o há»‘ Ä‘áº§u tiÃªn gáº§n player (trong bÃ¡n kÃ­nh 120px)
  const angle = Math.random() * Math.PI * 2;
  const distance = 60 + Math.random() * 60; // cÃ¡ch player tá»« 60â€“120px
  const x1 = Math.max(radius, Math.min(canvas.width - radius, player.x + Math.cos(angle) * distance));
  const y1 = Math.max(radius, Math.min(canvas.height - radius, player.y + Math.sin(angle) * distance));
  holePositions.push({ x: x1, y: y1 });

  // ğŸ’« Náº¿u cÃ³ há»‘ thá»© 2 â†’ táº¡o xa há»‘ Ä‘áº§u tiÃªn (tá»‘i thiá»ƒu 250px)
  if (holeCount >= 2) {
    const minDistance = 250;
    const maxAttempts = 50;
    for (let attempt = 0; attempt < maxAttempts; attempt++) {
      const x2 = radius + Math.random() * (canvas.width - radius * 2);
      const y2 = radius + Math.random() * (canvas.height - radius * 2);
      const dx = x2 - x1;
      const dy = y2 - y1;
      const dist = Math.hypot(dx, dy);
      if (dist >= minDistance) {
        holePositions.push({ x: x2, y: y2 });
        break;
      }
    }
  }

  // ğŸŒªï¸ ThÃªm vÃ o game
holePositions.forEach(pos => {
  blackHoles.push({
    x: pos.x,                      // Vá»‹ trÃ­ X ban Ä‘áº§u
    y: pos.y,                      // Vá»‹ trÃ­ Y ban Ä‘áº§u
    radius: radius,               // BÃ¡n kÃ­nh áº£nh hÆ°á»Ÿng
    damage: skill.baseDamage,     // SÃ¡t thÆ°Æ¡ng
    duration: skill.duration,     // Thá»i gian tá»“n táº¡i
    pullSpeed: 3.5,               // Lá»±c hÃºt má»—i frame
    tick: 0,                      // Äáº¿m frame
    dustTimer: 0, 
    endTime: Date.now() + skill.duration, // Thá»i Ä‘iá»ƒm káº¿t thÃºc

    // â• ThÃªm hÆ°á»›ng di chuyá»ƒn cá»±c cháº­m
    dx: (Math.random() - 0.5) * 0.1,  // tá»‘c Ä‘á»™ X cá»±c nhá»
    dy: (Math.random() - 0.5) * 0.1   // tá»‘c Ä‘á»™ Y cá»±c nhá»
  });
});
}

// ğŸ¸ Biáº¿n hÃ¬nh: Zombie táº¡m thá»i khÃ´ng phÃ¡t hiá»‡n ngÆ°á»i chÆ¡i (áº©n thÃ¢n)
function activateDisguise(skill) {
  disguiseActive = true;
  disguiseEndTime = Date.now() + skill.duration;

  // Cáº­p nháº­t tráº¡ng thÃ¡i cho zombie
  zombies.forEach(z => {
    if (!z.isBoss) {
      z.state = "wandering";
      z.wanderTime = Date.now() + 6000 + Math.random() * 4000;// Thá»i gian Ä‘i lang thang ngáº«u nhiÃªn tá»« 3s Ä‘áº¿n 7s
      z.wanderAngle = Math.random() * Math.PI * 2;

      // ğŸ’¬ Biá»ƒu cáº£m ngáº«u nhiÃªn náº¿u khÃ´ng pháº£i boss
      if (Math.random() < 0.6) {
        const expressions = ["ğŸ˜•", "ğŸ¤¢", "ğŸ˜´", "ğŸ˜³", "ğŸ¤®"];
        z.iconToDraw = expressions[Math.floor(Math.random() * expressions.length)];
        setTimeout(() => { z.iconToDraw = null; }, 5000); // Biá»ƒu cáº£m biáº¿n máº¥t sau 5s
      }
    }
  });
  setTimeout(() => {
    disguiseActive = false;
  }, skill.duration);
}
// MÃ u cho bom háº¡t nhÃ¢n khi phÃ¡t ná»•
const colors = [
    "rgba(255,255,255,0.7)", // tráº¯ng
    "rgba(255,0,0,0.7)",     // Ä‘á»
    "rgba(0,255,0,0.7)",     // xanh lÃ¡
    "rgba(0,200,255,0.7)",   // cyan
    "rgba(255,200,0,0.7)",   // vÃ ng
    "rgba(255,0,255,0.7)"    // tÃ­m
];
// â˜¢ï¸ Bom Háº¡t NhÃ¢n: RÆ¡i xuá»‘ng giá»¯a mÃ n hÃ¬nh, Ä‘áº¿m ngÆ°á»£c 5s rá»“i táº¡o vÃ²ng ná»• lan rá»™ng
function activateNuclearBomb(skill) {
    if (nuclearBombs.length >= 1) return;
    nuclearBombs.push({
        x: player.x,
        y: 100,
        vy: 3.5,
        exploded: false,
        landed: false,
        timerAfterLand: 5 * 60,
        damage: skill.baseDamage * 10,
        radius: 22,
        finalY: player.y,
        shockwave: false,
        shockwaveRadius: 0,
        shockwaveSpeed: 2
    });
    const updateInterval = setInterval(() => {
        if (nuclearBombs.length === 0) {
            clearInterval(updateInterval);
            return;
        }

        const bomb = nuclearBombs[0];
        if (bomb.exploded && !bomb.shockwave) return;
        // ğŸ’¨ Khi bom cháº¡m Ä‘áº¥t â€“ táº¡o háº¡t bá»¥i bay vÃ o tÃ¢m bom
        if (bomb.landed && !bomb.exploded) {
        for (let i = 0; i < 2; i++) {
        createSuctionDust(bomb.x, bomb.y, 0.6); // Tá»‘c Ä‘á»™ tan nhanh cháº­m
        }
        }
        // Bom rÆ¡i xuá»‘ng
        if (!bomb.landed) {
            bomb.y += bomb.vy;
            if (bomb.y >= bomb.finalY) {
                bomb.landed = true;
                bomb.y = bomb.finalY;
            }
        }
        // Äáº¿m ngÆ°á»£c ná»•
        else if (!bomb.exploded) {
            bomb.timerAfterLand--;
            if (bomb.timerAfterLand <= 0) {
                explodeNuclearBomb(bomb);
            }
        }

        // SÃ³ng xung kÃ­ch sau khi ná»•
        if (bomb.exploded && bomb.shockwave) {
            bomb.shockwaveRadius += bomb.shockwaveSpeed;
            zombies.forEach(z => {
                if (z.active && distance(bomb, z) < bomb.shockwaveRadius) {
                    dealDamageToZombie(z, bomb.damage);
                }
            });
            enemyBullets.forEach(b => {
                if (!b.active) return;
                if (distance(bomb, b) < bomb.shockwaveRadius) {
                    releaseEnemyBullet(b);
                    explosions.push(getExplosion(b.x, b.y));
                }
            });
            if (bomb.shockwaveRadius > Math.max(canvas.width, canvas.height) * 1.4) {
                nuclearBombs.shift();
                bomb.shockwave = false;
            }
        }
    }, 1000 / 60);
    // HÃ m phÃ¡t ná»•
    function explodeNuclearBomb(bomb) {
        bomb.exploded = true;
        bomb.shockwave = true;
        bomb.shockwaveRadius = 0;
        explosions.push(getExplosion(bomb.x, bomb.y)); // ğŸ’¥ hiá»‡u á»©ng ná»• nhá» trung tÃ¢m
        // ğŸŒŠ ThÃªm 2 vÃ²ng ná»• phá»¥ má»—i 2 giÃ¢y
        setTimeout(() => {
            extraShockwaves.push({
                x: bomb.x,
                y: bomb.y,
                radius: 0,
                maxRadius: 300,
                color: "red",
                alpha: 1
            });
        }, 2000);
        setTimeout(() => {
            extraShockwaves.push({
                x: bomb.x,
                y: bomb.y,
                radius: 0,
                maxRadius: 400,
                color: "cyan",
                alpha: 1
            });
        }, 4000);
        // ğŸ’¨ Háº¡t bá»¥i bay ra khi bom phÃ¡t ná»•
        for (let i = 0; i < 60; i++) {
    const angle = Math.random() * Math.PI * 2;
    const speed = Math.random() * 4 + 1;
    const color = colors[Math.floor(Math.random() * colors.length)]; // mÃ u ngáº«u nhiÃªn
    particles.push({
        x: bomb.x,
        y: bomb.y,
        vx: Math.cos(angle) * speed,
        vy: Math.sin(angle) * speed,
        size: Math.random() * 3 + 1,
        color: color,
        alpha: 1
    });
}
}
}
// ğŸ©¸ Quáº£ cáº§u háº¥p huyáº¿t
function activateBloodOrb(skill) {
    bloodOrbActive = true;
    bloodOrbEndTime = Date.now() + skill.duration;
    player.mana -= skill.manaCost;

    // XÃ¡c Ä‘á»‹nh sá»‘ lÆ°á»£ng quáº£ cáº§u theo level (tá»‘i Ä‘a 2)
    const maxCount = Math.min(1 + (skill.level || 0), 2);
    bloodOrbCount = maxCount;

    bloodOrbs = Array.from({ length: maxCount }, (_, i) => ({
        angle: (2 * Math.PI / maxCount) * i,
        radius: 60,
        x: player.x,
        y: player.y
    }));
}
// ğŸ“Œ Báº­t/táº¯t báº£ng ká»¹ nÄƒng báº±ng phÃ­m X
document.addEventListener('keydown', (e) => {
  if (e.key.toLowerCase() === 'x') {
    document.getElementById('skillsOverlay').classList.toggle('hidden');
    updateSkillsList();
  }
});

// ThÃªm ká»¹ nÄƒng má»›i (gá»i hÃ m nÃ y khi lÃªn cáº¥p)
function learnSkill(index) {
  const skill = skillsData[index];
if (!activeSkills.includes(skill)) {
  activeSkills.push(skill);
  /* Sá»¬A khá»‘i gÃ¡n level */
    skill.level = 1;              // â† luÃ´n báº¯t Ä‘áº§u á»Ÿ cáº¥p 1
if (skill.baseDamage !== undefined && skill.level === undefined) {
  skill.level = 0;
}
  updateSkillsList();
  showWarning(`ğŸ‰ Há»c ká»¹ nÄƒng: ${skill.icon} ${skill.name}`, { left: "40%", transform: "translate(-50%, -50%)" });
}
}

// ğŸ¯ PhÃ­m Z Ä‘á»ƒ báº­t/táº¯t báº£ng thá»‘ng kÃª
document.addEventListener("keydown", (e) => {
  if (e.key.toLowerCase() === "z") {
    const panel = document.getElementById("statsOverlay");
    panel.classList.toggle("hidden");
}
});

// ğŸ¯ GÃ¡n phÃ­m ` Ä‘á»ƒ báº­t/táº¯t FPS
document.addEventListener("keydown", (e) => {
  if (e.key === "`") {
    const fpsDiv = document.getElementById("fpsCounter");
    fpsDiv.style.display = fpsDiv.style.display === "none" ? "block" : "none";
}
});
function showGuide() {
  document.getElementById("guideOverlay").style.display = "block";
}
function hideGuide() {
  document.getElementById("guideOverlay").style.display = "none";
}
function showInfo() {
  document.getElementById("infoOverlay").style.display = "block";
}
function hideInfo() {
  document.getElementById("infoOverlay").style.display = "none";
}

</script>
<!-- ğŸŒŸ Popup khi lÃªn cáº¥p -->
<div id="levelUpPopup">Level Up!</div>
<!-- ğŸŒŸ Popup chá»n nÃ¢ng cáº¥p -->
<div id="upgradePopup">
  <h3 class="upgradeTitle">â« Chá»n nÃ¢ng cáº¥p</h3>
  <div id="upgradeChoices" class="upgradeChoices"></div>
</div>

<!-- ğŸ“Š Overlay hiá»ƒn thá»‹ thá»‘ng sá»‘ ká»¹ nÄƒng -->
<div id="statsOverlay" class="hidden">
  <h3>ğŸ“Š Thá»‘ng kÃª</h3>
  <div id="highScoreDisplay" style="text-align: center; font-weight: 300; margin: 2px 0; position: relative; top: -6px;">
  ğŸ† Ká»· lá»¥c: 0
  </div>
  <div id="stat-moveSpeed">ğŸ‘Ÿ Tá»‘c Ä‘á»™ cháº¡y: - </div>
  <div id="stat-moveSpeed1">ğŸ‘Ÿ test 1: - </div>
  <div id="stat-damage">ğŸ’¥ SÃ¡t thÆ°Æ¡ng: - </div>
  <div id="stat-fireRate">ğŸ”« HÆ°á»›ng báº¯n: - </div>
  <div id="stat-speed">ğŸ’¨ Tá»‘c Ä‘á»™: - </div>
  <div id="stat-lineCount">ğŸ§¨ Sá»‘ lÆ°á»£ng Ä‘áº¡n: - </div>
  <div id="stat-blade">ğŸ”ª Äao: -</div>
  <div id="stat-sword">âš”ï¸ Kiáº¿m: -</div>
  <div id="stat-fire">ğŸ”¥ Lá»­a: -</div>
  <div id="stat-ice">â„ï¸ BÄƒng: -</div>
  <div id="stat-skills"></div> <!-- ká»¹ nÄƒng khÃ¡c -->
  <div id="stat-spawned">ğŸ§Ÿ Tá»•ng sá»‘ zombie: 0</div>
  <div id="stat-alive">ğŸ§Ÿ Äang cÃ²n sá»‘ng: 0</div>
  <div id="stat-total">ğŸ§Ÿ ÄÃ£ tiÃªu diá»‡t: 0</div>
  <div id="stat-breakdown">
    <!-- sáº½ Ä‘Æ°á»£c cáº­p nháº­t báº±ng JS -->
  </div>
</div>
<!-- ğŸ“š Báº£ng Ká»¹ NÄƒng Active má»Ÿ báº±ng phÃ­m X -->
<div id="skillsOverlay" class="hidden">
<h3>ğŸ“š Ká»¹ nÄƒng Active</h3>
<div id="ui-mana" style="text-align: center; font-weight: 300; margin: 2px 0; position: relative; top: -2px;">ğŸ’  Mana: 0</div>
<div id="skills-list"></div>
</div>

<!-- ğŸ¯ Hiá»ƒn thá»‹ FPS realtime -->
<div id="fpsCounter" style="
  display: none;
  position: fixed;
  top: 0.2rem;
  left: 0.3rem;
  color: lime;
  background: rgba(0, 0, 0, 0);
  padding: 0.4rem 0.8rem;
  border-radius: 0.5rem;
  font-family: monospace;
  font-size: 0.9rem;
  z-index: 9999;
  pointer-events: none;
">
FPS: --
</div>
<!-- ğŸ“ Popup ká»¹ nÄƒng khi lÃªn cáº¥p -->
<div id="skillPopup">
  <h3>ğŸ“ Chá»n ká»¹ nÄƒng hoáº·c nÃ¢ng cáº¥p</h3>
  <div class="upgradeChoices" id="skillChoices"></div>
</div>
<div id="notificationContainer" aria-live="polite"></div>

</body>
</html>
